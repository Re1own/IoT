!function(){define(function(require,a,b){function c(a){return btoa(String.fromCharCode.apply(null,a.replace(/\r|\n/g,"").replace(/([\da-fA-F]{2}) ?/g,"0x$1 ").replace(/ +$/,"").split(" ")))}function d(a){var b,d,e="",f=0,g=32;for(f+=3,d=a.charCodeAt(f),33===parseInt(d)&&f++,b=0;g>b;++b)d=a.charCodeAt(++f).toString(16),0===d.length?d="00"+d:1===d.length&&(d="0"+d),e+=d;for(f+=2,d=a.charCodeAt(f),33===parseInt(d)&&f++,b=0;g>b;++b)d=a.charCodeAt(++f).toString(16),0===d.length?d="0"+d:1===d.length&&(d="0"+d),e+=d;return c(e)}function e(a){var b,c,d,e,f,g,h;for(g=a.length,f=0,h="";g>f;){do b=p[255&a.charCodeAt(f++)];while(g>f&&-1===b);if(-1===b)break;do c=p[255&a.charCodeAt(f++)];while(g>f&&-1===c);if(-1===c)break;h+=String.fromCharCode(b<<2|(48&c)>>4);do{if(d=255&a.charCodeAt(f++),61===d)return h;d=p[d]}while(g>f&&-1===d);if(-1===d)break;h+=String.fromCharCode((15&c)<<4|(60&d)>>2);do{if(e=255&a.charCodeAt(f++),61===e)return h;e=p[e]}while(g>f&&-1===e);if(-1===e)break;h+=String.fromCharCode((3&d)<<6|e)}return h}function f(a){var b,c,d,e,f,g;for(d=a.length,c=0,b="";d>c;){if(e=255&a.charCodeAt(c++),c===d){b+=q.charAt(e>>2),b+=q.charAt((3&e)<<4),b+="==";break}if(f=a.charCodeAt(c++),c===d){b+=q.charAt(e>>2),b+=q.charAt((3&e)<<4|(240&f)>>4),b+=q.charAt((15&f)<<2),b+="=";break}g=a.charCodeAt(c++),b+=q.charAt(e>>2),b+=q.charAt((3&e)<<4|(240&f)>>4),b+=q.charAt((15&f)<<2|(192&g)>>6),b+=q.charAt(63&g)}return b}function g(a){var b=0,c=a.length;if(c%2!==0)return null;c/=2;for(var d=[],e=0;c>e;e++){var f=a.substr(b,2),g=parseInt(f,16);d.push(g),b+=2}return d}function h(a){for(var b="",c=0;c<a.length;c++){var d=a[c].toString(16);1===d.length&&(d="0"+d),b+=d}return b}function j(a,b){var c;return c=255&a[b]|(255&a[b+1])<<8|(255&a[b+2])<<16|(255&a[b+3])<<24}function k(a){var b=atob(a),c=b.length,d=new Uint8Array(new ArrayBuffer(c));for(i=0;i<c;i++)d[i]=b.charCodeAt(i);return d}require("jsCore/mToken"),require("jsCore/base64"),require("jsCore/mTokenBasicOper"),require("jsCore/USBKeyInfoMap");var l=b.exports={},m="signContainer",n="1234567812345678",o=!0,p=[-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,62,-1,-1,-1,63,52,53,54,55,56,57,58,59,60,61,-1,-1,-1,-1,-1,-1,-1,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,-1,-1,-1,-1,-1,-1,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,-1,-1,-1,-1,-1];l.listDevice=function(){var a,b={};if(a=token.SOF_LoadLibrary(token.GM3000),0!==a)return b.success=!1,b.message=USBKeyInfoMap.getMsg(a),b;var c=token.SOF_EnumDevice();return null==c||0===c.length?(b.success=!1,b.message=tl("com.NotGetDevice"),b):(b.success=!0,b.message=c,b)},l.loginDevice=function(a,b){var c,d={};if(c=token.SOF_GetDeviceInstance(a,""),0!==c)return d.success=!1,d.message=USBKeyInfoMap.getMsg(c),d;if(c=token.SOF_Login(b),0!==c){var e=token.SOF_GetPinRetryCount();return d.message=tl("pfm.ErrorPIN")+","+tl("com.LoginTimes").replace("XXXX"," "+e+" "),d.success=!1,d}return d.success=!0,d.message=tl("com.LogInSuccessTip"),d},l.SM2Sign=function(a){var b={},c=token.SOF_GetUserList();if(null==c)return b.success=!1,b.message=tl("pfm.NoCertInDevice")+tl("pfm.PleaseCreatCertFirst"),b;token.SOF_SetDigestMethod(token.SGD_SM3),token.SOF_SetUserID(n);var f=token.SOF_SignData(m,o,_Base64encode(a),a.length);return null!=f&&""!==f?(b.message=d(e(f)),b.success=!0,b):(b.message=USBKeyInfoMap.getMsg(token.SOF_GetLastError()),b.success=!1,b)};var q="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";l.getSignCertSN=function(){var a={},b=token.SOF_GetUserList();if(null==b)return a.success=!1,a.message=tl("pfm.NoCertInDevicePleaseCreatTip"),a;var c=1,d=token.SOF_ExportUserCert(m,c);if(null===d&&""===d)return a.success=!1,a.message=tl("pfm.GetCertInfoFailed")+","+USBKeyInfoMap.getMsg(token.SOF_GetLastError()),a;var e=token.SOF_GetCertInfo(d,token.SGD_CERT_SERIAL);return a.success=!0,a.message=e,a},l.getSignCertPubkey=function(){var a={},b=token.SOF_GetUserList();if(null==b)return a.success=!1,a.message=tl("pfm.NoCertInDevicePleaseCreatTip"),a;var c=1,d=token.SOF_ExportUserCert(m,c);if(null===d&&""===d)return a.success=!1,a.message=tl("pfm.GetCertInfoFailed")+","+USBKeyInfoMap.getMsg(token.SOF_GetLastError()),a;var g=token.SOF_GetCertInfo(d,token.SGD_CERT_DER_PUBLIC_KEY),h=e(g);return h=h.slice(1),g=f(h),a.success=!0,a.message=g,a},l.encryptWithPubKey=function(a,b){var d,e,f={},i=[0,1,0,0],l=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],m=g(a),n=[];for(e=0,d=0;d<i.length;++d)n[e]=i[d],++e;for(d=0;d<l.length;++d)n[e]=l[d],++e;for(d=0;32>d;++d)n[e]=m[d],++e;for(d=0;d<l.length;++d)n[e]=l[d],++e;for(d=32;64>d;++d)n[e]=m[d],++e;var o=c(h(n)),p=c(b),q=token.SOF_EncryptByPubKey(o,p);if(""===q||void 0===q||null===q)return f.success=!1,f.message=tl("pfm.FailedEncodePleaseCheckKey"),f;var r=k(q),s=j(r,160),t=[],u=0;for(d=32;64>d;++d)t[u]=r[d],u++;for(d=96;128>d;++d)t[u]=r[d],u++;for(d=128;160>d;++d)t[u]=r[d],u++;for(d=164;164+s>d;++d)t[u]=r[d],u++;var v=h(t);return f.success=!0,f.message=v,f},l.get24RandomChar=function(){var a={},b=token.SOF_GenerateRandom(50);if(""===b||void 0===b||null===b)return a.success=!1,a.message=tl("pfm.FailedRandomPleaseCheckKey"),a;var c=b.substring(0,24);return a.success=!0,a.message=c,a}})}(jQuery);