!function(a){define(function(require,b,c){function d(){return g.Global.keepAlive().done(function(){o=0}).fail(function(b){return b.error&&b.error.code&&287637504===b.error.code?void clearInterval(p):void(5===++o?(alert(tl("com.ConnectOveretimeTip")),plugin.Reload()):k.login(n.username,n.password,n.logintype).done(function(){a.publish("RECONNECTION")}))})}function e(){var a=null;return a="LDAP"===n.logintype||"ActiveDirectory"===n.logintype?g.UserManager.getAuthorityList().done(function(a){m.AuthorityList=a}):g.UserManager.getUserInfo(n.username).done(function(a){a&&(m=a)}),a.fail(function(){throw new Error("Could not get the user info!")})}function f(a){if(""!==a){for(var b="",c=0;c<a.length;c++)""===b?b=a.charCodeAt(c).toString(16):b+=a.charCodeAt(c).toString(16);return b}}var g=require("jsCore/rpc"),h=require("jsCore/ability"),i=require("common/common"),j=(i.Cookie,require("/jsCore/mTokenOperator")),k=c.exports={},l=null,m={},n={},o=0,p=null;k.login=function(b,c,h){return n.logintype=h||"Direct",n.username=b,n.password=c,a.Deferred(function(h){g.Global.firstLogin(b,{loginType:n.logintype}).always(function(i){if(l=i.params,l&&l.realm&&(g.Global.realm=l.realm),i&&i.error&&(268632079===i.error.code||401===i.error.code)){"WatchNet"===l.encryption&&(n.logintype="WatchNet");var m={loginType:n.logintype,authorityType:l.encryption},o=a.Deferred();if(webCaps.is_show_Ushield){var q="",r="",s=j.get24RandomChar().message;l.encryption="Ushield",s=f(s).substr(0,16).toUpperCase(),webApp.mTokenPsw=s,k.getLoginInfo().password=s,g.DigitalCertificate.getPublicKey().done(function(a){if(a&&a.PublicKey){var c=a.PublicKey.split(","),d=c&&c[0].split(":")[1],e=c&&c[1].split(":")[1],f=d+e;q=j.encryptWithPubKey(f,s).message,r=q+":"+Base64.encode(j.getSignCertSN().message)+":"+j.SM2Sign(b+l.random).message,m={loginType:n.logintype,authorityType:l.encryption,authorityInfo:r},o.resolve()}})}else o.resolve();o.done(function(){g.Global.secondLogin(b,k.getAuth(b,c),m).done(function(){a.when(webApp.getGlobalConfigs(),e()).done(h.resolve),clearInterval(p),p=setInterval(d,6e4)}).fail(function(a){if(!(a&&a.params&&a.params.error)&&a&&a.error&&a.error.code)a.params?h.reject(a&&a.error&&a.error.code,a.params):h.reject(a&&a.error&&a.error.code);else{var b=a&&a.params&&a.params.error;"UserNotValidt"===b?h.reject(268632070):"PasswordNotValid"===b?h.reject(268632071):"InBlackList"===b?h.reject(268632073):"HasBeedUsed"===b?h.reject(268632074):"HasBeenLocked"===b?h.reject(268632081):h.reject()}})})}else i&&i.error&&400===i.error.code?h.reject(268632070):i&&i.error&&486===i.error.code?h.reject(268632075):h.reject()})}).promise()},k.logout=function(){return clearInterval(p),p=null,h.clear(),g.Global.logout(!!(a.browser.ie&&a.browser.version<=7))},k.getAuth=function(a,b,c){switch(c=c||l.encryption){case"Basic":return Base64.encode(a+":"+b);case"Default":return hex_md5(a+":"+l.random+":"+hex_md5(a+":"+l.realm+":"+b));default:return b}},k.chkAuthority=function(b){var c={ShutDown:"AuthMaintence",Monitor_01:"Monitor_01",Replay_01:"Replay_01",Record:"AuthStoreCfg",Backup:"AuthBackup",MHardisk:"AuthStoreCfg",MPTZ:"AuthManuCtr",Account:"AuthUserMag",Alarm:"AuthEventCfg",QueryLog:"AuthSysInfo",DelLog:"AuthSysInfo",SysUpdate:"AuthMaintence",AutoMaintain:"AuthMaintence",GeneralConf:"AuthSysCfg",EncodeConf:"AuthAVParam",RecordConf:"AuthStoreCfg",ComConf:"AuthPeripheral",NetConf:"AuthNetCfg",AlarmConf:"AuthEventCfg",VideoConfig:"AuthEventCfg",PtzConfig:"AuthPTZ",DefaultConfig:"AuthMaintence",VideoInputConfig:"AuthAVParam",IntelliConf:"AuthEventCfg",RainBrushConfig:"AuthPeripheral",ReportConfig:"AuthStoreCfg",FireWarning:"AuthEventCfg",HotTrace:"AuthEventCfg",PicInPic:"AuthEventCfg",TemperatureConfig:"AuthEventCfg",TemperatureAdjustConfig:"AuthEventCfg",LightingConf:"AuthPeripheral",PtzFan:"AuthPeripheral",PtzHeater:"AuthPeripheral"};return a.isArray(m.AuthorityList)?-1!==a.inArray(b,m.AuthorityList)||-1!==a.inArray(c[b],m.AuthorityList):!1},k.getAuthority=function(){return m.AuthorityList},k.needModifyPsw=function(){return"1970-1-1 00:00:00"===m.PasswordModifiedTime},k.getLoginInfo=function(){return n}})}(jQuery);