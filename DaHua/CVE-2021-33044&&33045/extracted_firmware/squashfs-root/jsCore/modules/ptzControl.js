!function(a){define(function(require,b,c){function d(b,c){var d=this;d.options=a.extend({},k,c),d.e=a(b).empty().append(j).translation(),d.init()}function e(){var b=0,c=!1,d=!1,e=!1,f=!1;return a.when(h.get("LensControl"),h.get("LensControlMix"),h.get("smallPtz"),h.get("AutoFocusButtonVisible"),h.get("AutoFocusButtonThermal"),h.get("ZoomThermal"),h.get("FocusThermal")).then(function(a,g,h,i,j,k,l){return a?b=1:h&&h.Support?b=3:g&&g.Support&&(b=2),i&&i.Support&&(c=!0),j&&j.Support&&(d=!0),k&&k.Support&&(e=!0),l&&l.Support&&(f=!0),[b,c,d,e,f]})}{var f=require("../plugin"),g=require("../pluginCanvas"),h=require("../ability"),i=require("../rpc"),j=require("./ptzControl.html");require("./ptzSetting")}require("widget/js/dui.drag");var k={ptzJoystick:!0,autoFocus:!1,isLaserDistMeasure:!1,isPtzLocate:!0,channel:0,showDirction:!0,showStep:!0,showAdjust:!0,title:!1};a.fn.ptzControl=function(){var b=arguments[0],c=2<=arguments.length?Array.prototype.slice.call(arguments,1):[],e=this;return this.each(function(){var f=a(this),g=f.data("ptzControl");if(g||f.data("ptzControl",g=new d(f,b)),"string"===a.type(b)&&a.isFunction(g[b])){var h=g[b].apply(g,c);if(void 0!==h)return e=h,!1}}),e},d.prototype.init=function(){function b(b){var c=b?l.pop():l.shift();c&&(k=c,i.PTZ.start(c.dir,c.step,-1!==a.inArray(c.dir,d)?c.step:0,0))}var c=this,d=["LeftUp","RightUp","LeftDown","RightDown"],j=null,k=null,l=[];e().done(function(a){c.type=a[0],c.autofocusVisible=a[1],c.autofocusThermal=a[2],c.zoomThermal=a[3],c.focusThermal=a[4]}),h.get("PTZCaps",!0).done(function(a){a&&a.PTZCtrl&&(a.PTZCtrl.PTStep===!1&&(c.options.showStep=!1),a.PTZCtrl.JoyStick===!1&&(c.options.ptzJoystick=!1)),c.options.showStep||c.$("#ptz_control_step").remove(),c.options.ptzJoystick||c.$("[data-for=ptz_joystick]").remove()}),c.options.isPtzLocate?c.$("#ptz_locate").on("click",function(){if(f.activePTZLocate(c.$("#ptz_locate")),"flash"===webApp.playMode||"h5"===webApp.playMode){webApp.RegionFocusLocate=!1,webApp.TrackObjectLocate=!1,a("[btn-for=onTrackObject]").hasClass("current")&&(a("[btn-for=onTrackObject]").removeClass("current"),webApp.LocateTrackObject=!0),a("[btn-for=onRegionFocus]").hasClass("current")&&(a("[btn-for=onRegionFocus]").removeClass("current"),webApp.LocateRegionFocus=!0);var b=!c.$("#ptz_locate").hasClass("current");c.$("#ptz_locate").toggleClass("current"),g.ActivePTZLocate(b),b?a.subscribe("RegionChanged",function(a,b){var c=((b[0]+b[2])/16384).limit(-1,1),d=((b[1]+b[3])/16384).limit(-1,1),e=Math.abs(b[3]-b[1])>Math.abs(b[2]-b[0])?b[3]-b[1]:b[2]-b[0],g=(e/8192).limit(-1,1),h=b[2]>b[0]?g*g:-1*g*g;webApp.RegionFocusLocate||webApp.TrackObjectLocate||i.PTZ.moveDirectly([c,d,h],null,f.windowId)}):a.unsubscribe("RegionChanged",null)}}):(c.$("#ptz_locate").attr("title",""),c.$("#ptz_locate").find("i").removeClass("ui-ptz-icon-center").addClass("ui-ptz-icon-null"),c.$("#ptz_locate").addClass("ptzLocateDisabled")),c.options.showDirction||c.$("#ptz_control_direction").remove(),c.options.showAdjust||c.$("#ptz_control_adjust").remove(),c.options.title&&c.$('[data-for="ptz_control"]').text(tl("itc.ZoomFocus")),"h5"===webApp.playMode,c.$(".u-tab").tab({click:function(a,b){-1!==webApp.DeviceType.indexOf("TPC")&&"ptz_joystick"===b.name?c.$("#ptzControlStep").hide():c.$("#ptzControlStep").show()}}),c.drager=c.$(".vR-area").drag({position:"center",dragElements:".vR-control",distance:35,autoReset:!0,start:function(){j=setInterval(b,500)},drag:function(b,d){a.browser.ie7?(c.$(".vR-control").css("cursor","move"),c.drager.css("cursor","pointer")):(c.$(".vR-control").css("cursor","none"),c.drager.css("cursor","none"));var e=d.position.x-d.firstPosition.x,f=d.firstPosition.y-d.position.y,g=Math.round(4*Math.atan2(f,e)/Math.PI)+3,h=["LeftDown","Down","RightDown","Right","RightUp","Up","LeftUp","Left"],i=parseInt(Math.round(Math.sqrt(Math.pow(Math.abs(e),2)+Math.pow(Math.abs(f),2)))/5)+1;-1===g&&(g=7);var j=h[g],k=l[l.length-1];k&&k.dir===j&&k.step===i||l.push({dir:j,step:i})},stop:function(){if(c.$(".vR-control").css("cursor","pointer"),c.drager.css("cursor","auto"),null===k&&l.length&&b(!0),k){var e=k.dir,f=k.step;setTimeout(function(){i.PTZ.stop(e,f,-1!==a.inArray(e,d)?f:0,0)},450)}clearInterval(j),j=null,k=null,l.length=0}}),c.$(".vR-control").on("mousewheel",function(a,b){var d=b>0?"ZoomTele":"ZoomWide",e=c.$("#ptz_step").val()-0||5;i.PTZ.start(d,e,0,0),setTimeout(function(){i.PTZ.stop(d,e,0,0)},450)}),c.$("a[cmd]").on("mousedown",function(b){var d=c.$(b.currentTarget),e=c.$("#ptz_step").val()-0||5,g=0,h=d.attr("cmd"),j=!0,k=0,l=0,m=0,n=0,o=!1,p=!1,q={ZoomWide:[-1,-.5],ZoomTele:[-1,.5],FocusFar:[-.5,-1],FocusNear:[.5,-1]},r=null;if(-1!==webApp.DeviceType.indexOf("TPC")&&((2===c.type||3===c.type)&&f.windowId||1===c.type?p=!0:c.focusThermal&&-1!==webApp.DeviceType.indexOf("SD")&&f.windowId?p=!0:-1===webApp.DeviceType.indexOf("SD")&&(p=!0)),-1!==a.inArray(h,["LeftUp","RightUp","LeftDown","RightDown"])&&(g=e),p)if(-1!==a.inArray(h,["ZoomWide","ZoomTele","FocusFar","FocusNear"]))j=!1,o=!1,k=q[h][0],l=q[h][1],m=-1===k?-1:0,n=-1===l?-1:0,-1===webApp.DeviceType.indexOf("SD")?i.DevVideoInput.adjustFocusContinuously(k,l,f.windowId):setTimeout(function(){j?(r=i.DevVideoInput.adjustFocus(k,l,f.windowId),r.done(function(){i.DevVideoInput.adjustFocus(m,n,f.windowId)}),o=!0):(r=i.DevVideoInput.adjustFocusContinuously(k,l,f.windowId),o=!0)},200);else if(-1!==a.inArray(h,["IrisSmall","IrisLarge"])){var s="IrisLarge"===h?1:-1;r=i.DevVideoInput.adjustIris(s,f.windowId)}else r=i.PTZ.start(h,e,g,0);else r=i.PTZ.start(h,e,g,0);d.on("mouseup mouseout",function(){j=!0,d.off("mouseup mouseout"),p?-1!==a.inArray(h,["ZoomWide","ZoomTele","FocusFar","FocusNear"])?-1===webApp.DeviceType.indexOf("SD")?i.DevVideoInput.adjustFocusContinuously(m,n,f.windowId):o&&i.DevVideoInput.adjustFocusContinuously(m,n,f.windowId):-1!==a.inArray(h,["IrisSmall","IrisLarge"])?i.DevVideoInput.adjustIris(0,f.windowId):r.done(function(){i.PTZ.stop(h,e,g,0)}):r.done(function(){i.PTZ.stop(h,e,g,0)})})}),h.get("PTZCaps").done(function(a){a&&((-1===webApp.DeviceType.indexOf("TPC")||1===webApp.CamType)&&(a.Zoom===!1&&c.$("#ptz_zoom_wrap").remove(),a.Focus===!1&&c.$("#ptz_focus_wrap").remove()),a.Iris===!1&&c.$("#ptz_iris_wrap").remove())}),c.options.autoFocus||c.$("#ptz_autofocus_wrap").remove(),c.$("#ptz_autofocus_wrap a").on("click",function(){i.DevVideoInput.autoFocus(f.windowId)})},d.prototype.$=function(a){return this.e.find(a)},d.prototype.changeChannel=function(a){var b=this;webApp.CHANNEL_NUMBER>1?a?(b.$("#ptz_iris_wrap").hide(),b.$("#ptz_zoom_wrap").toggle(b.zoomThermal),b.$("#ptz_focus_wrap").toggle(b.focusThermal),b.$("#ptz_autofocus_wrap").toggle(b.autofocusThermal)):(b.$("#ptz_zoom_wrap,#ptz_focus_wrap,#ptz_iris_wrap").show(),b.$("#ptz_autofocus_wrap").toggle(b.autofocusVisible)):(b.$("#ptz_zoom_wrap").toggle(b.zoomThermal),b.$("#ptz_focus_wrap").toggle(b.focusThermal),b.$("#ptz_autofocus_wrap").toggle(b.autofocusThermal))},c.exports=d})}(jQuery);