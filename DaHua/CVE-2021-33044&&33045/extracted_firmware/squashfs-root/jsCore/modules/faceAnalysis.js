!function(a){define(function(require,b,c){function d(b,c){var d=this;d.options=a.extend({},h,c),d.e=a(b).empty().append(g).translation(),d.init()}var e=require("../plugin"),f=require("../rpc"),g=require("./faceAnalysis.html");require("widget/js/dui.scroll");var h=null;a.fn.faceAnalysis=function(){var b=arguments[0],c=2<=arguments.length?Array.prototype.slice.call(arguments,1):[],e=this;return this.each(function(){var f=a(this),g=f.data("faceAnalysis");if(g||f.data("faceAnalysis",g=new d(f,b)),"string"===a.type(b)&&a.isFunction(g[b])){var h=g[b].apply(g,c);if(void 0!==h)return e=h,!1}}),e},d.prototype.init=function(){var b=this;"SimpChinese"!==global.currentLanguage&&b.$("[data-for = CNFace]").hide(),b.hasInfo=!1,b.curPicNum=0,b.$picList=b.$("#face_Analysis"),e.addEvent("FRPictureUrl",function(a){return a=JSON.parse(a),a.Candidate?(b.hasInfo||(b.$("#face_Analysis").show(),b.$(".face-none").hide(),b.hasInfo=!0),void b.addFeature(a)):!1}),b.$(".face").scroll({scrollYEnable:!0,contentWrap:".face-pic",content:"#face_Analysis",yBar:".face-scrollY",actionList:{y:".face-dragY"}}),b.$faceDialog=b.$("#faceAnalysis_dialog").dialog({close:function(){e.cover(b.options.video),webApp.hide_by_dialog=!1}}).detach().appendTo(document.body),ability.get("IVSCaps").done(function(c){var d=c.SupportedScenes.FaceAnalysis.SupportedRules;b.featureList=d.FaceAnalysis.FeatureList;var e="";a.each(b.featureList,function(a,b){e+='<li><span t="'+b+'+:"></span><span key='+b+"></span></li>"}),b.$faceDialog.find("#face_attr ul").empty().html(e).translation()}),b.$("#face_Analysis").delegate("li","click",function(){webApp.hide_by_dialog=!0,e.hide();var c=a(this).data("info")||{};b.showInfo(c),b.$faceDialog.dialog("show"),a(".u-mask").on("mousedown.face",function(a){a.stopPropagation()})}),b.e.on("mousedown",function(a){a.stopPropagation()}),b.$faceDialog.on("mousedown",function(a){a.stopPropagation()}),b.featureEnable={}},d.prototype.render=function(){var b=this;f.ConfigManager.getConfig("VideoAnalyseRule").done(function(c){a.each(c[e.channel],function(c,d){if("FaceAnalysis"===d.Type){var e=d.Config.FeatureList||[];b.featureEnable={},a.each(b.featureList,function(a,c){-1===e.indexOf(c)&&(b.featureEnable[c]="Unknown")})}})})},d.prototype.showInfo=function(b){var c=this;c.$faceDialog.find("#attrImg").prop("src",b.url),c.$faceDialog.find("#delImg").prop("src",b.Candidate.CandidateUrl[0]),c.$faceDialog.find("#face_attr [key], .face_alarm [key]").each(function(){var c=a(this).attr("key");a(this).html(tl(b[c])||tl("com.Unknow"))}),c.$faceDialog.find("#face_detail [key]").each(function(){var c=a(this).attr("key");a(this).html(tl(b.Candidate[c])||tl("com.Unknow"))})},d.prototype.resize=function(){var a=this;a.$(".face").scroll("resize")},d.prototype.addFeature=function(b){var c=this;a.extend(b,c.featureEnable);var d=a.extend(!0,{},b);delete d.Candidate,a.each(b.Candidate,function(e,f){++c.curPicNum>1e3&&(c.$picList.find("li:last").remove(),c.curPicNum--);var g=a("<li></li>"),h=a.extend(!0,{Time:f.Time,GroupName:f.GroupName,Similarity:f.Similarity},d);h.Candidate=f,g.data("info",h);var i=2.2*f.Similarity,j=f.GroupName||"";j.length>16&&(j=j.substr(0,16)),j.lengthB()>30&&(j=j.substrB(30)),j!==f.GroupName&&(j+="...");var k='<img src="'+b.url+'" /><img src="'+f.CandidateUrl[0]+'" /><div class="comp-prog"></div><div class="comp-num" style="width:'+i+'px;"></div><span class="comp-num2">'+f.Similarity+'%</span><div class="face-info"><span class="fn-left">'+j+'</span><span class="fn-right">'+f.Time.split(" ")[1]+"</span></div>";g.html(k),c.$("#face_Analysis").prepend(g)}),c.resize()},d.prototype.destroy=function(){var a=this;a.$("#face_Analysis").empty(),a.hasInfo=!1,a.curPicNum=0,a.$("#face_Analysis").hide(),a.$(".face-none").show(),e.StopRecvFacePic(),e.StopHttpServer()},d.prototype.$=function(a){return this.e.find(a)},c.exports=d})}(jQuery);