!function(a){define(function(require,b,c){function d(b,c){var d=this;d.options=a.extend({},h,c),d.e=a(b).empty().append(g).translation(),d.$(".u-tab.menu").tab(),d.$(".u-tab.fn-hide").tab(),d.$("a[data-action]").on("click",function(a){d.$("[data-target="+d.$(a.currentTarget).attr("data-action")+"]").toggleClass("fn-hide")}),d.$("a[cmd],div[cmd]").on("click",function(a){var b=d.$(a.currentTarget).attr("cmd");return d.$(a.currentTarget).prop("disabled")?!1:void d._chkCmd(b).done(function(){var a=d._buildArgs(b);f.PTZ.start(b,a.arg2,a.arg3,a.arg4),2===i&&d._disabled(b)})}),d.$("a[data-light]").on("click",function(a){f.PTZ.start("Wiper",d.$(a.currentTarget).attr("data-light")-0,0,0)}),d.$("#ptz_set_azi_show").on("click",function(a){var b=d.$(a.target);b.hasClass("current")?(b.removeClass("current"),b.attr("t","ivs.AzimuthDispShowBtn").parent().translation()):(b.addClass("current"),b.attr("t","ivs.AzimuthDispShowBtnStop").parent().translation(),d._getStatus())}),2===i&&(d.$(".resumeLastTask").on("click",function(){f.PtzFunc.resumeLastTask(0)}),d.$(".pausePtzAction").on("click",function(){f.PtzFunc.pausePtzAction(0)})),e.get("PtzFunctionMenu").done(function(a){a&&d.$("a[data-cap=PtzFunctionMenu]").remove()}),webApp.isSpecialPtz&&d.$("a[data-cap=PtzFunctionMenu]").remove(),d.$(".ui-boat-intel-current div[data-css]").on({mouseover:function(a){var b=d.$(a.currentTarget);b.parent().addClass("ui-boat-intel-current-"+b.attr("data-css"))},mouseout:function(a){var b=d.$(a.currentTarget);b.parent().removeClass("ui-boat-intel-current-"+b.attr("data-css"))}}),d.render()}var e=(require("../plugin"),require("../ability")),f=require("../rpc"),g=require("./ptzSetting.html"),h=null,i=1;i=-1!==webApp.DeviceType.indexOf("TPC")?-1===webApp.DeviceType.indexOf("SD")?1:2:-1===webApp.DeviceType.indexOf("TPC")&&-1!==webApp.DeviceType.indexOf("SD")?3:4,a.fn.ptzSetting=function(){var b=arguments[0],c=2<=arguments.length?Array.prototype.slice.call(arguments,1):[],e=this;return this.each(function(){var f=a(this),g=f.data("ptzSetting");if(g||f.data("ptzSetting",g=new d(f,b)),"string"===a.type(b)&&a.isFunction(g[b])){var h=g[b].apply(g,c);if(void 0!==h)return e=h,!1}}),e},d.prototype.render=function(){var b=this;e.get("PTZCaps",!0).done(function(c){c&&c.PtzFunctionMenu&&c.PtzFunctionMenu.SupportOSDMenu||b.$("[data-for=ptz_menu],[data-page=ptz_menu]").remove();var d=b.$("#ptz_set_select"),e="";if(isEnable("is_show_azimuthDisp")&&(e+='<option value="Azimuth" t="ivs.AzimuthDispShowBtn"></option>'),c){if(c.AutoScan!==!1&&(e+='<option value="AutoScan" t="ivs.Scan"></option>'),c.Preset!==!1&&(e+='<option value="Preset" t="ivs.Preset"></option>'),c.Tour!==!1&&(e+='<option value="Tour" t="ivs.AutoTour"></option>'),c.Pattern!==!1&&(e+='<option value="Pattern" t="ivs.Pattern"></option>'),(c&&c.AutoPan===!0||c.AutoPanGroup)&&(e+='<option value="AutoPan" t="ivs.AutoPan"></option>'),1!==i&&2!==i&&c.Aux!==!1&&(e+='<option value="Aux" t="itc.Assistant"></option>'),1!==i&&3!==i&&c.Wiper!==!1&&(e+='<option value="Wiper" t="per.RainBrush"></option>'),-1!==a.inArray("Absolutely",c.Move)){e+='<option value="Absolutely" t="ivs.PositionABS"></option>',3===i&&c.MoveAbsolutely&&a.inArray("Zoom",c.MoveAbsolutely.PTZ)>-1&&(b.$("#ptz_set_abs_zoom").removeClass("fn-hide"),b.$("#ptz_set_abs_zoom").prev().removeClass("fn-hide")),b.$("#ptz_set_abs_zoom").numberfield({allowDecimal:!1,allowNegative:!1,min:1,max:128});var f,g,h,j,k=c.PtzMotionRange;2===i?(f=k&&k.HorizontalAngle[0]||0,g=k&&k.HorizontalAngle[1]||360,h=k&&k.VerticalAngle[0]||0,j=k&&k.VerticalAngle[1]||90):(f=k&&10*k.HorizontalAngle[0]||0,g=k&&10*k.HorizontalAngle[1]||3600,h=k&&10*k.VerticalAngle[0]||0,j=k&&10*k.VerticalAngle[1]||900);var l=b.$("#ptz_set_abs_x").numberfield({allowDecimal:!1,allowNegative:!0,min:f,max:g}).prev("p").find("span");l.eq(1).text(f),l.eq(2).text(g);var m=b.$("#ptz_set_abs_y").numberfield({allowDecimal:!1,allowNegative:!0,min:h,max:j}).prev("p").find("span");m.eq(1).text(h),m.eq(2).text(j)}b._renderByDevType(c)}d.empty().html(e).translation(),d.get(0).selectedIndex=0,d.on("change",function(a){b.$(".u-tab.fn-hide").tab("select",b.$(a.target).val())}).change(),b.$(":text[capKey]").each(function(a,d){var e=b.$(d),f=e.attr("capKey"),g=e.attr("capMin")-0,h=c&&c[f+"Min"]||g,i=c&&c[f+"Max"]||255;e.numberfield({allowDecimal:!1,allowNegative:!1,min:h,max:i});var j=e.nextAll("span");j.eq(0).text(h),j.eq(2).text(i)})}),2!==i&&(b.$(".resumeLastTask").remove(),b.$(".pausePtzAction").remove())},d.prototype.$=function(a){return this.e.find(a)},d.prototype._renderByDevType=function(b){var c=this,d=["Preset","Tour","Pattern","Scan"];if(1===i||3===i||4===i)a.each(d,function(a,b){c.$("#ptz_func_"+b).remove()}),1===i&&d.each(function(b){a('[data-target="set'+b+'"]').removeClass("fn-hide")});else{var e=[];e.push(f.ConfigManager.getConfig("PtzMovement")),b.AutoScan&&e.push(f.ConfigManager.getConfig("AutoScan")),b.Preset&&e.push(f.PTZ.getPresets()),b.Tour&&e.push(f.ConfigManager.getConfig("PtzTour")),b.Pattern&&e.push(f.ConfigManager.getConfig("AutoPattern")),b.AutoPanGroup&&e.push(f.PtzFunc.getPanGroup(0)),a.when.apply(null,e).done(function(){var e=arguments,g=(e[0][0].Function||"None",e[0]&&e[0][0].Index||0),h=e[1]&&e[1][0]||[],i=e[2]||[],j=e[3]&&e[3][0]||[],k=e[4]&&e[4][0]||[],l=e[5]&&e[5].panGroupInfo||[],m="",n="",o="",p="";d.each(function(a){c.$("#ptz_func_"+a).empty().prop("disabled",!1),c.$('[cfg="set_'+a+'"]').addClass("fn-hide"),c.$("#tip"+a).text("")}),c.$("a[cmd]").each(function(b,d){c._disabledDom(!1,a(d),a(d))});for(var q=0;q<h.length;q++)h[q].LeftEnable&&h[q].RightEnable&&(o+='<option value="'+(q+1)+'">'+(q+1)+"</option>");if(""===o?(c.$("#tipScan").removeClass("fn-hide"),c.$("#tipScan").text(tl("com.NoValidScan")),c._disabledDom(!0,c.$('a[cmd="AutoScanOn"],a[cmd="AutoScanOff"],#main-ptz-historyOn-scan,#main-ptz-pause-scan'),c.$("#ptz_func_scan"))):(c.$("#ptz_func_Scan").append(o),c._disabledDom(!1,c.$("#main-ptz-historyOn-scan,#main-ptz-pause-scan"))),0!==i.length){for(var r=0;r<i.length;r++)m+='<option value="'+i[r].Index+'">'+i[r].Name+"</option>";c.$("#ptz_func_Preset").append(m)}else c.$("#tipPreset").removeClass("fn-hide"),c.$("#tipPreset").text(tl("com.NoPresetTip")),c._disabledDom(!0,c.$('a[cmd="GotoPreset"]'),c.$("#ptz_func_Preset"));if(0!==j.length){var s;s=j.length>b.TourMax?b.TourMax:j.length;for(var t=0;s>t;t++)if(j[t].Enable){var u=0;a.each(j[t].Presets,function(a,b){-1!==b[0]&&u++}),u>=1&&(n+='<option value="'+(t+1)+'">'+j[t].Name+"</option>")}}""===n?(c.$("#tipTour").removeClass("fn-hide"),c.$("#tipTour").text(tl("com.NoValidTour")),c._disabledDom(!0,c.$('a[cmd="StartTour"],a[cmd="StopTour"],#main-ptz-historyOn-tour,#main-ptz-pause-tour'),c.$("#ptz_func_Tour"))):(c.$("#ptz_func_Tour").append(n),c._disabledDom(!1,c.$("#main-ptz-historyOn-tour,#main-ptz-pause-tour")));for(var q=0;q<k.length;q++)k[q].Enable&&(p+='<option value="'+(q+1)+'">'+(q+1)+"</option>");if(""===p?(c.$("#tipPattern").removeClass("fn-hide"),c.$("#tipPattern").text(tl("com.NoValidPattern")),c._disabledDom(!0,c.$('a[cmd="StartPattern"],a[cmd="StopPattern"],#main-ptz-historyOn-pattern,#main-ptz-pause-pattern'),c.$("#ptz_func_Pattern"))):(c.$("#ptz_func_Pattern").append(p),c._disabledDom(!1,c.$("#main-ptz-historyOn-pattern, #main-ptz-pause-pattern"))),b.AutoPanGroup){var v=!1,w=!0;c.$("#tipAutoPan").text(""),l.each(function(a){a.Enable&&w&&(v=!0,w=!1)}),v?c._disabledDom(!1,c.$("#main-ptz-historyOn-outoPan,#main-ptz-pause-outoPan")):(c.$("#tipAutoPan").removeClass("fn-hide"),c.$("#tipAutoPan").text(tl("com.NoValidAutoPan")),c._disabledDom(!0,c.$('a[cmd="AutoPanOn"],a[cmd="AutoPanOff"],#main-ptz-historyOn-outoPan,#main-ptz-pause-outoPan')))}f.ConfigManager.getConfig("PtzCurOperType").done(function(a){var b=a?a.Type:"None";if("None"!==b){switch(b){case"Scan":c._disabledDom(!0,c.$('a[cmd="AutoScanOn"]')),c.$("#ptz_func_Scan").val(g+1).prop("disabled",!0),c.$("#ptz_set_select").val("AutoScan");break;case"Tour":c._disabledDom(!0,c.$('a[cmd="StartTour"]')),c.$("#ptz_func_Tour").val(g+1).prop("disabled",!0),c.$("#ptz_set_select").val("Tour");break;case"Pattern":c._disabledDom(!0,c.$('a[cmd="StartPattern"]')),c.$("#ptz_func_Pattern").val(g+1).prop("disabled",!0),c.$("#ptz_set_select").val("Pattern");break;case"PanGroup":c._disabledDom(!0,c.$('a[cmd="AutoPanOn"]')),c.$("#ptz_set_select").val("AutoPan");break;default:c.$("#ptz_set_select").get(0).selectedIndex=0}c.$("#ptz_set_select").on("change",function(a){c.$(".u-tab.fn-hide").tab("select",c.$(a.target).val())}).change()}})})}},d.prototype._disabledDom=function(a,b,c){a?b.addClass("ui-button-special-disabled"):b.removeClass("ui-button-special-disabled"),b.prop("disabled",a),c&&c.prop("disabled",a)},d.prototype._disabled=function(a){var b=this;switch(a){case"AutoScanOn":case"AutoScanOff":b._disabledDom("AutoScanOn"===a,b.$('a[cmd="AutoScanOn"]'),b.$("#ptz_func_Scan"));break;case"StartTour":case"StopTour":b._disabledDom("StartTour"===a,b.$('a[cmd="StartTour"]'),b.$("#ptz_func_Tour"));break;case"StartPattern":case"StopPattern":b._disabledDom("StartPattern"===a,b.$('a[cmd="StartPattern"]'),b.$("#ptz_func_Pattern"));break;case"AutoPanOn":case"AutoPanOff":b._disabledDom("AutoPanOn"===a,b.$('a[cmd="AutoPanOn"]'))}},d.prototype._buildArgs=function(a){var b=this,c={arg2:0,arg3:0,arg4:0};switch(a){case"AutoScanOn":case"AutoScanOff":case"ClearAutoScan":case"SetLeftLimit":case"SetRightLimit":c.arg2=2===i?b.$("#ptz_func_Scan").val()-0:b.$("#ptz_set_autoScan").numberfield("value");break;case"GotoPreset":c.arg2=2===i?b.$("#ptz_func_Preset").val()-0:b.$("#ptz_set_preset").numberfield("value");break;case"SetPreset":case"ClearPreset":c.arg2=b.$("#ptz_set_preset").numberfield("value");break;case"StartTour":case"StopTour":c.arg2=2===i?b.$("#ptz_func_Tour").val()-0:b.$("#ptz_set_tour").numberfield("value");break;case"ClearTour":c.arg2=b.$("#ptz_set_tour").numberfield("value");break;case"AddTour":case"DelTour":c.arg2=b.$("#ptz_set_tour").numberfield("value"),c.arg3=b.$("#ptz_set_tour_add").numberfield("value");break;case"StartPattern":case"StopPattern":c.arg2=2===i?b.$("#ptz_func_Pattern").val()-0:b.$("#ptz_set_pattern").numberfield("value");break;case"SetPatternBegin":case"SetPatternEnd":case"ClearPattern":c.arg2=b.$("#ptz_set_pattern").numberfield("value");break;case"AuxOn":case"AuxOff":c.arg2=b.$("#ptz_set_aux").numberfield("value");break;case"PositionABS":c.arg2=b.$("#ptz_set_abs_x").numberfield("value"),c.arg3=b.$("#ptz_set_abs_y").numberfield("value"),c.arg4=b.$("#ptz_set_abs_zoom").numberfield("value"),2===i&&(c.arg2=10*c.arg2,c.arg3=10*c.arg3,c.arg4=0)}return b.lastCommandArg=c,c},d.prototype._chkCmd=function(b){var c=this,d={StartTour:"StopTour",AutoPanOn:"AutoPanOff",AutoScanOn:"AutoScanOff",StartPattern:"StopPattern"},e=["StartTour","AutoPanOn","AutoScanOn","StartPattern","GotoPreset","PositionABS"],g=["StopTour","AutoPanOff","AutoScanOff","StopPattern"];return a.Deferred(function(h){-1!==a.inArray(b,e)?(d.hasOwnProperty(c.lastCommand)?(f.PTZ.start(d[c.lastCommand],c.lastCommandArg.arg2,c.lastCommandArg.arg3,c.lastCommandArg.arg4).done(h.resolve).fail(h.reject),2===i&&c._disabled(d[c.lastCommand])):(h.resolve(),2===i&&"GotoPreset"!==b&&"PositionABS"!==b&&c.$("#ptz_set_select").prop("disabled",!0)),c.lastCommand=b):-1!==a.inArray(b,g)?(h.resolve(),c.lastCommand=b,2===i&&c.$("#ptz_set_select").prop("disabled",!1)):h.resolve()}).promise()},d.prototype._getStatus=function(){var a=this,b=a.$("#ptz_set_azi_show");!b.is(":hidden")&&b.hasClass("current")?(f.PTZ.getStatus().done(function(b){var c=b.Postion;a.$("#ptz_set_azi_x").val(c[0]<0?(1800*c[0]+3600).round()/10:(1800*c[0]).round()/10),a.$("#ptz_set_azi_y").val((-1*c[1]*1800).round()/10)}),setTimeout(function(){a._getStatus()},200)):(b.removeClass("current"),b.attr("t","ivs.AzimuthDispShowBtn").parent().translation())},c.exports=d})}(jQuery);