!function(a){define(function(require,b,c){var d=require("../plugin"),e={containerId:0,_ocxDraw:function(a,b,c,f){var g="",h="",i="Convex",j="XXX",f=f||"XXX";switch(a){case"CrossFenceDetection":case"CrossFenceDetectionDown":case"CrossLineDetection":case"ManStandDetection":g="XLineShape",i="",a="Polygon";break;case"CrossRegionDetection":case"TakenAwayDetection":case"MoveDetection":case"WanderDetection":case"LeftDetection":case"TakenAwayDetection":case"ParkingDetection":case"VideoAbnormalDetection":case"VehicleAnalyse":case"RioterDetection":case"ManNumDetection":case"StereoNumberStat":g="Polygon",i="";break;case"StereoNumberStat_dir":g="MidArrowLineShape",i="";break;case"NumberStat":case"MinDetectRect":case"Stereo":g="Rect",j="Rect",i="";break;case"SizeFilter":g="DRectBigSmallShape",a="DRectBigSmallShape";break;case"ModuleDetectRegion":g="ModuleDetectRegion",j="Polygon",f="ModuleDetectRegion";break;case"RuleDetectRegion":g="RuleDetectRegion",j="Polygon";case"CalibrateRegionIPC":g="CalibrateRegionIPC",j="Polygon";break;default:g=a}return b||"DRectBigSmallShape"==a?h=e._ocxDataFromProtocol(b,g,c):c&&(d.SetVideoAnalyseContainerTip(e.containerId,0,tl("com.PleaseDrawShapeTip")),h=""),c&&(j=c),d.CreateMainVideoAnalyseShape(e.containerId,0,f,g,j,h,i).done(function(a){"MidArrowLineShape"!==g&&e._ocxSetShapeName(e.containerId,a,c)})},_ocxSubDraw:function(a,b,c){if(c)var f=e._ocxDataFromProtocol(c,b);else d.SetVideoAnalyseContainerTip(e.containerId,0,tl("com.PleaseDrawShapeTip")),f="";return d.AddVideoAnalyseShape(e.containerId,a,b,f,"")},_ocxRenderDraw:function(a,b,c){var f=e._ocxDataFromProtocol(c,b);return d.AddVideoAnalyseShape(e.containerId,a,b,f,"").done(function(){})},_ocxRedraw:function(a,b){return d.SetVideoAnalyseContainerTip(e.containerId,0,tl("com.PleaseDrawShapeTip")),e._ocxAdjustEnable(a,!0),d.RedrawVideoAnalyseShape(e.containerId,a).done(function(){return b?d.RedrawVideoAnalyseShape(e.containerId,b):void 0})},OcxReceiveData:function(a,b,c){var f=b,g=f&&f.ShapeState,h=f&&f.PreShapeState,i="done";switch(a){case"SizeFilter":case"DRectBig":case"DRectSmall":i="filterMoving";break;default:if(3==g)switch(h){case 2:e._ocxEventDone(f),i="createDone";break;case 4:case 5:e._ocxEventChangeDone(f.ShapeID),i="dragDone"}else 1==g&&2==h?d.SetVideoAnalyseContainerTip(e.containerId,0,tl("com.RegionBordersCantdrawTip")):(i="mousedownSelect",e._ocxCreateDone(f))}c&&c(i,f,a)},_ocxEventDone:function(a,b){b&&"CrossFenceDetection"==a.EventName},_ocxCreateDone:function(){},_ocxEventChangeDone:function(){},_ocxEnable:function(a){a?d.CreateVideoAnalyseContainer().done(function(a){e.containerId=a,d.containerId=a,d.EnableVideoAnalyseContainer(a,!0)}):(d.containerId=0,d.DeleteAllVideoAnalyseShape(e.containerId),d.ReleaseVideoAnalyseContainer(e.containerId))},_ocxDataFromProtocol:function(a,b,c){if(void 0==a||null==a||""==a)return"";var d="XXX",e=[4096,4096],f=[e[0]-parseInt(a[0]/2),e[1]-parseInt(a[1]/2)],g=[e[0]+parseInt(a[0]/2),e[1]+parseInt(a[1]/2)],h="";switch(b){case"Rect":d="Rect",h=JSON.encode([a[0],a[2]?a[2]:a[1]]);break;case"DRectBig":return h='{"DRectBig":'+JSON.encode([f,g])+"}";case"DRectSmall":return h='{"DRectSmall":'+JSON.encode([f,g])+"}";case"Polygon":default:h=JSON.encode(a),d=b}c&&(d=c);var i='{"'+d+'":'+h+"}";return i},_filterDataChangeTo:function(a){var b=[4095,4095],c=[b[0]-a[0]/2,b[1]-a[1]/2],d=[b[0]+a[0]/2,b[1]+a[1]/2];return[c,d]},_filterDataChangeFrom:function(a){var b=a[1][0]-a[0][0],c=a[1][1]-a[0][1];return[b,c]},_ocxShowOrHide:function(a,b){return void 0!=a?(d.EnableVideoAnalyseShape(e.containerId,a,b),d.ShowVideoAnalyseShape(e.containerId,a,b)):void 0},_ocxGetData:function(a,b){return d.GetVideoAnalyseShapeConfigData(e.containerId,a).then(function(a){var c=JSON.parse(a);for(var d in c)return b?e._filterDataChangeFrom(c[d]):c[d]})},_ocxGetShapeID:function(){return d.GetSelectedVideoAnalyseShapeID(e.containerId).then(function(a){var b=JSON.parse(a);for(var c in b)return b[c]})},_ocxSelected:function(a,b){void 0!=a&&(d.SelectVideoAnalyseShape(e.containerId,a,b),1==b&&e._ocxAdjustEnable(a,b))},_ocxAdjustEnable:function(a,b){d.EnableVideoAnalyseShape(e.containerId,a,b),0==b&&e._ocxSelected(a,b)},_ocxSetShapeName:function(a,b,c){d.SetVideoAnalyseShapeShowName(a||e.containerId,b,c)},_findRuleFromShapeId:function(a){for(var b=IVSRule.rules,c=0;c<b.length;c++)if(b[c].ocxId==a)return},OutPutRuleRect:function(a){e._disabledDraw(!1);var b=JSON.decode(a);b.OutPutRuleRect&&(videoAnalyseRuleJson.Config.MinDetectRect=b.OutPutRuleRect)},setFilterValue:function(a){e._disabledDraw(!1);var b=JSON.decode(a);b.MinRect?videoAnalyseRuleJson.Config.SizeFilter.MinSize=b.MinRect:b.MaxRect&&(videoAnalyseRuleJson.Config.SizeFilter.MaxSize=b.MaxRect)}};c.exports={render:function(a){d.addEvent&&d.addEvent("VideoAnalyzeConfig",function(b,c){e.OcxReceiveData(b,c,a)}),e._ocxEnable(!0)},leave:function(){d.addEvent("VideoAnalyzeConfig",null),e._ocxEnable(!1)},createShape:function(a,b,c,d){return e._ocxDraw(a,b,c,d)},createSubShape:function(a,b,c){return e._ocxSubDraw(a,b,c)},shapeDelete:function(a){return d.DeleteVideoAnalyseShape(e.containerId,a)},shapeDeleteAll:function(){d.DeleteAllVideoAnalyseShape(e.containerId)},selectShape:function(a,b){e._ocxSelected(a,b)},getData:function(a,b){return e._ocxGetData(a,b)},getShapeID:function(){return e._ocxGetShapeID()},showShape:function(b,c){if(void 0==b)return a.Deferred(function(a){a.resolve()});var d=e._ocxShowOrHide(b,!0);return d.done(function(){return void 0==c?d:e._ocxShowOrHide(c,!0)})},hideShape:function(b,c){if(void 0==b)return a.Deferred(function(a){a.resolve()});var d=e._ocxShowOrHide(b,!1);return d.done(function(){return void 0==c?d:e._ocxShowOrHide(c,!1)})},showOrHideScale:function(a,b){return e._ocxShowOrHide(a,b)},setTip:function(a,b){d.SetVideoAnalyseShapeShowName(e.containerId,a,b)},chooseShape:function(a,b,c){void 0===c&&(c=!0),a&&(e._ocxSelected(a,c),b&&(e._ocxShowOrHide(b,!0),e._ocxSelected(b,c)))},reDrawShape:function(a,b){return e._ocxRedraw(a,b)},ocxSetShapeTip:function(a){return d.SetVideoAnalyseContainerTip(e.containerId,0,a)},ocxDirection:function(a,b){if(void 0!=b){var c={None:-1,Enter:0,Leave:1,LeftToRight:0,RightToLeft:1,Both:2};return b=c[b],d.SetVideoAnalyseShapeDirection(e.containerId,a,b)}},ocxSetColor:function(a,b,c){void 0===c&&(c=!0);var f=0,g=0,h=255;switch(b){case"yellow":f=255,g=255,h=0;break;case"blue":f=0,g=0,h=255;break;case"green":f=0,g=255,h=0;break;case"lightblue":f=6,g=200,h=249}return d.SetVideoAnalyseShapeColor(e.containerId,a,f,g,h,c)},ocxAdjust:function(a,b,c){e._ocxAdjustEnable(a,c),b&&e._ocxAdjustEnable(b,c)},destory:function(){d.addEvent("VideoAnalyzeConfig",null),e._ocxEnable(!1)},ocxSetShapeName:function(a,b){e._ocxSetShapeName("",a,b)},ocxDrawEnable:function(a){return d.EnableVideoAnalyseContainer(e.containerId,a)},filterDataChangeFrom:function(a){return e._filterDataChangeFrom(a)}}})}(jQuery);