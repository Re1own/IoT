!function(a){define(function(require,b,c){function d(a,b){switch(a){case"Line":newData={points:b};break;case"Arc":break;case"Rect":break;case"Polygon":}return b}function e(a){var b,c,d,e;return a[0][0]<0&&(a[0][0]=0),a[0][1]<0&&(a[0][1]=0),a[0][0]>a[1][0]?(b=a[1][0],c=a[0][0]):(b=a[0][0],c=a[1][0]),a[0][1]>a[1][1]?(d=a[1][1],e=a[0][1]):(d=a[0][1],e=a[1][1]),[[b,d],[c,e]]}function f(a){if(a.length<3)return!1;for(var b=[],c=0;c<a.length-1;c++)b[c]=[a[c],a[c+1]];for(b[a.length-1]=[a[a.length-1],a[0]],c=2;c<b.length;c++)for(var d=0;c-1>d;d++)if(g(b[c],b[d])===!0)return!1;return!0}function g(a,b){var c={x:a[0][0]-b[0][0],y:a[0][1]-b[0][1]},d={x:a[1][0]-b[0][0],y:a[1][1]-b[0][1]},e={x:b[1][0]-b[0][0],y:b[1][1]-b[0][1]},f=h(c,e)*h(d,e);c={x:b[0][0]-a[0][0],y:b[0][1]-a[0][1]},d={x:b[1][0]-a[0][0],y:b[1][1]-a[0][1]},e={x:a[1][0]-a[0][0],y:a[1][1]-a[0][1]};var g=h(c,e)*h(d,e);return 0>f&&0>g?!0:!1}function h(a,b){return a.x*b.y-a.y*b.x}function k(a,b,c,d){return x(a,b,c,d)||v(a,b,c)?!0:(sb="Outside",!1)}function l(a){for(var b=a.toString(16);b.length<6;)b="0"+b;var c=b.substring(4),d=b.substring(2,4),e=b.substring(0,2),f="#"+c+d+e;return f}function m(a,b){var c=null;return void 0===a?[[0,0],[0,0]]:c=[[(b[0]-a[0])/2,(b[1]-a[1])/2],[(b[0]+a[0])/2,(b[1]+a[1])/2]]}function n(a){var b=null;return void 0===a?[0,0]:b=[a[1][0]-a[0][0],a[1][1]-a[0][1]]}function o(a,b){var c,d,e,f;return c=Math.floor(a[0]/mb.xStep),d=Math.floor(a[1]/mb.yStep),e=Math.floor(b[0]/mb.xStep),f=Math.floor(b[1]/mb.yStep),[[Math.min(c,e),Math.min(d,f)],[Math.max(c,e),Math.max(d,f)]]}function p(b){function c(b){$.fillStyle=l(b.color-0),a.each(b.matrix,function(b,c){if(c.length===mb.column)a.each(c.split(""),function(a,c){c-0&&$.fillRect(mb.matrix[b][a][0],mb.matrix[b][a][1],mb.xStep,mb.yStep)});else{var d=mb.column-c.length;a.each(c.split(""),function(a,c){c-0&&$.fillRect(mb.matrix[b][a+d][0],mb.matrix[b][a+d][1],mb.xStep,mb.yStep)})}})}s(),$.globalAlpha=.7,a.each(b,function(a,b){(null===pb||a!==pb)&&c(b)}),null!==pb&&c(b[pb])}function q(b,c,d){var e=b.split(""),f="",g=r();return a.each(e,function(a,b){f+=a>=c&&d>=a?g:b}),f}function r(){if(!jb||!mb||null===pb||void 0===pb||""===pb)return 0;var a=Math.floor(jb[0]/mb.xStep),b=Math.floor(jb[1]/mb.yStep);return 1-mb.matrixValue[pb].matrix[b].charAt(a)+""}function s(){$.clearRect(0,0,Z.prop("width"),Z.prop("height")),$.strokeStyle="#C8C8C8",$.beginPath();var a;for(a=0;a<mb.column+1;a++)$.moveTo(mb.xStep*a,0),$.lineTo(mb.xStep*a,Z.prop("height"));for(a=0;a<mb.row+1;a++)$.moveTo(0,mb.yStep*a),$.lineTo(Z.prop("width"),mb.yStep*a);$.stroke(),$.fillStyle="#C8C8C8",$.globalAlpha=.5,$.fillRect(0,0,Z.prop("width"),Z.prop("height"))}function t(b){var c="";return a.each(b,function(b,d){var e=[];a.each(d.matrix,function(a,b){e[a]=parseInt(b,2)}),c=b?c+" "+b+"@"+d.color+"-"+e.join(":"):c+b+"@"+d.color+"-"+e.join(":")}),c}function u(a){var b,c,d,e=0,f=a[0];if(a.length<3)return!0;if(3===a.length)b=a[1],c=a[0],d=a[2];else{for(var g=0;g<a.length;g++)a[g][1]>f[1]&&(f=a[g],e=g);b=a[e],c=a[e-1],d=a[e+1],void 0===c&&(c=a[a.length-1]),void 0===d&&(d=a[0])}var h=[b[0]-c[0],b[1]-c[1]],i=[d[0]-b[0],d[1]-b[1]];return h[0]*i[1]-h[1]*i[0]>0?!0:!1}function v(a,b,c,d){var e=null;return c?a[0]>b[0][0]&&a[0]<b[1][0]&&a[1]>b[0][1]&&a[1]<b[1][1]?((void 0===d||d)&&(sb="Inside"),!0):((void 0===d||d)&&(sb="Outside"),!1):(e=w(a,b),(void 0===d||d)&&(sb=e),"Inside"===e?!0:!1)}function w(a,b){for(var c=a[0],d=a[1],e=0,f=0,g=b.length,h=g-1;g>f;h=f,f++){var i=b[f][0],j=b[f][1],k=b[h][0],l=b[h][1],m=Math.atan2(j-d,i-c)-Math.atan2(l-d,k-c);m>=Math.PI?m-=2*Math.PI:m<=-Math.PI&&(m+=2*Math.PI),e+=m}return 0===Math.round(e/Math.PI)?"Outside":"Inside"}function x(a,b,c,d){if(c)return d?!1:Math.sqrt(Math.pow(a[0]-b[0][0],2)+Math.pow(a[1]-b[0][1],2))<4?(sb="OnPointLT",!0):Math.sqrt(Math.pow(a[0]-b[1][0],2)+Math.pow(a[1]-b[0][1],2))<4?(sb="OnPointRT",!0):Math.sqrt(Math.pow(a[0]-b[1][0],2)+Math.pow(a[1]-b[1][1],2))<4?(sb="OnPointRB",!0):Math.sqrt(Math.pow(a[0]-b[0][0],2)+Math.pow(a[1]-b[1][1],2))<4?(sb="OnPointLB",!0):!1;for(i=0;i<b.length;i++)Math.sqrt(Math.pow(a[0]-b[i][0],2)+Math.pow(a[1]-b[i][1],2))<4&&(sb="OnPoint"+i);return sb.indexOf("OnPoint")>-1?!0:!1}function y(a,b){for(i=0;i<b.length;i++)if(Math.sqrt(Math.pow(a[0]-b[i][0],2)+Math.pow(a[1]-b[i][1],2))<120)return i;return-1}function z(a,b){var c,d,e,f,g=(b[1][1]-b[0][1])/(b[1][0]-b[0][0]),h=(b[1][0]*b[0][1]-b[0][0]*b[1][1])/(b[1][0]-b[0][0]),i=Math.abs((g*a[0]-a[1]+h)/Math.sqrt(Math.pow(g,2)+1));return b[0][0]>b[1][0]?(c=b[0][0],d=b[1][0]):(c=b[1][0],d=b[0][0]),b[0][1]>b[1][1]?(e=b[0][1],f=b[1][1]):(e=b[1][1],f=b[0][1]),c===d&&a[0]>=d-5&&a[0]<=c+5&&a[1]>=f-5&&a[1]<=e+5?(sb="OnLine",!0):a[0]>=d-5&&a[0]<=c+5&&a[1]>=f-5&&a[1]<=e+5&&5>=i?(sb="OnLine",!0):!1}function A(a,b){var c=b.length;if(3>c)return sb="Outside",!1;for(var d=0;c-1>d;d++)z(a,[b[d],b[d+1]])&&(sb="OnLine");return z(a,[b[c-1],b[0]])&&(sb="OnLine"),"OnLine"===sb?!0:(sb="Outside",!1)}function B(b){if(null===b)return[];var c=[];return a.each(b,function(a,b){c[a]=[(8191*b[0]/Z.prop("width")).toFixed(0)-0,(8191*b[1]/Z.prop("height")).toFixed(0)-0]}),c}function C(b){if(null===b)return[];var c=[];return a.each(b,function(a,b){c[a]=[(b[0]*webApp.resolution.x/Z.prop("width")).toFixed(0)-0,(b[1]*webApp.resolution.y/Z.prop("height")).toFixed(0)-0]}),c}function D(b){if(!b||!Z)return[];var c=[];return a.each(b,function(a,b){c[a]=[parseInt(b[0]*Z.prop("width")/8191),parseInt(b[1]*Z.prop("height")/8191)]}),c}function E(b){if(!b||!Z)return[];var c=[];return a.each(b,function(a,b){c[a]=[parseInt(b[0]*Z.prop("width")/webApp.resolution.x),parseInt(b[1]*Z.prop("height")/webApp.resolution.y)]}),c}function F(b,c){a.each(ab[b].Shapes,function(a){a==c?(ab[b].Shapes[a].show=!0,ob=ab[b].Shapes[a].shapeName):Rb.showMult||(ab[b].Shapes[a].show=!1)})}function G(b){fb=null;var c=null;$.clearRect(0,0,Z.prop("width"),Z.prop("height")),a.each(ab[b].Shapes,function(a,b){b.show&&(fb=b,c=a,H(fb))}),fb&&"CalibrateRegionIPC"===fb.shapeName&&!Eb?($.beginPath(),a.each(ab[b].Shapes,function(a,b){b.mainShapeID==c&&b.isValidate===Eb&&b.data&&b.data.length>1&&(ob=b.shapeName,$.moveTo(b.data[0][0],b.data[0][1]),$.lineTo(b.data[1][0],b.data[1][1]))}),$.stroke()):fb&&"DetectRegion"===fb.shapeName&&a.each(ab[b].Shapes,function(a,b){if(b.mainShapeID==c){for($.beginPath(),ob=b.shapeName,j=0;j<b.data.length;j++)j?$.lineTo(b.data[j][0],b.data[j][1]):$.moveTo(b.data[j][0],b.data[j][1]);$.closePath(),$.stroke()}})}function H(b){if(null===b)return!1;if("DRectBigSmallShape"===b.shapeName)$.strokeStyle="#06C8F9",$.beginPath(),a.each(b.subShapes,function(a,b){$.lineWidth=b.sel?2:1,2===b.data.length&&($.rect(b.data[0][0],b.data[0][1],b.data[1][0]-b.data[0][0],b.data[1][1]-b.data[0][1]),$.closePath())}),$.stroke();else if($.fillStyle=b.fillStyle,$.strokeStyle=b.strokeStyle,$.lineWidth=b.lineWidth?b.lineWidth:1,b.show)if(b.filled)b.fill();else{b.stroke();var c=-1;if(-1!==b.direction&&b.points.length>=2){c=["CalibrateAreaShape","CalibrateRegionIPC","Polygon","DetectRegion"].indexOf(b.shapeName)>-1&&!u(b.points)&&2!=b.direction?1-b.direction:b.direction,$.save(),$.beginPath();var d=[];d[0]=b.points[(b.points.length/2).toInt()-1],d[1]=b.points[(b.points.length/2).toInt()],"RuleDetectRegion"===b.shapeName&&(d[0]=b.points[0],d[1]=[b.points[0][0],b.points[1][1]]);var e=J(d[0],d[1],c,25);a.each(e,function(a,b){$.moveTo(b[0][0],b[0][1]),$.lineTo(b[1][0],b[1][1])}),$.stroke(),$.restore()}if(b.showName&&b.points.length>1){var f=b.points[0],g=b.points[1],h=Math.atan((g[1]-f[1])/(g[0]-f[0]));g[0]-f[0]===0?$.strokeText(b.showName,f[0]+5,f[1]+10):g[0]-f[0]>0?($.translate(f[0],f[1]),$.rotate(h),$.strokeText(b.showName,5,-5),$.rotate(-h),$.translate(-f[0],-f[1])):($.translate(g[0],g[1]),$.rotate(h),$.strokeText(b.showName,5,-5),$.rotate(-h),$.translate(-g[0],-g[1]))}}}function I(b){var c=!0;return a.each(b,function(a,b){(b[0]<0||b[0]>Z.prop("width")||b[1]<0||b[1]>Z.prop("height"))&&(c=!1)}),c}function J(a,b,c,d){if(!a||!b||a[0]==b[0]&&a[1]==b[1])return null;var e=K(a,b,d),f=[],g=[(a[0]+b[0])/2,(a[1]+b[1])/2],h=[(g[0]+e[0][0])/2,(g[1]+e[0][1])/2],i=[(g[0]+e[1][0])/2,(g[1]+e[1][1])/2];if(f.push(e),2==c||1==c){var j=L(h,e[0],30),k=L(h,e[0],330);f.push(j,k)}if(2==c||0===c){var l=L(i,e[1],30),m=L(i,e[1],330);f.push(l,m)}return f}function K(a,b,c){var d;d=b[0]==a[0]?Math.PI/180*90:Math.atan((b[1]-a[1])/(b[0]-a[0]));var e=Math.sin(d),f=Math.cos(d),g=[],h=[],i=[];return g[0]=(a[0]+b[0])/2-c*e,g[1]=(a[1]+b[1])/2+c*f,h[0]=(a[0]+b[0])/2+c*e,h[1]=(a[1]+b[1])/2-c*f,b[0]>=a[0]?(i[0]=h,i[1]=g):(i[0]=g,i[1]=h),i}function L(a,b,c){var d=Math.sin(Math.PI/180*c),e=Math.cos(Math.PI/180*c),f=(a[0]-b[0])*e-(a[1]-b[1])*d+b[0],g=(a[1]-b[1])*e+(a[0]-b[0])*d+b[1],h=[b[0],b[1]],i=[f,g],j=[h,i];return j}function M(b,c){var d=null,e=null;return a.each(b,function(a,b){b.sel?d=b.subShapeName:e=b.data}),e&&e.length?"DRectBig"===d?c[1][0]-c[0][0]>e[1][0]-e[0][0]+2&&c[1][1]-c[0][1]>e[1][1]-e[0][1]+2:c[1][0]-c[0][0]+2<e[1][0]-e[0][0]&&c[1][1]-c[0][1]+2<e[1][1]-e[0][1]:!0}function N(a,b){if("PixelCount"===ob){var c=E(b),d=c[0],e=[c[1][0],c[0][1]],f=Math.atan((e[1]-d[1])/(e[0]-d[0]));$.translate(d[0],d[1]),$.rotate(f),$.strokeText(Math.abs(b[1][0]-b[0][0])+"*"+Math.abs(b[1][1]-b[0][1]),5,12),$.rotate(-f),$.translate(-d[0],-d[1])}}function O(b){if("FireDetect"!==ob||0!==Rb.enabled)switch(jb=[b.clientX-Z.offset().left+window.scrollX,b.clientY-Z.offset().top+window.scrollY],Fb=null,1===b.which?lb="Left":3===b.which&&(lb="Right"),ob){case"MotionDetect":var c=o(jb,jb);nb=a.extend(!0,{},mb),$.clearRect(0,0,Z.prop("width"),Z.prop("height"));for(var d=c[0][1];d<=c[1][1];d++)nb.matrixValue[pb].matrix[d]=q(nb.matrixValue[pb].matrix[d],c[0][0],c[1][0]);p(nb.matrixValue);break;case"VideoCut":case"VideoOsd":case"FireDetect":a.each(qb.osdArr,function(a,b){return b&&k(jb,b,!0,zb)?(rb=a,!1):void 0}),tb=a.extend(!0,[],qb.osdArr[rb]),xb=!1,"Outside"==sb&&yb.length>0&&("FireDetect"===ob?1===Rb.drawEnable&&(xb=!0):xb=!0,rb=yb[0]);break;case"RuleRect":if(1===Rb.drawEnable){switch(Kb){case 0:Hb[Jb].LeftLine=[],Hb[Jb].LeftLine[0]=[jb[0],jb[1]];break;case 1:Hb[Jb].LeftLine[1]=[jb[0],jb[1]];break;case 2:Hb[Jb].RightLine=[],Hb[Jb].RightLine[0]=[jb[0],jb[1]];break;case 3:var e=W(Hb[Jb].LeftLine[0],Hb[Jb].LeftLine[1],Hb[Jb].RightLine[0],jb),g=U(Hb[Jb].LeftLine[0][1],Hb[Jb].LeftLine[1][1]),h=U(Hb[Jb].RightLine[0][1],jb[1]);if(g!==h||e)return!1;Hb[Jb].RightLine[1]=[jb[0],jb[1]]}4>Kb&&Kb++}break;case"DetectLine":1===Rb.drawEnable&&(Hb[Jb].DetectLine=[],Hb[Jb].DetectLine[0]||(Hb[Jb].DetectLine[0]=[jb[0],jb[1]]));break;case"DetectRegionRect":if(Ib&&4==Ib.length){var i=w([Math.floor(8191*jb[0]/Z.prop("width")),Math.floor(8191*jb[1]/Z.prop("height"))],Ib);"Inside"==i?(Mb="move",Nb=a.extend(!0,[],Ib)):(sb="",Pb=y([Math.floor(8191*jb[0]/Z.prop("width")),Math.floor(8191*jb[1]/Z.prop("height"))],Ib),Mb="resize")}else Mb="draw",Ib=[],Ib[0]=[],Ib[0][0]=Math.floor(8191*jb[0]/Z.prop("width")),Ib[0][1]=Math.floor(8191*jb[1]/Z.prop("height"));break;case"DFilter":if(Ob&&Ob.DFilter&&4===Ob.DFilter.length){var i=v([Math.floor(8191*jb[0]/Z.prop("width")),Math.floor(8191*jb[1]/Z.prop("height"))],Ob.DFilter,!0,!1);i&&(Mb="move",Nb=a.extend(!0,[],Ob))}break;case"ArrowLineShape":case"LaneShape":case"XLineShape":case"LineShape":case"ModuleDetectRegion":case"RuleDetectRegion":case"DRectFilterShape":case"MinGatherRegion":case"Rect":case"PixelCount":case"CalibrateAreaShape":case"CalibrateRegionIPC":case"DetectRegion":case"Polygon":if(hb===_.ToDo||hb===_.Doing){if("Right"===lb){if(gb.length<2&&["ArrowLineShape","LaneShape","XLineShape","LineShape"].indexOf(ob)>-1)break;if(gb.length<3&&["CalibrateAreaShape","CalibrateRegionIPC","Polygon","DetectRegion"].indexOf(ob)>-1)break;hb=_.Done,a.each(ab[bb].Shapes,function(b,c){c.show&&db==b&&(ab[bb].Shapes[b].points=a.extend(!0,[],gb),gb=[])}),G(cb),hb=_.Done,a.publish("IVSRuleConfig",{data:B(ab[bb].Shapes[db].points),containerID:bb,shapeID:db,shapeName:ob}),jb=null,kb=null,sb="Outside"}else if("Left"===lb){if(-1!==["MinGatherRegion","PixelCount","RuleDetectRegion"].indexOf(ob)){hb=_.Doing;break}(-1===["CalibrateAreaShape","CalibrateRegionIPC","Polygon","DetectRegion"].indexOf(ob)||gb.length<3||f(gb.concat([jb])))&&(gb.push(jb),hb=_.Doing)}}else hb===_.Done&&"Left"===lb?a.each(ab[bb].Shapes,function(a,b){return b&&b.show&&b.points&&(b.sel||b.editable)&&k(jb,b.points,-1!==["MinGatherRegion","PixelCount","RuleDetectRegion"].indexOf(b.shapeName))?(sb.indexOf("OnPoint")>-1?hb=_.Edit:sb.indexOf("Inside")>-1&&(hb=_.Drag),db=a,fb=b,!1):void 0}):hb===_.Done&&"Right"===lb&&a.each(ab[bb].Shapes,function(a,b){b.show&&(ab[bb].Shapes[a].sel=!1)});break;case"DRectBigSmallShape":hb!==_.ToDo&&hb!==_.Doing||"Left"!==lb?hb!==_.Done&&hb!==_.Edit||"Left"!==lb||(x(jb,gb,!0)?hb=_.Edit:v(jb,gb,!0)&&(hb=_.Drag)):hb=_.Doing;break;case"VerticalLine":case"HorizontalLine":ab[bb].Shapes[db]&&(hb===_.Done&&x(jb,ab[bb].Shapes[db].points,!1)?(hb=_.Edit,sb="OnMainShapePoint"+parseInt(sb.split("OnPoint")[1])):hb===_.Done&&A(jb,ab[bb].Shapes[db].points,!1)?(hb=_.Drag,sb="OnMainShapeBorder"):v(jb,ab[bb].Shapes[db].points,!1)&&(hb===_.ToDo?(hb=_.Doing,gb.push(jb)):hb===_.Done&&a.each(ab[bb].Shapes,function(b,c){if(c.mainShapeID&&c.mainShapeID===db){if(x(jb,c.data,!1)&&c.isValidate===Eb)return curSubShapeID=b-0,hb=_.Edit,ob=c.shapeName,gb=a.extend(!0,[],c.data),!1;if(z(jb,c.data)&&c.isValidate===Eb)return curSubShapeID=b-0,hb=_.Drag,gb=a.extend(!0,[],c.data),!1}})));break;case"ExcludeRegion":if(hb===_.Done&&x(jb,ab[bb].Shapes[db].points,!1));else if(hb===_.Done&&A(jb,ab[bb].Shapes[db].points,!1))hb=_.Drag,sb="OnMainShapeBorder";else if(v(jb,ab[bb].Shapes[db].points,!1)&&(hb===_.ToDo||hb===_.Doing))if("Right"===lb){if(gb.length<3)break;hb=_.Done,a.each(ab[bb].Shapes,function(b){b==curSubShapeID&&(ab[bb].Shapes[b].data=a.extend(!0,[],gb))}),G(cb),a.publish("IVSRuleConfig",{data:B(gb),containerID:bb,shapeID:db,shapeName:ob}),gb=[],hb=_.Done,jb=null,kb=null,sb="Outside"}else"Left"===lb&&(gb.push(jb),hb=_.Doing);break;case"MoveDirectly":}}function P(b){if(("FireDetect"!==ob||0!==Rb.enabled)&&(kb=[b.clientX-Z.offset().left+window.scrollX,b.clientY-Z.offset().top+window.scrollY],jb||hb===_.Doing)){var c=o(jb,kb);ub=null;switch(nb=a.extend(!0,{},mb),ob){case"MotionDetect":if(1!==b.which)break;$.clearRect(0,0,Z.prop("width"),Z.prop("height"));for(var d=c[0][1];d<=c[1][1];d++)nb.matrixValue[pb].matrix[d]=q(nb.matrixValue[pb].matrix[d],c[0][0],c[1][0]);p(nb.matrixValue);break;case"VideoCut":case"VideoOsd":case"FireDetect":switch("FireDetect"==ob&&($.strokeStyle="#00FF00"),sb){case"OnPointLT":case"OnPointRT":case"OnPointLB":case"OnPointRB":if(kb[0]>Z.prop("width")||kb[1]>Z.prop("height")||kb[0]<0||kb[1]<0)return;if("VideoCut"===ob){var f=a.extend(!0,[],qb.osdArr[rb]);if(sb.indexOf("OnPointRB")>-1?(qb.osdArr[rb][1][0]=qb.osdArr[rb][1][0]+Db.width*(kb[1]-qb.osdArr[rb][1][1])/Db.height,qb.osdArr[rb][1][1]=kb[1]):sb.indexOf("OnPointLT")>-1?(qb.osdArr[rb][0][0]=qb.osdArr[rb][0][0]-Db.width*(qb.osdArr[rb][0][1]-kb[1])/Db.height,qb.osdArr[rb][0][1]=kb[1]):sb.indexOf("OnPointRT")>-1?(qb.osdArr[rb][1][0]=qb.osdArr[rb][1][0]+Db.width*(qb.osdArr[rb][0][1]-kb[1])/Db.height,qb.osdArr[rb][0][1]=kb[1]):sb.indexOf("OnPointLB")>-1&&(qb.osdArr[rb][0][0]=qb.osdArr[rb][0][0]-Db.width*(kb[1]-qb.osdArr[rb][1][1])/Db.height,qb.osdArr[rb][1][1]=kb[1]),qb.osdArr[rb]=e(qb.osdArr[rb]),qb.osdArr[rb][1][0]-qb.osdArr[rb][0][0]<Db.width||qb.osdArr[rb][1][1]-qb.osdArr[rb][0][1]<Db.height||qb.osdArr[rb][1][0]>Z.prop("width")||qb.osdArr[rb][1][1]>Z.prop("height")||qb.osdArr[rb][0][0]<0||qb.osdArr[rb][0][1]<0)return void(qb.osdArr[rb]=a.extend(!0,[],f));$.strokeStyle="#00FF00",$.setLineDash([4,2]),$.lineDashOffset=0}else sb.indexOf("OnPointRB")>-1?qb.osdArr[rb][1]=a.extend(!0,[],kb):sb.indexOf("OnPointLT")>-1?qb.osdArr[rb][0]=a.extend(!0,[],kb):sb.indexOf("OnPointRT")>-1?(qb.osdArr[rb][1][0]=kb[0],qb.osdArr[rb][0][1]=kb[1]):sb.indexOf("OnPointLB")>-1&&(qb.osdArr[rb][0][0]=kb[0],qb.osdArr[rb][1][1]=kb[1]),qb.osdArr[rb]=e(qb.osdArr[rb]);$.clearRect(0,0,Z.prop("width"),Z.prop("height")),$.beginPath(),a.each(qb.osdArr,function(a,b){$.rect(b[0][0],b[0][1],b[1][0]-b[0][0],b[1][1]-b[0][1]),$.closePath(),Ab&&$.fillRect(b[0][0],b[0][1],b[1][0]-b[0][0],b[1][1]-b[0][1])}),$.stroke();break;case"Inside":var g=kb[0]-jb[0],h=kb[1]-jb[1];if(tb[0][0]+g<0||tb[0][1]+h<0||tb[1][0]+g>Z.prop("width")||tb[1][1]+h>Z.prop("height"))return;qb.osdArr[rb]=[[tb[0][0]+g,tb[0][1]+h],[tb[1][0]+g,tb[1][1]+h]],"VideoCut"===ob&&($.strokeStyle="#00FF00",$.setLineDash([4,2]),$.lineDashOffset=0),$.clearRect(0,0,Z.prop("width"),Z.prop("height")),$.beginPath(),a.each(qb.osdArr,function(a,b){$.rect(b[0][0],b[0][1],b[1][0]-b[0][0],b[1][1]-b[0][1]),$.closePath(),Ab&&$.fillRect(b[0][0],b[0][1],b[1][0]-b[0][0],b[1][1]-b[0][1])}),$.stroke()}if(xb){var i=[[jb[0],jb[1]],[kb[0],kb[1]]];"FireDetect"!==ob&&(ob="VideoOsd",$.strokeStyle="#FFFF00"),$.globalAlpha=1,$.fillStyle="#000",$.clearRect(0,0,Z.prop("width"),Z.prop("height")),$.beginPath(),$.rect(i[0][0],i[0][1],i[1][0]-i[0][0],i[1][1]-i[0][1]),$.closePath(),a.each(qb.osdArr,function(a,b){b[0][0]!=b[1][0]&&b[0][1]!=b[1][1]&&($.rect(b[0][0],b[0][1],b[1][0]-b[0][0],b[1][1]-b[0][1]),$.closePath(),Ab&&$.fillRect(b[0][0],b[0][1],b[1][0]-b[0][0],b[1][1]-b[0][1]))}),$.stroke(),Ab&&$.fillRect(i[0][0],i[0][1],i[1][0]-i[0][0],i[1][1]-i[0][1])}"FireDetect"==ob&&Rb.SetFireDetectBackLine(5,Rb.backLines,Rb.backSpots);break;case"RuleRect":if(1===Rb.drawEnable){switch(Kb){case 1:Hb[Jb].LeftLine[1]=[kb[0],kb[1]];break;case 2:Hb[Jb].RightLine=[],Hb[Jb].RightLine[0]=[kb[0],kb[1]];break;case 3:Hb[Jb].RightLine[1]=[kb[0],kb[1]];var k=W(Hb[Jb].LeftLine[0],Hb[Jb].LeftLine[1],Hb[Jb].RightLine[0],Hb[Jb].RightLine[1]),l=U(Hb[Jb].LeftLine[0][1],Hb[Jb].LeftLine[1][1]),m=U(Hb[Jb].RightLine[0][1],kb[1]);if(l!==m||k)return Hb[Jb].RightLine.length=1,!1;Hb[Jb].RightLine[1]=[kb[0],kb[1]]}S()}break;case"DetectLine":1===Rb.drawEnable&&Hb[Jb].DetectLine&&Hb[Jb].DetectLine[0]&&(Hb[Jb].DetectLine[1]=[kb[0],kb[1]],S());break;case"DetectRegionRect":if("move"==Mb){var n=Math.floor(8191*kb[0]/Z.prop("width"))-Math.floor(8191*jb[0]/Z.prop("width")),r=Math.floor(8191*kb[1]/Z.prop("height"))-Math.floor(8191*jb[1]/Z.prop("height")),s=w([Nb[0][0]+n,Nb[0][1]+r],[[0,0],[8191,0],[8191,8191],[0,8191]]),t=w([Nb[2][0]+n,Nb[2][1]+r],[[0,0],[8191,0],[8191,8191],[0,8191]]);if("Inside"!=s||"Inside"!=t)return void Z.trigger("mouseup");Ib[0][0]=Nb[0][0]+n,Ib[0][1]=Nb[0][1]+r,Ib[2][0]=Nb[2][0]+n,Ib[2][1]=Nb[2][1]+r,S()}else if("resize"==Mb){var s=w([Math.floor(8191*kb[0]/Z.prop("width")),Math.floor(8191*kb[1]/Z.prop("height"))],[[0,0],[8191,0],[8191,8191],[0,8191]]);if("Inside"!=s)return void Z.trigger("mouseup");switch(Pb){case 0:Ib[0][0]=Math.floor(8191*kb[0]/Z.prop("width")),Ib[0][1]=Math.floor(8191*kb[1]/Z.prop("height"));break;case 1:Ib[0][0]=Math.floor(8191*kb[0]/Z.prop("width")),Ib[2][1]=Math.floor(8191*kb[1]/Z.prop("height"));break;case 2:Ib[2][0]=Math.floor(8191*kb[0]/Z.prop("width")),Ib[2][1]=Math.floor(8191*kb[1]/Z.prop("height"));break;case 3:Ib[0][1]=Math.floor(8191*kb[1]/Z.prop("height")),Ib[2][0]=Math.floor(8191*kb[0]/Z.prop("width"))}S()}else if("draw"==Mb){var s=w([Math.floor(8191*kb[0]/Z.prop("width")),Math.floor(8191*kb[1]/Z.prop("height"))],[[0,0],[8191,0],[8191,8191],[0,8191]]);if("Inside"!=s)return void Z.trigger("mouseup");Ib[2]=[],Ib[2][0]=Math.floor(8191*kb[0]/Z.prop("width")),Ib[2][1]=Math.floor(8191*kb[1]/Z.prop("height")),S()}break;case"DFilter":if("move"==Mb){var n=Math.floor(8191*kb[0]/Z.prop("width"))-Math.floor(8191*jb[0]/Z.prop("width")),r=Math.floor(8191*kb[1]/Z.prop("height"))-Math.floor(8191*jb[1]/Z.prop("height")),s=w([Nb.DFilter[0][0]+n,Nb.DFilter[0][1]+r],[[0,0],[8191,0],[8191,8191],[0,8191]]),t=w([Nb.DFilter[1][0]+n,Nb.DFilter[1][1]+r],[[0,0],[8191,0],[8191,8191],[0,8191]]);if("Inside"!=s||"Inside"!=t)return void Z.trigger("mouseup");Ob.DFilter[0][0]=Nb.DFilter[0][0]+n,Ob.DFilter[0][1]=Nb.DFilter[0][1]+r,Ob.DFilter[1][0]=Nb.DFilter[1][0]+n,Ob.DFilter[1][1]=Nb.DFilter[1][1]+r,Ob.DFilter[2][0]=Nb.DFilter[2][0]+n,Ob.DFilter[2][1]=Nb.DFilter[2][1]+r,Ob.DFilter[3][0]=Nb.DFilter[3][0]+n,Ob.DFilter[3][1]=Nb.DFilter[3][1]+r,S()}break;case"ArrowLineShape":case"LaneShape":case"XLineShape":case"LineShape":case"ModuleDetectRegion":case"RuleDetectRegion":case"DRectFilterShape":case"MinGatherRegion":case"Rect":case"PixelCount":case"CalibrateAreaShape":case"CalibrateRegionIPC":case"DetectRegion":case"Polygon":if(hb===_.Doing){if(-1!==["MinGatherRegion","PixelCount","RuleDetectRegion"].indexOf(ob)){$.clearRect(0,0,Z.prop("width"),Z.prop("height")),$.beginPath(),$.rect(jb[0],jb[1],kb[0]-jb[0],kb[1]-jb[1]),$.stroke(),N(ob,C([jb,kb]));break}ub=a.extend(!0,[],gb),ub.push(kb),$.clearRect(0,0,Z.prop("width"),Z.prop("height")),$.beginPath(),a.each(ub,function(a,b){a>0?$.lineTo(b[0],b[1]):$.moveTo(b[0],b[1])}),["CalibrateAreaShape","CalibrateRegionIPC","Polygon","DetectRegion"].indexOf(ob)>-1&&$.closePath(),$.stroke()}else if(hb===_.Drag&&"Inside"===sb){var u=a.extend(!0,[],fb.points);if(a.each(u,function(a){u[a][0]=parseInt(u[a][0])+parseInt(kb[0])-parseInt(jb[0]),u[a][1]=parseInt(u[a][1])+parseInt(kb[1])-parseInt(jb[1])}),!I(u))return null===Fb&&(Fb=a.extend(!0,[],vb)),!1;ub=a.extend(!0,[],u),vb=a.extend(!0,[],u),Fb=null}else if(hb===_.Edit&&sb.indexOf("OnPoint")>-1)ub=a.extend(!0,[],fb.points),-1!==["MinGatherRegion","PixelCount","RuleDetectRegion"].indexOf(ob)?"OnPointLT"===sb?ub[0]=a.extend(!0,[],kb):"OnPointLB"===sb?(ub[0][0]=kb[0],ub[1][1]=kb[1]):"OnPointRT"===sb?(ub[1][0]=kb[0],ub[0][1]=kb[1]):"OnPointRB"===sb&&(ub[1]=a.extend(!0,[],kb)):ub[sb.split("OnPoint")[1]]=a.extend(!0,[],kb);else if(hb===_.Done)return!1;ub&&ub.length>1&&($.clearRect(0,0,Z.prop("width"),Z.prop("height")),$.beginPath(),-1!==["MinGatherRegion","PixelCount","RuleDetectRegion"].indexOf(ob)?($.save(),"MinGatherRegion"===ob&&($.strokeStyle="#06C8F9"),$.rect(ub[0][0],ub[0][1],ub[1][0]-ub[0][0],ub[1][1]-ub[0][1]),$.stroke(),$.restore(),N(ob,C(ub))):(a.each(ub,function(a,b){a>0?$.lineTo(b[0],b[1]):$.moveTo(b[0],b[1])}),["CalibrateAreaShape","CalibrateRegionIPC","Polygon","DetectRegion"].indexOf(ob)>-1&&$.closePath(),$.stroke()));break;case"DRectBigSmallShape":if(hb===_.Doing)$.clearRect(0,0,Z.prop("width"),Z.prop("height")),$.strokeStyle="#06C8F9",$.beginPath(),a.each(ab[bb].Shapes[db].subShapes,function(a,b){!b.sel&&b.data&&b.data.length&&($.lineWidth=1,$.rect(b.data[0][0],b.data[0][1],b.data[1][0]-b.data[0][0],b.data[1][1]-b.data[0][1]))}),$.lineWidth=2,$.rect(jb[0],jb[1],kb[0]-jb[0],kb[1]-jb[1]),$.stroke();else if(hb===_.Edit){if(sb.indexOf("OnPoint")>-1){if(sb.indexOf("OnPointRB")>-1){if(!M(ab[bb].Shapes[db].subShapes,[gb[0],kb]))return;gb[1]=a.extend(!0,[],kb)}else if(sb.indexOf("OnPointLT")>-1){if(!M(ab[bb].Shapes[db].subShapes,[kb,gb[1]]))return;gb[0]=a.extend(!0,[],kb)}else if(sb.indexOf("OnPointRT")>-1){if(!M(ab[bb].Shapes[db].subShapes,[[gb[0][0],kb[1]],[kb[0],gb[1][1]]]))return;gb[1][0]=kb[0],gb[0][1]=kb[1]}else if(sb.indexOf("OnPointLB")>-1){if(!M(ab[bb].Shapes[db].subShapes,[[kb[0],gb[0][1]],[gb[1][0],kb[1]]]))return;gb[0][0]=kb[0],gb[1][1]=kb[1]}gb=e(gb),$.clearRect(0,0,Z.prop("width"),Z.prop("height")),$.strokeStyle="#06C8F9",$.beginPath(),a.each(ab[bb].Shapes[db].subShapes,function(a,b){!b.sel&&b.data&&b.data.length&&($.lineWidth=1,$.rect(b.data[0][0],b.data[0][1],b.data[1][0]-b.data[0][0],b.data[1][1]-b.data[0][1]))}),$.lineWidth=2,$.rect(parseInt(gb[0][0]),parseInt(gb[0][1]),gb[1][0]-gb[0][0],gb[1][1]-gb[0][1]),$.stroke()}}else if(hb===_.Drag&&"Inside"===sb){if(ub=a.extend(!0,[],gb),a.each(ub,function(a){ub[a][0]=parseInt(ub[a][0])+parseInt(kb[0])-parseInt(jb[0]),ub[a][1]=parseInt(ub[a][1])+parseInt(kb[1])-parseInt(jb[1])}),!I(ub)){null===Fb&&(Fb=e(ub));break}Fb=null,$.clearRect(0,0,Z.prop("width"),Z.prop("height")),$.strokeStyle="#06C8F9",$.beginPath(),a.each(ab[bb].Shapes[db].subShapes,function(a,b){!b.sel&&b.data&&b.data.length&&($.lineWidth=1,$.rect(b.data[0][0],b.data[0][1],b.data[1][0]-b.data[0][0],b.data[1][1]-b.data[0][1]))}),$.lineWidth=2,$.rect(parseInt(ub[0][0]),parseInt(ub[0][1]),ub[1][0]-ub[0][0],ub[1][1]-ub[0][1]),$.stroke()}break;case"VerticalLine":case"HorizontalLine":if(hb===_.Drag&&sb.indexOf("OnMainShapeBorder")>-1){var u=a.extend(!0,[],ab[bb].Shapes[db].points);if(a.each(u,function(a){u[a][0]=parseInt(u[a][0])+parseInt(kb[0])-parseInt(jb[0]),u[a][1]=parseInt(u[a][1])+parseInt(kb[1])-parseInt(jb[1])}),!I(u)){null===Fb&&(Fb=a.extend(!0,[],vb));break}ub=a.extend(!0,[],u),vb=a.extend(!0,[],u),wb={},a.each(ab[bb].Shapes,function(a,b){b.mainShapeID&&b.mainShapeID===db&&(wb[a]=[[parseInt(ab[bb].Shapes[a].data[0][0])+parseInt(kb[0])-parseInt(jb[0]),parseInt(ab[bb].Shapes[a].data[0][1])+parseInt(kb[1])-parseInt(jb[1])],[parseInt(ab[bb].Shapes[a].data[1][0])+parseInt(kb[0])-parseInt(jb[0]),parseInt(ab[bb].Shapes[a].data[1][1])+parseInt(kb[1])-parseInt(jb[1])]])}),Fb=null,$.clearRect(0,0,Z.prop("width"),Z.prop("height")),$.beginPath();var x=0;a.each(ub,function(a,b){$.lineTo(b[0],b[1])}),$.closePath(),$.stroke(),a.each(wb,function(a,b){x+=1,4>=x&&($.beginPath(),$.moveTo(b[0][0],b[0][1]),$.lineTo(b[1][0],b[1][1]),$.stroke())})}else if(hb===_.Edit&&sb.indexOf("OnMainShapePoint")>-1)ub=a.extend(!0,[],ab[bb].Shapes[db].points),ub[sb.split("OnMainShapePoint")[1]]=a.extend(!0,[],kb),a.each(ab[bb].Shapes,function(b,c){c.mainShapeID&&c.mainShapeID===db&&(v(c.data[0],ub,!1,!1)&&v(c.data[1],ub,!1,!1)||(ub=a.extend(!0,[],ab[bb].Shapes[db].points)))}),$.clearRect(0,0,Z.prop("width"),Z.prop("height")),$.beginPath(),a.each(ub,function(a,b){$.lineTo(b[0],b[1])}),$.closePath(),$.stroke(),a.each(ab[bb].Shapes,function(a,b){b.mainShapeID&&b.mainShapeID===db&&($.beginPath(),$.moveTo(b.data[0][0],b.data[0][1]),$.lineTo(b.data[1][0],b.data[1][1]),$.stroke())});else if(ab[bb].Shapes[db]&&v(kb,ab[bb].Shapes[db].points,!1,!1))if(hb===_.Doing)$.clearRect(0,0,Z.prop("width"),Z.prop("height")),ab[bb].Shapes[db].stroke(),Eb||a.each(ab[bb].Shapes,function(a,b){b.data&&b.data.length>1&&b.mainShapeID&&b.mainShapeID===db&&a!=curSubShapeID&&b.isValidate===Eb&&($.moveTo(b.data[0][0],b.data[0][1]),$.lineTo(b.data[1][0],b.data[1][1]))}),"VerticalLine"===ob?($.moveTo(jb[0],jb[1]),$.lineTo(jb[0],kb[1]),$.stroke(),gb[1]=[jb[0],kb[1]]):"HorizontalLine"===ob&&($.moveTo(jb[0],jb[1]),$.lineTo(kb[0],kb[1]),$.stroke(),gb[1]=kb);else if(hb===_.Drag){var y=[];a.each(ab[bb].Shapes[curSubShapeID].data,function(a,b){y.push([parseInt(b[0])+kb[0]-jb[0],parseInt(b[1])+kb[1]-jb[1]])}),v(y[0],ab[bb].Shapes[db].points,!1,!1)&&v(y[1],ab[bb].Shapes[db].points,!1,!1)&&(gb=y,$.clearRect(0,0,Z.prop("width"),Z.prop("height")),ab[bb].Shapes[db].stroke(),Eb||a.each(ab[bb].Shapes,function(a,b){b.mainShapeID&&b.mainShapeID===db&&a!=curSubShapeID&&b.isValidate===Eb&&($.moveTo(b.data[0][0],b.data[0][1]),$.lineTo(b.data[1][0],b.data[1][1]))}),$.moveTo(gb[0][0],gb[0][1]),$.lineTo(gb[1][0],gb[1][1]),$.stroke())}else hb===_.Edit&&(gb=a.extend(!0,[],ab[bb].Shapes[curSubShapeID].data),"VerticalLine"===ob?gb[sb.split("OnPoint")[1]-0][1]=kb[1]:"HorizontalLine"===ob&&(gb[sb.split("OnPoint")[1]-0]=kb),v(kb,ab[bb].Shapes[db].points,!1,!1)&&($.clearRect(0,0,Z.prop("width"),Z.prop("height")),ab[bb].Shapes[db].stroke(),Eb||a.each(ab[bb].Shapes,function(a,b){b.mainShapeID&&b.mainShapeID===db&&a!=curSubShapeID&&b.isValidate===Eb&&($.moveTo(b.data[0][0],b.data[0][1]),$.lineTo(b.data[1][0],b.data[1][1]))}),$.moveTo(gb[0][0],gb[0][1]),$.lineTo(gb[1][0],gb[1][1]),$.stroke()));break;case"ExcludeRegion":if(hb===_.Drag&&sb.indexOf("OnMainShapeBorder")>-1){if(ub=a.extend(!0,[],ab[bb].Shapes[db].points),a.each(ub,function(a){ub[a][0]=parseInt(ub[a][0])+parseInt(kb[0])-parseInt(jb[0]),ub[a][1]=parseInt(ub[a][1])+parseInt(kb[1])-parseInt(jb[1])}),!I(ub)){null===Fb&&(Fb=a.extend(!0,[],ub));break}wb={},a.each(ab[bb].Shapes,function(a,b){b.mainShapeID&&b.mainShapeID===db&&(wb[a]=ab[bb].Shapes[a].data.map(function(a){return[parseInt(a[0])+parseInt(kb[0])-parseInt(jb[0]),parseInt(a[1])+parseInt(kb[1])-parseInt(jb[1])]}))}),Fb=null,$.clearRect(0,0,Z.prop("width"),Z.prop("height")),$.beginPath();var x=0;a.each(ub,function(a,b){$.lineTo(b[0],b[1])}),$.closePath(),$.stroke(),a.each(wb,function(a,b){$.beginPath();for(var c=0;c<b.length;c++)c?$.lineTo(b[c][0],b[c][1]):$.moveTo(b[c][0],b[c][1]);$.closePath(),$.stroke()})}else if(hb===_.Edit&&sb.indexOf("OnMainShapePoint")>-1);else if(v(kb,ab[bb].Shapes[db].points,!1,!1)&&hb===_.Doing){$.clearRect(0,0,Z.prop("width"),Z.prop("height")),ab[bb].Shapes[db].stroke(),a.each(ab[bb].Shapes,function(a,b){if(b.mainShapeID&&b.mainShapeID===db&&a!=curSubShapeID){for($.beginPath(),j=0;j<b.data.length;j++)j?$.lineTo(b.data[j][0],b.data[j][1]):$.moveTo(b.data[j][0],b.data[j][1]);$.closePath(),$.stroke()}});for(var z=0;z<gb.length;z++)z?$.lineTo(gb[z][0],gb[z][1]):$.moveTo(gb[z][0],gb[z][1]);$.lineTo(kb[0],kb[1]),$.closePath(),$.stroke()}break;case"MoveDirectly":Gb&&($.clearRect(0,0,Z.prop("width"),Z.prop("height")),$.strokeStyle="red",$.beginPath(),$.rect(jb[0],jb[1],kb[0]-jb[0],kb[1]-jb[1]),$.closePath(),$.stroke())}}}function Q(b){if(("FireDetect"!==ob||0!==Rb.enabled)&&jb&&nb){var c=[b.clientX-Z.offset().left+window.scrollX,b.clientY-Z.offset().top+window.scrollY],d=null;switch(ob){case"MotionDetect":mb=a.extend({},nb),nb=null,jb=null,kb=null,a.publish("OutPutStringInfo",t(mb.matrixValue));break;case"VideoCut":tb=null,jb=null,kb=null,a.publish("RegionChanged",[B(qb.osdArr[rb])[0][0],B(qb.osdArr[rb])[0][1],B(qb.osdArr[rb])[1][0],B(qb.osdArr[rb])[1][1],rb]);break;case"VideoOsd":case"FireDetect":if(xb){if(d=[[jb[0],jb[1]],[kb[0],kb[1]]],"VideoOsd"===ob&&jb[0]==kb[0]&&jb[1]==kb[1])return xb=!1,void(Rb.drawEnable=0);if("FireDetect"===ob){if(jb[0]===kb[0]||jb[1]===kb[1])return Rb.drawEnable=1,void(jb=null);xb=!1,Rb.drawEnable=0}qb.osdArr[rb]=e(d),yb.shift(),xb=!1}tb=null,jb=null,kb=null,a.publish("RegionChanged",[B(qb.osdArr[rb])[0][0],B(qb.osdArr[rb])[0][1],B(qb.osdArr[rb])[1][0],B(qb.osdArr[rb])[1][1],rb]);break;case"RuleRect":if(1===Rb.drawEnable){if(S(),3===Kb){var g=X(c,Hb[Jb].LeftLine,!0);if("right"!==g)return Kb=2,void(Hb[Jb].RightLine=[])}else if(4===Kb){var g=X(c,Hb[Jb].LeftLine,!0);if("right"!==g)return Kb=3,void(Hb[Jb].RightLine[1]=[])}Hb[Jb].LeftLine&&Hb[Jb].RightLine&&2===Hb[Jb].LeftLine.length&&2===Hb[Jb].RightLine.length&&(Rb.drawEnable=0,Kb=0,Lb[Qb.onDrawLeftRightLineFinish](Rb.getLanes()),jb=null,kb=null)}break;case"DetectLine":if(1===Rb.drawEnable){if(Hb[Jb]&&Hb[Jb].DetectLine[0]){Hb[Jb].DetectLine[1]=[kb[0],kb[1]],S();var h=W(Hb[Jb].LeftLine[0],Hb[Jb].LeftLine[1],Hb[Jb].DetectLine[0],Hb[Jb].DetectLine[1]),i=W(Hb[Jb].RightLine[0],Hb[Jb].RightLine[1],Hb[Jb].DetectLine[0],Hb[Jb].DetectLine[1]);h&&i?(Hb[Jb].DetectLine[0]=h,Hb[Jb].DetectLine[1]=i):Hb[Jb].DetectLine.length=0}S()}Hb[Jb]&&Hb[Jb].DetectLine&&2===Hb[Jb].DetectLine.length&&(Rb.drawEnable=0,Lb[Qb.onDrawLeftRightLineFinish](Rb.getLanes()),jb=null,kb=null);break;case"DetectRegionRect":if(""!=Mb&&Ib.length>2)if(Math.abs(Ib[0][0]-Ib[2][0])>6&&Math.abs(Ib[0][1]-Ib[2][1])>6){Ib[1]=[],Ib[3]=[],Ib[1][0]=Ib[0][0],Ib[1][1]=Ib[2][1],Ib[3][0]=Ib[2][0],Ib[3][1]=Ib[0][1];var j=[];j[0]=Ib[0],j[1]=Ib[2],Lb[Qb.onRegionFinish]({OutPutRuleRect:j})}else Ib=[],S();jb=null,kb=null,Mb="";break;case"DFilter":jb=null,kb=null,Mb="";break;case"ArrowLineShape":case"LaneShape":case"XLineShape":case"LineShape":case"ModuleDetectRegion":case"RuleDetectRegion":case"DRectFilterShape":case"MinGatherRegion":case"Rect":case"PixelCount":case"CalibrateAreaShape":case"CalibrateRegionIPC":case"DetectRegion":case"Polygon":if((hb===_.Drag||hb===_.Edit)&&(Fb?fb.points=a.extend(!0,[],Fb):-1!==["MinGatherRegion","PixelCount","RuleDetectRegion"].indexOf(ob)?fb.points=a.extend(!0,[],e(ub)):(-1!==["ArrowLineShape","XLineShape","LineShape"].indexOf(ob)||f(ub))&&(fb.points=a.extend(!0,[],ub)),a.each(ab[bb].Shapes,function(b,c){c.show&&db==b&&(ab[bb].Shapes[b].points=a.extend(!0,[],fb.points))}),G(cb),a.publish("IVSRuleConfig",{data:"PixelCount"===ob?C(ab[bb].Shapes[db].points):B(ab[bb].Shapes[db].points),containerID:bb,shapeID:db,shapeName:ob}),N(ob,C(ab[bb].Shapes[db].points))),hb===_.Doing&&-1!==["MinGatherRegion","PixelCount","RuleDetectRegion"].indexOf(ob)){fb.points=a.extend(!0,[],e([jb,kb])),hb=_.Done,jb=null,kb=null,sb="Outside",a.publish("IVSRuleConfig",{data:"PixelCount"===ob?C(ab[bb].Shapes[db].points):B(ab[bb].Shapes[db].points),containerID:bb,shapeID:db,shapeName:ob}),N(ob,C(ab[bb].Shapes[db].points));
break}hb!==_.ToDo&&hb!==_.Doing&&(hb=_.Done,jb=null,kb=null,sb="Outside");break;case"DRectBigSmallShape":if(hb===_.Doing){var k,l,m,o;a.each(ab[bb].Shapes[db].subShapes,function(a,b){0!==b.data.length&&("DRectBig"===b.subShapeName?(m=b.data[1][0]-b.data[0][0],o=b.data[1][1]-b.data[0][1]):(k=b.data[1][0]-b.data[0][0],l=b.data[1][1]-b.data[0][1]))}),a.each(ab[bb].Shapes[db].subShapes,function(b,c){c.sel&&(M(ab[bb].Shapes[db].subShapes,e([jb,kb]))?(ab[bb].Shapes[db].subShapes[b].data=a.extend(!0,[],e([jb,kb])),gb=a.extend(!0,[],e([jb,kb]))):(ab[bb].Shapes[db].subShapes[b].data="DRectBig"===c.subShapeName?a.extend(!0,[],[jb,[jb[0]+k+2,jb[1]+l+2]]):a.extend(!0,[],[jb,[jb[0]+m-2,jb[1]+o-2]]),gb=a.extend(!0,[],ab[bb].Shapes[db].subShapes[b].data),G(bb)),a.publish(ab[bb].Shapes[db].subShapes[b].subShapeName,{shapeID:b,data:n(B(ab[bb].Shapes[db].subShapes[b].data))}))})}else if(hb===_.Edit)a.each(ab[bb].Shapes[db].subShapes,function(b,c){c.sel&&(ab[bb].Shapes[db].subShapes[b].data=a.extend(!0,[],gb),a.publish(ab[bb].Shapes[db].subShapes[b].subShapeName,{shapeID:b,data:n(B(ab[bb].Shapes[db].subShapes[b].data))}))});else if(hb===_.Drag)if(Fb)a.each(ab[bb].Shapes[db].subShapes,function(b,c){c.sel&&(gb=ab[bb].Shapes[db].subShapes[b].data=a.extend(!0,[],Fb),a.publish(ab[bb].Shapes[db].subShapes[b].subShapeName,{shapeID:b,data:n(B(ab[bb].Shapes[db].subShapes[b].data))}))});else{if(0===ub.length)return!1;a.each(ab[bb].Shapes[db].subShapes,function(b,c){c.sel&&(gb=ab[bb].Shapes[db].subShapes[b].data=a.extend(!0,[],ub),a.publish(ab[bb].Shapes[db].subShapes[b].subShapeName,{shapeID:b,data:n(B(ab[bb].Shapes[db].subShapes[b].data))}))})}hb=_.Done,jb=null,kb=null,sb="Outside";break;case"VerticalLine":case"HorizontalLine":if(hb===_.Drag&&sb.indexOf("OnMainShapeBorder")>-1){ab[bb].Shapes[db].points=Fb?a.extend(!0,[],Fb):a.extend(!0,[],ub),a.each(ab[bb].Shapes,function(b,c){c.mainShapeID===db&&(ab[bb].Shapes[b].data=a.extend(!0,[],wb[b]))}),hb=_.Done,jb=null,kb=null,sb="Outside",a.publish("IVSRuleConfig",{data:B(ab[bb].Shapes[db].points),containerID:bb,shapeID:db,shapeName:"CalibrateRegionIPC"});var p=0;a.each(ab[bb].Shapes,function(b,c){c.mainShapeID===db&&(p+=1,4>=p&&a.publish("IVSRuleConfig",{data:B(c.data),containerID:bb,shapeID:parseInt(b),mainShapeID:c.mainShapeID,shapeName:c.shapeName}))})}else if(hb===_.Edit&&sb.indexOf("OnMainShapePoint")>-1)ab[bb].Shapes[db].points=a.extend(!0,[],ub),hb=_.Done,jb=null,kb=null,ub=null,sb="Outside",a.publish("IVSRuleConfig",{data:B(ab[bb].Shapes[db].points),containerID:bb,shapeID:db,shapeName:"CalibrateRegionIPC"});else if(hb===_.Doing||hb===_.Drag||hb===_.Edit){var q=a.extend(!0,[],gb),r=B(q);if(q.length<2)return;if(r[0][0]==r[1][0]&&r[0][1]==r[1][1])return hb=_.ToDo,gb=[],!1;for(var s=ab[bb].Shapes[db],u=0;u<s.points.length;u++){var v;if(v=u==s.points.length-1?W(q[0],q[1],s.points[u],s.points[0]):W(q[0],q[1],s.points[u],s.points[u+1]))return hb=_.ToDo,jb=null,kb=null,sb="Outside",gb=[],G(bb),!1}ab[bb].Shapes[curSubShapeID].data=q,hb=_.Done,jb=null,kb=null,sb="Outside",a.publish("IVSRuleConfig",{data:r,containerID:bb,shapeID:curSubShapeID,mainShapeID:db,shapeName:ob})}break;case"ExcludeRegion":if(hb===_.Drag&&sb.indexOf("OnMainShapeBorder")>-1)ab[bb].Shapes[db].points=Fb?a.extend(!0,[],Fb):a.extend(!0,[],ub),a.each(ab[bb].Shapes,function(b,c){c.mainShapeID===db&&(ab[bb].Shapes[b].data=a.extend(!0,[],wb[b]))}),hb=_.Done,jb=null,kb=null,ub=null,sb="Outside",a.publish("IVSRuleConfig",{data:B(ab[bb].Shapes[db].points),containerID:bb,shapeID:db,shapeName:"DetectRegion"}),a.each(ab[bb].Shapes,function(b,c){c.mainShapeID===db&&a.publish("IVSRuleConfig",{data:B(c.data),containerID:bb,shapeID:parseInt(b),mainShapeID:c.mainShapeID,shapeName:c.shapeName})});else if(hb===_.Edit&&sb.indexOf("OnMainShapePoint")>-1);else if(hb===_.Doing||hb===_.Edit)break;break;case"MoveDirectly":Gb&&(d=[jb,kb],d=B(d),jb=null,kb=null,a.publish("RegionChanged",[d[0][0],d[0][1],d[1][0],d[1][1]]),$.clearRect(0,0,Z.prop("width"),Z.prop("height")))}}}function R(a){Q(a)}function S(){$.clearRect(0,0,Z.prop("width"),Z.prop("height")),$.setLineDash([]);for(var a=0;a<Hb.length;a++)if(Hb[a]&&Hb[a].LeftLine){var b=Jb===a?"#FFFFFF":"#0000FF";Hb[a].LeftLine&&1===Hb[a].LeftLine.length||(!Hb[a].LeftLine||2!==Hb[a].LeftLine.length||!Hb[a].LeftLine||Hb[a].RightLine&&0!==Hb[a].RightLine.length?Hb[a].RightLine&&1===Hb[a].RightLine.length?(T(Hb[a].LeftLine[0][0],Hb[a].LeftLine[0][1],Hb[a].LeftLine[1][0],Hb[a].LeftLine[1][1],null,!0,b),T(Hb[a].LeftLine[1][0],Hb[a].LeftLine[1][1],Hb[a].RightLine[0][0],Hb[a].RightLine[0][1],!0,null,"#00FF00"),T(Hb[a].RightLine[0][0],Hb[a].RightLine[0][1],Hb[a].LeftLine[0][0],Hb[a].LeftLine[0][1],!0,null,"#00FF00")):Hb[a].RightLine&&2===Hb[a].RightLine.length&&(T(Hb[a].LeftLine[0][0],Hb[a].LeftLine[0][1],Hb[a].LeftLine[1][0],Hb[a].LeftLine[1][1],null,!0,b),T(Hb[a].RightLine[0][0],Hb[a].RightLine[0][1],Hb[a].RightLine[1][0],Hb[a].RightLine[1][1],null,!0,b),T(Hb[a].LeftLine[0][0],Hb[a].LeftLine[0][1],Hb[a].RightLine[0][0],Hb[a].RightLine[0][1],!0,null,"#00FF00"),T(Hb[a].LeftLine[1][0],Hb[a].LeftLine[1][1],Hb[a].RightLine[1][0],Hb[a].RightLine[1][1],!0,null,"#00FF00")):T(Hb[a].LeftLine[0][0],Hb[a].LeftLine[0][1],Hb[a].LeftLine[1][0],Hb[a].LeftLine[1][1],null,!0,b)),$.setLineDash([]),b=Jb===a?"#FFFF00":"#0000FF",$.strokeStyle=b,Hb[a].DetectLine&&Hb[a].DetectLine[0]&&Hb[a].DetectLine[1]&&T(Hb[a].DetectLine[0][0],Hb[a].DetectLine[0][1],Hb[a].DetectLine[1][0],Hb[a].DetectLine[1][1],null,null,b),$.font="10px Arial",Hb[a].LeftLine&&$.strokeText(tl("itc.LaneLine")+Hb[a].Number,Hb[a].LeftLine[0][0]+10,Hb[a].LeftLine[0][1]+10),Hb[a].RightLine&&$.strokeText(tl("itc.LaneLine")+Hb[a].Number,Hb[a].RightLine[0][0]+10,Hb[a].RightLine[0][1]+10),Hb[a].LeftLine&&Hb[a].LeftLine[0]&&Hb[a].LeftLine[1]&&$.strokeText(tl("w_lineleft"),(Hb[a].LeftLine[0][0]+Hb[a].LeftLine[1][0])/2,(Hb[a].LeftLine[0][1]+Hb[a].LeftLine[1][1])/2),Hb[a].RightLine&&Hb[a].RightLine[0]&&Hb[a].RightLine[1]&&$.strokeText(tl("w_lineRight"),(Hb[a].RightLine[0][0]+Hb[a].RightLine[1][0])/2,(Hb[a].RightLine[0][1]+Hb[a].RightLine[1][1])/2)}null!=Ib&&Ib.length>0&&($.setLineDash([]),$.strokeStyle="#06C8F9",$.beginPath(),$.rect(Ib[0][0]*Z.prop("width")/8191,Ib[0][1]*Z.prop("height")/8191,(Ib[2][0]-Ib[0][0])*Z.prop("width")/8191,(Ib[2][1]-Ib[0][1])*Z.prop("height")/8191),$.closePath(),$.stroke(),$.strokeStyle="#00FFFF"),Ob&&Ob.DFilter&&4===Ob.DFilter.length&&($.setLineDash([]),$.strokeStyle="#FFFF00",$.beginPath(),$.rect(Ob.DFilter[0][0]*Z.prop("width")/8191,Ob.DFilter[0][1]*Z.prop("height")/8191,(Ob.DFilter[1][0]-Ob.DFilter[0][0])*Z.prop("width")/8191,(Ob.DFilter[1][1]-Ob.DFilter[0][1])*Z.prop("height")/8191),$.closePath(),$.stroke(),$.strokeStyle="#FF0000",$.beginPath(),$.rect(Ob.DFilter[2][0]*Z.prop("width")/8191,Ob.DFilter[2][1]*Z.prop("height")/8191,(Ob.DFilter[3][0]-Ob.DFilter[2][0])*Z.prop("width")/8191,(Ob.DFilter[3][1]-Ob.DFilter[2][1])*Z.prop("height")/8191),$.closePath(),$.stroke())}function T(a,b,c,d,e,f,g){if(g=g||"#00FFFF",$.strokeStyle=g,$.beginPath(),$.moveTo(a,b),$.lineTo(c,d),$.setLineDash([]),e&&($.setLineDash([5,10]),$.lineDashOffset=0),$.closePath(),$.stroke(),f){var h=V(c,d,a,b,20),i=L(h,[c,d],30),j=L(h,[c,d],330);T(i[0][0],i[0][1],i[1][0],i[1][1],null,null,g),T(j[0][0],j[0][1],j[1][0],j[1][1],null,null,g)}}function U(a,b){return a-b>0?1:0>a-b?-1:0}function V(a,b,c,d,e){var f=null,g=[],h=null,i=null;return c===a?(g[0]=a,g[1]=b>=d?d>b-e?d:b-e:b+e>d?d:b+e):(f=Math.atan((d-b)/(c-a)),h=e*Math.cos(f),i=e*Math.sin(f),c>a&&d>=b?(g[0]=c>a+h?a+h:c,g[1]=d>b+i?b+i:d):c>a&&b>d?(g[0]=c>a+h?a+h:c,g[1]=b+i>d?b+i:d):a>c&&b>=d?(g[0]=a-h>c?a-h:c,g[1]=b-i>d?b-i:d):(g[0]=a-h>c?a-h:c,g[1]=d>b-i?b-i:d)),g}function W(a,b,c,d){var e=(a[0]-c[0])*(b[1]-c[1])-(a[1]-c[1])*(b[0]-c[0]),f=(a[0]-d[0])*(b[1]-d[1])-(a[1]-d[1])*(b[0]-d[0]);if(e*f>=0)return!1;var g=(c[0]-a[0])*(d[1]-a[1])-(c[1]-a[1])*(d[0]-a[0]),h=g+e-f;if(g*h>=0)return!1;var i=g/(f-e),j=i*(b[0]-a[0]),k=i*(b[1]-a[1]);return[a[0]+j,a[1]+k]}function X(b,c,d){var e=[];e[0]=a.extend(!0,[],c[0]),e[1]=a.extend(!0,[],c[1]),c[1][1]<c[0][1]&&d&&(e[0]=a.extend(!0,[],c[1]),e[1]=a.extend(!0,[],c[0]));var f=e[1][1]-e[0][1],g=e[0][0]-e[1][0],h=e[1][0]*e[0][1]-e[0][0]*e[1][1],i=f*b[0]+g*b[1]+h;return 0>i?"left":i>0?"right":"middle"}function Y(a){a.preventDefault()}var Z=null,$=null,_={Null:0,ToDo:1,Doing:2,Done:3,Drag:4,Edit:5},ab={},bb=0,cb=0,db=0,eb=0,fb=null,gb=[],hb=0,ib={strokeStyle:"#31FF01",fillStyle:"#000",filled:!1,dashed:!1,lineWidth:3,show:!0,direction:-1,sel:!1,shapeName:"",showName:"",editable:!1},jb=null,kb=null,lb=null,mb={row:0,column:0,matrix:[],xStep:0,yStep:0,matrixValue:[]},nb=null,ob=null,pb=null,qb={},rb=null,sb="Outside",tb=null,ub=null,vb=null,wb=null,xb=!1,yb=[],zb=!1,Ab=!1,Bb=0,Cb=0,Db={},Eb=!1,Fb=null,Gb=!1,Hb=[],Ib=[],Jb=0,Kb=0,Lb={},Mb="",Nb=null,Ob=null,Pb=-1,Qb={onDrawLeftRightLineFinish:"onDrawLeftRightLineFinish",onRegionFinish:"onRegionFinish"},Rb=c.exports={drawEnable:1,enabled:1,backLines:null,backSpots:null,showMult:!1,cover:function(b,c){var d=a(b);if(d.is(":visible")){Bb=c.split("*")[0],Cb=c.split("*")[1];var e,f,g,h,i=d.offset(),j=d.width(),k=d.height();Z=a("#canvas")[0]?a("#canvas").css({position:"absolute",top:"-10000px"}):a('<canvas id="canvas" style="position:absolute;top:-10000px;" width="1" height="1"></canvas>').appendTo(document.body),j*Cb>Bb*k?(e=Bb*k/Cb,f=k,h=i.top,g=i.left+(j*Cb-Bb*k)/(2*Cb)):Bb*k>j*Cb&&(e=j,f=Cb*j/Bb,h=i.top+(Bb*k-j*Cb)/(2*Bb),g=i.left),Z.css({top:h,left:g,"z-index":"auto"===d.css("z-index")?10002:d.css("z-index")}),"h5"===webApp.playMode&&j-e>0&&2>j-e&&(e=j),Z.prop("width",Math.ceil(e)),Z.prop("height",Math.ceil(f)),$=a("#canvas")[0].getContext("2d"),Z.off("mousemove").on("mousemove",P),Z.off("mousedown").on("mousedown",O),Z.off("mouseup").on("mouseup",Q),Z.off("mouseout").on("mouseout",R),Z.off("contextmenu").on("contextmenu",Y)}},resize:function(b,c){if(Z){var d=a(b);c&&(Bb=c.split("*")[0],Cb=c.split("*")[1]);var e,f,g,h,i=d.offset(),j=d.width(),k=d.height();if(j*Cb>Bb*k?(e=Bb*k/Cb,f=k,h=i.top,g=i.left+(j*Cb-Bb*k)/(2*Cb)):Bb*k>j*Cb&&(e=j,f=Cb*j/Bb,h=i.top+(Bb*k-j*Cb)/(2*Bb),g=i.left),c&&$){var l=$.getImageData(0,0,Z.prop("width"),Z.prop("height"));Z.prop("width",Math.round(e)),Z.prop("height",Math.round(f)),$.putImageData(l,0,0)}Z.css({top:h,left:g,width:e,height:f,"z-index":10004})}},getLanes:function(){for(var b=a.extend(!0,[],Hb),c=function(a){var b=[[],[]];return b[0][0]=8191*a[0][0]/Z.attr("width"),b[0][1]=8191*a[0][1]/Z.attr("height"),b[1][0]=8191*a[1][0]/Z.attr("width"),b[1][1]=8191*a[1][1]/Z.attr("height"),b},d=0;d<Hb.length;d++)b[d]&&b[d].Number>-1&&b[d].LeftLine&&b[d].RightLine&&(b[d].LeftLine=c(b[d].LeftLine),b[d].RightLine=c(b[d].RightLine),b[d].DetectLine&&(b[d].DetectLine=c(b[d].DetectLine)));return b},setLanes:function(b){Hb=a.extend(!0,[],b);for(var c=function(a){var b=[[],[]];return b[0][0]=a[0][0]*Z.attr("width")/8191,b[0][1]=a[0][1]*Z.attr("height")/8191,b[1][0]=a[1][0]*Z.attr("width")/8191,b[1][1]=a[1][1]*Z.attr("height")/8191,b},d=0;d<Hb.length;d++)Hb[d]&&Hb[d].LeftLine&&Hb[d].RightLine&&(Hb[d].LeftLine=c(Hb[d].LeftLine),Hb[d].RightLine=c(Hb[d].RightLine)),Hb[d].DetectLine&&(Hb[d].DetectLine=c(Hb[d].DetectLine))},setDetectRegionRect:function(b){Ib=a.extend(!0,[],b)},setSelectedIndex:function(a){Jb=a},reDrawTraCanvas:function(){S()},setDFilter:function(a){Ob=a},addEvent:function(a,b){Lb[a]=b},hide:function(){Z&&(Z.css("top",-1e4),Z.remove()),this.SetRegionNum(0),Z=null,$=null,_={Null:0,ToDo:1,Doing:2,Done:3,Drag:4,Edit:5},ab={},bb=0,cb=0,eb=0,fb=null,gb=[],hb=0,ib={strokeStyle:"#31FF01",fillStyle:"#000",filled:!1,dashed:!1,lineWidth:3,show:!0,direction:-1,sel:!1,shapeName:"",editable:!1},jb=null,kb=null,lb=null,mb={row:0,column:0,matrix:[],xStep:0,yStep:0,matrixValue:[]},nb=null,ob=null,pb=null,qb={},rb=null,sb="Outside",tb=null,ub=null,xb=!1,yb=[],zb=!1,Ab=!1,Bb=0,Cb=0,Db={},Eb=!1,Fb=null,Gb=!1,this.showMult=!1,Hb=[],Jb=0,Kb=0,Lb={},Ob=null},visible:function(a){Z&&Z.css("visibility",a?"visible":"hidden")},clearCanvas:function(){ob=null,$.clearRect(0,0,Z.prop("width"),Z.prop("height"))},getDelosdId:function(){return yb},remove:function(){Z&&Z.remove()},CreateVideoAnalyseContainer:function(){return bb++,ab[bb]={Enable:!0,Tip:"",Shapes:{}},cb=bb,Gb=!1,bb},EnableVideoAnalyseContainer:function(a,b){ab[a]&&(ab[a].Enable=b)},SetVideoAnalyseContainerTip:function(a,b){ab[a]&&(ab[a].Tip=b)},SetTip:function(a,b,c){var d=ab[a].Shapes[b].data[0],e=ab[a].Shapes[b].data[1],f=Math.atan((e[1]-d[1])/(e[0]-d[0]));e[0]-d[0]===0?$.strokeText(c,d[0]+5,d[1]+10):($.translate(d[0],d[1]),$.rotate(f),$.strokeText(c,5,-5),$.rotate(-f),$.translate(-d[0],-d[1]))},ActivePTZLocate:function(a){Gb=a,ob="MoveDirectly",jb=null,kb=null},CreateMainVideoAnalyseShape:function(a,b,c,d){if(ab[a]){var e=null;switch(ob=b,c?hb=_.Done:(hb=_.ToDo,gb=[]),b){case"ArrowLineShape":case"LaneShape":case"XLineShape":case"LineShape":e=new Sb(D(c),d,b);break;case"DRectBigSmallShape":e={sizeFilterId:++eb,subShapes:{},shapeName:b,show:!1};break;case"ModuleDetectRegion":case"RuleDetectRegion":case"DRectFilterShape":case"MinGatherRegion":case"Rect":e=new Tb(D(c),d,b),"MinGatherRegion"===b&&(e.strokeStyle="#06C8F9");break;case"PixelCount":e=new Tb(E(c),{sel:!0},b);break;case"CalibrateAreaShape":case"CalibrateRegionIPC":case"DetectRegion":case"Polygon":e=new Ub(D(c),d,b)}return ab[a].Shapes[++eb]=e,db=eb,F(a,eb),G(a),fb=e,eb}},AddVideoAnalyseShape:function(a,b,c,d,e){return ab[a]?"DRectBig"===c||"DRectSmall"===c?(ab[a].Shapes[b].subShapes[++eb]={subShapeName:c,data:D(m(d,[8191,8191])),sel:void 0===d?!0:!1},G(a),eb):"VerticalLine"===c||"HorizontalLine"===c?(d?(hb=_.Done,gb=D(d)):(hb=_.ToDo,gb=[]),ob=c,Eb=e&&e.isValidate?!0:!1,ab[a].Shapes[++eb]={mainShapeID:b,data:D(d),sel:!0,shapeName:c,isValidate:Eb},db=b,curSubShapeID=eb,(d||Eb)&&G(a),eb):"ExcludeRegion"===c?(d?(hb=_.Done,gb=D(d)):(hb=_.ToDo,gb=[]),ob=c,ab[a].Shapes[++eb]={mainShapeID:b,data:D(d),sel:!0,shapeName:c},db=b,curSubShapeID=eb,(d||Eb)&&G(a),eb):void 0:void 0},SetVideoAnalyseShapeShowName:function(a,b,c){ab[a].Shapes[b].showName=c,G(a)},SelectVideoAnalyseShape:function(a,b,c){void 0===c||c?(ab[a].Shapes[b].sel=!0,db=b):ab[a].Shapes[b].sel=!1},SelectFilterShape:function(a,b,c,d){return void 0===c?void((void 0===d||d)&&(hb=_.ToDo,gb=[])):void(void 0===d||d?(ab[a].Shapes[b].subShapes[c].sel=!0,db=b,gb=ab[a].Shapes[b].subShapes[c].data,gb.length&&gb[0][0]===gb[1][0]||!gb.length?(gb=[],hb=_.ToDo):hb=_.Done):ab[a].Shapes[b].subShapes[c].sel=!1)},SetVideoAnalyseShapeDirection:function(a,b,c){ab[a].Shapes[b].direction=c,G(a)},RedrawVideoAnalyseShape:function(a,b,c){void 0===c?(db=b,hb=_.ToDo,gb=[],ab[a].Shapes[b].points=[],F(a,b),G(a),fb=ab[a].Shapes[b]):(db=b,hb=_.ToDo,gb=[],ab[a].Shapes[b].subShapes[c].data=[],F(a,b),G(a),fb=ab[a].Shapes[b])},GetSelectedVideoAnalyseShapeID:function(b){a.each(ab[b].Shapes,function(a,b){return b.show?a:void 0})},ShowVideoAnalyseShape:function(a,b,c){void 0===c||c?F(a,b):b&&(ab[a].Shapes[b].show=c,ab[a].Shapes[b].sel=c,ab[a].Shapes[b].editable=c),Eb=!1,G(a)},SetVideoAnalyseShapeConfig:function(a,b,c){if(ab[a].Shapes[b]&&c){switch(ab[a].Shapes[b].shapeName){case"ArrowLineShape":case"LaneShape":case"XLineShape":case"LineShape":case"ModuleDetectRegion":case"RuleDetectRegion":case"DRectFilterShape":case"MinGatherRegion":case"Rect":case"CalibrateAreaShape":case"CalibrateRegionIPC":case"DetectRegion":case"Polygon":case"DRectBigSmallShape":case"VerticalLine":case"HorizontalLine":case"ExcludeRegion":case"MoveDirectly":ab[a].Shapes[b].points=D(c);break;case"PixelCount":ab[a].Shapes[b].points=E(c)}db=b,hb=_.Done,F(a,b),G(a),fb=ab[a].Shapes[b],N(ob,c)}},DeleteVideoAnalyseShape:function(a,b){delete ab[a].Shapes[b],hb=_.Done,G(a)},DeleteAllVideoAnalyseShape:function(a){a&&ab[a]&&(ab[a].Shapes={},ob=null,G(a))},ToggleVisibilityOfVideoAnalyseShape:function(b,c,d,e,f,g){if(b&&ab[b]){var h=[],i=[],j=[],k=[];a.isArray(d)?h=d:void 0!==d?h.push(d):h=null,a.isArray(e)?i=e:void 0!==e?i.push(e):i=null,a.isArray(g)?j=g:void 0!==g?j.push(g):j=null,a.isArray(f)?k=f:void 0!==f?k.push(f):k=null,a.each(ab[b].Shapes,function(a,d){return d?j&&-1!==j.indexOf(d.shapeName)?!0:k&&-1!==k.indexOf(1*a)?!0:void(h||i?(-1!==h.indexOf(1*a)||-1!==h.indexOf(d.shapeName))&&(ab[b].Shapes[a].show=!!c):ab[b].Shapes[a].show=!!c):!0}),G(b)}},ReleaseVideoAnalyseContainer:function(a){delete ab[a]},GetVideoAnalyseShapeConfigData:function(a,b){return ab[a].Shapes[b]},EnableVideoAnalyseShape:function(a,b,c){ab[a].Shapes[b].editable=c},SetVideoAnalyseShapeColor:function(a,b,c,d){ab[a].Shapes[b].strokeStyle=c,d&&(ab[a].Shapes[b].sel=d)},SetGridNum:function(a,b){mb.row=a,mb.column=b,mb.xStep=Z.prop("width")/mb.column,mb.yStep=Z.prop("height")/mb.row;for(var c=0;c<mb.row+1;c++){mb.matrix[c]=[];for(var d=0;d<mb.column+1;d++)mb.matrix[c][d]=[mb.xStep*d,mb.yStep*c]}s()},SetFuntionInfo:function(b,c){ob=b;var d=c.split(" ");switch(b){case"MotionDetect":a.each(d,function(b,c){mb.matrixValue[c.split("@")[0]]={color:c.split("@")[1].split("-")[0],matrix:a.map(c.split("@")[1].split("-")[1].split(":"),function(a){for(var b=(a-0).toString(2);b.length<mb.column;)b="0"+b;return b})}})}p(mb.matrixValue)},SetCurrentDrawId:function(a){pb=a,p(mb.matrixValue)},RemoveMonDetectReg:function(b){var c,d="",e=[];for(c=0;c<mb.column;c++)d+="0";for(c=0;c<mb.row;c++)e.push(d);mb.matrixValue[b].matrix=e,p(mb.matrixValue),a.publish("OutPutStringInfo",t(mb.matrixValue))},RemoveAllMonDetectReg:function(){var b,c="",d=[];for(b=0;b<mb.column;b++)c+="0";for(b=0;b<mb.row;b++)d.push(c);for(b=0;b<mb.matrixValue.length;b++)mb.matrixValue[b].matrix=d;p(mb.matrixValue),a.publish("OutPutStringInfo",t(mb.matrixValue))},SetRegionNum:function(a){qb.maxLen=a,qb.osdArr=[],0===a&&$&&$.clearRect(0,0,Z.prop("width"),Z.prop("height")),yb=[]},SetSelRegionByIndex:function(a,b,c,d,e,f,g,h){return!Z||(f&&(Ab=!0),h?(ob="FireDetect",$.strokeStyle="#00FF00"):ob="VideoOsd",zb=g,!qb.maxLen||a>qb.maxLen-1)?void 0:(qb.osdArr[a]=[[b*Z.prop("width")/8191,c*Z.prop("height")/8191],[d*Z.prop("width")/8191,e*Z.prop("height")/8191]],b==d||c==e?void(-1===yb.indexOf(a)&&yb.push(a)):void(-1==yb.indexOf(a)&&(rb=a,$.globalAlpha=1,$.fillStyle="#000",h||($.strokeStyle="#FFFF00"),$.beginPath(),$.rect(qb.osdArr[a][0][0],qb.osdArr[a][0][1],qb.osdArr[a][1][0]-qb.osdArr[a][0][0],qb.osdArr[a][1][1]-qb.osdArr[a][0][1]),$.closePath(),$.stroke(),Ab&&$.fillRect(qb.osdArr[a][0][0],qb.osdArr[a][0][1],qb.osdArr[a][1][0]-qb.osdArr[a][0][0],qb.osdArr[a][1][1]-qb.osdArr[a][0][1]))))},SetFireDetectBackLine:function(a,b,c){ob="FireDetect",$.strokeStyle="#FFFFFF",$.fillStyle="#FF0000";for(var d=0;d<b.length;d++)$.beginPath(),$.moveTo(b[d][0][0]/8191*Z.prop("width"),b[d][0][1]/8191*Z.prop("height")),$.lineTo(b[d][1][0]/8191*Z.prop("width"),b[d][1][1]/8191*Z.prop("height")),$.closePath(),$.stroke();for(var d=0;d<c.length;d++)$.beginPath(),$.arc(c[d][0]/8191*Z.prop("width"),c[d][1]/8191*Z.prop("height"),70/8191*Z.prop("width"),0,2*Math.PI),$.closePath(),$.fill()},setCurRuleType:function(a){ob=a},fillText:function(a,b){$.fillStyle="#FFFF00",$.fillText(a,b[0],b[1])},strokeText:function(a,b,c){c&&c.strokeStyle&&($.strokeStyle=c.strokeStyle),$.strokeText(a,b[0],b[1])},fillTextEx:function(a,b,c,d,e){e&&e.font&&($.font=e.font),e&&e.fillColor&&($.fillStyle=e.fillColor),c&&d||$.fillText(a,b[0],b[1])},DelSelReg:function(b,c){void 0===c&&(c=!0);var d,e=rb||0,f=this;if(!qb||0!=qb.osdArr.length){var g=0;for(d=0;d<qb.maxLen;d++)if(0!==qb.osdArr[d][0][0]||0!==qb.osdArr[d][0][1]||0!==qb.osdArr[d][1][0]||0!==qb.osdArr[d][1][1]){g=1;break}if(0!==g){if($.clearRect(0,0,Z.prop("width"),Z.prop("height")),-2==b){for(sb="Outside",d=0;d<qb.maxLen;d++)-1==yb.indexOf(d)&&yb.push(d),qb.osdArr[d]=[[0,0],[0,0]];rb=0}else-1==b&&(qb.osdArr[e]=[[0,0],[0,0]]);if(c){for(a.publish("RegionChanged",[B(qb.osdArr[e])[0][0],B(qb.osdArr[e])[0][1],B(qb.osdArr[e])[1][0],B(qb.osdArr[e])[1][1],e]),a.each(qb.osdArr,function(a,b){var c=b[0][0]/Z.prop("width")*8191,d=b[0][1]/Z.prop("height")*8191,e=b[1][0]/Z.prop("width")*8191,g=b[1][1]/Z.prop("height")*8191;"FireDetect"==ob?f.SetSelRegionByIndex(a,c,d,e,g,Ab,void 0,!0):f.SetSelRegionByIndex(a,c,d,e,g,Ab)}),d=e;d>-1;d--)if(-1==yb.indexOf(d)){rb=d;break}if(-1==d){for(d=qb.maxLen-1;d>e;d--)if(-1==yb.indexOf(d)){rb=d;break}d==e&&(sb="Outside",rb=0)}}}}},RegionClip:function(b,c,d,e,f,g){if(b&&c){Db={},d||e||f||g?(d=d*(Z.width()-0)/8191,e=e*(Z.height()-0)/8191,f=f*(Z.width()-0)/8191,g=g*(Z.height()-0)/8191):(d=(Z.width()-0)/2-(Z.width()-0)*b/(2*Bb),e=(Z.height()-0)/2-(Z.height()-0)*c/(2*Cb),f=(Z.width()-0)/2+(Z.width()-0)*b/(2*Bb),g=(Z.height()-0)/2+(Z.height()-0)*c/(2*Cb)),$&&$.clearRect(0,0,Z.prop("width"),Z.prop("height"));var h=new Tb([[d,e],[f,g]],{dashed:!0});h.stroke(),ob="VideoCut",rb=0,qb.osdArr=[[[d,e],[f,g]]],setTimeout(function(){a.publish("RegionChanged",[B(qb.osdArr[rb])[0][0],B(qb.osdArr[rb])[0][1],B(qb.osdArr[rb])[1][0],B(qb.osdArr[rb])[1][1],rb])},0),Db.width=(b*(Z.width()-0)/Bb).toFixed(0),Db.height=(c*(Z.height()-0)/Cb).toFixed(0)}}},Sb=function(a,b,c){var e=b||ib;a=d("Line",a),this.points=a,this.strokeStyle=e.strokeStyle||ib.strokeStyle,this.dashed=e.dashed||ib.dashed,this.show=e.show||ib.show,this.direction=e.direction||ib.direction,this.sel=e.sel||ib.sel,this.editable=e.editable||ib.editable,this.showName=e.showName||ib.showName,this.shapeName=c},Tb=function(a,b,c){var e=b||ib;a=d("Rect",a,b),this.points=a,this.strokeStyle=e.strokeStyle||ib.strokeStyle,this.fillStyle=e.fillStyle||ib.fillStyle,this.filled=e.filled||ib.filled,this.dashed=e.dashed||ib.dashed,this.show=e.show||ib.show,this.direction=e.direction||ib.direction,this.sel=e.sel||ib.sel,this.editable=e.editable||ib.editable,this.showName=e.showName||ib.showName,this.shapeName=c},Ub=function(a,b,c){var e=b||ib;a=d("Polygon",a,b),this.points=a,this.strokeStyle=e.strokeStyle||ib.strokeStyle,this.fillStyle=e.fillStyle||ib.fillStyle,this.filled=e.filled||ib.filled,this.dashed=e.dashed||ib.dashed,this.show=e.show||ib.show,this.direction=e.direction||ib.direction,this.sel=e.sel||ib.sel,this.editable=e.editable||ib.editable,this.showName=e.showName||ib.showName,this.shapeName=c};Sb.prototype={getData:function(){return this.points},createPath:function(){var b=this.points;$.lineWidth=this.lineWidth,$.strokeStyle=this.strokeStyle,$.fillStyle=this.fillStyle,this.dashed&&($.setLineDash([4,2]),$.lineDashOffset=0),$.beginPath(),a.each(b,function(a){0===a?$.moveTo(b[a][0],b[a][1]):$.lineTo(b[a][0],b[a][1])})},stroke:function(){$.save(),$.strokeStyle=this.strokeStyle,this.createPath(),$.stroke(),$.restore()},fill:function(){$.save(),this.createPath(),$.strokeStyle=this.strokeStyle,$.fillStyle=this.fillStyle,$.stroke(),$.fill(),$.restore()},move:function(a,b){this.x=a,this.y=b}},Tb.prototype={getData:function(){return this.points},createPath:function(){var a=this.points;2===a.length&&(this.dashed&&($.setLineDash([4,2]),$.lineDashOffset=0),$.beginPath(),$.rect(a[0][0],a[0][1],a[1][0]-a[0][0],a[1][1]-a[0][1]),$.closePath())},stroke:function(){2===this.points.length&&($.save(),this.createPath(),$.strokeStyle=this.strokeStyle,$.stroke(),$.restore())},fill:function(){2===this.points.length&&($.save(),this.createPath(),$.strokeStyle=this.strokeStyle,$.fillStyle=this.fillStyle,$.stroke(),$.fill(),$.restore())},move:function(a,b){this.x=a,this.y=b}},Ub.prototype={getPoints:function(){return this.points},createPath:function(){var b=this.getPoints();this.dashed&&($.setLineDash([4,2]),$.lineDashOffset=0),$.beginPath(),a.each(b,function(a,b){a?$.lineTo(b[0],b[1]):$.moveTo(b[0],b[1])}),$.closePath()},stroke:function(){$.save(),this.createPath(),$.strokeStyle=this.strokeStyle,$.stroke(),$.restore()},fill:function(){$.save(),this.createPath($),$.strokeStyle=this.strokeStyle,$.fillStyle=this.fillStyle,$.stroke(),$.fill(),$.restore()},move:function(a,b){this.x=a,this.y=b}}})}(jQuery);