!function(a){define(function(require,b,c){function d(){var a=location.hostname;return/:/.test(a)?/\[|\]/.test(a)?a:"["+a+"]":a}function e(){return""==location.port?"http:"==location.protocol?80:443:location.port}function f(a,b,c){return a.indexOf("264")>-1&&b===!1&&c>t?"video":"canvas"}var g,h,i=require("jsCore/rpcLogin"),j=require("jsCore/rpc"),k=require("jsCore/pluginCanvas"),l={},m=null,n={},o=null,p=null,q=null,r=null,s=null,t=921600,u=!1,v=null,w=null,x=.5,y=!0,z=c.exports={wsprotocol:"http:"===location.protocol?"ws":"wss",rtspprotocol:"rtsp",ip:d(),port:e(),mode:"canvas",audioPreviewVolume:0,audioPlaybackVolume:0,debug:!1,speed:1,currTime:0,totalTime:0,init:function(){p=this,(null===m||0===m.length)&&(jQuery("#h5playerContainer").remove(),jQuery("body").append('<div id="h5playerContainer" style="background:rgb(0,0,0);position:absolute;top:-10000px;width:1px;height:1px"></div>'),m=a("#h5playerContainer"),m.append('<canvas id="canvasplayer" style="position:absolute;" width="300" height="300"></canvas>'),m.append('<div id="videoLoading" class="video_loading"></div>'),m.append('<video id="videoplayer" style="position:absolute;" width="100%" height="100%"></video>'),m.append('<div id="h5playerProptip" class="h5playerProptip" style="display:none"></div>'),m.append('<div id="h5playertip" class="h5playertip" style="display:none"><span id="h5playertipWord"></span><i class="i-close"></i></div>'),m.translation(),l.canvasplayer=m.find("#canvasplayer"),l.videoplayer=m.find("#videoplayer"),o=m.find("#videoLoading"),n.canvasplayerObj=l.canvasplayer[0],n.videoplayerObj=l.videoplayer[0],m.find("#h5playertip i.i-close").on("click",function(){m.find("#h5playertip").hide().find("#h5playertipWord").text("")}))},cover:function(a,b){var c=a;if(c.is(":visible")){var d=c.offset(),e=c.width(),f=c.height();m.css({width:e,height:f,top:d.top,left:d.left,"z-index":10002}),e=m.width(),f=m.height();var g,h,i,j,k,n;b?(g=b.split("*")[0],h=b.split("*")[1]):(g=l.canvasplayer.attr("width"),h=l.canvasplayer.attr("height")),e*h>g*f?(i=g*f/h,j=f,k=0,n=(e*h-g*f)/(2*h)):g*f>e*h?(i=e,j=h*e/g,k=(g*f-e*h)/(2*g),n=0):(k=0,n=0,i=e,j=f),e-i>0&&2>e-i&&(i=e,n=0),"canvas"===z.mode&&(b&&l.canvasplayer.attr("width",g).attr("height",h),l.canvasplayer.css({top:k,left:n,width:i,height:j})),m.show()}},_coverContainer:function(a){var b=a;if(b.is(":visible")){var c=b.offset(),d=b.width(),e=b.height();m.css({width:d,height:e,top:c.top,left:c.left,"z-index":10002}),"canvas"===z.mode&&l.canvasplayer.css({top:0,left:0,width:300,height:300}).prop("width",300).prop("height",300),m.show()}},playPreview:function(b,c,d,e,f,g){if(g&&a("#canvas").hide(),y=!1,z._coverContainer(d),m.show().find("#h5playerProptip").hide().text(""),!i.chkAuthority("Monitor_01"))return void m.find("#h5playerProptip").show().text(tl("noVideoAuthoity"));l.canvasplayer.hide(),l.videoplayer.hide(),o.show();var h=i.getLoginInfo();z.setMode(c).done(function(a){z.mode=a;var i={wsURL:p.wsprotocol+"://"+p.ip+":"+p.port+"/rtspoverwebsocket",rtspURL:p.rtspprotocol+"://"+p.ip+":"+p.port+"/cam/realmonitor?channel="+b+"&subtype="+c,decodeMode:z.mode,username:h.username,password:h.password};y!==!0&&(q=new PlayerControl(i),q.on("DecodeStart",function(a){z.cover(d,a.width+"*"+a.height)}),q.on("PlayStart",function(){o.hide();var a={};"canvas"===z.mode?(l.canvasplayer.show(),a.width=l.canvasplayer.attr("width")-0,a.height=l.canvasplayer.attr("height")-0):(l.videoplayer.show(),a.width=n.videoplayerObj.videoWidth-0,a.height=n.videoplayerObj.videoHeight-0),f&&(g&&(k.hide(),webApp.resolution.x=a.width,webApp.resolution.y=a.height,k.cover("#attr_video",webApp.resolution.x+"*"+webApp.resolution.y),jQuery('[data-page="camera_attr"] [cfg="VideoInBacklight"]').hasClass("current")?jQuery('[data-page="camera_attr"] [sel-for=onSelBLMode]').change():jQuery('[data-page="camera_attr"] [cfg="VideoInWhiteBalance"]').hasClass("current")&&jQuery('[data-page="camera_attr"] #attr_wb_mode').change()),f.resolve(a))}),q.on("ResolutionChanged",function(a){v=a.width*a.height,z._rePlay(w,u,v,b,c,d,e,f,g),z.cover(d,a.width+"*"+a.height)}),q.on("MSEResolutionChanged",function(a){v=a.width*a.height,z._rePlay(w,u,v,b,c,d,e,f,g),z.cover(d,a.width+"*"+a.height)}),q.on("FrameTypeChange",function(a){w=a,z._rePlay(w,u,v,b,c,d,e,f,g)}),q.on("audioChange",function(){e&&z._rePlay(w,u,v,b,c,d,f,e,g)}),q.on("Error",function(a){if(a)switch(a.errorCode){case 101:e&&0===c&&e();break;case 404:o.hide(),m.show().find("#h5playerProptip").show().text(tl("resource is limited, open video failed!"));break;case 201:e&&m.find("#h5playertip").show().find("#h5playertipWord").text(tl("med.notSupportAudioType"))}}),q.on("WorkerReady",function(){q.connect()}),q.init(n.canvasplayerObj,n.videoplayerObj),q.setAudioVolume(e?z.audioPreviewVolume:0))})},_rePlay:function(a,b,c,d,e,g,h,i,j){var k=f(a,b,c);z.hide(),z.mode=k,z.playPreview(d,e,g,h,i,j)},playback:function(a,b,c,d){var e=0,f=0;z.mode="canvas",z.totalTime=0,z.currTime=0,z._coverContainer(b),o.show(),m.find("#h5playerProptip").hide().text("");var g=i.getLoginInfo(),h={wsURL:p.wsprotocol+"://"+p.ip+":"+p.port+"/rtspoverwebsocket",rtspURL:p.rtspprotocol+"://"+p.ip+":"+p.port+"/"+a.FilePath,decodeMode:z.mode,username:g.username,password:g.password};q=new PlayerControl(h),q.on("PlayStart",function(){o.hide(),l.canvasplayer.show(),m.off("mouseenter").off("mouseleave").on("mouseenter",function(){s.show()}).on("mouseleave",function(){s.hide()})}),q.on("DecodeStart",function(a){z.cover(b,a.width+"*"+a.height)}),q.on("GetFrameRate",function(){}),q.on("UpdateCanvas",function(a){0===e&&(e=a.timestamp),z.currTime=a.timestamp-e,z.currTime!==f&&(f=z.currTime,p.processControlsBar(z.currTime))}),q.on("Error",function(a){if(a)switch(a.errorCode){case 101:z.currTime<z.totalTime*x&&(c(),m.show().find("#h5playerProptip").show().text(tl("net.streamMaximumDelay")),q.close());break;case 201:m.find("#h5playertip").show().find("#h5playertipWord").text(tl("med.notSupportAudioType"))}}),q.init(n.canvasplayerObj,n.videoplayerObj),q.connect(),z._initPlayBackControlsBar(a.Duration,d)},initControlsBar:function(){null===s&&(m.append('<div id="controlsBarContainer" class="playback-controlsbar-container" style="display:none"></div>'),s=m.find("#controlsBarContainer"),s.append('<div id="controlsBar" style="width:600px;margin-top:14px;margin-left:50px;"></div'),r=s.find("#controlsBar"),s.append('<div class="playback-controlsbar-process"><span id="currentTimeSpan">00:00:01</span>/<span id="totalTimeSpan">24:24:24</span></div>'),g=s.find("#currentTimeSpan"),h=s.find("#totalTimeSpan"))},_initPlayBackControlsBar:function(a,b){z.totalTime=a,r.slider({min:1,max:a,dragEnable:!1,prompt:!1,title:function(a){return window.global.formatSeconds(a)},icons:!1,complete:function(a,c){z.playByTime(c.value),b()}}),h.text(window.global.formatSeconds(a)),z.processControlsBar(0)},processControlsBar:function(a){null!==s&&(a=a||0,r.slider("value",a),g.text(window.global.formatSeconds(a)))},showAutoSwitch:function(a,b){a&&m.find("#h5playertip").show().find("#h5playertipWord").text(b)},playByTime:function(a){q.playByTime(a)},play:function(){return q?(q.play(),!0):!1},playFF:function(a){q&&(q.playFF(a),z.speed=a)},pause:function(){return q?(q.pause(),!0):!1},stop:function(){return q?(q.stop(),!0):!1},capture:function(){var a=new Date,b=a.getFullYear()+""+global.leftPad(a.getMonth()+1,"0",2)+global.leftPad(a.getDate(),"0",2);b+="_",b=b+global.leftPad(a.getHours(),"0",2)+""+global.leftPad(a.getMinutes(),"0",2)+global.leftPad(a.getSeconds(),"0",2),q&&q.capture(b)},setAudioVolume:function(a,b){b===!0?z.audioPlaybackVolume=a:z.audioPreviewVolume=a,q&&q.setAudioVolume(a)},hide:function(){"h5"===webApp.playMode&&(m.hide(),m.find("#h5playerProptip").hide().text(""),m.off(),l.canvasplayer.hide(),l.videoplayer.hide(),m.find("#h5playertip").hide().find("#h5playertipWord").text(""),q&&(y=!0,q.close()),o&&o.hide(),s&&s.hide(),q=null)},destroy:function(){},setMode:function(b){return b=b||0,a.Deferred(function(a){var c=["Encode","SmartEncode"],d="canvas";j.ConfigManager.getConfig(c).done(function(c){var e=null;if(u=!1,0===b)e=c[0].params.table[0].MainFormat[0],u=c[1].result&&c[1].params.table[0].Enable;else{var g=b-1;b>3&&(g=b-4),e=c[0].params.table[0].ExtraFormat[g],u=c[1].result&&c[1].params.table[0].Extra&&c[1].params.table[0].Extra[g]}v=e.Video.Height*e.Video.Width,w=e.Video.Compression,d=f(w,u,v),a.resolve(d)}).fail(function(){a.reject()})}).promise()},visible:function(a){m&&m.css("visibility",a?"visible":"hidden")}}})}(jQuery);