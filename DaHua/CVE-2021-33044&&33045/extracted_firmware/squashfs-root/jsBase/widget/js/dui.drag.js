!function(a,b){a.widget("dui.drag",{version:"1.0.1",widgetName:"drag",widgetEventPrefix:"drag",options:{dragElements:null,droppables:null,grid:!1,modifiers:{x:"left",y:"top"},size:!1,position:!1,adsorption:0,distance:!1,autoReset:!1,overlay:!0,showSelect:!1,resize:!1,resizeDirections:["resize-left","resize-left-top","resize-top","resize-top-right","resize-right","resize-right-bottom","resize-bottom","resize-bottom-left"],limit:!1,unit:"px"},_create:function(){var b=this,c=this.options.dragElements;this.dragElements=null===c?this.element.children():this.element.children(c);var d=this.options.droppables;this.droppables=null===d?!1:this.element.children(d),this.doc=a(this.element[0].ownerDocument),this.mouse={now:{},pos:{}},this.value={now:{}},this.firstPosition=[],this.element.css("position","relative"),this.dragElements.css("position","absolute").each(function(c,d){b._setPostion.call(b,a(d),c),b._setSize.call(b,a(d),c)}),this._setupEvents(),this.selection=a.browser.Engine.trident?"selectstart":"mousedown",this.options.showSelect&&this.options.resize&&this.dragElements.delegate(".resize-left,.resize-left-top,.resize-top,.resize-top-right,.resize-right,.resize-right-bottom,.resize-bottom,.resize-bottom-left","mousedown",function(c){var d=a(this);b.target=d.parent();var e={left:c.pageX,top:c.pageY};b._on(b.doc,{mousemove:function(a){for(var c={left:a.pageX,top:a.pageY},f=d.attr("value").split("-"),g=1;g<f.length;g++)b._setResize(e,c,f[g],a.ctrlKey);e.left=a.pageX,e.top=a.pageY,a.stopPropagation()}}),b._on(b.doc,{mouseup:function(a){b.dragElements.find(".resize-left,.resize-left-top,.resize-top,.resize-top-right,.resize-right,.resize-right-bottom,.resize-bottom,.resize-bottom-left").off("mousemove"),b._off(b.doc,"mousemove"),b._off(b.doc,"mouseup"),a.stopPropagation(),b._trigger("stop",c,{ui:b})}}),c.stopPropagation()})},_setPostion:function(b,c){var d=this.options.position,e=a.type(d),f=(this.element.width()-b.outerWidth(!0))/2,g=(this.element.height()-b.outerHeight(!0))/2,h=null,i=0;"object"==e?(h={left:parseInt(d.left),top:parseInt(d.top)},i=d.zOrder||0):"array"==e?(h="center"==d[c]?{left:parseInt(f),top:parseInt(g)}:{left:parseInt(d[c].left),top:parseInt(d[c].top)},i=d[c].zOrder||0):"string"==e?"center"==d&&(h={left:parseInt(f),top:parseInt(g)}):h=b.position(),this.firstPosition[b.index()]=h,b.css(h).data("zOrder",i)},_setSize:function(a,b){var c=this.options.size;c!==!1&&a.css({width:c[b].width,height:c[b].height}).data("resize",{minSize:c[b].minSize,maxSize:c[b].maxSize})},_setupEvents:function(){this._on(this.dragElements,{mousedown:this._start})},_start:function(b){this._trigger("beforeStart",b,{ui:this});var c,d=this.options.modifiers,e={x:b.pageX,y:b.pageY};this.mouse.start=a.extend(!0,{},e),this.mouse.now=a.extend(!0,{},e),this.target=a(b.currentTarget),this.options.showSelect&&this._showCurrentSelect();for(c in d)this.value.now[c]=parseInt(this.target.css(d[c])),this.mouse.pos[c]=e[c]-this.value.now[c];"number"==a.type(this.options.grid)&&(this.options.grid={x:this.options.grid,y:this.options.grid});var f={mousemove:this._drag,mouseup:this._stop};f[this.selection]=function(){return!1},this._on(this.doc,f),this._addDrapLimit(),this._trigger("start",b,{ui:this})},_addDrapLimit:function(){var b=this.target,c=this.element,d={};a.each(["left","top"],function(a,b){d[b]=parseInt(c.css("padding-"+b))});var e=c.width(),f=c.height(),g=b.outerWidth(!0),h=b.outerHeight(!0),i=d.left,j=d.top,k=[i,i+e-g],l=[j,j+f-h],m=this.options.limit;m&&(-1!==a.inArray("x",m)&&(k=[this.firstPosition[b.index()].left,this.firstPosition[b.index()].left]),-1!==a.inArray("y",m)&&(l=[this.firstPosition[b.index()].top,this.firstPosition[b.index()].top])),this.limit={x:k,y:l}},_getMouseMove:function(){var a=this.mouse;this.move=Math.round(Math.sqrt(Math.pow(a.now.x-a.start.x,2)+Math.pow(a.now.y-a.start.y,2)))},_checkDistance:function(){var a=(this.mouse,this.move);return this.options.distance?a<=this.options.distance:!0},_fixValue:function(){var a=this.options.distance,b=this.mouse;if(a){var c=this.move,d=(b.now.x-b.start.x)*a/c,e=(b.now.y-b.start.y)*a/c,f=this.firstPosition[this.target.index()].left,g=this.firstPosition[this.target.index()].top;this.value.now={x:d+f,y:e+g}}},_showCurrentSelect:function(){var b=this;this.dragElements.find(".resize-left,.resize-left-top,.resize-top,.resize-top-right,.resize-right,.resize-right-bottom,.resize-bottom,.resize-bottom-left").remove(),a.each(this.options.resizeDirections,function(c,d){var e=a('<div value="'+d+'" class="'+d+'"></div>');b.options.resize||e.css("cursor","default"),b.target.append(e)})},_setResize:function(a,b,c,d){var e=this,f=e.target.data("resize"),g=f.minSize,h=f.maxSize,i=this.options.adsorption;switch(chk=0==i||d?!1:e._checkAdsorption(c,b[c]-a[c]+this.target.position()[c]),c){case"left":if(b.left-a.left<0){if(!e.options.overlay&&e._checkOverlay("left",e.target.position().left+b.left-a.left))break;if(b.left-a.left+e.target.position().left<i){if(h&&e.target.width()+e.target.position().left>=h[0]){e.target.width(h[0]);break}e.target.width(e.target.width()+e.target.position().left),e.target.css("left",0)}else if(b.left-a.left+e.target.position().left>0){if(h&&e.target.width()>=h[0]){e.target.width(h[0]);break}chk&&e.target.position().left-chk.position().left>0?(e.target.width(e.target.position().left-chk.position().left-chk.width()+e.target.width()),e.target.css("left",chk.position().left+chk.width())):(e.target.css("left",b.left-a.left+e.target.position().left),e.target.width(e.target.width()+Math.abs(b.left-a.left)))}}else if(b.left-a.left>0){if(g&&e.target.width()<=g[0]){e.target.width(g[0]);break}a.left-b.left+e.target.width()>0&&(e.target.css("left",b.left-a.left+e.target.position().left),e.target.width(e.target.width()-Math.abs(b.left-a.left)))}break;case"top":if(b.top-a.top<0){if(!e.options.overlay&&e._checkOverlay("top",e.target.position().top+b.top-a.top))break;if(b.top-a.top+e.target.position().top<i){if(h&&e.target.height()+e.target.position().top>=h[1]){e.target.height(h[1]);break}e.target.height(e.target.height()+e.target.position().top),e.target.css("top",0)}else if(b.top-a.top+e.target.position().top>0){if(h&&e.target.height()>=h[1]){e.target.height(h[1]);break}chk&&e.target.position().top-chk.position().top>0?(e.target.height(e.target.position().top-chk.position().top-chk.height()+e.target.height()),e.target.css("top",chk.position().top+chk.height())):(e.target.css("top",b.top-a.top+e.target.position().top),e.target.height(e.target.height()+Math.abs(b.top-a.top)))}}else if(b.top-a.top>0){if(g&&e.target.height()<=g[1]){e.target.height(g[1]);break}a.top-b.top+e.target.height()>0&&(e.target.css("top",b.top-a.top+e.target.position().top),e.target.height(e.target.height()-Math.abs(b.top-a.top)))}break;case"right":if(b.left-a.left<0){if(g&&e.target.width()<=g[0]){e.target.width(g[0]);break}b.left-a.left+e.target.width()>0&&e.target.width(e.target.width()+b.left-a.left)}else if(b.left-a.left>0){if(h&&e.target.width()>=h[0]){e.target.width(h[0]);break}if(!e.options.overlay&&e._checkOverlay("left",e.target.position().left+b.left-a.left))break;e.target.width(b.left-a.left+e.target.width()+e.target.position().left<e.target.parent().width()-i?chk&&chk.position().left-e.target.position().left>0?chk.position().left-e.target.position().left:e.target.width()+b.left-a.left:e.target.parent().width()-e.target.position().left)}break;case"bottom":if(b.top-a.top<0){if(g&&e.target.height()<=g[1]){e.target.height(g[1]);break}b.top-a.top+e.target.height()>0&&e.target.height(e.target.height()+b.top-a.top)}else if(b.top-a.top>0){if(h&&e.target.height()>=h[1]){e.target.height(h[1]);break}if(!e.options.overlay&&e._checkOverlay("top",e.target.position().top+b.top-a.top))break;e.target.height(b.top-a.top+e.target.height()+e.target.position().top<e.target.parent().height()-i?chk&&chk.position().top-e.target.position().top>0?chk.position().top-e.target.position().top:e.target.height()+b.top-a.top:e.target.parent().height()-e.target.position().top)}}},_isRectangleIntersect:function(a,b){var c=[(a[0]+a[0]+a[2])/2,(a[1]+a[1]+a[3])/2],d=[(b[0]+b[0]+b[2])/2,(b[1]+b[1]+b[3])/2];return 2*Math.abs(c[0]-d[0])<a[2]+b[2]&&2*Math.abs(c[1]-d[1])<a[3]+b[3]},_checkOverlay:function(a,b){var c=this.target,d=this.target.siblings(),e=[this.target.position().left,this.target.position().top,this.target.width(),this.target.height()];"left"==a&&(e[0]=b),"top"==a&&(e[1]=b);for(var f=d.length-1;f>=0;f--){var g=d.eq(f),h=[g.position().left,g.position().top,g.width(),g.height()];if(c.data("zOrder")==g.data("zOrder")&&this._isRectangleIntersect(e,h))return g}return!1},_drag:function(a){var b,c=this.options.modifiers,d={x:a.pageX,y:a.pageY},e=this.options.adsorption;this.mouse.primeMouse=this.mouse.now||this.mouse.start,this.mouse.now=d,this._getMouseMove();for(b in c)if(this.value.now[b]=this._checkRange(this.mouse.now[b]-this.mouse.pos[b],b),this.options.grid&&this.options.grid[b]&&(this.value.now[b]-=this.value.now[b]%this.options.grid[b]),this._checkDistance()||this._fixValue(),e&&!a.ctrlKey){this.value.now[b]=this._checkBorder(this.mouse.now[b]-this.mouse.pos[b],b);var f=this._checkAdsorption(c[b],this.value.now[b]);if(f){var g=f.position()[c[b]]-this.target.position()[c[b]],h="left"==c[b]?this.target.width():this.target.height(),i="left"==c[b]?f.width():f.height(),j=0>g?f.position()[c[b]]+i:f.position()[c[b]]-h;j=this._checkRange(j,b),!this._checkOverlay(c[b],j)&&this.target.css(c[b],j)}else this.target.css(c[b],this.value.now[b]+this.options.unit)}else if(this.options.overlay)this.target.css(c[b],this.value.now[b]+this.options.unit);else{var k=this._checkOverlay(c[b],this.value.now[b]);if(k){var l=this.value.now[b]-this.target.position()[c[b]],h="left"==c[b]?this.target.width():this.target.height(),i="left"==c[b]?k.width():k.height(),j=l>0?k.position()[c[b]]-h:k.position()[c[b]]+i;j=this._checkRange(j,b),!this._checkOverlay(c[b],j)&&this.target.css(c[b],j)}else this.target.css(c[b],this.value.now[b]+this.options.unit)}this._trigger("drag",a,{ui:this,position:this.value.now,firstPosition:{x:this.firstPosition[this.target.index()].left,y:this.firstPosition[this.target.index()].top}})},_checkRange:function(a,b){var c=this.limit[b];return c&&(a>c[1]?a=c[1]:a<c[0]&&(a=c[0])),a},_stop:function(a){if(this.options.adsorption&&!a.ctrlKey)for(var c in this.options.modifiers)this._checkAdsorption(this.options.modifiers[c],b,"aligment");this._off(this.doc,"mousemove"),this._off(this.doc,"mouseup"),this._off(this.doc,this.selection),this.droppables&&(this.overed=this._checkDroppables()),this._trigger("stop",a,{ui:this}),this.options.autoReset&&this.target.css(this.firstPosition[this.target.index()])},getCurrent:function(){return this.target||a()},_checkDroppables:function(){var b=this,c=a.grep(this.droppables,function(c){var d=a(c).offset(),e=a(c).width(),f=a(c).height(),g=b.mouse.now;return g.x>d.left&&g.x<d.left+e&&g.y<d.top+f&&g.y>d.top});return c.length?a(c[0]):void 0},_checkBorder:function(a,b){var c=this.limit[b],d=this.options.adsorption;return c&&(a>c[1]-d?a=c[1]:a<c[0]+d&&(a=c[0])),a},_rectAdsorption:function(a,b,c){var d=[(a[0]+a[0]+a[2])/2,(a[1]+a[1]+a[3])/2],e=[(b[0]+b[0]+b[2])/2,(b[1]+b[1]+b[3])/2];return"left"==c||"right"==c?2*Math.abs(d[0]-e[0])-(a[2]+b[2])<this.options.adsorption&&2*Math.abs(d[1]-e[1])-(a[3]+b[3])<0:2*Math.abs(d[1]-e[1])-(a[3]+b[3])<this.options.adsorption&&2*Math.abs(d[0]-e[0])-(a[2]+b[2])<0},_checkAdsorption:function(a,b,c){c=c||"adsortion";var d=this.target,e=this.target.siblings(),f=d.data("zOrder"),g=[this.target.position().left,this.target.position().top,this.target.width(),this.target.height()];"adsortion"==c&&("left"==a&&(g[0]=b),"top"==a&&(g[1]=b));for(var h=e.length-1;h>=0;h--){var i=e.eq(h),j=[i.position().left,i.position().top,i.width(),i.height()];if(f==i.data("zOrder"))if("adsortion"==c){if(this._rectAdsorption(g,j,a))return i}else if(this._checkAlignment(g,j,a))return i}return!1},_checkAlignment:function(a,b,c){var d,e,f,g,h;if(d={left:"x",top:"y"},this.mouse.primeMouse=this.mouse.primeMouse||this.mouse.start,g=this.options.adsorption,e=this.mouse.now[d[c]]-this.mouse.pos[d[c]],f=this.mouse.primeMouse[d[c]]-this.mouse.pos[d[c]],e>f){if("left"==c){if((a[1]==b[1]+b[3]||a[1]==b[1]-a[3])&&Math.abs(b[2]+b[0]-a[2]-a[0])<g&&Math.abs(a[0]-b[0])>0)return h=this._checkRange(b[0]+b[2]-a[2],"x"),!this._checkOverlay("left",h)&&this.target.css("left",h),!0}else if((b[0]==a[0]+a[2]||a[0]==b[0]+b[2])&&Math.abs(b[3]+b[1]-a[3]-a[1])<g&&Math.abs(b[3]+b[1]-a[3]-a[1])>0)return h=this._checkRange(b[1]+b[3]-a[3],"y"),!this._checkOverlay("top",h)&&this.target.css("top",h),!0}else{if(!(f>e))return!1;if("left"==c){if((a[1]==b[1]+b[3]||a[1]==b[1]-a[3])&&Math.abs(a[0]-b[0])<g&&Math.abs(a[0]-b[0])>0)return h=this._checkRange(b[0],"x"),!this._checkOverlay("left",h)&&this.target.css("left",h),!0}else if((b[0]==a[0]+a[2]||a[0]==b[0]+b[2])&&Math.abs(a[1]-b[1])<g&&Math.abs(a[0]-b[0])>0)return h=this._checkRange(b[1],"y"),!this._checkOverlay("top",h)&&this.target.css("top",h),!0}}})}(jQuery);