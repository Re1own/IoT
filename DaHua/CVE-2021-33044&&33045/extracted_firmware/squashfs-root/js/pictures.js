!function(a){define(function(require,b,c){var d=require("jsCore/rpc"),e=require("jsCore/ability"),f=require("common/common"),g=f.Cookie,h=require("jsCore/plugin"),i=require("jsCore/rpcLogin"),j=require("jsCore/pageBase"),k=12,l=[tl("ivs.OsdOriginal"),tl("ivs.OsdCompound"),"dav","avi","mp4"],m=null,n=0,o=new Array,p=0,q=0,r=0,s=null,t=null,u=null,v=null,w=null,x=null,y=null;c.exports=j.extend({init:function(){s=this,u=s.$("#pictures_dp1").datepicker(),u.datepicker("value",new Date),v=s.$("#pictures_tp1").timefield({timeZone:"24"}),s.$("#pictures_tp1 input").css({width:"20px"}),w=s.$("#pictures_dp2").datepicker(),w.datepicker("value",new Date),x=s.$("#pictures_tp2").timefield({timeZone:"24"}),x.timefield("value","23:59:59"),s.$("#pictures_tp2 input").css({width:"20px"}),s._initPicsListTable(),"TrafficPark"===webApp.SDTraficIntelType?s.$("#pics_select").val(tl("appEventExTrafficParking")):"IntelliCityMgr"===webApp.SDTraficIntelType&&s.$("#pics_select").val(tl("appEventShopPresence")),e.get("IVSCaps").done(function(b){if(b&&b.SupportedRules){a("#pics_select_content").html("");var c="",d="",e=!1;if("TrafficPark"===webApp.SDTraficIntelType)for(var f=0;f<b.SupportedRules.length;f++)d="TrafficJam"===b.SupportedRules[f]?"ivs.appEventTrafficJam":"TrafficParkingManual"===b.SupportedRules[f]?"ivs.ManualEvidence":"appEventEx"+b.SupportedRules[f],"TrafficParking"===b.SupportedRules[f]?(e=!0,c+="<div class='ui-form-item fn-marl10'><label class='ui-checkbox'><input type='checkbox' value='"+b.SupportedRules[f]+"' checked><span>"+tl(d)+"</span></label></div>"):c+="<div class='ui-form-item fn-marl10'><label class='ui-checkbox'><input type='checkbox' value='"+b.SupportedRules[f]+"'><span>"+tl(d)+"</span></label></div>";else if("IntelliCityMgr"===webApp.SDTraficIntelType)for(var f=0;f<b.SupportedRules.length;f++)d="appEvent"+b.SupportedRules[f],"ShopPresence"===b.SupportedRules[f]?(e=!0,c+="<div class='ui-form-item fn-marl10'><label class='ui-checkbox'><input type='checkbox' value='"+b.SupportedRules[f]+"' checked><span>"+tl(d)+"</span></label></div>"):c+="<div class='ui-form-item fn-marl10'><label class='ui-checkbox'><input type='checkbox' value='"+b.SupportedRules[f]+"'><span>"+tl(d)+"</span></label></div>";a("#pics_select_content").html(c)}}),y=s.$("#pictures_tip"),s.bind(),s.render()},bind:function(){s.$("#pics_select_mask").on("click",function(){if(s.$("#pics_select_content").hasClass("fn-hide"))s.$("#pics_select_content").removeClass("fn-hide");else{s.$("#pics_select_content").addClass("fn-hide");var b="",c=0,d=s.$("#pics_select_content input[type='checkbox']");a.each(d,function(e,f){"TrafficPark"===webApp.SDTraficIntelType?a(f).prop("checked")&&(b+="TrafficJam"===a(f).val()?tl("ivs.appEvent"+a(f).val())+"，":"TrafficParkingManual"===a(f).val()?tl("ivs.ManualEvidence"):tl("appEventEx"+a(f).val())+"，",c++):"IntelliCityMgr"===webApp.SDTraficIntelType&&a(f).prop("checked")&&(b+=tl("appEvent"+a(f).val())+"，",c++),e==d.length-1&&(3>=c||(b=b.substring(0,14)+"..."))}),s.$("#pics_select").val(b)}s.$("#pics_select_content").focus()}),a("#pics_select_content label.ui-checkbox input[type='checkbox']").on("click",function(){s.$("#pics_select_mask").click()}),s.$("#pics_select_content").on("mouseleave",function(){s.$("#pics_select_content").addClass("fn-hide")}),s.$("#pictures_search").on("click",s._bindSearchfiles)},render:function(){h.GetConfigPath("PlaybackDownload").done(function(a){s.$("#path_PictureSnapshot").val(a)})},_bindSearchfiles:function(){if(s.$(this).hasClass("ui-button-disabled"))return!1;s.$(this).addClass("ui-button-disabled"),p=0,r=0,q=0,s.$("#g_downFileProgress").css("display","none");var b=u.datepicker("value")+" "+v.timefield("value"),c=w.datepicker("value")+" "+x.timefield("value"),e=new Date(b).getTime(),f=new Date(c).getTime();if(e>=f)return s._picsTip("error",tl("com.BeginTLessThanEndTTip")),void s.$("#pictures_search").removeClass("ui-button-disabled");var g=["==",0];g=2===~~a("#pictures_files_type").val()?["||",2,3,4]:["==",~~a("#pictures_files_type").val()];var h=["||"],i=a("#pics_select_content input[type='checkbox']");a.each(i,function(b,c){"TrafficPark"===webApp.SDTraficIntelType?a(c).prop("checked")&&h.push("TrafficJam"===a(c).val()?tl("ivs.appEvent"+a(c).val()):"TrafficParkingManual"===a(c).val()?tl("appEventExTrafficParking"):"TrafficParking"===a(c).val()?tl("appEventExTrafficParkingA"):tl("appEventEx"+a(c).val())):"IntelliCityMgr"===webApp.SDTraficIntelType&&a(c).prop("checked")&&h.push(tl("appEvent"+a(c).val()))});var j={};webCaps.is_show_newIntelli?"TrafficPark"===webApp.SDTraficIntelType?j={StartTime:b,EndTime:c,DB:{TrafficPark:{Event:h,Type:g}}}:"IntelliCityMgr"===webApp.SDTraficIntelType&&(j={StartTime:b,EndTime:c,DB:{IntelliCityMgr:{Event:h,Type:g}}}):j={StartTime:b,EndTime:c,DB:{SDTraffic:{Event:h,Type:g}}},d.MediaFileFind.create().done(function(a){m=a,d.MediaFileFind.findFile(a,j).done(function(){d.MediaFileFind.getCount(a).done(function(b){n=0,o=[],s._getAllData(a,b)})}).fail(function(){s._failForGetData()})})},_failForGetData:function(){t.table("dataSource",[]),d.MediaFileFind.close(m),d.MediaFileFind.destroy(m),s._picsTip("error",tl("ivs.NotSearchData")),s.$("#pictures_search").removeClass("ui-button-disabled")},_picsTip:function(b,c){var d=a("#pictures_tip");d.removeClass("fn-hide"),d.find("i").addClass("i-"+b),d.find("span").text(c),setTimeout(function(){d.addClass("fn-hide")},1500)},_getAllData:function(b,c){var e=100;d.MediaFileFind.setQueryResultOptions(b,n).done(function(){d.MediaFileFind.findNextFile(b,e).done(function(f){for(var g=0;g<f.infos.length;g++){var h={},i=null;webCaps.is_show_newIntelli?"TrafficPark"===webApp.SDTraficIntelType?i=f.infos[g].Summary.TrafficPark:"IntelliCityMgr"===webApp.SDTraficIntelType&&(i=f.infos[g].Summary.IntelliCityMgr):i=f.infos[g].Summary.SDTraffic,h.pictureNum=i.PlateNumber,h.carNumber=i.PlateNumber,h.eventType=i.Event,h.eventTime=new Date(1e3*i.EventDate-288e5).format(),h.fileType=l[i.Type],h.fileSize=Math.round(i.Length/1024/1024*100)/100+"M",h.filePath=i.FilePath,h.loadProgress="",h.chooseEnable=!1,h.plateColor=i.PlateColor,o.push(h)}n+=e,c>=n?s._getAllData(b,c):(d.MediaFileFind.close(m),d.MediaFileFind.destroy(m),t.table("dataSource",o),s.$("#pics_list_table a[data-action='first']").click(),s.$("#pictures_search").removeClass("ui-button-disabled"),o&&a("#pics_list_table .u-table-main").css("height","auto"))}).fail(function(){s._failForGetData()})}).fail(function(){s._failForGetData()})},_initPicsListTable:function(){t=a("#pics_list_table").table({height:750,pageable:!0,selectSingle:!1,selectAllPage:!0,pageSize:k,columns:[{check:"chooseEnable",width:"5%"},{title:tl("com.Numbers"),width:"8%",render:function(a){return a._index+1}},{fields:"pictureNum",title:tl("com.picture"),width:"10%",render:function(b){var c=a("<div>"+b.pictureNum+"</div>");switch(b.plateColor){case tl("com.black"):c.addClass("pics-list-table-image plate-balck");break;case tl("com.BlueColor"):c.addClass("pics-list-table-image plate-blue");break;case tl("com.GreenColor"):c.addClass("pics-list-table-image plate-green");break;case tl("com.white"):c.addClass("pics-list-table-image plate-white");break;case tl("com.Yellow"):c.addClass("pics-list-table-image plate-yellow")}return c}},{fields:"carNumber",title:tl("itc.LicenseNumber"),width:"12%"},{fields:"eventTime",title:tl("ivs.EventTime"),width:"15%"},{fields:"eventType",title:tl("sto.EventType"),width:"10%"},{fields:"fileType",title:tl("sto.FileType"),width:"10%"},{fields:"fileSize",title:tl("com.FileSize:").split(":")[0],width:"10%"},{fields:"loadProgress",title:tl("com.DownloadProgress"),width:"15%",render:function(b){return a("<div id='loadPro_"+(b._index+1)+"'>"+b.loadProgress+"</div>")}}]}),s.$("#pics_list_table thead").css({"font-size":"14px",height:"30px","line-height":"30px"})},onChoosePath:function(b){("flash"===webApp.playMode||"h5"===webApp.playMode)&&s.tip("error","com.NoSupport");var c=a(b.target).attr("data-target");h.ShowFileBrowse().done(function(a){c&&s.$("#path_"+c).val(a),h.SetConfigPath("PlaybackSnapshot",s.$("#path_"+c).val())})},downLoadFiles:function(){var a=s.$("a[btn-for='downLoadFiles']");return""===s.$("#path_PictureSnapshot").val()?void s._picsTip("error",tl("com.ChooseDownloadPath")):(q=t.table("getMultiChecked","chooseEnable").length,0===q?(s._picsTip("error",tl("com.ChooseDownloadFile")),void setTimeout(function(){a.addClass("btn-start").removeClass("btn-stop"),a.children("i").addClass("download-plugin-icon fn-marl5").removeClass("playback-dates-type-red fn-left"),a.children("label").text(tl("sto.Download"))},500)):a.hasClass("btn-start")?(a.removeClass("btn-start").addClass("btn-stop"),a.children("i").removeClass("download-plugin-icon fn-marl5").addClass("playback-dates-type-red fn-left"),a.children("label").text(tl("com.Stop")),s.$("#g_downFileProgress").css("display","inline-block"),s.$("#g_downFileProgress").text(tl("com.Progress")+": "+r+" / "+q),void s.startDownload()):(a.addClass("btn-start").removeClass("btn-stop"),a.children("i").addClass("download-plugin-icon fn-marl5").removeClass("playback-dates-type-red fn-left"),a.children("label").text(tl("sto.Download")),void h.StopAllPictureDownloadRequests()))},startDownload:function(){if(!o[p]){p=0,r=0,q=0;var a=s.$("a[btn-for='downLoadFiles']");return void setTimeout(function(){a.addClass("btn-start").removeClass("btn-stop"),a.children("i").addClass("download-plugin-icon fn-marl5").removeClass("playback-dates-type-red fn-left"),a.children("label").text(tl("sto.Download"))},500)}{var b=o[p].filePath,c=b.split("/"),e=c[4]+"-"+c[5]+"-"+c[6]+"-"+c[7],f=o[p].chooseEnable||!1,j=~~o[p]._index+1;o[p].loadProgress}f?h.GetConfigPath("PlaybackDownload").done(function(a){var c=a+"\\"+e,f=g.get("DhWebClientSessionID");h.InternetDownloadFile(b,c,f).done(function(a){a&&h.addEvent("DownloadPos",function(a){if(s.$("#loadPro_"+j).text(a+"%"),100==a){o[p].loadProgress="100%",p++,r++,s.$("#g_downFileProgress").text(tl("com.Progress")+": "+r+" / "+q);var b={Type:e,Address:location.hostname},c=i.getLoginInfo().username;d.Log.append(tl("sto.Download"),b,"Local",c),s.startDownload()}})})}):(p++,s.startDownload())}})})}(jQuery);