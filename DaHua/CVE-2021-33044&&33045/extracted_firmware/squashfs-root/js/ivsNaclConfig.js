!function(a){define(function(require,a,b){b.exports=require("jsCore/pageTab"),b.exports.prototype.ivs_global=ability.get("IVSCaps").then(function(a){return 0!==a.SupportedScenes.Normal.SupportedCalibrateParams.MaxCelibateAreas})}),define("ivs_rule",function(require,b,c){var d=require("jsCore/rpc"),e=require("jsCore/pageBase"),f=require("jsCore/ability"),g=require("jsCore/modules/naclDraw"),h=require("jsCore/modules/timeSection"),i=require("jsCore/hlsplayer"),j=require("jsCore/flashplayer"),k=require("jsCore/h5player"),l=require("jsCore/pluginCanvas");require("jsCore/modules/eventHandler"),require("widget/js/dui.slider");var m,n,o=null,p=null,q={},r=0,s=null,t=null,u="CrossLineDetection",v=!0,w={LeftDetection:[6,3600],TakenAwayDetection:[6,3600],WanderDetection:[1,600],MoveDetection:[6,300],RioterDetection:[10,300],ParkingDetection:[6,300]},x=null,y=0,z=0,A=0,B={},C={},D=null,E=[];c.exports=e.extend({init:function(){o=this,webApp.DeviceType.indexOf("IPC")>-1&&(o.$("[sel-for= onChangePreset]").append('<option value="0">0</option>'),o.$("#ivs_presets_wrap").addClass("fn-hide"),o.$("[data-emptyReules]").hide()),o.$("[slider=sensitivity]").slider({min:1,max:10,complete:function(a,b){t.Config.Sensitivity=b.value}}),o.$("#ivs_minDuration").numberfield({max:600,min:1,allowDecimal:!1}),o.$("#ivs_TrackTime").numberfield({min:5,max:300,allowDecimal:!1,allowNegative:!1}),o._getTemp(),x={support:!1,status:"",timer:0,init:function(a){a=a===!0?!0:!1,this.support=a,a===!0&&o.$("#ivs_lockPtz_wrap").removeClass("fn-hide"),this.Traceer=d.DevIntelliTracker,o.$("#ivs_lockPtz").text(tl("ivs.UnlockPtz")+"(180s)")},render:function(){if(this.support!==!1){var a=this;this.Traceer.getLockLeft().done(function(b){0==b?a.setLocktime(180):(a.renderDom(b),setTimeout(function(){a.getLocktime()},1e3))}).fail(function(){setTimeout(function(){o.$("#ivs_tip").tip("com.GetLockLeftError")},1e3)})}},renderDom:function(a){var b=this,c=o.$("#ivs_lockPtz"),d="";switch(a){case 0:d=tl("ivs.LockPtz")+"(180s)",c.on("click",function(){b.setLocktime(180)}),b.status="unlocked";break;default:d=tl("ivs.UnlockPtz")+"("+a+"s)",c.on("click",function(){b.setLocktime(0)}),b.status="locking"}c.text(d)},leave:function(){this.support!==!1&&"locking"==this.status&&this.setLocktime(0)},getLocktime:function(){var a=this;this.Traceer.getLockLeft().done(function(b){a.renderDom(b),"locking"==x.status?a.timer=setTimeout(function(){a.getLocktime()},1e3):$clear(a.timer)}).fail(function(){o.$("#ivs_tip").tip("com.GetLockLeftError")})},setLocktime:function(a){var b=this;this.Traceer.setLockDuration(a).done(function(){b.renderDom(a),b.getLocktime()}).fail(function(){o.$("#ivs_tip").tip("com.SetLockDurationError")})}},f.get("IntelliTracker").done(function(a){x.init(a&&a.Support),a&&a.Support&&o.$('div[data-wrap="TrackEnable"]').show()}),f.get("IVSCaps").done(function(b){z=b.MaxRules||10,A=b.SupportedScenes.Normal.MaxRules||10;for(var c in b.SupportedScenes.Normal.SupportedRules)"SmokeDetection"!=c&&E.push(c);-1!==E.indexOf("HeatMap")&&E.splice(E.indexOf("HeatMap"),1),-1!==E.indexOf("VideoAbnormalDetection")&&E.splice(E.indexOf("VideoAbnormalDetection"),1);var e=void 0!==b.LinkPtzSupport?b.LinkPtzSupport:webApp.HasPtz;if(webApp.EventCaps){for(var f=[],h=webApp.EventCaps,i={},j=jQuery.extend({},webApp.DefaultEvent),k=Math.ceil(E.length/8),m=[],n=[],p=0;k>p;p++)n[p]=E.slice(8*p,8*(p+1)),m.push(d.EventManager.getEventLink(n[p]));jQuery.when.apply(null,m).done(function(){for(var a=0;k>a;a++){var b=n[a],c=arguments[a].name;b.each(function(a,b){var d=c[b];i[a]=d,f.combine(d)})}f.indexOf("default")>-1?(j=h,f.length=0,$each(j,function(a,b){a&&"boolean"==typeof a&&f.push(b)})):f.each(function(a){j[a]=!0,"AlarmOutEnable"===a?j.AlarmOutLatch=h.AlarmOutLatch:"DejitterEnable"===a?j.DejitterRange=h.DejitterRange:"RecordEnable"===a&&(j.RecordLatch=h.RecordLatch)}),$each(i,function(a,b){var c=[];"default"==a[0]||f.length==a.length?a.length=0:(f.each(function(b){a.indexOf(b)<0&&c.push(b)}),i[b]=c)}),o.$("#ivs_eventHandler").eventHandler(j)}).fail(function(){o.$("#ivs_eventHandler").eventHandler({PtzLinkEnable:e})}).always(function(){jQuery("#page_ivsConfig #ala_pir_time").off("click").on("click",function(){"hls"!=webApp.playMode&&"flash"!=webApp.playMode&&"h5"!=webApp.playMode&&plugin.hide();var a=self._findIndexNow(),b=videoAnalyseRuleGlobalJson[curchannel][a];timesection.open(b.EventHandler.LightingLink.WhiteLightTimeSection,{title:"com.Period"}).done(function(a){b.EventHandler.LightingLink.WhiteLightTimeSection=a}).always(function(){"hls"!=webApp.playMode&&"flash"!=webApp.playMode&&"h5"!=webApp.playMode&&plugin.cover("#ivsVideo")})})})}else o.$("#ivs_eventHandler").eventHandler({PtzLinkEnable:e});var r={};a.each(b.SupportedScenes.Normal.SupportedRules,function(b,c){r[b]=tl(b),a.isArray(c.SupportedObjectTypes)&&"Unknown"!==c.SupportedObjectTypes[0]&&(C[b]=c.SupportedObjectTypes)}),s=o.$("#ivs_ruleManager").table({height:180,columns:[{check:"Enable",width:"15%",preventEvt:!0,checkItem:function(a,b,c){parseInt(c.rowIndex)===this.getSelectedRow()&&o._changeOCX()},checkAll:function(){o._changeOCX()}},{t:"com.Numbers",width:"8%",render:function(a){return a._index+1}},{t:"com.Name",width:"30%",fields:"Name",limit:63,editor:function(){return a('<input type="text" class="u-input" />')}},{t:"com.RuleType",width:"29%",fields:"Type",singleSel:!0,valueMap:r,editor:function(b,c){var d="",e=c.valueMap;if(e){d="<select>";for(var f in e)d+='<option value="'+f+'">'+tl(e[f])+"</option>";d+="</select>"}return a(d)}},{t:"com.Delete",width:"8%",action:"delete",icon:"i-del",titleIcon:"ui-set-icon-add",preventEvt:!0,handle:function(a){g.shapeDelete(a.shapeId),g.shapeDelete(a.sizeFilterId),("flash"==webApp.playMode||"h5"===webApp.playMode)&&(l.DeleteVideoAnalyseShape(o.containerId,a.shapeId),l.DeleteVideoAnalyseShape(o.containerId,a.sizeFilterId)),this.getSelectedRow()===a._index&&(t=null),this.del(a),0===q[a.PtzPresetId].length&&o.$("[data-emptyReules]").hide(),o._checkMaxRule()&&o.disabled(o.$("[data-action=titleAction]"),!1)},titleAction:function(b){o._addRule();var c=o._checkMaxRule();c||o.disabled(a(b.target),!0)}}],onRowSelect:function(a,b){o._saveRuleInfo(),o.hideCurrentShape(),t=b.data,o._changeRule()},onblurEditor:function(a,b){if("Type"==b.field){g.shapeDelete(b.data.shapeId),("flash"==webApp.playMode||"h5"===webApp.playMode)&&l.DeleteVideoAnalyseShape(o.containerId,b.data.shapeId),delete b.data.shapeId;var c=b.data.Name;o._modifyRule(b.editVal,c)}else if("Name"==b.field){var d=b.editVal;if(""===d||null===d||void 0===d)return o.$("#ivs_tip").tip("error",tl("com.MustName")),!1;if(b.data.Name===d)return!1;b.data.Name=b.editVal,g.ocxSetShapeName(b.data.shapeId,b.editVal),("flash"===webApp.playMode||"h5"===webApp.playMode)&&l.SetVideoAnalyseShapeShowName(o.containerId,b.data.shapeId,b.editVal),"CrossFenceDetection"==b.data.Type&&g.ocxSetShapeName(b.data.shapeId1,b.editVal+tl("ivs.DownstairsLine"))}}}),o.$("#ivs_ruleManager").on("change","[data-editable=Type] select",function(){t.Type=a(this).val()}),o.render()}),o.$('[name = "ivs_maxMin"]').on("click",o.onDrawTarget)},render:function(){if("hls"==webApp.playMode)i.cover(jQuery("#ivsVideo")),plugin.hide(),i.init("","",""),i.beginPlay();else if("flash"==webApp.playMode||"h5"===webApp.playMode){"flash"==webApp.playMode&&j.cover(jQuery("#ivsVideo")),plugin.hide(),"flash"==webApp.playMode&&j.playPreview(1,0),k&&"h5"===webApp.playMode&&(D=new a.Deferred,k.playPreview(1,0,a("#ivsVideo"),null,D));var b=function(){l.cover("#ivsVideo",webApp.resolution.x+"*"+webApp.resolution.y),o.containerId=l.CreateVideoAnalyseContainer()};"flash"===webApp.playMode?d.ConfigManager.getConfig(["Encode","VideoImageControl"]).done(function(a){if(webApp.resolution.x=a[0].params.table[0].MainFormat[0].Video.Width,webApp.resolution.y=a[0].params.table[0].MainFormat[0].Video.Height,1==a[1].params.table[0].Rotate90||2==a[1].params.table[0].Rotate90){var c;c=webApp.resolution.x,webApp.resolution.x=webApp.resolution.y,webApp.resolution.y=c}b()}):"h5"===webApp.playMode&&D&&D.done(function(a){webApp.resolution.x=a.width,webApp.resolution.y=a.height,b()}),a.subscribe("IVSRuleConfig",function(a,b){return"PixelCount"===b.shapeName?(B.width=b.data[1][0]-b.data[0][0],B.height=b.data[1][1]-b.data[0][1],o.$("[name=DetectSize-0]").val(B.width),void o.$("[name=DetectSize-1]").val(B.height)):"MinGatherRegion"===b.shapeName?(t.Config.MinDetectRect=b.data,void o._disabledDraw(!1)):void((void 0===t.shapeId||t.shapeId==b.shapeID)&&(t.Config.DetectRegion&&(t.Config.DetectRegion=b.data),t.Config.DetectLine&&(t.Config.DetectLine=b.data),t.shapeId=b.shapeID,v=!0,o._drawDir()))}),a.subscribe("DRectBig",function(b,c){t.Config.SizeFilter.MaxSize=a.extend(!0,[],c.data),o._changeSizeFilter(),o._disabledDraw(!1),v=!0}),a.subscribe("DRectSmall",function(b,c){t.Config.SizeFilter.MinSize=a.extend(!0,[],c.data),o._changeSizeFilter(),o._disabledDraw(!1),v=!0}),webCaps.is_show_PixelCounter&&(o.$("#f_c_detect").show(),o.$("[name=DetectSize-0]").numberfield({min:0,max:webApp.resolution.x,allowDecimal:!0,allowNegative:!1}),o.$("[name=DetectSize-1]").numberfield({min:0,max:webApp.resolution.y,allowDecimal:!0,allowNegative:!1}),plugin.addEvent("ResolutionChangeIvs",function(){o.$("[name=DetectSize-0]").numberfield({min:0,max:webApp.resolution.x,allowDecimal:!0,allowNegative:!1}),o.$("[name=DetectSize-1]").numberfield({min:0,max:webApp.resolution.y,allowDecimal:!0,allowNegative:!1}),o.$("[name=DetectSize-0]").trigger("change"),o.$("[name=DetectSize-1]").trigger("change")}))}else plugin.cover("#ivsVideo",function(){plugin.SetRegionNum(0),plugin.SetModuleMode(2),plugin.open(),g.render(o.naclHandle)});setTimeout(function(){o.onRefresh(!1),x.render()},500)},leave:function(){x.leave(),g.leave(),plugin.hide(),plugin.close(),plugin.addEvent("ResolutionChangeIvs",null),"flash"===webApp.playMode||"h5"===webApp.playMode?("h5"===webApp.playMode?k.hide():j.hide(),l.hide(),a.unsubscribe("IVSRuleConfig",null),a.unsubscribe("DRectBig",null),a.unsubscribe("DRectSmall",null),B={}):"hls"===webApp.playMode&&i.hideAndStopLoad()},destory:function(){g.leave(),E=[]},_getTemp:function(){webApp.DeviceType.indexOf("IPC")<0&&d.VideoInAnalyse.getTemplateGlobal().done(function(a){m=a}),d.VideoInAnalyse.getTemplateRule("Normal").done(function(a){n=a.Normal})},_renderElements:function(){t=null,q={},v=!0;var b=a.extend(!0,[],p[r]);y=0,a.each(b,function(a,b){"Normal"==b.Class?q[b.PtzPresetId]?q[b.PtzPresetId].push(b):q[b.PtzPresetId]=[b]:y++});var c=o.$("[sel-for= onChangePreset]");webApp.DeviceType.indexOf("IPC")<0?a.when(d.PTZ.getPresets(),d.ConfigManager.getConfig("PtzMovement")).always(function(b,d){b=b||[],b.length?(s.find(".ui-set-icon-add").removeClass("disabled"),c.empty(),a.each(b,function(a,b){c.append("<option value="+b.Index+' class="'+(1==b.Type?"fn-color-ivsGreen":"fn-color-black")+'">'+b.Name+"</option>")}),d[r]&&"Preset"==d[r].Function&&c.val(d[r].Index+1)):(c.empty(),c.append('<option value="-1" >'+tl("com.AddPresetFirstTip")+"</option>"),c.val(-1),s.find(".ui-set-icon-add").addClass("disabled")),c.change()}):c.change();var e=o._checkMaxRule();o.disabled(o.$("[data-action=titleAction]"),!e)},onChangePreset:function(b){var c=a(b.target).val()-0,e=b.target.selectedOptions[0];e&&e.hasClass("fn-color-ivsGreen")?b.target.addClass("fn-color-ivsGreen"):b.target.removeClass("fn-color-ivsGreen"),b.isTrigger||d.PTZ.gotoPreset(c),q[c]&&q[c].length?o.$("[data-emptyReules]").show():(q[c]=[],o.$("[data-emptyReules]").hide(),("flash"==webApp.playMode||"h5"===webApp.playMode)&&t&&t.shapeId&&l.ShowVideoAnalyseShape(o.containerId,t.shapeId,!1)),s.table("dataSource",q[c]).table("selectRow",0)},_changeRule:function(){o._changeRuleInfo(),o._changeOCX()},_changeOCX:function(){if(g.ocxDrawEnable(t.Enable),t.Enable)if(t.shapeId)g.showShape(t.shapeId,t.shapeId1),g.ocxAdjust(t.shapeId,t.shapeId1,!1),("flash"==webApp.playMode||"h5"===webApp.playMode)&&(l.ShowVideoAnalyseShape(o.containerId,t.shapeId),l.SelectVideoAnalyseShape(o.containerId,t.shapeId,!1));else{var a=o._getRulePos(),b=t.Config[a].toString().split(",");if(("flash"==webApp.playMode||"h5"===webApp.playMode)&&(t.shapeId=Math.max.apply(null,b)<=0?l.CreateMainVideoAnalyseShape(o.containerId,o._getShapeNameByRule(t.Type),null,{showName:t.Name}):l.CreateMainVideoAnalyseShape(o.containerId,o._getShapeNameByRule(t.Type),t.Config[a],{showName:t.Name}),o._drawDir(),l.SelectVideoAnalyseShape(o.containerId,t.shapeId,!1)),Math.max.apply(null,b)<=0)return;g.createShape(t.Type,t.Config[a],t.Name).done(function(a){t.shapeId=a,o._drawDir(),g.ocxAdjust(a,"",!1)}),"CrossFenceDetection"==t.Type&&g.createShape("CrossFenceDetectionDown",t.Config.DownstairsLine,t.Name+tl("ivs.DownstairsLine"),"CrossFenceDetectionDown").done(function(a){t.shapeId1=a,g.ocxAdjust(a,"",!1)})}else o.hideCurrentShape()},hideCurrentShape:function(){t&&(g.hideShape(t.shapeId,t.shapeId1),g.hideShape(t.sizeFilterId),g.ocxDrawEnable(!1),("flash"===webApp.playMode||"h5"===webApp.playMode)&&(l.ShowVideoAnalyseShape(o.containerId,t.shapeId,!1),l.ShowVideoAnalyseShape(o.containerId,t.sizeFilterId,!1)))},_getRulePos:function(a){switch(a=a||t.Type){case"CrossLineDetection":return"DetectLine";case"CrossFenceDetection":return"UpstairsLine";case"CrossFenceDetectionDown":return"DownstairsLine";default:return"DetectRegion"}},_changeRuleInfo:function(){o.$("[rule-for]").hide();var b=t.Type,c=t.Config;switch(o.$("[rule-for *= "+b+"]").show(),o.$("#ivs_object_filter_ck").show(),o.$("#ivs_target_label").attr("t","ivs.AimFiltrate").text(tl("ivs.AimFiltrate")),o._renderMinDuration(b),b){case"CrossLineDetection":o.$("#ivs_ruleDirection").val(c.Direction);break;case"CrossRegionDetection":o.$('[name = "ivs_crd"]').each(function(){var b=a(this).attr("data-val");a.inArray(b,c.Action)>-1?a(this).prop("checked",!0):a(this).prop("checked",!1)}),o.$("[data-val =Cross]").prop("checked")?(o.$("#ivs_ruleDirection2").val(c.Direction),o.$("#ivs_ruleDirectionWrap2").show()):o.$("#ivs_ruleDirectionWrap2").hide();break;case"CrossFenceDetection":o.$("#ivs_ruleDirection").val(c.Direction);break;case"MoveDetection":o.$('[slider="sensitivity"]').slider("value",c.Sensitivity);break;case"ParkingDetection":o.$("#ivs_minDuration").val(c.MinDuration);break;case"RioterDetection":o.$("#ivs_minDuration").val(c.MinDuration),o.$('[slider="sensitivity"]').slider("value",c.Sensitivity),o.$("#ivs_object_filter_ck").hide(),o.$("#ivs_minFilter").prop("checked",!0),o.$("#ivs_target_label").attr("t","ivs.MinGatherRegion").text(tl("ivs.MinGatherRegion"));break;case"LeftDetection":case"TakenAwayDetection":case"WanderDetection":o.$("#ivs_minDuration").val(c.MinDuration)}if(void 0!==t.TrackEnable&&o.$("#ivs_TrackEnable").prop("checked",t.TrackEnable),void 0!==c.TrackDuration&&o.$("#ivs_TrackTime").numberfield("value",c.TrackDuration.TrackDuration),C[t.Type]){var d=o.$("#ivs_alarmObject");o.$("[data-wrap=SupportedObjectTypes]").show(),d.find("input").parent().hide(),a.each(C[t.Type],function(a,b){var c=t.ObjectTypes.indexOf(b)>-1;d.find("input[value = "+b+"]").prop("checked",c).parent().show()}),o.$("#ivs_objectFilter").prop("checked",a.inArray("Unknown",t.ObjectTypes)>-1).click()}else o.$("[data-wrap=SupportedObjectTypes]").hide();o.$("#ivs_eventHandler").eventHandler("set",t.EventHandler),o._changeSizeFilter()},_changeSizeFilter:function(){var b=t.Config;o.$("input[name ^= MaxSize], input[name ^= MinSize]").each(function(){var c=a(this).attr("name").split("-");a(this).val(b.SizeFilter[c[0]][c[1]])})},_saveRuleInfo:function(b){if(t){var c=t.Type,d=t.Config;switch(c){case"CrossLineDetection":d.Direction=o.$("#ivs_ruleDirection").val();break;case"CrossRegionDetection":d.Action=[],o.$('[name = "ivs_crd"]:checked').each(function(){var b=a(this).attr("data-val");d.Action.push(b)}),d.Direction=a.inArray("Cross",d.Action)>-1?o.$("#ivs_ruleDirection2").val():"";break;case"CrossFenceDetection":d.Direction=o.$("#ivs_ruleDirection").val();break;case"MoveDetection":d.Sensitivity=o.$('[slider="sensitivity"]').slider("value");break;case"ParkingDetection":d.MinDuration=o.$("#ivs_minDuration").val()-0;break;case"RioterDetection":d.MinDuration=o.$("#ivs_minDuration").val()-0,d.Sensitivity=o.$('[slider="sensitivity"]').slider("value");break;case"LeftDetection":case"TakenAwayDetection":case"WanderDetection":d.MinDuration=o.$("#ivs_minDuration").val()-0}if(t.EventHandler=o.$("#ivs_eventHandler").eventHandler("get"),void 0!==t.TrackEnable&&(t.TrackEnable=a("#ivs_TrackEnable").prop("checked")),void 0!==d.TrackDuration&&(d.TrackDuration=o.$("#ivs_TrackTime").numberfield("value")),C[t.Type]){var e=[];o.$("#ivs_alarmObject").find("input").each(function(){a(this).prop("checked")&&e.push(a(this).val())}),!o.$("#ivs_objectFilter").prop("checked")&&jQuery.inArray("Unknown",t.ObjectTypes)>-1&&e.push("Unknown"),t.ObjectTypes=e}g.chooseShape(t.bigId,"",!1),g.chooseShape(t.smallId,"",!1),g.ocxSetShapeTip(""),b?g.ocxAdjust(t.shapeId,t.shapeId1,!1):(g.hideShape(t.shapeId,t.shapeId1),g.hideShape(t.sizeFilterId));var f=o._getRulePos(),h=t.Config[f].toString().split(",");Math.max.apply(null,h)<=0&&delete t.shapeId,v=!0}},_addRule:function(){var b=a.extend(!0,{},n[u]);b.Name=o._getUniqueName(),b.PtzPresetId=o.$("[sel-for= onChangePreset]").val()-0;var c=q[b.PtzPresetId].length;0===c&&o.$("[data-emptyReules]").show(),s.table("add",b,-1).table("selectRow",c)},_checkMaxRule:function(){var b=o.$("[sel-for= onChangePreset]").val()-0;if(q[b]&&q[b].length>=A)return!1;var c=0;return a.each(q,function(a,b){c+=b.length}),c+y>=z?!1:!0},_modifyRule:function(b,c){var d=a.extend(!0,{},n[b]);d.Name=c||o._getUniqueName(),d.PtzPresetId=o.$("[sel-for= onChangePreset]").val()-0,d.Enable=t.Enable,s.table("modify",d),o._changeRuleInfo()},_getShapeNameByRule:function(a){var b=null;switch(a){case"CrossFenceDetection":case"CrossFenceDetectionDown":case"CrossLineDetection":case"ManStandDetection":case"StereoNumberStat_dir":b="XLineShape";break;case"CrossRegionDetection":case"TakenAwayDetection":case"MoveDetection":case"WanderDetection":case"LeftDetection":case"TakenAwayDetection":case"ParkingDetection":case"VideoAbnormalDetection":case"VehicleAnalyse":case"RioterDetection":case"ManNumDetection":case"StereoNumberStat":b="Polygon";break;case"NumberStat":case"MinDetectRect":case"Stereo":b="Rect";break;case"SizeFilter":b="DRectBigSmallShape";break;case"ModuleDetectRegion":b="ModuleDetectRegion";break;case"RuleDetectRegion":b="RuleDetectRegion";break;case"CalibrateRegionIPC":b="CalibrateRegionIPC";break;default:b=a}return b},_getUniqueName:function(){var b=[],c=tl("com.Rule"),d=new RegExp("(^"+c+")(\\d*)$"),e=o._reBackConfig();a.each(e,function(a,c){var e=d.exec(c.Name);e&&b.push(e[2]-0)}),b.sort(function(a,b){return a-b});var f=b.length+1;return a.each(b,function(a,b){return b-a>1?(f=a+1,!1):void 0}),c+f},_checkUniqueName:function(b){var c=[];return a.each(q,function(b,d){a.each(d,function(a,b){c.push(b.Name)})}),!b||-1!==c.indexOf(b)},_disabledDraw:function(a){o.disabled("#ivs_maxFilter",a),o.disabled("#ivs_minFilter",a)},_renderMinDuration:function(a){var b=w[a]||[1,600];o.$("#ivs_minDuration").numberfield("max",b[1]).numberfield("min",b[0]),o.$("#ivs_minDurationTip").text("("+b[0]+"~"+b[1]+")")},onSetPeriod:function(){plugin.hide(),h.open(t.EventHandler.TimeSection).done(function(a){t.EventHandler.TimeSection=a}).always(function(){plugin.cover("#ivsVideo")})},onDrawRule:function(){var a=o.$("#ivs_ruleManager .current input");if(a[0]&&!a[0].checked)return void o.$("#ivs_tip").tip("warning",tl("com.RuleIsntEnableTip"),3e3,1);if(!v)return o.$("#ivs_tip").tip("warning",tl("com.PleaseDrawShapeTip")),!1;g.hideShape(t.sizeFilterId);var b=t.Config[o._getRulePos()]||[[0,0],[0,0]],c=Math.max.apply(null,b.toString().split(","));t.shapeId&&c?(g.showShape(t.shapeId,t.shapeId1),g.chooseShape(t.shapeId,t.shapeId1),("flash"==webApp.playMode||"h5"===webApp.playMode)&&(l.ShowVideoAnalyseShape(o.containerId,t.shapeId),l.SelectVideoAnalyseShape(o.containerId,t.shapeId))):t.shapeId||c?!t.shapeId&&c?("flash"==webApp.playMode||"h5"===webApp.playMode)&&(t.shapeId=l.CreateMainVideoAnalyseShape(o.containerId,o._getShapeNameByRule(t.Type),b,{showName:t.Name})):t.shapeId&&!c&&(("flash"==webApp.playMode||"h5"===webApp.playMode)&&l.RedrawVideoAnalyseShape(o.containerId,t.shapeId),v=!1):(g.createShape(t.Type,"",t.Name),("flash"==webApp.playMode||"h5"===webApp.playMode)&&(t.shapeId=l.CreateMainVideoAnalyseShape(o.containerId,o._getShapeNameByRule(t.Type),null,{showName:t.Name})),v=!1)},onClearRule:function(){if(t.Enable){if(!v)return o.$("#ivs_tip").tip("error",tl("com.PleaseDrawShapeTip")),!1;if(g.hideShape(t.sizeFilterId),t.shapeId){if(v=!1,"flash"===webApp.playMode||"h5"===webApp.playMode){l.RedrawVideoAnalyseShape(o.containerId,t.shapeId);var a=o._getRulePos();"DetectLine"==a?t.Config[a]=[[0,0],[0,0]]:"DetectRegion"==a?t.Config[a]=[[0,0],[0,0],[0,0],[0,0]]:"UpstairsLine"==a&&(t.Config.UpstairsLine=[[0,0],[0,0]],t.Config.DownstairsLine=[[0,0],[0,0]])}g.reDrawShape(t.shapeId,t.shapeId1).done(function(){var a=o._getRulePos();"DetectLine"==a?t.Config[a]=[[0,0],[0,0]]:"DetectRegion"==a?t.Config[a]=[[0,0],[0,0],[0,0],[0,0]]:"UpstairsLine"==a&&(t.Config.UpstairsLine=[[0,0],[0,0]],t.Config.DownstairsLine=[[0,0],[0,0]])})}else g.createShape(t.Type,"",t.Name)}},onDrawTarget:function(){if(!t.Enable)return void o.$("#ivs_tip").tip("warning",tl("com.RuleIsntEnableTip"));if(!v)return o.$("#ivs_tip").tip("warning",tl("com.PleaseDrawShapeTip")),!1;if(g.hideShape(t.shapeId,t.shapeId1),"flash"!==webApp.playMode&&"h5"!==webApp.playMode||!t.shapeId||l.ShowVideoAnalyseShape(o.containerId,t.shapeId,!1),t.sizeFilterId)g.showShape(t.sizeFilterId),("flash"===webApp.playMode||"h5"===webApp.playMode)&&l.ShowVideoAnalyseShape(o.containerId,t.sizeFilterId),t.smallId||(o._disabledDraw(!0),g.createSubShape(t.sizeFilterId,"DRectSmall"),"flash"!==webApp.playMode&&"h5"!==webApp.playMode||"RioterDetection"===t.Type||(t.smallId=l.AddVideoAnalyseShape(o.containerId,t.sizeFilterId,"DRectSmall")));else{if("flash"===webApp.playMode||"h5"===webApp.playMode)if("RioterDetection"!==t.Type){t.sizeFilterId=l.CreateMainVideoAnalyseShape(o.containerId,o._getShapeNameByRule("SizeFilter")),t.bigId=l.AddVideoAnalyseShape(o.containerId,t.sizeFilterId,"DRectBig",t.Config.SizeFilter.MaxSize);var a=t.Config.SizeFilter.MinSize,b=a.toString().split(",");Math.max.apply(null,b)>0?t.smallId=l.AddVideoAnalyseShape(o.containerId,t.sizeFilterId,"DRectSmall",a):o.$("#ivs_minFilter").prop("checked")&&(t.smallId=l.AddVideoAnalyseShape(o.containerId,t.sizeFilterId,"DRectSmall"),o._disabledDraw(!0))}else t.sizeFilterId=l.CreateMainVideoAnalyseShape(o.containerId,"MinGatherRegion",t.Config.MinDetectRect);g.createShape("SizeFilter","","","SizeFilter").done(function(a){t.sizeFilterId=a,g.createSubShape(a,"DRectBig",t.Config.SizeFilter.MaxSize).done(function(a){t.bigId=a,g.ocxSetColor(a,"lightblue"),"RioterDetection"==t.Type&&g.hideShape(t.bigId)});var b=t.Config.SizeFilter.MinSize;"RioterDetection"==t.Type&&(b=g.filterDataChangeFrom(t.Config.MinDetectRect));var c=b.toString().split(",");Math.max.apply(null,c)>0?g.createSubShape(a,"DRectSmall",b).done(function(a){t.smallId=a,g.ocxSetColor(a,"lightblue")}):o.$("#ivs_minFilter").prop("checked")&&g.createSubShape(t.sizeFilterId,"DRectSmall").done(function(a){o._disabledDraw(!0),g.ocxSetColor(a,"lightblue")})})}o.$("#ivs_maxFilter").prop("checked")?(("flash"===webApp.playMode||"h5"===webApp.playMode)&&(l.SelectFilterShape(o.containerId,t.sizeFilterId,t.bigId,!0),l.SelectFilterShape(o.containerId,t.sizeFilterId,t.smallId,!1)),g.chooseShape(t.bigId,"",!0),g.chooseShape(t.smallId,"",!1)):(("flash"===webApp.playMode||"h5"===webApp.playMode)&&("RioterDetection"!==t.Type?(l.SelectFilterShape(o.containerId,t.sizeFilterId,t.bigId,!1),l.SelectFilterShape(o.containerId,t.sizeFilterId,t.smallId,!0)):l.SelectVideoAnalyseShape(o.containerId,t.sizeFilterId)),g.chooseShape(t.bigId,"",!1),g.chooseShape(t.smallId,"",!0))},onClearTarget:function(){t.Enable&&(o.onDrawTarget(),setTimeout(function(){return o._disabledDraw(!0),"RioterDetection"===t.Type&&t.sizeFilterId?void l.RedrawVideoAnalyseShape(o.containerId,t.sizeFilterId):void(o.$("#ivs_maxFilter").prop("checked")?(g.reDrawShape(t.bigId),("flash"===webApp.playMode||"h5"===webApp.playMode)&&l.RedrawVideoAnalyseShape(o.containerId,t.sizeFilterId,t.bigId),o.$('[name="MaxSize-0"]').val(0),o.$('[name="MaxSize-1"]').val(0),t.Config.SizeFilter.MaxSize[0]=0,t.Config.SizeFilter.MaxSize[1]=0,v=!1):(o.$('[name="MinSize-0"]').val(0),o.$('[name="MinSize-1"]').val(0),t.Config.SizeFilter.MinSize[0]=0,t.Config.SizeFilter.MinSize[1]=0,v=!1,t.smallId?(g.reDrawShape(t.smallId),("flash"===webApp.playMode||"h5"===webApp.playMode)&&l.RedrawVideoAnalyseShape(o.containerId,t.sizeFilterId,t.smallId)):(g.createSubShape(t.sizeFilterId,"DRectSmall"),("flash"===webApp.playMode||"h5"===webApp.playMode)&&l.AddVideoAnalyseShape(o.containerId,t.sizeFilterId,"DRectSmall"))))},100))},onChkCross:function(b){var c,d=-1;if(a(b.target).prop("checked")?(o.$("#ivs_ruleDirectionWrap2").show(),c=o.$("#ivs_ruleDirection2").val()):(o.$("#ivs_ruleDirectionWrap2").hide(),c="None"),t.shapeId&&(g.ocxDirection(t.shapeId,c),"flash"===webApp.playMode||"h5"===webApp.playMode)){switch(c){case"LeftToRight":case"Enter":d=0;break;case"RightToLeft":case"Leave":d=1;break;case"Both":d=2}l.SetVideoAnalyseShapeDirection(o.containerId,t.shapeId,d)}},onChangeDir:function(b){var c=a(b.target).val(),d=-1;if(t.shapeId&&(g.ocxDirection(t.shapeId,c),"flash"===webApp.playMode||"h5"===webApp.playMode)){switch(c){case"LeftToRight":case"Enter":d=0;break;case"RightToLeft":case"Leave":d=1;break;case"Both":d=2}l.SetVideoAnalyseShapeDirection(o.containerId,t.shapeId,d)}},onDrawDetect:function(){var a=o.$("[name=DetectSize-0]").numberfield("value"),b=o.$("[name=DetectSize-1]").numberfield("value"),c={PixelCount:[[0,0],[a,b]],Name:"rect1"};return o.$("#ivs_maxFilter").prop("disabled")?void o.$("#ivs_tip").tip("error",tl("com.PleaseDrawShapeTip")):void(a*b?"flash"===webApp.playMode||"h5"===webApp.playMode?(B.ShapeId?l.SetVideoAnalyseShapeConfig(o.containerId,B.ShapeId,[[(webApp.resolution.x-a)/2,(webApp.resolution.y-b)/2],[(webApp.resolution.x+a)/2,(webApp.resolution.y+b)/2]]):B.ShapeId=l.CreateMainVideoAnalyseShape(o.containerId,"PixelCount",[[(webApp.resolution.x-a)/2,(webApp.resolution.y-b)/2],[(webApp.resolution.x+a)/2,(webApp.resolution.y+b)/2]]),l.SelectVideoAnalyseShape(o.containerId,B.ShapeId)):plugin.SetObjectConfig(JSON.stringify(c)):"flash"===webApp.playMode||"h5"===webApp.playMode?B.ShapeId=l.CreateMainVideoAnalyseShape(o.containerId,"PixelCount"):plugin.AddShape(6,"PixelCount","rect1",-1,0))},naclHandle:function(a,b,c){var d;if("createDone"==a||"dragDone"==a){t.shapeId||(t.shapeId=b.ShapeID);var e="";"CrossFenceDetectionDown"==c&&(e="CrossFenceDetectionDown",t.shapeId1&&(t.shapeId1=b.ShapeID)),d=o._getRulePos(e);{g.getData(b.ShapeID).done(function(a){t.Config[d]=a,v=!0})}}if("createDone"==a&&(o._drawDir(),"UpstairsLine"===d&&g.createShape("CrossFenceDetectionDown","",t.Name+tl("ivs.DownstairsLine"),"CrossFenceDetectionDown")),"filterMoving"==a){var f=b.ShapeName;if("DRectSmall"==f)"RioterDetection"==t.Type?g.getData(b.ShapeID).done(function(a){t.smallId=b.ShapeID,t.Config.MinDetectRect=a,v=!0}):g.getData(b.ShapeID,!0).done(function(a){t.smallId=b.ShapeID,t.Config.SizeFilter.MinSize=a,o._changeSizeFilter()}),o._disabledDraw(!1);else if("DRectBig"==f)g.getData(b.ShapeID,!0).done(function(a){t.Config.SizeFilter.MaxSize=a,v=!0,o._changeSizeFilter()});else if(b.SelShape){var h=b.SelShape.ShapeName;"DRectSmall"===h?o.$("#ivs_minFilter").prop("checked",!0):"DRectBig"===h&&o.$("#ivs_maxFilter").prop("checked",!0)}o._disabledDraw(!1)}},_drawDir:function(){var a,b=-1;switch(t.Type){case"CrossLineDetection":case"CrossFenceDetection":a=o.$("#ivs_ruleDirection").val();break;case"CrossRegionDetection":a=o.$("[data-val=Cross]").prop("checked")?o.$("#ivs_ruleDirection2").val():"None"}if(g.ocxDirection(t.shapeId,a),"flash"===webApp.playMode||"h5"===webApp.playMode){switch(a){case"LeftToRight":case"Enter":b=0;break;case"RightToLeft":case"Leave":b=1;break;case"Both":b=2}l.SetVideoAnalyseShapeDirection(o.containerId,t.shapeId,b)}},onChangeFilter:function(b){var c=a(b.target).prop("checked");c?(t.ObjectTypes=a.grep(t.ObjectTypes,function(a){return"Unknown"!==a}),0===t.ObjectTypes.length&&o.$("#ivs_tip").tip("warning",tl("ivs.AlarmChoose"))):t.ObjectTypes.push("Unknown"),o.$("#ivs_alarmObject").toggleClass("fn-hide",!c)},onChangeFilterItem:function(b){-1===a.inArray("Unknown",t.ObjectTypes)&&0===o.$("[name = filterItem]:checked").length&&(a(b.target).prop("checked",!0),o.$("#ivs_tip").tip("warning",tl("ivs.AlarmChoose")))},_reBackConfig:function(){var b=a.grep(p[r],function(a){return"Normal"!=a.Class}),c=a.extend(!0,{},q);return a.each(c,function(c,d){a.each(d,function(a,c){delete c.__id,delete c._index,delete c.shapeId,delete c.shapeId1,delete c.sizeFilterId,delete c.smallId,delete c.bigId,b.push(c)})}),b},_checkGlobal:function(){return a.Deferred(function(b){webApp.DeviceType.indexOf("IPC")>-1?b.resolve():d.ConfigManager.getConfig("VideoAnalyseGlobal").done(function(c){var e=c;null==e[r]&&(e[r]={});var f=[],g=[];for(var h in e[r])-1!==h.indexOf("Scene")&&(f.push(e[r][h].PtzPresetId),g.push(h));var i=f.length;a.each(q,function(b){q[b].length>0&&a.inArray(b-0,f)<0&&(e[r]["Scene"+i]=a.extend(!0,{},m.Scene),e[r]["CalibrateArea"+i]=m.CalibrateArea?a.extend(!0,{},m.CalibrateArea):null,e[r]["Scene"+i].PtzPresetId=b-0,e[r]["Scene"+i].Type="Normal")}),d.ConfigManager.setConfig("VideoAnalyseGlobal",e).done(function(){b.resolve()}).fail(function(){b.reject("setGlobalFailed")})}).fail(function(){b.reject("getGlobalFailed")})})},onConfirm:function(){o._saveRuleInfo(!0);var b=!1,c=!1;if(a.each(q,function(d,e){a.each(e,function(a,d){var e=o._getRulePos(d.Type),f=d.Config[e],g=d.Config.SizeFilter.MaxSize;return!d.Enable||f&&!global.isZeroArray(f)?!g||global.isZeroArray(g)?(c=!0,!1):void 0:(b=!0,!1)})}),c||b)return o.$("#ivs_tip").tip("warning",tl("com.PleaseDrawShapeTip")),!1;if(s.find(".u-table-editCell").length)return setTimeout(function(){o.onConfirm()},1e3);p[r]=o._reBackConfig();var e=o.areRuleNamesDuplicate(p[r]);if(e)return!1;var f=!0;if(a.each(p[r],function(a,b){return C[b.Type]&&0===b.ObjectTypes.length?(o.$("#ivs_tip").tip("warning",tl("ivs.AlarmChoose")),f=!1,!1):void 0}),!f)return!1;var g=o._checkGlobal();g.always(function(){B.ShapeId&&l.ShowVideoAnalyseShape(o.containerId,B.ShapeId,!1),d.ConfigManager.setConfig("VideoAnalyseRule",p).done(function(){o.$("#ivs_tip").tip("success",tl("com.SaveSuccessTip"))}).fail(function(){o.$("#ivs_tip").tip("error",tl("com.SaveConfigFailTip"))})})},onDefault:function(){g.shapeDeleteAll(),("flash"===webApp.playMode||"h5"===webApp.playMode)&&(l.DeleteAllVideoAnalyseShape(o.containerId),B={}),d.ConfigManager.getDefault("VideoAnalyseRule").done(function(b){var c=["HeatMap","NumberStat","FaceDetection"],d=a.extend(!0,{},p);B.ShapeId&&l.ShowVideoAnalyseShape(o.containerId,B.ShapeId,!1),p=b,p[r]=a.grep(p[r],function(a){return-1===c.indexOf(a.Class)}),a.each(d[r],function(a,b){-1!==c.indexOf(b.Class)&&p[r].push(b)}),o._renderElements(),o.$("#ivs_tip").tip("success",tl("com.DefaultSuccessTip"))}).fail(function(){o.$("#ivs_tip").tip("error",tl("com.DefaultfailureTip"))})},onRefresh:function(a){a!==!1&&(g.shapeDeleteAll(),("flash"===webApp.playMode||"h5"===webApp.playMode)&&(l.DeleteAllVideoAnalyseShape(o.containerId),B={})),d.ConfigManager.getConfig("VideoAnalyseRule").done(function(b){p=b,g.ocxSetShapeTip(""),D?D.done(function(){o._renderElements()}):o._renderElements(),o._disabledDraw(!1),a!==!1&&o.$("#ivs_tip").tip("success",tl("com.OperateSuccessTip"))}).fail(function(){o.$("#ivs_tip").tip("error",tl("com.OperateFailTip"))})},areRuleNamesDuplicate:function(a){return a.some(function(b,c){return a.some(function(a,d){if(c!==d&&b.Name===a.Name){var e="",f=o.ruleType2Str(b.Type),g=o.ruleType2Str(a.Type);return c>d&&(e=f,f=g,g=e),o.$("#ivs_tip").tip("error",""+tl(f)+tl("com.And")+tl(g)+tl("com.GroupNameSameTip")),!0
}return!1})})},ruleType2Str:function(a){switch(a){case"StereoNumberStat":a="NumberStat";break;case"StereoStayDetection":a="StereoManStayDetection";break;case"StereoManNumDetection":a="StereoAbnormalCountDetection";break;case"StereoDistanceDetection":a="StereoApproachDetection";break;case"HumanTrait":a="com.People";break;case"NonMotorDetect":a="ivs.NoMotorVehicle";break;case"VehicleDetect":a="ivs.MotorVehicle"}return a}})}),define("ivs_global",function(require,b,c){var d=require("jsCore/rpc"),e=require("jsCore/pageBase"),f=require("jsCore/modules/naclDraw"),g=require("jsCore/plugin"),h=require("jsCore/hlsplayer"),i=require("jsCore/flashplayer"),j=require("jsCore/h5player"),k=require("jsCore/pluginCanvas");require("jsCore/modules/minPtzControl");var l,m,n=null,o=null,p=null,q=null,r=null,s=null,t=null,u=[],v=1,w=null,x=null,y=null,z=null,A=[],B=[],C={},D={shapeId:[],Region:[]},E=0,F=0,G=0,H=null,I={Vertical:"ivs.Vertical",Horizontal:"ivs.Horizontal"};require("widget/js/dui.slider"),c.exports=e.extend({init:function(){z=this,z.getTemplate(),ability.get("IVSCaps").done(function(a){var b=a.SupportedScenes.Normal.SupportedModuleParams;b.Shadow===!1&&z.$('div[data-cap="Shadow"]').hide(),0==b.AntiDisturbance&&z.$('div[data-cap="AntiDisturbance"]').hide()}),z.$("#ivs_global_presets").change(function(){var a=this.value-0,b=this.selectedOptions[0];b&&b.hasClass("fn-color-ivsGreen")?this.addClass("fn-color-ivsGreen"):this.removeClass("fn-color-ivsGreen"),d.PTZ.gotoPreset(a).always(function(){z._renderGlobalElements()})}),-1===webApp.DeviceType.indexOf("SD")&&z.$("[data-show=SD]").remove(),z.$("#scaleLength").on("change",function(){var b=z.$(this).val()-0,c=this;if(isNaN(b)?(z.$(this).val(v),b=v):.05>=b?(b=1,z.$(this).val(b)):b>10&&(b=10,z.$(this).val(b)),b+""!=z.$(this).val()){var d=this.attr("maxlength");z.$(this).val(d?(b+"").substr(0,d-0):b)}var e=z.$("input:radio[name=scaleLine]:checked").val();a.each(p.Staffs,function(a,b){b.Type==e&&(b.Length=z.$(c).val()-0)})}).on("keyup",function(){var a=z.$(this).val();/[^\d\.]/g.test(a)&&z.$(this).val(a.replace(/[^\d\.]/g,""))}),z.$("#ivs_scaleContent").on("click","[data-toggle]",function(){var a,b,c=z.$(this).attr("data-toggle"),d=z.$(this).parent().next("span");"fold"==c?(a="visible",b="scale_icon_hide",c="unfold"):(a="hidden",b="scale_icon_show",c="fold"),d.css("visibility",a),z.$("#ivs_ScaleIcon").attr("class",b),z.$(this).attr("data-toggle",c)}),z.$("#ivs_scaleContent").on("click","a",function(){var b=z.$(this).attr("data-type"),c=null,d=parseInt(z.$(this).attr("data-staffIndex"),10),e=parseInt(z.$(this).attr("scale-index"),10);z.$("#ivs_scaleContent").find("a").removeClass("scale_current"),z.$(this).addClass("scale_current"),a.each(B,function(a,b){f.showOrHideScale(b,!1)}),a.each(q.Area,function(a,b){("flash"===webApp.playMode||"h5"===webApp.playMode)&&k.ShowVideoAnalyseShape(z.containerId,b),f.showOrHideScale(b,!0),f.selectShape(b,!1)}),q&&a.each(q.Staffs,function(a,b){f.showOrHideScale(b,!0),f.selectShape(b,!1)}),"Horizontal"==b||"Vertical"==b?(f.selectShape(q.Staffs[d],!0),c=z.getStaff(b,e),z.$("#ivs_global_staffType").find("input[value="+b+"]").prop("checked",!0),c&&z.$("#scaleLength").prop("disabled",!1).val(c.Length)):"CalibrateArea"===b&&f.selectShape(q.Area[0],!0)}),z.$("i[data-link]").on("click",function(a){var b=a.currentTarget.attributes["data-link"].value;z.$("#"+b+" .ui-form-item").toggleClass("fn-hide"),z.slide=new Fx.Slide(b),z.slide.toggle(),this.toggleClass("toggle")}),z.$("#Global_IVSForm .ui-form-item").addClass("fn-hide"),new Fx.Slide("Global_IVSForm").hide(),z.sliderInit(),z.ocxMode="ParaOrGlobal",z._initPtz(),z.render()},render:function(){if("hls"==webApp.playMode)h.cover(a("#ivs_global_video")),g.hide(),h.init("","",""),h.beginPlay();else if("flash"==webApp.playMode||"h5"===webApp.playMode){"flash"===webApp.playMode&&(i.cover("#ivs_global_video"),i.playPreview(1,0)),j&&"h5"===webApp.playMode&&(H=a.Deferred(),j.playPreview(1,0,a("#ivs_global_video"),null,H));var b=function(){k.cover("#ivs_global_video",webApp.resolution.x+"*"+webApp.resolution.y),z.containerId=k.CreateVideoAnalyseContainer();var b=z.$("#ivs_global_presets");webApp.DeviceType.indexOf("IPC")<0?a.when(d.PTZ.getPresets(),d.ConfigManager.getConfig("PtzMovement")).always(function(c,d){c=c||[],c.length?(b.empty(),a.each(c,function(a,c){b.append("<option value="+c.Index+' class="'+(1==c.Type?"fn-color-ivsGreen":"fn-color-black")+'">'+c.Name+"</option>")}),d[F]&&"Preset"==d[F].Function&&b.val(d[F].Index+1)):(b.empty(),b.append('<option value="-1" >'+tl("com.AddPresetFirstTip")+"</option>"),b.val(-1)),b.change()}):(z.$(".sd-line").hide(),z.$("#ivs_global_presets_wrap").hide(),b.empty(),b.change())};"flash"==webApp.playMode?d.ConfigManager.getConfig(["Encode","VideoImageControl"]).done(function(a){if(webApp.resolution.x=a[0].params.table[0].MainFormat[0].Video.Width,webApp.resolution.y=a[0].params.table[0].MainFormat[0].Video.Height,1==a[1].params.table[0].Rotate90||2==a[1].params.table[0].Rotate90){var c;c=webApp.resolution.x,webApp.resolution.x=webApp.resolution.y,webApp.resolution.y=c}b()}):"h5"===webApp.playMode&&H&&H.done(function(a){webApp.resolution.x=a.width,webApp.resolution.y=a.height,b()}),a.subscribe("IVSRuleConfig",function(a,b){var c;switch(-1!==["CalibrateRegionIPC","VerticalLine","HorizontalLine"].indexOf(b.shapeName)&&(z.enableStaffOperation(),p||(q={Area:[],Staffs:[]},p={Area:[],Staffs:[],Type:"Groud"})),b.shapeName){case"CalibrateRegionIPC":q.Area.length>0?p.Area=b.data:(p.Area=b.data,p.Staffs=[],q.Area[0]=b.shapeID);break;case"VerticalLine":if(q.Staffs.indexOf(b.shapeID)>-1)c=q.Staffs.indexOf(b.shapeID),p.Staffs[c].Start=b.data[0],p.Staffs[c].End=b.data[1],z.$("#ivs_scaleContent").find("[data-staffindex="+c+"]").trigger("click");else{if(4===q.Staffs.length){A[0]=b.data,B[0]=b.shapeID,d.DevVideoAnalyse.testCalibrateWithScreenPoints("Vertical",b.data[0],b.data[1]).done(function(a){k.SetTip(z.containerId,b.shapeID,a.toFixed(2))});break}p.Staffs.push({End:b.data[1],Length:z.$("#scaleLength").val()-0,Start:b.data[0],Type:"Vertical"}),q.Staffs.push(b.shapeID)}break;case"HorizontalLine":if(q.Staffs.indexOf(b.shapeID)>-1)c=q.Staffs.indexOf(b.shapeID),p.Staffs[c].Start=b.data[0],p.Staffs[c].End=b.data[1],z.$("#ivs_scaleContent").find("[data-staffindex="+c+"]").trigger("click");else{if(4===q.Staffs.length){A[1]=b.data,B[1]=b.shapeID,d.DevVideoAnalyse.testCalibrateWithScreenPoints("Horizontal",b.data[0],b.data[1]).done(function(a){k.SetTip(z.containerId,b.shapeID,a.toFixed(2))});break}p.Staffs.push({End:b.data[1],Length:z.$("#scaleLength").val()-0,Start:b.data[0],Type:"Horizontal"}),q.Staffs.push(b.shapeID)}break;case"DetectRegion":C.Region=b.data;break;case"ExcludeRegion":c=D.shapeId.indexOf(b.shapeID),c>-1?D.Region[c]=b.data:(D.Region.push(b.data),D.shapeId.push(b.shapeID))}})}else g.cover("#ivs_global_video",function(){g.SetRegionNum(0),g.SetModuleMode(2),g.open(),f.render(z.naclHandle)});d.ConfigManager.getConfig(["VideoAnalyseGlobal","VideoAnalyseModule"]).done(function(a){n=a[0].params.table,a[1].result&&(w=a[1].params.table),o=n,z._renderGlobalElements(0)}),ability.get("IVSCaps").done(function(a){a&&g.SetMaxPntNum(a.MaxPointOfLine,a.MaxPointOfRegion)})},onDefault:function(){var a=isNaN(z.$("#ivs_global_presets").val())?0:z.$("#ivs_global_presets").val()-0;for(var b in n[0])if(-1!==b.indexOf("Scene")&&n[0][b].PtzPresetId==a){var c=b.replace("Scene","CalibrateArea");n[0][c]=null,n[0][b].Detail.Track=jQuery.extend(!0,{},y.Scene.Detail.Track);break}for(var d=0;d<w[0].length;d++)if(w[0][d].PtzPresetId==a&&"Normal"==w[0][d].Type){for(var e in x)"PtzPresetId"!==e&&"Type"!==e&&(w[0][d][e]=x[e]);break}z.$("#ivs_global_remark").tip("success",tl("com.DefaultSuccessTip")),z._renderGlobalElements(0)},onRefresh:function(a){d.ConfigManager.getConfig(["VideoAnalyseGlobal","VideoAnalyseModule"]).done(function(b){common.chkMutilCallRet(b,!0)?(n=b[0].params.table,o=n,b[1].result&&(w=b[1].params.table),d.PTZ.gotoPreset(z.$("#ivs_global_presets").val()-0).always(function(){z._renderGlobalElements(0)}),a!==!1&&z.$("#ivs_global_remark").tip("success",tl("com.OperateSuccessTip"))):z.$("#ivs_global_remark").tip("error",tl("com.OperateFailTip"))})},onConfirm:function(){var a=z._findCalibrateKey();n[0][a]=[p];var b=p&&p.Area&&p.Staffs&&4==p.Staffs.length;if(!b&&p)return void z.$("#ivs_global_remark").tip("error",tl("com.ScaleAll"));if("visible"==z.$("#ivs_ScaleAreaShow").css("visibility")&&z.$("#ivs_ScaleListShow span").length<4)return void z.$("#ivs_global_remark").tip("error",tl("com.AreaDrawTip"));z._saveGlobalScale();var c=z.$("#ivs_global_presets").val()-0;z._saveIVS(c);var e=["VideoAnalyseGlobal","VideoAnalyseModule"],f=[n,w];d.ConfigManager.setConfig(e,f).done(function(a){common.chkMutilCallRet(a)?(o=n,z.$("#ivs_global_remark").tip("success",tl("com.SaveSuccessTip"),3e3,0),webApp.isNeedReboot(a)&&webApp.reboot("com.ConfEffectRestartTip")):z.$("#ivs_global_remark").tip("error",tl("com.IvsGlobalSaveTip"))})},leave:function(){f.leave(),g.hide(),g.close(),"hls"===webApp.playMode?h.hideAndStopLoad():"flash"===webApp.playMode?(i.hide(),k.hide()):"h5"===webApp.playMode&&(j.hide(),k.hide())},destory:function(){f.leave()},AddScaleArea:function(){-1!==z.$("#ivs_global_presets").val()&&("hidden"===z.$("#ivs_ScaleAreaShow").css("visibility")?(z.$("#ivs_ScaleAreaShow").css("visibility","visible"),z.SetCalibrateAndRules("CalibrateArea",0,!0)):z.$("#ivs_global_remark").tip("error",tl("com.AreaErrorTip")))},DeleteScaleArea:function(){if(z.$("#ivs_ScaleAreaCheck").hasClass("scale_current")){z.$("#ivs_ScaleAreaShow").css("visibility","hidden"),z.$("#ivs_ScaleAreaCheck").removeClass("scale_current"),z.SetCalibrateAndRules("CalibrateArea",0,!1),p=null;var a=z._findCalibrateKey();n[0][a]=p,o=n,z.$("#ivs_ScaleListShow").empty(),u.length=0,z.disableStaffOperation()}},AddScale:function(){if(!z.$(this).hasClass("ui-button-disabled")){if("hidden"==z.$("#ivs_ScaleAreaShow").css("visibility")||!p)return void z.$("#ivs_global_remark").tip("warning",tl("com.AreaDrawTip"));if(-1!==u.indexOf("Horizontal")&&!z.$("#scaleVertical").prop("checked"))return void z.$("#ivs_global_remark").tip("error",tl("com.HorizontalErrorTip"));if(3==u.length&&-1===u.indexOf("Horizontal")&&z.$("#scaleVertical").prop("checked")||4==u.length)return void z.$("#ivs_global_remark").tip("error",tl("com.VerticalErrorTip"));if(p&&!p.Staffs&&u.length||p&&p.Staffs&&u.length!=p.Staffs.length)return void z.$("#ivs_global_remark").tip("error",tl("com.PleaseDrawShapeTip"));var b=z.$("#scaleVertical").prop("checked")?"Vertical":"Horizontal",c=0;a.each(u,function(a,d){d==b&&c++}),u.push(b),z.SetCalibrateAndRules(b,0,!0),z.$("#ivs_ScaleListShow").find("i.scale_bottom_icon").attr("class","scale_main_icon"),z.$("#ivs_scaleContent").find("a").removeClass("scale_current");var d=a("<span name="+b+"></span>");d.html('<div class="fn-clear scale-region"><i class="scale_bottom_icon"></i><a href="javascript:;" class="scale_current" data-staffIndex="'+(u.length-1)+'" scale-index="'+c+'" data-type="'+b+'">'+tl(I[b])+"</a></div>"),z.$("#ivs_ScaleListShow").append(d),"Vertical"===b?z._createSub("VerticalLine",""):z._createSub("HorizontalLine","")}},DeleteScale:function(){if(!z.$(this).hasClass("ui-button-disabled")){var b=z.$("#ivs_scaleContent").find("#ivs_ScaleListShow").find("a.scale_current");if(0===b.length)return void z.$("#ivs_global_remark").tip("warning",tl("com.PleaseSelectStaff"));var c=b.attr("data-type"),d=(parseInt(b.attr("scale-index"),10),parseInt(b.attr("data-staffIndex"),10));b.parent("div").parent("span").remove(),u.splice(d,1),p.Staffs.splice(d,1),z.SetCalibrateAndRules(c,d,!1);var e=z.$("#ivs_ScaleListShow").find("a"),f=0;a.each(u,function(b,c){var d=0;"Vertical"==c&&(d=f++),a(e[b]).attr("scale-index",d),a(e[b]).attr("data-staffIndex",b)}),z.$("#ivs_ScaleListShow").children().last()&&z.$("#ivs_ScaleListShow").children().last().find("i").attr("class","scale_bottom_icon")}},addDetectRegion:function(){if("flash"===webApp.playMode||"h5"===webApp.playMode){k.DeleteVideoAnalyseShape(z.containerId,C.shapeId),C.shapeId=k.CreateMainVideoAnalyseShape(z.containerId,"DetectRegion");for(var a=0;a<D.shapeId.length;a++)k.DeleteVideoAnalyseShape(z.containerId,D.shapeId[a]);D={shapeId:[],Region:[]}}else detectIds&&f.shapeDelete(m),q&&q.Area.each(function(a){f.showOrHideScale(a,!1)}),q&&q.Staffs.each(function(a){f.showOrHideScale(a,!1)}),f.createShape("ModuleDetectRegion","").done(function(a){m=a,z._createDetectSub("Polygon",""),f.ocxSetColor(a,"yellow",!0)})},addExcludeRegion:function(){if("flash"===webApp.playMode||"h5"===webApp.playMode){if(C.shapeId)k.ShowVideoAnalyseShape(z.containerId,C.shapeId,!0);else{C.shapeId=k.CreateMainVideoAnalyseShape(z.containerId,"DetectRegion",C.Region);for(var a=0;a<D.Region.length;a++)D.shapeId[a]=k.AddVideoAnalyseShape(z.containerId,C.shapeId,"ExcludeRegion",D.Region[a])}D.shapeId.push(k.AddVideoAnalyseShape(z.containerId,C.shapeId,"ExcludeRegion"))}else"para"!==z.ocxMode&&(z.ocxMode="para"),detectIds&&(detectIds.each(function(a){f.showOrHideScale(a,!0)}),q&&q.Area.each(function(a){f.showOrHideScale(a,!1)}),q&&q.Staffs.each(function(a){f.showOrHideScale(a,!1)})),detectIds.each(function(a){f.showOrHideScale(a,!0)}),q&&q.Area.each(function(a){f.showOrHideScale(a,!1)}),q&&q.Staffs.each(function(a){f.showOrHideScale(a,!1)}),z._createDetectSub("RuleOut","")},ScaleCheck:function(){return p&&p.Area&&p.Staffs&&4==p.Staffs.length?(z.$("#ivs_ScaleListShow a").removeClass("scale_current"),scaleCheckNum=z.$("#ivs_scaleValue").val()-0,q.Staffs.each(function(a){f.showOrHideScale(a,!1)}),B.each(function(a){f.showOrHideScale(a,!1)}),E&&f.shapeDelete(E),void(scaleCheckNum?z._createSub("VerticalLine","",!0):z._createSub("HorizontalLine","",!0))):void z.$("#ivs_global_remark").tip("error",tl("com.ScaleAll"))},getPresets:function(a){d.PTZ.getPresets().done(function(b){var c=b||[],e="";if(z.$("#ivs_global_presets").empty(),0===c.length)e+='<option t="com.AddPresetFirstTip"></option>',z.$("#ivs_global_presets").html(e).translation(),a&&a();else{for(var f=0;f<c.length;f++)e+=1===c[f].Type?'<option class="fn-color-ivsGreen" value = "'+c[f].Index+'" title="'+c[f].Name+'">'+c[f].Name+"</option>":'<option class="fn-color-black" value = "'+c[f].Index+'" title="'+c[f].Name+'">'+c[f].Name+"</option>";z.$("#ivs_global_presets").html(e).trigger("change"),d.ConfigManager.getConfig("PtzMovement").done(function(a){"Preset"==a[0].Function&&z.$("#ivs_global_presets").val(a[0].Index+1),z.$("#ivs_global_presets").selectedIndex<0&&(z.$("#ivs_global_presets").selectedIndex=0)}).always(function(){a&&a()})}}).fail(function(){z.$(".sd-line").addClass("fn-hide"),z.$("#ivs_global_presets_wrap").addClass("fn-hide"),z.$("#ivs_global_presets").empty(),z.$("#ivs_global_presets").options.add(new Option(tl("com.AddPresetFirstTip"),0)),a&&a()})},getTemplate:function(){d.VideoInAnalyse.getTemplateModule("Normal").done(function(a){x=a.Normal}),d.VideoInAnalyse.getTemplateGlobal().done(function(a){y=a})},sliderInit:function(){z.Slider={},z.Slider.OverlapPercent=z.$("#Global_IVS_1_slider").slider({min:0,max:100}),z.Slider.DistLimit=z.$("#Global_IVS_2_slider").slider({min:0,max:100}),z.Slider.TimeLimit=z.$("#Global_IVS_3_slider").slider({min:0,max:100}),z.Slider.VAMSensitivity=z.$("#Global_IVS_4_slider").slider({min:1,max:10})},SetCalibrateAndRules:function(a,b,c){var d=z._name2Type(a);c?"Polygon"===d&&z._redrawShap(d,b):"Polygon"===d?(f.shapeDelete(l),("flash"===webApp.playMode||"h5"===webApp.playMode)&&k.DeleteVideoAnalyseShape(z.containerId,l),p=null,q=null):(("flash"===webApp.playMode||"h5"===webApp.playMode)&&k.DeleteVideoAnalyseShape(z.containerId,q.Staffs[b]),f.shapeDelete(q.Staffs[b]),q.Staffs.splice(b,1))},naclHandle:function(b,c,e){var g=c,h=e;switch(b){case"createDone":"ModuleDetectRegion"===h?f.getData(g.ShapeID).done(function(a){detectIds.push(g.ShapeID),detectJsons.push(a)}):"XXX"===h&&(z.enableStaffOperation(),f.getData(g.ShapeID).done(function(a){switch(p||(q={Area:[],Staffs:[]},p={Area:[],Staffs:[],Type:"Groud"}),g.ShapeName){case"Polygon":p.Area=a,p.Staffs=[],q.Area[0]=g.ShapeID;break;case"VerticalLine":if(4===q.Staffs.length){A[0]=a,B[0]=g.ShapeID,d.DevVideoAnalyse.testCalibrateWithScreenPoints("Vertical",a[0],a[1]).done(function(a){f.setTip(g.ShapeID,a.toFixed(2))});break}p.Staffs.push({End:a[1],Length:z.$("#scaleLength").val()-0,Start:a[0],Type:"Vertical"}),q.Staffs.push(g.ShapeID);break;case"HorizontalLine":if(4===q.Staffs.length){A[1]=a,B[1]=g.ShapeID,d.DevVideoAnalyse.testCalibrateWithScreenPoints("Horizontal",a[0],a[1]).done(function(a){f.setTip(g.ShapeID,a.toFixed(2))});break}p.Staffs.push({End:a[1],Length:z.$("#scaleLength").val()-0,Start:a[0],Type:"Horizontal"}),q.Staffs.push(g.ShapeID)}}));break;case"dragDone":switch(g.ShapeName){case"Polygon":f.getData(g.ShapeID).done(function(a){p.Area=a,z.$("#ivs_ScaleAreaCheck").trigger("click")}),q.Staffs.each(function(a,b){f.getData(a).done(function(a){p.Staffs[b].Start=a[0],p.Staffs[b].End=a[1]})});break;case"VerticalLine":4===q.Staffs.length&&a.inArray(g.ShapeID,B)>-1&&f.getData(g.ShapeID).done(function(a){A[0]=a,B[0]=g.ShapeID,d.DevVideoAnalyse.testCalibrateWithScreenPoints("Vertical",a[0],a[1]).done(function(a){f.setTip(g.ShapeID,a.toFixed(2))})});break;case"HorizontalLine":4===q.Staffs.length&&a.inArray(g.ShapeID,B)>-1&&f.getData(g.ShapeID).done(function(a){A[1]=a,B[1]=g.ShapeID,d.DevVideoAnalyse.testCalibrateWithScreenPoints("Horizontal",a[0],a[1]).done(function(a){f.setTip(g.ShapeID,a.toFixed(2))})});break;default:f.getData(g.ShapeID).done(function(a){var b=q.Staffs.indexOf(g.ShapeID);p.Staffs[b].Start=a[0],p.Staffs[b].End=a[1],z.$("#ivs_scaleContent").find("[data-staffindex="+b+"]").trigger("click")})}break;case"mousedownSelect":}},_createSub:function(a,b,c){return"flash"===webApp.playMode||"h5"===webApp.playMode?c?k.AddVideoAnalyseShape(z.containerId,l,a,b,{isValidate:c}):k.AddVideoAnalyseShape(z.containerId,l,a,b):void f.createSubShape(l,a,b).then(function(a){return f.ocxSetColor(a,"green",!0),E=a,a})},_createDetectSub:function(a,b){return"flash"===webApp.playMode||"h5"===webApp.playMode?k.AddVideoAnalyseShape(z.containerId,m,a,b):void f.createSubShape(m,a,b).then(function(a){return f.ocxSetColor(a,"green",!0),a})},_drawMainRule:function(a,b){("flash"===webApp.playMode||"h5"===webApp.playMode)&&(k.DeleteAllVideoAnalyseShape(z.containerId),l=k.CreateMainVideoAnalyseShape(z.containerId,"CalibrateRegionIPC",b,null)),f.shapeDeleteAll(),f.createShape("CalibrateRegionIPC","").done(function(c){l=c,z._createSub(a,b),f.ocxSetColor(c,"yellow",!0)})},_redrawShap:function(a){z._drawMainRule(a,"")},_name2Type:function(a){var b="";switch(a){case"CalibrateArea":b="Polygon";break;case"Vertical":b="VerticalLine";break;case"Horizontal":b="HorizontalLine";break;case"CheckedLength":}return b},_renderGlobalElements:function(){f.shapeDeleteAll(),("flash"===webApp.playMode||"h5"===webApp.playMode)&&k.DeleteAllVideoAnalyseShape(z.containerId);var a=z.$("#ivs_global_presets").val()-0;if(z._renderIVS(a),n&&0!==n.length){var b=z._findCalibrateKey(),c=n[G][b]||[];if(p=c[0]||null,z._renderScale(),z.$("#scaleVertical").prop("checked",!0),-1===webApp.DeviceType.indexOf("SD"))z.ocxMode="global",z._renderCalibrateOcx();else switch(z.ocxMode){case"para":z._renderCalibrateOcx();break;case"global":z._renderCalibrateOcx();break;case"ParaOrGlobal":z._renderCalibrateOcx()}}},_findCalibrateKey:function(){var a=z.$("#ivs_global_presets").val()-0,b="CalibrateArea";for(var c in n[G])-1!==c.indexOf("Scene")&&n[G][c].PtzPresetId==a&&(b=c.replace("Scene","CalibrateArea"));return b},_renderIVS:function(a){var b=0;if(w&&w[b]&&void 0!=w[b]){C={},D={shapeId:[],Region:[]};for(var c=0;c<w[b].length;c++)if(w[b][c].PtzPresetId==a&&"Normal"==w[b][c].Type){w[b][c].AntiDisturbance===!0?z.$("#VAM_AntiDisturbance_true").prop("checked",!0):z.$("#VAM_AntiDisturbance_false").prop("checked",!0),w[b][c].Shadow===!0?z.$("#VAM_Shadow_true").prop("checked",!0):z.$("#VAM_Shadow_false").prop("checked",!0),z.$("#Global_IVS_4_slider").slider("value",w[b][c].Sensitivity),w[b][c].DetectRegion&&(C.Region=w[b][c].DetectRegion,w[b][c].ExcludeRegion&&w[b][c].ExcludeRegion.each(function(a){D.Region.push(a)}));break}var d=n[b];for(var e in d)-1!==e.indexOf("Scene")&&d[e].PtzPresetId==a&&d[e].Detail.Track&&(z.Slider.OverlapPercent.slider("value",d[e].Detail.Track.OverlapPercent),z.Slider.DistLimit.slider("value",d[e].Detail.Track.DistLimit),z.Slider.TimeLimit.slider("value",d[e].Detail.Track.TimeLimit))}},_buildAnalyseGlobal:function(a){if("[object Array]"!==Object.prototype.toString.call(a)){var b=[];b.push(a[0]),a=b}var c={result:!0,params:{table:[a]}};r=JSON.stringify(c)},_renderScale:function(){var b=z._findCalibrateKey(),c=n[G][b]||[],d=c[0];if(u.length=0,z.$("#ivs_ScaleListShow").empty(),!d||!d.Area)return z.$("#ivs_ScaleAreaShow").css("visibility","hidden"),void z.disableStaffOperation();z.$("#ivs_ScaleAreaShow").css("visibility","visible"),z.enableStaffOperation();var e="",f=0;d.Staffs&&a.each(d.Staffs,function(a,b){var c=0;c="Horizontal"==b.Type?0:f++,e+="<span name="+b.Type+'><div class="fn-clear scale-region"><i class="scale_main_icon"></i><a href="javascript:;" data-staffIndex="'+a+'" scale-index="'+c+'" data-type="'+b.Type+'">'+tl(I[b.Type])+"</a></div></span>",u.push(b.Type),"Vertical"==b.Type?(z.$("#scaleLength").val(b.Length),s=b.Length):t=b.Length}),z.$("#ivs_ScaleListShow").html(e),z.$("#ivs_ScaleListShow").children().last().find("i").attr("class","scale_bottom_icon")},_initPtz:function(){-1!==webApp.DeviceType.indexOf("SD")?($minPtzControl=z.$("#ivsSdPtz").minPtzControl(),$minPtzControl.minPtzControl("init",{showBoat:!0,showStep:!0}),z.$("#ivsSdSetBtn").removeClass("fn-hide")):webApp.CHANNEL_NUMBER>1&&($minPtzControl=z.$("#ivsSdPtz").minPtzControl(),$minPtzControl.minPtzControl("init",{showBoat:!1,showStep:!1}))},markSceneMaxZoom:function(){var a=z.$("#ivs_global_presets").val()-0,b=0;return 0>=a?void z.$("#ivs_global_remark").tip("warning",tl("notIvsPresetNow")):void d.PTZ.getStatus().done(function(c){var e=c.Postion[2];d.ConfigManager.getConfig("VideoAnalyseModule").done(function(c){for(var f=c,g=0;g<f[b].length;g++)if(f[b][g].PtzPresetId==a){f[b][g].MaxTrackZoom=e;break}d.ConfigManager.setConfig("VideoAnalyseModule",f).done(function(){w=f,z.$("#ivs_global_remark").tip("success",tl("com.OperateSuccessTip"))})})}).fail(function(){z.$("#ivs_global_remark").tip("error",tl("ptz.getStatusError"))})},setPreset:function(){var a=z.$("#ivs_global_presets")[0].value-0,b=z.$("#ivs_global_presets")[0].selectedOptions[0].text;d.PTZ.setPreset(a,b).done(function(){z.$("#ivs_global_remark").tip("success",tl("com.OperateSuccessTip"))}).fail(function(){z.$("#ivs_global_remark").tip("error",tl("com.OperateFailTip"))})},getStaff:function(a,b){var c=p.Staffs;if(c){var d=c.filter(function(b){return b.Type==a});return d[b]}},saveCurrentStaff:function(){var a=z.$("#ivs_ScaleListShow").find("a.scale_current");if(a.length>0&&p.Staffs){var b=parseInt(a.attr("data-staffIndex")),c=parseFloat(z.$("#scaleLength").val());p.Staffs[b].Length=isNaN(c)?v:c}},disableStaffOperation:function(){z.$("#ivs_global_staffType").find("input[name=scaleLine]").prop("disabled",!0),z.$("#scaleLength").prop("disabled",!0),z.$("#scaleLength").val(1),z.$("#ivs_AddScale").addClass("ui-button-disabled"),z.$("#ivs_DeleteScale").addClass("ui-button-disabled")},enableStaffOperation:function(){z.$("#ivs_global_staffType input[name=scaleLine]").prop("disabled",!1),z.$("#scaleLength").prop("disabled",!1),z.$("#ivs_AddScale").removeClass("ui-button-disabled"),z.$("#ivs_DeleteScale").removeClass("ui-button-disabled")},_saveGlobalScale:function(){p&&z.saveCurrentStaff()},_saveIVS:function(a){for(var b=0,c=0;c<w[b].length;c++)if(w[b][c].PtzPresetId==a&&"Normal"==w[b][c].Type){w[b][c].AntiDisturbance=z.$("#VAM_AntiDisturbance_true").prop("checked"),w[b][c].Shadow=z.$("#VAM_Shadow_true").prop("checked"),w[b][c].Sensitivity=z.$("#Global_IVS_4_slider").slider("value"),w[b][c].DetectRegion=C.Region,w[b][c].ExcludeRegion=D.Region;break}var d=n[b];for(var e in d)-1!==e.indexOf("Scene")&&d[e].PtzPresetId==a&&d[e].Detail.Track&&(d[e].Detail.Track.OverlapPercent=z.$("#Global_IVS_1_slider").slider("value"),d[e].Detail.Track.DistLimit=z.$("#Global_IVS_2_slider").slider("value"),d[e].Detail.Track.TimeLimit=z.$("#Global_IVS_3_slider").slider("value"))},_renderCalibrateOcx:function(){var a=z._findCalibrateKey(),b=n[G][a]||[];q={Area:[],Staffs:[]},z._buildAnalyseGlobal(b),("flash"===webApp.playMode||"h5"===webApp.playMode)&&b[0]&&b[0].Area&&(l=k.CreateMainVideoAnalyseShape(z.containerId,"CalibrateRegionIPC",b[0].Area,null),q.Area[0]=l,b[0].Staffs.each(function(a,b){q.Staffs[b]="Vertical"===a.Type?k.AddVideoAnalyseShape(z.containerId,l,"VerticalLine",[a.Start,a.End]):k.AddVideoAnalyseShape(z.containerId,l,"HorizontalLine",[a.Start,a.End])})),b[0]&&b[0].Area&&f.createShape("CalibrateRegionIPC","").done(function(a){l=a,f.createSubShape(l,"Polygon",b[0].Area).done(function(a){f.ocxSetColor(a,"blue",!0),q.Area[0]=a,b[0].Staffs.each(function(a,b){"Vertical"===a.Type?f.createSubShape(l,"VerticalLine",[a.Start,a.End]).done(function(a){q.Staffs[b]=a,f.selectShape(a,!1)}):f.createSubShape(l,"HorizontalLine",[a.Start,a.End]).done(function(a){q.Staffs[b]=a,f.selectShape(a,!1)})})})})},_bulidModuleJson:function(){for(var a=z.$("#ivs_global_presets").val()-0,b={result:!0,params:{table:[[{DetectRegion:null,ExcludeRegion:null,PtzPresetId:0}]]}},c=0;c<w[0].length;c++)if(w[0][c].PtzPresetId===a){b.params.table[0][0].DetectRegion=w[0][c].DetectRegion,b.params.table[0][0].ExcludeRegion=w[0][c].ExcludeRegion||"";break}return JSON.stringify(b)},_renderModuleOcx:function(){}})})}(jQuery);