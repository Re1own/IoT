!function(a){define(function(require,a,b){b.exports=require("jsCore/pageTab")}),define("flo_config",function(require,b,c){function d(b){var c=a.extend(!0,[],b);return 2===b.length?[c[0],[c[0][0],c[1][1]],c[1],[c[1][0],c[0][1]]]:4===b.length?[c[0],c[2]]:void 0}function e(){return JSON.stringify({result:!0,params:{table:[[w]]}})}function f(b){a.each(b,function(a,b){B[b]={}})}function g(){var b=[];return a.each(B,function(a){b.push(a)}),b}function h(b){if(b)for(var c=g(),d=0;d<b.length;d++){if(!b[d].result)return!1;B[c[d]]=b[d].params.table}var e=v.val()-0;return a.each(B.VideoAnalyseRule[analyseSenceRuleMap.NumberStat],function(a,b){return"NumberStat"!==b.Type||void 0!==b.Config.PlanId&&b.Config.PlanId!==e?void 0:(w=b,u=w.Name,!1)}),!0}function i(a){for(var b=0;b<a.length;b++)if(0!==a[b])return!1;return!0}function j(a,b,c){if(0===a[0]&&0===a[1]&&0===b[0]&&0===b[1])return!0;var d={};d.nX=b[0]-a[0],d.nY=b[1]-a[1];var e={};e.nX=c[0]-a[0],e.nY=c[1]-a[1];var f=!1,g=0,h={};return b[0]>=a[0]?b[1]>=a[1]?(h.nX=b[1]-a[1],h.nY=a[0]-b[0],g=(c[0]-a[0])*h.nX+(c[1]-a[1])*h.nY,f=g>0?!0:!1):(h.nX=a[1]-b[1],h.nY=b[0]-a[0],g=(c[0]-a[0])*h.nX+(c[1]-a[1])*h.nY,f=g>0?!1:!0):b[0]<a[0]?b[1]<a[1]?(h.nX=b[1]-a[1],h.nY=a[0]-b[0],g=(c[0]-a[0])*h.nX+(c[1]-a[1])*h.nY,f=g>0?!0:!1):(h.nX=a[1]-b[1],h.nY=b[0]-a[0],g=(c[0]-a[0])*h.nX+(c[1]-a[1])*h.nY,f=g>0?!1:!0):f=b[1]<a[1]?c[0]<a[0]?!0:!1:c[0]<a[0]?!1:!0,f}var k=require("jsCore/rpc"),l=require("jsCore/pageBase"),m=require("jsCore/rpcLogin"),n=require("jsCore/plugin"),o=require("jsCore/pluginCanvas"),p=require("jsCore/modules/eventHandler"),q=require("jsCore/modules/IntellMutex"),r=require("jsCore/modules/timeSection"),s=require("jsCore/ability"),t=require("common/common");require("jsCore/modules/ptzSetControl");var u,v,w=null,x=null,y=null,z=null,A=0,B={},C=require("jsCore/hlsplayer"),D=require("jsCore/flashplayer"),E=require("jsCore/h5player"),F={},G=!0,H={},I=null;c.exports=l.extend({init:function(){x=this,webApp.EventCaps?k.EventManager.getEventLink("NumberStat").done(function(b){var c=b.name,d=a.extend({},webApp.DefaultEvent),e=webApp.EventCaps;"default"===c[A][0]?d=e:c[A].each(function(a){d[a]=!0,"AlarmOutEnable"===a?d.AlarmOutLatch=e.AlarmOutLatch:"DejitterEnable"===a?d.DejitterRange=e.DejitterRange:"RecordEnable"===a&&(d.RecordLatch=e.RecordLatch)}),y=new p("#f_c_event",d)}).fail(function(){y=new p("#f_c_event")}):y=new p("#f_c_event"),z=new q("f_c_mutex"),v=x.$('select[sel-for="onChangePID"]'),f(webApp.IsSDIntel&&!webApp.NoIntelliPreset?["VideoAnalyseRule","VideoWidgetNumberPlan"]:["VideoAnalyseRule","VideoWidgetNumberStat"]),s.get("IVSCaps").done(function(a){if(webCaps.is_new_IVSUI!==!0){var b=q.getIntellMutexTip("NumberStat",a||{});b&&(z.add("intell",b),z.setCtrl("intell",!0)),z.add("tvout",'<span t="com.IntellMutexTVOutTip">'+tl("com.IntellMutexTVOutTip")+"</span>")}}),x.$("#f_c_enter, #f_c_leave, #f_c_stranded").numberfield({min:0,max:65535,allowDecimal:!1,allowNegative:!1}),x.$("#f_c_enable").on("click",function(){w.Enable=this.checked,this.checked?z.show():z.hide(),"flash"===webApp.playMode||"h5"===webApp.playMode?(w.shapeId&&o.ShowVideoAnalyseShape(x.containerId,w.shapeId,w.Enable),!w.Enable&&H.sizeFilterId&&o.ShowVideoAnalyseShape(x.containerId,H.sizeFilterId,!1)):(n.SetIVSConfig(e(),2),n.SubVideoWndCtrl(12,1),n.SetCurModule(0)),x.$("#f_c_max, #f_c_min").prop("disabled",!1)}),x.$("#f_c_max").on("click",function(){x.$(this).prop("checked",!0),x._targetRule()}),x.$("#f_c_min").on("click",function(){x.$(this).prop("checked",!0),x._targetRule()}),x.$("#f_c_rulename").on("blur",function(){return this.value?("ocx"===webApp.playMode&&n.SetCurShape(u),u=x.$("#f_c_rulename").val(),w.Name=u,void("flash"===webApp.playMode||"h5"===webApp.playMode?o.SetVideoAnalyseShapeShowName(x.containerId,w.shapeId,u):(n.SetCurName(u),n.SetCurShape("save")))):(this.value=w.Name,void x.$("#f_c_tip").tip("warning",tl("com.NullLimiteTip")))}),webCaps.is_new_IVSUI&&(x.$("#f_c_direction").find("option:eq(0)").attr("t","com.LeftToRight"),x.$("#f_c_direction").find("option:eq(1)").attr("t","com.RightToLeft"),x.$("#f_c_direction").translation()),s.get("IVSCaps").done(function(a){if(a&&a.SupportedScenes&&a.SupportedScenes.NumberStat){var b=a.SupportedScenes.NumberStat;if(b.SupportedSceneParams.CameraAspect&&(x.$("#f_c_angel").parent().show(),f(["VideoAnalyseGlobal"])),b.SupportedModuleParams.SizeFilter.MaxSize&&b.SupportedModuleParams.SizeFilter.MinSize){var c="("+b.SupportedModuleParams.SizeFilter.MinSize[0]+"-"+b.SupportedModuleParams.SizeFilter.MaxSize[0]+")";x.$("#f_c_bestsize").show().text(c)}"h5"===webApp.playMode&&x.$("#f_c_bestsize").hide()}a&&a.SupportedScenes&&a.SupportedScenes.NumberStatPlan&&!webApp.NoIntelliPreset&&x.initRules(a.SupportedScenes.NumberStatPlan.MaxRules),x.render()}),isEnable("show_flowrate_target")&&x.$("#f_c_target").show(),webApp.IsSDIntel&&!webApp.NoIntelliPreset&&(x.$("#floSdPtzWrap").ptzSetControl(),x.$('a[btn-for="onDefault"]').addClass("fn-hide"))},render:function(){z.hide(),webCaps.is_new_IVSUI!==!0&&z.setCtrl("tvout",g_videoInConflict.DSP.hasConflict()),"hls"===webApp.playMode?(C.cover(x.$("#f_c_video")),n.hide(),C.init("","",""),C.beginPlay()):"flash"===webApp.playMode||"h5"===webApp.playMode?("flash"===webApp.playMode&&D.cover(x.$("#f_c_video")),n.hide(),"flash"===webApp.playMode&&D.playPreview(1,0),E&&"h5"===webApp.playMode&&(I=new a.Deferred,E.playPreview(1,0,x.$("#f_c_video"),null,I)),"flash"===webApp.playMode?k.ConfigManager.getConfig(["Encode","VideoImageControl"]).done(function(a){if(webApp.resolution.x=a[0].params.table[0].MainFormat[0].Video.Width,webApp.resolution.y=a[0].params.table[0].MainFormat[0].Video.Height,1==a[1].params.table[0].Rotate90||2==a[1].params.table[0].Rotate90){var b;b=webApp.resolution.x,webApp.resolution.x=webApp.resolution.y,webApp.resolution.y=b}o.cover("#f_c_video",webApp.resolution.x+"*"+webApp.resolution.y),x.containerId=o.CreateVideoAnalyseContainer(),x._getConfig(!1)}):"h5"===webApp.playMode&&(x.disabled("[btn-for=onDrawRule]",!0),x.disabled("[btn-for=onDrawClear]",!0),x.disabled("[btn-for=onDrawTarget]",!0),x.disabled("[btn-for=onClearTarget]",!0),I&&I.done(function(a){webApp.resolution.x=a.width,webApp.resolution.y=a.height,o.cover("#f_c_video",webApp.resolution.x+"*"+webApp.resolution.y),x.containerId=o.CreateVideoAnalyseContainer(),o.showMult=!0,x._getConfig(!1),x.disabled("[btn-for=onDrawRule]",!1),x.disabled("[btn-for=onDrawClear]",!1),x.disabled("[btn-for=onDrawTarget]",!1),x.disabled("[btn-for=onClearTarget]",!1)})),a.subscribe("DRectBig",function(b,c){w.Config.SizeFilter.MaxSize=a.extend(!0,[],c.data),H.MaxSize=a.extend(!0,[],c.data),x._renderSizeFilter(w.Config.SizeFilter,!0),x.$("#f_c_max, #f_c_min").prop("disabled",!1)}),a.subscribe("DRectSmall",function(b,c){w.Config.SizeFilter.MinSize=a.extend(!0,[],c.data),H.MinSize=a.extend(!0,[],c.data),x._renderSizeFilter(w.Config.SizeFilter,!0),x.$("#f_c_max, #f_c_min").prop("disabled",!1)})):n.cover("#f_c_video",function(a){n.SetRegionNum(0),n.SetModuleMode(2),m.chkAuthority("Monitor_01")&&n.open(),a&&x._getConfig(!1),x._getConfig(!1)}),n.addEvent("OutPutStringInfo",function(a,b){b=JSON.parse(b),"OutPutShapeRect"===a?(G=!0,w.Config.DetectRegion=b.Config.DetectRegion,w.Config.Direction=b.Config.Direction):"OutPutObjectRect"===a&&(webCaps.is_show_PixelCounter&&b.rect1?(F.width=b.rect1[0],F.height=b.rect1[1],x.$("[name=DetectSize-0]").numberfield("value",F.width),x.$("[name=DetectSize-1]").numberfield("value",F.height)):(b.MinRect?w.Config.SizeFilter.MinSize=b.MinRect:b.MaxRect&&(w.Config.SizeFilter.MaxSize=b.MaxRect),x._renderSizeFilter(w.Config.SizeFilter,!0),x.$("#f_c_max, #f_c_min").prop("disabled",!1)))}),a.subscribe("IVSRuleConfig",function(a,b){if(void 0===w.shapeId||w.shapeId==b.shapeID){var c=x._ruleInitEmpty();if("RuleDetectRegion"===b.shapeName&&(w.Config.DetectRegion=d(b.data),w.shapeId=b.shapeID),c){var e=x.$("#f_c_direction").val()-0;o.SetVideoAnalyseShapeDirection(x.containerId,w.shapeId,e)}w.Config.Direction=[[0,0],[0,0]]}"PixelCount"===b.shapeName&&(F.width=b.data[1][0]-b.data[0][0],F.height=b.data[1][1]-b.data[0][1],x.$("[name=DetectSize-0]").numberfield("value",F.width),x.$("[name=DetectSize-1]").numberfield("value",F.height))}),isEnable("show_flowrate_target")&&webCaps.is_show_PixelCounter&&(x.$("#f_c_detect").show(),x.$("[name=DetectSize-0]").numberfield({min:0,max:webApp.resolution.x,allowDecimal:!0,allowNegative:!1}),x.$("[name=DetectSize-1]").numberfield({min:0,max:webApp.resolution.y,allowDecimal:!0,allowNegative:!1}),n.addEvent("ResolutionChangeIvs",function(){x.$("[name=DetectSize-0]").numberfield({min:0,max:webApp.resolution.x,allowDecimal:!0,allowNegative:!1}),x.$("[name=DetectSize-1]").numberfield({min:0,max:webApp.resolution.y,allowDecimal:!0,allowNegative:!1}),x.$("[name=DetectSize-0]").trigger("change"),x.$("[name=DetectSize-1]").trigger("change")}));var b=v.val()-0;b>0&&!webApp.NoIntelliPreset&&k.PTZ.gotoStatisticPlan("NumberStat",b)},leave:function(){n.addEvent("OutPutStringInfo",null),n.addEvent("ResolutionChangeIvs",null),n.SetIVSConfig("",2),n.hide(),z.hide(),"hls"===webApp.playMode?C.hideAndStopLoad():("flash"===webApp.playMode||"h5"===webApp.playMode)&&(H={},o.hide(),"h5"===webApp.playMode?E.hide():D.hide(),a.unsubscribe("IVSRuleConfig",null),a.unsubscribe("DRectBig",null),a.unsubscribe("DRectSmall",null),F={})},initRules:function(a){if(a){var b,c="";for(b=1;a+1>b;b++)c+="<option value="+b+">"+b+"</option>";v.html(c).parent().removeClass("fn-hide")}},_getConfig:function(a){m.chkAuthority("EncodeConf")?f(["VideoWidget"]):x.$("#tr_osdenable").css("display","none");var b=g();k.ConfigManager.getConfig(b).done(function(b){G=!0,F.ShapeId&&o.ShowVideoAnalyseShape(x.containerId,F.ShapeId,!1),h(b)?(x._renderElements(),a&&x.$("#f_c_tip").tip("success",tl("com.OperateSuccessTip"))):x.$("#f_c_tip").tip("error",tl("com.OperateFailTip"))})},_renderElements:function(){if(H={},F={},"flash"===webApp.playMode||"h5"===webApp.playMode?o.DeleteAllVideoAnalyseShape(x.containerId):n.SetIVSConfig("",0),x.$("#f_c_enable").prop("checked",w.Enable),x.$("#f_c_max, #f_c_min").prop("disabled",!1),B.VideoAnalyseGlobal){var b=B.VideoAnalyseGlobal[0].Scene.Detail.CameraAngle>20?"lean":"vertical";x.$("#f_c_angel").val(b)}x.$("#f_c_rulename").val(w.Name),"Entrance"==w.Config.Type&&x.$("#f_c_direction").val(j(w.Config.DetectRegion[0],w.Config.DetectRegion[1],w.Config.Direction[0])?"0":"1"),x.$("#f_c_enter").numberfield("value",w.Config.EnterThreshold),x.$("#f_c_leave").numberfield("value",w.Config.ExitThreshold),x.$("#f_c_stranded").numberfield("value",w.Config.InsideThreshold);var c;webApp.IsSDIntel&&!webApp.NoIntelliPreset?a.each(B.VideoWidgetNumberPlan[0],function(a,b){b.PlanID===v.val()-0&&(c=b)}):c=B.VideoWidgetNumberStat[0],x.$("#f_c_osdenable").prop("checked",c.EncodeBlend),isEnable("show_flowrate_target")&&(H=a.extend(!0,H,w.Config.SizeFilter),x._renderSizeFilter(w.Config.SizeFilter)),y.set(w.EventHandler);var f=x._ruleInitEmpty();if("flash"===webApp.playMode||"h5"===webApp.playMode){w.shapeId?o.ShowVideoAnalyseShape(x.containerId,w.shapeId):w.shapeId=f?o.CreateMainVideoAnalyseShape(x.containerId,"RuleDetectRegion",null,{showName:w.Name}):o.CreateMainVideoAnalyseShape(x.containerId,"RuleDetectRegion",d(w.Config.DetectRegion),{showName:w.Name});var g=x.$("#f_c_direction").val()-0;o.SetVideoAnalyseShapeDirection(x.containerId,w.shapeId,g),o.SelectVideoAnalyseShape(x.containerId,w.shapeId,!1)}else n.SetIVSConfig(e(),2),n.SetCurShape(w.Name),f||n.SetCurShape("save")},_renderSizeFilter:function(a,b){b||x._initTarget(),x.$('input[name*="Size-"]').each(function(b,c){if(3>=b){var d=c.name.split("-");x.$(this).val(a[d[0]][parseInt(d[1])])}})},_ruleInitEmpty:function(a){for(var b=w.Config.DetectRegion,c=!0,d=b.length;d--;)if(b[d][0]||b[d][1]){c=!1;break}return c&&!a&&n.DeleteShape(w.Name),c},onDrawRule:function(){if(webCaps.is_show_PixelCounter&&n.DeleteShape("rect1"),x.$("#f_c_enable").prop("checked")&&x._targetTip()){var a,b=x.$("#f_c_rulename").val(),c=x.$("#f_c_direction").val(),d=x._ruleInitEmpty(!0);return"0"==c?a=0:"1"==c&&(a=1),d?void("flash"===webApp.playMode||"h5"===webApp.playMode?o.RedrawVideoAnalyseShape(x.containerId,w.shapeId):(n.SetCurShape(b),n.AddShape(2,webCaps.is_new_IVSUI?"NumberStatNew":"NumberStat",b,a,0))):void("flash"===webApp.playMode||"h5"===webApp.playMode?(o.ShowVideoAnalyseShape(x.containerId,w.shapeId),o.SelectVideoAnalyseShape(x.containerId,w.shapeId)):n.SelectRule(b,0))}},onDrawClear:function(){webCaps.is_show_PixelCounter&&n.DeleteShape("rect1"),x.$("#f_c_enable").prop("checked")&&(w.Config.DetectRegion=[[0,0],[0,0],[0,0],[0,0]],G=!1,w.Config.Direction=[[0,0],[0,0]],"flash"===webApp.playMode||"h5"===webApp.playMode?o.RedrawVideoAnalyseShape(x.containerId,w.shapeId):(n.DeleteShape(u),n.SetIVSConfig(e(),2),x.onDrawRule()))},onDrawTarget:function(){x._targetTip()&&(x._initTarget(),x._targetRule(),x.$("#f_c_max, #f_c_min").prop("disabled",!1))},_initTarget:function(){if(x.$("#f_c_enable").prop("checked")&&w){var a={};a.MaxRect=w.Config.SizeFilter.MaxSize,a.MinRect=w.Config.SizeFilter.MinSize,n.SetObjectConfig(JSON.stringify(a)),n.SetCurPtzID(0)}},_targetRule:function(){if(x.$("#f_c_enable").prop("checked")&&w)if("flash"===webApp.playMode||"h5"===webApp.playMode){if(o.showMult=!1,o.ToggleVisibilityOfVideoAnalyseShape(x.containerId,!1),H.sizeFilterId)o.ShowVideoAnalyseShape(x.containerId,H.sizeFilterId),H.smallId||(H.smallId=o.AddVideoAnalyseShape(x.containerId,H.sizeFilterId,"DRectSmall"));else{H.sizeFilterId=o.CreateMainVideoAnalyseShape(x.containerId,"DRectBigSmallShape"),H.bigId=o.AddVideoAnalyseShape(x.containerId,H.sizeFilterId,"DRectBig",H.MaxSize);var a=H.MinSize,b=a.toString().split(",");Math.max.apply(null,b)>0?H.smallId=o.AddVideoAnalyseShape(x.containerId,H.sizeFilterId,"DRectSmall",a):x.$("#f_c_min").prop("checked")&&(H.smallId=o.AddVideoAnalyseShape(x.containerId,H.sizeFilterId,"DRectSmall"))}o.SelectFilterShape(x.containerId,H.sizeFilterId,H.bigId,x.$("#f_c_max").prop("checked")),o.SelectFilterShape(x.containerId,H.sizeFilterId,H.smallId,x.$("#f_c_min").prop("checked"))}else x._initTarget(),x.$("#f_c_max").prop("checked")?i(w.Config.SizeFilter.MaxSize)?n.AddShape(5,"","MaxRect",0,-1):n.SetCurShape("MaxRect"):i(w.Config.SizeFilter.MinSize)?n.AddShape(5,"","MinRect",0,-1):n.SetCurShape("MinRect")},onClearTarget:function(){if(x.$("#f_c_enable").prop("checked")&&w&&w.Config.SizeFilter){if(x.$("#f_c_max").prop("disabled"))return void x.$("#f_c_tip").tip("error",tl("com.PleaseDrawShapeTip"));"flash"!==webApp.playMode&&"h5"!==webApp.playMode||!H.sizeFilterId?(n.SetVideoAnalyseContainerTip(0,""),x.$("#f_c_max").prop("checked")?(n.DeleteShape("MaxRect"),n.AddShape(5,"","MaxRect",0,-1)):(n.DeleteShape("MinRect"),n.AddShape(5,"","MinRect",0,-1))):(o.showMult=!1,x.$("#f_c_max").prop("checked")?o.RedrawVideoAnalyseShape(x.containerId,H.sizeFilterId,H.bigId):o.RedrawVideoAnalyseShape(x.containerId,H.sizeFilterId,H.smallId)),x.$("#f_c_max").prop("checked")?(w.Config.SizeFilter.MaxSize=[0,0],H.MaxSize=[0,0],x.$('[name="MaxSize-0"]').val(0),x.$('[name="MaxSize-1"]').val(0)):(w.Config.SizeFilter.MinSize=[0,0],H.MinSize=[0,0],x.$('[name="MinSize-0"]').val(0),x.$('[name="MinSize-1"]').val(0))}},onDrawDetect:function(){var a=x.$("[name=DetectSize-0]").numberfield("value"),b=x.$("[name=DetectSize-1]").numberfield("value"),c={PixelCount:[[0,0],[a,b]],Name:"rect1"};return x.$("#f_c_max").prop("disabled")||!G?void x.$("#f_c_tip").tip("error",tl("com.PleaseDrawShapeTip")):void(a*b?"flash"===webApp.playMode||"h5"===webApp.playMode?(o.showMult=!1,F.ShapeId?o.SetVideoAnalyseShapeConfig(x.containerId,F.ShapeId,[[(webApp.resolution.x-a)/2,(webApp.resolution.y-b)/2],[(webApp.resolution.x+a)/2,(webApp.resolution.y+b)/2]]):F.ShapeId=o.CreateMainVideoAnalyseShape(x.containerId,"PixelCount",[[(webApp.resolution.x-a)/2,(webApp.resolution.y-b)/2],[(webApp.resolution.x+a)/2,(webApp.resolution.y+b)/2]])):n.SetObjectConfig(JSON.stringify(c)):"flash"===webApp.playMode||"h5"===webApp.playMode?(o.showMult=!1,F.ShapeId=o.CreateMainVideoAnalyseShape(x.containerId,"PixelCount")):n.AddShape(6,"PixelCount","rect1",-1,0))},_targetTip:function(){var a,b,c=function(a){for(var b=0;b<a.length;b++)if(0!==a[b])return!1;return!0};return isEnable("show_flowrate_target")?(a=c(w.Config.SizeFilter.MaxSize),b=c(w.Config.SizeFilter.MinSize),a||b?(x.$("#f_c_tip").tip("error",tl("com.PleaseDrawShapeTip")),x.onClearTarget(),!1):!0):!0},onChangeType:function(){if(w){if(!x._targetTip())return void x.$("#f_c_direction").val(j(w.Config.DetectRegion[0],w.Config.DetectRegion[1],w.Config.Direction[0])?"0":"1");var a=w.Config.Direction[0];if(w.Config.Direction[0]=w.Config.Direction[1],w.Config.Direction[1]=a,"h5"===webApp.playMode){var b=x.$("#f_c_direction").val()-0;o.SetVideoAnalyseShapeDirection(x.containerId,w.shapeId,b)}else n.SetIVSConfig(e(),2),n.SetCurShape(u),n.SetCurShape("save")}},onClearZero:function(){k.VideoStatServer.clearSectionStat()},onChangePID:function(){k.PTZ.gotoStatisticPlan("NumberStat",v.val()-0),h(),x._renderElements(),x._getConfig(!1)},_saveElement:function(){if(delete w.shapeId,"flash"===webApp.playMode||"h5"===webApp.playMode){var a=w.Config.Direction;if(0===a[0][0]&&0===a[1][0]){var b=w.Config.DetectRegion,c=[b[0][0],b[0][1]+(b[1][1]-b[0][1])/2],d=[b[2][0],b[3][1]+(b[2][1]-b[3][1])/2],e=x.$("#f_c_direction").val();w.Config.Direction="0"===e?[d,c]:[c,d]}}w.Enable=x.$("#f_c_enable").prop("checked"),w.Config.EnterThreshold=x.$("#f_c_enter").numberfield("value"),w.Config.ExitThreshold=x.$("#f_c_leave").numberfield("value"),w.Config.InsideThreshold=x.$("#f_c_stranded").numberfield("value"),w.Name=x.$("#f_c_rulename").val(),w.EventHandler=y.get()},checkGlobal:function(b){var c=0,d="Scene";for(var e in b[c])if(-1!==e.indexOf("Scene")&&0===b[c][e].PtzPresetId&&(d=e,"NumberStatPlan"==b[c][e].Type))return!0;return""===b[c][d].Type||null===b[c][d].Type||(a.isArray(b[c][d].TypeList)?b[c][d].TypeList.push(b[c][d].Type):b[c][d].TypeList=[b[c][d].Type]),webApp.IsSDIntel&&!webApp.NoIntelliPreset&&(b[c][d].TypeList=[],x.$("#f_c_enable").prop("checked")&&(b[c][d].Type="NumberStatPlan")),b},defCheckGlobal:function(b){return a.Deferred(function(a){k.ConfigManager.getConfig("VideoAnalyseGlobal").done(function(c){null==c[0]&&(c[0]={}),c=x.checkGlobal(c,b),c!==!0&&webApp.IsSDIntel?k.ConfigManager.setConfig("VideoAnalyseGlobal",c).done(function(){a.resolve()}).fail(function(){a.reject("setGlobalFailed")}):a.resolve()}).fail(function(){a.reject("getGlobalFailed")})})},onConfirm:function(){if(x._targetTip()){var b=null,c=null,d=!0,e=["VideoAnalyseRule"];B.VideoAnalyseGlobal&&e.push("VideoAnalyseGlobal"),k.ConfigManager.getConfig(e).done(function(e){var f=!0;if(a.each(e,function(a,b){b.result||(f=!1)}),f){var g=e[0].params.table;x.defCheckGlobal(g).done(function(){if(a.each(g,function(e,f){a.each(f,function(a,e){u==e.Name&&"NumberStat"!=e.Type&&(b=e.Type,c="VideoAbnormalDetection"==b?"ivs.VideoAbnormalDetection":b,x.$("#f_c_tip").tip("error",tl(tl("ivs.PtzNumberStat")+" "+tl("com.And")+" "+tl(c)+" "+tl("com.GroupNameSameTip"))),d=!1)})}),d){n.SetCurShape("save"),x._saveElement();var f=v.val()-0;a.each(g[analyseSenceRuleMap.NumberStat],function(b,c){if("NumberStat"===c.Type&&(void 0===c.Config.PlanId||c.Config.PlanId===f)){g[analyseSenceRuleMap.NumberStat][b]=w;var d;webApp.IsSDIntel&&!webApp.NoIntelliPreset?a.each(B.VideoWidgetNumberPlan[0],function(a,b){b.PlanID===f&&(d=b)}):d=B.VideoWidgetNumberStat[0],d.EncodeBlend=x.$("#f_c_osdenable").prop("checked"),d.EncodeBlend&&B.VideoWidget[0].UserDefinedTitle&&(B.VideoWidget[0].UserDefinedTitle[0].EncodeBlend=!1);var h=[],i=[];a.each(B,function(a,b){var c=null;"VideoAnalyseRule"===a?c=g:"VideoAnalyseGlobal"===a?(c=e[1].params.table,c[0].Scene.Detail.CameraAngle="lean"===x.$("#f_c_angel").val()?90:0):c=b,h.push(a),i.push(c)}),webApp.IsSDIntel&&!webApp.NoIntelliPreset&&k.PTZ.setStatisticPlan("NumberStat",f).always(function(){}),k.ConfigManager.setConfig(h,i).done(function(a){t.chkMutilCallRet(a)?(x._renderElements(),x.$("#f_c_tip").tip("success",tl("com.SaveSuccessTip"))):x.$("#f_c_tip").tip("error",tl("com.SaveConfigFailTip"))})}})}})}else x.$("#f_c_tip").tip("error",tl("com.SaveConfigFailTip"))})}},onDefault:function(){var a=g();k.ConfigManager.getDefault(a).done(function(a){G=!0,F.ShapeId&&o.ShowVideoAnalyseShape(x.containerId,F.ShapeId,!1),h(a)?(x._renderElements(),x.$("#f_c_tip").tip("success",tl("com.DefaultSuccessTip"))):x.$("#f_c_tip").tip("error",tl("com.DefaultfailureTip"))}).fail(function(){x.$("#f_c_tip").tip("error",tl("com.DefaultfailureTip"))})},onRefresh:function(){x._getConfig(!0)},onSetPeriod:function(){w&&w.EventHandler&&w.EventHandler.TimeSection&&(n.hide(),r.open(w.EventHandler.TimeSection).done(function(a){w.EventHandler.TimeSection=a}).always(function(){"hls"!=webApp.playMode&&"flash"!=webApp.playMode&&"h5"!==webApp.playMode&&n.cover("#f_c_video")}))}})}),define("flo_report",function(require,b,c){function d(a,b,c){var d,e,f,g,h;if(!(b>=a)){if(d=(a-b)/c,g=Math.pow(10,parseInt(Math.log(d)/Math.log(10)))==d?Math.pow(10,parseInt(Math.log(d)/Math.log(10))):Math.pow(10,parseInt(Math.log(d)/Math.log(10))+1),e=(d/g).toFixed(6),e=e>=0&&.1>=e?.1:e>=.100001&&.2>=e?.2:e>=.200001&&.25>=e?.25:e>=.250001&&.5>=e?.5:1,e*=g,parseInt(b/e)!=b/e&&(b=0>b?-1*Math.ceil(Math.abs(b/e))*e:parseInt(Math.abs(b/e))*e),parseInt(a/e)!=a/e&&(a=parseInt(a/e+1)*e),f=(a-b)/e,c>f&&(h=c-f,f=c,a+=h%2==0?e*parseInt(h/2):e*parseInt(h/2+1),b-=e*parseInt(h/2)),c=f,0>b){var i=(a-b)/c,j=(a+b)/i;return[a+b,0,j]}return[a,b,c]}}function e(){var a=o.$("#f_r_enter").prop("checked"),b=o.$("#f_r_exit").prop("checked"),c=o.$("#f_r_showNum").prop("checked"),e=o.$('[fc_type="bar"]').prop("checked"),f=0,g=function(a){var b=a;return b=a%10===0||10>a?a:10*Math.ceil(a/10)};return a&&b?(p.nDirectionStat=2,f=d(g(p.totalMax),0,10)):a&&!b?(p.nDirectionStat=0,f=d(g(p.enterMax),0,10)):b&&!a?(p.nDirectionStat=1,f=d(g(p.exitMax),0,10)):p.nDirectionStat=3,f?(p.MaxData=f[0],p.YCount=f[2],p.ShowNumber=c,p.nShowType=e?0:1,!0):!1}{var f=require("jsCore/pageBase"),g=require("jsCore/rpc"),h=require("jsCore/plugin");require("lib/jquery.jqplot")}require("lib/Chart.min");var i,j,k,l,m,n,o=null,p=null,q={Hour:"com.DayReportRangeTip",Day:"com.MonthReportRangeTip",Month:"com.YearReportRangeTip"},r=!1;c.exports=f.extend({init:function(){o=this,i=o.$("#fr_st_date").datepicker({change:function(a,b){k.datepicker("minDate",b.value)}}),o.$("#fr_st_date").parent().css("min-width","978px"),j=o.$("#fr_st_time").timefield({disableM:!0,disableS:!0}),k=o.$("#fr_en_date").datepicker(),l=o.$("#fr_en_time").timefield({disableM:!0,disableS:!0}),o.$("#f_r_enter,#f_r_exit,#f_r_showNum,[fc_type=bar],[fc_type=line]").on("click",function(){if(p){if(!e())return a.alert(tl("com.NoDataTip")),void o._clearChart();o._drawChart(p)}}),ability.get("IVSCaps").done(function(a){a&&a.SupportedScenes&&a.SupportedScenes.NumberStatPlan&&o.initRules(a.SupportedScenes.NumberStatPlan.MaxRules),o.render()})},render:function(){r=!1,a(window).on("resize.flowrate",function(){p&&o._drawChart(p)}),o.onChangeReportType(),p?o._drawChart(p):o.disabled("[btn-for=onExport]",!0),g.ConfigManager.getConfig("Locales").done(function(a){switch(a.TimeFormat.split(" ")[0]){case"MM-dd-yyyy":case"MM/dd/yyyy":i.datepicker("format","mm-dd-yyyy"),k.datepicker("format","mm-dd-yyyy");break;case"dd-MM-yyyy":case"dd/MM/yyyy":i.datepicker("format","dd-mm-yyyy"),k.datepicker("format","dd-mm-yyyy");break;default:i.datepicker("format","yyyy-mm-dd"),k.datepicker("format","yyyy-mm-dd")}switch(a.TimeFormat.split(" ")[1]){case"HH:mm:ss":j.timefield("format","24"),l.timefield("format","24");break;default:j.timefield("format","12"),l.timefield("format","12")}}),("flash"===webApp.playMode||"h5"===webApp.playMode)&&o.$("#f_r_showNum").parent("label").hide()},leave:function(){r=!0,o._clearChart(!0),a(window).off("resize.flowrate")},destory:function(){o._clearChart(!0),a(window).off("resize.flowrate")},initRules:function(a){if(a){var b,c="";for(b=1;a+1>b;b++)c+="<option value="+b+">"+b+"</option>";o.$("#f_r_pid").html(c).parent().removeClass("fn-hide")}},onChangeReportType:function(){{var b=o.$("select[sel-for=onChangeReportType]").val(),c=new Date,d=c.getFullYear(),e=c.getMonth();c.getDate()}o.$("#fr_tips_txt").text(tl(q[b])),j.hide(),l.hide(),"Hour"==b?(j.show(),l.show(),i.datepicker("value",c),k.datepicker("value",c),j.timefield("value","00:00:00"),l.timefield("value",a.pad(c.getHours(),2)+":00:00")):"Day"==b?(i.datepicker("value",new Date(d,e,1)),k.datepicker("value",c)):(i.datepicker("value",new Date(d,0,1)),k.datepicker("value",c)),k.datepicker("minDate",i.datepicker("value"))},_clearChart:function(a){o.$("#f_r_title").html(""),o.$("#f_r_chart").empty().addClass("ui-emptyChart"),a&&(p=null)},onSearch:function(){var b=o.$("select[sel-for=onChangeReportType]").val(),c=i.datepicker("value")+" ",d=k.datepicker("value")+" ",e=o.$("#f_r_pid").val()-0,f=null,h=null,m=null,n=null,p=null;if(o.disabled("[btn-for=onExport]",!0),"Hour"==b){if(c+=j.timefield("value"),d+=l.timefield("value"),f=c,h=d,n=new Date(c.replace(/-/g,"/")),p=new Date(d.replace(/-/g,"/")),n.addDays(1)<p)return void a.alert(tl(q[b]))}else if("Day"==b){if(f=c,h=d,c+="00:00:00",d+="23:59:59",n=new Date(c.replace(/-/g,"/")),p=new Date(d.replace(/-/g,"/")),n.addMonths(1)<p)return void a.alert(tl(q[b]))}else if("Month"==b){o.$("#flow_reportTip").tip("warning",tl("com.YearReportErrorTip"));var s=new Date(c.replace(/-/g,"/")),t=new Date(d.replace(/-/g,"/")).addMonths(1);if(s.setDate(1),t.setDate(0),i.datepicker("value",s),k.datepicker("value",t),c+="00:00:00",d+="23:59:59",f=c.substr(0,7),h=d.substr(0,7),n=new Date(c.replace(/-/g,"/")),p=new Date(d.replace(/-/g,"/")),n.addYears(1)<p)return void a.alert(tl(q[b]))}if(new Date(c.replace(/-/g,"/"))>new Date(d.replace(/-/g,"/")))return a.alert(tl("com.BeginTLessThanEndTTip")),!1;var u=o.$("#f_r_enter").prop("checked"),v=o.$("#f_r_exit").prop("checked");if(!u&&!v)return a.alert(tl("com.ChooseDirTip")),!1;m=f+" ~ "+h+" "+tl("ivs.PtzNumberStat");var w={StartTime:c,EndTime:d,Granularity:b};webApp.IsSDIntel&&(w.PlanID=e),g.VideoStatServer.startFind(w).done(function(c){var d=c.token,e=c.totalCount;g.VideoStatServer.doFind(d,0,e).done(function(c){c&&!c.info&&a.alert(tl("com.NoDataTip")),r||(o._formatChartData(c,b,m),g.VideoStatServer.stopFind(d))}).fail(function(){a.alert(tl("com.NoDataTip"))})}).fail(function(){a.alert(tl("com.OpearFaildTip"))})},_formatChartData:function(b,c,f){var g=[],h=[],i=[],j=0,k=o.$("#f_r_enter").prop("checked"),l=o.$("#f_r_exit").prop("checked");a.each(b.info,function(a,b){g[a]=b.EnteredSubtotal,h[a]=b.ExitedSubtotal,i[a]=b.StartTime});var m,n=Math.max.apply(null,g),q=Math.max.apply(null,h),r=Math.max(n,q);if(m=k?l?r:n:l?q:0,o._clearChart(!0),!m)return a.alert(tl("com.NoDataTip"));o.disabled("[btn-for=onExport]",!1),j=d(m,0,10),p={enter:g,exit:h,YCount:j[2],MaxData:j[0],ShowNumber:!0,title:f,EnteredTotal:0,ExitedTotal:0,params:b,nReportType:0,nDirectionStat:0,nShowType:0,enterMax:n,exitMax:q,totalMax:r,timeArr:[]},"Hour"==c?(a.each(i,function(a,b){p.timeArr[a]=b.substr(5,8).replace(/\-/g,"/")+":00"}),p.nReportType=0):"Day"==c?(a.each(i,function(a,b){p.timeArr[a]=b.substr(0,10).replace(/\-/g,"/")}),p.nReportType=1):(a.each(i,function(a,b){p.timeArr[a]=b.substr(0,7).replace(/\-/g,"/")}),p.nReportType=2);for(var s=0;s<g.length;s++)p.EnteredTotal+=g[s];for(var t=0;t<h.length;t++)p.ExitedTotal+=h[t];e(),o._drawChart(p)},_drawChart:function(b){var c,d=b.enter,e=b.exit,f=b.timeArr,g=null,h=[],i=[],j=0,k=50,l={labels:f,datasets:[]},q=b.nDirectionStat,r=b.ShowNumber;if(o._clearChart(),"flash"===webApp.playMode||"h5"===webApp.playMode){if(o.$("#f_r_chart").append('<canvas id="f_r_canvas" width="1595" height="593"></canvas>'),m=document.getElementById("f_r_canvas").getContext("2d"),n=new Chart(m,{type:b.nShowType?"line":"bar",data:l,options:{responsive:!0,legend:{position:"right"},title:{display:!0,text:b.title}}}),2===q)l.datasets=[{label:tl("com.Enter"),backgroundColor:Chart.helpers.color("rgb(255, 99, 132)").alpha(.5).rgbString(),borderColor:"rgb(255, 99, 132)",borderWidth:1,data:b.enter},{label:tl("com.Leave"),backgroundColor:Chart.helpers.color("rgb(54, 162, 235)").alpha(.5).rgbString(),borderColor:"rgb(54, 162, 235)",borderWidth:1,data:b.exit}];else if(0===q)l.datasets=[{label:tl("com.Enter"),backgroundColor:Chart.helpers.color("rgb(255, 99, 132)").alpha(.5).rgbString(),borderColor:"rgb(255, 99, 132)",borderWidth:1,data:b.enter}];else{if(1!==q)return void o.disabled("[btn-for=onExport]",!0);l.datasets=[{label:tl("com.Leave"),backgroundColor:Chart.helpers.color("rgb(54, 162, 235)").alpha(.5).rgbString(),borderColor:"rgb(54, 162, 235)",borderWidth:1,data:b.exit}]}return o.$("#f_r_chart").removeClass("ui-emptyChart"),n.update(),void document.getElementById("f_r_canvas").toDataURL()}var s=o.$("#f_r_chart").width()/d.length;if(100>s&&(j=-30,k=.3*s),g=o.$('[fc_type="bar"]').prop("checked")?{renderer:a.jqplot.BarRenderer,rendererOptions:{barWidth:k,barMargin:0,barPadding:0,fillToZero:!0},pointLabels:{show:r,edgeTolerance:-50}}:{pointLabels:{show:r,edgeTolerance:-50}},2===q)h=[d,e],i=[{label:tl("com.Enter")+(r?b.EnteredTotal:"")},{label:tl("com.Leave")+(r?b.ExitedTotal:"")}],c=["#f00","#00f"];else if(0===q)h=[d],i=[{label:tl("com.Enter")+(r?b.EnteredTotal:"")}],c=["#f00"];else{if(1!==q)return void o.disabled("[btn-for=onExport]",!0);h=[e],i=[{label:tl("com.Leave")+(r?b.ExitedTotal:"")}],c=["#00f"]}o.disabled("[btn-for=onExport]",!1),o.$("#f_r_title").html(p.title);a.jqplot("f_r_chart",h,{seriesColors:c,seriesDefaults:g,series:i,legend:{show:!0,placement:"outsideGrid"},grid:{background:"#dedede",gridLineColor:"#999",borderColor:"#999"},axes:{xaxis:{renderer:a.jqplot.CategoryAxisRenderer,ticks:f,tickRenderer:a.jqplot.CanvasAxisTickRenderer,tickOptions:{markSize:5,_styles:{"margin-top":"10px"},showGridline:!1,angle:j}},yaxis:{min:0,max:b.MaxData,numberTicks:b.YCount+1}}})},onExport:function(){if("flash"===webApp.playMode||"h5"===webApp.playMode){var b=o.$("#f_r_canvas")[0];if(!b)return;var c=b.toDataURL(),d="PeopleCounting"+(new Date).format("yyyyMMddHHmmss"),e=a("<a></a>").attr("href",c).attr("download",d).appendTo("body");return e[0].click(),e.remove(),!1}h.GetConfigPath("LiveSnapshot").done(function(b){b=b+(a.browser.Platform.win?"\\":"/")+"PeopleCounting"+(new Date).format("yyyyMMddHHmmss"),h.ShowSaveOrOpenDlg("saveFile",b,[{description:"bmp( *.bmp)",extensions:["bmp"]},{description:"Microsoft Office (*.csv)",extensions:["csv"]}]).done(function(b){var c,d={};d.params=p.params,d.MaxData=p.MaxData,d.YCount=p.YCount,d.ShowNumber=p.ShowNumber,d.EnteredTotal=p.EnteredTotal,d.ExitedTotal=p.ExitedTotal,d.title=p.title,c="bmp"===b[2]?p.nShowType:2,h.MakeReport(p.nReportType,p.nDirectionStat,c,JSON.stringify(d),b[1]).done(function(b){a.alert(b?tl("com.ExportSuccessTip"):tl("com.ExportFailTip"))})})})}})})}(jQuery);