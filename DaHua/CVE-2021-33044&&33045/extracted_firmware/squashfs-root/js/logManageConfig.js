!function(a){define(function(require,a,b){b.exports=require("jsCore/pageTab");var c=require("jsCore/rpcLogin");b.exports.prototype.log_remote=function(){return!!isEnable("is_show_Syslog")&&(!webApp.newAuthority||c.chkAuthority("AuthSecurity"))}}),define("log_system",function(require,b,c){var d,e,f,g,h,i,j=require("jsCore/rpc"),k=require("jsCore/pageBase"),l=(require("common/common"),require("jsCore/rpcLogin")),m=require("jsCore/plugin"),n=(require("jsCore/ability"),{System:["StartUp","Abort","Exit","Restart","ShutDown","Reboot","System.Upgrade","Upgrade","SetCurrentTime"],Config:["SaveConfig","RecallConfig","Focus&Zoom","Config.importPackConfig","Config.exportPackConfig","Config.Restore","Config.OverlayPicture"],Storage:["SetWorkDirType","Storage.SetWorkDirGroup","Storage.ClearWorkDir","ClearWorkDir","Storage.HotPlug","HotPlug","RecordMode","FTP.Status","Storage.Unmount","NFS.Status","SD.Error","Disk.Error","SMB.Status","SDEncrypt.Encrypt","SDEncrypt.ClearPassword","SDEncrypt.Decrypt","SDEncrypt.ModifyPassword"],Event:["EventStart","EventStop","EventPulse","Storage.HealthAlarm"],Data:["FileAccess","FileAccessError","FileSearch","File.Access"],Account:["LogIn","LogOut","AddUser","DeleteUser","ModifyUser","AddGroup","DeleteGroup","ModifyGroup","Account.ModifyPwd","Account.LockUser","Account.ModifyContact","Account.PwdReset","Account.DevInit"],Security:["Security.SessionBlasting","Security.SessionHijacking","Security.LoginRestriction"],ClearLog:["ClearLog"]}),o=100,p=0;c.exports=k.extend({init:function(){var a=this;d=a.$("#lm_table").table({pageable:!1,height:260,columns:[{t:"com.Numbers",width:"10%",render:function(a){return a._index+1+p}},{t:"sys.LogTime",width:"30%",fields:"Time"},{t:"sys.UserName",width:"30%",fields:"User"},{t:"sys.LogType",width:"30%",fields:"Type"}],onRowSelect:function(b,c){return a._renderDetail(c.data),!1}}),e=a.$(".u-pagination").pagination({pageSize:o,change:function(b,c){return a._find(c.currentPage),!1}}),f=a.$("#lm_st_date").datepicker({change:function(a,b){h.datepicker("minDate",b.value)}}),g=a.$("#lm_st_time").timefield(),h=a.$("#lm_en_date").datepicker(),i=a.$("#lm_en_time").timefield(),a.render()},render:function(){var a=this;j.ConfigManager.getConfig("Locales").done(function(a){switch(a.TimeFormat.split(" ")[0]){case"MM-dd-yyyy":f.datepicker("format","mm-dd-yyyy"),h.datepicker("format","mm-dd-yyyy");break;case"dd-MM-yyyy":f.datepicker("format","dd-mm-yyyy"),h.datepicker("format","dd-mm-yyyy");break;default:f.datepicker("format","yyyy-mm-dd"),h.datepicker("format","yyyy-mm-dd")}switch(a.TimeFormat.split(" ")[1]){case"HH:mm:ss":g.timefield("format","24"),i.timefield("format","24");break;default:g.timefield("format","12"),i.timefield("format","12")}});var b=new Date;f.datepicker("value",b.addDays(-1)),g.timefield("value",b.getHours()+":"+b.getMinutes()+":"+b.getSeconds()),h.datepicker("value",b.addDays(1)),i.timefield("value",b.getHours()+":"+b.getMinutes()+":"+b.getSeconds()),a._renderTable(),e.pagination("total",0),a.disabled(a.$("[btn-for=onBackup]"),!0),a.$("#lm_serachtip").hide(),(!l.chkAuthority("DelLog")||webApp.newAuthority)&&(webApp.DeviceType.indexOf("SD")>-1&&-1===webApp.DeviceType.indexOf("TPC")?webCaps.is_show_clearLog||(a.$("[btn-for=onClear]").remove(),a.$("[sel-for=onTypeChange]").find("option[value=ClearLog]").remove()):(a.$("[btn-for=onClear]").remove(),a.$("[sel-for=onTypeChange]").find("option[value=ClearLog]").remove())),a.disabled(a.$("[btn-for=onSearch]"),!l.chkAuthority("QueryLog"))},leave:function(){h.datepicker("restoreDate")},onSearch:function(){function b(a){e.pagination("total",0),e.pagination("total",a),d.disabled(d.$("[btn-for=onSearch]"),!1),d.disabled(d.$("[btn-for=onBackup]"),!1),d.$("#lm_serachtip").show().find("span:eq(1)").text(a),d._find(1)}function c(a){d._renderTable(),e.pagination("total",0),d.disabled(d.$("[btn-for=onSearch]"),!1),d.disabled(d.$("[btn-for=onBackup]"),!0),d.$("#lm_serachtip").hide(),a&&d.tip("error",tl("com.QueryLogFailTip"))}var d=this,k=f.datepicker("value")+" "+g.timefield("value"),l=h.datepicker("value")+" "+i.timefield("value"),m=d.$("select[sel-for=onTypeChange]").val(),o={StartTime:k,EndTime:l,Translate:!0,Order:"Descent"};return m&&a.extend(o,{Types:n[m]}),new Date(k.replace(/-/g,"/"))>new Date(l.replace(/-/g,"/"))?(d.tip("warning",tl("com.BeginTLessThanEndTTip")),!1):(d.disabled(d.$("[btn-for=onSearch]"),!0),void j.Integration.getLogCount(o).done(function(a){0===a?(d.tip("success",tl("com.NoQueryLogTip")),c()):b(a)}).fail(function(){c(!0)}))},onClear:function(){var b=this;a.confirm(tl("sys.DeleteLog"),tl("com.SureToDeleteAllLogTip"),function(){j.Log.clear().done(function(a){a.result?(b.tip("success",tl("com.DelectLogSuccesTip")),b._renderTable(),e.pagination("total",0),b.$("#lm_serachtip").hide()):b.tip("error",tl("com.DelectLogFailTip"))}).fail(function(){b.tip("error",tl("com.DelectLogFailTip"))})})},onBackup:function(b){var c=this,d=new Date,e="LogBackup"+(d.getFullYear()+"-"+(d.getMonth()+1)+"-"+d.getDate());if("flash"===webApp.playMode||"h5"===webApp.playMode){b.preventDefault();var f=new XMLHttpRequest;return f.responseType="blob",f.open("GET","/RPC2_LogBackup/Log.Backup?action=doSeekFind&token="+j.Integration.token,!0),f.onreadystatechange=function(){if(4===f.readyState&&200===f.status){var a=new Blob([f.response],{type:"application/http"}),b=document.createElement("a");b.href=window.URL.createObjectURL(a),b.download="Log.Backup",document.body.appendChild(b),b.click(),setTimeout(function(){window.URL.revokeObjectURL(b.href),document.body.removeChild(b)},0),c.tip("success",tl("com.SaveSuccessTip"))}else 4===f.readyState&&200!==f.status&&c.tip("error",tl("com.SaveConfigFailTip"))},void f.send()}m.ShowSaveOrOpenDlg("saveFile",e,[{description:"Log Files (*.txt)",extensions:["txt"]}]).done(function(b){function d(e,f){j.Integration.getLog(e,f).done(function(f){if(f&&f.found&&a.isArray(f.items)){var g=a.map(f.items,function(a,b){return e+b+1+"	"+a.User+"	"+a.Time+"	"+a.Type+"	"+JSON.stringify(a.Detail)+"\r\n"});m.WriteFile(g.join(""),"a+",b[1]),d(e+=f.found,10*o)}else f&&0===f.found?c.tip("success",tl("com.SaveSuccessTip")):c.tip("error",tl("com.SaveConfigFailTip"))}).fail(function(){c.tip("error",tl("com.SaveConfigFailTip"))})}if(""!==b[0]){c.tip("success",tl("com.LoadingTip"),-1);var e=tl("com.Numbers")+"	"+tl("sys.UserName")+"	"+tl("com.Time")+"			"+tl("com.Type")+"	"+tl("com.Content")+"\r\n";m.WriteFile(e,"w+",b[1]),d(0,10*o)}})},_find:function(a){var b=this;p=(a-1)*o,j.Integration.getLog(p,o).done(function(a){a.found?b._renderTable(a.items):b._renderTable()}).fail(function(){b._renderTable()})},_renderTable:function(a){var b=this;d.table("dataSource",a||[]),b._renderDetail(),a&&a.length>0&&(b.$("#lm_serachtip>span:eq(5)").text(a[0].Time),b.$("#lm_serachtip>span:eq(4)").text(a[a.length-1].Time))},_renderDetail:function(b){var c=this,d=c.$("#lm_logtime"),e=c.$("#lm_logtype"),f=c.$("#lm_loguser"),g=c.$("#lm_logcontent");d.text(b&&b.Time||""),e.text(b&&b.Type||""),f.text(b&&b.User||""),b&&b.Detail?"string"===a.type(b.Detail)?g.text(b.Detail):"object"===a.type(b.Detail)&&(g.empty(),a.each(b.Detail,function(b,c){a("<div></div>").text(b+": "+c).appendTo(g)})):g.text("")}})}),define("log_remote",function(require,a,b){var c=require("jsCore/rpc"),d=require("jsCore/pageBase"),e=null,f=null,g=null;$facility=null;var h=null,i=null;b.exports=d.extend({init:function(){h=this,e=h.$("#log_remote_ip").ipfield(),f=h.$("#log_remote_port").numberfield({max:65534,min:1,allowDecimal:!1,allowNegative:!1}),$facility=h.$("#log_remote_facility").numberfield({max:23,min:0,allowDecimal:!1,allowNegative:!1}),g=h.$("#log_remote_enable"),h.render()},render:function(){this._getConfig(!1)},_getConfig:function(a){c.ConfigManager.getConfig("Syslog").done(function(b){b?(i=b,g.prop("checked",b.Enable),f.numberfield("value",b.Port),e.ipfield("value",b.Server),$facility.numberfield("value",b.Facility),a&&h.tip("success",tl("com.OperateSuccessTip"))):a&&h.tip("error",tl("com.OperateFailTip")),h.disabled(h.$("[btn-for=onSave]"),!b)}).fail(function(){a&&h.tip("error",tl("com.OperateFailTip")),h.disabled(h.$("[btn-for=onSave]"),!0)})},onDefault:function(){c.ConfigManager.getDefault("Syslog").done(function(a){i=a,g.prop("checked",a.Enable),f.numberfield("value",a.Port),e.ipfield("value",a.Server),$facility.numberfield("value",a.Facility),h.tip("success",tl("com.DefaultSuccessTip"))}).fail(function(){h.tip("error",tl("com.DefaultfailureTip"))})},onRefresh:function(){return this._getConfig(!0),!1},onSave:function(){return i.Enable=g.prop("checked"),i.Port=f.numberfield("value"),i.Server=e.ipfield("value"),i.Facility=$facility.numberfield("value"),c.ConfigManager.setConfig("Syslog",i).done(function(){h.tip("success",tl("com.SaveSuccessTip"))}).fail(function(){h.tip("error",tl("com.SaveConfigFailTip"))}),!1}})})}(jQuery);