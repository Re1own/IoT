!function(a){define(function(require,b,c){function d(a,b,c,d,e,f){return a+"-"+b+"-"+c+" "+d+":"+e+":"+f}function e(a,b,c,d,e,f,g,h){var i,j,m=l(a,b),n=d+g*h,o=(n/24).floor(),p=n%24,q=c+o>m?c+o-m:c+o,r=c+o>m?b+1:b;r=r>12?r-12:r;var s=r>12?a+1:a,t=q+1>m?q+1-m:q+1,u=q+1>m?r+1:r;u=r>12?r-12:r;var v=r>12?s+1:s;r=k(r),q=k(q),u=k(u),t=k(t);var w,x,y,z;if(1==h){var A=e+30>=60?e+30-60:e+30;w=e+30>=60?p+1:p,w=w>=24?w-24:w;var B=p+1>=24?p+1-24:p+1;j=p>=23?s+"-"+r+"-"+q+"~"+v+"-"+u+"-"+t:s+"-"+r+"-"+q,x=k(p)+":"+k(e)+":"+k(f),y=k(w)+":"+k(A)+":"+k(f),z=k(B)+":"+k(e)+":"+k(f),i=[],i.push(x,y,z)}else j=s+"-"+r+"-"+q+"~"+v+"-"+u+"-"+t,w=p+12>=24?p+12-24:p+12,x=k(p)+":"+k(e)+":"+k(f),y=k(w)+":"+k(e)+":"+k(f),z=k(p)+":"+k(e)+":"+k(f),i=[],i.push(x,y,z);var C=[];return C[0]=i,C[1]=j,C}function f(a,b,c,e,f,i,j,k){var l;switch(k){case 5:l=5;break;case 10:l=5;break;case 15:l=4;break;case 30:l=4}var m=g(a,b,c,e,f,i,j,k),n=h(e,f,i,0,k,db),o=h(e,f,i,l,k,db),p=d(m[0][0],m[0][1],m[0][2],n[0],n[1],n[2]),q=d(m[1][0],m[1][1],m[1][2],o[0],o[1],o[2]);return[p,q]}function g(a,b,c,d,e,f,g,h){var i;switch(h){case 5:i=5;break;case 10:i=10;break;case 15:i=12;break;case 30:i=24}var j=l(a,b),k=d+g*i,m=(k/24).floor(),n=k%24,o=c+m>j?c+m-j:c+m,p=c+m>j?b+1:b;p=p>12?p-12:p;var q=p>12?a+1:a,r=o+1>j?o+1-j:o+1,s=o+1>j?p+1:p;s=s>12?s-12:s;var t=s>12?q+1:q;switch(h){case 5:return 0===e&&0===f?n>=19?[[q,p,o],[t,s,r]]:[[q,p,o],[q,p,o]]:n>18?[[q,p,o],[t,s,r]]:[[q,p,o],[q,p,o]];case 10:return 0===e&&0===f?n>=14?[[q,p,o],[t,s,r]]:[[q,p,o],[q,p,o]]:n>13?[[q,p,o],[t,s,r]]:[[q,p,o],[q,p,o]];case 15:return 0===e&&0===f?n>=12?[[q,p,o],[t,s,r]]:[[q,p,o],[q,p,o]]:n>11?[[q,p,o],[t,s,r]]:[[q,p,o],[q,p,o]];case 30:return 0===e&&0===f?n>=0?[[q,p,o],[t,s,r]]:[[q,p,o],[q,p,o]]:[[q,p,o],[t,s,r]]}}function h(a,b,c,d,e,f){var g,h,i;switch(e){case 5:g=1,h=5;break;case 10:g=2,h=10;break;case 15:g=3,h=12;break;case 30:g=6,h=24}for(var j=a+h*f;j>24;)j-=24;a=j;var k=Math.floor((a+d*g)/24);return i=0===b&&0===c?a+d*g>=24?a+d*g-24*k:a+d*g:a+d*g>=24?a+d*g-24*k:a+d*g,[i,b,c]}function k(a){return 10>a?a="0"+a:a}function l(a,b){function c(a){return a%100===0&&a%400===0||a%100!==0&&a%4===0?!0:!1}return 4==b||6==b||9==b||11==b?30:2==b&&c(a)?29:2!=b||c(a)?31:28}function m(a){for(var b=a[0],c=a[0],d=1;d<a.length;d++){var e=a[d];c=Math.max(c,e),b=Math.min(b,e)}return[o(b,-1),n(c,-1)]}function n(a,b){var c=Math.pow(10,b||0);return Math.ceil(a*c)/c}function o(a,b){var c=Math.pow(10,b||0);return Math.floor(a*c)/c}var p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q,R,S,T,U,V,W=require("jsCore/rpc"),X=(require("jsCore/ability"),require("common/common"),require("jsCore/pageBase")),Y=["#1db806","#0284fe","#ffa800","#d031ff","#00fff5","#ff2523","#fe7e01","#ccff02","#ffff00","#0000ff","#34346c","#5b31aa","#a52cb7","#ea1ebc","#0cfc00"],Z=-1,$="ºC",_=[],ab=0,bb={},cb=!0,db=0,eb=[],fb=[],gb=[],hb=null,ib=null,jb=null,kb=[],lb=null,mb=null,nb=!1,ob=!1,pb=!1,qb=null,rb=0;require("/jsCore/raphael.js"),c.exports=X.extend({init:function(){qb=this,S=qb.$("#rep_st_date").datepicker({change:function(a,b){U.datepicker("minDate",b.value)}}),T=qb.$("#rep_st_time").timefield(),U=qb.$("#rep_en_date").datepicker(),V=qb.$("#rep_en_time").timefield(),qb._renderCanvas(),qb.bind(),qb.render(),qb.translate()},translate:function(){qb=this,a("#report_page").translation()},bind:function(){qb=this,a("#report_search").on("click",qb._onSearchClick),a("#report_slider_left").on("click",qb._onLeftClick),a("#report_slider_right").on("click",qb._onRigClick)},render:function(){qb=this,rb=webApp.CHANNEL_NUMBER>1?1:0,N=a("#report_rules"),O=a("#report_select"),S.datepicker("format","yyyy-mm-dd"),U.datepicker("format","yyyy-mm-dd"),T.timefield("format","24"),V.timefield("format","24");var b=new Date;S.datepicker("value",b.addDays(-1)),T.timefield("value",b.getHours()+":"+b.getMinutes()+":"+b.getSeconds()),U.datepicker("value",b.addDays(1)),V.timefield("value",b.getHours()+":"+b.getMinutes()+":"+b.getSeconds()),a(".report-slider").css("display","none")},leave:function(){qb=this,a("#RreportForm")&&(a("#RreportForm").addClass("bg"),qb._clearPaper(),qb._clearPath())},_renderCanvas:function(){qb=this,a("#report_paper").innerHTML="",L={title:tl("com.HistoryReport"),color:"#5c5c5c",paper:Raphael("report_paper",900,700)},a("#RreportForm").translation(),a("#report_paperData").innerHTML="",M={title:tl("com.HistoryReport"),color:"#5c5c5c",fill:"#FF0000",paper:Raphael("report_paperData",800,600)}},_getData:function(){r>0&&(cb=!1,a("#report_slider_left,#report_slider_right").off("click"),_[db]?qb._filterData(_[db]):(_[db]=[],qb._getNextData("Spot").done(function(a){_[db].combine(a),qb._getNextData("Line").done(function(a){_[db].combine(a),qb._getNextData("Area").done(function(a){_[db].combine(a),qb._filterData(_[db])})})})))},_getNextData:function(b){var c,e={},g=[];return 0===db&&1===r?(e.StartTime=d(t,u,v,w,x,y),e.EndTime=d(z,A,B,C,D,E)):r>db+1?(c=f(t,u,v,w,x,y,db,q),e.StartTime=c[0],e.EndTime=c[1]):db+1==r&&(c=f(t,u,v,w,x,y,db,q),e.StartTime=c[0],e.EndTime=d(z,A,B,C,D,E)),e.channel=rb,e.Period=q,e.Type=b,QueryCondition1=JSON.stringify(e),a.Deferred(function(a){return!nb&&"Spot"===b||!ob&&"Line"===b||!pb&&"Area"===b?void a.resolve(g):void W.RadiometryManager.startFind(e).done(function(b){Z=b.params.token,p=b.params.totalCount,W.RadiometryManager.doFind(Z,0,p).done(function(b){g=g.combine(b.params.info?b.params.info:[]),W.RadiometryManager.stopFind(Z).done(function(){a.resolve(g)}).fail(function(){a.reject()})}).fail(function(){a.reject()})}).fail(function(){a.reject()})}).promise()},_filterData:function(b){qb=this,a("#report_slider_left").on("click",qb._onLeftClick),a("#report_slider_right").on("click",qb._onRigClick);l(t,u);if(b){var c=db;eb[c]&&(eb[c]={}),fb[c]&&fb[c].empty(),gb[c]&&gb[c].empty(),a.each(b,function(a,b){eb[c]||(eb[c]={}),eb[c][b.PresetId]||(eb[c][b.PresetId]=[]),fb[c]||(fb[c]=[]);var d=fb[c].indexOf(b.PresetId);-1==d&&(fb[c].push(b.PresetId),fb[c].sort()),gb[c]||(gb[c]=[]),gb[c].push(b.QueryTemperInfo.TemperAve);var e=qb._addItem(b);if(0===eb[c][b.PresetId].length)eb[c][b.PresetId].push(e);else{var f=!1;for(i=0;i<eb[c][b.PresetId].length;i++){var g=eb[c][b.PresetId][i];if(g.Name==b.Name&&g.RuleId==b.RuleId&&g.Type==b.Type)return g.data.push(b.QueryTemperInfo.TemperAve.round(2)),g.time.push(qb._howmanySteps(b.Time)),void(f=!0);if(f)break}if(f)return;eb[c][b.PresetId].push(e)}}),qb._renderChart()}},_howmanySteps:function(a){qb=this;var b,c=a.split(" "),d=l(t,u),e=c[0].split("-"),f=c[1].split(":"),g=e[0].replace(/[^\d]/g,"")-0,h=e[1]-0,i=e[2]-0,j=f[0]-0,k=f[1]-0,m=0;return b=60*(60*(365*(g-t)*24+(h-u)*d*24+24*(i-v)+(j-w))+(k-x))+m-y},_addItem:function(a){qb=this;var b=qb._howmanySteps(a.Time),c={};return c.data=[],c.data.push(a.QueryTemperInfo.TemperAve.round(2)),c.time=[],c.time.push(b),c.Name=a.Name,c.RuleId=a.RuleId,c.PresetId=a.PresetId,c.Type=a.Type,c},_renderChart:function(){qb=this,qb._ChartScale(),qb._ChartPreset(),qb._ChartLabel(),qb._ChartData()},_ChartStatic:function(){qb=this,lb=[],mb=[],a("#RreportForm").removeClass("bg"),a(".report-slider").css("display","");var b=L,c=b.paper,d="",e=c.text(420,20,b.title).attr({"font-size":"18px","font-weight":"bold",fill:b.color,"text-anchor":"start"});mb.push(e);var f="M10 44 L880 44",g="M10 45 L880 45";c.path(f).attr({stroke:"#bcbcbc","stroke-width":"1px",width:1}),c.path(g).attr({stroke:"#ffffff","stroke-width":"1px",width:1}),lb.push(f),lb.push(g),W.ConfigManager.getConfig("HeatImagingThermometry").done(function(a){bb=a,$="Centigrade"==bb.TemperatureUnit?"°C":"°F";var d=c.text(35,80,$).attr({fill:b.color,"font-size":"12px"});mb.push(d)});var h;for(i=0;i<10;i++){var j=600-50*i;h+="M35 "+j+" L40 "+j}var k=c.path(h).attr({stroke:b.color,"stroke-width":"1px",width:1});lb.push(k);var l,m;if(5==q||10==q)for(i=1;i<61;i++)m=36+12*i,l+=i%12===0?"M"+m+" 640 L"+m+" 650":"M"+m+" 645 L"+m+" 650";else for(i=1;i<49;i++)m=36+15*i,l+=i%12===0?"M"+m+" 640 L"+m+" 650":"M"+m+" 645 L"+m+" 650";var n=c.path(l).attr({stroke:b.color,"stroke-width":"1px",width:1});lb.push(n);var o=c.text(845,650,tl("com.Hour")).attr({fill:b.color,"font-size":"12px","text-anchor":"start"});mb.push(o),d+="M35 100 l0 550",d+="M35 650 l780 0 ";var p=c.path(d).attr({stroke:b.color,"stroke-width":"1px",width:1});lb.push(p),Raphael.svg&&p.translate(.5,.5)},_ChartScale:function(){qb=this,jb&&jb.length>0&&jb.each(function(a){a.remove()}),jb=[];var a=L,b=a.paper;gb||(gb=[]),gb[db]&&0!==gb[db].length||(gb[db]=[0,100]);var c=m(gb[db]);0===c[0]&&0===c[1]&&(c=[0,100]);var d;for(i=0;i<11;i++){d=(c[1]-c[0])/10;var f=b.text(23,650-50*i,c[0]+d*i).attr({fill:a.color,"font-size":"12px"});jb.push(f)}R=50/d;{var j,l,n,o;e(t,u,v,w,x,y,db,q)}switch(q){case 5:for(Q=.04,i=0;i<6;i++)j=12*i*12,l=h(w,x,y,i,q,db),n=l[0]+":"+k(l[1])+":"+k(l[2]),o=b.text(36+j,660,n).attr({fill:a.color,"font-size":"12px"}),jb.push(o);break;case 10:for(Q=.02,i=0;i<6;i++)l=h(w,x,y,i,q,db),n=l[0]+":"+k(l[1])+":"+k(l[2]),j=12*i*12,o=b.text(36+j,660,n).attr({fill:a.color,"font-size":"12px"}),jb.push(o);break;case 15:for(Q=15/900,i=0;i<5;i++)l=h(w,x,y,i,q,db),n=l[0]+":"+k(l[1])+":"+k(l[2]),j=15*i*12,o=b.text(36+j,660,n).attr({fill:a.color,"font-size":"12px"}),jb.push(o);break;case 30:for(Q=15/1800,i=0;i<5;i++)j=15*i*12,l=h(w,x,y,i,q,db),n=l[0]+":"+k(l[1])+":"+k(l[2]),o=b.text(36+j,660,n).attr({fill:a.color,"font-size":"12px"}),jb.push(o)}var p=g(t,u,v,w,x,y,db,q);p=p[0].join()==p[1].join()?p[0][0]+"-"+p[0][1]+"-"+p[0][2]:p[0][0]+"-"+p[0][1]+"-"+p[0][2]+" ~ "+p[1][0]+"-"+p[1][1]+"-"+p[1][2];var s=b.text(120,680,p).attr({fill:a.color,"font-size":"12px"});jb.push(s);var z=db+1+"/"+r+"("+tl("com.Page")+")",A=b.text(395,680,z).attr({fill:a.color,"font-size":"12px"});jb.push(A)},_ChartPreset:function(){if(O.html(""),fb[db]&&0!==fb[db].length){var b='<label class="ui-sub-label fn-padr10">'+tl("ivs.Preset")+'</label><select class="fn-width40" id="report_selectBOX"></select>';for(O.html(b),a("#report_selectBOX").empty(),i=0;i<fb[db].length;i++)a("#report_selectBOX").append("<option value="+fb[db][i]+">"+fb[db][i]+"</option>");a("#report_selectBOX").on("change",qb._changePreset),P?fb[db].indexOf(P)<0&&(P=fb[db][0]):P=fb[db][0],a("#report_selectBOX").val(P)}},_ChartLabel:function(){if(qb=this,N.html(""),fb[db]&&0!==fb[db].length){var b="";for(i=0;i<eb[db][P].length;i++){{var c=eb[db][P][i];Y[i]}b+='<li><input type="checkbox" checked = "true" class="reportrule-enable" id="reportrule_enable'+i+'"/><i class="reportrule-color" id="reportrule_color" style="background:'+Y[i]+'"></i><span title='+c.Name+' class="reportrule-name">'+c.Name+"</span></li>"}N.html(b),a(".reportrule-enable").on("click",function(){var a=this.id.replace(/[^\d]/g,"");qb._displayRule(a)})}},_ChartData:function(){qb=this;var b,c;switch(q){case 5:b=5,c=1;break;case 10:b=10,c=2;break;case 15:b=12,c=3;break;case 30:b=24,c=6}if(ib&&ib.length>0&&a.each(ib,function(b,c){c.remove(),a.each(hb[b],function(a,b){b.remove()})}),ib=[],hb=[],fb[db]&&0!==fb[db].length){var d=M,e=d.paper;for(i=0;i<eb[db][P].length;i++){{var f=(eb[db][P][i],eb[db][P][i].data),g=eb[db][P][i].time;Y[i]}if(a("reportrule_enable"+i).checked){var h="",k=[];for(j=0;j<f.length;j++){var l=g[j],n=f[j],o=4+(l-db*b*60*60)*Q,p=m(gb[db]),r=510-(n-p[0])*R;h+=0===j?"M"+o+" "+r+" ":"L"+o+" "+r+" ";var s,t,u=d.paper.circle(o,r,3).attr({fill:Y[i],stroke:Y[i],"stroke-width":"1","z-index":"10000",opacity:"1",cursor:"pointer"}).data({data:n,X:o,Y:r,C:Y[i]}).hover(function(){kb.each(function(a){a.remove()}),kb=[],t=e.rect(this.data("X")+8,this.data("Y")-10,40,20,1).attr({fill:"#5c5c5c",stroke:"#333","stroke-width":"0.5"}),kb.push(t),s=e.text(this.data("X")+25,this.data("Y"),this.data("data")).attr({fill:"#FFFFFF","font-size":"12px"}),kb.push(s)},function(){setTimeout(function(){s&&(s.remove(),t.remove()),s="",t=""},0)});k.push(u)}var v=d.paper.path(h).attr({stroke:Y[i],"stroke-width":1,opacity:"1","z-index":"10"});ib.push(v),hb.push(k)}}}},_displayRule:function(b){a("#reportrule_enable"+b).prop("checked")?(ib[b].show(),a.each(hb[b],function(a,b){b.show()}),a.each(hb[b],function(a,b){b.show()})):(ib[b].hide(),a.each(hb[b],function(a,b){b.hide()}))},_changePreset:function(){P=a("#report_selectBOX").val()-0,qb._ChartLabel(),qb._ChartData()},_onLeftClick:function(){0>=db||(qb._clearPath(),db--,qb._getData())},_onRigClick:function(){r-1>db&&(qb._clearPath(),db++,qb._getData())},_onSearchClick:function(){N.innerHTML="",O.innerHTML="",_=[],db=0,cb=!0,qb._clearPaper(),qb._checkDate(),qb._viewPeriod(),(nb!==!1||ob!==!1||pb!==!1)&&(qb._renderCanvas(),qb._ChartStatic(),qb._getData())},_onTimeIntervalControl:function(b,c){qb=this;var d=!1;if(!(a("#report_end_date0").val()==a("#report_begin_date0").val()&&(a("#report_end_date1").val()==a("#report_begin_date1").val()&&(d=a("#report_end_date2").val()-0>a("#report_begin_date2").val()-0?!0:!1),a("#report_end_date1").val()-0>a("#report_begin_date1").val()-0)||a("#report_end_date0").val()-0>a("#report_begin_date0").val()-0||(a("#report_end_time0").val()-0<a("#report_begin_time0").val()-0&&(d||(a("#report_end_time0").val(a("#report_begin_time0").val()),a("#report_end_time1").val(a("#report_begin_time1").val()),a("#report_end_time2").val(a("#report_begin_time2").val()),a("#report_end_date2").val(a("#report_begin_date2").val()))),d))){a("#"+c+"0").val()-0<=a("#"+b+"0").val()-0&&(a("#"+c+"0").val(a("#"+b+"0").val()),a("#"+c+"1").val()-0<=a("#"+b+"1").val()-0&&(a("#"+c+"1").val(a("#"+b+"1").val()),a("#"+c+"2").val()-0<a("#"+b+"2").val()-0&&a("#"+c+"2").val(a("#"+b+"2").val()))),"report_begin_date"==b&&a("#"+b+"0").val()==a("#"+c+"0").val()&&a("#"+b+"1").val()==a("#"+c+"1").val()&&a("#"+b+"2").val()==a("#"+c+"2").val()&&(a("#report_end_time0").val()-0<a("#report_begin_time0").val()-0&&a("#report_end_time0").val(a("#report_begin_time0").val()),a("#report_end_time1").val()-0<a("#report_begin_time1").val()-0&&a("#report_end_time1").val(a("#report_begin_time1").val()),a("#report_end_time2").val()-0<a("#report_begin_time2").val()-0&&a("#report_end_time2").val(a("#report_begin_time2").val()));for(var e=0;3>e;e++)1==a("#"+b+e).val().length&&a("#"+b+e).val(0+a("#"+b+e).val()),1==a("#"+c+e).val().length&&a("#"+c+e).val(0+a("#"+c+e).val())}},_checkDate:function(){qb=this;var a=(S.datepicker("value")+" "+T.timefield("value"),U.datepicker("value")+" "+V.timefield("value"),S.datepicker("value").split("-")),b=U.datepicker("value").split("-");t=parseInt(a[0]),u=parseInt(a[1]),v=parseInt(a[2]),z=parseInt(b[0]),A=parseInt(b[1]),B=parseInt(b[2]);var c=T.timefield("value").split(":"),d=V.timefield("value").split(":");w=parseInt(c[0]),x=parseInt(c[1]),y=parseInt(c[2]),C=parseInt(d[0]),D=parseInt(d[1]),E=parseInt(d[2]),s=w,F=t,G=u,H=v,I=w,J=x,K=y},_howmanyPages:function(){qb=this;var a=l(t,u),b=z-t,c=A-u,d=B-v,e=C-w,f=D-x,g=E-y,h=365*b*24*60*60+c*a*24*60*60+24*d*60*60+60*e*60+60*f+g;r=5==q||10==q?(h/(60*q*60)).ceil():(h/(q/15*12*60*60)).ceil()},_viewPeriod:function(){q=a("#report_periodN").val()-0,nb=a("#report_spot").prop("checked"),ob=a("#report_line").prop("checked"),pb=a("#report_area").prop("checked"),qb._howmanyPages()},_onChangePeriod:function(){qb=this,qb._viewPeriod(),cb||(qb._clearPath(),db=0,qb._howmanyPages(),qb._renderCanvas(),qb._ChartStatic(),1==q&&qb._filterData(_[db]))},_clearPaper:function(){qb=this,L.paper&&L.paper.remove(),M.paper&&M.paper.remove(),cb=!0,db=0,ab=0,eb=[],fb=[],gb=[],hb=null,ib=null,jb=null},_clearPath:function(){qb=this,jb&&a.each(jb,function(a,b){b.remove()}),jb=[],O.innerHTML="",N.innerHTML="",ib&&ib.length>0&&a.each(ib,function(b,c){c.remove(),a.each(hb[b],function(a,b){b.remove()})}),ib=[],hb=[]}})})}(jQuery);