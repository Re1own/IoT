!function(a){define(function(require,b,c){c.exports=require("jsCore/pageTab"),c.exports.prototype.face_Analysis=c.exports.prototype.face_alarmLink=ability.get("IVSCaps").then(function(b){return b&&-1!==a.inArray("FaceAnalysis",b.SupportedScene)}),c.exports.prototype.face_find=a.when(ability.get("FaceDetection"),ability.get("FaceAnalysis")).then(function(a,b){return a&&a.HistoryDataFindSupport||b&&b.HistoryDataFindSupport})}),define("ipc_face",function(require,b,c){function d(b){for(var c=0;c<b.length;c++)if(a.isArray(b[c])){if(!d(b[c]))return!1}else if(0!==b[c])return!1;return!0}function e(b){var c=a.extend(!0,[],b);return 2===b.length?[c[0],[c[0][0],c[1][1]],c[1],[c[1][0],c[0][1]]]:4===b.length?[c[0],c[2]]:void 0}var f=require("jsCore/rpc"),g=require("jsCore/pageBase"),h=require("jsCore/plugin"),i=require("jsCore/pluginCanvas"),j=require("jsCore/rpcLogin"),k=require("jsCore/ability"),l=require("jsCore/modules/timeSection"),m=require("jsCore/modules/IntellMutex"),n=require("common/common");require("widget/js/dui.slider"),require("jsCore/modules/eventHandler");var o,p=require("jsCore/hlsplayer"),q=require("jsCore/flashplayer"),r=require("jsCore/h5player"),s=null,t=null,u=null,v=null,w=null,x=null,y=!1,z=!0,A=null,B=null,C=null,D=[],E=!1,F=0,G=!1,H=null,I=null,J=0,K=null,L=!1,M="FaceDetection",N="FaceDetection",O=null,P=!0,Q={},R=!0,S={},T={},U=null,V=!1,W=null,X=null,Y=null,Z=!1,$=null,_=[],ab={rect:null,max:4,curShapeID:0,length:0,render:a.noop,leave:a.noop,save:a.noop,clear:a.noop};c.exports=g.extend({init:function(){if(s=this,K=s.$("#faceAttr_dialog").dialog({zIndex:10003,confirm:function(b,c){h.cover("#i_f_video");var d=[];K.find("#attr_list input:checked").each(function(){d.push(a(this).val())}),u.Config.FeatureList=d,c.ui.close()},cancel:function(){h.cover("#i_f_video")},close:function(){h.cover("#i_f_video")}}).detach().appendTo(document.body),K.delegate("#attr_list input","click",function(){var b=a(this).prop("checked"),c=K.find("[chk-for=chooseAllFeature]");c.prop("checked",b&&K.find("#attr_list input:checked").length==L)}),U=s.$("#faceadvancedSet_dialog").dialog({zIndex:10003,confirm:function(a,b){h.cover("#i_f_video"),b.ui.close()},cancelSet:function(a,b){X&&X.Scene&&X.Scene.Detail&&U.find("[cfg=VideoAnalyseGlobal][key=FaceAngleRight]").slider("value",X.Scene.Detail.FaceAngleRight),U.find("[cfg=VideoAnalyseModule][key=Sensitivity]").slider("value",I[F][J].Sensitivity),U.find("[cfg=VideoAnalyseRule][key=MinQuality]").slider("value",u.Config.MinQuality),U.find("#faceAdvancedSet_featureFilter").prop("checked",u.Config.FeatureFilter),U.find("#faceAdvancedSet_optimalTime").numberfield("value",H[0].OptimalTime),h.cover("#i_f_video"),b.ui.close()}}).detach().appendTo(document.body),U.find("[cfg=VideoAnalyseGlobal][key=FaceAngleRight]").slider({min:1,max:90}),U.find("[cfg=VideoAnalyseModule][key=Sensitivity]").slider({min:0,max:100}),U.find("[cfg=VideoAnalyseRule][key=MinQuality]").slider({min:1,max:100}),U.find("#faceAdvancedSet_optimalTime").numberfield({min:1,max:300,allowDecimal:!1,allowNegative:!1}),k.get("IVSCaps").done(function(b){O=b,-1!==a.inArray("FaceAnalysis",b.SupportedScene)?(M="FaceAnalysis",N="FaceAnalysis",U.find("#faceAdvancedSet_quality").hide()):-1!==a.inArray("SDFaceDetect",b.SupportedScene)&&(M="SDFaceDetect");var c=b.SupportedScenes[M].SupportedRules,d=c&&c[N];if(d&&d.FeatureSupport){var e=d.FeatureList||[];L=e.length;var f="";a.each(e,function(a,b){f+='<label class="ui-label"><input type="checkbox" value="'+b+'" /><span t='+b+"></span></label>"}),K.find("#attr_list").html(f).translation()}else s.$("#i_face_attr_wrap").hide();if(d&&d.FaceFilterSupport&&(V=!0,s.$(".advancedSet").removeClass("fn-hide")),d&&d.SnapPolicy){_=d.SnapPolicy,h=s.$("#i_face_snap").empty();for(var g=0;g<_.length;g++)h.append('<option value="'+_[g]+'" t="ivs.'+_[g]+'"></option>').translation()}else{var h=s.$("#i_face_snap").empty();h.append('<option value="Realtime" t="ivs.Realtime">Realtime</option><option value="Optimal" t="ivs.Optimal">Optimal</option>').translation()}}),webCaps.draw_FaceDetectRegion&&s.$("[btn-for=onDrawRule]").parent("div").show(),t=new m("i_f_mutex"),webApp.EventCaps?f.EventManager.getEventLink(N).done(function(b){var c=b.name,d=a.extend({},webApp.DefaultEvent),e=webApp.EventCaps;"default"===c[F][0]?d=e:c[F].each(function(a){d[a]=!0,"AlarmOutEnable"===a?d.AlarmOutLatch=e.AlarmOutLatch:"DejitterEnable"===a?d.DejitterRange=e.DejitterRange:"RecordEnable"===a&&(d.RecordLatch=e.RecordLatch)}),s.$("#i_f_event").eventHandler(d)}).fail(function(){s.$("#i_f_event").eventHandler()}):s.$("#i_f_event").eventHandler(),s.$("#i_f_alacount").numberfield({min:1,max:35,allowDecimal:!1,allowNegative:!1}),s.$("#i_f_t_value").numberfield({min:0,max:100,allowDecimal:!1,allowNegative:!1}),s.$("#i_f_delayBlur").numberfield({min:10,max:100,allowDecimal:!1,allowNegative:!1}),k.get("VideoInputCapsEx").done(function(a){a&&a.FaceAutoExposure&&a.FaceAutoExposure.Support&&(y=!0,s.$("#i_f_expo").show(),s.$("#i_f_expo_light, #i_f_expo_time").slider({min:0,max:100}),s.$("#i_f_expo_enable").on("click",function(){s.$(this).prop("checked")&&!s.$("#i_f_enable").prop("checked")&&s.$("#i_f_tip").tip("warning",tl("com.IsEnableFacetectTip"))}),s.$("#i_f_enable").on("click",function(){!s.$(this).prop("checked")&&s.$("#i_f_expo_enable").prop("checked")&&s.$("#i_f_tip").tip("warning",tl("com.IsDisableFacetect"))}))}),f.DevVideoEncode.getCaps().done(function(a){a&&a.DynamicTrackROI&&s.$("#i_f_enhance_wrap").removeClass("fn-hide")}),k.get("DynamicROI").done(function(b){b&&b.SupportMosaic?(a("#i_f_startOne").removeClass("fn-hide"),a("#i_f_startTwo").removeClass("fn-hide"),a("#i_f_delayBlur_max").html(b.MosaicDelayTime),s.$("#i_f_delayBlur").numberfield("max",b.MosaicDelayTime)):(a("#i_f_startOne").addClass("fn-hide"),a("#i_f_startTwo").addClass("fn-hide"))}),k.get(N).done(function(b){if(b){if(b.CutoutPolicy){var c=s.$("#i_face_swap").empty(),d="";a.each(b.CutoutPolicy,function(a,b){d="Original"===b?"ivs.Face":"ivs."+b,c.append("<option value="+b+" t="+d+"></option>")}),c.translation(),s.$("#i_face_swap_wrap").removeClass("fn-hide"),G=!0}b.SnapPolicy&&s.$("#i_face_snap_wrap").removeClass("fn-hide"),b.SupportTargetStack&&(Z=!0,s.$("#i_f_target_wrap").removeClass("fn-hide")),b.FilterUnAliveSuport?s.$("#i_f_alive_wrap").removeClass("fn-hide"):s.onChangeAlive=a.noop}}),webCaps.is_new_IVSUI!==!0){var b=m.getIntellMutexTip("FaceDetection",O||{});b&&(t.add("intell",b),t.setCtrl("intell",!0)),t.add("tvout",'<span t="com.IntellMutexTVOutTip">'+tl("com.IntellMutexTVOutTip")+"</span>")}-1!==webApp.DeviceType.indexOf("SD")&&-1===webApp.DeviceType.indexOf("TPC")&&(z=!1,s.$("#i_f_target").parent().hide().prev().hide()),s.$("#i_f_enable").on("click",function(){-1===webApp.DeviceType.indexOf("TPC")&&(u.Enable=this.checked,this.checked?t.show():(t.hide(),P=!0),h.SetIVSConfig("",1),s._initTarget())}),-1!==webApp.DeviceType.indexOf("TPC")?(f.VideoInAnalyse.getTemplateRule("All").done(function(a){A=-1!==webApp.DeviceType.indexOf("SD")?a.SDFaceDetect.FaceDetection.Config.SizeFilter:a.FaceDetection.FaceDetection.Config.SizeFilter}),s.$("#i_f_event").eventHandler({FaceSnapshot:!1}),s.$("#i_f_max").on("click",function(){s.$(this).prop("checked",!0),h.SelectOneIntelShape(D[1],!0),h.SelectOneIntelShape(D[0],!1),s._renderSizeFilter(u.Config.SizeFilter,!0)}),s.$("#i_f_min").on("click",function(){s.$(this).prop("checked",!0),h.SelectOneIntelShape(D[0],!0),h.SelectOneIntelShape(D[1],!1),s._renderSizeFilter(u.Config.SizeFilter,!0)}),s.$("#i_f_enhance").parent().parent().hide(),s.$("#i_f_alacount").parent().show()):(s.$("#i_f_max").on("click",function(){s.$(this).prop("checked",!0),s._targetRule()}),s.$("#i_f_min").on("click",function(){s.$(this).prop("checked",!0),s._targetRule()})),webCaps.draw_FaceExcludeRegion&&(s.$("[btn-for = onDrawExclude]").parent().show(),ab.render=function(){h.addEvent("VideoAnalyzeConfig",function(a){var b=JSON.parse(a),c=b.EventParam;"ExcludeEvent"===b.EventName&&3===c.ShapeState&&(ab.curShapeID=c.ShapeID,h.GetVideoAnalyseShapeConfigData(c.ShapeID).done(function(a){a=JSON.parse(a),ab.rect[c.ShapeID]=a[c.ShapeName]}))}),h.EnableVideoAnalyseModule(!0)},ab.leave=function(){h.SetVideoAnalyseContainerTip(0,""),h.DeleteAllVideoAnalyseShape(),h.EnableVideoAnalyseModule(!1),h.addEvent("VideoAnalyzeConfig",null)},ab.save=function(b){if(ab.rect){var c=[];a.each(ab.rect,function(a,b){b&&(c.push(b),"flash"===webApp.playMode||"h5"===webApp.playMode?i.EnableVideoAnalyseShape(s.containerId,a-0,!1):(h.SetVideoAnalyseContainerTip(0,""),h.EnableVideoAnalyseShape(a-0,!1)))}),b.ExcludeRegion=c}},ab.clear=function(){h.SetVideoAnalyseContainerTip(0,""),ab.rect=null,h.DeleteAllVideoAnalyseShape(),ab.length=0,ab.curShapeID=0},ab.draw=function(){ab.rect={};var b=I[F][J].ExcludeRegion||[];a.each(b,function(a,b){ab.length++,h.CreateMainVideoAnalyseShape(0,"ExcludeEvent","Polygon","Exclude",JSON.stringify({Exclude:b}),"").done(function(a){ab.rect[a]=b,ab.curShapeID=a})})}),s.bind(),f.FaceFlowStat.getCaps().done(function(a){a&&a.Support&&(Y={},s.$("[btn-for = onClearZero]").parent("div").removeClass("fn-hide"))}).always(function(){s.render()})},bind:function(){a("#i_f_enhance").on("click",function(){a(this).prop("checked")&&a("#i_f_blur").prop({checked:!1})}),a("#i_f_blur").on("click",function(){a(this).prop("checked")&&a("#i_f_enhance").prop({checked:!1})})},render:function(){if(webCaps.is_new_IVSUI!==!0&&t.setCtrl("tvout",g_videoInConflict.DSP.hasConflict()),"hls"==webApp.playMode)p.cover(s.$("#i_f_video")),h.hide(),p.init("","",""),p.beginPlay();else if("flash"==webApp.playMode||"h5"===webApp.playMode){S={},"flash"==webApp.playMode&&(q.cover(s.$("#i_f_video")),q.playPreview(1,0));var b=null;r&&"h5"===webApp.playMode&&(b=new a.Deferred,r.playPreview(1,0,s.$("#i_f_video"),null,b)),a.subscribe("DRectBig",function(b,c){u.Config.SizeFilter.MaxSize=a.extend(!0,[],c.data),Q.MaxSize=a.extend(!0,[],c.data),s._renderSizeFilter(u.Config.SizeFilter,!0),s.$("#i_f_max, #i_f_min").prop("disabled",!1)}),a.subscribe("DRectSmall",function(b,c){u.Config.SizeFilter.MinSize=a.extend(!0,[],c.data),Q.MinSize=a.extend(!0,[],c.data),s._renderSizeFilter(u.Config.SizeFilter,!0),s.$("#i_f_max, #i_f_min").prop("disabled",!1)}),a.subscribe("IVSRuleConfig",function(a,b){"RuleDetectRegion"===b.shapeName?(P=!0,I[F][J].DetectRegion=e(b.data)):"Polygon"===b.shapeName&&(ab.rect[1*b.shapeID]=b.data,ab.curShapeID=1*b.shapeID,i.SelectVideoAnalyseShape(s.containerId,1*b.shapeID,!0))});var c=function(){setTimeout(function(){i.cover("#i_f_video",webApp.resolution.x+"*"+webApp.resolution.y),s.containerId=i.CreateVideoAnalyseContainer(),s._getConfig(!1)},1e3)};"flash"==webApp.playMode?f.ConfigManager.getConfig(["Encode","VideoImageControl"]).done(function(a){if(webApp.resolution.x=a[0].params.table[0].MainFormat[0].Video.Width,webApp.resolution.y=a[0].params.table[0].MainFormat[0].Video.Height,1==a[1].params.table[0].Rotate90||2==a[1].params.table[0].Rotate90){var b;b=webApp.resolution.x,webApp.resolution.x=webApp.resolution.y,webApp.resolution.y=b}c()}):"h5"===webApp.playMode&&b&&b.done(function(a){webApp.resolution.x=a.width,webApp.resolution.y=a.height,c()})}else h.cover("#i_f_video",function(a){h.SetRegionNum(0),h.SetModuleMode(2),R=j.chkAuthority("Monitor_0"+(F+1)),-1!==webApp.DeviceType.indexOf("TPC")?R&&(h.SetVisibleVideoWnd(1,0),h.ConnectRealVideoEx(0,0,0)):h.open(),a&&s._getConfig(!1)}),-1!==webApp.DeviceType.indexOf("TPC")?(f.ConfigManager.getConfig(["HeatImagingThermometry","CalibratePoints"]).done(function(a){a&&a[0]&&"Centigrade"==a[0].params.table.TemperatureUnit?(s.$("#i_f_t_value").numberfield({min:0,max:100,allowDecimal:!1,allowNegative:!1}),s.$("#i_f_t_value").next("span").text("ºC (0~100)")):(s.$("#i_f_t_value").numberfield({min:32,max:212,allowDecimal:!1,allowNegative:!1}),s.$("#i_f_t_value").next("span").text("ºF (32~212)")),k.get("RadioMetry").done(function(b){b&&b.Support&&a[1].params.table.Enable?(E=!0,s.$("[thermal]").show()):s.$("[thermal]").hide()}),s._getConfig(!1)}),h.addEvent("VideoAnalyzeConfig",function(a){var b=JSON.parse(a),c=b.ShapeData.RectangleShape,d=b.EventParam.ShapeID,e=Math.abs(c[1][0]-c[0][0]),f=Math.abs(c[1][1]-c[0][1]);"BigFilter"==d?(u.Config.SizeFilter.MaxSize=[e,f],s.$("#i_f_max").prop("checked",!0)):(u.Config.SizeFilter.MinSize=[e,f],s.$("#i_f_min").prop("checked",!0)),h.SelectOneIntelShape(d,!0),s._renderSizeFilter(u.Config.SizeFilter,!0)})):(h.addEvent("OutPutStringInfo",function(a,b){var c=JSON.parse(b);"OutPutObjectRect"===a?webCaps.is_show_PixelCounter&&c.rect1?(T.width=c.rect1[0],T.height=c.rect1[1],s.$("[name=DetectSize-0]").numberfield("value",T.width),s.$("[name=DetectSize-1]").numberfield("value",T.height)):(c.MinRect?u.Config.SizeFilter.MinSize=c.MinRect:c.MaxRect&&(u.Config.SizeFilter.MaxSize=c.MaxRect),s._renderSizeFilter(u.Config.SizeFilter,!0),s.$("#i_f_max, #i_f_min").prop("disabled",!1)):"OutPutRuleRect"===a&&(P=!0,I[F][J].DetectRegion=e(c.OutPutRuleRect))}),ab.render(),s._getConfig(!1));webCaps.is_show_PixelCounter&&(-1!==webApp.DeviceType.indexOf("SD")&&-1===webApp.DeviceType.indexOf("TPC")?s.$("#i_f_detect").parent("div").hide():s.$("#i_f_detect").parent("div").show(),s.$("[name=DetectSize-0]").numberfield({min:0,max:webApp.resolution.x,allowDecimal:!0,allowNegative:!1}),s.$("[name=DetectSize-1]").numberfield({min:0,max:webApp.resolution.y,allowDecimal:!0,allowNegative:!1}),h.addEvent("ResolutionChangeIvs",function(){s.$("[name=DetectSize-0]").numberfield({min:0,max:webApp.resolution.x,allowDecimal:!0,allowNegative:!1}),s.$("[name=DetectSize-1]").numberfield({min:0,max:webApp.resolution.y,allowDecimal:!0,allowNegative:!1}),s.$("[name=DetectSize-0]").trigger("change"),s.$("[name=DetectSize-1]").trigger("change")}),a.subscribe("IVSRuleConfig",function(a,b){"PixelCount"===b.shapeName&&(T.width=b.data[1][0]-b.data[0][0],T.height=b.data[1][1]-b.data[0][1],s.$("[name=DetectSize-0]").numberfield("value",T.width),s.$("[name=DetectSize-1]").numberfield("value",T.height))}))},leave:function(){-1!==webApp.DeviceType.indexOf("TPC")?(h.addEvent("VideoAnalyzeConfig",null),B&&h.DeleteAllIntelShape(B)):(h.addEvent("OutPutStringInfo",null),h.addEvent("ResolutionChangeIvs",null),h.DeleteAllVideoAnalyseShape()),ab.leave(),h.SetIVSConfig("",0),h.hide(),h.close(),"flash"===webApp.playMode||"h5"===webApp.playMode?("h5"===webApp.playMode?r.hide():q.hide(),T={},Q={},i.hide(),a.unsubscribe("DRectBig",null),a.unsubscribe("DRectSmall",null),a.unsubscribe("IVSRuleConfig",null),i.DeleteAllVideoAnalyseShape(s.containerId)):"hls"===webApp.playMode&&p.hideAndStopLoad()},_getConfig:function(a){o=["VideoAnalyseRule","VideoEncodeROI"],E&&o.push("FaceRadiometry"),y&&o.push("VideoInFaceAutoExposure"),G&&o.push("FaceSnapshot"),(webCaps.draw_FaceDetectRegion||webCaps.draw_FaceExcludeRegion||V)&&o.push("VideoAnalyseModule"),V&&o.push("VideoAnalyseGlobal"),Y&&o.push("FaceFlowStat"),Z&&o.push("TargetStack"),f.ConfigManager.getConfig(o).done(function(b){n.chkMutilCallRet(b)?(s._renderElements(b),a&&s.$("#i_f_tip").tip("success",tl("com.OperateSuccessTip"))):s.$("#i_f_tip").tip("error",tl("com.OperateFailTip"))})},_renderElements:function(b,c){P=!0,Q={},S={},T={},ab.clear(),"flash"===webApp.playMode||"h5"===webApp.playMode?i.DeleteAllVideoAnalyseShape(s.containerId):(h.SetIVSConfig("",0),h.DeleteAllVideoAnalyseShape()),s.$("#i_f_max, #i_f_min").prop("disabled",!1);var d=b[0].params.table,e=analyseSenceRuleMap[N]||F;if(a.each(d[e],function(a,b){return b.Type===N?(u=b,!1):void 0}),u.Config.SizeFilter?Q=a.extend(!0,Q,u.Config.SizeFilter):(u.Config.SizeFilter={},-1!==webApp.DeviceType.indexOf("TPC")?(u.Config.SizeFilter.MinSize=A.MinSize,u.Config.SizeFilter.MaxSize=A.MaxSize):(u.Config.SizeFilter.MaxSize=[8191,8191],u.Config.SizeFilter.MinSize=[500,500]),Q={},Q.MaxSize=[8191,8191],Q.MinSize=[500,500]),s.$("#i_f_enable").prop("checked",u.Enable),s.$("#i_f_alacount").numberfield("value",u.Config.TriggerTargets||1),s.$("#i_f_event").eventHandler("set",u.EventHandler),s._renderSizeFilter(u.Config.SizeFilter),c===!1&&b[1]?(s.$("#i_f_enhance").prop("checked",b[1].params.table[0].DynamicTrack===!0),s.$("#i_f_blur").prop("checked",2===b[1].params.table[0].DynamicTrack),s.$("#i_f_delayBlur").numberfield("value",b[1].params.table[0].DynamicDelayTime)):(w=b[1].params.table,w[0].DynamicTrack&&(s.$("#i_f_enhance").prop("checked",w[0].DynamicTrack),s.$("#i_f_blur").prop({checked:!1})),w[0].DynamicTrack||(s.$("#i_f_enhance").prop("checked",!1),s.$("#i_f_blur").prop("checked",!1)),2==w[0].DynamicTrack&&(s.$("#i_f_enhance").prop("checked",!1),s.$("#i_f_blur").prop("checked",!0)),s.$("#i_f_delayBlur").numberfield("value",w[0].DynamicDelayTime)),E&&(x=b[o.indexOf("FaceRadiometry")].params.table,s.$("#i_f_t_enable").prop("checked",x[0].Enable),s.$("#i_f_t_value").numberfield("value",x[0].threshold||0)),y&&(v=b[o.indexOf("VideoInFaceAutoExposure")].params.table,s.$("#i_f_expo_enable").prop("checked",v[0].Enable),s.$("#i_f_expo_light").slider("value",v[0].TargetBrightness),s.$("#i_f_expo_time").slider("value",v[0].Interval)),G&&(H=b[o.indexOf("FaceSnapshot")].params.table,s.$("#i_face_swap").val(H[0].CutoutPolicy),s.$("#i_face_snap").val(H[0].SnapPolicy),"Quality"!==s.$("#i_face_snap").val()||u.Config.FeatureFilter||s.$("#i_f_tip").tip("warning",tl("ivs.PleaseSelectQuality"))),L&&(s.$("#i_face_attr").prop("checked",u.Config.FeatureEnable),s.$("#i_face_attr_wrap").toggleClass("fn-hide","Realtime"===H[F].SnapPolicy)),(webCaps.draw_FaceDetectRegion||webCaps.draw_FaceExcludeRegion||V)&&(I=b[o.indexOf("VideoAnalyseModule")].params.table,a.each(I[F],function(a,b){b.Type===N&&(J=a)})),V){if(c===!1){var f=b[o.indexOf("VideoAnalyseGlobal")].params.table,g=f[F]&&f[F].Scene;g&&g.Detail&&U.find("[cfg=VideoAnalyseGlobal][key=FaceAngleRight]").slider("value",g.Detail.FaceAngleRight)}else W=b[o.indexOf("VideoAnalyseGlobal")].params.table,X=W[F],X&&X.Scene&&X.Scene.Detail&&U.find("[cfg=VideoAnalyseGlobal][key=FaceAngleRight]").slider("value",X.Scene.Detail.FaceAngleRight);U.find("[cfg=VideoAnalyseModule][key=Sensitivity]").slider("value",I[F][J].Sensitivity),U.find("[cfg=VideoAnalyseRule][key=MinQuality]").slider("value",u.Config.MinQuality),U.find("#faceAdvancedSet_featureFilter").prop("checked",u.Config.FeatureFilter),U.find("#faceAdvancedSet_optimalTime").numberfield("value",H[0].OptimalTime)}if(Y&&(Y=b[o.indexOf("FaceFlowStat")].params.table,s.$("#i_f_osdenable").prop("checked",Y[F].EncodeBlend)),Z){var j=b[o.indexOf("TargetStack")].params.table;c!==!1&&($=j),a.each(j[F],function(a,b){return b.Type===M?(s.$("#i_f_target_enable").prop("checked",!!b.Stack),!1):void 0})}s.onChangeAlive()},onChangeAlive:function(b){var c,d=s.$("#i_face_snap"),e=d.val();b?(c=a(b.target).prop("checked"),u.Config.FilterUnAliveEnable=c):(c=u.Config.FilterUnAliveEnable,s.$("#i_f_alive_enable").prop("checked",c)),d.empty(),a.each(_,function(a,b){c&&"Realtime"===b||s.$("#i_face_snap").append('<option value="'+b+'" t="ivs.'+b+'"></option>')}),d.translation(),c&&(b&&s.$("#i_f_tip").tip("error",tl("ivs.AliveTip"),4e3),"Realtime"===e&&(e="Optimal")),d.val(e).change()},_renderSizeFilter:function(b,c){z&&(c||s._initTarget(),a.each(s.$("#i_f_target").find("input[type=text]"),function(a,c){var d=c.name.split("-");s.$(this).val(b[d[0]][parseInt(d[1])])}))},onClearZero:function(){f.FaceFlowStat.clearOSD()},onDrawRule:function(){if(s.$("#i_f_enable").prop("checked")&&R)if("flash"===webApp.playMode||"h5"===webApp.playMode){i.showMult=!1,i.ToggleVisibilityOfVideoAnalyseShape(s.containerId,!1);var a=I[F][J].DetectRegion;S.ShapeId&&d(a)?(i.RedrawVideoAnalyseShape(s.containerId,S.ShapeId),i.fillText(tl("com.DrawRectTip"),[100,100])):S.ShapeId&&!d(a)?(i.SetVideoAnalyseShapeConfig(s.containerId,S.ShapeId,e(a)),i.ShowVideoAnalyseShape(s.containerId,S.ShapeId,!0),i.EnableVideoAnalyseShape(s.containerId,S.ShapeId,!0)):!S.ShapeId&&d(a)?(S.ShapeId=i.CreateMainVideoAnalyseShape(s.containerId,"RuleDetectRegion",null),i.fillText(tl("com.DrawRectTip"),[100,100])):S.ShapeId||d(a)||(S.ShapeId=i.CreateMainVideoAnalyseShape(s.containerId,"RuleDetectRegion",e(a)),i.EnableVideoAnalyseShape(s.containerId,S.ShapeId,!0))}else webCaps.is_show_PixelCounter&&h.DeleteShape("rect1"),h.DeleteShape("MaxRect"),h.DeleteShape("MinRect"),s.hideExclude(),h.SetVideoAnalyseContainerTip(0,""),h.DeleteShape("RuleRect"),d(e(I[F][J].DetectRegion))?h.AddShape(6,"","RuleRect",0,0):(h.SetObjectConfig(JSON.stringify({RuleRect:e(I[F][J].DetectRegion)})),h.SetCurShape("RuleRect"))},onDrawClear:function(){s.$("#i_f_enable").prop("checked")&&R&&(webCaps.is_show_PixelCounter&&h.DeleteShape("rect1"),I[F][J].DetectRegion=[[0,0],[0,0],[0,0],[0,0]],"flash"===webApp.playMode||"h5"===webApp.playMode?(i.showMult=!1,S.ShapeId&&i.DeleteVideoAnalyseShape(s.containerId,S.ShapeId),S.ShapeId=null):h.DeleteShape("RuleRect"),s.onDrawRule())},onModifyExclude:function(){if(s.$("#i_f_enable").prop("checked")&&R)if(s.filterEmptyExcludeRegion(ab),"flash"===webApp.playMode||"h5"===webApp.playMode){if(i.showMult=!1,i.ToggleVisibilityOfVideoAnalyseShape(s.containerId,!1),i.showMult=!0,!ab.rect){ab.rect={};var b=I[F][J].ExcludeRegion||[];a.each(b,function(a,b){ab.length++;var c=i.CreateMainVideoAnalyseShape(s.containerId,"Polygon",b);ab.rect[c]=b,ab.curShapeID=c})}a.each(ab.rect,function(a){i.EnableVideoAnalyseShape(s.containerId,a-0,!0),i.ShowVideoAnalyseShape(s.containerId,a-0,!0)})}else webCaps.is_show_PixelCounter&&h.DeleteShape("rect1"),h.DeleteShape("RuleRect"),h.DeleteShape("MaxRect"),h.DeleteShape("MinRect"),ab.rect?a.each(ab.rect,function(a){h.EnableVideoAnalyseShape(a-0,!0),h.ShowVideoAnalyseShape(a-0,!0)}):ab.draw()},onDrawExclude:function(){if(s.filterEmptyExcludeRegion(ab),s.$("#i_f_enable").prop("checked")&&R)if("flash"===webApp.playMode||"h5"===webApp.playMode){if(i.showMult=!1,i.ToggleVisibilityOfVideoAnalyseShape(s.containerId,!1),i.showMult=!0,!ab.rect){ab.rect={};var b=I[F][J].ExcludeRegion||[];a.each(b,function(a,b){ab.length++;var c=i.CreateMainVideoAnalyseShape(s.containerId,"Polygon",b);ab.rect[c]=b,ab.curShapeID=c})}if(a.each(ab.rect,function(a){i.EnableVideoAnalyseShape(s.containerId,a-0,!1),i.ShowVideoAnalyseShape(s.containerId,a-0,!0)}),ab.length<ab.max){var c=i.CreateMainVideoAnalyseShape(s.containerId,"Polygon",null);ab.length++,ab.rect[c]=null,ab.curShapeID=c,i.fillText(tl("com.PleaseDrawRegionTip"),[100,100])}}else webCaps.is_show_PixelCounter&&h.DeleteShape("rect1"),h.DeleteShape("RuleRect"),h.DeleteShape("MaxRect"),h.DeleteShape("MinRect"),ab.rect||ab.draw(),a.each(ab.rect,function(a){h.EnableVideoAnalyseShape(a-0,!1),h.ShowVideoAnalyseShape(a-0,!0)}),ab.length<ab.max&&h.CreateMainVideoAnalyseShape(0,"ExcludeEvent","Polygon","Exclude","","").done(function(a){ab.length++,ab.rect[a]=null,ab.curShapeID=a,h.SetVideoAnalyseContainerTip(0,tl("com.PleaseDrawRegionTip"))})},hideExclude:function(){ab.rect&&(a.each(ab.rect,function(a){"flash"===webApp.playMode||"h5"===webApp.playMode?(i.ShowVideoAnalyseShape(s.containerId,1*a,!1),i.EnableVideoAnalyseShape(s.containerId,1*a,!1)):(h.ShowVideoAnalyseShape(a-0,!1),h.EnableVideoAnalyseShape(a-0,!1))}),s.filterEmptyExcludeRegion(ab))},onExcludeClear:function(){if(s.filterEmptyExcludeRegion(ab),"flash"===webApp.playMode||"h5"===webApp.playMode){if(i.showMult=!1,i.ToggleVisibilityOfVideoAnalyseShape(s.containerId,!1),i.showMult=!0,!ab.rect){ab.rect={};var b=I[F][J].ExcludeRegion||[];a.each(b,function(a,b){ab.length++;var c=i.CreateMainVideoAnalyseShape(s.containerId,"Polygon",b);ab.rect[c]=b,ab.curShapeID=c})}a.each(ab.rect,function(a){i.ShowVideoAnalyseShape(s.containerId,a-0,!0)}),ab.curShapeID&&(ab.rect[ab.curShapeID]=null,s.filterEmptyExcludeRegion(ab))}else{if(!ab.curShapeID)return h.SetVideoAnalyseContainerTip(0,""),!1;h.DeleteVideoAnalyseShape(ab.curShapeID).done(function(){h.SetVideoAnalyseContainerTip(0,""),delete ab.rect[ab.curShapeID],--ab.length?a.each(ab.rect,function(a){return ab.curShapeID=a-0,!1}):ab.curShapeID=0})}},onDrawTarget:function(){if(-1!==webApp.DeviceType.indexOf("TPC")){if(!u||!h)return;C?null==D[0]&&null==D[1]?(C=null,s._targetTPCRule("BigSmallFilterBox")):D[0]&&null==D[1]?s._targetTPCRule("BigFilter"):D[1]&&null==D[0]&&s._targetTPCRule("SmallFilter"):s._targetTPCRule("BigSmallFilterBox")}else{if(!s.$("#i_f_enable").prop("checked")||!R)return;if(s.$("#i_f_max").prop("disabled"))return void s.$("#i_f_tip").tip("error",tl("com.PleaseDrawShapeTip"));s._targetRule()}s.hideExclude()},clearTarget:function(){if(-1!==webApp.DeviceType.indexOf("TPC")){if(!u||!u.Config.SizeFilter||!h||0===D.length)return;s.$("#i_f_max").prop("checked")?(u.Config.SizeFilter.MaxSize=[8191,8191],h.DeleteOneIntelShape(D[1]),D[1]=null):(u.Config.SizeFilter.MinSize=[0,0],h.DeleteOneIntelShape(D[0]),D[0]=null)}else{if(!(s.$("#i_f_enable").prop("checked")&&u&&u.Config.SizeFilter&&R))return;if(s.$("#i_f_max").prop("disabled"))return void s.$("#i_f_tip").tip("error",tl("com.PleaseDrawShapeTip"));"flash"!==webApp.playMode&&"h5"!==webApp.playMode||!Q.sizeFilterId?(h.SetVideoAnalyseContainerTip(0,""),s.$("#i_f_max").prop("checked")?(h.DeleteShape("MaxRect"),h.AddShape(5,"","MaxRect",0,-1)):(h.DeleteShape("MinRect"),h.AddShape(5,"","MinRect",0,-1))):(i.showMult=!1,s.$("#i_f_max").prop("checked")?i.RedrawVideoAnalyseShape(s.containerId,Q.sizeFilterId,Q.bigId):i.RedrawVideoAnalyseShape(s.containerId,Q.sizeFilterId,Q.smallId))}s.$("#i_f_max").prop("checked")?(u.Config.SizeFilter.MaxSize=[0,0],Q.MaxSize=[0,0],s.$('[name="MaxSize-0"]').val(0),s.$('[name="MaxSize-1"]').val(0)):(u.Config.SizeFilter.MinSize=[0,0],Q.MinSize=[0,0],s.$('[name="MinSize-0"]').val(0),s.$('[name="MinSize-1"]').val(0)),s.hideExclude()},_initTarget:function(){if(-1!==webApp.DeviceType.indexOf("TPC"))B&&(h.RemoveOneIntelShapeContainer(B),B=null,C=null,D=[]),s._targetTPCRule("BigSmallFilterBox");else{if(h.SetIVSConfig("",1),!s.$("#i_f_enable").prop("checked"))return void(("flash"===webApp.playMode||"h5"===webApp.playMode)&&(Q.sizeFilterId&&i.ShowVideoAnalyseShape(s.containerId,Q.sizeFilterId,!1),S.ShapeId&&i.ShowVideoAnalyseShape(s.containerId,S.ShapeId,!1),T.ShapeId&&i.ShowVideoAnalyseShape(s.containerId,T.ShapeId,!1)));if(u&&u.Config.SizeFilter){var a={};a.MaxRect=u.Config.SizeFilter.MaxSize,a.MinRect=u.Config.SizeFilter.MinSize,h.SetObjectConfig(JSON.stringify(a)),h.SetCurPtzID(0)}}},_targetRule:function(){if(s.$("#i_f_enable").prop("checked")&&u&&u.Config.SizeFilter)if("flash"===webApp.playMode||"h5"===webApp.playMode){if(i.showMult=!1,i.ToggleVisibilityOfVideoAnalyseShape(s.containerId,!1),Q.sizeFilterId)i.ShowVideoAnalyseShape(s.containerId,Q.sizeFilterId),Q.smallId||(Q.smallId=i.AddVideoAnalyseShape(s.containerId,Q.sizeFilterId,"DRectSmall"));else{Q.sizeFilterId=i.CreateMainVideoAnalyseShape(s.containerId,"DRectBigSmallShape"),Q.bigId=i.AddVideoAnalyseShape(s.containerId,Q.sizeFilterId,"DRectBig",Q.MaxSize);var a=Q.MinSize,b=a.toString().split(",");Math.max.apply(null,b)>0?Q.smallId=i.AddVideoAnalyseShape(s.containerId,Q.sizeFilterId,"DRectSmall",a):s.$("#i_f_min").prop("checked")&&(Q.smallId=i.AddVideoAnalyseShape(s.containerId,Q.sizeFilterId,"DRectSmall"))}i.SelectFilterShape(s.containerId,Q.sizeFilterId,Q.bigId,s.$("#i_f_max").prop("checked")),i.SelectFilterShape(s.containerId,Q.sizeFilterId,Q.smallId,s.$("#i_f_min").prop("checked"))}else s.hideExclude(),h.DeleteShape("RuleRect"),h.SetVideoAnalyseContainerTip(0,""),s._initTarget(),s.$("#i_f_max").prop("checked")?d(u.Config.SizeFilter.MaxSize)?h.AddShape(5,"","MaxRect",0,-1):h.SetCurShape("MaxRect"):d(u.Config.SizeFilter.MinSize)?h.AddShape(5,"","MinRect",0,-1):h.SetCurShape("MinRect")},_targetTPCRule:function(b){function c(b){var c={RectangleShape:f[b]};return c=JSON.stringify(c),a.Deferred(function(a){h.AddOneSubIntelShape(B,C,"RectangleShape","VideoAnalyzeConfig",b,"",c,"").done(function(b){h.SetOneIntelShapeDisplayColor(b,0,0,255,255),h.SetOneIntelShapeDisplayColor(b,1,0,255,255),h.SetOneIntelShapeThickness(b,1),a.resolve(b)}).fail(function(){a.reject()})}).promise()}var d=u.Config.SizeFilter.MinSize,e=u.Config.SizeFilter.MaxSize,f={};if(f.SmallFilter=[[(8191-d[0])/2,(8191-d[1])/2],[(8191+d[0])/2,(8191+d[1])/2]],f.BigFilter=[[(8191-e[0])/2,(8191-e[1])/2],[(8191+e[0])/2,(8191+e[1])/2]],B||h.CreateOneIntelShapeContainer(0,"").done(function(a){B=a}),"BigSmallFilterBox"==b)C&&h.DeleteOneIntelShape(C),h.CreateOneIntelShape(B,b,"VideoAnalyzeConfig",b,"","","").done(function(a){C=a,D=[],c("SmallFilter").done(function(a){D.push(a),c("BigFilter").done(function(a){D.push(a)})})});else{var g="SmallFilter"==b?0:1;c(b).done(function(a){D[g]=a})}s.$("#i_f_max").prop("checked")?(h.SelectOneIntelShape(D[1],!0),h.SelectOneIntelShape(D[0],!1)):(h.SelectOneIntelShape(D[0],!0),h.SelectOneIntelShape(D[1],!1))},onDrawDetect:function(){var a=s.$("[name=DetectSize-0]").numberfield("value"),b=s.$("[name=DetectSize-1]").numberfield("value"),c={PixelCount:[[0,0],[a,b]],Name:"rect1"};return s.$("#i_f_max").prop("disabled")?void s.$("#i_f_tip").tip("error",tl("com.PleaseDrawShapeTip")):(h.DeleteShape("RuleRect"),h.DeleteShape("MaxRect"),h.DeleteShape("MinRect"),s.hideExclude(),h.SetVideoAnalyseContainerTip(0,""),void(a*b?"flash"===webApp.playMode||"h5"===webApp.playMode?(i.showMult=!1,T.ShapeId?i.SetVideoAnalyseShapeConfig(s.containerId,T.ShapeId,[[(webApp.resolution.x-a)/2,(webApp.resolution.y-b)/2],[(webApp.resolution.x+a)/2,(webApp.resolution.y+b)/2]]):T.ShapeId=i.CreateMainVideoAnalyseShape(s.containerId,"PixelCount",[[(webApp.resolution.x-a)/2,(webApp.resolution.y-b)/2],[(webApp.resolution.x+a)/2,(webApp.resolution.y+b)/2]])):h.SetObjectConfig(JSON.stringify(c)):"flash"===webApp.playMode||"h5"===webApp.playMode?(i.showMult=!1,T.ShapeId=i.CreateMainVideoAnalyseShape(s.containerId,"PixelCount")):h.AddShape(6,"PixelCount","rect1",-1,0)))},onDefault:function(){o=["VideoAnalyseRule","VideoEncodeROI"],E&&o.push("FaceRadiometry"),y&&o.push("VideoInFaceAutoExposure"),G&&o.push("FaceSnapshot"),(webCaps.draw_FaceDetectRegion||webCaps.draw_FaceExcludeRegion||V)&&o.push("VideoAnalyseModule"),V&&o.push("VideoAnalyseGlobal"),Y&&o.push("FaceFlowStat"),Z&&o.push("TargetStack"),f.ConfigManager.getDefault(o).done(function(a){n.chkMutilCallRet(a)?(s._renderElements(a,!1),s.$("#i_f_tip").tip("success",tl("com.DefaultSuccessTip"))):s.$("#i_f_tip").tip("error",tl("com.DefaultfailureTip"))})},onRefresh:function(){s._getConfig(!0)},onConfirm:function(){if(-1===webApp.DeviceType.indexOf("TPC")){var b=u.Config.SizeFilter.MaxSize;if(!b||d(b))return void s.$("#i_f_tip").tip("error",tl("com.PleaseDrawShapeTip"))}if(o=["VideoAnalyseRule","VideoEncodeROI"],configTable=[u,w],h.SetCurShape("save"),u.Enable=s.$("#i_f_enable").prop("checked"),u.Config.TriggerTargets=s.$("#i_f_alacount").numberfield("value"),u.EventHandler=s.$("#i_f_event").eventHandler("get"),L&&(u.Config.FeatureEnable=s.$("#i_face_attr").prop("checked")),w[0].DynamicTrack=a("#i_f_enhance").prop("checked")===!0?s.$("#i_f_enhance").prop("checked"):a("#i_f_blur").prop("checked")===!0?2:!1,w[0].DynamicDelayTime=s.$("#i_f_delayBlur").numberfield("value"),E&&(x[0].Enable=s.$("#i_f_t_enable").prop("checked"),x[0].threshold=s.$("#i_f_t_value").numberfield("value"),o.push("FaceRadiometry"),configTable.push(x)),y&&(v[0].Enable=s.$("#i_f_expo_enable").prop("checked"),v[0].TargetBrightness=s.$("#i_f_expo_light").slider("value"),v[0].Interval=s.$("#i_f_expo_time").slider("value"),o.push("VideoInFaceAutoExposure"),configTable.push(v)),G&&(H[0].CutoutPolicy=s.$("#i_face_swap").val(),s.$("#i_face_snap_wrap").hasClass("fn-hide")||(H[0].SnapPolicy=s.$("#i_face_snap").val()),o.push("FaceSnapshot"),configTable.push(H)),webCaps.draw_FaceDetectRegion||webCaps.draw_FaceExcludeRegion||V){if(ab.save(I[F][J]),s.filterEmptyExcludeRegion(ab),o.push("VideoAnalyseModule"),configTable.push(I),d(I[F][J].DetectRegion))return void s.$("#i_f_tip").tip("error",tl("com.DrawRectTip"));if(!P)return void s.$("#i_f_tip").tip("error",tl("com.PleaseDrawShapeTip"))}V&&X&&(X.Scene.Detail&&(X.Scene.Detail.FaceAngleRight=U.find("[cfg=VideoAnalyseGlobal][key=FaceAngleRight]").slider("value"),u.Config.MinQuality=U.find("[cfg=VideoAnalyseRule][key=MinQuality]").slider("value"),u.Config.FeatureFilter=U.find("#faceAdvancedSet_featureFilter").prop("checked"),H[0].OptimalTime=U.find("#faceAdvancedSet_optimalTime").numberfield("value"),I[F][J].Sensitivity=U.find("[cfg=VideoAnalyseModule][key=Sensitivity]").slider("value")),o.push("VideoAnalyseGlobal"),configTable.push(W)),Y&&(Y[F].EncodeBlend=s.$("#i_f_osdenable").prop("checked"),o.push("FaceFlowStat"),configTable.push(Y)),Z&&(a.each($[F],function(a,b){return b.Type===M?(b.Stack=s.$("#i_f_target_enable").prop("checked")-0,!1):void 0
}),o.push("TargetStack"),configTable.push($)),f.ConfigManager.getConfig("VideoAnalyseRule").done(function(b){var c=analyseSenceRuleMap[N]||F;a.each(b[c],function(a,d){return d.Type===N?(b[c][a]=u,configTable[0]=b,f.ConfigManager.setConfig(o,configTable).done(function(a){n.chkMutilCallRet(a)?s.$("#i_f_tip").tip("success",tl("com.SaveSuccessTip")):s.$("#i_f_tip").tip("error",tl("com.SaveConfigFailTip"))}),!1):void 0})}).fail(function(){s.$("#i_f_tip").tip("error",tl("com.SaveConfigFailTip"))})},onSetPeriod:function(){u&&u.EventHandler&&u.EventHandler.TimeSection&&(h.hide(),l.open(u.EventHandler.TimeSection).done(function(a){u.EventHandler.TimeSection=a}).always(function(){"hls"!=webApp.playMode&&"flash"!=webApp.playMode&&"h5"!==webApp.playMode&&h.cover("#i_f_video")}))},onChangePolicy:function(b){var c=a(b.target).val();u.Config.FilterUnAliveEnable&&"Realtime"===c?a(b.target).val(H[0].SnapPolicy):(s.$("#i_face_attr_wrap").toggleClass("fn-hide","Realtime"===c),"Quality"!==s.$("#i_face_snap").val()||u.Config.FeatureFilter||s.$("#i_f_tip").tip("warning",tl("ivs.PleaseSelectQuality")))},onSetAttr:function(){var b=u.Config.FeatureList||[];K.find("#attr_list input").each(function(){var c=a(this).val();a(this).prop("checked",-1!==a.inArray(c,b))}),K.find("[chk-for = chooseAllFeature]").prop("checked",b.length==L),h.hide(),K.dialog("show")},chooseAllFeature:function(b){var c=a(b.target).prop("checked");K.find("#attr_list input").prop("checked",c)},onAdvancedSet:function(){h.hide(),U.dialog("show")},filterEmptyExcludeRegion:function(b){if(b.rect){var c=[];a.each(b.rect,function(a,d){d?c.push(a):("flash"===webApp.playMode||"h5"===webApp.playMode?i.DeleteVideoAnalyseShape(s.containerId,1*a):h.DeleteVideoAnalyseShape(1*a),delete b.rect[a])}),b.length=c.length,c.length>0?b.curShapeID&&!b.rect[b.curShapeID]&&(b.curShapeID=1*Math.max.apply(null,c)):b.curShapeID=0}}})}),define("face_Analysis",function(require,c,d){var e=require("jsCore/rpc"),f=require("jsCore/pageBase"),g=require("jsCore/plugin"),h=(require("jsCore/ability"),require("common/common")),i=require("jsCore/modules/timeSection");require("widget/js/dui.drag");var j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D=null,E=5,F=[],G=1,H=null,I=100,J=1,K=0,L=[],M="table",N={steps:["choose","confirm","regiseting","finish","fail","stop"],comfirmTitle:["sys.Browse","sys.Browse","com.CheckDetail","com.Ok","ivs.Export","Stop"],cancelTitle:["Cancel","Cancel","Cancel","com.Close","com.Close","Cancel"],curStep:0,total:0,num:0,picProcess:null,failPicList:[],registerAddProgress:0,registerAbstractProcess:0,registerRate:[.5,.5]},O={},P=0,Q={left:0,top:0,right:8191,bottom:8191};d.exports=f.extend({init:function(){D=this,"SimpChinese"!==global.currentLanguage&&D.$("[data-for = CNFace]").hide(),D.initGroup(),D.initPerson(),D.initTask(),D.render()},initGroup:function(){l=D.$("#face_group_wrap"),j=D.$("#face_group").table({height:250,columns:[{t:"com.Numbers",width:"5%",render:function(a){return a._index+1}},{fields:"groupName",t:"ivs.FaceGroup",width:"25%",limit:127,editor:function(){return a('<input type="text" class="u-input"/>')}},{fields:"groupSize",t:"ivs.RegisterNo",width:"10%"},{t:"ivs.Deploy",check:"Enable",width:"15%"},{fields:"Similarity",t:"ivs.Similarity",width:"15%",dataType:"number",editor:function(){return a('<input type="text" class="u-input" />')}},{action:"edit",icon:"i-list",t:"itc.Detail",width:"10%",handle:function(a){n=a,D.showGroupDetail()}},{action:"setTime",icon:"i-set",t:"med.ArmDisarm",width:"10%",handle:function(a){i.open(a.TimeSection).done(function(b){a.TimeSection=b,a.isModify=!0})}},{action:"delete",icon:"i-del",t:"com.Delete",width:"10%",handle:function(b){var c=b.groupID,d=this;a.confirm(tl("com.Delete"),tl("com.ConfirmBatteryTip"),function(){e.FaceRecognitionServer.deleteGroup(c).done(function(){d.del(b),D.$("#faceGroup_tip").tip("success",tl("com.OperateSuccessTip")),D.disabled(D.$("[btn-for=onAddGroup]"),m.length>=E)}).fail(function(){D.$("#faceGroup_tip").tip("error",tl("com.OperateFailTip"))})})}},{fields:"groupID",width:"10%",hide:!0}],onblurEditor:function(b,c){return c.data.isModify=!0,"Similarity"==c.field?h.Check.number(c.editVal)&&c.editVal<=100:"groupName"==c.field?(c.editVal=a.htmlEscape(c.editVal),c.data.groupName=c.editVal,m.each(function(a){return a.groupID===c.data.groupID?(a.groupName=c.data.groupName,!1):void 0}),j.table("dataSource",m),!1):void 0}}),k=D.$("#faceGroup_dialog").dialog({confirm:function(a,b){var c=k.find("#group_name").val();b.ui.close(),e.FaceRecognitionServer.createGroup(c).done(function(){D.getConfig(),D.$("#faceGroup_tip").tip("success",tl("com.OperateSuccessTip"))}).fail(function(){D.$("#faceGroup_tip").tip("error",tl("com.OperateFailTip"))})},close:function(){k.find("#group_name").val(""),k.find("[data-action=confirm]").addClass("disabled")}}).detach().appendTo(document.body),k.find("#group_name").textfield({length:127}).keyup(function(b){var c=a(b.target).val();k.find("[data-action=confirm]").toggleClass("disabled",!c.length)}).blur(function(b){var c=a(b.target).val();k.find("[data-action=confirm]").toggleClass("disabled",!c.length)})},initPerson:function(){a.subscribe("RECONNECTION",D.reconnectHandle),L[0]=new Date("1900/1/1"),L[1]=new Date("2037/12/31"),r=D.$("#face_detail_wrap"),M="table",I=100,o=D.$("#face_search").table({height:260,columns:[{check:"Del",width:"4%"},{t:"com.Numbers",width:"6%",render:function(a){return K+a._index+1}},{fields:"Name",t:"com.Name",width:"20%"},{fields:"Sex",t:"Gender",width:"5%",render:function(a){return tl(a.Sex)}},{fields:"Birthday",t:"com.Birth",width:"8%"},{fields:"City",t:"com.City",width:"10%",hide:"SimpChinese"!==global.currentLanguage,render:function(a){return a.Province+a.City}},{fields:"CertificateType",t:"com.Type",width:"10%",render:function(a){return tl(a.CertificateType)}},{fields:"ID",t:"com.ID",width:"17%"},{fields:"FeatureState",t:"ivs.AbstractStatus",width:"10%",render:function(a){return tl("1"==a.FeatureState?"ivs.invalid":"ivs.Effective")}},{action:"edit",icon:"ui-table-icon-edit",t:"com.Modify",width:"5%",handle:function(b){u=a.extend(!0,{},b),D.modifyPerson()}},{action:"delete",icon:"ui-table-icon-delete",t:"com.Delete",width:"5%",handle:function(b){a.confirm(tl("com.Delete"),tl("com.ConfirmBatteryTip"),function(){D.delOnePerson(b)})}},{fields:"UID",hide:!0}]}),H=D.$(".u-pagination").pagination({pageSize:I,changePageSize:!0,isShowSelect:!0,reSearch:!0,pageSizeOptions:[50,100],change:function(a,b){J=b.currentPage,I=b.pageSize,D._ChangePersonPage()}}),p=D.$("#person_dialog").dialog({stopBubble:!1,confirm:function(a,b){x.isInvalid()||3!=G&&!v||(D.addOrModifyPerson(),b.ui.close())},close:function(){v="",p.find("[clear]").each(function(){a(this).val("")}),p.find("select").prop("selectedIndex",0),p.find("[sel-for = onChangeProvince],[sel-for=onChangeCity]").change(),p.find("#img1, #img0").prop("src",""),p.find("#img1").hide(),D.onCancelDrag()}}).detach().appendTo(document.body),q=D.$("#multiPerson_dialog").dialog({confirm:function(a,b){D.isAbstract=0,D.handleMulti(b)},faceCancel:function(a,b){D.cancelMulti(b)}}).detach().appendTo(document.body),q.on("mousedown",function(a){a.stopPropagation()}),N.confirmBtn=q.find("[data-action=confirm]"),N.cancelBtn=q.find("a[data-action=faceCancel]"),N.cancelIcon=q.find("i[data-action=faceCancel]"),N.picProcess=q.find("#face_process"),s=q.find("#face_failPic").table({height:200,columns:[{t:"com.Numbers",width:"20%",render:function(a){return a._index+1}},{t:"com.File",width:"80%",fields:"fileName"}]}),D.$("#face_birth_end").datepicker({minDate:"1900-1-1",readonly:!1}),D.$("#face_birth_begin").datepicker({minDate:"1900-1-1",readonly:!1,change:function(a,b){D.$("#face_birth_end").datepicker("minDate",b.value)}}),D.$("#face_birth_begin, #face_birth_end").textfield({validReg:/^[\d|\-]*$/,errorHandle:"prevent"}).blur(function(b){D.timeLimit(D.$("#face_birth_begin"),D.$("#face_birth_end")),"face_birth_begin"==b.target.id&&a(this).val()&&D.$("#face_birth_end").datepicker("minDate",a(this).val())});var c=p.find("[key = Province]"),d='<option value=""  t="com.Unlimited">'+tl("com.Unlimited")+"</option>";a.each(b,function(a){d+="<option value ="+a+">"+a+"</option>"}),c.html(d),D.$("[sel-for = onChangeProvince]").html(d),p.find("[key = Birthday]").datepicker({minDate:"1900-1-1",readonly:!1}),p.find("[key = Birthday]").textfield({validReg:/^[\d|\-]*$/,errorHandle:"prevent"}).blur(function(){D.timeLimit(p.find("[key = Birthday]"))}),t=p.find(".face-drag-btn"),p.find(".face-drag").drag({dragElements:".drag-target",position:[{left:"0px",top:"0px",zOrder:0}],size:[{width:"476px",height:"326px",minSize:[50,50],maxSize:[476,326]}],showSelect:!0,resize:!0,drag:function(a,b){D.dragDone(b.ui.target)},stop:function(a,b){D.dragDone(b.ui.target)}}),x=a.validator([{element:p.find("[key = Name]"),check:[h.Check.require,function(b){return""!==a.trim(b)}],events:["keyup","blur"]}]),p.find("[key = Name]").textfield({length:63}),p.find("[key = ID]").textfield({length:31}),y=D.$("#abstract_dialog").dialog({closeAbstract:function(){D.isAbstract?(O.$stop.show(),O.$info.hide()):y.dialog("close")},stopAbstract:function(){e.FaceRecognitionServer.stopGroupReAbstract(O.abstractID),D.detachAbstract(),y.dialog("close")},cancelAbstract:function(){O.$stop.show(),O.$info.hide()},returnAbstract:function(){O.$stop.hide(),O.$info.show()},close:function(){O.$cancelAbstract.removeClass("disabled"),O.$num.text(""),O.$process.css("width","0px")}}).detach().appendTo(document.body),O.$num=y.find("#abstract_number"),O.$process=y.find("#abstract_process"),O.$tip=y.find("#abstract_tip"),O.SID=-1,O.abstractID=-1,O.$info=y.find("[show-for = info]"),O.$stop=y.find("[show-for = stop]"),O.$cancelAbstract=y.find("[data-action = cancelAbstract]"),$personSearchImg=D.$(".face_searchImg"),$personSearchImg.delegate("a","click",function(){var b=a(this).attr("data-action"),c=a(this).parents("li").attr("data-index");"del"===b?a.confirm(tl("com.Delete"),tl("com.ConfirmBatteryTip"),function(){D.delOnePerson(F[c])}):(u=a.extend(!0,{},F[c]),D.modifyPerson())}).delegate("input","click",function(){var b=a(this).parents("li").attr("data-index");F[b].Del=a(this).prop("checked")})},initTask:function(){$taskDialog=D.$("#faceTask_dialog").dialog({confirm:function(){D.confirmTask()},remove:function(a,b){g.StopSyncFaceRecognitionDB(),D.removeTask(),b.ui.close()},close:function(){var a=$taskDialog.find('[data-action="confirm"]');a.hasClass("disabled")&&(D.removeTask(),a.removeClass("disabled"))}}).detach().appendTo(document.body),A=$taskDialog.find("#add_task").table({columns:[{fields:"Name",width:"20%",t:"com.Add"},{t:"com.Status",fields:"status",width:"50%",title:""},{fields:"time",width:"20%",title:""}]}),B=$taskDialog.find("#del_task").table({columns:[{fields:"Name",width:"20%",t:"com.Delete"},{t:"com.Status",fields:"status",width:"50%",title:""},{fields:"time",width:"20%",title:""},{fields:"UID",hide:!0}]}),C=$taskDialog.find("#modify_task").table({columns:[{fields:"Name",width:"20%",t:"com.Modify"},{t:"com.Status",fields:"status",width:"50%",title:""},{fields:"time",width:"20%",title:""}]})},render:function(){g.addEvent("PictureUrl",function(a,b){v=a,p.find("#img"+b).prop("src",a),0===b&&(p.find("#img1").prop("src",a).show(),p.find("[btn-for = onUploadImg]").hide(),p.find("#face_drag").show())}),g.addEvent("FaceInfoRegister",function(a,b,c){if(c){if(N.tip)return!1;N.num++;var d=Math.floor(N.num/N.total*100),e=Math.floor(d*N.registerRate[0]);return q.find("#face_updating").html(e+"%"),N.picProcess.css("width",321*e/100+"px"),1!==b&&N.failPicList.push({fileName:c}),(100===d||288620558===b)&&(g.StopBatchRegister(),288620558===b&&(N.tip=tl("ivs.OverFaceMax"),D.isAbstract=0,window.setTimeout(function(){D.isAbstract||(N.picProcess.css("width","321px"),D.finishRegisterAbstract())},1e4)),N.registerAddProgress=100*N.registerRate[0],N.failPicList.length===N.total&&(q.find("#face_updating").html("100%"),N.picProcess.css("width","321px"),D.finishRegisterAbstract())),!1}var f=a.substr(0,1),h=null,i="";1==f?(h=A.table("dataSource"),i=A):(h=C.table("dataSource"),i=C);for(var j=0;j<h.length;j++)if(h[j].tag==a){h[j].status=tl(1==b?"com.OperateSuccessTip":"com.OperateFailTip"),i.table("modify",h[j],j),selectId=j;break}}),g.addEvent("RegPicNum",function(a){N.total=a;var b="";0===a?b=tl("com.NullLimiteTip"):(N.registerRate=50>a?[.9,.1]:1e3>a?[.6,.4]:8e3>a?[.5,.5]:[.4,.6],N.confirmBtn.removeClass("disabled")),q.find("#person_fileNum").html(a||b)}),a(window).on("resize.faceImg",D.onResize),D.getConfig(),z={1:tl("ivs.AbstractStatus")+":"+tl("ivs.invalid"),2:tl("ivs.AbstractStatus")+":"+tl("ivs.Effective")}},updataRegisterAbstract:function(a){if("FaceFeatureAbstract"===a.eventList[0].Code){if(D.isAbstract=1,!N.registerAddProgress)return!1;var b=a.eventList[0].Data.Infos[0];if(b.Process<N.registerAbstractProcess)return!1;N.registerAbstractProcess=b.Process;var c=Math.floor(b.Process*N.registerRate[1])+N.registerAddProgress;q.find("#face_updating").html(c+"%"),N.picProcess.css("width",321*c/100+"px"),"100"==c&&D.finishRegisterAbstract()}},finishRegisterAbstract:function(){e.EventManager.detach(O.SID,["FaceFeatureAbstract"]).done(function(){O.SID=-1}),h.devNotify.detach("client.notifyEventStream",D.updataRegisterAbstract),N.confirmBtn.removeClass("disabled"),2!==N.curStep||N.tip||window.setTimeout(function(){N.confirmBtn.click()},200);var a=N.failPicList.length;q.find("#faceSuccess").html(N.num-a),q.find("#faceFail").html(a),q.find(".face-fail").toggleClass("fn-hide",!a),s.table("dataSource",N.failPicList),N.tip&&(q.find("#face_updataTip").html(N.tip),q.find("#face_updating").html(""),N.num=N.total),D.isAbstract=0},getConfig:function(b){e.FaceRecognitionServer.findGroup().done(function(c){m=c||[],a.each(m,function(b,c){c.Enable=c.channels&&c.channels.length&&-1!==c.channels[0]?!0:!1,c.Similarity=c.similarity[0],c.groupName=a.htmlEscape(c.groupName)}),j.table("dataSource",m),b&&D.$("#faceGroup_tip").tip("success",tl("com.OperateSuccessTip")),D.disabled(D.$("[btn-for=onAddGroup]"),m.length>=E)}).fail(function(){b&&D.$("#faceGroup_tip").tip("error",tl("com.OperateFailTip"))})},leave:function(){D.clearPersonSearch(),g.addEvent("PictureUrl",null),g.addEvent("FRRegisterInfo",null),g.addEvent("FaceInfoRegister",null),a(window).off("resize.faceImg")},destory:function(){P=0,a.unsubscribe("RECONNECTION",D.reconnectHandle)},onRefresh:function(){D.getConfig(!0)},onConfirm:function(){var b=[];a.each(m,function(c,d){if(d.Enable&&b.push(d.groupID),d.isModify){delete d.isModify;var f={GroupID:d.groupID,GroupName:a.htmlEscapeReverse(d.groupName),Similarity:d.Similarity,TimeSection:d.TimeSection};e.FaceRecognitionServer.modifyGroup(f)}}),b.length||(b[0]=""),e.FaceRecognitionServer.setGroup(b).done(function(){D.$("#faceGroup_tip").tip("success",tl("com.SaveSuccessTip"))}).fail(function(a){a.error&&288620565===a.error.code?D.$("#faceGroup_tip").tip("error",tl("ivs.Abstracting")):D.$("#faceGroup_tip").tip("error",tl("com.SaveConfigFailTip"))})},onBackToGroup:function(){D.getConfig(),o.table("dataSource",[]),l.show(),r.hide()},onAddGroup:function(){k.dialog("show")},showGroupDetail:function(){D.$("#face_curGroup").html(n.groupName),D.clearPersonSearch(),l.hide(),r.show(),w=-1},clearPersonSearch:function(){F=[],o.table("dataSource",[]),$personSearchImg.empty().hide(),D.$("[show-for = search]").hide(),D.$("#face_searchKey input, #face_searchKey select").val(""),D.$("#face_searchKey [sel-for=onChangeProvince], #face_searchKey [sel-for=onChangeCity]").change()},onSearchPerson:function(){J=1;var b={};D.$("#face_searchKey [key]").each(function(){var c=a(this).attr("key"),d=a(this).val();(d||"City"===c)&&(b[c]=d,"FeatureState"===c&&(b[c]=d-0))});var c={Range:[n.groupType||"HistoryDB"],GroupID:[n.groupID],BirthdayRange:[D.$("#face_birth_begin").val(),D.$("#face_birth_end").val()]};e.FaceRecognitionServer.startFind(b,c).done(function(a){w=a.token;var b=a.totalCount;b?(D.$(".u-pagination, [btn-for = onDelPerson]").show(),H.pagination("option","currentPage",1).pagination("total",b,!0)):(F=[],D.$("[show-for = search]").hide(),D.$("#faceGroup_tip").tip("success",tl("com.NoData")))}).fail(function(){F=[],D.$("[show-for = search]").hide(),D.$("#faceGroup_tip").tip("success",tl("com.NoData"))})},_ChangePersonPage:function(){if(0>w)return!1;var b=J,c=w;e.FaceRecognitionServer.doFind(w,I,(J-1)*I).done(function(d){return c!==w?!1:(F=a.map(d.candidates,function(a){return a.Person}),K=(b-1)*I,o.data("render",!1),$personSearchImg.data("render",!1),void D.onChangeDisplay())})},onChangeDisplay:function(b){return b&&(D.$("[data-mode]").removeClass("ui-button-hover"),M=a(b.currentTarget).addClass("ui-button-hover").attr("data-mode")),F.length?(D.$("[data-content]").hide(),D.$("[data-content = "+M+"]").show(),"table"===M?D.$("#face_allImg").hide():D.$("#face_allImg").show(),void D.displayContent()):!1},onResize:function(){if($personSearchImg.data("render")){var a=D.getImgGap();$personSearchImg.find("li").css({margin:"10px "+a+"px"})}},getImgGap:function(){var a=$personSearchImg.width()-20,b=190,c=Math.floor(a/b),d=a%b/c,e=(10+d)/2;return e},displayContent:function(){if("table"!==M||o.data("render")){if(!$personSearchImg.data("render")){var b=D.getImgGap();D.$("[chk-for = onCheckAllImg]").prop("checked",!1),$personSearchImg.data("render",!0);var c="";a.each(F,function(a,d){c+="<li data-index="+a+' style="margin:10px '+b+'px;" title="'+z[d.FeatureState]+'"><img src="/RPC2_LoadFaceFile'+d.Image[0].FilePath+'"/><input type="checkbox" />'+(2===d.FeatureState?"<span></span>":"")+'<div><a class="ui-table-icon-whiteDel" data-action="del"></a><a class="ui-table-icon-whiteEdit" data-action="edit"></a></div><label class="ui-label">'+d.Name+"</label></li>"}),$personSearchImg.empty().html(c)}}else o.table("dataSource",F).data("render",!0)},onCheckAllImg:function(b){var c=a(b.target).prop("checked");$personSearchImg.find("input").prop("checked",!c).click()},delOnePerson:function(a){e.FaceRecognitionServer.deletePerson(a).done(function(){D.onSearchPerson(),D.$("#faceGroup_tip").tip("success",tl("com.OperateSuccessTip"))}).fail(function(){D.$("#faceGroup_tip").tip("error",tl("com.OperateFailTip"))})},addOrModifyPerson:function(){var b="";1===G&&(u={},u.GroupID=n.groupID,u.GroupName=n.groupName),p.find("[key]").each(function(){var b=a(this).attr("key"),c=a(this).val();u[b]=c}),u.tag=""+G+P;var c=JSON.stringify(u);v&&(b=v.split("/"),b=b[b.length-1]),1===G?A.table("add",u):C.table("add",u),D.$("#face_taskTotal").html(++P),g.RegisterFaceInfo(c,b,G)},onAbstractAll:function(){var a=[];a.push(n.groupID),O.abstractID=-1,h.devNotify.subscribe("client.notifyEventStream",D.updataAbstractProcess),e.EventManager.attach(["FaceFeatureAbstract"]).done(function(b){O.SID=b,e.FaceRecognitionServer.groupReAbstract(a).done(function(a){O.abstractID=a&&a.token||-2}).fail(function(){O.abstractID=-2}).always(function(){D.showAbstractProcess()})}).fail(function(){h.devNotify.detach("client.notifyEventStream",D.updataAbstractProcess)})},onAbstract:function(){O.abstractID=-1;var b=[];a.each(F,function(a,c){c.Del&&b.push({UID:c.UID})}),h.devNotify.subscribe("client.notifyEventStream",D.updataAbstractProcess),e.EventManager.attach(["FaceFeatureAbstract"]).done(function(a){O.SID=a,e.FaceRecognitionServer.reAbstract(b).fail(function(){O.abstractID=-2}).always(function(){D.showAbstractProcess()})}).fail(function(){h.devNotify.detach("client.notifyEventStream",D.updataAbstractProcess)})},showAbstractProcess:function(){-2!==O.abstractID?(O.$tip.text(tl("ivs.Abstracting")),O.$process.parent().show()):(O.$tip.text(tl("com.NoData")),O.$process.parent().hide(),D.detachAbstract()),O.$stop.hide(),O.$info.show(),O.abstractID<0&&O.$cancelAbstract.hide(),y.dialog("show")},updataAbstractProcess:function(a){if("FaceFeatureAbstract"===a.eventList[0].Code){D.isAbstract=2;var b=a.eventList[0].Data.Infos[0];O.$num.text(b.Process+"%"),O.$process.css("width",321*b.Process/100+"px"),"100"==b.Process&&D.finishAbstract()}},finishAbstract:function(){O.$num.text("100%"),O.$process.css("width","321px"),O.$tip.text(tl("com.Accomplished")),D._ChangePersonPage(),O.$cancelAbstract.addClass("disabled"),O.abstractID=-1,D.detachAbstract(),D.isAbstract=0},detachAbstract:function(){e.EventManager.detach(O.SID,["FaceFeatureAbstract"]).done(function(){O.SID=-1}),h.devNotify.detach("client.notifyEventStream",D.updataAbstractProcess)},onChoosePath:function(){g.ShowFileBrowse().done(function(a){N.num=0,N.total=0,g.GetPicFileNum(a),N.path=a,q.find("#person_filePath").html(a),D.goNextStep(1)})},onAddPerson:function(){G=1,p.dialog("show")},onAddMultiPerson:function(){N.confirmBtn.addClass("disabled"),D.goNextStep(0),q.dialog("show"),a(".u-mask").on("mousedown.face",function(a){a.stopPropagation()})},showFailPic:function(){q.find(".u-button").show(),D.goNextStep(4)},handleMulti:function(a){switch(N.curStep){case 0:D.goNextStep();break;case 1:D.startRegister();break;case 2:q.find(".u-button").hide(),D.goNextStep();break;case 4:g.ShowFileBrowse().done(function(a){g.SaveFailRegisterFile(a).done(function(){q.find("#multi_tip").tip("success",tl("com.ExportSuccessTip")),N.confirmBtn.addClass("disabled")})});break;case 5:g.StopBatchRegister(),e.FaceRecognitionServer.stopReAbstract().done(function(){e.EventManager.detach(O.SID,["FaceFeatureAbstract"]).done(function(){O.SID=-1}),h.devNotify.detach("client.notifyEventStream",D.updataRegisterAbstract)}),a.ui.close(),D.resetMulti()}},cancelMulti:function(a){if(N.num&&-1!==O.SID)switch(N.curStep){case 2:N.confirmBtn.removeClass("disabled"),D.goNextStep(5);break;case 5:N.confirmBtn.addClass("disabled"),D.goNextStep(2);break;default:D.resetMulti(),a.ui.close()}else 5===N.curStep?D.goNextStep(2):(D.resetMulti(),a.ui.close())},resetMulti:function(){q.find(".u-button").show().removeClass("disabled"),q.find("#person_fileNum").html(""),N.total=0,N.num=0,N.failPicList.length=0},goNextStep:function(a){var b=N.steps[N.curStep];void 0!==a?N.curStep=a:a=++N.curStep;var c=N.steps[a];q.find("[step-for = "+b+"]").hide(),q.find("[step-for = "+c+"]").show();var d=tl(N.comfirmTitle[a]),e=tl(N.cancelTitle[a]);N.confirmBtn.html(d),N.cancelBtn.html(e)},startRegister:function(){N.tip="",N.registerAddProgress=0,N.registerAbstractProcess=0,N.picProcess.css("width","0px"),q.find("#face_updating").html(""),q.find("#face_updataTip").html(tl("ivs.FaceRegistering")),g.StartBatchRegister(JSON.stringify({GroupID:n.groupID,GroupName:n.groupName})),N.confirmBtn.addClass("disabled"),D.goNextStep(),e.EventManager.attach(["FaceFeatureAbstract"]).done(function(a){O.SID=a}),h.devNotify.subscribe("client.notifyEventStream",D.updataRegisterAbstract)},reconnectHandle:function(){if(D.isAbstract){var a=D.isAbstract;h.devNotify.reconnect(),e.EventManager.attach(["FaceFeatureAbstract"]).done(function(b){O.SID=b,D.isAbstract=0,window.setTimeout(function(){D.isAbstract||(1===a?D.finishRegisterAbstract():2===a&&D.finishAbstract())},1e4)})}},onDelPerson:function(){var b=B.table("dataSource"),c=a.map(b,function(a){return a.UID}),d=[];a.each(F,function(a,b){b.Del&&-1===c.indexOf(b.UID)&&(P++,d.push(b))}),B.table("add",d),D.$("#face_taskTotal").html(P||"")},onUploadImg:function(){g.ShowSaveOrOpenDlg("openFile","",[{description:"img (*.png;*.jpg;*.bmp)",extensions:["png","jpg","bmp"]}]).done(function(a){var b=a[1];g.SetFaceFilePath(b)})},onConfirmDrag:function(){g.ClipFacePicture(480,330,Q.left,Q.top,Q.right,Q.bottom)},onCancelDrag:function(){t.attr("style",""),p.find(".drag-target").attr("style",""),p.find("#face_drag").hide(),p.find("[btn-for = onUploadImg]").show(),Q={left:0,top:0,right:8191,bottom:8191}},modifyPerson:function(){G=3,p.find("[key]").each(function(){var b=a(this).attr("key");a(this).val(u[b]||""),"Province"==b?a(this).trigger("change"):"City"==b&&-1===a(this)[0].selectedIndex&&a(this).val("Custom").change()});var b="/RPC2_LoadFaceFile"+u.Image[0].FilePath;p.find("#img1").prop("src",b).show(),p.dialog("show")},dragDone:function(a){var b=a.width(),c=a.height(),d=a.position(),e=d.top,f=d.left;t.css({top:e,left:f>90?f-90:f}),Q.left=f,Q.top=e,Q.right=f+b,Q.bottom=e+c},timeLimit:function(b,c){var d=[a.trim(b.val())],e=[];c&&d.push(a.trim(c.val()));for(var f=0;f<d.length;f++)""!==d[f]&&(e[f]=new Date(d[f].replace(/-/g,"/")),e[f].getDate()!=d[f].split("-")[2]?arguments[f].val(""):e[f].getTime()>L[1].getTime()?arguments[f].datepicker("value",L[1]):e[f].getTime()<L[0].getTime()&&arguments[f].datepicker("value",L[0]));d[0]&&d[1]&&e[0].getTime()>e[1].getTime()&&arguments[1].datepicker("value",e[0])},onShowTask:function(){$taskDialog.dialog("show")},confirmTask:function(){$taskDialog.find('[data-action="confirm"]').addClass("disabled"),g.SyncFaceRecognitionDB();var a=B.table("dataSource"),b=a.length,c=0;b&&!function d(){var f=a[c];e.FaceRecognitionServer.deletePerson(f).done(function(){f.status=tl("com.OperateSuccessTip")}).fail(function(){f.status=tl("com.OperateFailTip")}).always(function(){B.table("modify",f,c),++c<b&&d()})}()},removeTask:function(){var a=B.table("dataSource"),b=C.table("dataSource");(b.length||a.length)&&D.onSearchPerson(),A.table("dataSource",[]),C.table("dataSource",[]),B.table("dataSource",[]),D.$("#face_taskTotal").html(""),P=0},onChangeProvince:function(c){var d=a(c.target),e=d.val(),f=d.siblings("select[key = City]");f.length<1&&(f=p.find("select[key = City]"));f.siblings("input");d.attr("data-for")&&(f=D.$("select[key = City]"));var g=b[e]||[];f.empty();var h='<option value=""  t="com.Unlimited">'+tl("com.Unlimited")+"</option>";a.each(g,function(a,b){h+="<option value="+b+">"+b+"</option>"}),h+='<option value="Custom">'+tl("sys.Custom")+"</option>",f.html(h).change()},onChangeCity:function(b){var c=a(b.target),d=c.val(),e=c.siblings("input");e.val(d),"Custom"===d&&e.val(""),e.toggleClass("fn-hide","Custom"!==d)},onChangeType:function(){p.find("[key = ID]").val("")}})}),define("face_alarmLink",function(require,b,c){var d=require("jsCore/rpc"),e=require("jsCore/pageBase"),f=(require("jsCore/ability"),null),g=0,h=null,i=null;c.exports=e.extend({init:function(){f=this;for(var a="",b=0;b<webApp.ALARM_OUT_NUMBER;b++)a+='<option value="'+b+'" t="ivs.AlarmChannel+'+(b+1)+'"></option>';f.$("[sel-for=onSelAlarmChn]").append(a).translation(),f.$("#face_AlarmOutLatch").numberfield({max:300,min:1,allowDecimal:!1,allowNegative:!1}),h=f.$("[sel-for=onSelFaceAlarm]"),f.render()},render:function(b){d.ConfigManager.getConfig("FaceRecognitionAlarm").done(function(c){i=c,i&&(h.empty(),i.length<1?(h.addClass("fn-color-gray").append("<option>"+tl("ivs.AddFaceFirst")+"</option>"),f.disabled("[name=face_link],#face_AlarmOutEnable,#face_AlarmOutLatch",!0)):(h.removeClass("fn-color-gray"),f.disabled("[name=face_link],#face_AlarmOutEnable,#face_AlarmOutLatch",!1),a.each(i,function(a,b){f.$("[sel-for=onSelFaceAlarm]").append('<option value="'+a+'" title="'+b.GroupName+'">'+b.GroupName+"</option>")}),f.$("[sel-for=onSelFaceAlarm]").change())),b&&f.tip("success",tl("com.OperateSuccessTip"))}).fail(function(){b&&f.tip("error",tl("com.OperateFailTip"))})},onSelFaceAlarm:function(b){b.isTrigger||f.saveConfig(),curGroup=a(b.target).val(),f.$("#face_AlarmOutEnable").prop("checked",i[curGroup].AlarmOutEnable),f.$("[sel-for=onSelAlarmChn]").change()},onSelAlarmChn:function(b){b.isTrigger||f.saveConfig(),g=a(b.target).val();var c=i[curGroup].AlarmChannel[g];f.$("[name = face_link][value = 1]").prop("checked",!!(1&c.AlarmRuleMask)),f.$("[name = face_link][value = 2]").prop("checked",!!(2&c.AlarmRuleMask)),f.$("#face_AlarmOutLatch").numberfield("value",c.AlarmOutLatch)},saveConfig:function(){var b=i[curGroup].AlarmChannel[g],c=0;f.$("[name = face_link]:checked").each(function(){c+=a(this).val()-0}),b.AlarmRuleMask=c,b.AlarmOutLatch=f.$("#face_AlarmOutLatch").numberfield("value"),i[curGroup].AlarmOutEnable=f.$("#face_AlarmOutEnable").prop("checked")},onRefresh:function(){f.render(!0)},onConfirm:function(){i.length>0&&f.saveConfig(),d.ConfigManager.setConfig("FaceRecognitionAlarm",i).done(function(){f.tip("success",tl("com.SaveSuccessTip"))}).fail(function(){f.tip("error",tl("com.SaveConfigFailTip"))})}})}),define("face_find",function(require,c,d){var e,f,g,h,i,j,k,l,m,n,o,p,q=require("jsCore/rpc"),r=require("jsCore/pageBase"),s=null,t=20,u=100,v=1,w=[],x=!0,y={Person:{Age:[0,200]}},z=0;d.exports=r.extend({init:function(){s=this,s.initSearch(),k=(global.isDDNS()?"http://"+location.hostname+":"+global.getDDNSMessage().devwebport:"")+"/RPC_Loadfile",h=s.$("#face_find_info"),g=s.$(".face_findImg"),g.delegate("li","click",function(){var b=a(this).attr("data-index");s.showDetail(b)}),f=s.$(".u-pagination").pagination({isShowSelect:!0,reSearch:!0,pageSize:t,changePageSize:!0,pageSizeOptions:[20,40],change:function(a,b){(v!==b.currentPage||t!==b.pageSize)&&(v=b.currentPage,t=b.pageSize,window.setTimeout(function(){s.displayInfo(b.currentPage)},1e3))}}),s.$faceDialog=s.$("#face_find_dialog").dialog({}).detach().appendTo(document.body),s.$loadDialog=s.$("#face_loading_dialog").dialog({}).detach().appendTo(document.body),ability.get("IVSCaps").done(function(b){var c;b.SupportedScene.indexOf("FaceAnalysis")>-1?(c="FaceAnalysis",s.$("[sel-for = onChangeType]").append('<option value="RecSuccess" t="FaceRecognition;title::FaceRecognition" title="'+tl("FaceRecognition")+'">'+tl("FaceRecognition")+"</option>")):(c="FaceDetection",s.$("[sel-for = onChangeType],#face_find_type").hide());var d=b.SupportedScenes[c].SupportedRules,e=d[c].FeatureList,f="";a.each(e,function(a,b){f+='<li><span t="'+b+'+:"></span><span key='+b+"></span></li>"}),s.$faceDialog.find("#attrInfo").empty().html(f).translation()}),s.render()},initSearch:function(){s.$(".ui-switch-icon").click(function(){a(this).toggleClass("toggle"),s.$("#face_find_advanced").slideToggle()}),l=s.$("#face_find_begin").datepicker({change:function(a,b){s.$("#face_find_end").datepicker("minDate",b.value),y.StartTime=l.datepicker("value")+" "+n.timefield("value"),y.EndTime=m.datepicker("value")+" "+o.timefield("value"),y.StartTime>y.EndTime&&o.timefield("value",n.timefield("value"))}}),m=s.$("#face_find_end").datepicker({change:function(){y.EndTime=m.datepicker("value")+" "+o.timefield("value")}}),n=s.$("#face_st_time").timefield({change:function(){y.StartTime=l.datepicker("value")+" "+n.timefield("value"),y.StartTime>y.EndTime&&(o.timefield("value",n.timefield("value")),y.EndTime=m.datepicker("value")+" "+o.timefield("value"))}}),o=s.$("#face_en_time").timefield({change:function(){y.EndTime=m.datepicker("value")+" "+o.timefield("value"),y.StartTime>y.EndTime&&(n.timefield("value",o.timefield("value")),y.StartTime=l.datepicker("value")+" "+n.timefield("value"))}}),s.$("[key = Age0], [key = Age1]").numberfield({min:0,max:200,value:0,allowDecimal:!1,allowNegative:!1}).blur(function(){var b=a(this).attr("key"),c=a(this).val()-0;"Age0"===b?(y.Person.Age[0]=c,c>y.Person.Age[1]&&(s.$("[key = Age1]").val(c),y.Person.Age[1]=c)):(y.Person.Age[1]=c,c<y.Person.Age[0]&&(s.$("[key = Age0]").val(c),y.Person.Age[0]=c))}),s.$("[key = Sex],[key = Emotion],[key = CertificateType]").change(function(){var b=a(this).attr("key"),c=a(this).val();y.Person[b]=c}),s.$("[key = Glasses],[key = Mask],[key = Beard],[key = Complexion]").change(function(){var b=a(this).attr("key"),c=a(this).val()-0;y.Person[b]=c}),s.$("[key = ID], input[key = City]").blur(function(){var b=a(this).attr("key"),c=a(this).val();y.Person[b]=c});var c='<option value=""  t="com.Unlimited">'+tl("com.Unlimited")+"</option>";a.each(b,function(a){c+="<option value ="+a+">"+a+"</option>"}),c+='<option value="Unknown" t="Unknown">'+tl("Unknown")+"</option>",s.$("[sel-for = onChangeProvince]").html(c),"SimpChinese"!==global.currentLanguage&&s.$("[data-for = CNFace]").hide()},render:function(){s.renderDate(),q.MediaFileFind.create().done(function(a){i=a,s.disabled(s.$("[btn-for = onSearchData]"),!1)}),s.$("[sel-for = onChangeType]").change()},leave:function(){s.disabled(s.$("[btn-for = onSearchData]"),!0),h.hide(),g.empty(),z=0,x||q.MediaFileFind.close(i).done(function(){x=!0}),q.MediaFileFind.destroy(i)
},destory:function(){x=!0},renderDate:function(){p={0:tl("com.Unknow"),1:tl("com.No"),2:tl("com.Yes"),Smile:tl("Smile"),Anger:tl("Rage"),Sadness:tl("Sadness"),Disgust:tl("Disgust"),Surprise:tl("Surprise"),Neutral:tl("Normal"),Laugh:tl("Laughter"),Happy:tl("Jolly"),Scream:tl("Scream"),Fear:tl("Fear"),Confused:tl("Confused"),Man:tl("Male"),Woman:tl("Female"),Race1:tl("com.Yellow"),Race2:tl("com.black"),Race3:tl("com.white"),IC:tl("IC"),Passport:tl("Passport"),Unknown:tl("Unknown"),Male:tl("Male"),Female:tl("Female"),Glasses3:tl("SunGlasses"),Glasses1:tl("NoGlasses"),Glasses2:tl("WearGlasses")},q.ConfigManager.getConfig("Locales").done(function(a){switch(a.TimeFormat.split(" ")[0]){case"MM-dd-yyyy":l.datepicker("format","mm-dd-yyyy"),m.datepicker("format","mm-dd-yyyy");break;case"dd-MM-yyyy":l.datepicker("format","dd-mm-yyyy"),m.datepicker("format","dd-mm-yyyy");break;default:l.datepicker("format","yyyy-mm-dd"),m.datepicker("format","yyyy-mm-dd")}switch(a.TimeFormat.split(" ")[1]){case"HH:mm:ss":n.timefield("format","24"),o.timefield("format","24");break;default:n.timefield("format","12"),o.timefield("format","12")}});var a=new Date,b=a.format().split(" ");l.datepicker("value",a.addDays(-1)),n.timefield("value",b[1]),m.datepicker("value",a.addDays(1)),o.timefield("value",b[1]),y.StartTime=l.datepicker("value")+" "+n.timefield("value"),y.EndTime=m.datepicker("value")+" "+o.timefield("value"),z=0},onSearchData:function(){s.$loadDialog.dialog("show"),x||q.MediaFileFind.close(i).done(function(){x=!0}),w.length=0;var b={DB:{FaceRecognitionRecordFilter:y}};q.MediaFileFind.findFile(i,b).done(function(){q.MediaFileFind.getCount(i).done(function(a){f.pagination("option","currentPage",1).pagination("total",a)}),s.afterFind(),s.findNext()}).fail(function(){s.$loadDialog.dialog("close"),a.alert(tl("com.NoDataTip")),h.hide()})},afterFind:function(){x=!1,"RecSuccess"===j?s.$faceDialog.find("[show-for = RecSuccess]").show():s.$faceDialog.find("[show-for = RecSuccess]").hide()},findNext:function(){q.MediaFileFind.findNextFile(i,u).done(function(a){a.infos&&(w.push(a.infos),1===w.length,a.found===u?s.findNext():(s.displayInfo(),q.MediaFileFind.close(i).done(function(){x=!0})))})},displayInfo:function(){if(!w.length)return!1;var b=arguments[0]||v;if(b!==v)return!1;if(s.$loadDialog.dialog("show"),e=[],u===t){if(e=w[b-1],!e)return}else{var c=(b-1)*t/u,d=(b-1)*t%u,c=Math.floor(c);u>=d+t?e=w[c].slice(d,d+t):(e=w[c].slice(d),w[c+1]&&(e=a.merge(e,w[c+1].slice(0,t-(u-d)))))}s.displayAllInfo()},displayAllInfo:function(){function b(){for(var c=document.createDocumentFragment(),h=Math.min(5,f-d),l=0,m=[],n="RecSuccess"===j?[]:null,o=[],p=z,q=d+h,r=d;q>r;r++){var t=e[r].SummaryNew[0].Value,u=t.Object,v=k+u.Image.FilePath;if(o[r]=a("<li data-index="+r+' style="margin:10px '+i+'px;"><div></div><p>'+u.SnapTime+"</p></li>"),m[r]=new Image,n){var w=t.Candidates,x=k+w[0].Person.Image[0].FilePath;n[r]=new Image,n[r].src=x}m[r].onload=function(a){return function(){if(o[a].find("div").append(m[a]),n&&o[a].find("div").append(n[a]),c.appendChild(o[a].get(0)),d++,++l===h){if(d===h&&s.$loadDialog.dialog("close"),p!==z)return!1;g[0].appendChild(c),f>d&&b()}}}(r),m[r].onerror=function(){if(d++,++l===h){if(d===h&&s.$loadDialog.dialog("close"),p!==z)return!1;g[0].appendChild(c),f>d&&b()}},m[r].src=v}}z++;var c="RecSuccess"===j?250:150,d=0,f=e.length;h.show();var i=s.getImgGap(c);g.empty(),"RecSuccess"===j?g.addClass("match"):g.removeClass("match"),b()},onChangeType:function(b){s.clearSearch(),j=a(b.target).val(),y.RegType=j,y.Person={Age:[0,200]},"All"===j?(s.$("[search-for = RecSuccess]").hide(),s.$("[search-for = All]").show()):(s.$("[search-for = RecSuccess]").show(),s.$("[search-for = All]").hide())},clearSearch:function(){s.$("#face_find_advanced input").val(""),s.$("#face_find_advanced select").each(function(){this.selectedIndex=0}),s.$("input[key = City]").addClass("fn-hide"),s.$("[key = Age0]").numberfield("value",0),s.$("[key = Age1]").numberfield("value",200)},getImgGap:function(a){a=a||180;var b=g.width()-20,c=a+10,d=Math.floor(b/c),e=b%c/d,f=(10+e)/2;return f},showDetail:function(b){var c=e[b].SummaryNew[0].Value,d=c.Object;if(s.$faceDialog.find("[key = Time]").html(d.SnapTime),s.$faceDialog.find("#attrInfo [key]").each(function(){var b=a(this).attr("key"),c=d[b];"Race"===b&&c?c="Race"+c:"Glasses"===b&&c&&(c="Glasses"+c),a(this).html(p[c]||c||p[0])}),s.$faceDialog.find("#attrImg").attr("src",k+d.Image.FilePath),"RecSuccess"===j){var f=c.Candidates[0].Person;s.$faceDialog.find("[key = GroupName]").html(f.GroupName),s.$faceDialog.find("[key = Similarity]").html(c.Candidates[0].Similarity),s.$faceDialog.find("#personInfo [key]").each(function(){var b=a(this).attr("key"),c=f[b];a(this).html(p[c]||c)}),s.$faceDialog.find("#delImg").attr("src",k+f.Image[0].FilePath)}s.$faceDialog.dialog("show")},onChangeProvince:function(c){var d=a(c.target).val();y.Person.Province=d;var e=s.$("select[key = City]"),f=b[d]||[],g='<option value=""  t="com.Unlimited">'+tl("com.Unlimited")+"</option>";a.each(f,function(a,b){g+="<option value="+b+">"+b+"</option>"}),g+='<option value="Custom">'+tl("sys.Custom")+'</option><option value="Unknown" t="Unknown">'+tl("Unknown")+"</option>",e.empty().html(g).change()},onChangeCity:function(b){var c=a(b.target).val();y.Person.City=c;var d=s.$("input[key = City]");d.val(c),"Custom"===c&&d.val(""),d.toggleClass("fn-hide","Custom"!==c)}})});var b={"北京市":["市辖区"],"天津市":["市辖区"],"河北省":["石家庄市","唐山市","秦皇岛市","邯郸市","邢台市","保定市","张家口市","沧州市","廊坊市","衡水市"],"山西省":["太原市","大同市","阳泉市","长治市","晋城市","朔州市","运城市","忻州市","临汾市","吕梁市"],"内蒙古自治区":["呼和浩特市","包头市","乌海市","赤峰市","通辽市","呼伦贝尔市","巴彦淖尔市","乌兰察布市","兴安盟","锡林郭勒盟","阿拉善盟"],"辽宁省":["沈阳市","大连市","鞍山市","抚顺市","本溪市","丹东市","锦州市","营口市","阜新市","辽阳市","盘锦市","铁岭市","朝阳市","葫芦岛市"],"吉林省":["长春市","吉林市","四平市","辽源市","通化市","白山市","松原市","白城市","延边朝鲜族自治州"],"黑龙江省":["哈尔滨市","齐齐哈尔市","鸡西市","鹤岗市","双鸭山市","大庆市","伊春市","佳木斯市","七台河市","牡丹江市","黑河市","绥化市","大兴安岭地区"],"上海市":["市辖区"],"江苏省":["南京市","无锡市","徐州市","常州市","苏州市","南通市","连云港市","淮安市","盐城市","扬州市","镇江市","泰州市","宿迁市"],"浙江省":["杭州市","宁波市","温州市","嘉兴市","湖州市","金华市","衢州市","舟山市","台州市","丽水市"],"安徽省":["合肥市","芜湖市","蚌埠市","淮南市","马鞍山市","淮北市","铜陵市","安庆市","黄山市","滁州市","阜阳市","宿州市","巢湖市","六安市","亳州市","池州市","宣城市"],"福建省":["福州市","厦门市","莆田市","三明市","泉州市","漳州市","南平市","龙岩市","宁德市"],"江西省":["南昌市","景德镇市","九江市","新余市","赣州市","吉安市","宜春市","抚州市","上饶市"],"山东省":["济南市","青岛市","淄博市","枣庄市","东营市","烟台市","潍坊市","济宁市","泰安市","威海市","日照市","莱芜市","德州市","聊城市","滨州市","菏泽市"],"河南省":["郑州市","开封市","洛阳市","平顶山市","安阳市","鹤壁市","新乡市","焦作市","濮阳市","许昌市","漯河市","三门峡市","南阳市","商丘市","信阳市","周口市","驻马店市"],"湖北省":["武汉市","黄石市","十堰市","宜昌市","襄樊市","鄂州市","荆门市","孝感市","荆州市","黄冈市","咸宁市","随州市","恩施土家族苗族自治州"],"湖南省":["长沙市","株洲市","湘潭市","衡阳市","邵阳市","岳阳市","常德市","张家界市","益阳市","郴州市","永州市","怀化市","娄底市","湘西土家族苗族自治州"],"广东省":["广州市","韶关市","深圳市","珠海市","汕头市","佛山市","江门市","湛江市","茂名市","肇庆市","惠州市","梅州市","汕尾市","河源市","阳江市","清远市","东莞市","中山市","潮州市","云浮市"],"广西壮族自治区":["南宁市","柳州市","桂林市","梧州市","北海市","防城港市","钦州市","贵港市","玉林市","百色市","贺州市","河池市","来宾市","崇左市"],"海南省":["海口市","三亚市"],"重庆市":["市辖区"],"四川省":["成都市","自贡市","攀枝花市","泸州市","德阳市","绵阳市","广元市","遂宁市","内江市","乐山市","南充市","眉山市","宜宾市","广安市","达州市","雅安市","巴中市","资阳市","阿坝藏族羌族自治州","甘孜藏族自治州","凉山彝族自治州"],"贵州省":["贵阳市","六盘水市","遵义市","安顺市","铜仁地区","毕节地区","黔东南苗族侗族自治州","黔南布依族苗族自治州"],"云南省":["昆明市","曲靖市","玉溪市","保山市","昭通市","丽江市","普洱市","临沧市","楚雄彝族自治州","红河哈尼族彝族自治州","西双版纳傣族自治州","大理白族自治州","德宏傣族景颇族自治州","怒江傈僳族自治州","迪庆藏族自治州"],"西藏自治区":["拉萨市","昌都地区","山南地区","日喀则地区","那曲地区","阿里地区","林芝地区"],"陕西省":["西安市","铜川市","宝鸡市","咸阳市","渭南市","延安市","汉中市","榆林市","安康市","商洛市"],"甘肃省":["兰州市","嘉峪关市","金昌市","白银市","天水市","武威市","张掖市","平凉市","酒泉市","庆阳市","定西市","陇南市","临夏回族自治州","甘南藏族自治州"],"青海省":["西宁市","海东地区","海北藏族自治州","黄南藏族自治州","海南藏族自治州","果洛藏族自治州","玉树藏族自治州","海西蒙古族藏族自治州"],"宁夏回族自治区":["银川市","石嘴山市","吴忠市","固原市","中卫市"],"新疆维吾尔自治区":["乌鲁木齐市","克拉玛依市","昌吉回族自治州","博尔塔拉蒙古自治州","巴音郭楞蒙古自治州","阿克苏地区","克孜勒苏柯尔克孜自治州","喀什地区","和田地区","伊犁哈萨克自治州","塔城地区","阿勒泰地区","自治区直辖县级行政区划"],"台湾省":[],"香港特别行政区":[],"澳门特别行政区":[]}}(jQuery);