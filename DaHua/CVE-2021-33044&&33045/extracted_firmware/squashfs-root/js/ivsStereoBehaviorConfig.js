!function(a){define(function(require,a,b){b.exports=require("jsCore/pageTab")}),define("beh_rule",function(require,b,c){var d=require("jsCore/rpc"),e=require("jsCore/pageBase"),f=require("jsCore/ability"),g=require("jsCore/rpcLogin"),h=require("jsCore/modules/timeSection");require("jsCore/modules/eventHandler");var i=null,j=0,k="StereoBehavior",l=null,m=[],n=[],o=0,p=0,q=0,r=null,s=null,t=null,u=null,v="",w=[],x=!1,y={StereoFallDetection:"StereoFallDetection",StereoFightDetection:"StereoFightDetection",StereoStayDetection:"StereoManStayDetection",StereoManNumDetection:"StereoAbnormalCountDetection",StereoDistanceDetection:"StereoApproachDetection"};c.exports=e.extend({init:function(){var b=a.Deferred(),c=a.Deferred();i=this,n=[],i.$("[slider=sensitivity]").slider({min:1,max:10,complete:function(a,b){u.Config.Sensitivity=b.value}}),i.$("#beh_MinHeight").numberfield({min:0,max:200,allowDecimal:!1}),i.$("#beh_MaxHeight").numberfield({min:0,max:300,allowDecimal:!1}),i.$("[rule*=StereoFallDetection][cfgKye = MinDuration]").numberfield({min:1,max:60,allowDecimal:!1}),i.$("[rule*=StereoStayDetection][cfgKye = MinDuration]").numberfield({min:1,max:3600,allowDecimal:!1}),i.$("[cfgKye = ReportInterval]").numberfield({min:0,max:300,allowDecimal:!1}),i.$("[cfgKye = EnterThresholdMin], [cfgKye = EnterThresholdMax]").numberfield({min:0,max:60,allowDecimal:!1}).blur(function(){var b=a(this).attr(b),c=a(this).val()-0;"EnterThresholdMin"===b?i.$("[cfgKye = EnterThresholdMax]").numberfield("min",c):i.$("[cfgKye = EnterThresholdMin]").numberfield("max",c)}),i.$("[cfgKye = Threshold]").numberfield({min:0,max:10,allowDecimal:!1}),isEnable("is_hide_StereoDistance_param")?(i.$("[rule*=StereoDistanceDetection][cfgKye = DetectType]").parent().remove(),i.$("[rule*=StereoDistanceDetection][cfgKye = Distance]").parent().remove()):i.$("[rule*=StereoDistanceDetection][cfgKye = Distance]").numberfield({min:10,max:600,allowDecimal:!1}),f.get("IVSCaps").done(function(b){var c=b.SupportedScenes[k],d={};p=b.MaxRules,o=c.MaxRules,a.each(c.SupportedRules,function(a){y[a]&&(n.push(a),d[a]=tl(y[a]))}),s=i.$("#beh_ruleManager").table({height:162,columns:[{check:"Enable",width:"10%",checkItem:function(a,b,c){parseInt(c.rowIndex)===this.getSelectedRow()&&i.renderOCX(),a.stopPropagation()},checkAll:function(){i.renderOCX()}},{t:"com.Numbers",width:"8%",render:function(a){return a._index+1}},{t:"com.Name",width:"30%",fields:"Name",limit:63,editor:function(){return a('<input type="text" class="u-input" />')},render:function(a){return'<span title="'+a.Name+'" style="display:inline-block;overflow:hidden;white-space:nowrap;text-overflow:ellipsis;word-wrap:normal;text-align:left;max-width:100%;vertical-align:middle;">'+a.Name+"</span>"}},{t:"com.RuleType",width:"34%",fields:"Type",singleSel:!0,valueMap:d,editor:function(b,c){var d="",e=c.valueMap;if(e){d="<select>";for(var f in e)d+='<option value="'+f+'">'+e[f]+"</option>";d+="</select>"}return a(d)}},{t:"com.Delete",width:"8%",action:"delete",icon:"i-del",titleIcon:"ui-set-icon-add",handle:function(a,b){b.stopPropagation(),this.del(a),i.delRule(a.Type)},titleAction:function(){i.addRule()}}],onRowSelect:function(a,b){i.saveRule(),u=b.data,i.renderRule(),i.renderOCX()},onblurEditor:function(b,c){if("Type"==c.field){var d=c.editVal,e=w.indexOf(d);return-1!==e?(w.splice(e,1),w.push(c.data.Type),i.changeRuleType(d),!0):(i.$("#beh_tip").tip("warning",tl("com.SameRuleOnlyOneTip")),!1)}if("Name"==c.field){var f=c.editVal;return""===f||null===f||void 0===f?(i.$("#beh_tip").tip("error",tl("com.MustName")),x=!0,setTimeout(function(){x=!1},a.fn.tip.defaults.time),!1):c.data.Name===f?!1:i.isUniqueName(c)?(i.changeRuleName(f,c._index-0),!0):(x=!0,setTimeout(function(){x=!1},a.fn.tip.defaults.time),!1)}}})}),d.VideoInAnalyse.getTemplateRule(k).done(function(a){r=a[k],b.resolve()}),webApp.EventCaps?d.EventManager.getEventLink(n).done(function(b){var c=a.extend(!0,{},webApp.EventCaps,webApp.DefaultEvent);t={},a.each(b.name,function(b,d){t[n[b]]=d,a.each(d,function(a,d){"default"===d?(c=webApp.EventCaps,t[n[b]]=null):c[d]=!0})}),i.$("#beh_eventHandler").eventHandler(c)}).fail(function(){i.$("#beh_eventHandler").eventHandler(webApp.EventCaps)}).always(function(){c.resolve()}):(i.$("#beh_eventHandler").eventHandler(),c.resolve()),a.when(b,c).done(function(){i.render()})},render:function(){plugin.addEvent("OutPutStringInfo",function(a,b){b=JSON.parse(b),"OutPutShapeRect"===a&&(u.Config.DetectRegion=b.Config.DetectRegion)}),plugin.cover("#behVideo",function(a){plugin.SetRegionNum(0),plugin.SetModuleMode(2),g.chkAuthority("Monitor_01")&&plugin.open(),a&&i.renderOCX()}),i.getConfig()},getConfig:function(a){d.ConfigManager.getConfig("VideoAnalyseRule").done(function(b){l=b,i.fliterRule(),a&&i.$("#beh_tip").tip("success",tl("com.OperateSuccessTip"))}).fail(function(){a&&i.$("#beh_tip").tip("error",tl("com.OperateFailTip"))})},fliterRule:function(){u=null,m.length=0,q=0,w=a.extend(!0,[],n),a.each(l[j],function(a,b){b.Class===k?(m.push(b),w.splice(w.indexOf(b.Type),1)):q++}),s.table("dataSource",m).table("selectRow",0),i._checkRuleNum()},renderRule:function(){v=u.Type;var b=u.Config,c=i.$("[rule *= "+v+"]");if(i.$("[rule]").parent().hide(),c.parent().show(),t){var d=i.$("#beh_eventHandler").find("[cap]"),e=t[v];e?d.each(function(){var b=a(this).attr("cap");a(this).closest(".ui-form-item").toggleClass("fn-hide",-1===e.indexOf(b))}):d.closest(".ui-form-item").removeClass("fn-hide")}i.$('[slider="sensitivity"]').slider("value",b.Sensitivity),i.$("#beh_MinHeight").val(b.MinHeight),i.$("#beh_MaxHeight").val(b.MaxHeight),c.each(function(){var c=a(this).attr("cfgKye");a(this).val(b[c])}),i.$("#beh_eventHandler").eventHandler("set",u.EventHandler)},renderOCX:function(){plugin.SetIVSConfig(i._buildRuleJson(),2),plugin.SetCurShape(u.Name);var a=i._ruleInitEmpty();a||plugin.SetCurShape("save")},saveRule:function(){if(!u)return!1;var b=u.Config;b.MinHeight=i.$("#beh_MinHeight").val()-0,b.MaxHeight=i.$("#beh_MaxHeight").val()-0,i.$("[rule *= "+v+"]").each(function(){var c=a(this).attr("cfgKye");b[c]=a(this).val()-0}),u.EventHandler=i.$("#beh_eventHandler").eventHandler("get")},delRule:function(a){i._checkRuleNum(),w.push(a)},addRule:function(){var b=w[0],c=a.extend(!0,{},r[b]),d=m.length;c.Enable=!0,c.Name=i._getUniqueName(),s.table("add",c,-1).table("selectRow",d),i._checkRuleNum(),w.splice(w.indexOf(b),1)},changeRuleType:function(b){u.Type=b,u.Config=a.extend(!0,{},r[b].Config),i.renderRule(),i.renderOCX()},changeRuleName:function(a,b){s.table("getSelectedRow")===b&&(plugin.SetCurShape(u.Name),u.Name=a,plugin.SetCurName(a),plugin.SetCurShape("save"))},_checkRuleNum:function(){var a=m.length,b=Math.min(p-q-a,o-a,n.length-a);i.disabled(i.$("[data-action=titleAction]"),!b),i.$("[data-emptyreules]").toggleClass("fn-hide",!a),m.length||plugin.SetIVSConfig("",2)},_getUniqueName:function(){var b=[],c=tl("com.Rule"),d=new RegExp("(^"+c+")(\\d*)$"),e=0;a.each(l[j],function(a,c){c.Class!==k&&(e=d.exec(c.Name),e&&b.push(e[2]-0))}),a.each(m,function(a,c){e=d.exec(c.Name),e&&b.push(e[2]-0)}),b.sort(function(a,b){return a-b});var f=b.length+1;return a.each(b,function(a,b){return b-a>1?(f=a+1,!1):void 0}),c+f},onSetPeriod:function(){u.EventHandler.TimeSection&&(plugin.hide(),h.open(u.EventHandler.TimeSection).done(function(a){u.EventHandler.TimeSection=a}).always(function(){"hls"!=webApp.playMode&&"flash"!=webApp.playMode&&"h5"!=webApp.playMode&&plugin.cover("#behVideo")}))},onDrawRule:function(a){if(!u.Enable)return void i.$("#beh_tip").tip("error",tl("com.RuleIsntEnableTip"));var b=i._ruleInitEmpty(!0);return b?(a&&i.$("#beh_tip").tip("error",tl("com.PleaseDrawShapeTip")),plugin.SetCurShape(u.Name),void plugin.AddShape(2,u.Type,u.Name,-1,0)):void plugin.SelectRule(u.Name,0)},onClearRule:function(){return u.Enable?null===u.Config.DetectRegion?void i.$("#beh_tip").tip("error",tl("com.PleaseDrawShapeTip")):(u.Config.DetectRegion=null,plugin.DeleteShape(u.Name),plugin.SetIVSConfig(i._buildRuleJson(),2),void i.onDrawRule()):void i.$("#beh_tip").tip("error",tl("com.RuleIsntEnableTip"))},_buildRuleJson:function(){return JSON.stringify({result:!0,params:{table:[[u]]}})},_ruleInitEmpty:function(a){for(var b=u.Config.DetectRegion||[[0,0],[0,0],[0,0],[0,0]],c=!0,d=b.length;d--;)if(b[d][0]||b[d][1]){c=!1;break}return c&&!a&&plugin.DeleteShape(u.Name),c},isUniqueName:function(a){for(var b="",c="",d=0;d<l[j].length;d++)if(l[j][d].Class!==k&&l[j][d].Name===a.editVal)return b=i.ruleType2Str(a.data.Type),c=i.ruleType2Str(l[j][d].Type),i.$("#beh_tip").tip("error",""+tl(b)+tl("com.And")+tl(c)+tl("com.GroupNameSameTip")),!1;for(var e=0;e<m.length;e++)if(m[e].Name===a.editVal){if(b=i.ruleType2Str(a.data.Type),c=i.ruleType2Str(m[e].Type),e<a._index){var f="";f=b,b=c,c=f}return i.$("#beh_tip").tip("error",""+tl(b)+tl("com.And")+tl(c)+tl("com.GroupNameSameTip")),!1}return!0},ruleType2Str:function(a){switch(a){case"CrossLineDetection":a="appEventCrossLineDetection";break;case"CrossRegionDetection":a="appEventCrossRegionDetection";break;case"StereoNumberStat":a="NumberStat";break;case"StereoFallDetection":a="StereoFallDetection";break;case"StereoFightDetection":a="StereoFightDetection";break;case"StereoStayDetection":a="StereoManStayDetection";break;case"StereoManNumDetection":a="StereoAbnormalCountDetection";break;case"StereoDistanceDetection":a="StereoApproachDetection"}return a},leave:function(){plugin.SetIVSConfig("",2),plugin.addEvent("OutPutStringInfo",null),plugin.hide(),plugin.close(),x=!1},onDefault:function(){d.ConfigManager.getDefault("VideoAnalyseRule").done(function(b){var c=a.grep(l[j],function(a){return a.Class!==k}),d=a.grep(b[j],function(a){return a.Class===k});l[j]=a.merge(c,d),i.fliterRule(),i.$("#beh_tip").tip("success",tl("com.DefaultSuccessTip"))}).fail(function(){i.$("#beh_tip").tip("success",tl("com.DefaultfailureTip"))})},onRefresh:function(){i.getConfig(!0)},onConfirm:function(){return x?void 0:(plugin.SetCurShape("save"),i.saveRule(),l[j]=i._reBackConfig(),i.isEnabledRuleWithoutShape(l[j])?void i.$("#beh_tip").tip("error",tl("com.PleaseDrawShapeTip")):void d.ConfigManager.setConfig("VideoAnalyseRule",l).done(function(){i.$("#beh_tip").tip("success",tl("com.SaveSuccessTip"))}).fail(function(){i.$("#beh_tip").tip("error",tl("com.SaveConfigFailTip"))}))},_reBackConfig:function(){var b=a.grep(l[j],function(a){return a.Class!==k}),c=a.extend(!0,[],m);return a.each(c,function(a,c){delete c.__id,delete c._index,b.push(c)}),b},isEnabledRuleWithoutShape:function(a){for(var b=!1,c=0;c<a.length;c++)if(a[c]&&"StereoBehavior"===a[c].Class&&!a[c].Config.DetectRegion&&a[c].Enable){b=!0;break}return b}})}),define("beh_scale",function(require,b,c){var d=require("jsCore/rpc"),e=require("jsCore/pageBase"),f=require("jsCore/plugin"),g=require("jsCore/modules/naclDraw"),h=(require("jsCore/ability"),require("common/common"),null),i=0,j=null,k=null,l=null,m=!1,n=!1,o=null,p="ScaleArea",q=-1,r=0,s=0,t=[];c.exports=e.extend({init:function(){h=this,h.$("#beh_cameraHeight").numberfield({min:0,max:1e3,allowDecimal:!1,allowNegative:!1}),h.$("#beh_cameraAngle").numberfield({min:0,max:90,allowDecimal:!0,decimalPrecision:1,allowNegative:!1}),h.render()},render:function(){f.cover("#beh_scale_scale",function(b){f.SetRegionNum(0),f.SetModuleMode(2),f.open(),a.browser.chrome&&a.browser.version>41?g.render(h._outPutNaclGroudRect):f.addEvent("OutPutStringInfo",function(a,b){switch(a){case"OutPutGlobalLaneInfo":h._outPutGlobalCalibrateInfo(b)}}),b&&h._getConfig(!1)}),h._getConfig(!1)},leave:function(){a.browser.chrome&&a.browser.version>41?g.leave():(f.addEvent("OutPutStringInfo",null),f.SetIVSConfig("",2)),f.hide(),f.close()},destory:function(){a.browser.chrome&&a.browser.version>41&&g.leave()},_getConfig:function(a){d.ConfigManager.getConfig(["StereoCalibrate","VideoAnalyseGlobal","VideoAnalyseRule"]).done(function(b){h._renderElements(b);var c=b[2].params.table[i];m=!1;for(var d=0;d<c.length;d++)if(c[d]&&"StereoBehavior"===c[d].Class&&c[d].Enable){m=!0;break}a&&h.$("#beh_scale_tip").tip("success",tl("com.OperateSuccessTip"))}).fail(function(){h.$("#beh_scale_tip").tip("error",tl("com.OperateFailTip"))})},_renderElements:function(b){j=b[0].params.table&&b[0].params.table,k=b[1].params.table&&b[1].params.table,l=a.extend(!0,{},k),a.each(l[i].CalibrateArea,function(a,b){return b&&"Stereo"===b.Method?(q=a,t=b.Area,!1):void 0});var c=l[i].Scene;n=!1,(c.Type&&"StereoBehavior"===c.Type||-1!==a.inArray("StereoBehavior",c.TypeList))&&(n=!0),j[i]&&(r=j[i].CameraHeight,s=j[i].CameraAngle,h.$("#beh_cameraHeight").numberfield("value",r),h.$("#beh_cameraAngle").numberfield("value",s)),a.browser.chrome&&a.browser.version>41?setTimeout(h._renderNaclCalibrateOcx,200):h._renderCalibrateOcx()},_renderCalibrateOcx:function(){if(l[i]){var a=k[i].CalibrateArea;h._buildAnalyseGlobal(a),f.SetIVSConfig(o,0),f.SubVideoWndCtrl(12,1)}},_renderNaclCalibrateOcx:function(){if(l[i]){var a=l[i].CalibrateArea[q];a&&(a.shapeId&&(g.ocxAdjust(a.shapeId,a.shapeId1,!1),g.shapeDelete(a.shapeId)),g.createShape(a.Method,a.Area).done(function(a){g.ocxAdjust(a,"",!1)}),g.ocxSetShapeTip(""))}},_buildAnalyseGlobal:function(b){var c=null,d=[{Area:[],Type:"StereoVision",Name:p}];c=b[q]||{},a.each(c.Area,function(a,b){d[0].Area.push(b)});var e={result:!0,params:{table:[d]}};o=JSON.stringify(e)},onScaleHeight:function(){var b=!1,c=h._ruleInitEmpty(!0);if(a.browser.chrome&&a.browser.version>41){if(l){var d=l[i].CalibrateArea[q];d&&(d.shapeId?(g.showShape(d.shapeId),g.chooseShape(d.shapeId)):(g.createShape(d.Method,""),ipcIvsRuleDrawFinish=!1))}}else{if(!c)return void(b||f.SelectRule(p,0));f.DeleteShape(p),f.AddShape(0,"StereoVision",p,-1,0)}},onClearScale:function(){if(f.SetIVSConfig("",0),a.browser.chrome&&a.browser.version>41){if(l){var b=l[i].CalibrateArea[q];b.shapeId?(ipcIvsRuleDrawFinish=!1,g.reDrawShape(b.shapeId).done(function(){b.Area=[[0,0],[0,0]]}),g.chooseShape(b.shapeId)):g.createShape(b.Method,"")}}else l[i].CalibrateArea[q].Area=[[0,0],[0,0]],f.AddShape(0,"StereoVision",p,-1,0)},_ruleInitEmpty:function(a){var b=!1,c=null;return c=l[i].CalibrateArea[q],c.Area?0===c.Area[0][0]&&0===c.Area[0][1]&&0===c.Area[1][0]&&0===c.Area[1][1]&&(a||f.DeleteShape(p),b=!0):b=!0,b},_outPutGlobalCalibrateInfo:function(a){var b=JSON.parse(a);l[i].CalibrateArea[q].Area=b[0].config.CalibrateArea.DetectRegion},_outPutNaclGroudRect:function(a,b){if(l){var c=l[i].CalibrateArea[q];("createDone"==a||"dragDone"==a)&&(c.shapeId||(c.shapeId=b.ShapeID,g.ocxAdjust(c.shapeId,"",!0))),"mousedownSelect"===a&&(c.shapeId=b.ShapeID);{g.getData(b.ShapeID).done(function(a){c.Area=a,ipcIvsRuleDrawFinish=!1})}}},_saveData:function(){j[i].CameraHeight=h.$("#beh_cameraHeight").numberfield("value"),j[i].CameraAngle=h.$("#beh_cameraAngle").numberfield("value")},onRefresh:function(){if(a.browser.chrome&&a.browser.version>41&&l){a.each(l[i].CalibrateArea,function(a,b){b&&"Stereo"===b.Method&&(q=a)});var b=l[i].CalibrateArea[q];g.ocxSetShapeTip(""),b&&b.shapeId&&g.shapeDelete(b.shapeId)}h._getConfig(!0)},onConfirm:function(){if(!m||!n)return void h.$("#beh_scale_tip").tip("error",tl("com.EnablePlanAndRuleTip"));if(h._saveData(),a.browser.chrome&&a.browser.version>41){var b=l[i].CalibrateArea[q];g.ocxSetShapeTip(""),b&&g.ocxAdjust(b.shapeId,"",!1)}else f.SetCurShape("save");k=a.extend(!0,[],l),h.disabled(h.$("[id^=beh_camera]"),!0);var c=k[i].CalibrateArea[q].Area,e=!1;a.each(t,function(b){a.each(t[b],function(a){t[b][a]!==c[b][a]&&(e=!0)})}),e?d.ConfigManager.setConfig("VideoAnalyseGlobal",k).done(function(){d.ConfigManager.getConfig(["StereoCalibrate","VideoAnalyseGlobal"]).done(function(a){h._renderElements(a),h.disabled(h.$("[id^=beh_camera]"),!1),h.$("#beh_scale_tip").tip("success",tl("com.SaveSuccessTip"))})}).fail(function(){h.disabled(h.$("[id^=beh_camera]"),!1),h.$("#beh_scale_tip").tip("error",tl("com.SaveConfigFailTip"))}):r!==j[i].CameraAngle||s!==j[i].CameraHeight?d.ConfigManager.setConfig("StereoCalibrate",j).done(function(){d.ConfigManager.getConfig("StereoCalibrate").done(function(a){if(j=a,j&&j[i]){var b=j[i].CameraHeight,c=j[i].CameraAngle;0>b&&(b=0),0>c&&(c=0),r=c,s=b}h.disabled(h.$("[id^=beh_camera]"),!1),h.$("#beh_scale_tip").tip("success",tl("com.SaveSuccessTip"))})}).fail(function(){h.disabled(h.$("[id^=beh_camera]"),!1),h.$("#beh_scale_tip").tip("error",tl("com.SaveConfigFailTip"))}):(h.disabled(h.$("[id^=beh_camera]"),!1),h.$("#beh_scale_tip").tip("success",tl("com.SaveSuccessTip")))}})})}(jQuery);