!function(a){define(function(require,a,b){b.exports=require("jsCore/pageTab"),ability.get("ExternalSensorCaps").done(function(a){b.exports.prototype.inf_set=!(!a||!a.SupportLabelInfo),b.exports.prototype.ana_alarm=b.exports.prototype.ana_report=!(!a||!a.Support)})}),define("inf_set",function(require,b,c){var d=require("jsCore/rpc"),e=require("jsCore/pageBase");require("jsCore/modules/eventHandler");var f=require("jsCore/hlsplayer"),g=require("jsCore/flashplayer"),h=require("jsCore/h5player"),i=null,j=null,k=0,l=null,m=null;c.exports=e.extend({init:function(){j=this,m=j.$("#inf_SignalThreshold").parent("div"),webApp.EventCaps?d.EventManager.getEventLink("LabelInfoAlarm").done(function(b){var c=b.name,d=a.extend({},webApp.DefaultEvent),e=webApp.EventCaps;"default"===c[k][0]?d=e:c[k].each(function(a){d[a]=!0,"AlarmOutEnable"===a?d.AlarmOutLatch=e.AlarmOutLatch:"DejitterEnable"===a?d.DejitterRange=e.DejitterRange:"RecordEnable"===a&&(d.RecordLatch=e.RecordLatch)}),j.$("#ana_eventHandler").eventHandler(d)}).fail(function(){j.$("#ana_eventHandler").eventHandler()}):j.$("#ana_eventHandler").eventHandler(),l=j.$("#inf_SignalThreshold").slider({min:1,max:100}),d.RfidManager.getReceiverID().done(function(a){j.$("#inf_receiverID").text(a)}),j.$("#inf_eable").click(function(b){a(b.target).prop("checked")?(m.show(),d.RfidManager.getSignalThreshold().done(function(a){l.slider("value",a)})):m.hide()}),j.render()},render:function(b){"hls"==webApp.playMode?(f.cover(j.$("#inf_video")),plugin.hide(),f.init("","",""),f.beginPlay()):"flash"==webApp.playMode?(g.cover(j.$("#inf_video")),g.playPreview(1,0)):"h5"===webApp.playMode?(h&&h.playPreview(1,0,j.$("#inf_video")),d.ConfigManager.getConfig(["Encode","VideoImageControl"]).done(function(a){if(webApp.resolution.x=a[0].params.table[0].MainFormat[0].Video.Width,webApp.resolution.y=a[0].params.table[0].MainFormat[0].Video.Height,1==a[1].params.table[0].Rotate90||2==a[1].params.table[0].Rotate90){var b;b=webApp.resolution.x,webApp.resolution.x=webApp.resolution.y,webApp.resolution.y=b}})):plugin.cover("#inf_video",function(){plugin.SetModuleMode(1),plugin.open()}),a.when(d.ConfigManager.getConfig("LabelInfoAlarm")).done(function(a){i=a,j._renderElement(),b&&j.$("#inf_tip").tip("success",tl("com.OperateSuccessTip"))}).fail(function(){b&&j.$("#inf_tip").tip("error",tl("com.OperateFailTip"))})},_renderElement:function(){j.$("#inf_eable").prop("checked",i[k].Enable),i[k].Enable?(m.show(),d.RfidManager.getSignalThreshold().done(function(a){l.slider("value",a)})):m.hide(),j.$("#inf_eventHandler").eventHandler("set",i[k].EventHandler)},leave:function(){plugin.hide(),plugin.close(),f&&f.hideAndStopLoad(),g&&g.hide(),h&&h.hide()},onConfirm:function(){var b=l.slider("value");i[k].Enable=j.$("#inf_eable").prop("checked"),i[k].EventHandler=j.$("#inf_eventHandler").eventHandler("get"),a.when(d.ConfigManager.setConfig("LabelInfoAlarm",i)).done(function(){i[k].Enable&&d.RfidManager.setSignalThreshold(b).done(function(){}),j.$("#inf_tip").tip("success",tl("com.SaveSuccessTip"))}).fail(function(){j.$("#inf_tip").tip("error",tl("com.SaveConfigFailTip"))})},onDefault:function(){d.ConfigManager.getDefault("LabelInfoAlarm").done(function(a){i=a,j._renderElement(),j.$("#inf_tip").tip("success",tl("com.DefaultSuccessTip"))}).fail(function(){j.$("#inf_tip").tip("error",tl("com.DefaultfailureTip"))})},onRefresh:function(){j.render(!0)}})}),define("ana_alarm",function(require,b,c){var d=require("jsCore/rpc"),e=require("jsCore/pageBase"),f=require("jsCore/rpcLogin"),g=require("jsCore/ability");require("jsCore/modules/eventHandler");var h=common.Check;timesection=require("jsCore/modules/timeSection");var i,j=require("jsCore/hlsplayer"),k=require("jsCore/flashplayer"),l=require("jsCore/h5player"),m=null,n=0,o=null,p=null,q=null,r=null,s=0,t=!0,u=4,v={AlarmLimit:[20,30],AlarmLimitEnable:[!0,!0],Compensation:0,Enable:!1,EventHandler:{AlarmOut:1,AlarmOutChannels:[0],AlarmOutEnable:!0,AlarmOutLatch:10,BeepEnable:!1,Dejitter:0,Delay:0,ExAlarmOut:1,ExAlarmOutChannels:[0],ExAlarmOutEnable:!1,FlashEnable:!1,FlashLatch:10,LogEnable:!0,MailEnable:!1,Matrix:1,MatrixChannels:[0],MatrixEnable:!1,MessageEnable:!1,PtzLink:[["None",0]],PtzLinkEnable:!1,Record:1,RecordChannels:[0],RecordEnable:!0,RecordLatch:10,Snapshot:1,SnapshotChannels:[0],SnapshotEnable:!1,TimeSection:[["1 00:00:00-23:59:59","0 00:00:00-23:59:59","0 00:00:00-23:59:59","0 00:00:00-23:59:59","0 00:00:00-23:59:59","0 00:00:00-23:59:59"],["1 00:00:00-23:59:59","0 00:00:00-23:59:59","0 00:00:00-23:59:59","0 00:00:00-23:59:59","0 00:00:00-23:59:59","0 00:00:00-23:59:59"],["1 00:00:00-23:59:59","0 00:00:00-23:59:59","0 00:00:00-23:59:59","0 00:00:00-23:59:59","0 00:00:00-23:59:59","0 00:00:00-23:59:59"],["1 00:00:00-23:59:59","0 00:00:00-23:59:59","0 00:00:00-23:59:59","0 00:00:00-23:59:59","0 00:00:00-23:59:59","0 00:00:00-23:59:59"],["1 00:00:00-23:59:59","0 00:00:00-23:59:59","0 00:00:00-23:59:59","0 00:00:00-23:59:59","0 00:00:00-23:59:59","0 00:00:00-23:59:59"],["1 00:00:00-23:59:59","0 00:00:00-23:59:59","0 00:00:00-23:59:59","0 00:00:00-23:59:59","0 00:00:00-23:59:59","0 00:00:00-23:59:59"],["1 00:00:00-23:59:59","0 00:00:00-23:59:59","0 00:00:00-23:59:59","0 00:00:00-23:59:59","0 00:00:00-23:59:59","0 00:00:00-23:59:59"]],TipEnable:!1,Tour:1,TourChannels:[0],TourEnable:!1,VoiceEnable:!1},ExternalSensorID:"",LowPowerAlarmEnable:!1,LowerLimit:-40,Name:"",OSDEnable:!0,SamplingFrequency:4,TransmittingPower:0,Type:"I4-20",Unit:"℃",UpperLimit:80,Valid:!1,SenseMethod:"TempSensor"},w=[],x={TempSensor:"℃",HumiditySensor:"%RH",SmokingSensor:"",CO2:"ppm",Sound:"dB",PM25:"ug/m3",SF6:"ppm",O3:"ppm",AmbientLight:"Lux",Custom:"Custom"},y={TempSensor:"com.Temeper",HumiditySensor:"com.Humidity",SmokingSensor:"com.SmokingSensor",CO2:"com.CO2",Sound:"com.Sound",PM25:"com.PM25",SF6:"com.SF6",O3:"com.O3",AmbientLight:"com.AmbientLight",Custom:"sys.Custom"},z=null,A=null,B=null,C=0,D=null,E=null;c.exports=e.extend({init:function(){m=this,f.chkAuthority("EncodeConf")||m.$("#ana_osdenable_wrap").hide(),D=m.$("[sel-for=onChangeSel][key=Unit]"),E=m.$("[sel-for=onChangeSel][key=SenseMethod]"),o=m.$("#ana_channel"),$addChn=m.$(".ana-btn"),z=m.$("#ana_search").dialog({confirm:function(){m.addSearchChn()},close:function(){plugin.cover("#ana_video")},search:function(){var b=a(this).find("input[type = text]").val();m.renderSearchChn(a.trim(b))},refresh:function(){a(this).find("input[type = text]").val(""),m.searchChn("refresh")},sort:function(){var b=a(this).find("[data-action = sort]"),c=b.attr("order"),d="";"asc"==c?(b.addClass("ui-button-icon-desc"),b.attr("order","desc"),d="desc"):(b.removeClass("ui-button-icon-desc"),b.attr("order","asc"),d="asc"),m.renderSearchChn(d)}}).detach().appendTo(document.body),A=m.$("#ana_sensor").dialog({confirm:function(){m._saveSensorSet(),plugin.cover("#ana_video")}}).detach().appendTo(document.body),m.$("[key = AlarmLimit]").numberfield({max:2e5,min:-500,allowDecimal:!0,decimalPrecision:2,exceptValue:["","-"]}).blur(function(){var a=m.$("#ana_minAlarm").numberfield("value"),b=m.$("#ana_maxAlarm").numberfield("value");a>b&&m.$("#ana_maxAlarm").numberfield("value",b=a)}),m.$("[key = LowerLimit], [key = UpperLimit]").numberfield({max:2e5,min:-500,allowDecimal:!0,decimalPrecision:2,exceptValue:["","-"]}).blur(function(){var a=m.$("[key = LowerLimit]").numberfield("value"),b=m.$("[key = UpperLimit]").numberfield("value");a>b&&m.$("[key = UpperLimit]").numberfield("value",b=a)}),m.$("[key = Compensation]").numberfield({max:100,min:-100,allowDecimal:!0,decimalPrecision:2,exceptValue:["","-"]}),g.get("ExternalSensorCaps").done(function(a){t="RS-485"===a.NetworkingMode,u=a.Channel,t?m.$("[show-for = RFID]").hide():(m.$("[show-for = 485]").hide(),m.$("[show-for = 485]").find("[key]").prop("disabled",!0)),m.render()}),o.delegate("li[data-for]","click",m._changeChannel),o.delegate("a","click",m.delChn),$addChn.on("click",function(){return o.find("li[data-for]").length==u?(m.$("#ana_tip").tip("warning",tl("ivs.FullChannel")),!1):void(t?(0===o.find("li[data-for]").length&&m.$(".u-tab-content").removeClass("fn-hide"),m.addChn()):(plugin.hide(),z.dialog("show"),a("#ana_search").find(".ana-searchBox input").val(""),m.searchChn()))}),webApp.EventCaps?d.EventManager.getEventLink("AnalogAlarm").done(function(b){var c=b.name,d=a.extend({},webApp.DefaultEvent),e=webApp.EventCaps;"default"===c[n][0]?d=e:c[n].each(function(a){d[a]=!0,"AlarmOutEnable"===a?d.AlarmOutLatch=e.AlarmOutLatch:"DejitterEnable"===a?d.DejitterRange=e.DejitterRange:"RecordEnable"===a&&(d.RecordLatch=e.RecordLatch)}),m.$("#ana_eventHandler").eventHandler(d)}).fail(function(){m.$("#ana_eventHandler").eventHandler()}):m.$("#ana_eventHandler").eventHandler(),i=a.validator([{element:m.$("[key=Name]"),check:[h.require],errorMsg:["com.NotNoneTip"],events:["keyup"]}])},searchChn:function(b){d.ExternalSensorManager.discoverLabel().done(function(c){B=c;var d=z.find("[data-action = sort]").attr("order");m.renderSearchChn(d),"refresh"==b&&a("#ana_searchTip").tip("success",tl("adv.Refresh")+tl("com.SucceedTip"))}).fail(function(){B=null})},renderSearchChn:function(b){var c=[];a.each(p,function(a,b){b.Valid&&c.push(b.ExternalSensorID)});var d="",e=z.find(".ana_searchList").empty(),f=B&&B.list;f&&("asc"==b?B.list.sort(function(a,b){return a.LabelID>b.LabelID?1:-1}):"desc"==b?B.list.sort(function(a,b){return a.LabelID<b.LabelID?1:-1}):void 0!==b&&(f=a.grep(B.list,function(a){return a.LabelID.indexOf(b)>-1})),a.each(f,function(b,e){var f=a.inArray(e.LabelID,c)>-1;d+='<li><div class="ui-checkbox"><input type="checkbox" LabelID='+e.LabelID+' SenseMethod = "'+e.SenseMethod+'"'+(f?"disabled checked":"")+'/></div><label class="ui-label">'+e.LabelID+"</label></li>"})),e.html(d)},render:function(a){"hls"==webApp.playMode?(j.cover(m.$("#ana_video")),plugin.hide(),j.init("","",""),j.beginPlay()):"flash"==webApp.playMode?(k.cover(m.$("#ana_video")),k.playPreview(1,0)):"h5"===webApp.playMode?l.playPreview(1,0,m.$("#ana_video")):(plugin.addEvent("RegionChanged",function(a,b,c,d,e){var f=global.getDefaultRect(b,c,d,e);q[n].SensorInfo[0].Rect=f}),plugin.cover("#ana_video",function(a){plugin.SetModuleMode(1),plugin.open(),a&&m.renderOSD()})),d.ConfigManager.getConfig(["AnalogAlarm","VideoWidget"]).done(function(b){p=b[0].params.table,q=b[1].result&&b[1].params.table,m._getOSDList(),m.renderList(),m.renderOSD(),a&&m.$("#ana_tip").tip("success",tl("com.OperateSuccessTip"))}).fail(function(){a&&m.$("#ana_tip").tip("error",tl("com.OperateFailTip"))})},leave:function(){plugin.addEvent("RegionChanged",null),plugin.SetRegionNum(0),plugin.hide(),plugin.close(),j&&j.hideAndStopLoad(),k&&k.hide(),l&&l.hide()},renderList:function(){o.find("li[data-for]").remove();var b="";a.each(p,function(c,d){if(d.Valid){b=d.Enable?"on":"off";var e=a("<li data-for="+c+' class="'+b+'"><a class="i-del"></a><i class="i-arrows"></i><span t="med.Channel"></span>'+(c+1)+"</li>");e.insertBefore($addChn)}}),o.translation(),m.$(".u-tab-content").toggleClass("fn-hide",0===o.find("li[data-for]").length),o.find("li[data-for]:first").click()},addChn:function(){var b=null;C=0;var c=$addChn,d=arguments[0];a.each(p,function(c,e){return e.Valid?void 0:(C=c,b=a("<li data-for="+c+' class="off"><a class="i-del"></a><i class="i-arrows"></i><span>'+tl("med.Channel")+(c+1)+"</span></li>"),e.Valid=!0,d&&(e.ExternalSensorID=d.LabelID,e.SenseMethod=d.SenseMethod,e.Unit=x[d.SenseMethod]||"",e.Name=C+1+" "+tl(y[e.SenseMethod]||y.Custom)),!1)}),o.find("li[data-for]").each(function(b,d){return a(d).attr("data-for")>C?(c=a(d),!1):void 0}),a.inArray(C,w)<0&&w.push(C),b.insertBefore(c),d||b.click()},addSearchChn:function(){var b=z.find('[type = "checkbox"]:checked:enabled'),c=u-o.find("li[data-for]").length;return b.length>0?(0===o.find("li[data-for]").length&&m.$(".u-tab-content").removeClass("fn-hide"),b.length>c&&(b.length=c,window.setTimeout(function(){m.$("#ana_tip").tip("warning",tl("ivs.FullChannel"))},0)),a.each(b,function(b,c){m.addChn({LabelID:a(c).attr("LabelID"),SenseMethod:a(c).attr("SenseMethod")})}),o.find("li[data-for = "+C+"]").click(),z.dialog("close"),void plugin.cover("#ana_video")):!1},delChn:function(b){var c=a(b.target).parent("li"),d=c.attr("data-for");return p[d]=a.extend(!0,{},v),c.remove(),o.find("li[data-for]:first").click(),w=a.grep(w,function(a){return a!=d}),m.$(".u-tab-content").toggleClass("fn-hide",0===o.find("li[data-for]").length),m.$("[btn-for=onConfirm]").click(),!1},_getOSDList:function(){return q?(r=q[n].SensorInfo[0].Description,w.length=0,void a.each(r,function(a,b){w.push(b.ID)})):!1},_changeChannel:function(b){b.isTrigger||m._save(),o.children("li[data-for]").removeClass("current"),s=a(this).addClass("current").attr("data-for")-0,m._renderElement()},_renderElement:function(){m.disabled(D,!1);var b=p[s];m.$("#ana_eable").prop("checked",b.Enable),m.$("#ana_osdenable").prop("checked",a.inArray(s,w)>-1),t||m.$("#ana_lowPowerAlarmEnable").prop("checked",b.LowPowerAlarmEnable),m.$("#ana_alarmLowerEnable").prop("checked",b.AlarmLimitEnable[0]),m.$("#ana_alarmUpperEnable").prop("checked",b.AlarmLimitEnable[1]),m.$("[key]:enabled").each(function(){var c=a(this).attr("key"),d=a(this).attr("pos");a(this).val(void 0!==d?b[c][d]:b[c])}),m.$("select[key = SenseMethod]").change(),m.$("select[key = Unit]").change(),m.$("#ana_eventHandler").eventHandler("set",b.EventHandler),i.validate()},renderOSD:function(){if(!q)return!1;var a=q[n].SensorInfo[0].Rect,b=parseInt(8191/450),c=parseInt(8191/337);a=a||[0,0,0,0],width=120*b,height=20*c;var d=a[0]+width>8191?8191-width:a[0],e=a[1]+height>8191?8191-height:a[1];plugin.SetRegionNum(0),plugin.SetRegionNum(1),plugin.SetRegionAttributeByIndex(0,"",1,0,0,0),setTimeout(function(){plugin.SetSelRegionByIndex(0,d,e,d+width,e+height)},0)},_save:function(){if(i.isInvalid())return m.$("#ana_tip").tip("warning",tl(i.errors()[0].errorMsg));var b=p[s];b.Enable=m.$("#ana_eable").prop("checked"),t||(b.LowPowerAlarmEnable=m.$("#ana_lowPowerAlarmEnable").prop("checked")),b.AlarmLimitEnable[0]=m.$("#ana_alarmLowerEnable").prop("checked"),b.AlarmLimitEnable[1]=m.$("#ana_alarmUpperEnable").prop("checked"),m.$("#ana_osdenable").prop("checked")?a.inArray(s,w)<0&&w.push(s):w=a.grep(w,function(a){return a!=s}),m.$("[key]:enabled").each(function(){var c=a(this).attr("key"),d=a(this).attr("pos"),e=a(this).attr("number");void 0!==d?b[c][d]=a(this).val()-0:b[c]=void 0!==e?a(this).numberfield("value"):a(this).val()}),b.EventHandler=m.$("#ana_eventHandler").eventHandler("get")},onChangeEnable:function(b){var c=a(b.target).prop("checked");o.find("li[data-for="+s+"]").toggleClass("on",c)},onSetPeriod:function(){var a=p[s];a&&a.EventHandler&&a.EventHandler.TimeSection&&(plugin.hide(),timesection.open(a.EventHandler.TimeSection).done(function(b){a.EventHandler.TimeSection=b}).always(function(){plugin.cover("#ana_video")}))},onChangeSel:function(b){var c=a(b.target),d=c.attr("key"),e=(p[s],m.$("select[key = "+d+"]")),f=m.$("input[key = "+d+"]"),g=c.val();if(b.isTrigger){if(e.val()!=f.val()){m.$("select[key = "+d+"]").val("Custom");var g="Custom"}}else f.val("Custom"==g?"":g),y[g]&&m.$("[key=Name]").val(s+1+" "+tl(y[g])),"SenseMethod"===d&&(D.val(x[g]),m.$("#ana_Unit input[key=Unit]").val("Custom"==g?"":x[g]),m.$("#ana_Unit").toggleClass("fn-hide","Custom"!=g),m.disabled(D,"Custom"!==g));if("Unit"===d){var h=E.val();m.disabled(D,"Custom"!==h)}else m.$("#ana_minAlarm, #ana_maxAlarm").parent("div").toggleClass("fn-hide","SmokingSensor"===g);m.$("#ana_"+d).toggleClass("fn-hide","Custom"!=g)},onSetSensor:function(){plugin.hide();var b=p[s];A.find("[key]").each(function(){var c=a(this).attr("key");a(this).val(b[c])}),A.find("#ana_LowPowerAlarmEnable").prop("checked",b.LowPowerAlarmEnable),A.dialog("show")},_saveSensorSet:function(){var b=p[s];A.find("[key]").each(function(){var c=a(this).attr("key");b[c]=a(this).val()}),b.LowPowerAlarmEnable=A.find("#ana_LowPowerAlarmEnable").prop("checked")},onConfirm:function(b){var c=!1;if(i.isInvalid())return m.$("#ana_tip").tip("warning",tl(i.errors()[0].errorMsg));b.isTrigger&&(c=!0),o.find("li[data-for]").length&&(c||m._save()),q&&(r.length=0,a.each(w,function(a,b){r.push({ID:b-0})}),q[n].SensorInfo[0].Description=r);var e="";if(a.each(p,function(a,b){b.Enable&&(e+=b.Name+b.Unit)}),e.lengthB()>90)return void m.$("#ana_tip").tip("error",tl("com.OverlayTooLongTip"));var f=["AnalogAlarm"],g=[p];q&&(f.push("VideoWidget"),g.push(q)),d.ConfigManager.setConfig(f,g).done(function(){c||m.$("#ana_tip").tip("success",tl("com.SaveSuccessTip"))}).fail(function(){c||m.$("#ana_tip").tip("error",tl("com.SaveConfigFailTip"))})},onDefault:function(){d.ConfigManager.getDefault(["AnalogAlarm","VideoWidget"]).done(function(b){p=b[0].params.table,b[1].result&&(q[n].SensorInfo[0]=a.extend(!0,{},b[1].params.table[n].SensorInfo[0])),m._getOSDList(),m.renderList(),m.renderOSD(),m.$("#ana_tip").tip("success",tl("com.DefaultSuccessTip"))}).fail(function(){m.$("#ana_tip").tip("error",tl("com.DefaultfailureTip"))})},onRefresh:function(){m.render(!0)}})}),define("ana_report",function(require,b,c){function d(a,b,c){var d,e,f,g,h,i=b;if(!(b>a)){if(a==b){if(0===a)return[10,0,1];a>0?b=0:a=0}if(d=(a-b)/c,d=Math.ceil(d),g=Math.pow(10,parseInt(Math.log(d)/Math.log(10)))==d?Math.pow(10,parseInt(Math.log(d)/Math.log(10))):Math.pow(10,parseInt(Math.log(d)/Math.log(10))+1),e=(d/g).toFixed(6),e=e>=0&&.1>=e?.1:e>=.100001&&.2>=e?.2:e>=.200001&&.25>=e?.25:e>=.250001&&.5>=e?.5:1,e*=g,parseInt(b/e)!=b/e&&(b=0>b?-1*Math.ceil(Math.abs(b/e))*e:parseInt(Math.abs(b/e))*e),parseInt(a/e)!=a/e&&(a=parseInt(a/e+1)*e),f=(a-b)/e,c>f&&(h=c-f,f=c,a+=h%2===0?e*parseInt(h/2):e*parseInt(h/2+1),b-=e*parseInt(h/2)),c=f,i>=0&&0>b){var j=(a-b)/c,k=(a+b)/j;return[a+b,0,k]}return[a,b,c]}}function e(){var a=n.$('[fc_type="bar"]').prop("checked");return o.nShowType=a?0:1,o.MaxData?!0:!1}function f(a,b,c){for(var d=(b-a)/c,e=[],f=0;c>=f;f++)e.push(a+f*d);return e}var g,h,i,j,k=require("jsCore/pageBase"),l=require("jsCore/rpc"),m=require("jsCore/plugin"),n=(require("lib/jquery.jqplot"),null),o=null,p={Hour:"com.DayReportRangeTip",Day:"com.MonthReportRangeTip",Month:"com.YearReportRangeTip"},q=!1,r=null,s=0;c.exports=k.extend({init:function(){n=this,r=n.$("[sel-for = onChangeChn]").empty(),g=n.$("#an_st_date").datepicker({change:function(a,b){i.datepicker("minDate",b.value)}}),n.$("#an_st_date").parent().css("min-width","978px"),h=n.$("#an_st_time").timefield({disableM:!0,disableS:!0}),i=n.$("#an_en_date").datepicker(),j=n.$("#an_en_time").timefield({disableM:!0,disableS:!0}),n.$("#an_r_enter,#an_r_exit,#an_r_showNum,[fc_type=bar],[fc_type=line]").on("click",function(){if(o){if(!e())return a.alert(tl("com.NoDataTip")),void n._clearChart();n._drawChart(o)}}),n.render()},render:function(){q=!1,a(window).on("resize.flowrate",function(){o&&n._drawChart(o)}),n.onChangeReportType(),o?n._drawChart(o):n.disabled("[btn-for=onExport]",!0),l.ConfigManager.getConfig(["Locales","AnalogAlarm"]).done(function(b){var c=b[0].params.table,d=b[1].params.table;switch(c.TimeFormat.split(" ")[0]){case"MM-dd-yyyy":g.datepicker("format","mm-dd-yyyy"),i.datepicker("format","mm-dd-yyyy");break;case"dd-MM-yyyy":g.datepicker("format","dd-mm-yyyy"),i.datepicker("format","dd-mm-yyyy");break;default:g.datepicker("format","yyyy-mm-dd"),i.datepicker("format","yyyy-mm-dd")}switch(c.TimeFormat.split(" ")[1]){case"HH:mm:ss":h.timefield("format","24"),j.timefield("format","24");break;default:h.timefield("format","12"),j.timefield("format","12")}r.empty();var e=!1;a.each(d,function(a,b){b.Valid&&(e=!0,r.append("<option value ="+a+">"+tl("med.Channel")+(a+1)+"</option>"))}),e||r.append("<option>"+tl("com.None")+"</option>"),n.disabled("[btn-for=onSearch]",!e)})},leave:function(){q=!0,n._clearChart(!0),a(window).off("resize.flowrate")},destory:function(){n._clearChart(!0),a(window).off("resize.flowrate")},onChangeReportType:function(){{var b=n.$("select[sel-for=onChangeReportType]").val(),c=new Date,d=c.getFullYear(),e=c.getMonth();c.getDate()}n.$("#an_tips_txt").text(tl(p[b])),h.hide(),j.hide(),"Hour"==b?(h.show(),j.show(),g.datepicker("value",c),i.datepicker("value",c),h.timefield("value","00:00:00"),j.timefield("value",a.pad(c.getHours(),2)+":00:00")):"Day"==b?(g.datepicker("value",new Date(d,e,1)),i.datepicker("value",c)):(g.datepicker("value",new Date(d,0,1)),i.datepicker("value",c)),i.datepicker("minDate",g.datepicker("value")),n.$("[sel-for=onChangeTime]").parent("li").toggleClass("fn-hide","Hour"==b)},_clearChart:function(a){n.$("#an_r_title").html(""),n.$("#an_r_chart").empty().addClass("ui-emptyChart"),a&&(o=null)},onSearch:function(){var b=n.$("select[sel-for=onChangeReportType]").val(),c=g.datepicker("value")+" ",d=i.datepicker("value")+" ",e=null,f=null,k=null,m=null,o=null;if(n.disabled("[btn-for=onExport]",!0),"Hour"==b){if(c+=h.timefield("value"),d+=j.timefield("value"),e=c,f=d,m=new Date(c.replace(/-/g,"/")),o=new Date(d.replace(/-/g,"/")),m.addDays(1)<o)return void a.alert(tl(p[b]))}else if("Day"==b){if(e=c,f=d,c+="00:00:00",d+="23:59:59",m=new Date(c.replace(/-/g,"/")),o=new Date(d.replace(/-/g,"/")),m.addMonths(1)<o)return void a.alert(tl(p[b]))}else if("Month"==b){n.$("#flow_reportTip").tip("warning",tl("com.YearReportErrorTip"));var t=new Date(c.replace(/-/g,"/")),u=new Date(d.replace(/-/g,"/")).addMonths(1);if(t.setDate(1),u.setDate(0),g.datepicker("value",t),i.datepicker("value",u),c+="00:00:00",d+="23:59:59",e=c.substr(0,7),f=d.substr(0,7),m=new Date(c.replace(/-/g,"/")),o=new Date(d.replace(/-/g,"/")),m.addYears(1)<o)return void a.alert(tl(p[b]))}if(new Date(c.replace(/-/g,"/"))>new Date(d.replace(/-/g,"/")))return a.alert(tl("com.BeginTLessThanEndTTip")),!1;var v={StartTime:c,EndTime:d,Granularity:b,Index:r.val()-0,RecordHour:n.$("[sel-for=onChangeTime]").val()-0,VideoChannel:s},w="";"SimpChinese"===global.currentLanguage&&"Day"==b?(w=tl("com.TimePoint").substr(-1),k=tl("med.Channel")+(r.val()-0+1)+" "+v.RecordHour+w+" "+e+" ~ "+f+" "+tl("ivs.AnalogAlarm")):k=tl("med.Channel")+(r.val()-0+1)+" "+e+" ~ "+f+" "+tl("ivs.AnalogAlarm"),l.ExternalSensorManager.startFind(v).done(function(e){var f=e.token,g=e.totalCount;g?l.ExternalSensorManager.doFind(f,0,g).done(function(a){if(!q){l.ExternalSensorManager.stopFind(f);var e=n._buildAll(a,c,d);n._formatChartData(e,b,k)}}).fail(function(){a.alert(tl("com.NoDataTip"))}):l.ExternalSensorManager.stopFind(f).done(function(){a.alert(tl("com.NoDataTip"))})}).fail(function(){a.alert(tl("com.OpearFaildTip"))})},_buildAll:function(b,c,d){var e=n.$("select[sel-for=onChangeReportType]").val(),f=new Date(c.replace(/-/g,"/")),g=new Date(d.replace(/-/g,"/")),h=[],i=[],j=0,k=["getHours","setHours"];for("Day"==e&&(k=["getDate","setDate"],j=n.$("[sel-for=onChangeTime]").val()-0);g.getTime()-f.getTime()>=0;){var l=f[k[0]](),m=f.getMonth()+1,o=f.getDate(),p=f.getHours()||j;o=10>o?"0"+o:o,m=10>m?"0"+m:m,p=10>p?"0"+p:p;var q=f.getFullYear()+"-"+m+"-"+o+" "+p;h.push(q),f[k[1]](l+1)}"Hour"===e&&(h.length=h.length-1),a.each(b.info,function(a,b){i[a]=b.RecordTime.substr(0,13)});var r=[];return a.each(h,function(c,d){var e=i.indexOf(d);r.push(-1===e?{RecordTime:d+":00:00",Data:"none"}:a.extend(!0,{},b.info[e]))}),b.info=r,b},_formatChartData:function(b,c,e){var f=[],g=[],h=0;a.each(b.info,function(a,b){f[a]=b.Data,g[a]=b.RecordTime});var i=a.grep(f,function(a){return a-parseFloat(a)>=0}),j=Math.max.apply(null,i),k=Math.min.apply(null,i),l=j,m=k>0?0:k;n._clearChart(!0),n.disabled("[btn-for=onExport]",!1),h=d(l,m,10),o={coll:f,YCount:h[2],MaxData:h[0],MinData:h[1],ShowNumber:!0,title:e,params:b,nReportType:0,nShowType:0,timeArr:[],nDirectionStat:-1,reportType:"AnalogAlarm"},"Hour"==c?(a.each(g,function(a,b){o.timeArr[a]=b.substr(5,11).replace(/\-/g,"/")}),o.nReportType=0):"Day"==c?(a.each(g,function(a,b){o.timeArr[a]=b.substr(0,10).replace(/\-/g,"/")}),o.nReportType=1):(a.each(g,function(a,b){o.timeArr[a]=b.substr(0,7).replace(/\-/g,"/")}),o.nReportType=2),o.nShowType=n.$('[fc_type="bar"]').prop("checked")?0:1,n._drawChart(o)},_drawChart:function(b){var c=b.coll,d=b.timeArr,e=null,g=[],h=[],i=0,j=50,k=b.ShowNumber;n._clearChart();var l=n.$("#an_r_chart").width()/c.length;100>l&&(i=-30,j=.3*l),e=n.$('[fc_type="bar"]').prop("checked")?{renderer:a.jqplot.BarRenderer,rendererOptions:{barWidth:j,barMargin:0,barPadding:0,fillToZero:!0},pointLabels:{show:k,edgeTolerance:-50}}:{pointLabels:{show:k,edgeTolerance:-50}},g=[c],h=[{fillToZero:!0}],n.disabled("[btn-for=onExport]",!1),n.$("#an_r_title").html(o.title);a.jqplot("an_r_chart",g,{negativeSeriesColors:["#00f"],seriesColors:["#f00"],seriesDefaults:e,series:h,legend:{show:!1,placement:""},grid:{background:"#dedede",gridLineColor:"#999",borderColor:"#999"},axes:{xaxis:{renderer:a.jqplot.CategoryAxisRenderer,ticks:d,tickRenderer:a.jqplot.CanvasAxisTickRenderer,tickOptions:{markSize:5,_styles:{"margin-top":"10px"},showGridline:!1,angle:i}},yaxis:{min:b.MinData,max:b.MaxData,pad:1,ticks:f(b.MinData,b.MaxData,b.YCount),tickRenderer:a.jqplot.AxisTickRenderer,tickOptions:{_styles:{"margin-right":"10px"},formatter:function(a,b){return"none"==b?"":Math.floor(100*b)/100}}}}})},onExport:function(){m.GetConfigPath("LiveSnapshot").done(function(b){b=b+(a.browser.Platform.win?"\\":"/")+"DataAcquisition"+(new Date).format("yyyyMMddHHmmss"),m.ShowSaveOrOpenDlg("saveFile",b,[{description:"bmp( *.bmp)",extensions:["bmp"]}]).done(function(b){var c,d={};d.params=o.params,d.MaxData=o.MaxData,d.YCount=o.YCount,d.ShowNumber=o.ShowNumber,d.title=o.title,d.MinData=o.MinData,d.reportType="AnalogAlarm",c="bmp"===b[2]?o.nShowType:2,m.MakeReport(o.nReportType,o.nDirectionStat,c,JSON.stringify(d),b[1]).done(function(b){a.alert(b?tl("com.ExportSuccessTip"):tl("com.ExportFailTip"))})})})}})})}(jQuery);