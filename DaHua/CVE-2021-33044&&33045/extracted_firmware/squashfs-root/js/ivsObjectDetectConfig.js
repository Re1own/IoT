!function(a){define(function(require,a,b){b.exports=require("jsCore/pageTab")}),define("object_scene",function(require,b,c){function d(a,b){return a-b}function e(b){for(var c=0;c<b.length;c++)if(a.isArray(b[c])){if(!e(b[c]))return!1}else if(0!==b[c])return!1;return!0}var f=require("jsCore/rpc"),g=require("jsCore/pageBase"),h=require("jsCore/modules/timeSection"),i=require("jsCore/flashplayer"),j=require("jsCore/h5player"),k=require("jsCore/pluginCanvas"),l=require("jsCore/rpcLogin");require("jsCore/modules/eventHandler"),require("jsCore/modules/ptzSetControl");var m=null,n=0;ClassType="ObjectDetect",configName=null,configJsonMap=null;var o,p,q,r,s,t=[],u=[],v=null,w=0,x=0,y=0,z=null,A=[],B={VehicleDetect:"ivs.MotorVehicle",NonMotorDetect:"ivs.NoMotorVehicle",HumanTrait:"com.People",Original:"ivs.Face",Cephalothorax:"ivs.Cephalothorax",Half:"ivs.Half",Whole:"ivs.Whole",HumanDetect:"ivs.HumanDetect",Normal:"com.Normal",Far:"ivs.DistantView",Middle:"ivs.MiddleView",Near:"ivs.CloseView"},C={VehicleDetect:"ivs.MotorVehicle",NonMotorDetect:"ivs.NoMotorVehicle",HumanTrait:"HumanTrait",Original:"ivs.Face",Cephalothorax:"ivs.Cephalothorax",Half:"ivs.Half",Whole:"ivs.Whole",HumanDetect:"ivs.HumanDetect",Helmet:"ivs.Helmet",NumOfCycling:"ivs.Rider",NonMotorColor:"itc.CarColor",Hat:"ivs.Hat",Bag:"ivs.Bag",CarrierBag:"ivs.CarrierBagStatus",Umbrella:"ivs.Umbrella",UpperBodyColor:"ivs.UpperBodyColor",LowerBodyColor:"ivs.LowerBodyColor",UpClothes:"ivs.UpClothesType",DownClothes:"ivs.DownClothesType",MainColor:"ivs.MainColor",Text:"ivs.CarText",Calling:"ivs.Phone",AnnualInspection:"ivs.InspectionSticker",CarLogoIndex:"itc.VehicleLogo",BrandYear:"ivs.BrandYear",SunShade:"ivs.SunLouver",SafeBelt:"ivs.SafetyBelt",Category:"itc.CarType",VehicleColor:"itc.CarColor",Attachment:"ivs.CarItems",Smoking:"ivs_osd.TitleBit59",Age:"Age",Sex:"Sex",Emotion:"Emotion",Glass:"Glasses",Glasses:"Glasses",Express:"Emotion",Race:"Race",Eye:"Eye",Mouth:"Mouth",Mask:"Mask",Beard:"Beard",Attractive:"Attractive",Phone:"pfm.Phone",FaceFlag:"ivs.FaceFlag",CarSeries:"itc.CarSeries",Plate:"itc.PlateNo",PlateColor:"itc.PlateColor",Pendant:"ivs.Pendant",PerfumeBox:"ivs.PerfumeBox",TissueBox:"ivs.TissueBox",Call:"ivs.Phone",humanNum:"ivs.Rider"},D=!0,E={},F=[],G={},H={VehicleDetect:tl("TrafficFlowStat"),NonMotorDetect:tl("ivs.NonMotorDetectFlowStat"),HumanTrait:tl("ivs.HumanTraitFlowStat")},I={NonMotorDetect:"NonMotor",VehicleDetect:"Vehicle",HumanTrait:"Human"},J=null,K=!1;c.exports=g.extend({init:function(){var b=a.Deferred(),c=a.Deferred(),d=a.Deferred(),e=a.Deferred();m=this,$faceAttrDialog=m.$("#faceAttr_dialog").dialog({confirm:function(b,c){plugin.cover("#object_video");var d=[];$faceAttrDialog.find("#attr_list input:checked").each(function(){d.push(a(this).val())}),configJsonMap.VideoAnalyseRule[n][0].Config.FeatureList=d,c.ui.close()},cancel:function(){plugin.cover("#object_video")},close:function(){plugin.cover("#object_video")}}).detach().appendTo(document.body),$carAttrDialog=m.$("#carAttr_dialog").dialog({confirm:function(b,c){plugin.cover("#object_video");var d=[];$carAttrDialog.find("#attrcar_list input:checked").each(function(){d.push(a(this).val())}),configJsonMap.VideoAnalyseRule[n][2].Config.FeatureList=d,c.ui.close()},cancel:function(){plugin.cover("#object_video")},close:function(){plugin.cover("#object_video")}}).detach().appendTo(document.body),$nocarAttrDialog=m.$("#nocarAttr_dialog").dialog({confirm:function(b,c){plugin.cover("#object_video");var d=[];$nocarAttrDialog.find("#attrnocar_list input:checked").each(function(){d.push(a(this).val())}),configJsonMap.VideoAnalyseRule[n][1].Config.FeatureList=d,c.ui.close()},cancel:function(){plugin.cover("#object_video")},close:function(){plugin.cover("#object_video")}}).detach().appendTo(document.body),$facebodyAttrDialog=m.$("#facebodyAttr_dialog").dialog({confirm:function(b,c){plugin.cover("#object_video");var d=[];$facebodyAttrDialog.find("#attrbody_list input:checked").each(function(){d.push(a(this).val())}),configJsonMap.VideoAnalyseRule[n][0].Config.HumanFeatureList=d,c.ui.close()},cancel:function(){plugin.cover("#object_video")},close:function(){plugin.cover("#object_video")}}).detach().appendTo(document.body),D=l.chkAuthority("EncodeConf"),configName=["VideoAnalyseRule","VideoAnalyseGlobal","VideoAnalyseModule"],webApp.DeviceType.indexOf("SD")>-1?(m.$("#ipcIntellentFace_presets_wrap").show(),m.$("#onDefault").addClass("fn-hide"),m.$("#onDefaultSD").removeClass("fn-hide")):(m.$("#onDefault").removeClass("fn-hide"),m.$("#onDefaultSD").addClass("fn-hide")),m.$("input:radio[name=ivsObjectDetectConfig_maxMin]").on("change",function(){m.onDrawTarget()}),m.$("label[name=label4max]").on("click",function(){m.$("input:radio[name=ivsObjectDetectConfig_maxMin][value=max]").trigger("click")}),m.$("label[name=label4min]").on("click",function(){m.$("input:radio[name=ivsObjectDetectConfig_maxMin][value=min]").trigger("click")}),webCaps.is_show_PixelCounter?(m.$("[name=DetectSize-0]").numberfield({min:0,max:webApp.resolution.x,allowDecimal:!0,allowNegative:!1}),m.$("[name=DetectSize-1]").numberfield({min:0,max:webApp.resolution.y,allowDecimal:!0,allowNegative:!1})):m.$("[name=DetectSize-0]").parent().parent().hide(),ability.get("IVSCaps").done(function(b){var c=b.SupportedScenes[ClassType],d={};x=b.MaxRules,w=c.MaxRules,t=[],a.each(c.SupportedRules,function(a){t.push(a),d[a]=tl(B[a])});var e=b.SupportedScenes.ObjectDetect.SupportedRules;if(e&&e.HumanTrait&&e.HumanTrait.FeatureSupport){var f=e.HumanTrait.FeatureList||[];featureSupport=f.length;var g="";a.each(f,function(a,b){g+='<label class="ui-label"><input type="checkbox" value="'+b+'" /><span t='+C[b]+"></span></label>"}),$faceAttrDialog.find("#attr_list").html(g).translation();var h=e.HumanTrait.HumanFeatureList||[];featureSupport1=h.length,g="",a.each(h,function(a,b){g+='<label class="ui-label"><input type="checkbox" value="'+b+'" /><span t='+C[b]+"></span></label>"}),$facebodyAttrDialog.find("#attrbody_list").html(g).translation()}else m.$("#i_object_attr_wrap, [btn-for = onSetAttr]").remove();if(e&&e.VehicleDetect&&e.VehicleDetect.FeatureSupport){var f=e.VehicleDetect.FeatureList||[];featureSupport2=f.length;var g="";a.each(f,function(a,b){g+='<label class="ui-label"><input type="checkbox" value="'+b+'" /><span t='+C[b]+"></span></label>"}),$carAttrDialog.find("#attrcar_list").html(g).translation()}else m.$("#i_car_attr_wrap").remove();if(e&&e.NonMotorDetect&&e.NonMotorDetect.FeatureSupport){var f=e.NonMotorDetect.FeatureList||[];featureSupport3=f.length;var g="";a.each(f,function(a,b){g+='<label class="ui-label"><input type="checkbox" value="'+b+'" /><span t='+C[b]+"></span></label>"}),$nocarAttrDialog.find("#attrnocar_list").html(g).translation()}else m.$("#i_nocar_attr_wrap").remove();if(c.SceneDepth){var i="";a.each(c.SceneDepth,function(a,b){i+='<option value="'+b+'" t="'+B[b]+'"></option>'}),m.$("[name=sceneSelect]").parent().show(),m.$("[name=sceneSelect]").empty().append(i).translation()}r=t[0],$ruleTable=m.$("#obj_ruleManager").table({height:130,columns:[{check:"Enable",width:"15%",preventEvt:!0,checkItem:function(a,b,c){parseInt(c.rowIndex)!==this.getSelectedRow()||c.data.Enable||m.hideAllShapes()},checkAll:function(a){!a.target.checked&&s&&m.hideAllShapes()}},{t:"com.Numbers",width:"8%",render:function(a){return a._index+1}},{t:"com.Name",width:"30%",fields:"Name",limit:63,editor:function(){return a('<input type="text" class="u-input" />')}},{t:"com.RuleType",width:"29%",fields:"Type",singleSel:!0,valueMap:d,editor:function(b,c){var d="",e=c.valueMap;if(e){d="<select>";for(var f in e)d+='<option value="'+f+'">'+e[f]+"</option>";d+="</select>"}return a(d)}},{t:"com.Delete",width:"8%",action:"delete",icon:"i-del",titleIcon:"ui-set-icon-add",preventEvt:!0,handle:function(a){this.del(a),m.delRule(a)},titleAction:function(){m.addRule()}}],onRowSelect:function(a,b){m.saveRule(),s=b.data,m.renderRule()},onblurEditor:function(b,c){if("Type"==c.field){var d=c.editVal,e=A.indexOf(d);return-1!==e?(A.splice(e,1),A.push(c.data.Type),m.changeRuleType(d),!0):(m.$("#obj_tip").tip("warning",tl("com.SameRuleOnlyOneTip")),!1)}if("Name"==c.field){var f=c.editVal;return""===f||null===f||void 0===f?(m.$("#obj_tip").tip("error",tl("com.MustName")),K=!0,setTimeout(function(){K=!1},a.fn.tip.defaults.time),!1):c.data.Name===f?!1:!0}}})}),-1!==t.indexOf("HumanTrait")?(ability.get("FaceDetection").done(function(b){if(b&&b.CutoutPolicy){var c="";a.each(b.CutoutPolicy,function(a,b){c+='<option value="'+b+'" t="'+B[b]+'"></option>'}),m.$("#obj_face_swap").empty().append(c).translation(),configName.push("FaceSnapshot"),m.$("#obj_face_swap").parent("div").show()}}),ability.get("ObjectDetect").done(function(b){if(b&&b.CutoutPolicy){var c="";a.each(b.CutoutPolicy,function(a,b){c+='<option value="'+b+'" t="'+B[b]+'"></option>'}),m.$("#obj_face_swap").empty().append(c).translation(),configName.push("FaceSnapshot"),m.$("#obj_face_swap").parent("div").attr("show-for","HumanTrait")}}),ability.get("VideoInputCapsEx").done(function(b){b&&b.FaceAutoExposure&&b.FaceAutoExposure.Support&&(m.$("#obj_face_expo_light, #obj_face_expo_time").slider({min:0,max:100,complete:function(b,c){var d=a(b.target).attr("key");configJsonMap.VideoInFaceAutoExposure[n][d]=c.value}}),configName.push("VideoInFaceAutoExposure"),m.$("#obj_face_expo_wrap").show())}),f.DevVideoEncode.getCaps().done(function(a){a&&a.DynamicTrackROI&&!webCaps.NewGlobalCamera&&(configName.push("VideoEncodeROI"),m.$("#obj_enhance_wrap").show())}).always(function(){b.resolve()})):b.resolve(),webApp.IsSDIntel&&webCaps.NewGlobalCamera&&m.$("#objSdPtzWrap").ptzSetControl(),webApp.EventCaps?f.EventManager.getEventLink(t).done(function(b){z={};var c=a.extend(!0,{},webApp.EventCaps,webApp.DefaultEvent);a.each(b.name,function(b,d){z[t[b]]=d,a.each(d,function(a,d){"default"===d?(c=webApp.EventCaps,z[t[b]]=null):c[d]=!0})}),m.$("#obj_eHandler").eventHandler(c)}).fail(function(){m.$("#obj_eHandler").eventHandler(webApp.EventCaps)}).always(function(){c.resolve()}):(m.$("#obj_eHandler").eventHandler(),c.resolve()),f.VideoInAnalyse.getTemplateRule(ClassType).done(function(a){q=a[ClassType],d.resolve()}),ability.get("FlowStat").done(function(b){var c="";if(b&&b[0]){var d={Human:"HumanTrait",NonMotor:"NonMotorDetect",Vehicle:"VehicleDetect"};a.each(b[0],function(a,b){G[d[a]]=b.Support,b.Support&&(c+=d[a])}),c&&(configName.push("TrafficFlowStat"),D&&(configName.push("VideoWidget"),m.$("#obj_StatOSD").attr("show-for",c)))}}).always(function(){e.resolve()}),a.when(b,c,d,e).done(function(){m.render()})},render:function(){var b=a.Deferred();if("flash"===webApp.playMode||"h5"===webApp.playMode){if("flash"===webApp.playMode&&(i.cover(m.$("#object_video")),i.playPreview(1,0),f.ConfigManager.getConfig(["Encode","VideoImageControl"]).done(function(a){if(webApp.resolution.x=a[0].params.table[0].MainFormat[0].Video.Width,webApp.resolution.y=a[0].params.table[0].MainFormat[0].Video.Height,1==a[1].params.table[0].Rotate90||2==a[1].params.table[0].Rotate90){var b;b=webApp.resolution.x,webApp.resolution.x=webApp.resolution.y,webApp.resolution.y=b}k.cover("#object_video",webApp.resolution.x+"*"+webApp.resolution.y),m.containerId=k.CreateVideoAnalyseContainer()}).always(function(){b.resolve()})),"h5"===webApp.playMode){var c=a.Deferred();j.playPreview(1,0,m.$("#object_video"),null,c),c.done(function(a){webApp.resolution.x=a.width,webApp.resolution.y=a.height}),k.cover("#object_video",webApp.resolution.x+"*"+webApp.resolution.y),m.containerId=k.CreateVideoAnalyseContainer(),b.resolve()}}else plugin.cover("#object_video",function(a){plugin.SetRegionNum(0),plugin.SetModuleMode(2),l.chkAuthority("Monitor_01")&&plugin.open(),a&&plugin.EnableVideoAnalyseModule(!0)}),plugin.EnableVideoAnalyseModule(!0),b.resolve();m.bind(),a.when(b).always(function(){m._getConfig(!1)})},bind:function(){plugin.addEvent("VideoAnalyzeConfig",function(a){switch(a=JSON.parse(a),a.EventParam.ShapeState){case 3:switch(a.EventName){case"detectRegionEvent":plugin.GetVideoAnalyseShapeConfigData(a.EventParam.ShapeID).done(function(b){b=JSON.parse(b),E.id=a.EventParam.ShapeID,b=b[a.EventParam.ShapeName],E.coordinates=[b[0],[b[0][0],b[1][1]],b[1],[b[1][0],b[0][1]]],2===a.EventParam.PreShapeState&&plugin.SetVideoAnalyseContainerTip(0,tl("com.DrawingIsCompletedTip"))});break;case"excludeRegionEvent":switch(a.EventParam.PreShapeState){case 2:case 4:case 5:plugin.GetVideoAnalyseShapeConfigData(a.EventParam.ShapeID).done(function(b){b=JSON.parse(b);for(var c=0;c<F.length;c++)if(F[c].id===a.EventParam.ShapeID){F.splice(c,1);break}F.push({id:a.EventParam.ShapeID,coordinates:b[a.EventParam.ShapeName]})})}}}}),plugin.addEvent("OutPutStringInfo",function(a,b){var c=JSON.parse(b);"OutPutObjectRect"===a&&(webCaps.is_show_PixelCounter&&c.rect1?(m.$("[name=DetectSize-0]").numberfield("value",c.rect1[0]),m.$("[name=DetectSize-1]").numberfield("value",c.rect1[1])):c.MinRect?(s.Config.SizeFilter.MinSize=c.MinRect,m.$('[name="MinSize-0"]').val(c.MinRect[0]),m.$('[name="MinSize-1"]').val(c.MinRect[1])):c.MaxRect&&(s.Config.SizeFilter.MaxSize=c.MaxRect,m.$('[name="MaxSize-0"]').val(c.MaxRect[0]),m.$('[name="MaxSize-1"]').val(c.MaxRect[1])))}),("flash"===webApp.playMode||"h5"===webApp.playMode)&&(a.subscribe("IVSRuleConfig",function(a,b){if("RuleDetectRegion"===b.shapeName)(!E.coordinates||e(E.coordinates))&&k.fillText(tl("com.DrawingIsCompletedTip"),[100,100]),E.id=1*b.shapeID,E.coordinates=[b.data[0],[b.data[0][0],b.data[1][1]],b.data[1],[b.data[1][0],b.data[0][1]]],k.EnableVideoAnalyseShape(m.containerId,b.shapeID,!0);else if("Polygon"===b.shapeName){for(var c=0;c<F.length;c++)if(F[c].id===1*b.shapeID){F.splice(c,1);break}F.push({id:1*b.shapeID,coordinates:b.data})}else"PixelCount"===b.shapeName&&webCaps.is_show_PixelCounter&&(m.$("[name=DetectSize-0]").numberfield("value",b.data[1][0]-b.data[0][0]),m.$("[name=DetectSize-1]").numberfield("value",b.data[1][1]-b.data[0][1]))}),a.subscribe("DRectBig",function(a,b){var c=s.Config.SizeFilter.MaxSize;c[0]=b.data[0],c[1]=b.data[1],c.id=1*b.shapeID,m.$('[name="MaxSize-0"]').val(b.data[0]),m.$('[name="MaxSize-1"]').val(b.data[1])}),a.subscribe("DRectSmall",function(a,b){var c=s.Config.SizeFilter.MinSize;c[0]=b.data[0],c[1]=b.data[1],c.id=1*b.shapeID,m.$('[name="MinSize-0"]').val(b.data[0]),m.$('[name="MinSize-1"]').val(b.data[1])})),webCaps.is_show_PixelCounter&&(plugin.addEvent("ResolutionChangeIvs",function(){m.$("[name=DetectSize-0]").numberfield({min:0,max:webApp.resolution.x,allowDecimal:!0,allowNegative:!1}),m.$("[name=DetectSize-1]").numberfield({min:0,max:webApp.resolution.y,allowDecimal:!0,allowNegative:!1})}),m.$("[name=DetectSize-0]").trigger("change"),m.$("[name=DetectSize-1]").trigger("change"))},leave:function(){s=null,plugin.DeleteAllVideoAnalyseShape(),plugin.addEvent("VideoAnalyzeConfig",null),plugin.addEvent("OutPutStringInfo",null),plugin.addEvent("ResolutionChangeIvs",null),plugin.SetVideoAnalyseContainerTip(0,""),plugin.EnableVideoAnalyseModule(!1),plugin.hide(),plugin.close(),K=!1,("flash"===webApp.playMode||"h5"===webApp.playMode)&&("h5"===webApp.playMode?j.hide():i.hide(),k.showMult=!1,k.hide(),a.unsubscribe("IVSRuleConfig",null),a.unsubscribe("DRectBig",null),a.unsubscribe("DRectSmall",null),webCaps.is_show_PixelCounter&&(J=null,m.$("[name=DetectSize-0]").numberfield("value",0),m.$("[name=DetectSize-1]").numberfield("value",0)))},_getConfig:function(b){f.ConfigManager.getConfig(configName).done(function(c){configJsonMap={},a.each(c,function(a,b){configJsonMap[configName[a]]=b.params.table}),u=configJsonMap.VideoAnalyseGlobal;for(var d=null,e=0;e<configJsonMap.VideoAnalyseModule[n].length;e++)if("ObjectDetect"===configJsonMap.VideoAnalyseModule[n][e].Type){d=configJsonMap.VideoAnalyseModule[n][e];break}if(E=d.DetectRegion?{id:null,coordinates:d.DetectRegion}:null,F=[],d.ExcludeRegion)for(var f=0;f<d.ExcludeRegion.length;f++)F.push({id:null,coordinates:d.ExcludeRegion[f]});if(void 0!==u[n].Scene.Depth&&m.$("[name=sceneSelect]").val(u[n].Scene.Depth),D){var g=configJsonMap.VideoWidget[n].TrafficFlowTitle;g.EncodeBlend||(g.Human.ShowHumanFlowStat=!1,g.MotorOrNon.ShowMotorFlowStat=!1,g.MotorOrNon.ShowNonMotorFlowStat=!1)}plugin.SetVideoAnalyseContainerTip(0,""),plugin.DeleteAllVideoAnalyseShape(),("flash"===webApp.playMode||"h5"===webApp.playMode)&&(k.DeleteAllVideoAnalyseShape(m.containerId),J=null),m._getNewConfig(),b&&m.$("#obj_tip").tip("success",tl("com.OperateSuccessTip"))}).fail(function(){m.$("#obj_tip").tip("error",tl("com.OperateFailTip"))})},filterRule:function(){var b=configJsonMap;A=a.extend(!0,[],t),y=0,o=[],p=[],a.each(b.VideoAnalyseRule[n],function(a,b){b.Class===ClassType&&p.push(b),b.Class===ClassType&&b.PtzPresetId===v?(o.push(b),A.splice(A.indexOf(b.Type),1)):y++}),$ruleTable.table("dataSource",o).table("selectRow",0),m._checkRuleNum()},renderRule:function(){var b=configJsonMap;if(r=s.Type,m.changeRule(),m.$("#obj_eHandler").eventHandler("set",s.EventHandler),G[r]){m.$("#obj_flowStat_txt").text(H[r]);var c=!0;if(a.each(b.TrafficFlowStat[n].Config,function(a,b){return-1!==r.indexOf(b.StatType)&&s.PtzPresetId===b.PresetID?(m.$("#obj_flowStat").prop("checked",b.Enable),c=!1,!1):void 0}),c&&(m.$("#obj_flowStat").prop("checked",!0),b.TrafficFlowStat[n].Config.push({Enable:!0,PresetID:v,StatType:I[r]})),D){var d=!1,e=b.VideoWidget[n].TrafficFlowTitle;"HumanTrait"===r?d=e.Human.ShowHumanFlowStat:"VehicleDetect"===r?d=e.MotorOrNon.ShowMotorFlowStat:"NonMotorDetect"===r&&(d=e.MotorOrNon.ShowNonMotorFlowStat),m.$("#obj_osdenable").prop("checked",d)}}if(b.FaceSnapshot&&m.$("#obj_face_swap").val(b.FaceSnapshot[n].CutoutPolicy),b.VideoEncodeROI&&m.$("#obj_enhance").prop("checked",b.VideoEncodeROI[n].DynamicTrack),b.VideoInFaceAutoExposure){var f=b.VideoInFaceAutoExposure[n];m.$("#obj_face_expo_enable").prop("checked",f.Enable),m.$("#obj_face_expo_light").slider("value",f.TargetBrightness),m.$("#obj_face_expo_time").slider("value",f.Interval)}"VehicleDetect"===r?(m.$("#i_car_attr_wrap").show(),m.$("#i_nocar_attr_wrap").hide(),m.$("#i_object_attr_wrap").hide(),m.$("#obj-car-integrity").prop("checked",!!s.Config.IntegrityFilter)):"HumanTrait"===r||"HumanDetect"===r?(m.$("#i_car_attr_wrap").hide(),m.$("#i_nocar_attr_wrap").hide(),m.$("#i_object_attr_wrap").show()):"HumanDetect"===r||"NonMotorDetect"===r&&(m.$("#i_car_attr_wrap").hide(),m.$("#i_nocar_attr_wrap").show(),m.$("#i_object_attr_wrap").hide())},changeRule:function(){m.$("[show-for]").hide(),m.$("[show-for *= "+r+"]").show();var b=s.Config.SizeFilter;if(m.$('[name="MinSize-0"]').val(b.MinSize[0]),m.$('[name="MinSize-1"]').val(b.MinSize[1]),m.$('[name="MaxSize-0"]').val(b.MaxSize[0]),m.$('[name="MaxSize-1"]').val(b.MaxSize[1]),("flash"===webApp.playMode||"h5"===webApp.playMode)&&(k.showMult=!1),m.hideAllShapes(),z){var c=m.$("#obj_eHandler").find("[cap]"),d=z[r];d?c.each(function(){var b=a(this).attr("cap");a(this).closest(".ui-form-item").toggleClass("fn-hide",-1===d.indexOf(b))}):c.closest(".ui-form-item").removeClass("fn-hide")}},changeRuleType:function(a){s.Type=a,s.Config=q[a].Config,m.renderRule()},delRule:function(a){var b=a.Config.SizeFilter.MaxSize.groupId||a.Config.SizeFilter.MinSize.groupId;void 0!==b&&("flash"===webApp.playMode||"h5"===webApp.playMode)&&k.DeleteVideoAnalyseShape(m.containerId,b),m._checkRuleNum(),A.push(a.Type)},addRule:function(){var b=A[0],c=a.extend(!0,{},q[b]),d=o.length;c.Name=m._getUniqueName(),c.PtzPresetId=v||0,$ruleTable.table("add",c,-1).table("selectRow",d),m._checkRuleNum(),A.splice(A.indexOf(b),1)},_checkRuleNum:function(){var a=o.length,b=Math.min(x-y-a,w-a);m.disabled(m.$("[data-action=titleAction]"),!b),m.$("[data-emptyreules]").toggleClass("fn-hide",!a),a?m.$("[name=obj_ctrl_area]").show():(s=null,m.hideAllShapes(),m.$("[name=obj_ctrl_area]").hide())},_getUniqueName:function(){var b=[],c=tl("com.Rule"),d=new RegExp("(^"+c+")(\\d*)$"),e=0;a.each(configJsonMap.VideoAnalyseRule[n],function(a,c){c.Class!==ClassType&&(e=d.exec(c.Name),e&&b.push(e[2]-0))}),a.each(o,function(a,c){e=d.exec(c.Name),e&&b.push(e[2]-0)}),b.sort(function(a,b){return a-b});var f=b.length+1;return a.each(b,function(a,b){return b-a>1?(f=a+1,!1):void 0}),c+f},isRuleNamesDuplicate:function(a){return a.some(function(b,c){return a.some(function(a,d){if(c!==d&&b.Name===a.Name){var e="",f=m.ruleType2Str(b.Type),g=m.ruleType2Str(a.Type);return c>d&&(e=f,f=g,g=e),m.$("#obj_tip").tip("error",""+tl(f)+tl("com.And")+tl(g)+tl("com.GroupNameSameTip")),!0}return!1})})},_getNewConfig:function(){globalMap={};var b=m.$("[sel-for = onChangePreset]").empty();webApp.DeviceType.indexOf("IPC")>-1?(globalMap[0]="Scene",b.append("<option value = 0>0</option>"),b.val(v).change(),m.filterRule()):f.PTZ.getPresets().done(function(c){var e=c||[],g={},h=[],i=[];a.each(e,function(a,b){g[b.Index]=b.Name,i.push(b.Index)}),a.each(u[n],function(b,c){b.indexOf("Scene")>-1&&a.inArray(c.PtzPresetId,i)>-1&&("ObjectDetect"==c.Type||c.TypeList&&a.inArray("ObjectDetect",c.TypeList)>-1)&&(h.push(c.PtzPresetId),globalMap[c.PtzPresetId]=b,h=h.sort(d))});for(var j=0;j<h.length;j++)b.append("<option value = "+h[j]+' class = "fn-color-ivsGreen">'+g[h[j]]+"</option>"),b.addClass("fn-color-ivsGreen");h.length<1?(b.removeClass("fn-color-ivsGreen"),b.append("<option value = -1>"+tl("com.AddPlanFirstTip")+"</option>"),v=-1,m.$("#tr_sc_tip").tip("warning",tl("com.AddPlanFirstTip")),plugin.SetIVSConfig("",0)):f.ConfigManager.getConfig("PtzMovement").done(function(a){"Preset"==a[n].Function&&(v=a[n].Index+1)}).always(function(){var c=v;a.inArray(v,h)<0&&(c=h[0]),b.val(c).change()})})},onChangePreset:function(a){a.isTrigger||(m.saveRule(),configJsonMap.VideoAnalyseRule[n]=m._reBackConfig()),v=m.$("#ipcparkingSpace_presets").val()-0,f.PTZ.gotoPreset(v).always(function(){m.filterRule()})},ruleType2Str:function(a){switch(a){case"CrossLineDetection":a="appEventCrossLineDetection";break;case"CrossRegionDetection":a="appEventCrossRegionDetection";break;case"StereoNumberStat":a="NumberStat";break;case"StereoFallDetection":a="StereoFallDetection";break;case"StereoFightDetection":a="StereoFightDetection";break;case"StereoStayDetection":a="StereoManStayDetection";break;case"StereoManNumDetection":a="StereoAbnormalCountDetection";break;case"StereoDistanceDetection":a="StereoApproachDetection";break;case"HumanTrait":a="com.People";break;case"NonMotorDetect":a="ivs.NoMotorVehicle";break;case"VehicleDetect":a="ivs.MotorVehicle"}return a},saveRule:function(){return s?void(s.EventHandler=m.$("#obj_eHandler").eventHandler("get")):!1},onCheckBox:function(b){var c=a(b.target).attr("cfg"),d=a(b.target).prop("checked"),e=configJsonMap[c][n];switch(c){case"TrafficFlowStat":var f=!0;a.each(e.Config,function(a,b){return-1!==r.indexOf(b.StatType)&&v===b.PresetID?(b.Enable=d,f=!1,!1):void 0}),f&&e.Config.push({Enable:d,PresetID:v,StatType:I[r]});break;case"VideoWidget":"HumanTrait"===r?e.TrafficFlowTitle.Human.ShowHumanFlowStat=d:"VehicleDetect"===r?e.TrafficFlowTitle.MotorOrNon.ShowMotorFlowStat=d:"NonMotorDetect"===r&&(e.TrafficFlowTitle.MotorOrNon.ShowNonMotorFlowStat=d);break;case"VideoEncodeROI":e.DynamicTrack=d;break;case"VideoInFaceAutoExposure":e.Enable=d}},onSelectSwap:function(b){configJsonMap.FaceSnapshot[n].CutoutPolicy=a(b.target).val()},chooseAllFeature:function(b){var c=a(b.target).prop("checked");$faceAttrDialog.find("#attr_list input").prop("checked",c),$facebodyAttrDialog.find("#attrbody_list input").prop("checked",c),$carAttrDialog.find("#attrcar_list input").prop("checked",c),$nocarAttrDialog.find("#attrnocar_list input").prop("checked",c)},onSetAttr:function(){var b=configJsonMap.VideoAnalyseRule[n][0].Config.FeatureList||[];$faceAttrDialog.find("#attr_list input").each(function(){var c=a(this).val();a(this).prop("checked",-1!==a.inArray(c,b))}),$faceAttrDialog.find("[chk-for = chooseAllFeature]").prop("checked",b.length==featureSupport),plugin.hide(),$faceAttrDialog.dialog("show")},onSetAttr1:function(){var b=configJsonMap.VideoAnalyseRule[n][0].Config.HumanFeatureList||[];$facebodyAttrDialog.find("#attrbody_list input").each(function(){var c=a(this).val();a(this).prop("checked",-1!==a.inArray(c,b))}),$facebodyAttrDialog.find("[chk-for = chooseAllFeature]").prop("checked",b.length==featureSupport1),plugin.hide(),$facebodyAttrDialog.dialog("show")},onSetAttr2:function(){var b=configJsonMap.VideoAnalyseRule[n][2].Config.FeatureList||[];$carAttrDialog.find("#attrcar_list input").each(function(){var c=a(this).val();a(this).prop("checked",-1!==a.inArray(c,b))}),$carAttrDialog.find("[chk-for = chooseAllFeature]").prop("checked",b.length==featureSupport2),plugin.hide(),$carAttrDialog.dialog("show")},onSetAttr3:function(){var b=configJsonMap.VideoAnalyseRule[n][1].Config.FeatureList||[];$nocarAttrDialog.find("#attrnocar_list input").each(function(){var c=a(this).val();a(this).prop("checked",-1!==a.inArray(c,b))}),$nocarAttrDialog.find("[chk-for = chooseAllFeature]").prop("checked",b.length==featureSupport3),plugin.hide(),$nocarAttrDialog.dialog("show")},onChangeCarIntegrity:function(b){s&&(s.Config.IntegrityFilter=!!a(b.target).prop("checked"))},onSelectScene:function(b){u[n].Scene.Depth=a(b.target).val()},onRefresh:function(){m._getConfig(!0)},onDefault:function(){f.ConfigManager.getDefault(configName).done(function(b){a.each(configName,function(c,d){var e=b[c].params.table;switch(d){case"TrafficFlowStat":case"FaceSnapshot":case"VideoInFaceAutoExposure":configJsonMap[d]=e;break;case"VideoWidget":configJsonMap.VideoWidget[n].TrafficFlowTitle.EncodeBlend=e[n].TrafficFlowTitle.EncodeBlend,configJsonMap.VideoWidget[n].TrafficFlowTitle.Human=e[n].TrafficFlowTitle.Human,configJsonMap.VideoWidget[n].TrafficFlowTitle.MotorOrNon=e[n].TrafficFlowTitle.MotorOrNon,configJsonMap.VideoWidget[n].TrafficFlowTitle.EncodeBlend||(configJsonMap.VideoWidget[n].TrafficFlowTitle.Human.ShowHumanFlowStat=!1,configJsonMap.VideoWidget[n].TrafficFlowTitle.MotorOrNon.ShowMotorFlowStat=!1,configJsonMap.VideoWidget[n].TrafficFlowTitle.MotorOrNon.ShowNonMotorFlowStat=!1);break;case"VideoEncodeROI":configJsonMap.VideoEncodeROI[n].DynamicTrack=e[n].DynamicTrack;break;case"VideoAnalyseRule":var f=a.grep(configJsonMap.VideoAnalyseRule[n],function(a){return a.Class!==ClassType}),g=a.grep(e[n],function(a){return a.Class===ClassType});configJsonMap.VideoAnalyseRule[n]=a.merge(f,g);break;case"VideoAnalyseModule":for(var h=null,i=0;i<e[n].length;i++)if("ObjectDetect"===e[n][i].Type){h=e[n][i],configJsonMap.VideoAnalyseModule[n][i]=h;break}if(E=h.DetectRegion?{id:null,coordinates:h.DetectRegion}:null,F=[],h.ExcludeRegion)for(var j=0;j<h.ExcludeRegion.length;j++)F.push({id:null,coordinates:h.ExcludeRegion[j]});break;case"VideoAnalyseGlobal":var k=e[n].Scene.Depth;void 0!==k&&(configJsonMap.VideoAnalyseGlobal[n].Scene.Depth=k,m.$("[name=sceneSelect]").val(k))}}),plugin.SetVideoAnalyseContainerTip(0,""),plugin.DeleteAllVideoAnalyseShape(),m.filterRule(),m.$("#obj_tip").tip("success",tl("com.DefaultSuccessTip"))}).fail(function(){m.$("#obj_tip").tip("error",tl("com.DefaultfailureTip"))})},onDefaultSD:function(){var b,c=[],d=[];f.VideoInAnalyse.getTemplateRule("ObjectDetect").done(function(e){b=e.ObjectDetect,a.each(b,function(a,b){b.PtzPresetId=m.$("#ipcparkingSpace_presets").val()-0,c.push(b)});A=a.extend(!0,[],t),y=0,o=[],a.each(configJsonMap.VideoAnalyseRule[n],function(a,b){b.Class===ClassType&&b.PtzPresetId===m.$("#ipcparkingSpace_presets").val()-0?(o.push(b),A.splice(A.indexOf(b.Type),1)):(y++,d.push(b))}),a.each(c,function(a,b){d.push(b)}),configJsonMap.VideoAnalyseRule[n]=a.extend(!0,{},d),$ruleTable.table("dataSource",c).table("selectRow",0),m._checkRuleNum()}),f.ConfigManager.getDefault(configName).done(function(b){a.each(configName,function(a,c){if("VideoAnalyseRule"!==c){var d=b[a].params.table;switch(c){case"TrafficFlowStat":case"VideoAnalyseGlobal":case"FaceSnapshot":case"VideoInFaceAutoExposure":configJsonMap[c]=d;break;case"VideoWidget":configJsonMap.VideoWidget[n].TrafficFlowTitle.EncodeBlend=d[n].TrafficFlowTitle.EncodeBlend;break;case"VideoEncodeROI":configJsonMap.VideoEncodeROI[n].DynamicTrack=d[n].DynamicTrack}}}),m.$("#obj_tip").tip("success",tl("Defaultsuccess"))}).fail(function(){m.$("#obj_tip").tip("error",tl("Defaultfailure"))})},onSave:function(){if(!K){m.saveRule(),m.saveDetectAndExcludeRegionData();for(var b=0;b<o.length;b++){var c=o[b].Config.SizeFilter.MaxSize;if(e(c))return void m.$("#obj_tip").tip("error",tl("com.PleaseDrawShapeTip"))}if(D){var d=configJsonMap.VideoWidget[n].TrafficFlowTitle;d.Human&&d.Human.ShowHumanFlowStat||d.MotorOrNon.ShowMotorFlowStat||d.MotorOrNon.ShowNonMotorFlowStat?!d.EncodeBlend&&m.$("#obj_osdenable").prop("checked")&&(d.EncodeBlend=!0):o.length===w&&(d.EncodeBlend=!1)}configJsonMap.VideoAnalyseRule[n]=m._reBackConfig();var g=[],h=[];a.each(configJsonMap,function(a,b){g.push(a),h.push(b)});var i=configJsonMap.VideoAnalyseRule[n].filter(function(a){return a.Class!==ClassType}).concat(o),j=m.isRuleNamesDuplicate(i);return j?!1:void f.ConfigManager.setConfig(g,h).done(function(){m.$("#obj_tip").tip("success",tl("com.SaveSuccessTip"))}).fail(function(){m.$("#obj_tip").tip("error",tl("com.SaveConfigFailTip"))})}},_reBackConfig:function(){var b=a.grep(configJsonMap.VideoAnalyseRule[n],function(a){return a.Class!==ClassType||a.Class===ClassType&&a.PtzPresetId!==v}),c=a.extend(!0,[],o);return a.each(c,function(a,c){delete c.__id,delete c._index,b.push(c)}),b},onClearZero:function(){var a={HumanTrait:"Human",NonMotorDetect:"NoMotor",VehicleDetect:"Motor"};f.trafficFlowStat.clearStat(n,-1,v,[a[r]])},onSetPeriod:function(){s.EventHandler&&s.EventHandler.TimeSection&&(plugin.hide(),h.open(s.EventHandler.TimeSection).done(function(a){s.EventHandler.TimeSection=a}).always(function(){"hls"!=webApp.playMode&&"flash"!=webApp.playMode&&"h5"!==webApp.playMode&&plugin.cover("#object_video")}))},onDrawRule:function(){if(!s.Enable)return void m.$("#obj_tip").tip("error",tl("com.RuleIsntEnableTip"));if("flash"===webApp.playMode||"h5"===webApp.playMode){k.showMult=!1;var a=E.id,b=E.coordinates;a&&!b?(k.RedrawVideoAnalyseShape(m.containerId,a),k.fillText(tl("com.DrawRectTip"),[100,100])):a&&b?(k.SetVideoAnalyseShapeConfig(m.containerId,a,[b[0],b[2]]),k.ShowVideoAnalyseShape(m.containerId,a,!0),k.EnableVideoAnalyseShape(m.containerId,a,!0),k.SelectVideoAnalyseShape(m.containerId,a,!0)):a||b?!a&&b&&(E.id=k.CreateMainVideoAnalyseShape(m.containerId,"RuleDetectRegion",[b[0],b[2]]),k.EnableVideoAnalyseShape(m.containerId,E.id,!0),k.SelectVideoAnalyseShape(m.containerId,E.id,!0)):(E.id=k.CreateMainVideoAnalyseShape(m.containerId,"RuleDetectRegion",null),k.fillText(tl("com.DrawRectTip"),[100,100]))}else m.toggleExcludeRegion(!1,!1),plugin.DeleteShape("MaxRect"),plugin.DeleteShape("MinRect"),plugin.DeleteShape("rect1"),k.showMult=!1,m.filterEmptyShape(E),E&&E.coordinates?(m.toggleDetectRegion(!0),plugin.SetVideoAnalyseContainerTip(0,"")):(plugin.CreateMainVideoAnalyseShape(0,"detectRegionEvent","Rect","Detect","","").done(function(a){E={},E.id=a}),plugin.SetVideoAnalyseContainerTip(0,tl("com.DrawRectTip")))},onDrawClear:function(){return s.Enable?(E&&E.id&&("flash"===webApp.playMode||"h5"===webApp.playMode?k.DeleteVideoAnalyseShape(m.containerId,E.id):plugin.DeleteVideoAnalyseShape(E.id)),E={},void m.onDrawRule()):void m.$("#obj_tip").tip("error",tl("com.RuleIsntEnableTip"))},onDrawExclude:function(){if(!s.Enable)return void m.$("#obj_tip").tip("error",tl("com.RuleIsntEnableTip"));if("flash"===webApp.playMode||"h5"===webApp.playMode){k.ToggleVisibilityOfVideoAnalyseShape(m.containerId,!1),k.showMult=!0,F||(F=[]);for(var a=0;a<F.length;a++)F[a].id&&!F[a].coordinates?(k.DeleteVideoAnalyseShape(m.containerId,F[a].id),F.splice(a,1),a--):F[a].id?k.ShowVideoAnalyseShape(m.containerId,F[a].id,!0):F[a].coordinates&&(F[a].id=k.CreateMainVideoAnalyseShape(m.containerId,"Polygon",F[a].coordinates));if(F.length<10){var b=k.CreateMainVideoAnalyseShape(m.containerId,"Polygon",null);F.push({id:b,coordinates:null}),k.fillText(tl("com.PleaseDrawRegionTip"),[100,100])
}}else m.toggleDetectRegion(!1),plugin.DeleteShape("MaxRect"),plugin.DeleteShape("MinRect"),plugin.DeleteShape("rect1"),m.filterEmptyShape(F),m.toggleExcludeRegion(!0,!1),F.length<10?(plugin.CreateMainVideoAnalyseShape(0,"excludeRegionEvent","Polygon","Exclude","","").done(function(a){F.push({id:a,coordinates:null})}),plugin.SetVideoAnalyseContainerTip(0,tl("com.PleaseDrawRegionTip"))):plugin.SetVideoAnalyseContainerTip(0,"")},onModifyExclude:function(){if(!s.Enable)return void m.$("#obj_tip").tip("error",tl("com.RuleIsntEnableTip"));if("flash"===webApp.playMode||"h5"===webApp.playMode){k.ToggleVisibilityOfVideoAnalyseShape(m.containerId,!1),k.showMult=!0,F||(F=[]);for(var a=0;a<F.length;a++)F[a].id&&!F[a].coordinates?(k.DeleteVideoAnalyseShape(m.containerId,F[a].id),F.splice(a,1),a--):F[a].id?(k.ShowVideoAnalyseShape(m.containerId,F[a].id,!0),k.SelectVideoAnalyseShape(m.containerId,F[a].id,!0)):F[a].coordinates&&(F[a].id=k.CreateMainVideoAnalyseShape(m.containerId,"Polygon",F[a].coordinates),k.SelectVideoAnalyseShape(m.containerId,F[a].id,!0))}else m.toggleDetectRegion(!1),plugin.DeleteShape("MaxRect"),plugin.DeleteShape("MinRect"),plugin.DeleteShape("rect1"),m.filterEmptyShape(F),m.toggleExcludeRegion(!0,!0),plugin.SetVideoAnalyseContainerTip(0,"")},onExcludeClear:function(){if(!s.Enable)return void m.$("#obj_tip").tip("error",tl("com.RuleIsntEnableTip"));if("flash"===webApp.playMode||"h5"===webApp.playMode){k.ToggleVisibilityOfVideoAnalyseShape(m.containerId,!1),k.showMult=!0,F||(F=[]);for(var a=0;a<F.length;a++)F[a].id&&!F[a].coordinates?(k.DeleteVideoAnalyseShape(m.containerId,F[a].id),F.splice(a,1),a--):F[a].id?k.ShowVideoAnalyseShape(m.containerId,F[a].id,!0):F[a].coordinates&&(F[a].id=k.CreateMainVideoAnalyseShape(m.containerId,"Polygon",F[a].coordinates));var b=F.pop();b&&b.id&&k.DeleteVideoAnalyseShape(m.containerId,b.id)}else{m.toggleDetectRegion(!1),plugin.DeleteShape("MaxRect"),plugin.DeleteShape("MinRect"),plugin.DeleteShape("rect1"),m.filterEmptyShape(F),m.toggleExcludeRegion(!0);var b=F.pop();b&&b.id&&plugin.DeleteVideoAnalyseShape(b.id),plugin.SetVideoAnalyseContainerTip(0,"")}!F||!F.length},toggleDetectRegion:function(a){E&&(E.id?(plugin.EnableVideoAnalyseShape(E.id,a),plugin.ShowVideoAnalyseShape(E.id,a)):a&&E.coordinates&&plugin.CreateMainVideoAnalyseShape(0,"detectRegionEvent","Rect","Detect",JSON.stringify({Detect:[E.coordinates[0],E.coordinates[2]]}),"").done(function(a){E.id=a,plugin.EnableVideoAnalyseShape(a,!0)}))},toggleExcludeRegion:function(a,b){for(var c=0;c<F.length;c++)F[c].id?(void 0!==b&&plugin.EnableVideoAnalyseShape(F[c].id,a&&b),plugin.ShowVideoAnalyseShape(F[c].id,a)):a&&F[c].coordinates&&plugin.CreateMainVideoAnalyseShape(0,"excludeRegionEvent","Polygon","Exclude",JSON.stringify({Exclude:F[c].coordinates}),"").done(function(a){F[c].id=a,void 0!==b&&plugin.EnableVideoAnalyseShape(a,b)})},filterEmptyShape:function(a){switch(Object.prototype.toString.call(a)){case"[object Object]":a.id&&!a.coordinates&&(plugin.DeleteVideoAnalyseShape(a.id),a.id=null,a.coordinates=null);break;case"[object Array]":for(var b=0;b<a.length;b++)a[b].id&&!a[b].coordinates&&(plugin.DeleteVideoAnalyseShape(a[b].id),a.splice(b,1),b--)}},saveDetectAndExcludeRegionData:function(){m.filterEmptyShape(E),m.filterEmptyShape(F);for(var a=0;a<configJsonMap.VideoAnalyseModule[n].length;a++)if("ObjectDetect"===configJsonMap.VideoAnalyseModule[n][a].Type){var b=configJsonMap.VideoAnalyseModule[n][a];if(E&&E.coordinates?b.DetectRegion=E.coordinates:(b.DetectRegion=[[0,0],[0,8191],[8191,8191],[8191,0]],E={coordinates:[[0,0],[0,8191],[8191,8191],[8191,0]]}),b.ExcludeRegion=[],F&&F.length>0)for(var c=0;c<F.length;c++)b.ExcludeRegion.push(F[c].coordinates)}},onDrawTarget:function(){if(s){if(!s.Enable)return void m.$("#obj_tip").tip("error",tl("com.RuleIsntEnableTip"));if("flash"===webApp.playMode||"h5"===webApp.playMode){k.showMult=!1,k.ToggleVisibilityOfVideoAnalyseShape(m.containerId,!1);var a=s.Config.SizeFilter.MaxSize,b=s.Config.SizeFilter.MinSize,c="max"===m.$("input:radio[name=ivsObjectDetectConfig_maxMin]:checked").val();void 0===a.groupId?(a.groupId=k.CreateMainVideoAnalyseShape(m.containerId,"DRectBigSmallShape"),b.groupId=a.groupId):k.ShowVideoAnalyseShape(m.containerId,a.groupId),void 0===a.id&&(a.id=k.AddVideoAnalyseShape(m.containerId,a.groupId,"DRectBig",a)),void 0===b.id&&(b.id=k.AddVideoAnalyseShape(m.containerId,b.groupId,"DRectSmall",b)),c?e(a)&&(k.RedrawVideoAnalyseShape(m.containerId,a.groupId,a.id),k.fillText(tl("com.DrawRectTip"),[100,100])):e(b)&&(k.RedrawVideoAnalyseShape(m.containerId,b.groupId,b.id),k.fillText(tl("com.DrawRectTip"),[100,100])),k.SelectFilterShape(m.containerId,a.groupId,a.id,c),k.SelectFilterShape(m.containerId,b.groupId,b.id,!c)}else{m.toggleDetectRegion(!1),m.toggleExcludeRegion(!1,!1),plugin.DeleteShape("rect1"),plugin.SetVideoAnalyseContainerTip(0,"");var d={},f=s.Config.SizeFilter;d.MaxRect=f.MaxSize,d.MinRect=f.MinSize,plugin.SetIVSConfig("",1),plugin.SetObjectConfig(JSON.stringify(d)),"max"===m.$("input:radio[name=ivsObjectDetectConfig_maxMin]:checked").val()?e(f.MaxSize)?plugin.AddShape(5,"","MaxRect",0,-1):plugin.SetCurShape("MaxRect"):e(f.MinSize)?plugin.AddShape(5,"","MinRect",0,-1):plugin.SetCurShape("MinRect")}}},onClearTarget:function(){if(s){if(!s.Enable)return void m.$("#obj_tip").tip("error",tl("com.RuleIsntEnableTip"));var a=s.Config.SizeFilter.MaxSize,b=s.Config.SizeFilter.MinSize,c="max"===m.$("input:radio[name=ivsObjectDetectConfig_maxMin]:checked").val();c?(a[0]=0,a[1]=0,m.$('[name="MaxSize-0"]').val(0),m.$('[name="MaxSize-1"]').val(0)):(b[0]=0,b[1]=0,m.$('[name="MinSize-0"]').val(0),m.$('[name="MinSize-1"]').val(0)),m.onDrawTarget()}},onDrawDetect:function(){if(!s.Enable)return void m.$("#obj_tip").tip("error",tl("com.RuleIsntEnableTip"));var a=m.$("[name=DetectSize-0]").numberfield("value"),b=m.$("[name=DetectSize-1]").numberfield("value");if("flash"===webApp.playMode||"h5"===webApp.playMode)k.showMult=!1,k.ToggleVisibilityOfVideoAnalyseShape(m.containerId,!1),a*b?null!==J?k.SetVideoAnalyseShapeConfig(m.containerId,J,[[(webApp.resolution.x-a)/2,(webApp.resolution.y-b)/2],[(webApp.resolution.x+a)/2,(webApp.resolution.y+b)/2]]):J=k.CreateMainVideoAnalyseShape(m.containerId,"PixelCount",[[(webApp.resolution.x-a)/2,(webApp.resolution.y-b)/2],[(webApp.resolution.x+a)/2,(webApp.resolution.y+b)/2]]):(void 0!==J&&null!==J&&k.DeleteVideoAnalyseShape(m.containerId,J),J=k.CreateMainVideoAnalyseShape(m.containerId,"PixelCount"),k.fillText(tl("com.DrawRectTip"),[100,100]));else{m.toggleDetectRegion(!1),m.toggleExcludeRegion(!1,!1),plugin.DeleteShape("MaxRect"),plugin.DeleteShape("MinRect"),plugin.SetVideoAnalyseContainerTip(0,"");var c={PixelCount:[[0,0],[a,b]],Name:"rect1"};a*b?plugin.SetObjectConfig(JSON.stringify(c)):plugin.AddShape(6,"PixelCount","rect1",-1,0)}},hideAllShapes:function(){"flash"===webApp.playMode||"h5"===webApp.playMode?k.ToggleVisibilityOfVideoAnalyseShape(m.containerId,!1):(m.filterEmptyShape(E),m.filterEmptyShape(F),m.toggleDetectRegion(!1),m.toggleExcludeRegion(!1,!1),plugin.DeleteShape("MaxRect"),plugin.DeleteShape("MinRect"),plugin.DeleteShape("rect1"),plugin.SetVideoAnalyseContainerTip(0,""))}})}),define("object_image",function(require,b,c){var d,e,f,g,h=require("jsCore/rpc"),i=require("jsCore/pageBase"),j=require("jsCore/flashplayer"),k=require("jsCore/h5player"),l=require("jsCore/pluginCanvas"),m=require("jsCore/rpcLogin"),n=null,o=0,p=0,q="ObjectDetectSnapshot",r=null,s=null,t=74,u=0,v=14,w="VehicleOSD";c.exports=i.extend({init:function(){n=this,d={VehicleOSD:{"%09":"motor_num","%12":"motor_color","%61":"motor_type","%46":"motor_logo","%58":"motor_plate","%71":"motor_model","%70":"motor_sunshade","%69":"motor_safebelt","%72":"motor_smoke","%73":"motor_call","%141":"motor_items","%107":"motor_annualinspection"},NonMotorOSD:{"%61":"nonmotor_nontype","%12":"nonmotor_noncolor","%142":"nonmotor_people","%118":"human_uppercolor","%116":"human_uppertype"},HumanTraitOSD:{"%143":"human_gender","%118":"human_uppercolor","%116":"human_uppertype","%119":"human_lowercolor","%117":"human_downtype","%121":"human_bag","%120":"human_hat"}},e={motor_num:"itc.PlateNo",motor_color:"itc.CarColor",motor_type:"itc.CarType",motor_logo:"itc.CarLogo",motor_plate:"itc.PlateColor",motor_model:"itc.CarSeries",motor_sunshade:"ivs.SunLouver",motor_safebelt:"ivs.SafetyBelt",motor_smoke:"ivs_osd.TitleBit59",motor_call:"ivs_osd.TitleBit60",motor_items:"ivs.CarItems",motor_annualinspection:"ivs.InspectionSticker",nonmotor_nontype:"itc.CarType",nonmotor_noncolor:"itc.CarColor",nonmotor_people:"ivs.Rider",human_gender:"Gender",human_uppercolor:"ivs.UpperBodyColor",human_uppertype:"ivs.UpClothesType",human_lowercolor:"ivs.LowerBodyColor",human_downtype:"ivs.DownClothesType",human_bag:"ivs.Bag",human_umbrella:"ivs.Umbrella",human_carrierbag:"ivs.CarrierBagStatus",human_hat:"ivs.Hat",human_helmet:"ivs.Helmet",osd_time:"com.Time",osd_address:"com.Place"},f={"%y%M%d%h%m%s":"osd_time","%19":"osd_address"};for(var b={VehicleDetect:"VehicleOSD",NonMotorDetect:"NonMotorOSD",HumanTrait:"HumanTraitOSD"},c={VehicleDetect:"ivs.MotorVehicle",NonMotorDetect:"ivs.NoMotorVehicle",HumanTrait:"com.People"},h="",i="",j="",k=0;v>k;k++)h+='<div class="traffic_OSD_item" item-num='+k+"></div>";a.each(d,function(b,c){j+='<div type-for="'+b+'">',a.each(c,function(a,b){i+='<div class="traffic_OSD_move" t="'+e[b]+'" id="'+b+'" data-val='+a+"></div>",j+='<label class="ui-label"><input type="checkbox" name='+b+"><span t="+e[b]+"></span></label>"}),j+="</div>"}),a.each(f,function(a,b){i+='<div class="traffic_OSD_move" t="'+e[b]+'" id="'+b+'" data-val='+a+"></div>"}),n.$("#tr_image_move").empty().append(h+i).translation(),n.$(".traffic_OSD_wrap").empty().append(j).translation(),a.each(d,function(a,b){b["%y%M%d%h%m%s"]="osd_time",b["%19"]="osd_address"}),n.$(":checkbox[name]").click(function(){var b=a(this);b.prop("checked")?n._addItem(b.attr("name"),!0):n._delItem(b.attr("name"))}),n.$("#tr_image_move").drag({dragElements:".traffic_OSD_move",droppables:".traffic_OSD_item",start:function(a,b){b.ui.target.addClass("traffic_OSD_moving")},drag:function(){},stop:function(a,b){var c=b.ui.overed,d=b.ui.target,e=n.$(".traffic_OSD_item[item-num="+d.attr("move-num")+"]");if(c&&c.hasClass("enable")&&c.attr("item-num")!=d.attr("move-num")){var f=(n.$(".traffic_OSD_move[move-num="+c.attr("item-num")+"]"),c.attr("item-num")),g=(c.position().left,n.$(".traffic_OSD_item.enable").length);if(d.attr("move-num")-0>c.attr("item-num")-0)for(var h=g-1;h>=f;h--)h>=d.attr("move-num")||n.$(".traffic_OSD_move[move-num="+h+"]")&&n.$(".traffic_OSD_move[move-num="+h+"]").css({left:(h+1)%6*t+10,top:26*Math.floor((h+1)/6)+10}).attr("move-num",h+1);else for(var h=0;f>=h;h++)h<=d.attr("move-num")-0||n.$(".traffic_OSD_move[move-num="+h+"]")&&n.$(".traffic_OSD_move[move-num="+h+"]").css({left:(h-1)%6*t+10,top:26*Math.floor((h-1)/6)+10}).attr("move-num",h-1);d.css({left:c.position().left+10,top:c.position().top}).attr("move-num",c.attr("item-num")),c.removeClass("moveTag")}else d.css({left:e.position().left+10,top:e.position().top});d.removeClass("traffic_OSD_moving")}}),n.$("#image_addressVal").textfield({length:45,validReg:/^[^|]+$/,errorHandle:"prevent"}).on("blur",function(){g=a(this).textfield("value")}),ability.get("IVSCaps").done(function(d){var e=d.SupportedScenes.ObjectDetect.SupportedRules,f=n.$('[sel-for="onChangeType"]').empty();a.each(e,function(a){f.append("<option value="+b[a]+">"+tl(c[a])+"</option>")})}).always(function(){n.render()})},destory:function(){n.$(".traffic_OSD_move").each(function(a,b){delete n[b.id]})},render:function(){if("flash"===webApp.playMode)j.cover(n.$("#traffic_image_video")),j.playPreview(1,0);else if("h5"===webApp.playMode){var b=new a.Deferred;k.playPreview(1,0,n.$("#traffic_image_video"),null,b),b.done(function(a){webApp.resolution.x=a.width,webApp.resolution.y=a.height})}else plugin.cover("#traffic_image_video",function(a){plugin.SetRegionNum(0),plugin.SetModuleMode(2),m.chkAuthority("Monitor_01")&&plugin.open(),a&&n.onRefresh(!1)});n._getConfig(!1)},leave:function(){plugin.hide(),plugin.close(),"flash"===webApp.playMode?(j.hide(),l.hide()):"h5"===webApp.playMode&&(k.hide(),l.hide())},onRefresh:function(a){return n.disabled("[btn-for=onRefresh]"),n._getConfig(a),!1},onDefault:function(){return n.disabled("[btn-for=onDefault]"),h.ConfigManager.getDefault(q).done(function(a){s=a,g="",n.$("[sel-for = onChangeType]").val(w).change(),n.$(".u-tip").tip("success",tl("com.DefaultSuccessTip"))}).fail(function(){n.disabled("[btn-for=onDefault]",!1),n.disabled("[btn-for=onSave]"),n.$(".u-tip").tip("error",tl("com.DefaultfailureTip"))}),!1},onSave:function(){return n.disabled("[btn-for=onSave]"),n.saveOrder(),n.saveElement(),h.ConfigManager.setConfig(q,s).done(function(){n.$(".u-tip").tip("success",tl("com.SaveSuccessTip"))}).fail(function(){n.$(".u-tip").tip("error",tl("com.SaveConfigFailTip"))}).always(function(){n.disabled("[btn-for=onSave]",!1)}),!1},saveOrder:function(){var b=[];n.$(".traffic_OSD_move[move-num]").each(function(c,d){var e=a(d);b[e.attr("move-num")]=e.attr("data-val")}),r=b.join(""),s[p][w].OSDOrder=r,a.each(f,function(b){var c=r.indexOf(b)>-1;a.each(s[p],function(a,d){if(a!==w){var e=d.OSDOrder.indexOf(b)>-1;c?e||(d.OSDOrder+=b):e&&(d.OSDOrder=d.OSDOrder.replace(b,""))}})})},saveElement:function(){a.each(d,function(b,c){var d=s[p][b].OSDOrder,e=[],f=!1;a.each(c,function(a){var b="";d.indexOf(a)>-1&&("%19"==a&&(b=g,f=!0),e.push({Name:a,NameType:0,Postfix:b,SeperaterCount:1}))}),!f&&a.trim(g)&&e.push({Name:"%19",NameType:0,Postfix:g,SeperaterCount:1}),s[p][b].OSDCustomizeSort[0].Element=e})},_getConfig:function(a){h.ConfigManager.getConfig(q).done(function(b){s=b,g="",n.$("[sel-for = onChangeType]").val(w).change(),a&&n.$(".u-tip").tip("success",tl("com.OperateSuccessTip"))}).fail(function(){n.disabled("[btn-for=onSave]"),n.$(".u-tip").tip("error",tl("com.OperateFailTip")),n.disabled("[btn-for=onRefresh]",!1)})},_addItem:function(a,b){var c=n.$(".traffic_OSD_item:not(.enable):first").addClass("enable").position();n.$("#"+a).attr("move-num",o).show().css({left:c.left+10,top:c.top}),o++,b&&n._reSetLimitHeight()},_delItem:function(b){var c=n.$("#"+b).hide();n.$(".traffic_OSD_item.enable:last").removeClass("enable"),c.siblings("[move-num]").each(function(b,d){if(a(d).attr("move-num")-0>c.attr("move-num")-0){var e=a(d).attr("move-num");a(d).css({left:(e-1)%6*t+10,top:26*Math.floor((e-1)/6)+10}).attr("move-num",e-1)}}),o--,c.removeAttr("move-num",""),n._reSetLimitHeight()},_reSetLimitHeight:function(a){var b=u;a=a||o,u=26*Math.ceil(a/6),b!=u&&(n.$("#tr_image_move").height(u),window.setTimeout(function(){plugin.cover("#traffic_image_video"),"flash"===webApp.playMode?j.cover(n.$("#traffic_image_video")):"h5"===webApp.playMode&&k.cover(n.$("#traffic_image_video"))},0))},_render:function(b){if(!g){n.$("#image_addressVal").textfield("value","");for(var c=s[p][w].OSDCustomizeSort[0].Element,e=0;e<c.length;e++)"%19"==c[e].Name&&(g=c[e].Postfix,n.$("#image_addressVal").textfield("value",g))}o=0,n.$(".traffic_OSD_move").removeAttr("move-num").hide(),n.$(".traffic_OSD_item").removeClass("enable"),n.$(":checkbox[name]").prop("checked",!1);var f=[],h=d[w],i=0;a.each(h,function(a,c){var d=b.indexOf(a);d>-1&&(f[d]=c,i++)}),n._reSetLimitHeight(i),a.each(f,function(a,b){b&&(n.$(":checkbox[name="+b+"]").prop("checked",!0),n._addItem(b))}),n.disabled("[btn-for=onDefault]",!1),n.disabled("[btn-for=onRefresh]",!1)},onChangeType:function(b){b.isTrigger||n.saveOrder(),w=a(b.target).val(),r=s[p][w].OSDOrder,n.$("[type-for]").hide(),n.$("[type-for = "+w+"]").show(),n._render(r)}})}),define("object_report",function(require,b,c){function d(a,b,c){var d,e,f,g,h;if(!(b>=a)){if(d=(a-b)/c,g=Math.pow(10,parseInt(Math.log(d)/Math.log(10)))==d?Math.pow(10,parseInt(Math.log(d)/Math.log(10))):Math.pow(10,parseInt(Math.log(d)/Math.log(10))+1),e=(d/g).toFixed(6),e=e>=0&&.1>=e?.1:e>=.100001&&.2>=e?.2:e>=.200001&&.25>=e?.25:e>=.250001&&.5>=e?.5:1,e*=g,parseInt(b/e)!=b/e&&(b=0>b?-1*Math.ceil(Math.abs(b/e))*e:parseInt(Math.abs(b/e))*e),parseInt(a/e)!=a/e&&(a=parseInt(a/e+1)*e),f=(a-b)/e,c>f&&(h=c-f,f=c,a+=h%2===0?e*parseInt(h/2):e*parseInt(h/2+1),b-=e*parseInt(h/2)),c=f,0>b){var i=(a-b)/c,j=(a+b)/i;return[a+b,0,j]}return[a,b,c]}}function e(){var a=v.$("#traffic_motor").prop("checked"),b=v.$("#traffic_nomotor").prop("checked"),c=v.$("#traffic_human").prop("checked"),e=v.$("#traffic_showNum").prop("checked"),f=v.$('[chartType="bar"]').prop("checked"),g=0;coordinateY=0;var h=function(a){var b=a;return b=a%10===0||10>a?a:10*Math.ceil(a/10)},i=0;return a&&(i+=1),b&&(i+=2),c&&(i+=4),w.nDirectionStat=i,(g=Math.max(a&&w.motorMax,b&&w.nomotorMax,c&&w.humanMax))?(coordinateY=d(h(g),0,10),w.MaxData=coordinateY[0],w.YCount=coordinateY[2],w.ShowNumber=e,w.nShowType=f?0:1,!0):!1}function f(a){var b=new Date,c=b.getTimezoneOffset();return b.setTime(1e3*a+6e4*c),b.format()}function g(a){var b=new Date,c=b.getTimezoneOffset();return(a-6e4*c)/1e3}var h,i,j,k,l,m,n,o,p,q,r,s=require("jsCore/pageBase"),t=require("jsCore/rpc"),u=require("jsCore/plugin"),v=(require("lib/jquery.jqplot"),null),w=null,x={Minute:"com.HourReportRangeTip",Hour:"com.DayReportRangeTip",Day:"com.MonthReportRangeTip",Month:"com.YearReportRangeTip"},y=!1,z=0,A="";c.exports=s.extend({init:function(){v=this,h=v.$("#traffic_st_date").datepicker({change:function(a,b){if(j.datepicker("minDate",b.value),"Month"===v.$("select[sel-for=onChangeReportType]").val()){var c=new Date(b.value.replace(/-/g,"/"));c.setDate(1),h.datepicker("value",c)}}}),v.$("#traffic_st_date").parent().css("min-width","978px"),i=v.$("#traffic_st_time").timefield({disableS:!0}),j=v.$("#traffic_en_date").datepicker({change:function(a,b){if("Month"===v.$("select[sel-for=onChangeReportType]").val()){var c=new Date(b.value.replace(/-/g,"/"));c.setDate(1),c.addMonths(1),c.setDate(0),j.datepicker("value",c)}}}),k=v.$("#traffic_en_time").timefield({disableS:!0}),v.$("#traffic_motor,#traffic_nomotor,#traffic_human,#traffic_showNum,[chartType=bar],[chartType=line]").on("click",function(){if(w){if(!e())return a.alert(tl("com.NoDataTip")),void v._clearChart();v._drawChart(w)}}),ability.get("FlowStat").done(function(b){if(b&&b[0]){var c={traffic_human:"Human",traffic_nomotor:"NonMotor",traffic_motor:"Vehicle"};a.each(c,function(a,c){b[0][c]&&b[0][c].Support||(v.$("#"+a).prop("checked",!1),v.$("#"+a).parent().hide())})}}).always(function(){v.render()})},render:function(){y=!1,a(window).on("resize.traffic",function(){w&&v._drawChart(w)}),v.onChangeReportType(),w?v._drawChart(w):v.disabled("[btn-for=onExport]",!0),t.ConfigManager.getConfig("Locales").done(function(a){switch(a.TimeFormat.split(" ")[0]){case"MM-dd-yyyy":h.datepicker("format","mm-dd-yyyy"),j.datepicker("format","mm-dd-yyyy");break;case"dd-MM-yyyy":h.datepicker("format","dd-mm-yyyy"),j.datepicker("format","dd-mm-yyyy");break;default:h.datepicker("format","yyyy-mm-dd"),j.datepicker("format","yyyy-mm-dd")}switch(a.TimeFormat.split(" ")[1]){case"HH:mm:ss":i.timefield("format","24"),k.timefield("format","24");break;default:i.timefield("format","12"),k.timefield("format","12")}})},leave:function(){y=!0,v._clearChart(!0),a(window).off("resize.traffic")},destory:function(){v._clearChart(!0),a(window).off("resize.traffic")},initRules:function(a){if(a){var b,c="";for(b=1;a+1>b;b++)c+="<option value="+b+">"+b+"</option>";v.$("#f_r_pid").html(c).parent().removeClass("fn-hide")}},onChangeReportType:function(){{var b=v.$("select[sel-for=onChangeReportType]").val(),c=new Date,d=c.getFullYear(),e=c.getMonth();c.getDate()}v.$("#traffic_tips_txt").text(tl(x[b])),i.hide(),k.hide(),"Minute"==b?(i.show(),k.show(),h.datepicker("value",c),j.datepicker("value",c),i.timefield("value",a.pad(c.getHours(),2)+":00:00"),k.timefield("value",a.pad(c.getHours()+1,2)+":00:00"),i.timefield("disabled",{disableM:!1}),k.timefield("disabled",{disableM:!1})):"Hour"==b?(i.show(),k.show(),h.datepicker("value",c),j.datepicker("value",c),i.timefield("value","00:00:00"),k.timefield("value",a.pad(c.getHours(),2)+":00:00"),i.timefield("disabled",{disableM:!0}),k.timefield("disabled",{disableM:!0})):"Day"==b?(h.datepicker("value",new Date(d,e,1)),j.datepicker("value",c)):(h.datepicker("value",new Date(d,0,1)),c.setDate(1),c.addMonths(1),c.setDate(0),j.datepicker("value",c)),j.datepicker("minDate",h.datepicker("value"))},_clearChart:function(a){v.$("#traffic_title").html(""),v.$("#traffic_chart").empty().addClass("ui-emptyChart"),a&&(w=null)},onSearch:function(){if(A=v.$("select[sel-for=onChangeReportType]").val(),l=h.datepicker("value")+" ",m=j.datepicker("value")+" ",n=null,o=null,p=null,q=null,r=null,v.disabled("[btn-for=onExport]",!0),"Minute"==A){if(v.$("#traffic_reportTip").tip("warning",tl("com.HourReportErrorTip")),l+=i.timefield("value"),m+=k.timefield("value"),n=l,o=m,q=new Date(l.replace(/-/g,"/")),r=new Date(m.replace(/-/g,"/")),q.addHours(1)<r)return a.alert(tl(x[A])),void v._clearChart(!0)}else if("Hour"==A){if(l+=i.timefield("value"),m+=k.timefield("value"),n=l,o=m,q=new Date(l.replace(/-/g,"/")),r=new Date(m.replace(/-/g,"/")),q.addDays(1)<r)return a.alert(tl(x[A])),void v._clearChart(!0)}else if("Day"==A){if(n=l,o=m,l+="00:00:00",m+="23:59:59",q=new Date(l.replace(/-/g,"/")),r=new Date(m.replace(/-/g,"/")),q.addMonths(1)<r)return a.alert(tl(x[A])),void v._clearChart(!0)}else if("Month"==A){v.$("#traffic_reportTip").tip("warning",tl("com.YearReportErrorTip"));var b=new Date(l.replace(/-/g,"/")),c=new Date(m.replace(/-/g,"/"));if(b.setDate(1),c.setDate(1),c.addMonths(1),c.setDate(0),h.datepicker("value",b),j.datepicker("value",c),l=a.formatDate(b,"yyyy/MM/dd"),m=a.formatDate(c,"yyyy/MM/dd"),l+=" 00:00:00",m+=" 23:59:59",n=l.substr(0,7),o=m.substr(0,7),q=new Date(l.replace(/-/g,"/")),r=new Date(m.replace(/-/g,"/")),q.addYears(1)<r)return a.alert(tl(x[A])),void v._clearChart(!0)}if(new Date(l.replace(/-/g,"/"))>new Date(m.replace(/-/g,"/")))return a.alert(tl("com.BeginTLessThanEndTTip")),v._clearChart(!0),!1;var d=v.$("#traffic_motor").prop("checked"),e=v.$("#traffic_nomotor").prop("checked"),f=v.$("#traffic_human").prop("checked");if(!(d||e||f))return a.alert(tl("com.ChooseType")),v._clearChart(!0),!1;p=n+" ~ "+o+" "+tl("ivs.ObjectFlowStat");var g={StartTime:l,EndTime:m,Granularity:A,Channel:z,PresetID:[]};t.trafficFlowStat.startFind(g).done(function(b){var c=b.token,d=b.totalCount;t.trafficFlowStat.doFind(c,d).done(function(b){if(b&&!b.info)return a.alert(tl("com.NoDataTip")),v._clearChart(!0),!1;if(!y){var d=v.addEmptyData(A,l,m,b.info);b.info=d,v._formatChartData(b,A,p),t.trafficFlowStat.stopFind(c)}}).fail(function(){v._clearChart(!0),a.alert(tl("com.NoDataTip"))})}).fail(function(){a.alert(tl("com.OpearFaildTip")),v._clearChart(!0)})},_formatChartData:function(b,c,g){var h=[],i=[],j=[],k=[],l=0,m=v.$("#traffic_motor").prop("checked"),n=v.$("#traffic_nomotor").prop("checked"),o=v.$("#traffic_human").prop("checked");a.each(b.info,function(a,b){i[a]=b.MotoVehicles,b.NoMotoVehicles=h[a]=b.Vehicles-b.MotoVehicles,j[a]=b.VehicleTypeFlow&&b.VehicleTypeFlow.PasserbyVehicles,b.StartTime=k[a]=f(b.UTC)});var p=Math.max.apply(null,h),q=Math.max.apply(null,i),r=Math.max.apply(null,j),s=Math.max(p,q,r),t=Math.max(m&&p,n&&q,o&&r);if(v._clearChart(!0),!t)return a.alert(tl("com.NoDataTip"));v.disabled("[btn-for=onExport]",!1),l=d(t,0,10),w={motor:h,nomotor:i,human:j,YCount:l[2],MaxData:l[0],ShowNumber:!0,title:g,motorTotal:0,nomotorTotal:0,humanTotal:0,params:b,timeArr:[],nReportType:0,nDirectionStat:0,nShowType:0,motorMax:p,nomotorMax:q,humanMax:r,totalMax:s},"Minute"==c?(a.each(k,function(a,b){w.timeArr[a]=b.substr(5,11).replace(/\-/g,"/")}),w.nReportType=3):"Hour"==c?(a.each(k,function(a,b){w.timeArr[a]=b.substr(5,8).replace(/\-/g,"/")+":00"}),w.nReportType=0):"Day"==c?(a.each(k,function(a,b){w.timeArr[a]=b.substr(0,10).replace(/\-/g,"/")}),w.nReportType=1):(a.each(k,function(a,b){w.timeArr[a]=b.substr(0,7).replace(/\-/g,"/")}),w.nReportType=2);for(var u=0;u<h.length;u++)w.motorTotal+=h[u],w.nomotorTotal+=i[u],w.humanTotal+=j[u];e(),v._drawChart(w)},_drawChart:function(b){var c=b.motor,d=b.nomotor,e=b.human,f=a.extend([],b.timeArr),g=null,h=[],i=[],j=0,k=50,l=[],m=b.nDirectionStat,n=b.ShowNumber;if(v._clearChart(),1&m&&(h.push(c),i.push({label:tl("ivs.MotorVehicle")+(n?b.motorTotal:"")}),l.push("#f00")),2&m&&(h.push(d),i.push({label:tl("ivs.NoMotorVehicle")+(n?b.nomotorTotal:"")}),l.push("#00f")),4&m&&(h.push(e),i.push({label:tl("com.People")+(n?b.humanTotal:"")}),l.push("#0f0")),!h.length)return void v.disabled("[btn-for=onExport]",!0);v.disabled("[btn-for=onExport]",!1),v.$("#traffic_title").html(w.title);var o=v.$("#traffic_chart").width()/f.length;150>o&&(j=-30,k=.3*o),g=v.$('[chartType="bar"]').prop("checked")?{renderer:a.jqplot.BarRenderer,rendererOptions:{barWidth:k,barMargin:0,barPadding:0,fillToZero:!0},pointLabels:{show:n,edgeTolerance:-50}}:{pointLabels:{show:n,edgeTolerance:-50}};a.jqplot("traffic_chart",h,{seriesColors:l,seriesDefaults:g,series:i,legend:{show:!0,placement:"outsideGrid"},grid:{background:"#dedede",gridLineColor:"#999",borderColor:"#999"},axes:{xaxis:{renderer:a.jqplot.CategoryAxisRenderer,ticks:f,tickRenderer:a.jqplot.CanvasAxisTickRenderer,tickOptions:{markSize:5,_styles:{"margin-top":"10px"},showGridline:!1,angle:j}},yaxis:{min:0,max:b.MaxData,numberTicks:b.YCount+1}}})},addEmptyData:function(b,c,d,e){var h=new Date(c.replace(/-/g,"/")),i=new Date(d.replace(/-/g,"/")),j=a.extend(!0,{},e[0],{MotoVehicles:0,Vehicles:0,VehicleTypeFlow:{PasserbyVehicles:0}}),k=[];switch(b){case"Minute":var l=5*Math.ceil(h.getMinutes()/5),m=5*Math.ceil(i.getMinutes()/5);for(h.setMinutes(l),i.setMinutes(m);i>h;){var n=g(h),o=e.map(function(a){return a.UTC}),p=o.indexOf(n);k.push(-1===p?a.extend(!0,{},j,{UTC:n}):a.extend(!0,{},e[p])),h.addMinutes(5)}break;case"Hour":for(;i>=h;){var n=g(h),o=e.map(function(a){var b=new Date(f(a.UTC).replace(/-/g,"/"));return b.setMinutes(0),g(b)}),p=o.indexOf(n);k.push(-1===p?a.extend(!0,{},j,{UTC:n}):a.extend(!0,{},e[p])),h.addHours(1)}break;case"Day":for(;i>=h;){var n=g(h),o=e.map(function(a){var b=new Date(f(a.UTC).replace(/-/g,"/"));return b.setHours(0,0),g(b)}),p=o.indexOf(n);k.push(-1===p?a.extend(!0,{},j,{UTC:n}):a.extend(!0,{},e[p])),h.addDays(1)}break;case"Month":for(;i>=h;){var n=g(h),o=e.map(function(a){var b=new Date(f(a.UTC).replace(/-/g,"/"));return b.setDate(1),b.setHours(0,0),g(b)}),p=o.indexOf(n);k.push(-1===p?a.extend(!0,{},j,{UTC:n}):a.extend(!0,{},e[p])),h.addMonths(1)}}return k},onExport:function(){u.GetConfigPath("LiveSnapshot").done(function(b){b=b+(a.browser.Platform.win?"\\":"/")+tl("ivs.ObjectFlowStat")+(new Date).format("yyyyMMddHHmmss"),u.ShowSaveOrOpenDlg("saveFile",b,[{description:"bmp( *.bmp)",extensions:["bmp"]},{description:"Microsoft Office (*.csv)",extensions:["csv"]}]).done(function(b){var c,d={};d.params=w.params,d.MaxData=w.MaxData,d.YCount=w.YCount,d.ShowNumber=w.ShowNumber,d.motorTotal=w.motorTotal,d.nomotorTotal=w.nomotorTotal,d.humanTotal=w.humanTotal,d.reportType="objectDetect",d.title=w.title,c="bmp"===b[2]?w.nShowType:2,u.MakeReport(w.nReportType,w.nDirectionStat,c,JSON.stringify(d),b[1]).done(function(b){a.alert(b?tl("com.ExportSuccessTip"):tl("com.ExportFailTip"))})})})}})})}(jQuery);