!function(a){define(function(require,a,b){b.exports=require("jsCore/pageTab")}),define("fire_detect",function(require,b,c){var d=require("jsCore/rpc"),e=require("jsCore/pageBase"),f=require("jsCore/rpcLogin"),g=require("jsCore/plugin"),h=require("jsCore/pluginCanvas"),i=require("jsCore/modules/timeSection"),j=require("jsCore/ability");require("jsCore/modules/eventHandler");var k=require("jsCore/hlsplayer"),l=require("jsCore/flashplayer"),m=0,n=null,o=null,p=null,q=null,r=!1,s=!1,t=!1,u=!1,v={rect:null,max:4,curShapeID:0,length:0,render:a.noop,leave:a.noop,save:a.noop,clear:a.noop},w=0,x=4,y=[[[0,4096],[8191,4096]],[[4096,0],[4096,8191]],[[6144,0],[6144,8191]]],z=[[4096,4096],[6144,4096],[4096,8185],[6144,8185]];c.exports=e.extend({init:function(){n=this,w=0,n.$("[cfg][key=Sensitivity]").slider({min:7,max:10,complete:function(a,b){var c=n.$(a.target),d=c.attr("key");o.Config[d]=b.value}}),n.$("#fire_AB,#fire_BC,#fire_CD,#fire_DA,#fire_OD").numberfield({max:100,min:0,allowDecimal:!0,decimalPrecision:2,allowNegative:!1}),n.$("#fire_location").on("click",function(b){a(b.target).prop("checked")?n.$("#fire_location_wrap").show():n.$("#fire_location_wrap").hide()}),n.$("#fireDetect_enable").on("click",function(b){h.enabled=0,a(b.target).prop("checked")?(n.onDrawExclude(!1),u=s&&t?!0:!1):(n.hideExclude(),u=!1),u&&n.$("#FD_sc_tip").tip("error",tl("ivs.WDFireConflictTip"))}),"flash"!==webApp.playMode&&(v.render=function(){g.addEvent("VideoAnalyzeConfig",function(a){var b=JSON.parse(a),c=b.EventParam;if("ExcludeEvent"===b.EventName&&0===c.ShapeState&&3===c.PreShapeState){if(v.curShapeID=c.ShapeID,--v.length)return!1;v.curShapeID=0}"ExcludeEvent"===b.EventName&&3===c.ShapeState&&(v.curShapeID=c.ShapeID,g.GetVideoAnalyseShapeConfigData(c.ShapeID).done(function(a){a=JSON.parse(a),v.rect[c.ShapeID]=a[c.ShapeName]})),"LineShapeEvnet"===b.EventName&&g.SetVideoAnalyseShapeColor(c.ShapeID,255,255,255,!1),"SpotShapeEvent"===b.EventName&&g.SetVideoAnalyseShapeColor(c.ShapeID,255,0,0,!1)}),g.EnableVideoAnalyseModule(!0)},v.leave=function(){g.SetVideoAnalyseContainerTip(0,""),g.DeleteAllVideoAnalyseShape(),g.EnableVideoAnalyseModule(!1),g.addEvent("VideoAnalyzeConfig",null)},v.save=function(b){if(v.rect){var c=[];a.each(v.rect,function(a,b){b?c.push(b):(n.onExcludeClear(!1),g.SetVideoAnalyseContainerTip(0,""))});for(var d=n.$("#ipc_fireDetect_presets").val()-0,e=0;e<b[m].length;e++)if(b[m][e].PtzPresetId===d&&"SmokeFire"===b[m][e].Type){b[m][e].ExcludeRegion=c;break}}},v.clear=function(){g.SetVideoAnalyseContainerTip(0,""),v.rect=null,g.DeleteAllVideoAnalyseShape(),v.length=0,v.curShapeID=0}),webApp.EventCaps?d.EventManager.getEventLink("FireDetection").done(function(b){var c=b.name,d=a.extend({},webApp.DefaultEvent),e=webApp.EventCaps;"default"===c[m][0]?d=e:c[m].each(function(a){d[a]=!0,"AlarmOutEnable"===a?d.AlarmOutLatch=e.AlarmOutLatch:"DejitterEnable"===a?d.DejitterRange=e.DejitterRange:"RecordEnable"===a&&(d.RecordLatch=e.RecordLatch)}),n.$("#fire_event").eventHandler(d)}).fail(function(){n.$("#fire_event").eventHandler()}):n.$("#fire_event").eventHandler(),"flash"===webApp.playMode&&(h.backLines=y,h.backSpots=z,a.subscribe("RegionChanged",function(a,b){if(w=b[b.length-1],b.length>1)for(var c=n.$("#ipc_fireDetect_presets").val()-0,d=0;d<q[m].length;d++)if(q[m][d].PtzPresetId===c&&"SmokeFire"===q[m][d].Type){for(q[m][d].ExcludeRegion||(q[m][d].ExcludeRegion=[]),q[m][d].ExcludeRegion[w]=[[b[0],b[1]],[b[2],b[3]]];q[m][d].ExcludeRegion.length<4;)q[m][d].ExcludeRegion.push([[0,0],[0,0]]);break}}));var b=a.Deferred();j.get("VideoInputCapsEx").always(function(a){-1!==a.VideoInBacklight.Modes.indexOf("WideDynamic")&&(r=!0),b.resolve()}),a.when(b).always(function(){n.render()})},render:function(){"hls"==webApp.playMode?(k.cover(n.$("#fireDetectVideo")),g.hide(),k.init("","",""),k.beginPlay()):"flash"==webApp.playMode?(l.cover(n.$("#fireDetectVideo")),g.hide(),l.playPreview(1,0)):(g.cover("#fireDetectVideo",function(a){g.SetModuleMode(2),f.chkAuthority("Monitor_01")&&g.open(),a&&(v.render(),n._getConfig(!1))}),v.render()),n._getConfig()},leave:function(){v.leave(),g.hide(),k&&k.hideAndStopLoad(),l&&l.hide(),"flash"===webApp.playMode&&(l.hide(),h.hide())},_getConfig:function(b){var c=["VideoAnalyseRule","VideoAnalyseModule"];r&&c.push("VideoInBacklight","VideoAnalyseGlobal"),"flash"===webApp.playMode&&(c.push("Encode"),c.push("VideoImageControl")),d.ConfigManager.getConfig(c).done(function(d){if(p=d[0].params.table,q=d[1].params.table,s=r&&d[2]&&"WideDynamic"===d[2].params.table[m][0].Mode?!0:!1,t=!1,r&&d[3]&&d[3].params.table[0].Scene){var e=d[3].params.table[0].Scene;(e.Type&&-1!==e.Type.indexOf("SmokeFire")||e.TypeList&&-1!==e.TypeList.indexOf("SmokeFire"))&&(t=!0)}if("flash"===webApp.playMode){var f=a.inArray("Encode",c),g=a.inArray("VideoImageControl",c);if(webApp.resolution.x=d[f].params.table[0].MainFormat[0].Video.Width,webApp.resolution.y=d[f].params.table[0].MainFormat[0].Video.Height,1==d[g].params.table[0].Rotate90||2==d[g].params.table[0].Rotate90){var i;i=webApp.resolution.x,webApp.resolution.x=webApp.resolution.y,webApp.resolution.y=i}h.cover("#fireDetectVideo",webApp.resolution.x+"*"+webApp.resolution.y)}n._render(p[analyseSenceRuleMap.SmokeFire],q),n.disabled("[btn-for=onSave]",!1),b&&n.$("#FD_sc_tip").tip("success",tl("com.OperateSuccessTip"))}).fail(function(){n.disabled("[btn-for=onSave]",!0),n.$("#FD_sc_tip").tip("error",tl("com.OperateFailTip"))})},_render:function(b){a.each(b,function(b,c){if("FireDetection"===c.Type){if(o=c,n.$("#fireDetect_enable").prop("checked",o.Enable),s&&t&&o.Enable?(u=!0,n.$("#FD_sc_tip").tip("error",tl("ivs.WDFireConflictTip"))):u=!1,n.$("[cfg=FireDetect][key=Sensitivity]").slider("value",o.Config.Sensitivity),n.$("#fire_location").prop("checked",o.Config.PositionParam.Enable),n.$("#fire_AB").numberfield("value",o.Config.PositionParam.AB),n.$("#fire_BC").numberfield("value",o.Config.PositionParam.BC),n.$("#fire_CD").numberfield("value",o.Config.PositionParam.CD),n.$("#fire_DA").numberfield("value",o.Config.PositionParam.DA),n.$("#fire_OD").numberfield("value",o.Config.PositionParam.OD),o.Config.PositionParam.Enable?n.$("#fire_location_wrap").show():n.$("#fire_location_wrap").hide(),n.$("#fire_event").eventHandler("set",o.EventHandler),v.clear(),o.Enable?n.onDrawExclude(!1):n.hideExclude(),h.enabled=0,"flash"===webApp.playMode)h.SetFireDetectBackLine(5,y,z);else{var d=null;a.each(y,function(a,b){d={Line1:b},g.CreateMainVideoAnalyseShape(0,"LineShapeEvnet","LineShape","Line1",JSON.stringify(d),"").done(function(a){g.EnableVideoAnalyseShape(a,!1)})});var e=null;a.each(z,function(a,b){e={spot:[b],radius:3},g.CreateMainVideoAnalyseShape(0,"SpotShapeEvent","SpotShape","spot",JSON.stringify(e),"solid").done(function(a){g.EnableVideoAnalyseShape(a,!1)})})}return!1}})},_save:function(){o.Enable=a("#fireDetect_enable").prop("checked"),o.Config.PositionParam.Enable=n.$("#fire_location").prop("checked"),o.Config.PositionParam.AB=n.$("#fire_AB").numberfield("value"),o.Config.PositionParam.BC=n.$("#fire_BC").numberfield("value"),o.Config.PositionParam.CD=n.$("#fire_CD").numberfield("value"),o.Config.PositionParam.DA=n.$("#fire_DA").numberfield("value"),o.Config.PositionParam.OD=n.$("#fire_OD").numberfield("value"),o.EventHandler=n.$("#fire_event").eventHandler("get"),v.save(q)},onSave:function(){return u?void n.$("#FD_sc_tip").tip("error",tl("ivs.WDFireConflictTip")):(n._save(),void d.ConfigManager.setConfig(["VideoAnalyseRule","VideoAnalyseModule"],[p,q]).done(function(b){common.chkMutilCallRet(b)?a("#FD_sc_tip").tip("success",tl("com.SaveSuccessTip")):n.$("#FD_sc_tip").tip("error",tl("com.SaveConfigFailTip"))}).fail(function(){n.$("#FD_sc_tip").tip("error",tl("com.SaveConfigFailTip"))}))},onDefault:function(){var b=["VideoAnalyseRule","VideoAnalyseModule"];return"flash"===webApp.playMode&&(b.push("Encode"),b.push("VideoImageControl")),d.ConfigManager.getDefault(b).done(function(b){var c=b[0].params.table;if(q=b[1].params.table,"flash"===webApp.playMode){if(webApp.resolution.x=b[2].params.table[0].MainFormat[0].Video.Width,webApp.resolution.y=b[2].params.table[0].MainFormat[0].Video.Height,1==b[3].params.table[0].Rotate90||2==b[3].params.table[0].Rotate90){var d;d=webApp.resolution.x,webApp.resolution.x=webApp.resolution.y,webApp.resolution.y=d}h.cover("#fireDetectVideo",webApp.resolution.x+"*"+webApp.resolution.y)}for(var e=p[analyseSenceRuleMap.SmokeFire].length,f=e-1;f>=0;f--)if("FireDetection"===p[analyseSenceRuleMap.SmokeFire][f].Type){p[analyseSenceRuleMap.SmokeFire].splice(f,1);break}a.each(c[analyseSenceRuleMap.SmokeFire],function(b,c){"FireDetection"===c.Type&&(p[analyseSenceRuleMap.SmokeFire][b]=a.extend(!0,{},c))}),n._render(p[analyseSenceRuleMap.SmokeFire],q),n.disabled("[btn-for=onSave]",!1),n.$("#FD_sc_tip").tip("success",tl("com.DefaultSuccessTip"))}).fail(function(){n.disabled("[btn-for=onSave]",!0),n.$("#FD_sc_tip").tip("error",tl("com.DefaultfailureTip"))}),!1},onRefresh:function(){this._getConfig(!0)},onSetPeriod:function(){return o&&o.EventHandler&&o.EventHandler.TimeSection&&(g.hide(),i.open(o.EventHandler.TimeSection).done(function(a){o.EventHandler.TimeSection=a}).always(function(){"hls"!=webApp.playMode&&"flash"!=webApp.playMode&&g.cover("#fireDetectVideo")})),!1},onDrawExclude:function(b){if(n.$("#fireDetect_enable").prop("checked")&&b!==!1){"flash"===webApp.playMode&&(h.drawEnable=1,h.enabled=1);var c=n.$("#ipc_fireDetect_presets").val()-0;if("flash"===webApp.playMode){for(var d=null,e=0;e<q[m].length;e++)if(q[m][e].PtzPresetId===c&&"SmokeFire"===q[m][e].Type){d=q[m][e].ExcludeRegion||[];break}h.SetRegionNum(x);for(var e=0;x>e;e++){var f=d[e]||[[0,0],[0,0]],i=f[0][0],j=f[0][1],k=f[1][0],l=f[1][1];w=e,h.SetSelRegionByIndex(e,i,j,k,l,!1,void 0,!0)}h.getDelosdId&&h.getDelosdId().length>0&&h.fillText(tl("com.PleaseDrawRegionTip"),[100,100]),h.SetFireDetectBackLine(5,y,z)}else{if(v.rect)a.each(v.rect,function(a){g.ShowVideoAnalyseShape(a-0,!0)});else{v.rect={};for(var d=null,e=0;e<q[m].length;e++)if(q[m][e].PtzPresetId===c&&"SmokeFire"===q[m][e].Type){d=q[m][e].ExcludeRegion||[];break}a.each(d,function(a,b){v.length++,g.CreateMainVideoAnalyseShape(0,"ExcludeEvent","Rect","Exclude",JSON.stringify({Exclude:b}),"EnableRBtnDelete").done(function(a){v.rect[a]=b,v.curShapeID=a})})}if(v.length<v.max){if(v.curShapeID&&!v.rect[v.curShapeID])return g.SetVideoAnalyseContainerTip(0,tl("com.PleaseDrawRegionTip")),!1;g.CreateMainVideoAnalyseShape(0,"ExcludeEvent","Rect","Exclude","","EnableRBtnDelete").done(function(a){v.length++,v.rect[a]=null,v.curShapeID=a,g.SetVideoAnalyseContainerTip(0,tl("com.PleaseDrawRegionTip"))})}}}},hideExclude:function(){if("flash"===webApp.playMode)h.drawEnable=0,h.enabled=0,h.clearCanvas(),h.SetFireDetectBackLine(5,y,z);else{if(!v.rect)return;a.each(v.rect,function(a){g.ShowVideoAnalyseShape(a-0,!1)})}},onExcludeClear:function(b){if("flash"===webApp.playMode){if(!n.$("#fireDetect_enable").prop("checked")||0===h.enabled)return;h.DelSelReg(-1),h.SetFireDetectBackLine(5,y,z)}v.curShapeID&&g.DeleteVideoAnalyseShape(v.curShapeID).done(function(){g.SetVideoAnalyseContainerTip(0,""),delete v.rect[v.curShapeID],--v.length?a.each(v.rect,function(a){return v.curShapeID=a-0,b!==!1&&g.SelectVideoAnalyseShape(v.curShapeID,!0),!1}):v.curShapeID=0})}})})}(jQuery);