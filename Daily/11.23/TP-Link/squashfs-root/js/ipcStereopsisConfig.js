!function(a){define(function(require,a,b){b.exports=require("jsCore/pageTab")}),define("ipc_stereopsisRule",function(require,b,c){{var d=require("jsCore/rpc"),e=require("jsCore/pageBase"),f=require("jsCore/modules/naclDraw"),g=require("jsCore/plugin"),h=require("jsCore/ability"),i=require("jsCore/modules/timeSection");require("common/common")}require("widget/js/dui.slider"),require("jsCore/modules/eventHandler");var j,k=null,l=0,m="",n=[],o=null,p=null,q=null,r=-1,s=!1;c.exports=e.extend({init:function(){k=this,h.get("IVSCaps").done(function(b){if(b&&b.SupportedScenes&&b.SupportedScenes.StereoVision&&b.SupportedScenes.StereoVision.SupportedRules){n=[];for(var c in b.SupportedScenes.StereoVision.SupportedRules)n.push(c);if(n){var d=k.$("[sel-for=onChangeRuleType]").empty();a.each(n,function(a,b){d.append('<option value="'+b+'" t="appEvent'+b+'"></option>')}),d.translation()}}}),k.$("[cfg][key=Threshold]").slider({min:0,max:100,complete:function(a,b){var c=k.$(a.target),d=c.attr("key");p.Config[d]=b.value}}),k.$("[cfg][key=Sensitivity]").slider({min:1,max:10,complete:function(a,b){var c=k.$(a.target),d=c.attr("key");p.Config[d]=b.value}}),k.$("#ipcStereopsis_maxHeight").numberfield({max:300,min:0,allowDecimal:!1,allowNegative:!1}).blur(function(a){var b=k.$(a.target).val()-0,c=k.$("#ipcStereopsis_minHeight").val()-0;c>b&&k.$("#i_sr_tip").tip("error",tl("ivs.MaxDetectHeight")+" < "+tl("ivs.MinDetectHeight")+" !")}),k.$("#ipcStereopsis_minHeight").numberfield({max:200,min:0,allowDecimal:!1,allowNegative:!1}).blur(function(a){var b=k.$(a.target).val()-0,c=k.$("#ipcStereopsis_maxHeight").val()-0;b>c&&k.$("#i_sr_tip").tip("error",tl("ivs.MaxDetectHeight")+" < "+tl("ivs.MinDetectHeight")+" !")}),k.$("#i_sr_enable").on("click",function(){q.Enable=this.checked,this.checked?a.browser.chrome&&a.browser.version>41?q.shapeId?f.showShape(q.shapeId):k._renderNaclOcx():k._renderOcx():a.browser.chrome&&a.browser.version>41?q.shapeId?(f.ocxSetShapeTip(""),f.hideShape(q.shapeId)):k._renderNaclOcx():g.SetIVSConfig("",2)}),k.render()},render:function(){g.cover("#i_sr_video",function(){g.SetRegionNum(0),g.SetModuleMode(2),g.open(),a.browser.chrome&&a.browser.version>41?f.render(k._outPutNaclShapeRect):g.addEvent("OutPutStringInfo",function(a,b){switch(a){case"OutPutShapeRect":k._outPutShapeRect(b)}}),k._getConfig(!1)}),k._getConfig(!1)},leave:function(){a.browser.chrome&&a.browser.version>41?f.leave():(g.addEvent("OutPutStringInfo",null),g.SetIVSConfig("",2)),g.hide(),g.close()},destory:function(){a.browser.chrome&&a.browser.version>41&&f.leave()},_getConfig:function(b){d.ConfigManager.getConfig("VideoAnalyseRule").done(function(c){o=c,m?(a.each(o[l],function(a,b){"StereoVision"===b.Class&&b.Type===m&&(p=b,r=a)}),p=o[l][r]):(a.each(o[l],function(b,c){"StereoVision"===c.Class&&a.inArray(c.Type,n)>-1&&(p=c,r=b)}),p=o[l][r]),k._renderElements(p),b&&k.$("#i_sr_tip").tip("success",tl("com.OperateSuccessTip"))}).fail(function(){k.$("#i_sr_tip").tip("error",tl("com.OperateFailTip"))})},_renderElements:function(b){k.$("#i_sr_enable").prop("checked",b.Enable),k.$("[sel-for=onChangeRuleType]").val(b.Type),k.$("[sel-for=onSelAnomalyType]").val(b.Config.DetectType).change(),k.$("#ipcStereopsis_maxHeight").numberfield("value",b.Config.MaxHeight),k.$("#ipcStereopsis_minHeight").numberfield("value",b.Config.MinHeight),k.$("[cfg=StereoVision][key=Sensitivity]").slider("value",b.Config.Sensitivity),k.$("[cfg=StereoVision][key=Threshold]").slider("value",b.Config.Threshold),k.$("[cfg=StereoVision][key=Threshold]").slider("value",b.Config.Threshold),k.$("[cfg=StereoVision][key=Threshold]").slider("value",b.Config.Threshold);var c=k.$("[sel-for=onChangeRuleType]").val();"ManNumDetection"===c?(k.$("#num_threshold,#numAbnomaly_type").removeClass("fn-hide"),k.$("#distance_threshold").addClass("fn-hide")):"NearDistanceDetection"===c?(k.$("#distance_threshold").removeClass("fn-hide"),k.$("#num_threshold,#numAbnomaly_type").addClass("fn-hide")):"ManStandDetection"===c&&(k.$("#num_threshold,#numAbnomaly_type").addClass("fn-hide"),k.$("#distance_threshold").addClass("fn-hide")),webApp.EventCaps?d.EventManager.getEventLink(c).done(function(b){var c=b.name,d=a.extend({},webApp.DefaultEvent),e=webApp.EventCaps;"default"===c[l][0]?d=e:c[l].each(function(a){d[a]=!0,"AlarmOutEnable"===a?d.AlarmOutLatch=e.AlarmOutLatch:"DejitterEnable"===a?d.DejitterRange=e.DejitterRange:"RecordEnable"===a&&(d.RecordLatch=e.RecordLatch)}),k.$("#i_sr_event").eventHandler(d)}).fail(function(){k.$("#i_sr_event").eventHandler()}):k.$("#i_sr_event").eventHandler(),k.$("#i_sr_event").eventHandler("set",b.EventHandler),q=a.extend(!0,{},b),a.browser.chrome&&a.browser.version>41?setTimeout(k._renderNaclOcx,300):k._renderOcx()},onChangeRuleType:function(){var b=k.$("[sel-for=onChangeRuleType]").val();a.each(o[l],function(a,c){"StereoVision"===c.Class&&c.Type===b&&(p=c,r=a)}),k._renderElements(p)},_saveData:function(){q&&q.Config&&(p.Config.DetectLine=q.Config.DetectLine),q&&q.Config&&(p.Config.DetectRegion=q.Config.DetectRegion),p.Enable=k.$("#i_sr_enable").prop("checked"),p.Config.DetectType=k.$("[sel-for=onSelAnomalyType]").val()-0,p.Config.MaxHeight=k.$("#ipcStereopsis_maxHeight").numberfield("value"),p.Config.MinHeight=k.$("#ipcStereopsis_minHeight").numberfield("value"),p.EventHandler=k.$("#i_sr_event").eventHandler("get"),m=k.$("[sel-for=onChangeRuleType]").val()},onDefault:function(){a.browser.chrome&&a.browser.version>41&&f.shapeDeleteAll(),d.ConfigManager.getDefault("VideoAnalyseRule").done(function(b){o=b,a.each(o[l],function(a,b){"StereoVision"===b.Class&&(r=a,p=b)}),k._renderElements(p),k.$("#i_sr_tip").tip("success",tl("com.DefaultSuccessTip"))}).fail(function(){k.$("#i_sr_tip").tip("error",tl("com.DefaultfailureTip"))})},onRefresh:function(){a.browser.chrome&&a.browser.version>41&&(f.ocxSetShapeTip(""),q&&q.shapeId&&f.shapeDelete(q.shapeId)),k._getConfig(!0)},onConfirm:function(){s&&(s=!1);var b=k.$("#ipcStereopsis_minHeight").numberfield("value"),c=k.$("#ipcStereopsis_maxHeight").numberfield("value");return b>c?(k.$("#i_sr_tip").tip("error",tl("ivs.MaxDetectHeight")+" < "+tl("ivs.MinDetectHeight")+" !",1e3),!1):(a.browser.chrome&&a.browser.version>41?(f.ocxSetShapeTip(""),f.ocxAdjust(q.shapeId,q.shapeId1,!1)):g.SetCurShape("save"),k._saveData(),void d.ConfigManager.getConfig("VideoAnalyseRule").done(function(b){var c=analyseSenceRuleMap.StereoVision||l;a.each(b[c],function(a,d){"ManStandDetection"===d.Type&&(b[c][a]=p)}),o=b,d.ConfigManager.setConfig("VideoAnalyseRule",o).done(function(){k.$("#i_sr_tip").tip("success",tl("com.SaveSuccessTip"))}).fail(function(){k.$("#i_sr_tip").tip("error",tl("com.SaveConfigFailTip"))})}).fail(function(){k.$("#i_sr_tip").tip("error",tl("com.SaveConfigFailTip"))}))},onSetPeriod:function(){p&&p.EventHandler&&p.EventHandler.TimeSection&&(g.hide(),i.open(p.EventHandler.TimeSection).done(function(a){p.EventHandler.TimeSection=a}).always(function(){g.cover("#i_sr_video")}))},onDrawRule:function(){var b=!1,c=q.Name,d=q.Type,e=k._getRuleType(d),h=k.$("#i_sr_enable").prop("checked");if(!h)return k.$("#i_sr_tip").tip("warning",tl("com.RuleIsntEnableTip")),void(a.browser.chrome&&a.browser.version>41&&f.ocxSetShapeTip(""));if(s)return void k.$("#i_sr_tip").tip("error",tl("com.PleaseDrawShapeTip"));if(a.browser.chrome&&a.browser.version>41)q.shapeId&&q.Config[e]?(f.showShape(q.shapeId,q.shapeId1),f.chooseShape(q.shapeId,q.shapeId1)):(f.createShape(q.Type,"",q.Name),s=!1);else{var i=k._ruleInitEmpty(!0);if(!i)return void(b||g.SelectRule(c,0));switch(g.DeleteShape(c),d){case"ManStandDetection":case"ManNumDetection":case"NearDistanceDetection":g.AddShape(2,d,c,0,0)}s=!1}},onClearRule:function(){var b=k.$("#i_sr_enable").prop("checked");if(!b)return void k.$("#i_sr_tip").tip("warning",tl("com.RuleIsntEnableTip"));var c="";switch(q.Type){case"ManNumDetection":c="DetectRegion";break;case"ManStandDetection":case"NearDistanceDetection":c="DetectLine";break;default:c="DetectRegion"}if(a.browser.chrome&&a.browser.version>41)q.shapeId?(s=!1,f.reDrawShape(q.shapeId,q.shapeId1).done(function(){"DetectLine"==c?q.Config[c]=null:"DetectRegion"==c&&(q.Config[c]=null)})):f.createShape(q.Type,"",q.Name);else{var d=k._ruleInitEmpty(!0);if(d)return void k.$("#i_sr_tip").tip("error",tl("com.PleaseDrawShapeTip"));"DetectLine"==c?q.Config[c]=null:"DetectRegion"==c&&(q.Config[c]=null),s=!1,k._buildRuleJson(),g.DeleteShape(q.Name),g.AddShape(2,q.Type,q.Name,-1,0)}},_outPutShapeRect:function(a){s=!1;var b=q.Type,c=JSON.parse(a);switch(b){case"ManStandDetection":case"NearDistanceDetection":c.Config.DetectLine&&(q.Config.DetectLine=c.Config.DetectLine);break;case"ManNumDetection":if(c.Config.DetectRegion.length<3){s=!0;break}c.Config.DetectRegion&&(q.Config.DetectRegion=c.Config.DetectRegion);break;default:c.Config.DetectRegion&&(q.Config.DetectRegion=c.Config.DetectRegion)}},_ruleInitEmpty:function(b){k._buildRuleJson();var c=JSON.parse(j).params.table[0][0],d=!1;if(c.Config.DetectLine){var e=0;a.each(c.Config.DetectLine,function(b){a.each(c.Config.DetectLine[b],function(a,b){e+=b})}),e||(b||g.DeleteShape(c.Name),d=!0)}else if(c.Config.DetectRegion&&"array"==$type(c.Config.DetectRegion)){var f,h=c.Config.DetectRegion,i=!0;for(f=h.length;f--;)if(h[f][0]||h[f][1]){i=!1;break}i&&!b&&g.DeleteShape(c.Name),d=i}else d=!0;return d},_renderOcx:function(){q&&(k._buildRuleJson(),g.SetIVSConfig(j,2),g.SetCurShape(q.Name),k._ruleInitEmpty(),q.Enable&&g.SetCurPtzID(0),g.SetCurShape("save"))},_buildRuleJson:function(){var b=a.extend(!0,{},q);delete b.EventHandler;var c={result:!0,params:{table:[[b]]}};return j=JSON.stringify(c),JSON.stringify(c)},_outPutNaclShapeRect:function(a,b){("createDone"==a||"dragDone"==a)&&(q.shapeId=b.ShapeID,f.ocxAdjust(q.shapeId,q.shapeId1,!0)),"mousedownSelect"===a&&(q.shapeId=b.ShapeID);{var c=k._getRuleType();f.getData(b.ShapeID).done(function(a){q.Config[c]=a,s=!1})}},_renderNaclOcx:function(){var a=k._getRuleType();k.$("#i_sr_enable").prop("checked")&&(q.shapeId?(f.ocxAdjust(q.shapeId,q.shapeId1,!1),f.shapeDelete(q.shapeId)):f.createShape(q.Type,q.Config[a],q.Name).done(function(a){f.ocxAdjust(a,"",!1)}),f.ocxSetShapeTip(""))},_getRuleType:function(a){switch(a=a||q.Type){case"ManStandDetection":return"DetectLine";case"ManNumDetection":return"DetectRegion";case"StereoNumberStat":return"DetectRegion";default:return"DetectRegion"}}})}),define("ipc_stereopsisScale",function(require,b,c){{var d=require("jsCore/rpc"),e=require("jsCore/pageBase"),f=require("jsCore/plugin"),g=require("jsCore/modules/naclDraw");require("jsCore/ability"),require("common/common")}require("widget/js/dui.slider"),require("jsCore/modules/eventHandler");var h=null,i=0,j=null,k=null,l=null,m=null,n="ScaleArea",o=-1,p=0,q=0,r=[];c.exports=e.extend({init:function(){h=this,h.$("#ipcStereopsis_cameraHeight").numberfield({min:0,max:1e3,allowDecimal:!1,allowNegative:!1}),h.$("#ipcStereopsis_cameraAngle").numberfield({min:0,max:90,allowDecimal:!0,allowNegative:!1}),h.render()},render:function(){f.cover("#i_ss_video",function(){f.SetRegionNum(0),f.SetModuleMode(2),f.open(),a.browser.chrome&&a.browser.version>41?g.render(h._outPutNaclGroudRect):f.addEvent("OutPutStringInfo",function(a,b){switch(a){case"OutPutGlobalLaneInfo":h._outPutGlobalCalibrateInfo(b)}}),h._getConfig(!1)}),h._getConfig(!1)},leave:function(){a.browser.chrome&&a.browser.version>41?g.leave():(f.addEvent("OutPutStringInfo",null),f.SetIVSConfig("",2)),f.hide(),f.close()},destory:function(){a.browser.chrome&&a.browser.version>41&&g.leave()},_getConfig:function(a){d.ConfigManager.getConfig(["StereoCalibrate","VideoAnalyseGlobal"]).done(function(b){h._renderElements(b),a&&h.$("#i_ss_tip").tip("success",tl("com.OperateSuccessTip"))}).fail(function(){h.$("#i_sr_tip").tip("error",tl("com.OperateFailTip"))})},_renderElements:function(b){if(j=b[0].params.table&&b[0].params.table,k=b[1].params.table&&b[1].params.table,l=a.extend(!0,{},k),a.each(l[i].CalibrateArea,function(a,b){b&&"Stereo"===b.Method&&(o=a)}),j[i]){var c=j[i].CameraHeight,d=j[i].CameraAngle;0>c&&(c=0),0>d&&(d=0),h.$("#ipcStereopsis_cameraHeight").numberfield("value",c||0),h.$("#ipcStereopsis_cameraAngle").numberfield("value",d||0),p=d,q=c}k&&(r=k[i].CalibrateArea[o].Area),a.browser.chrome&&a.browser.version>41?setTimeout(h._renderNaclCalibrateOcx,300):h._renderCalibrateOcx()},_renderCalibrateOcx:function(){if(l[i]){var a=l[i].CalibrateArea;h._buildAnalyseGlobal(a),f.SetIVSConfig(m,0),f.SubVideoWndCtrl(12,1)}},_renderNaclCalibrateOcx:function(){if(l[i]){var a=l[i].CalibrateArea[o];a&&(a.shapeId&&(g.ocxAdjust(a.shapeId,a.shapeId1,!1),g.shapeDelete(a.shapeId)),g.createShape(a.Method,a.Area).done(function(a){g.ocxAdjust(a,"",!1)}),g.ocxSetShapeTip(""))}},_buildAnalyseGlobal:function(b){var c=null,d=[{Area:[],Type:"StereoVision",Name:n}];c=b[o]||{},a.each(c.Area,function(a,b){d[0].Area.push(b)});var e={result:!0,params:{table:[d]}};m=JSON.stringify(e)},onScaleHeight:function(){var b=!1,c=h._ruleInitEmpty(!0);if(a.browser.chrome&&a.browser.version>41){if(l){var d=l[i].CalibrateArea[o];d&&(d.shapeId?(g.showShape(d.shapeId),g.chooseShape(d.shapeId)):(g.createShape(d.Method,""),ipcIvsRuleDrawFinish=!1))}}else{if(!c)return void(b||f.SelectRule(n,0));f.DeleteShape(n),f.AddShape(0,"StereoVision",n,-1,0)}},onClearScale:function(){if(f.SetIVSConfig("",0),a.browser.chrome&&a.browser.version>41){if(l){var b=l[i].CalibrateArea[o];b.shapeId?(ipcIvsRuleDrawFinish=!1,g.reDrawShape(b.shapeId).done(function(){b.Area=[[0,0],[0,0]]}),g.chooseShape(b.shapeId)):g.createShape(b.Method,"")}}else l[i].CalibrateArea[o].Area=[[0,0],[0,0]],f.AddShape(0,"StereoVision",n,-1,0)},_ruleInitEmpty:function(a){var b=!1,c=null;return c=l[i].CalibrateArea[o],c?(c.Area?0===c.Area[0][0]&&0===c.Area[0][1]&&0===c.Area[1][0]&&0===c.Area[1][1]&&(a||f.DeleteShape(n),b=!0):b=!0,b):void 0},_outPutGlobalCalibrateInfo:function(a){var b=JSON.parse(a);l[i].CalibrateArea[o].Area=b[0].config.CalibrateArea.DetectRegion},_outPutNaclGroudRect:function(a,b){if(l){var c=l[i].CalibrateArea[o];("createDone"==a||"dragDone"==a)&&(c.shapeId||(c.shapeId=b.ShapeID,g.ocxAdjust(c.shapeId,"",!0))),"mousedownSelect"===a&&(c.shapeId=b.ShapeID);{g.getData(b.ShapeID).done(function(a){c.Area=a,ipcIvsRuleDrawFinish=!1})}}},_saveData:function(){j[i].CameraHeight=h.$("#ipcStereopsis_cameraHeight").numberfield("value"),j[i].CameraAngle=h.$("#ipcStereopsis_cameraAngle").numberfield("value")},onDefault:function(){a.browser.chrome&&a.browser.version>41&&g.shapeDeleteAll(),d.ConfigManager.getDefault(["StereoCalibrate","VideoAnalyseGlobal"]).done(function(a){h._renderElements(a,!0),h.$("#i_ss_tip").tip("success",tl("com.DefaultSuccessTip"))}).fail(function(){h.$("#i_ss_tip").tip("error",tl("com.DefaultfailureTip"))})},onRefresh:function(){if(a.browser.chrome&&a.browser.version>41&&l){a.each(l[i].CalibrateArea,function(a,b){b&&"Stereo"===b.Method&&(o=a)});var b=l[i].CalibrateArea[o];g.ocxSetShapeTip(""),b&&b.shapeId&&g.shapeDelete(b.shapeId)}h._getConfig(!0)},onConfirm:function(){if(h._saveData(),a.browser.chrome&&a.browser.version>41){var b=l[i].CalibrateArea[o];g.ocxSetShapeTip(""),b&&g.ocxAdjust(b.shapeId,"",!1)}else f.SetCurShape("save");k=a.extend(!0,[],l),h.disabled(h.$("[id^=ipcStereopsis_camera]"),!0);var c=k[i].CalibrateArea[o].Area,e=!1;a.each(r,function(b){a.each(r[b],function(a){r[b][a]!==c[b][a]&&(e=!0)})}),e?d.ConfigManager.setConfig("VideoAnalyseGlobal",k).done(function(){d.ConfigManager.getConfig(["StereoCalibrate","VideoAnalyseGlobal"]).done(function(a){h._renderElements(a),h.disabled(h.$("[id^=ipcStereopsis_camera]"),!1),h.$("#i_ss_tip").tip("success",tl("com.SaveSuccessTip"))})}).fail(function(){h.disabled(h.$("[id^=ipcStereopsis_camera]"),!1),h.$("#i_ss_tip").tip("error",tl("com.SaveConfigFailTip"))}):p!==j[i].CameraAngle||q!==j[i].CameraHeight?d.ConfigManager.setConfig("StereoCalibrate",j).done(function(){d.ConfigManager.getConfig("StereoCalibrate").done(function(a){if(j=a,j&&j[i]){var b=j[i].CameraHeight,c=j[i].CameraAngle;0>b&&(b=0),0>c&&(c=0),p=c,q=b}h.disabled(h.$("[id^=ipcStereopsis_camera]"),!1),h.$("#i_ss_tip").tip("success",tl("com.SaveSuccessTip"))})}).fail(function(){h.disabled(h.$("[id^=ipcStereopsis_camera]"),!1),h.$("#i_ss_tip").tip("error",tl("com.SaveConfigFailTip"))}):(h.disabled(h.$("[id^=ipcStereopsis_camera]"),!1),h.$("#i_ss_tip").tip("success",tl("com.SaveSuccessTip")))}})})}(jQuery);