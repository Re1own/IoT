!function(a){define(function(require,a,b){b.exports=require("jsCore/pageTab")}),define("https",function(require,b,c){var d=require("jsCore/rpc"),e=require("common/rpcBase"),f=require("jsCore/pageBase"),g=null,h=null,i={},j={},k={},l=[],m=null,n=require("common/common"),o=n.Check,p=!1,q=!1;c.exports=f.extend({init:function(){g=this,g.$("#https_enable").on("change",function(){g._renderButton()}),m=g.$("#https_addDialog").dialog({save:function(){g._onSave()}}).detach().appendTo(document.body),m.find("[cfg=CommonName], [cfg=Email]").textfield(),m.find("[cfg=State], [cfg=Locatity], [cfg=Organization],[cfg=OrganizationUnit]").textfield(),m.find("[cfg=UsefulLife]").numberfield({min:1,max:5e3,allowDecimal:!1,allowNegative:!1}),m.find("[cfg=Country]").textfield({validReg:/^[a-zA-Z]*$/,validRegRet:!0,errorHandle:"prevent"}),m.find("[cfg=Country]").keyup(function(a){a.target.value=a.target.value.toUpperCase()}),h=a.validator([{element:m.find("[cfg=Country]"),check:function(a){return/^[a-zA-Z]{2}$/.test(a)},errorMsg:["com.Need2Caps"],events:["blur"],errorElem:".u-input-error"},{element:m.find("[cfg=CommonName]"),check:[o.require,function(b){return!!a.trim(b)}],errorMsg:["com.Necessary","com.Necessary"],events:["blur","blur"],errorElem:".u-input-error"},{element:m.find("[cfg=Email]"),check:function(a){return a?/^[\w-.]+@[\w-]+(\.{1}[\w-]+)+$/.test(a):!0},errorMsg:["com.WrongEmailFormatTip"],events:["blur"],errorElem:".u-input-error"}],function(a){a.parent().translation()}),g.$("#cert_path, #key_path, #installed_cert_path, #cert_createdRequest").textfield(),g.render()},render:function(){g.$("#cert_path").textfield("value",""),g.$("#key_path").textfield("value",""),g.$("#installed_cert_path").textfield("value",""),g.$("#cert_createdRequest").textfield("value",""),g.$("#cert_info_subject").text(""),g.$("#cert_info_issuer").text(""),g.$("#cert_info_usefullife").text(""),q=!1,d.ConfigManager.getConfig("Https").done(function(a){i=a,g.$("#https_enable").prop("checked",i.Enable),p=""===i.ServerCertificate.CommonName?!1:!0,p&&e.CertManager.getSvrCertInfo().done(function(a){j=a,g._renderElements()}).fail(function(){g.tip("error","com.ConnectFailTip")}),g._renderButton()}).fail(function(){g.tip("error","com.ConnectFailTip"),g._renderButton()}),"https:"===window.location.protocol.toLowerCase()&&g.$("#https_enable").prop("disabled",!0),g.$("#cert_select").parent("div").remove(),g.$("#key_select").parent("div").remove(),"flash"===webApp.playMode||"h5"===webApp.playMode?(g.$("[btn-for=onCertSelect]").parent("div").append('<div class="ui-file fn-opacity" style="left:450px;"><input type="file" class="ui-file-box fn-opacity" id="cert_select" hidefocus="hidefocus" /></div>'),g.$("[btn-for=onKeySelect]").parent("div").append('<div class="ui-file fn-opacity" style="left:450px;"><input type="file" class="ui-file-box fn-opacity" id="key_select" hidefocus="hidefocus" /></div>'),g.$("#cert_select").on("change",g._onCertChange),g.$("#key_select").on("change",g._onKeyChange),g.$("[btn-for=onRequestDownload]").attr({target:"_blank",href:"/RPC2_DownloadRootCert/RootCert.cer"})):g.$("[btn-for=onRequestDownload]").attr("href","javascript:;").attr("target","")},onRefresh:function(){g.$("#https_enable").prop("checked",i.Enable),g.$("#cert_path").textfield("value",""),g.$("#key_path").textfield("value",""),g.$("#installed_cert_path").textfield("value",""),g.$("#cert_info_subject").text(""),g.$("#cert_info_issuer").text(""),g.$("#cert_info_usefullife").text(""),g.$("#cert_createdRequest").textfield("value",""),q=!1,d.ConfigManager.getConfig("Https").done(function(a){i=a,p=""===i.ServerCertificate.CommonName?!1:!0,p&&e.CertManager.getSvrCertInfo().done(function(a){j=a,g._renderElements(),g.tip("success","com.OperateSuccessTip")}).fail(function(){return g.tip("error","com.OperateFailTip"),!1}),g._renderButton(),g.tip("success","com.OperateSuccessTip")}).fail(function(){g.tip("error","com.OperateFailTip"),g._renderButton()})},onConfirm:function(){g.$("#https_enable").prop("checked")!==i.Enable?(g.$("#installed_cert_path").textfield("value",""),g.$("#installed_cert_info0").text(""),g.$("#installed_cert_info1").text(""),g.$("#installed_cert_info2").text(""),g.onRequestInstall()):g.tip("success","com.SaveSuccessTip")},destory:function(){m.remove()},_renderElements:function(){g.$("#https_download_cert").prop("src",""),a.each(m.find("[cfg]"),function(b,c){var d=a(c).attr("cfg");"UsefulLife"===d?a(c).numberfield("value",i.ServerCertificate[d]):a(c).textfield("value",i.ServerCertificate[d])});var b=g._toLocalTime(j.usefulLife.Start),c=g._toLocalTime(j.usefulLife.End);g.$("#installed_cert_path").textfield("value","H/IP="+i.ServerCertificate.CommonName+";C="+i.ServerCertificate.Country+";ST="+i.ServerCertificate.State+";L="+i.ServerCertificate.Locatity+";O="+i.ServerCertificate.Organization+";OU="+i.ServerCertificate.OrganizationUnit+";EM="+i.ServerCertificate.Email);var d=tl("itc.Subject")+" H/IP="+j.subject.CommonName+"; C="+j.subject.Country+"; ST="+j.subject.State+"; L="+j.subject.Locality+"; O="+j.subject.Organization+"; OU="+j.subject.OrganizationUnit+"; EM="+j.subject.Email+";",e=tl("pfm.Issuer")+" H/IP="+j.issuer.CommonName+"; C="+j.issuer.Country+"; ST="+j.issuer.State+"; L="+j.issuer.Locality+"; O="+j.issuer.Organization+"; OU="+j.issuer.OrganizationUnit+"; EM="+j.issuer.Email+";",f=tl("com.Validity")+": "+b+"~"+c;g.$("#cert_info_subject").text(d),g.$("#cert_info_issuer").text(e),g.$("#cert_info_usefullife").text(f),g._renderButton(),h.validate()},_renderButton:function(){var a=g.$("#https_enable").prop("checked");return i.Enable?(g.disabled(".ui-button",!0),g.$(".ui-button").addClass("ui-button-disabled"),g.disabled(".cert-btn3",!1),g.$(".cert-btn3").removeClass("ui-button-disabled"),("flash"===webApp.playMode||"h5"===webApp.playMode)&&g.$("[type=file]").hide(),!1):(p?a?(g.disabled(".ui-button",!0),g.$(".ui-button").addClass("ui-button-disabled")):(q?(g.disabled(".ui-button",!1),g.$(".ui-button").removeClass("ui-button-disabled"),g.disabled(".cert-btn0,.cert-btn2,.cert-btn4,.cert-btn5,.cert-btn6",!0),g.$(".cert-btn0,.cert-btn2,.cert-btn4,.cert-btn5,.cert-btn6").addClass("ui-button-disabled")):(g.disabled(".ui-button",!1),g.$(".ui-button").removeClass("ui-button-disabled"),g.disabled(".cert-btn0,.cert-btn1,.cert-btn2,.cert-btn4,.cert-btn5,.cert-btn6",!0),g.$(".cert-btn0,.cert-btn1,.cert-btn2,.cert-btn4,.cert-btn5,.cert-btn6").addClass("ui-button-disabled")),("flash"===webApp.playMode||"h5"===webApp.playMode)&&g.$("[type=file]").hide()):(g.$("#installed_cert_path").textfield("value",""),g.$("#cert_info_subject").text(""),g.$("#cert_info_issuer").text(""),g.$("#cert_info_usefullife").text(""),a?(g.tip("error","pfm.CertificateNotAvailible"),g.$("#https_enable").prop("checked",!1)):(q?(g.disabled(".ui-button",!1),g.$(".ui-button").removeClass("ui-button-disabled"),g.disabled(".cert-btn0,.cert-btn3,.cert-btn6,.cert-btn7",!0),g.$(".cert-btn0,.cert-btn3,.cert-btn6,.cert-btn7").addClass("ui-button-disabled")):(g.disabled(".ui-button",!1),g.$(".ui-button").removeClass("ui-button-disabled"),g.disabled(".cert-btn1,.cert-btn2,.cert-btn3,.cert-btn6,.cert-btn7",!0),g.$(".cert-btn1,.cert-btn2,.cert-btn3,.cert-btn6,.cert-btn7").addClass("ui-button-disabled")),("flash"===webApp.playMode||"h5"===webApp.playMode)&&g.$("[type=file]").show())),g.disabled(".cert-btn3",!1),void g.$(".cert-btn3").removeClass("ui-button-disabled"))},onRequestDelete:function(){g.$("#cert_createdRequest").textfield("value",""),q=!1,g._renderButton(),g.tip("success","com.OperateSuccessTip")},onRequestInstall:function(){i.Enable=g.$("#https_enable").prop("checked"),d.ConfigManager.setConfig("Https",i).done(function(a){e.CertManager.getSvrCertInfo().done(function(b){j=b,p=!0,g._renderElements(),webApp.isNeedReboot(a)&&webApp.reboot("com.ConfEffectRestartTip")}).always(function(){g.tip("success","com.OperateSuccessTip")})}).fail(function(){g.tip("error","com.OperateFailTip")})},onRequestDownload:function(){"flash"!==webApp.playMode&&"h5"!==webApp.playMode&&(a("#ocx")[0]?plugin.ShowSaveOrOpenDlg("saveFile","RootCert",[{description:"(*.cer)",extensions:["cer"]}]).done(function(a){e.CertManager.exportRootCert().done(function(b){var c=Base64.decode(b.params.cert);plugin.WriteFile(c,"w+",a[1]).done(function(a){-1===a?g.tip("error","com.OperateFailTip"):g.tip("success","com.OperateSuccessTip")})}).fail(function(){g.tip("error","com.OperateFailTip")})}):g.tip("error","com.NeedVideoOcx"))},onCertDelete:function(){e.CertManager.removeSvrCert().done(function(){p=!1,g.onRefresh(),g.tip("success","com.DelectSuccessTip")}).fail(function(){g.tip("error","com.Deletefail")})},onCertSelect:function(){return a("#ocx")[0]?plugin.ShowSaveOrOpenDlg("openFile","",[{description:"cacert (*.pem)",extensions:["pem"]}]).done(function(a){l[0]=a[1],g.$("#cert_path").textfield("value",a[1]),""!==g.$("#key_path").textfield("value")&&(g.disabled(".cert-btn6",!1),g.$(".cert-btn6").removeClass("ui-button-disabled"))}):g.tip("error","com.NeedVideoOcx"),!1},onKeySelect:function(){return a("#ocx")[0]?plugin.ShowSaveOrOpenDlg("openFile","",[{description:"privkey(*.pem)",extensions:["pem"]}]).done(function(a){l[1]=a[1],g.$("#key_path").textfield("value",a[1]),""!==g.$("#cert_path").textfield("value")&&(g.disabled(".cert-btn6",!1),g.$(".cert-btn6").removeClass("ui-button-disabled"))}):g.tip("error","com.NeedVideoOcx"),!1},onCertUpload:function(){var a={};"flash"===webApp.playMode||"h5"===webApp.playMode?(("pem"!==l[0].split(".")[1]||"pem"!==l[1].split(".")[1])&&g.tip("warning","com.FileFormatDefaultTip"),a.cert=Base64.encode(k.cert),a.key=Base64.encode(k.key)):(plugin.ReadFile(l[0]).done(function(b){a.cert=Base64.encode(b)}),plugin.ReadFile(l[1]).done(function(b){a.key=Base64.encode(b)})),n.EncryptInfo(webApp.EncryptInfo.pub,{cert:a.cert,key:a.key}).done(function(a){d.CertManager.importSvrCert(a.salt,a.cipher,a.content).done(function(){p=!0,g.render(),g.tip("success","com.UpmoveSuccessTip")}).fail(function(){g.tip("error","com.UpmoveFailTip")})})},openDialog:function(){m.dialog("show"),m.find("[cfg=Country]").textfield("value",""),m.find("[cfg=CommonName]").textfield("value",""),m.find("[cfg=Email]").textfield("value",""),m.find("[cfg=State]").textfield("value","none"),m.find("[cfg=Locatity]").textfield("value","none"),m.find("[cfg=Organization]").textfield("value","none"),m.find("[cfg=OrganizationUnit]").textfield("value","none"),m.find("[cfg=UsefulLife]").numberfield("value",365)},_toLocalTime:function(a){var b=a.split(" "),c=b[0].split("-"),d=b[1].split(":"),e=new Date(c[0]-0,c[1]-0,c[2]-0,d[0]-0,d[1]-0,d[2]-0),f=e.getTimezoneOffset();return e.addMonths(-1).addSeconds(60*-f),e.format()},_onSave:function(){return h.validate(),h.isInvalid()?m.find("#httpDiaTip").tip("warning",tl(h.errors()[0].errorMsg)):(a.each(m.find("[cfg]"),function(b,c){var d=a(c).attr("cfg");i.ServerCertificate[d]="UsefulLife"===d?a(c).numberfield("value")-0:a(c).textfield("value")}),""===i.ServerCertificate.State&&(i.ServerCertificate.State="none"),""===i.ServerCertificate.Locatity&&(i.ServerCertificate.Locatity="none"),""===i.ServerCertificate.Organization&&(i.ServerCertificate.Organization="none"),""===i.ServerCertificate.OrganizationUnit&&(i.ServerCertificate.OrganizationUnit="none"),m.dialog("close"),g.$("#cert_createdRequest").textfield("value","H/IP="+i.ServerCertificate.CommonName+";C="+i.ServerCertificate.Country+";ST="+i.ServerCertificate.State+";L="+i.ServerCertificate.Locatity+";O="+i.ServerCertificate.Organization+";OU="+i.ServerCertificate.OrganizationUnit+";EM="+i.ServerCertificate.Email),q=!0,void g._renderButton())},_onCertChange:function(){var b=a(this).val();if(l[0]=b,g.$("#cert_path").textfield("value",b),""!==g.$("#key_path").textfield("value")&&(g.disabled(".cert-btn6",!1),g.$(".cert-btn6").removeClass("ui-button-disabled")),window.FileReader){var c=this.files[0];filename=c.name.split(".")[0];var d=new FileReader;d.onload=function(){k.cert=this.result},d.readAsText(c)}else if(document.implementation&&document.implementation.createDocument){var e;e=document.implementation.createDocument("","",null),e.async=!1,e.load(this.value),k.cert=e.xml}else alert(tl("com.NoSupport"))},_onKeyChange:function(){var b=a(this).val();if(l[1]=b,g.$("#key_path").textfield("value",b),""!==g.$("#cert_path").textfield("value")&&(g.disabled(".cert-btn6",!1),g.$(".cert-btn6").removeClass("ui-button-disabled")),window.FileReader){var c=this.files[0];filename=c.name.split(".")[0];var d=new FileReader;d.onload=function(){k.key=this.result},d.readAsText(c)}else if(document.implementation&&document.implementation.createDocument){var e;e=document.implementation.createDocument("","",null),e.async=!1,e.load(this.value),k.key=e.xml}else alert(tl("com.NoSupport"))}})})}(jQuery);