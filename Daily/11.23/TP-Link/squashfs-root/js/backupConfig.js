!function(a){define(function(require,a,b){b.exports=require("jsCore/pageTab")}),define("backup",function(require,b,c){var d=require("jsCore/rpc"),e=require("jsCore/plugin"),f=require("common/common"),g=require("jsCore/pageBase"),h=null,i=["VideoInOptions","VideoColor","Encode","EncodeCrop","VideoWaterMark","VideoWidget","ChannelTitle","VideoEncodeROI","VideoInPreviewOptions","VideoInWhiteBalance","VideoInExposure","VideoInDenoise","VideoInDayNight","VideoInFocus","VideoInZoom","VideoInSharpness","VideoInColor","VideoInRotate","VideoImageControl","VideoInMode","VideoInDefog","VideoWidgetNumberStat","AudioInDenoise","VideoInBacklight","LDCorrection","OSDSysAbnormal","NetSerEncrypt","VideoSubColor","VideoInSceneMode","NetAbort","PPPoE","DDNS","AlarmServer","NTP","Email","WLan","Wireless","SIP","Mobile","T2UServer","SNMP","Bonjour","ARP&Ping","Qos","VideoAnalyseRule","VideoAnalyseGlobal","VideoAnalyseModule","UserGlobal","AroudWifiSearch","AroudWifiDevInfo","AroudWifiLocationInfo","AroudWifiFactoryInfo","MotionDetect","BlindDetect","UnFocusDetect","LossDetect","Alarm","NetAlarm","AlarmOut","ExAlarmOut","IPConflict","NetAbort","StorageNotExist","StorageFailure","StorageLowSpace","StorageHealthAlarm","FlashLight","LoginFailureAlarm","ArmMode","AudioDetect","Sound","AudioInputVolume","AudioOutputVolume","TrafficSnapshot.Detector","TrafficSnapshot.OSD.OSDOrder","MovedDetect","SmartEncode","FaceSnapshot","VideoInFaceAutoExposure","LabelInfoAlarm","TrafficSnapshotNew","FaceRecognitionAlarm","Record","Snap","RecordMode","SnapMode","RecordStoragePoint","NAS","MediaGlobal","Holiday","StorageGlobal","StorageGroup","Comm","Ptz","AutoMaintain","ATM","ATMSniffer","Locales","Lighting","VideoOut","PowerFault","MultiVideoSensor","AnalogAlarm"],j=["HeatImagingThermometry","ThermometryRule","HeatImagingTemper","FireWarning","RadioDataInJpeg","PicInPic","HotColdSpotWarning","QuickFocusSchedule","CalibratePoints","VisualRadiometry","ThermoIntelliVideoFilter","TrackerPolicy","TrackerPolicySchedule","VideoImageControl","VideoInBacklight","VideoInIRExposure","LDCorrection","FlatFieldCorrection","ThermographyOptionScene","ThermographyColorScene","TemperatureDifferenceOSD","ThermographyVideoMode","ThermoAlgo","FaceRadiometry"],k=[],l=null,m=!1;c.exports=g.extend({init:function(){h=this,k=-1!==webApp.DeviceType.indexOf("TPC")?i.concat(j):i,ability.get("ConfigBackupFilelist").then(function(a){a&&"Encrypt"===a.VersionType&&(m=!0)}),ability.get("SupportPtzCfgImExport").done(function(a){a&&i.push("PtzPreset","PtzTour","AutoPan","AutoScan","PtzSpeed","AutoPattern","PowerUp","IdleMotion","PrivacyMasking","PtzLimit","PtzAutoMovement","PtzElevation","PtzHeater","PtzPowerLevel","PanoramicTrace","PtzIntelliTrack")}),h.render()},render:function(){h.tip("error","",0),e.addEvent("configFileImport",function(a){200===a?h.tip("success","com.OperateSuccessTip"):h.tip("error","com.OperateFailTip")}),e.addEvent("configFileExport",function(a){200===a?(h.$("#bu_path").text(l),h.tip("success","com.OperateSuccessTip")):h.tip("error","com.OperateFailTip")}),"flash"===webApp.playMode||"h5"===webApp.playMode?(h.$("[btn-for=onImport]").parent("div").append('<form action="/RPC2_configFileImport?callback=uploadSucceed" name="backup_form" method="post" target="backup_frame" enctype="multipart/form-data"><div class="ui-file fn-opacity"><input type="file" class="ui-file-box fn-opacity" name="backup_upload" hidefocus="hidefocus" /></div><input type="submit" id="backup_submit" value="Submit" style="display:none" /></form>'),h.$("[btn-for=onImport]").parent("div").append('<iframe name="backup_frame" id="backup_frame" style="display:none;" mce_style="display:none;"></iframe>'),h.$("[name=backup_upload]").on("change",function(){var b=a(this).val();return"backup"!==b.split(".")[1]?(h.tip("warning","com.FileTypeUnmatched"),void h.$("[name=backup_upload]").val("")):void h.$("#backup_submit").click()})):(h.$("[name=backup_form]").remove(),h.$("[name=backup_frame]").remove())},leave:function(){e.addEvent("configFileImport",null),e.addEvent("configFileExport",null),("flash"===webApp.playMode||"h5"===webApp.playMode)&&(h.$("[name=backup_form]").remove(),h.$("[name=backup_frame]").remove())},onImport:function(){("flash"===webApp.playMode||"h5"===webApp.playMode)&&h.$("[name=backup_upload]").click(),e.ShowSaveOrOpenDlg("openFile","",[{description:"Config Files (*.backup)",extensions:["backup"]}]).done(function(a){(-1===webApp.DeviceType.indexOf("TPC")||""!==a[0])&&h._importConfig(a[1])})},onExport:function(a){if("flash"===webApp.playMode||"h5"===webApp.playMode){a.preventDefault();var b=new XMLHttpRequest;b.responseType="blob";var c=h.getEncryptServerUrl(d.getSession());b.open("GET",c,!0),b.onreadystatechange=function(){if(4===b.readyState&&200===b.status){var a=new Blob([b.response],{type:"application/binarytet-stream"}),c=document.createElement("a");c.href=window.URL.createObjectURL(a),c.download="configFileExport.backup",document.body.appendChild(c),c.click(),setTimeout(function(){window.URL.revokeObjectURL(c.href),document.body.removeChild(c)},0),h.tip("success","com.OperateSuccessTip")}else 4===b.readyState&&200!==b.status&&h.tip("error","com.OperateFailTip")},b.send()}else e.ShowSaveOrOpenDlg("saveFile","DeviceConfig",[{description:"Config Files (*.backup)",extensions:["backup"]}]).done(function(a){(-1===webApp.DeviceType.indexOf("TPC")||""!==a[0])&&h._exportConfig(a[0],a[1])})},_importConfig:function(b){if(m&&"nacl"!==e.type){var c=d.getSession(),g="RPC2_configFileImport";e.PostOneHttpRequest(g,b,"",c,"configFileImport").done(function(){h.tip("warning","com.LoadingTip",-1)}).fail(function(){h.tip("error","com.OperateFailTip")})}else{h.tip("warning","com.LoadingTip",-1);var i=[],j=[];e.ReadFile(b).done(function(c){try{if(a.each(JSON.parse(c),function(a,b){i.push(a),j.push(b)}),0===i.length)return h.tip("warning","No items which can be imported.");d.ConfigManager.setConfig(i,j).done(function(a){f.chkMutilCallRet(a)?(h.tip("success","com.SaveSuccessTip"),h.$("#bu_path").text(b)):h.tip("error","com.SaveConfigFailTip")})}catch(e){h.tip("warning","com.FileFormatDefaultTip")}})}},_exportConfig:function(b,c){if(/[\\\/\:\*\?\"\<\>\|]/g.test(b))return h.tip("error","com.FileNameInvalidTip!");if(m&&"nacl"!==e.type){l=c;var f=h.getEncryptServerUrl(d.getSession());e.RequestOneCGIInteraction(f,c,"configFileExport").done(function(){h.tip("warning","com.LoadingTip",-1)}).fail(function(){h.tip("error","com.OperateFailTip")})}else{h.tip("warning","com.LoadingTip",-1);try{d.ConfigManager.getConfig(k).done(function(b){var d={};a.each(b,function(a,b){b.result&&b.params&&b.params.table&&(d[k[a]]=b.params.table)}),e.WriteFile(JSON.stringify(d),"w+",c).done(function(a){-1===a?h.tip("error","com.NoWriteRightTip"):(h.tip("success","com.OperateSuccessTip"),h.$("#bu_path").text(c))})}).fail(function(){h.tip("error","com.OperateFailTip")})}catch(g){h.tip("error","com.OperateFailTip")}}},getEncryptServerUrl:function(a){var b="/cgi-bin/configFileExport.backup?action=All&sessionId="+a;return webApp.EncryptInfo&&webApp.EncryptInfo.asymmetric&&(b=f.getEncryptServerUrl("/cgi-bin/configFileExport.backup?","action=All&sessionId="+a)),b}}),window.uploadSucceed=function(a){a.result?h.tip("success","com.OperateSuccessTip"):h.tip("error","com.OperateFailTip")}})}(jQuery);