!function(a){define(function(require,b,c){c.exports=require("jsCore/pageTab");var d=require("jsCore/rpcLogin");c.exports.prototype.rtsp=ability.get("StreamAuthority").then(function(a){return!(!a||!a.Rtsp)}),c.exports.prototype.ssh=a.when(ability.get("SSHD"),ability.get("SystemService")).then(function(a,b){return!(!a||!a.Support||b&&b.Support)}),c.exports.prototype.ipAuth=ability.get("IPTableFilter").then(function(a){return(!a||!a.Support)&&d.chkAuthority("AuthSecurity")}),c.exports.prototype.sysService=ability.get("SystemService").then(function(a){return!(!a||!a.Support)}),c.exports.prototype.pswReset=ability.get("SystemService").then(function(a){return!(a&&a.Support)&&(d.chkAuthority("AuthSecurity")||webCaps.is_show_PswReset&&"admin"===d.getLoginInfo().username)}),c.exports.prototype.upnpDiscover=ability.get("SystemService").then(function(a){return!(!isEnable("is_show_startDeviceDiscover")||a&&a.Support)}),c.exports.prototype.https=ability.get("SystemService").then(function(a){return!!(a&&a.Support&&isEnable("is_show_HTTPS"))}),c.exports.prototype.firewall=ability.get("IPTableFilter").then(function(a){return a&&a.Support})}),define("rtsp",function(require,b,c){var d=require("jsCore/rpc"),e=(require("common/common"),require("jsCore/pageBase")),f=null,g=null;c.exports=e.extend({init:function(){f=this,f.render()},_getConfig:function(a){d.ConfigManager.getConfig("StreamAuthority").done(function(b){g=b,f._renderElements(),a&&f.tip("success","com.OperateSuccessTip")}).fail(function(){a&&f.tip("error","com.OperateFailTip")})},_renderElements:function(){f.$("#security_rtsp_mode").val(g.RtspLoginCheck)},render:function(){f._getConfig()},onRefresh:function(){f._getConfig(!0)},onDefault:function(){d.ConfigManager.getDefault("StreamAuthority").done(function(a){g=a,f._renderElements(),f.tip("success","com.DefaultSuccessTip")}).fail(function(){f.tip("error","com.DefaultfailureTip")})},onSave:function(){var b="";g.RtspLoginCheck=f.$("#security_rtsp_mode").val(),g.OnvifLoginCheck=g.RtspLoginCheck,b="Basic"===g.RtspLoginCheck?"net.RTSPBasicAuthTip":"None"===g.RtspLoginCheck?"net.RTSPNoneAuthTip":"",b?a.confirm(tl("com.Prompt"),tl(b),function(){d.ConfigManager.setConfig("StreamAuthority",g).done(function(){f.tip("success","com.SaveSuccessTip")}).fail(function(){f.tip("error","com.SaveConfigFailTip")})},function(){return!1},!1):d.ConfigManager.setConfig("StreamAuthority",g).done(function(){f.tip("success","com.SaveSuccessTip")}).fail(function(){f.tip("error","com.SaveConfigFailTip")})}})}),define("ssh",function(require,a,b){var c=require("jsCore/rpc"),d=(require("jsCore/plugin"),require("common/common"),require("jsCore/pageBase")),e=null,f=null;b.exports=d.extend({init:function(){e=this,e.render()},_getConfig:function(a){c.ConfigManager.getConfig("SSHD").done(function(b){f=b,e._renderElements(),a&&e.tip("success","com.OperateSuccessTip")}).fail(function(){a&&e.tip("error","com.OperateFailTip")})},_renderElements:function(){e.$("#security_ssh_enable").prop("checked",f.Enable)},render:function(){e._getConfig()},onRefresh:function(){e._getConfig(!0)},onDefault:function(){c.ConfigManager.getDefault("SSHD").done(function(a){f=a,e._renderElements(),e.tip("success","com.DefaultSuccessTip")}).fail(function(){e.tip("error","com.DefaultfailureTip")})},onSave:function(){f.Enable=e.$("#security_ssh_enable").prop("checked"),c.ConfigManager.setConfig("SSHD",f).done(function(){e.tip("success","com.SaveSuccessTip")}).fail(function(){e.tip("error","com.SaveConfigFailTip")})}})}),define("ipAuth",function(require,b,c){var d=require("jsCore/rpc"),e=require("jsCore/pageBase");require("widget/js/dui.macfield");var f=null,g=null,h=null,i=null,j=null,k=null,l=null,m=null,n=null,o={},p=[],q="",r="",s="",t=null,u="",v="add",w="TrustList";c.exports=e.extend({init:function(){f=this,(webApp.GongAnDetect||-1!==webApp.DeviceType.indexOf("TPC"))&&(f.$('[data-for="BannedList"]').show(),f.$("#ipAuth_enable").attr("t","com.StartUsing").text(tl("com.StartUsing"))),m=f.$("#ipAuth_Enable"),g=f.$("#ipAuth_AddIP").dialog({title:tl("net.AddIPMac"),save:function(){f._onSave()}}).detach().appendTo(document.body),h=f.$("#ipAuth_delIP").dialog({title:tl("net.DeleteIpMac"),"delete":function(){f._onDel()}}).detach().appendTo(document.body),n=h.find("#delMsg"),i=g.find("#ipAuth_IP1").ipfield(),j=g.find("#ipAuth_IP2").ipfield(),k=g.find("#ipAuth_IP3").macfield(),l=f.$("#ip_Table").table({height:200,columns:[{t:"net.IPaddrMAC",width:"50%",fields:"ip"},{t:"com.Modify",width:"25%",action:"modify",icon:"ui-table-icon-edit",handle:function(a){return v="modify",u=a.ip,f._onModifyIP(a.ip),!1}},{t:"com.Delete",icon:"ui-table-icon-del",action:"delete",handle:function(a){return v="del",u=a.ip,f._closeAllDialog(),n.text(tl("com.SureDeleteIPMACTip")),h.dialog("show").find(".u-dialog-head").find("h1").text(tl("net.DeleteIpMac")),!1}}]}),m.on("click",function(){o.Enable=a(this).prop("checked")}),f.$(".ui-table-tab li").on("click",function(){a(this).siblings().removeClass("ui-table-tab-current"),w=a(this).addClass("ui-table-tab-current").attr("data-for"),m.prop("checked",o.Enable),f._renderAccess()}),f.render()},render:function(){f._closeAllDialog(),d.ConfigManager.getConfig(["AccessFilter","Network"]).done(function(a){o=a[0].params.table,f._renderElements(),a[1].params.table.eth0&&(q=a[1].params.table.eth0.IPAddress,r=a[1].params.table.eth0.PhysicalAddress),a[1].params.table.eth2&&(s=a[1].params.table.eth2.IPAddress,t=a[1].params.table.eth2.PhysicalAddress)})},destory:function(){g.remove(),h.remove()},_renderElements:function(){m.prop("checked",o.Enable),null==o.TrustList&&(o=JSON.parse('{"Enable" : false,"Type" : "BannedList","TrustList" : [],"BannedList" : []}')),f._renderAccess()},_renderAccess:function(){p=[],a.each(o[w],function(a,b){p.push({ip:b})}),l.table("dataSource",p),0===o[w].length?(f.disabled("#ipAuth_Enable"),m.prop("checked",!1)):f.disabled("#ipAuth_Enable",!1)},onChangeES:function(){switch(g.find("[sel-for=onChangeES]").get(0).selectedIndex){case 0:i.show(),j.hide(),k.hide();break;case 1:i.show(),j.show(),k.hide();break;case 2:i.hide(),j.hide(),k.show()}},_closeAllDialog:function(){g.dialog("close"),h.dialog("close"),i.ipfield("value","1.0.0.1"),j.ipfield("value","1.0.0.1"),k.macfield("empty")},onAddIP:function(){return webApp.GongAnDetect&&o[w].length>=200?(a.alert(tl("IpmostTo200"),function(){}),!1):(v="add",f._closeAllDialog(),g.find("[sel-for=onChangeES]").val("1"),i.show(),j.hide(),k.hide(),i.ipfield("value","1.0.0.1"),g.dialog("show").find(".u-dialog-head").find("h1").text(tl("net.AddIPMac")),j.ipfield("value","1.0.0.1"),k.macfield("empty"),void g.dialog("show"))},onClearIP:function(){v="clear",f._closeAllDialog(),n.text(tl("com.SureToClearIPMac")),h.dialog("show").find(".u-dialog-head").find("h1").text(tl("net.RemoveallIpMac"))},_onModifyIP:function(a){if(f._closeAllDialog(),u=a,g.dialog("show").find(".u-dialog-head").find("h1").text(tl("net.ModifyIpMac")),u.indexOf(":")>-1)g.find("[sel-for=onChangeES]").val(3),i.hide(),j.hide(),k.show().macfield("value",u);else if(u.indexOf("-")>-1){g.find("[sel-for=onChangeES]").val(2),i.show(),j.show(),k.hide();var b=u.split("-");i.ipfield("value",b[0]),j.ipfield("value",b[1])}else u.indexOf(".")>-1&&(g.find("[sel-for=onChangeES]").val(1),i.show(),j.hide(),k.hide(),i.ipfield("value",u))},onDefault:function(){d.ConfigManager.getDefault("AccessFilter").done(function(a){o=a,f._renderElements(),f.tip("success","com.DefaultSuccessTip")}).fail(function(){f.tip("error","com.DefaultfailureTip")})},onRefresh:function(){d.ConfigManager.getConfig("AccessFilter").done(function(a){o=a,f._renderElements(),f.tip("success","com.OperateSuccessTip")}).fail(function(){f.tip("error","com.OperateFailTip")})},onConfirm:function(){o.Enable=m.is(":checked"),o.Type=w;var a=-1!==w.indexOf("Trust")?"Trust":"Banned",b=[];if(o[a+"List"].length){for(var c=0;c<o[a+"List"].length;c++)b.push(!0);o[a+"Enable"]=b}d.ConfigManager.setConfig("AccessFilter",o).done(function(){f.tip("success","com.SaveSuccessTip")}).fail(function(){f.tip("error","com.SaveConfigFailTip")})},_onSave:function(){var b=-1;switch("modify"===v&&(b=a.inArray(u,o[w])),g.find("[sel-for=onChangeES]").get(0).selectedIndex){case 0:var c=i.ipfield("value");if(q==c||s==c)return g.dialog("close"),void f.tip("warning","com.IpNotNowTip");if(a.inArray(c,o[w])>-1)return g.dialog("close"),void f.tip("warning","com.IpExiseTip");u=c;break;case 1:var d=i.ipfield("value")+"-"+j.ipfield("value"),e=q+"-"+q,h=s+"-"+s;if(e==d||h==d)return g.dialog("close"),void f.tip("warning","com.IpNotNowTip");var l=i.ipfield("value").split("."),m=j.ipfield("value").split(".");if(256*l[0]*256*256+256*l[1]*256+256*l[2]+l[3]-0>256*m[0]*256*256+256*m[1]*256+256*m[2]+m[3]-0&&(d=j.ipfield("value")+"-"+i.ipfield("value")),a.inArray(d,o[w])>-1)return g.dialog("close"),void f.tip("warning","com.IpExiseTip");u=d;break;case 2:var n=k.macfield("value");if(r.toLowerCase()==n.toLowerCase()||t&&t.toLowerCase()==n.toLowerCase())return g.dialog("close"),void f.tip("warning","com.UsedTip");var p=!1;if(a.each(o[w],function(a,b){return u===b?b===n&&(p=!0):void(b.toLowerCase()===n.toLowerCase()&&(p=!0))}),p)return g.dialog("close"),void f.tip("warning","com.MACIsExistTip");u=n}-1===b?o[w].push(u):o[w][b]=u,u="",f._renderElements(),f._closeAllDialog(),f.tip("success","com.OperateingSuccessTip")},_onDel:function(){"del"===v?o[w].erase(u):"clear"===v&&(o[w]=[]),f._renderElements(),f._closeAllDialog(),f.tip("success","com.OperateingSuccessTip")}})}),define("sysService",function(require,b,c){var d=require("jsCore/rpc"),e=require("jsCore/pageBase"),f=require("jsCore/rpcLogin"),g=null,h=[],i=[],j={VSP_CoSignServerIP:"VSP_CoSignServer-IP",VSP_CoSignServerPort:"VSP_CoSignServer-Port",SSH:"SSHD-Enable",Broadcast:"DeviceDiscovery-Enable",PswReset:"PwdReset-Enable",CGI:"VSP_CGI-ServiceStart",Onvif:"VSP_ONVIF-ServiceStart",Genetec:"VSP_GENETEC-ServiceStart",MediaEncrypt:"MediaEncrypt-RTSPOverTls-Enable",FrameEncrypt:"MediaEncrypt-PrivateMediaEncrypt-KeyFrameEncrypt-Enable",MobilePush:"MobilePhoneApplication-PushNotificationEnable",FileBackupEncrypt:"DownloadEncrypt-Enable",FileBackupEncryptPassword:"DownloadEncrypt-Password"};c.exports=e.extend({init:function(){g=this,g.$("#sys_ser_VSP_CoSignServerIP").ipfield(),g.$("#sys_ser_VSP_CoSignServerPort").numberfield({max:65534,min:1025,allowDecimal:!1,allowNegative:!1}),a.when(ability.get("SSHD"),ability.get("SupportCGICfg"),ability.get("SupportOnvifCfg"),ability.get("SupportGenetecCfg"),ability.get("SupportMediaEncrypt"),ability.get("SupportMobilePush"),ability.get("SupportFileBackupEncrypt")).then(function(b,c,d,e,i,k,l){if(b&&b.Support||delete j.SSH,isEnable("is_show_startDeviceDiscover")||delete j.Broadcast,f.chkAuthority("AuthSecurity")||webCaps.is_show_PswReset&&"admin"===f.getLoginInfo().username)g.$("#sys_ser_PswReset").change(function(){a(this).prop("checked")||g.tip("warning","sys.DisablePswReset")});else{delete j.PswReset;var m=g.$("#sys_ser_PswReset").closest(".ui-form-item");m.next(".fn-horizontal-line").remove(),m.remove()}c||delete j.CGI,d||delete j.Onvif,e||delete j.Genetec,i?(a("#sys_ser_MediaEncrypt").attr("disabled",!0),a(".ui-form-item.MediaEncrypt").css("visibility","hidden").css("position","fixed"),a("#sys_ser_FrameEncrypt").on("change",function(){a("#sys_ser_MediaEncrypt").prop("checked",!1)})):(delete j.MediaEncrypt,delete j.FrameEncrypt),k||delete j.MobilePush,l||(delete j.FileBackupEncrypt,delete j.FileBackupEncryptPassword),webCaps.is_show_CoSignServer?g.$(".coSignServer").removeClass("fn-hide"):(delete j.VSP_CoSignServerIP,delete j.VSP_CoSignServerPort,g.$(".coSignServer").remove()),a.each(j,function(a,b){g.$(".ui-form-item."+a).removeClass("fn-hide");var c=b.split("-")[0];-1===h.indexOf(c)&&h.push(c)}),g.$(".ui-form-item.fn-hide").remove(),g.$(".fn-horizontal-line").each(function(b,c){(a(c).next("div").is(".fn-horizontal-line")||a(c).next("div").is(".ui-button-box"))&&a(c).remove()}),g.render()})},render:function(){g._getConfig()},_getConfig:function(b){var c=!1;-1!==h.indexOf("DownloadEncrypt")?(h.length=h.length-1,c=!0,a.when(d.ConfigManager.getConfig(h),d.ConfigManager.getConfig("DownloadEncrypt")).then(function(a,d){for(var e=0;e<a.length;e++)i[e]=a[e].params.table;c&&(i[a.length]=d,h.push("DownloadEncrypt")),g._renderElements(),b&&g.tip("success","com.OperateSuccessTip")},function(){b&&g.tip("error","com.OperateFailTip")})):d.ConfigManager.getConfig(h).then(function(a){for(var c=0;c<a.length;c++)i[c]=a[c].params.table;g._renderElements(),b&&g.tip("success","com.OperateSuccessTip")},function(){b&&g.tip("error","com.OperateFailTip")})},_renderElements:function(){a.each(j,function(a,b){var c,d,e;if(e=b.split("-"),d=h.indexOf(e[0]),i[d]&&null!==i[d][e[1]]){c=i[d];for(var f=1;f<e.length;f++)c=c[e[f]];webCaps.is_show_CoSignServer&&-1!==e.indexOf("VSP_CoSignServer")?"string"==typeof c?g.$("#sys_ser_"+a).ipfield("value",c):g.$("#sys_ser_"+a).numberfield("value",c):"boolean"==typeof c?g.$("#sys_ser_"+a).prop("checked",c):g.$("#sys_ser_"+a).val(c)}})},onDefault:function(){var b=!1;-1!==h.indexOf("DownloadEncrypt")?(h.length=h.length-1,b=!0,a.when(d.ConfigManager.getDefault(h),d.ConfigManager.getDefault("DownloadEncrypt")).then(function(a,c){for(var d=0;d<a.length;d++)i[d]=a[d].params.table;b&&(i[a.length]=c,h.push("DownloadEncrypt")),g._renderElements(),g.tip("success","com.DefaultSuccessTip")},function(){b&&h.push("DownloadEncrypt"),g.tip("error","com.DefaultfailureTip")})):d.ConfigManager.getDefault(h).then(function(a){for(var b=0;b<a.length;b++)i[b]=a[b].params.table;g._renderElements(),g.tip("success","com.DefaultSuccessTip")},function(){g.tip("error","com.DefaultfailureTip")})},onRefresh:function(){g._getConfig(!0)},onConfirm:function(){a.each(j,function(a,b){var c,d,e;d=b.split("-"),c=h.indexOf(d[0]),e=i[c];for(var f=1;f<d.length;f++)e=e[d[f]];webCaps.is_show_CoSignServer&&-1!==d.indexOf("VSP_CoSignServer")?i[c][d[1]]="string"==typeof e?g.$("#sys_ser_"+a).ipfield("value"):g.$("#sys_ser_"+a).numberfield("value"):"boolean"==typeof e?2===d.length?i[c][d[1]]=g.$("#sys_ser_"+a).prop("checked"):3===d.length?i[c][d[1]][d[2]]=g.$("#sys_ser_"+a).prop("checked"):4===d.length?i[c][d[1]][d[2]][d[3]]=g.$("#sys_ser_"+a).prop("checked"):5===d.length&&(i[c][d[1]][d[2]][d[3]][d[4]]=g.$("#sys_ser_"+a).prop("checked")):2===d.length?i[c][d[1]]=g.$("#sys_ser_"+a).val():3===d.length?i[c][d[1]][d[2]]=g.$("#sys_ser_"+a).val():4===d.length?i[c][d[1]][d[2]][d[3]]=g.$("#sys_ser_"+a).val():5===d.length&&(i[c][d[1]][d[2]][d[3]][d[4]]=g.$("#sys_ser_"+a).val())});var b=!1,c=null;if(a.inArray("MediaEncrypt",h)&&webCaps.syn_KeyFrameEncrypt_RtspOverTls){var e=i[h.indexOf("MediaEncrypt")].PrivateMediaEncrypt.KeyFrameEncrypt.Enable;i[h.indexOf("MediaEncrypt")].RTSPOverTls.Enable=e}-1!==h.indexOf("DownloadEncrypt")?(h.length=h.length-1,b=!0,c=i.pop(),a.when(d.ConfigManager.setConfig(h,i),d.ConfigManager.setConfig("DownloadEncrypt",c)).then(function(){h.push("DownloadEncrypt"),i.push(c),g.tip("success","com.SaveSuccessTip")},function(){h.push("DownloadEncrypt"),i.push(c),g.tip("error","com.SaveConfigFailTip")})):d.ConfigManager.setConfig(h,i).then(function(){g.tip("success","com.SaveSuccessTip")},function(){g.tip("error","com.SaveConfigFailTip")})}})}),define("pswReset",function(require,b,c){var d=require("jsCore/rpc"),e=(require("jsCore/plugin"),require("common/common"),require("jsCore/pageBase")),f=null,g=null;c.exports=e.extend({init:function(){f=this,f.$("#security_psw_enable").change(function(){a(this).prop("checked")||f.tip("warning","sys.DisablePswReset")}),f.render()},_getConfig:function(a){d.ConfigManager.getConfig("PwdReset").done(function(b){g=b,f._renderElements(),a&&f.tip("success","com.OperateSuccessTip")}).fail(function(){a&&f.tip("error","com.OperateFailTip")})},_renderElements:function(){f.$("#security_psw_enable").prop("checked",g.Enable)},render:function(){f._getConfig()},onRefresh:function(){f._getConfig(!0)},onDefault:function(){d.ConfigManager.getDefault("PwdReset").done(function(a){g=a,f._renderElements(),f.tip("success","com.DefaultSuccessTip")}).fail(function(){f.tip("error","com.DefaultfailureTip")})},onSave:function(){g.Enable=f.$("#security_psw_enable").prop("checked"),d.ConfigManager.setConfig("PwdReset",g).done(function(){f.tip("success","com.SaveSuccessTip")}).fail(function(){f.tip("error","com.SaveConfigFailTip")})}})}),define("upnpDiscover",function(require,a,b){var c=require("jsCore/rpc"),d=(require("jsCore/plugin"),require("common/common"),require("jsCore/pageBase")),e=null,f=null;b.exports=d.extend({init:function(){e=this,e.render()},_getConfig:function(a){c.ConfigManager.getConfig("DeviceDiscovery").done(function(b){f=b,e._renderElements(),a&&e.tip("success","com.OperateSuccessTip")}).fail(function(){a&&e.tip("error","com.OperateFailTip")})},_renderElements:function(){e.$("#security_upnp_enable").prop("checked",f.Enable)},render:function(){e._getConfig()},onRefresh:function(){e._getConfig(!0)},onDefault:function(){c.ConfigManager.getDefault("DeviceDiscovery").done(function(a){f=a,e._renderElements(),e.tip("success","com.DefaultSuccessTip")}).fail(function(){e.tip("error","com.DefaultfailureTip")})},onSave:function(){f.Enable=e.$("#security_upnp_enable").prop("checked"),c.ConfigManager.setConfig("DeviceDiscovery",f).done(function(){e.tip("success","com.SaveSuccessTip")}).fail(function(){e.tip("error","com.SaveConfigFailTip")})}})}),define("https",function(require,b,c){var d=require("jsCore/rpc"),e=require("common/rpcBase"),f=require("jsCore/pageBase"),g=null,h=null,i={},j={},k={},l=[],m=null,n=require("common/common"),o=n.Check,p=!1,q=!1,r=null;c.exports=f.extend({init:function(){g=this,g.$("#https_enable").on("click",function(){var b=g.$(this);webCaps.is_show_HTTPS_Tips?b.prop("checked")?g._renderButton():a.confirm(tl("com.Close"),tl("conf_net.https_disable_tip"),function(){b.prop("checked",!1),g._renderButton()},function(){b.prop("checked",!0),g._renderButton()},null):g._renderButton()}),m=g.$("#https_addDialog").dialog({save:function(){g._onSave()}}).detach().appendTo(document.body),m.find("[cfg=CommonName], [cfg=Email]").textfield(),m.find("[cfg=State], [cfg=Locatity], [cfg=Organization],[cfg=OrganizationUnit]").textfield(),m.find("[cfg=UsefulLife]").numberfield({min:1,max:5e3,allowDecimal:!1,allowNegative:!1}),m.find("[cfg=Country]").textfield({validReg:/^[a-zA-Z]*$/,validRegRet:!0,errorHandle:"prevent"}),m.find("[cfg=Country]").keyup(function(a){a.target.value=a.target.value.toUpperCase()}),h=a.validator([{element:m.find("[cfg=Country]"),check:function(a){return/^[a-zA-Z]{2}$/.test(a)},errorMsg:["com.Need2Caps"],events:["blur"],errorElem:".u-input-error"},{element:m.find("[cfg=CommonName]"),check:[o.require,function(b){return!!a.trim(b)}],errorMsg:["com.Necessary","com.Necessary"],events:["blur","blur"],errorElem:".u-input-error"},{element:m.find("[cfg=Email]"),check:function(a){return a?/^[\w-.]+@[\w-]+(\.{1}[\w-]+)+$/.test(a):!0},errorMsg:["com.WrongEmailFormatTip"],events:["blur"],errorElem:".u-input-error"}],function(a){a.parent().translation()}),g.$("#cert_path, #key_path, #installed_cert_path, #cert_createdRequest").textfield(),webCaps.is_show_EnableTLS1||(g.$("#TLS_tips").remove(),g.$("#TLS").remove()),r=g.$("#https_TLS_dialog").dialog({save:function(){r.dialog("close"),g.onRequestInstall(!0)},close:function(){g.onRequestInstall()}}),g.render()},_getConfig:function(a){g.$("#cert_path").textfield("value",""),g.$("#key_path").textfield("value",""),g.$("#installed_cert_path").textfield("value",""),g.$("#cert_createdRequest").textfield("value",""),g.$("#cert_info_subject").text(""),g.$("#cert_info_issuer").text(""),g.$("#cert_info_usefullife").text(""),q=!1,d.ConfigManager.getConfig("Https").done(function(b){i=b,g.$("#https_enable").prop("checked",i.Enable),i.SSLProtocols?"TLSv1Enable"in i.SSLProtocols||(i.SSLProtocols.TLSv1Enable=!1):(i.SSLProtocols={},i.SSLProtocols.TLSv1Enable=!1),i.SSLProtocols&&"TLSv1Enable"in i.SSLProtocols&&g.$("#TLS_enable").prop("checked",i.SSLProtocols.TLSv1Enable),p=""===i.ServerCertificate.CommonName?!1:!0,p&&e.CertManager.getSvrCertInfo().done(function(a){j=a,g._renderElements()}).fail(function(){g.tip("error","com.ConnectFailTip")}),a&&g.tip("success","com.OperateSuccessTip"),g._renderButton()}).fail(function(){g.tip("error","com.ConnectFailTip"),g._renderButton()})},render:function(){g._getConfig(),g.$("#cert_select").parent("div").remove(),g.$("#key_select").parent("div").remove(),g.$("#TLS_enable").next("span").text(tl("net.StartUsingTLS")),"flash"===webApp.playMode||"h5"===webApp.playMode?(g.$("[btn-for=onCertSelect]").parent("div").append('<div class="ui-file fn-opacity" style="left:450px;"><input type="file" class="ui-file-box fn-opacity" id="cert_select" hidefocus="hidefocus" /></div>'),g.$("[btn-for=onKeySelect]").parent("div").append('<div class="ui-file fn-opacity" style="left:450px;"><input type="file" class="ui-file-box fn-opacity" id="key_select" hidefocus="hidefocus" /></div>'),g.$("#cert_select").on("change",g._onCertChange),g.$("#key_select").on("change",g._onKeyChange),g.$("[btn-for=onRequestDownload]").attr({target:"_blank",href:"/RPC2_DownloadRootCert/RootCert.cer"})):g.$("[btn-for=onRequestDownload]").attr("href","javascript:;").attr("target","")},onRefresh:function(){g._getConfig(!0)},onConfirm:function(){g.$("#https_enable").prop("checked")!==i.Enable?(g.$("#installed_cert_path").textfield("value",""),g.$("#installed_cert_info0").text(""),g.$("#installed_cert_info1").text(""),g.$("#installed_cert_info2").text(""),g.onRequestInstall()):webCaps.is_show_EnableTLS1?i.SSLProtocols&&"TLSv1Enable"in i.SSLProtocols&&g.$("#TLS_enable").prop("checked")!=i.SSLProtocols.TLSv1Enable?g.$("#https_enable").prop("checked")?r.dialog("show"):g.onRequestInstall():g.tip("success","com.SaveSuccessTip"):g.onRequestInstall()},destory:function(){m.remove()},_renderElements:function(){g.$("#https_download_cert").prop("src",""),a.each(m.find("[cfg]"),function(b,c){var d=a(c).attr("cfg");"UsefulLife"===d?a(c).numberfield("value",i.ServerCertificate[d]):a(c).textfield("value",i.ServerCertificate[d])});var b=g._toLocalTime(j.usefulLife.Start),c=g._toLocalTime(j.usefulLife.End);g.$("#installed_cert_path").textfield("value","H/IP="+i.ServerCertificate.CommonName+";C="+i.ServerCertificate.Country+";ST="+i.ServerCertificate.State+";L="+i.ServerCertificate.Locatity+";O="+i.ServerCertificate.Organization+";OU="+i.ServerCertificate.OrganizationUnit+";EM="+i.ServerCertificate.Email);var d=tl("itc.Subject")+" H/IP="+j.subject.CommonName+"; C="+j.subject.Country+"; ST="+j.subject.State+"; L="+j.subject.Locality+"; O="+j.subject.Organization+"; OU="+j.subject.OrganizationUnit+"; EM="+j.subject.Email+";",e=tl("pfm.Issuer")+" H/IP="+j.issuer.CommonName+"; C="+j.issuer.Country+"; ST="+j.issuer.State+"; L="+j.issuer.Locality+"; O="+j.issuer.Organization+"; OU="+j.issuer.OrganizationUnit+"; EM="+j.issuer.Email+";",f=tl("com.Validity")+": "+b+"~"+c;g.$("#cert_info_subject").text(d),g.$("#cert_info_issuer").text(e),g.$("#cert_info_usefullife").text(f),g._renderButton(),h.validate()},_renderButton:function(){var a=g.$("#https_enable").prop("checked");return i.Enable?(g.disabled(".ui-button",!0),g.$(".ui-button").addClass("ui-button-disabled"),g.disabled(".cert-btn3",!1),g.$(".cert-btn3").removeClass("ui-button-disabled"),("flash"===webApp.playMode||"h5"===webApp.playMode)&&g.$("[type=file]").hide(),!1):(p?a?(g.disabled(".ui-button",!0),g.$(".ui-button").addClass("ui-button-disabled")):(q?(g.disabled(".ui-button",!1),g.$(".ui-button").removeClass("ui-button-disabled"),g.disabled(".cert-btn0,.cert-btn2,.cert-btn4,.cert-btn5,.cert-btn6",!0),g.$(".cert-btn0,.cert-btn2,.cert-btn4,.cert-btn5,.cert-btn6").addClass("ui-button-disabled")):(g.disabled(".ui-button",!1),g.$(".ui-button").removeClass("ui-button-disabled"),g.disabled(".cert-btn0,.cert-btn1,.cert-btn2,.cert-btn4,.cert-btn5,.cert-btn6",!0),g.$(".cert-btn0,.cert-btn1,.cert-btn2,.cert-btn4,.cert-btn5,.cert-btn6").addClass("ui-button-disabled")),("flash"===webApp.playMode||"h5"===webApp.playMode)&&g.$("[type=file]").hide()):(g.$("#installed_cert_path").textfield("value",""),g.$("#cert_info_subject").text(""),g.$("#cert_info_issuer").text(""),g.$("#cert_info_usefullife").text(""),a?(g.tip("error","pfm.CertificateNotAvailible"),g.$("#https_enable").prop("checked",!1)):(q?(g.disabled(".ui-button",!1),g.$(".ui-button").removeClass("ui-button-disabled"),g.disabled(".cert-btn0,.cert-btn3,.cert-btn6,.cert-btn7",!0),g.$(".cert-btn0,.cert-btn3,.cert-btn6,.cert-btn7").addClass("ui-button-disabled")):(g.disabled(".ui-button",!1),g.$(".ui-button").removeClass("ui-button-disabled"),g.disabled(".cert-btn1,.cert-btn2,.cert-btn3,.cert-btn6,.cert-btn7",!0),g.$(".cert-btn1,.cert-btn2,.cert-btn3,.cert-btn6,.cert-btn7").addClass("ui-button-disabled")),("flash"===webApp.playMode||"h5"===webApp.playMode)&&g.$("[type=file]").show())),g.disabled(".cert-btn3",!1),void g.$(".cert-btn3").removeClass("ui-button-disabled"))},onRequestDelete:function(){g.$("#cert_createdRequest").textfield("value",""),q=!1,g._renderButton(),g.tip("success","com.OperateSuccessTip")},onRequestInstall:function(a){i.Enable=g.$("#https_enable").prop("checked"),i.SSLProtocols&&"TLSv1Enable"in i.SSLProtocols&&(i.SSLProtocols.TLSv1Enable=g.$("#TLS_enable").prop("checked")),d.ConfigManager.setConfig("Https",i).done(function(b){e.CertManager.getSvrCertInfo().done(function(a){j=a,p=!0,g._renderElements(),webApp.isNeedReboot(b)&&webApp.reboot("com.ConfEffectRestartTip")}).always(function(){g.tip("success","com.OperateSuccessTip"),1==a&&webApp.reboot("com.ConfEffectRestartTip")})}).fail(function(){g.tip("error","com.OperateFailTip")})},onRequestDownload:function(){"flash"!==webApp.playMode&&"h5"!==webApp.playMode&&(a("#ocx")[0]?plugin.ShowSaveOrOpenDlg("saveFile","RootCert",[{description:"(*.cer)",extensions:["cer"]}]).done(function(a){e.CertManager.exportRootCert().done(function(b){var c=Base64.decode(b.params.cert);plugin.WriteFile(c,"w+",a[1]).done(function(a){-1===a?g.tip("error","com.OperateFailTip"):g.tip("success","com.OperateSuccessTip")})}).fail(function(){g.tip("error","com.OperateFailTip")})}):g.tip("error","com.NeedVideoOcx"))},onCertDelete:function(){e.CertManager.removeSvrCert().done(function(){p=!1,g.onRefresh(),g.tip("success","com.DelectSuccessTip")}).fail(function(){g.tip("error","com.Deletefail")})},onCertSelect:function(){return a("#ocx")[0]?plugin.ShowSaveOrOpenDlg("openFile","",[{description:"cacert (*.pem)",extensions:["pem"]}]).done(function(a){a[1].split("\\");l[0]=a[1],g.$("#cert_path").textfield("value",a[1]),""!==g.$("#key_path").textfield("value")&&(g.disabled(".cert-btn6",!1),g.$(".cert-btn6").removeClass("ui-button-disabled"))}):g.tip("error","com.NeedVideoOcx"),!1},onKeySelect:function(){return a("#ocx")[0]?plugin.ShowSaveOrOpenDlg("openFile","",[{description:"privkey(*.pem)",extensions:["pem"]}]).done(function(a){a[1].split("\\");l[1]=a[1],g.$("#key_path").textfield("value",a[1]),""!==g.$("#cert_path").textfield("value")&&(g.disabled(".cert-btn6",!1),g.$(".cert-btn6").removeClass("ui-button-disabled"))}):g.tip("error","com.NeedVideoOcx"),!1},onCertUpload:function(){var a={};if("flash"===webApp.playMode||"h5"===webApp.playMode){if("pem"!==l[0].split(".")[1]||"pem"!==l[1].split(".")[1])return g.tip("warning","com.FileFormatDefaultTip"),!1;a.cert=Base64.encode(k.cert),a.key=Base64.encode(k.key)}else plugin.ReadFile(l[0]).done(function(b){a.cert=Base64.encode(b)}),plugin.ReadFile(l[1]).done(function(b){a.key=Base64.encode(b)});n.EncryptInfo(webApp.EncryptInfo.pub,{cert:a.cert,key:a.key}).done(function(a){d.CertManager.importSvrCert(a.salt,a.cipher,a.content).done(function(){p=!0,g.render(),g.tip("success","com.UpmoveSuccessTip")}).fail(function(){g.tip("error","com.UpmoveFailTip")})})},openDialog:function(){m.dialog("show"),m.find("[cfg=Country]").textfield("value",""),m.find("[cfg=CommonName]").textfield("value",""),m.find("[cfg=Email]").textfield("value",""),m.find("[cfg=State]").textfield("value","none"),m.find("[cfg=Locatity]").textfield("value","none"),m.find("[cfg=Organization]").textfield("value","none"),m.find("[cfg=OrganizationUnit]").textfield("value","none"),m.find("[cfg=UsefulLife]").numberfield("value",365)},_toLocalTime:function(a){var b=a.split(" "),c=b[0].split("-"),d=b[1].split(":"),e=new Date(c[0]-0,c[1]-0,c[2]-0,d[0]-0,d[1]-0,d[2]-0),f=e.getTimezoneOffset();return e.addMonths(-1).addSeconds(60*-f),e.format()},_onSave:function(){return h.validate(),h.isInvalid()?m.find("#httpDiaTip").tip("warning",tl(h.errors()[0].errorMsg)):(a.each(m.find("[cfg]"),function(b,c){var d=a(c).attr("cfg");i.ServerCertificate[d]="UsefulLife"===d?a(c).numberfield("value")-0:a(c).textfield("value")}),""===i.ServerCertificate.State&&(i.ServerCertificate.State="none"),""===i.ServerCertificate.Locatity&&(i.ServerCertificate.Locatity="none"),""===i.ServerCertificate.Organization&&(i.ServerCertificate.Organization="none"),""===i.ServerCertificate.OrganizationUnit&&(i.ServerCertificate.OrganizationUnit="none"),m.dialog("close"),g.$("#cert_createdRequest").textfield("value","H/IP="+i.ServerCertificate.CommonName+";C="+i.ServerCertificate.Country+";ST="+i.ServerCertificate.State+";L="+i.ServerCertificate.Locatity+";O="+i.ServerCertificate.Organization+";OU="+i.ServerCertificate.OrganizationUnit+";EM="+i.ServerCertificate.Email),q=!0,void g._renderButton())},_onCertChange:function(){var b=a(this).val();if(l[0]=b,g.$("#cert_path").textfield("value",b),""!==g.$("#key_path").textfield("value")&&(g.disabled(".cert-btn6",!1),g.$(".cert-btn6").removeClass("ui-button-disabled")),window.FileReader){var c=this.files[0];filename=c.name.split(".")[0];var d=new FileReader;d.onload=function(){k.cert=this.result},d.readAsText(c)}else if(document.implementation&&document.implementation.createDocument){var e;e=document.implementation.createDocument("","",null),e.async=!1,e.load(this.value),k.cert=e.xml}else alert(tl("com.NoSupport"))},_onKeyChange:function(){var b=a(this).val();if(l[1]=b,g.$("#key_path").textfield("value",b),""!==g.$("#cert_path").textfield("value")&&(g.disabled(".cert-btn6",!1),g.$(".cert-btn6").removeClass("ui-button-disabled")),window.FileReader){var c=this.files[0];filename=c.name.split(".")[0];var d=new FileReader;d.onload=function(){k.key=this.result},d.readAsText(c)}else if(document.implementation&&document.implementation.createDocument){var e;e=document.implementation.createDocument("","",null),e.async=!1,e.load(this.value),k.key=e.xml}else alert(tl("com.NoSupport"))}})}),define("firewall",function(require,b,c){function d(a){var b=/(^(::)$)|(^(:(:[0]{1,4}){1,7})$)|(^(([0]{1,4}:){1,7}([0]{1,4}))$)|(^(ff[a-f\d]{2}))/;return!b.test(a)}function e(a){var b=/^\s*((([0-9A-Fa-f]{1,4}:){7}([0-9A-Fa-f]{1,4}|:))|(([0-9A-Fa-f]{1,4}:){6}(:[0-9A-Fa-f]{1,4}|((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3})|:))|(([0-9A-Fa-f]{1,4}:){5}(((:[0-9A-Fa-f]{1,4}){1,2})|:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3})|:))|(([0-9A-Fa-f]{1,4}:){4}(((:[0-9A-Fa-f]{1,4}){1,3})|((:[0-9A-Fa-f]{1,4})?:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9A-Fa-f]{1,4}:){3}(((:[0-9A-Fa-f]{1,4}){1,4})|((:[0-9A-Fa-f]{1,4}){0,2}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9A-Fa-f]{1,4}:){2}(((:[0-9A-Fa-f]{1,4}){1,5})|((:[0-9A-Fa-f]{1,4}){0,3}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9A-Fa-f]{1,4}:){1}(((:[0-9A-Fa-f]{1,4}){1,6})|((:[0-9A-Fa-f]{1,4}){0,4}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(:(((:[0-9A-Fa-f]{1,4}){1,7})|((:[0-9A-Fa-f]{1,4}){0,5}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:)))(%.+)?\s*$/;return b.test(a)}require("widget/js/dui.macfield");var f,g,h=require("common/common"),i=h.Check,j=require("jsCore/rpc"),k=(require("common/rpcBase"),require("jsCore/pageBase")),l="add",m=0,n=null,o=null,p="",q="",r=null,s=64,t=null;
c.exports=k.extend({init:function(){t=this,ability.get("IPTableFilter").done(function(a){s=a&&a.RulesNum||64,a&&a.SemiConnectAttack===!1&&t.$("#firewall_type option[value = BanhalfConn]").remove()}),$tableUser=t.$("#firewall_table").table({pageable:!1,height:200,columns:[{check:"Enable",width:"10%"},{t:"net.IPaddrMAC",width:"40%",render:function(a){return"0:0:0:0:0:0"!=a.Mac?a.Mac:a.BeginIP!=a.EndIP?a.BeginIP+"-"+a.EndIP:"0.0.0.0"==a.EndIP?tl("com.AllIpAdress"):a.BeginIP}},{t:"net.Port",width:"20%",fields:"Name",render:function(a){return"0:0:0:0:0:0"!=a.Mac?"/":a.BeginPort!=a.EndPort?a.BeginPort+"-"+a.EndPort:0==a.EndPort?tl("com.DevAllPort"):a.BeginPort}},{t:"com.Modify",width:"15%",action:"edit",icon:"ui-table-icon-edit",handle:function(a){t.onEditIPNet(a)}},{t:"com.Delete",action:"delete",width:"15%",icon:"ui-table-icon-del",handle:function(b){var c=t.$("#firewall_type").val(),d=[];"NetAccess"==c?1==r[c].NetFilterType?d=r[c].WhiteAddrList:2==r[c].NetFilterType&&(d=r[c].BlackAddrList):"NtpAccess"==c&&(d=r[c].AddrList),a.confirm(tl("net.DeleteIpMac"),tl("com.SureDeleteIPMACTip"),function(){d.splice(b._index,1),t._renderElements(),t.tip("success","com.OperateingSuccessTip")},null)}}]}),$firewall_addIP=t.$("#firewall_addIP").dialog({confirm:function(){t._saveDialog($firewall_addIP.find("#firewall_pop_type").val())}}).detach().appendTo(document.body),$firewall_addIP.find("#f_pop_startServerPort").numberfield({min:1,max:65535}),$firewall_addIP.find("#f_pop_endServerPort").numberfield({min:1,max:65535}),$firewall_addIP.find("#f_pop_MAC").macfield(),a.each(["f_pop_IpAddress","f_pop_startIpAddress","f_pop_endIpAddress"],function(a,b){$firewall_addIP.find("#"+b).ipfield({type:"ip",error:function(a,b){var c=$firewall_addIP.find(".u-tip");"prevent"===b.type?c.tip("warning",tl("com.Ipv4127")):"firstIPError"==b.type?c.tip("warning",tl("com.Ipv4Range")):"lastIPError"==b.type&&c.tip("warning",tl("com.Ipv4RangeLast"))}})}),$v6ip=$firewall_addIP.find("#NN_IPV6_IP").textfield(),f=a.validator([{element:$v6ip,check:[i.ipv6ornull,d],errorMsg:["com.BadFormatIPV6address","com.BadFormatIPV6address"],events:"blur",errorElem:".u-tip"}]),$v6ip_net_start=$firewall_addIP.find("#NN_IPV6_IP_net_start").textfield(),$v6ip_net_end=$firewall_addIP.find("#NN_IPV6_IP_net_end").textfield(),g=a.validator([{element:$v6ip_net_start,check:[i.ipv6ornull,d],errorMsg:["com.BadFormatIPV6address","com.BadFormatIPV6address"],events:"blur",errorElem:".u-tip"},{element:$v6ip_net_end,check:[i.ipv6ornull,d],errorMsg:["com.BadFormatIPV6address","com.BadFormatIPV6address"],events:"blur",errorElem:".u-tip"}]),j.ConfigManager.getConfig(["Network"]).done(function(a){a[0].params.table.eth0&&(n=a[0].params.table.eth0.IPAddress,o=a[0].params.table.eth0.PhysicalAddress),a[0].params.table.eth2&&(p=a[0].params.table.eth2.IPAddress,q=a[0].params.table.eth2.PhysicalAddress)}),t._bind(),t.render()},_saveDialog:function(b){function c(a,b){var c=!1;if(1==b.length&&!b[0])return c;if("modify"==l&&a==b[m].BeginIP)return c;for(var d=0,e=b.length;e>d;d++)if(a==b[d].BeginIP&&a==b[d].EndIP){c=!0;break}return c}function d(a,b){var c=!1;if(1==b.length&&!b[0])return c;if("modify"==l&&a==b[m].BeginIP+"-"+b[m].EndIP)return c;for(var d=0,e=b.length;e>d;d++)if(a==b[d].BeginIP+"-"+b[d].EndIP){c=!0;break}return c}function e(a,b){var c=!1;if(1==b.length&&!b[0])return c;if("modify"==l&&b[m].Mac&&a.toLowerCase()==b[m].Mac.toLowerCase())return c;for(var d=0,e=b.length;e>d;d++)if(b[d].Mac&&a.toLowerCase()==b[d].Mac.toLowerCase()){c=!0;break}return c}function h(a,b,c){if("IPv6"==c)var d=a.split(":"),e=b.split(":");else var d=a.split("."),e=b.split(".");for(var f=d.length,g=[],h=[],i=0;f>i;i++)g[i]=jQuery.pad(d[i],4),h[i]=jQuery.pad(e[i],4);return g.join("")<h.join("")?!0:!1}var i="IPv6"==$firewall_addIP.find('[sel-for="onIPVersionChange"]').val(),j=t.$("#firewall_type").val(),k="white"==t.$("[name=firewall_ipauth]:checked").val()?"WhiteAddrList":"BlackAddrList",q="BlackAddrList"==k,u=$firewall_addIP.find("#f_pop_all_port").prop("checked"),v={Enable:!1,BeginIP:"0.0.0.0",EndIP:"0.0.0.0",BeginPort:0,EndPort:0,Mac:"0:0:0:0:0:0"},w="success",x="com.OperateingSuccessTip",y=r[j][k];if(y.length>=s)return t.tip("warn","com.CurrentNameListCeil"),void $firewall_addIP.dialog("close");switch("NtpAccess"==j&&(y=r[j].AddrList),b){case"IPAddress":if(i&&f.isInvalid())return void $firewall_addIP.find(".u-tip").tip("warning",tl(f.errors()[0].errorMsg));var z=$firewall_addIP.find("#f_pop_IpAddress").ipfield("value"),A=$firewall_addIP.find("#NN_IPV6_IP").textfield("value"),B=$firewall_addIP.find("#f_pop_startServerPort").numberfield("value")-0,C=$firewall_addIP.find("#f_pop_endServerPort").numberfield("value")-0;i?("NetAccess"==j&&(v=a.extend(v,{Enable:!1,BeginIP:A,EndIP:A,BeginPort:Math.min(B,C),EndPort:Math.max(B,C)})),c(A,y)&&(w="warning",x="com.IpExiseTip")):("NetAccess"==j?v=a.extend(v,{Enable:!1,BeginIP:z,EndIP:z,BeginPort:Math.min(B,C),EndPort:Math.max(B,C)}):"NtpAccess"==j&&(v=a.extend(v,{Enable:!1,BeginIP:z})),c(z,y)?(w="warning",x="com.IpExiseTip"):(n==z||p==z)&&(w="warning",x="com.IpNotNowTip"));break;case"IPNet":if(i&&g.isInvalid())return void $firewall_addIP.find(".u-tip").tip("warning",tl(g.errors()[0].errorMsg));var z=null,D=$firewall_addIP.find("#f_pop_startIpAddress").ipfield("value"),E=$firewall_addIP.find("#f_pop_endIpAddress").ipfield("value"),F=$firewall_addIP.find("#NN_IPV6_IP_net_start").textfield("value"),G=$firewall_addIP.find("#NN_IPV6_IP_net_end").textfield("value"),B=$firewall_addIP.find("#f_pop_startServerPort").numberfield("value")-0,C=$firewall_addIP.find("#f_pop_endServerPort").numberfield("value")-0;i?(h(F,G,"IPv6")||(z=F,F=G,G=z),"NetAccess"==j&&(v=a.extend(v,{Enable:!1,BeginIP:F,EndIP:G,BeginPort:Math.min(B,C),EndPort:Math.max(B,C)})),d(F+"-"+G,y)&&(w="warning",x="com.IpExiseTip")):(h(D,E)||(z=D,D=E,E=z),"NetAccess"==j?v=a.extend(v,{Enable:!1,BeginIP:D,EndIP:E,BeginPort:Math.min(B,C),EndPort:Math.max(B,C)}):"NtpAccess"==j&&(v=a.extend(v,{Enable:!1,BeginIP:D,EndIP:E})),d(D+"-"+E,y)?(w="warning",x="com.IpExiseTip"):(n+"-"+n==D+"-"+E||p+"-"+p==D+"-"+E)&&(w="warning",x="com.IpNotNowTip"));break;case"MAC":var H=$firewall_addIP.find("#f_pop_MAC").macfield("value");v=a.extend(v,{Enable:!1,Mac:H}),e(H,y)?(w="warning",x="com.MACIsExistTip"):(H.toLowerCase()==o.toLowerCase()||H.toLowerCase()==p.toLowerCase())&&(w="warning",x="com.UsedTip");break;case"All":var B=$firewall_addIP.find("#f_pop_startServerPort").numberfield("value")-0,C=$firewall_addIP.find("#f_pop_endServerPort").numberfield("value")-0;if(v=a.extend(v,{Enable:!1,BeginIP:"0.0.0.0",EndIP:"0.0.0.0",BeginPort:Math.min(B,C),EndPort:Math.max(B,C),Mac:"0:0:0:0:0:0"}),q&&1==v.BeginPort&&65535==v.EndPort)return void $firewall_addIP.find(".u-tip").tip("warning",tl("com.BlackIpSetPortAgain"))}u&&(v=a.extend(v,{BeginPort:0,EndPort:0})),"success"==w&&("add"==l?y.push(v):"modify"==l&&(v.Enable=y[m].Enable,y.splice(m,1,v)),t._renderElements()),$firewall_addIP.dialog("close"),t.tip(w,x)},render:function(){t._getConfig()},_getConfig:function(a){j.ConfigManager.getConfig("IPTableFilter").done(function(b){r=b,t._renderElements(r),a&&t.tip("success","com.OperateSuccessTip")}).fail(function(){t.tip("error","com.OperateFailTip")})},_renderElements:function(){t.selectFirewallType()},onAddIPNet:function(){l="add",$firewall_addIP.find(".u-dialog-head h1").text(tl("net.AddIPMac")),"b"==t.$("#firewall_type").val()&&($firewall_addIP.find("#firewall_pop_type").empty(),$firewall_addIP.find("#firewall_pop_type").append(['<option value="a">'+tl("net.IPAddress")+"</option>",'<option value="b">'+tl("net.IPArea")+"</option>"])),$firewall_addIP.find("#f_pop_IpAddress").ipfield("value","1.0.0.1"),$firewall_addIP.find("#f_pop_startIpAddress").ipfield("value","1.0.0.1"),$firewall_addIP.find("#f_pop_endIpAddress").ipfield("value","1.0.0.1"),$firewall_addIP.find("#f_pop_startServerPort").numberfield("value",0),$firewall_addIP.find("#f_pop_endServerPort").numberfield("value",0),$firewall_addIP.find("#f_pop_MAC").macfield("value","00:00:00:00:00:00"),$firewall_addIP.find('[sel-for="onIPVersionChange"]').val("IPv4"),$firewall_addIP.find("#NN_IPV6_IP").textfield("value",""),$firewall_addIP.find("#NN_IPV6_IP_net_start").textfield("value",""),$firewall_addIP.find("#NN_IPV6_IP_net_end").textfield("value",""),$firewall_addIP.find("#NN_IPV6_IPEx").numberfield("value",1),$firewall_addIP.find("#NN_IPV6_IPEx_start").numberfield("value",1),$firewall_addIP.find("#NN_IPV6_IPEx_end").numberfield("value",1),$firewall_addIP.find("#f_pop_all_port").prop("checked",!1),$firewall_addIP.find("[sel-for=selectNetType]").find("option[value=All]").prop("disabled",!1),$firewall_addIP.dialog("show"),$firewall_addIP.find("#firewall_pop_type").val("IPAddress"),$firewall_addIP.find("#firewall_pop_type").change()},onEditIPNet:function(a){l="modify",$firewall_addIP.find(".u-dialog-head h1").text(tl("com.Modify")),m=a._index;var b=t.$("#firewall_type").val();if($firewall_addIP.find("#f_pop_all_port").prop("checked",!1),$firewall_addIP.find("[sel-for=selectNetType]").find("option[value=All]").prop("disabled",!1),"0:0:0:0:0:0"!=a.Mac)$firewall_addIP.find("#f_pop_MAC").macfield("value",a.Mac),$firewall_addIP.find("#firewall_pop_type").val("MAC");else{var c=e(a.EndIP);c?($firewall_addIP.find('[sel-for="onIPVersionChange"]').val("IPv6"),a.EndIP!=a.BeginIP?($firewall_addIP.find("#NN_IPV6_IP_net_start").textfield("value",a.BeginIP),$firewall_addIP.find("#NN_IPV6_IP_net_end").textfield("value",a.EndIP),$firewall_addIP.find("#firewall_pop_type").val("IPNet")):($firewall_addIP.find("#NN_IPV6_IP").textfield("value",a.BeginIP),$firewall_addIP.find("#firewall_pop_type").val("IPAddress"))):a.EndIP!=a.BeginIP?($firewall_addIP.find("#f_pop_startIpAddress").ipfield("value",a.BeginIP),$firewall_addIP.find("#f_pop_endIpAddress").ipfield("value",a.EndIP),$firewall_addIP.find("#firewall_pop_type").val("IPNet"),$firewall_addIP.find('[sel-for="onIPVersionChange"]').val("IPv4")):"0.0.0.0"==a.BeginIP?$firewall_addIP.find('[sel-for="selectNetType"]').val("All"):($firewall_addIP.find("#f_pop_IpAddress").ipfield("value",a.BeginIP),$firewall_addIP.find("#firewall_pop_type").val("IPAddress"),$firewall_addIP.find('[sel-for="onIPVersionChange"]').val("IPv4")),"NetAccess"==b&&(0==a.BeginPort&&0==a.EndPort?$firewall_addIP.find("#f_pop_all_port").prop("checked",!1).click():($firewall_addIP.find("#f_pop_startServerPort").numberfield("value",a.BeginPort),$firewall_addIP.find("#f_pop_endServerPort").numberfield("value",a.EndPort)))}$firewall_addIP.dialog("show"),$firewall_addIP.find("#firewall_pop_type").change(),$firewall_addIP.find('[sel-for="onIPVersionChange"]').change()},selectFirewallType:function(){var a=t.$("#firewall_type").val();switch(a){case"NetAccess":t.doNetAccess(a);break;case"NtpAccess":t.ipAuth(a);break;case"BanPing":t.forbidPing(a);break;case"BanhalfConn":t.preventHalfConnect(a)}},onIPVersionChange:function(){var a=$firewall_addIP.find("#firewall_pop_type").val(),b=$firewall_addIP.find('[sel-for="onIPVersionChange"]').val();$firewall_addIP.find("#f_IPv6").addClass("fn-hide"),$firewall_addIP.find("#f_IPv4").addClass("fn-hide"),$firewall_addIP.find("#f_"+b).removeClass("fn-hide"),"IPv4"==b?"IPAddress"!=a&&($firewall_addIP.find("#f_IPv4").addClass("fn-hide"),$firewall_addIP.find("#f_IPv6_net_start").addClass("fn-hide"),$firewall_addIP.find("#f_IPv6_net_end").addClass("fn-hide"),"IPNet"==a?($firewall_addIP.find("#f_pop_startIpAddress").parent().removeClass("fn-hide"),$firewall_addIP.find("#f_pop_endIpAddress").parent().removeClass("fn-hide")):($firewall_addIP.find("#f_IPv6_net_start").addClass("fn-hide"),$firewall_addIP.find("#f_IPv6_net_end").addClass("fn-hide"))):"IPv6"==b&&("IPAddress"!=a?($firewall_addIP.find("#f_IPv6").addClass("fn-hide"),$firewall_addIP.find("#f_IPv6_net_start").removeClass("fn-hide"),$firewall_addIP.find("#f_IPv6_net_end").removeClass("fn-hide"),$firewall_addIP.find("#f_pop_startIpAddress").parent().addClass("fn-hide"),$firewall_addIP.find("#f_pop_endIpAddress").parent().addClass("fn-hide")):($firewall_addIP.find("#f_IPv6_net_start").addClass("fn-hide"),$firewall_addIP.find("#f_IPv6_net_end").addClass("fn-hide")))},doNetAccess:function(){var a=r.NetAccess.NetFilterType;t._showOrHideNode(["f_net_type"],"show"),t._showOrHideNode(["firewall_net"],a>0?"show":"hide"),t.$("#firewall_type_enable").prop("checked",a>0),t.$("#firewall_ipAuth_tip").parent().show(),1==a?(t.$("#firewall_ipauth_white").trigger("click"),$tableUser.table("dataSource",r.NetAccess.WhiteAddrList)):2==a&&(t.$("#firewall_ipauth_black").trigger("click"),$tableUser.table("dataSource",r.NetAccess.BlackAddrList))},ipAuth:function(a){t._showOrHideNode(["f_net_type"],"hide"),t._showOrHideNode(["firewall_net"],"show"),t.$("#firewall_ipAuth_tip").parent().hide(),t.$("#firewall_type_enable").prop("checked",r[a].Enable),$tableUser.table("dataSource",r.NtpAccess.AddrList)},forbidPing:function(a){t.$("#firewall_type_enable").prop("checked",r[a]),t.$("#firewall_net").addClass("fn-hide")},preventHalfConnect:function(a){t.$("#firewall_type_enable").prop("checked",r[a]),t.$("#firewall_net").addClass("fn-hide")},selectNetType:function(){function a(){for(var a=["firewall_ipAuth_tip","f_pop_IpAddress","f_pop_startIpAddress","f_pop_endIpAddress","f_pop_startServerPort","f_pop_endServerPort","f_pop_MAC","f_ipVersion","NN_IPV6_IP_net_start","NN_IPV6_IP_net_end","NN_IPV6_IP","f_pop_all_port_label"],b=0,c=a.length;c>b;b++)$firewall_addIP.find("#"+a[b]).parent().addClass("fn-hide");$firewall_addIP.find("#f_pop_all_port").prop("disabled",!1)}function b(a){for(var b=0,c=a.length;c>b;b++)$firewall_addIP.find("#"+a[b]).parent().removeClass("fn-hide")}var c=$firewall_addIP.find("#firewall_pop_type").val(),d=$firewall_addIP.find("#f_pop_all_port").prop("checked");if(a(),"NetAccess"==t.$("#firewall_type").val())switch(d||"MAC"==c||b(["f_pop_startServerPort","f_pop_endServerPort"]),c){case"IPAddress":b(["f_pop_IpAddress","f_ipVersion","f_pop_all_port_label"]);break;case"IPNet":b(["f_pop_startIpAddress","f_pop_endIpAddress","f_ipVersion","NN_IPV6_IP_net_start","NN_IPV6_IP_net_end","f_pop_all_port_label"]);break;case"MAC":b(["f_pop_MAC"]);break;case"All":var e=t.$("#firewall_ipauth_black").prop("checked");e&&$firewall_addIP.find("#f_pop_all_port").prop("disabled",!0),b(["f_pop_all_port_label"])}else if("NtpAccess"==t.$("#firewall_type").val())switch(c){case"IPAddress":b(["f_pop_IpAddress","f_ipVersion","f_pop_all_port_label"]);break;case"IPNet":b(["f_pop_startIpAddress","f_pop_endIpAddress","f_ipVersion","NN_IPV6_IP_net_start","NN_IPV6_IP_net_end","f_pop_all_port_label"]);break;case"MAC":b(["f_pop_MAC"])}"MAC"!=c&&"All"!=c&&$firewall_addIP.find("[sel-for=onIPVersionChange]").change()},_bind:function(){t.$("#firewall_ipauth_white").on("click",function(){r.NetAccess.NetFilterType=1,$tableUser.table("dataSource",r.NetAccess.WhiteAddrList),t.$("#firewall_ipAuth_tip").text(tl("com.AllowIPConnectDeviceTip"))}),t.$("#firewall_ipauth_black").on("click",function(){r.NetAccess.NetFilterType=2,$tableUser.table("dataSource",r.NetAccess.BlackAddrList),t.$("#firewall_ipAuth_tip").text(tl("com.ForbidenIPConnectDeviceTip"))}),t.$("#firewall_type_enable").on("click",function(){var a=t.$("#firewall_type").val();"NetAccess"==a?t.$(this).prop("checked")?(t._showOrHideNode(["firewall_net"],"show"),t.$("#firewall_ipauth_white").click()):(r.NetAccess.NetFilterType=0,t._showOrHideNode(["firewall_net"],"hide")):"NtpAccess"==a?r[a].Enable=t.$(this).prop("checked"):r[a]=t.$(this).prop("checked")}),$firewall_addIP.find("#f_pop_all_port").on("click",function(){var a=t.$("#firewall_ipauth_black").prop("checked"),b=$firewall_addIP.find("#f_pop_all_port").prop("checked");b?($firewall_addIP.find("#f_pop_endServerPort").parent().addClass("fn-hide"),$firewall_addIP.find("#f_pop_startServerPort").parent().addClass("fn-hide"),$firewall_addIP.find("#f_pop_endServerPort").numberfield("value",0),$firewall_addIP.find("#f_pop_startServerPort").numberfield("value",0),a&&$firewall_addIP.find("[sel-for=selectNetType]").find("option[value=All]").prop("disabled",!0)):(a&&$firewall_addIP.find("[sel-for=selectNetType]").find("option[value=All]").prop("disabled",!1),$firewall_addIP.find("#f_pop_endServerPort").parent().removeClass("fn-hide"),$firewall_addIP.find("#f_pop_startServerPort").parent().removeClass("fn-hide"))})},_showOrHideNode:function(a,b){"string"==typeof a&&(a=[a]);for(var c=0,d=a.length;d>c;c++)"hide"==b?t.$("#"+a[c]).addClass("fn-hide"):"show"==b&&t.$("#"+a[c]).removeClass("fn-hide")},onRefresh:function(){t._getConfig(!0)},onConfirm:function(){function b(a){for(var b=!1,c=0,d=a.length;d>c;c++)if(a[c]&&a[c].Enable){b=!0;break}return b}if(1==r.NetAccess.NetFilterType){if(!b(r.NetAccess.WhiteAddrList))return void a.alert(tl("com.WhiteIPAuthMustEnableOne"))}else if(2==r.NetAccess.NetFilterType&&!b(r.NetAccess.BlackAddrList))return void a.alert(tl("com.BlackIPAuthMustEnableOne"));j.ConfigManager.setConfig("IPTableFilter",r).done(function(){t.tip("success","com.SaveSuccessTip")}).fail(function(){t.tip("error","com.SaveConfigFailTip")})},onDefault:function(){j.ConfigManager.getDefault("IPTableFilter").done(function(a){r=a,t.tip("success","com.DefaultSuccessTip"),t._renderElements(a)}).fail(function(){t.tip("error","com.DefaultfailureTip")})}})})}(jQuery);