define(function(require){var a=require("jsCore/rpc"),b=require("jsCore/rpcLogin"),c=require("common/common"),d=c.Check,e=Page.recordStorageConfig={Tab:[],init:function(){e.Tab.path.init(),e.Tab.local.init(),e.Tab.ftp.init(),e.Tab.newftp.init(),e.Tab.network.init(),e.Tab.store.init(),e.Tab.lightstore.init(),webApp.GongAnDetect&&($$("#vertical_line").setStyle("display","block"),$$("#right_half").setStyle("display","block"),$$("#rs_tab_title_store").setStyle("display","block"),$$("#rs_tab_store").setStyle("display","block")),webCaps.is_show_newIntelli?($$("#rs_tab_title_ftp").setStyle("display","none"),$$("#rs_tab_title_newftp").setStyle("display","block")):($$("#rs_tab_title_ftp").setStyle("display","block"),$$("#rs_tab_title_newftp").setStyle("display","none")),jQuery.when(ability.is("BitrateConflict"),a.Encode.getCaps()).done(function(a,b){if(!a){var c=b&&b.VideoEncodeDevices&&b.VideoEncodeDevices[0].SupportDynamicBitrate;if(c){var d=c.some(function(a){return a.Support}),e=c.filter(function(a){return a.Support}),f="";if(d){$$("#rs_tab_title_lightstore").setStyle("display","block");for(var g=0;g<e.length;g++)f+="Main"==e[g].Stream?'<option value="Main" t="med.MainStream"></option>':"Extra1"==e[g].Stream?'<option value="Extra1" t="med.AuxiliaryStream1"></option>':'<option value="Extra2" t="med.AuxiliaryStream2"></option>';$$("#rs_tab_store_stream").set("html",f).translation(),1===e.length&&$("rs_tab_store_stream").getParent().setStyle("display","none")}}}}),e.translate(),e.bind(),e.render()},translate:function(){$("page_recordStorageConfig").translation()},render:function(){isEnable("is_show_help")||$("rs_help").setStyle("display","none"),$$(".rs_tab_title.ui-tab-current").fireEvent("click")},bind:function(){$$(".rs_tab_title").addEvent("click",e._onTabTitleClick),$("rs_help").addEvent("click",function(){openHelp("recordStorageConfig.htm")})},_onTabTitleClick:function(){var a=this.getProperty("data-for");e.Tab[a].render(),$$(".rs_tab_title").removeClass("ui-tab-current"),$$(".rs_tabs").setStyle("display","none"),this.addClass("ui-tab-current"),$("rs_tab_"+a).setStyle("display","block")}};!function(){var b,c=[!1,!1,!1,!1,!1,!1,!1,!1,!1],d=[!1,!1,!1,!1,!1,!1,!1,!1,!1],e=!0,f=!1,g=Page.recordStorageConfig.Tab.path={init:function(){g.translate(),g.bind(),g._showAlarmInfo()},translate:function(){},render:function(){g._getConfigAndRenderElements()},bind:function(){$$("#page_recordStorageConfig input[id^=rs_record]").addEvent("click",function(){g._onCheckBoxClick("record",this)}),$$("#page_recordStorageConfig input[id^=rs_snapshot]").addEvent("click",function(){g._onCheckBoxClick("snapshot",this)}),$("rs_tab_path_default").addEvent("click",g._onDefaultClick),$("rs_tab_path_confirm").addEvent("click",g._onConfirmClick),$("rs_tab_path_refresh").addEvent("click",g._onRefreshClick)},_showAlarmInfo:function(){webApp.ALARM_IN_NUMBER>0||webApp.IsLocalStore?($$(".rs_tab_path_event_type_alarm").setStyle("display",""),$$(".rs_tab_path_event_check_alarm").setStyle("display","")):(f=!0,$$(".rs_tab_path_event_type_alarm").setStyle("display","none"),$$(".rs_tab_path_event_check_alarm").setStyle("display","none")),isEnable("show_NAS_config")&&$$(".rs_tab_path_remote_wrap").setStyle("display",""),webApp.IsLocalStore?$$(".rs_tab_path_local_wrap").setStyle("display",""):$$(".rs_tab_path_local_wrap").setStyle("display","none");for(var a,b=$$("#rs_tab_path_videotab table tr").filter(function(a){return"none"!=a.style.display}),c=$$("#rs_tab_path_snaptab table tr").filter(function(a){return"none"!=a.style.display}),d=0;d<b.length;d++)a=d%2?"":"ui-special-table-tr-odd",b[d].addClass(a);for(var e=0;e<c.length;e++)a=e%2?"":"ui-special-table-tr-odd",c[e].addClass(a)},_setVideoAndSnapShotArray:function(a){c[0]=a.TimingRecord.Local,c[3]=a.TimingRecord.FTP=!!a.TimingRecord.FTP,c[6]=a.TimingRecord.Remote,c[1]=a.VideoDetectRecord.Local,c[4]=a.VideoDetectRecord.FTP=!!a.VideoDetectRecord.FTP,c[7]=a.VideoDetectRecord.Remote,c[2]=a.AlarmRecord.Local,c[5]=a.AlarmRecord.FTP=!!a.AlarmRecord.FTP,c[8]=a.AlarmRecord.Remote,d[0]=a.TimingSnapShot.Local,d[3]=a.TimingSnapShot.FTP=!!a.TimingSnapShot.FTP,d[6]=a.TimingSnapShot.Remote,d[1]=a.VideoDetectSnapShot.Local,d[4]=a.VideoDetectSnapShot.FTP=!!a.VideoDetectSnapShot.FTP,d[7]=a.VideoDetectSnapShot.Remote,d[2]=a.AlarmSnapShot.Local,d[5]=a.AlarmSnapShot.FTP=!!a.AlarmSnapShot.FTP,d[8]=a.AlarmSnapShot.Remote},_showRecordCheck:function(){for(var a=0;9>a;a++)$("rs_record_"+a).checked=c[a]},_showSnapShotCheck:function(){for(var a=0;9>a;a++)$("rs_snapshot_"+a).checked=d[a]},_showSync:function(a){$("rs_tab_ftp_sync").checked=a.TimingRecord.AutoSync||a.VideoDetectRecord.AutoSync||a.AlarmRecord.AutoSync||a.TimingSnapShot.AutoSync||a.VideoDetectSnapShot.AutoSync||a.AlarmSnapShot.AutoSync,e&&($("rs_tab_ftp_emergency").checked=a.TimingRecord.LocalForEmergency||a.VideoDetectRecord.LocalForEmergency||a.AlarmRecord.LocalForEmergency||a.TimingSnapShot.LocalForEmergency||a.VideoDetectSnapShot.LocalForEmergency||a.AlarmSnapShot.LocalForEmergency,e=!1)},_onCheckBoxClick:function(a,b){var e,h,i=b.id.replace(/[^\d]/g,"")-0;if("record"===a?(e=c,h=d):(e=d,h=c),e[i]=b.checked,b.checked)switch(i){case 0:case 1:case 2:for((e[3]||e[6])&&(e[0]=!0),(e[4]||e[7])&&(e[1]=!0),(e[5]||e[8])&&(e[2]=!0),f&&(e[2]=!1,h[2]=!1),i=3;9>i;i++)e[i]=!1;break;case 3:case 4:case 5:for((e[0]||e[6])&&(e[3]=!0),(e[1]||e[7])&&(e[4]=!0),(e[2]||e[8])&&(e[5]=!0),i=0;3>i;i++)e[i]=!1;for(i=6;9>i;i++)e[i]=!1;for(h[6]&&(h[3]=!0),h[7]&&(h[4]=!0),h[8]&&(h[5]=!0),f&&(e[5]=!1,h[5]=!1),i=6;9>i;i++)h[i]=!1;break;case 6:case 7:case 8:for((e[0]||e[3])&&(e[6]=!0),(e[1]||e[4])&&(e[7]=!0),(e[2]||e[5])&&(e[8]=!0),i=0;6>i;i++)e[i]=!1;for(h[3]&&(h[6]=!0),h[4]&&(h[7]=!0),h[5]&&(h[8]=!0),f&&(e[8]=!1,h[8]=!1),i=3;6>i;i++)h[i]=!1}g._showRecordCheck(),g._showSnapShotCheck()},_onConfirmClick:function(){var e=b,f=$("rs_tab_ftp_emergency").checked,g=$("rs_tab_ftp_sync").checked;e.TimingRecord.Local=c[0],e.TimingRecord.FTP=c[3],e.TimingRecord.Remote=c[6],e.TimingRecord.LocalForEmergency=c[3]&&f,e.TimingRecord.AutoSync=c[3]&&g,e.VideoDetectRecord.Local=c[1],e.VideoDetectRecord.FTP=c[4],e.VideoDetectRecord.Remote=c[7],e.VideoDetectRecord.LocalForEmergency=c[4]&&f,e.VideoDetectRecord.AutoSync=c[4]&&g,e.AlarmRecord.Local=c[2],e.AlarmRecord.FTP=c[5],e.AlarmRecord.Remote=c[8],e.AlarmRecord.LocalForEmergency=c[5]&&f,e.AlarmRecord.AutoSync=c[5]&&g,e.TimingSnapShot.Local=d[0],e.TimingSnapShot.FTP=d[3],e.TimingSnapShot.LocalForEmergency=d[3]&&f,e.TimingSnapShot.AutoSync=d[3]&&g,e.TimingSnapShot.Remote=d[6],e.VideoDetectSnapShot.Local=d[1],e.VideoDetectSnapShot.FTP=d[4],e.VideoDetectSnapShot.LocalForEmergency=d[4]&&f,e.VideoDetectSnapShot.AutoSync=d[4]&&g,e.VideoDetectSnapShot.Remote=d[7],e.AlarmSnapShot.Local=d[2],e.AlarmSnapShot.FTP=d[5],e.AlarmSnapShot.LocalForEmergency=d[5]&&f,e.AlarmSnapShot.AutoSync=d[5]&&g,e.AlarmSnapShot.Remote=d[8],e.ManualRecord.Local=c[0]||c[1]||c[2],e.ManualRecord.LocalForEmergency=e.TimingRecord.LocalForEmergency||e.VideoDetectRecord.LocalForEmergency||e.AlarmRecord.LocalForEmergency,e.ManualRecord.AutoSync=e.TimingRecord.AutoSync||e.VideoDetectRecord.AutoSync||e.AlarmRecord.AutoSync,e.ManualRecord.Remote=c[6]||c[7]||c[8]||c[3]||c[4]||c[5],e.EventRecord.Local=e.ManualRecord.Local,e.EventRecord.LocalForEmergency=e.ManualRecord.LocalForEmergency,e.EventRecord.AutoSync=e.ManualRecord.AutoSync,e.EventRecord.Remote=e.ManualRecord.Remote,e.ManualSnapShot.Local=d[0]||d[1]||d[2],e.ManualSnapShot.LocalForEmergency=e.TimingSnapShot.LocalForEmergency||e.VideoDetectSnapShot.LocalForEmergency||e.AlarmSnapShot.LocalForEmergency,e.ManualSnapShot.AutoSync=e.TimingSnapShot.AutoSync||e.VideoDetectSnapShot.AutoSync||e.AlarmSnapShot.AutoSync,e.ManualSnapShot.Remote=d[6]||d[7]||d[8]||d[3]||d[4]||d[5],e.EventSnapShot.Local=e.ManualSnapShot.Local,e.EventSnapShot.LocalForEmergency=e.ManualSnapShot.LocalForEmergency,e.EventSnapShot.AutoSync=e.ManualSnapShot.AutoSync,e.EventSnapShot.Remote=e.ManualSnapShot.Remote,a.ConfigManager.getConfig("NAS").done(function(b){var c,d,f;for(c=b,d=e.TimingRecord.FTP||e.VideoDetectRecord.FTP||e.AlarmRecord.FTP||e.TimingSnapShot.FTP||e.VideoDetectSnapShot.FTP||e.AlarmSnapShot.FTP,hasNFS=e.TimingRecord.Remote||e.VideoDetectRecord.Remote||e.AlarmRecord.Remote||e.TimingSnapShot.Remote||e.VideoDetectSnapShot.Remote||e.AlarmSnapShot.Remote,f=0;f<c.length;f++)"FTP"!=c[f].Protocol&&d?c[f].Enable=!1:"FTP"!=c[f].Protocol||d?"NFS"!=c[f].Protocol||hasNFS||(c[f].Enable=!1,$("rs_tab_network_enable").checked=!1,$("rs_tab_network_enable").disabled=!0):(c[f].Enable=!1,$("rs_tab_ftp_enable").checked=!1,$("rs_tab_ftp_enable").disabled=!0,$("rs_tab_ftp_emergency").checked=!1,$("rs_tab_ftp_emergency").disabled=!0);d||a.Storage.getCaps().done(function(b){b&&b.RemoteStoreList&&-1!==b.RemoteStoreList.indexOf("SFTP")&&a.ConfigManager.getConfig("SFTP").done(function(b){var c=b[0];c.Enable=!1,a.ConfigManager.setConfig("SFTP",[c])})});for(var g=[],h=0;h<webApp.CHANNEL_NUMBER;h++)g.push(e);a.ConfigManager.setConfig("RecordStoragePoint",g).done(function(){a.ConfigManager.setConfig("NAS",c).done(function(){remarkDisplay("rs_tab_path_remark",tl("com.SaveSuccessTip"),3e3,0)}).fail(function(){remarkDisplay("rs_tab_path_remark",tl("com.SaveConfigFailTip"),3e3,1)})}).fail(function(){remarkDisplay("rs_tab_path_remark",tl("com.SaveConfigFailTip"),3e3,1)})})},_onRefreshClick:function(){g._getConfigAndRenderElements(!0)},_onDefaultClick:function(){a.ConfigManager.getDefault("RecordStoragePoint").done(function(a){b=a[0],g._setVideoAndSnapShotArray(b),g._showSync(b),g._showRecordCheck(),g._showSnapShotCheck(),remarkDisplay("rs_tab_path_remark",tl("com.DefaultSuccessTip"),3e3,0)}).fail(function(){remarkDisplay("rs_tab_path_remark",tl("com.DefaultfailureTip"),3e3,1)})},_getConfigAndRenderElements:function(c){a.ConfigManager.getConfig("RecordStoragePoint").done(function(a){b=a[0],g._setVideoAndSnapShotArray(b),g._showSync(b),g._showRecordCheck(),g._showSnapShotCheck(),c&&remarkDisplay("rs_tab_path_remark",tl("com.OperateSuccessTip"),3e3,0)}).fail(function(){remarkDisplay("rs_tab_path_remark",tl("com.OperateFailTip"),3e3,1)})},getRecordStoragePoint:function(){var a=$unlink(b);return a}}}(),function(){var e,f,g,h,i=[],j=[-1,-1],k=!1,l=!0,m=jQuery.Deferred(),n=["com.Normal","net.UnAuthorised","SDEncrypt.Encrypt"],o=Page.recordStorageConfig.Tab.local={init:function(){return webApp.IsLocalStore?$("rs_tab_title_local").setStyle("display",""):$("rs_tab_title_local").setStyle("display","none"),b.chkAuthority("MHardisk")?(e=jQuery("#rs_encrypt_dialog").dialog({confirm:function(){var b=this;if(validatorEncrypt.isInvalid())return validatorEncrypt.validate();var c=i[j[0]],d=jQuery(this).find("[name=newPsw]").val();a.SDEncrypt.encrypt(c.Name,d).done(function(){o.render(!1),e.find(".u-tip").tip("success",tl("com.OperateSuccessTip")),setTimeout(function(){var a=jQuery(b).offsetParent().find(".ui-pwd-strength");o.checkPwdStrength("",a),e.dialog("close")},3e3)}).fail(function(){e.find(".u-tip").tip("error",tl("com.OperateFailTip"))})},cancel:function(){var a=jQuery(this).offsetParent().find(".ui-pwd-strength");o.checkPwdStrength("",a)}}).detach().appendTo(document.body),f=jQuery("#rs_decrypt_dialog").dialog({confirm:function(){if(validatorDecrypt.isInvalid())return validatorDecrypt.validate();var b=i[j[0]],c=jQuery(this).find("[name=psw]").val();""!==c&&a.SDEncrypt.decrypt(b.Name,c).done(function(){o.render(!1),f.find(".u-tip").tip("success",tl("com.OperateSuccessTip")),setTimeout(function(){f.dialog("close")},3e3)}).fail(function(){a.SDEncrypt.getOperateErrorPolicy(b.Name,"decrypt").done(function(a){var b=tl("com.OperateFailTip");a.params.policy&&a.params.policy.leftTimes?b=tl("sys.AfreshPwdTip")+tl("com.LoginTimes").replace("XXXX",a.params.policy.leftTimes):a.params.policy&&a.params.policy.lockSeconds&&(b=tl("com.AccoutLockTip")+tl("sys.lockedSecond").replace("XXXX",a.params.policy.lockSeconds)),f.find(".u-tip").tip("error",b)})})}}).detach().appendTo(document.body),g=jQuery("#rs_modify_dialog").dialog({confirm:function(){var b=this;if(validatorModify.isInvalid())return validatorModify.validate();var c=i[j[0]],d=jQuery(this).find("[name=oldPsw]").val(),e=jQuery(this).find("[name=newPsw]").val();a.SDEncrypt.modifyPassword(c.Name,e,d).done(function(){o.render(!1),g.find(".u-tip").tip("success",tl("com.OperateSuccessTip")),setTimeout(function(){g.dialog("close");var a=jQuery(b).offsetParent().find(".ui-pwd-strength");o.checkPwdStrength("",a)},3e3)}).fail(function(){a.SDEncrypt.getOperateErrorPolicy(c.Name,"modifyPassword").done(function(a){var b=tl("com.OperateFailTip");a.params.policy&&a.params.policy.leftTimes?b=tl("sys.AfreshPwdTip")+tl("com.LoginTimes").replace("XXXX",a.params.policy.leftTimes):a.params.policy&&a.params.policy.lockSeconds&&(b=tl("com.AccoutLockTip")+tl("sys.lockedSecond").replace("XXXX",a.params.policy.lockSeconds)),g.find(".u-tip").tip("error",b)})})},cancel:function(){var a=jQuery(this).offsetParent().find(".ui-pwd-strength");o.checkPwdStrength("",a)}}).detach().appendTo(document.body),h=jQuery("#rs_clear_dialog").dialog({confirm:function(){var b=this;if(validatorClear.isInvalid())return validatorClear.validate();var c=i[j[0]],d=jQuery(this).find("[name=psw]").val();a.SDEncrypt.clearPassword(c.Name,d).done(function(){o.render(!1),h.find(".u-tip").tip("success",tl("com.OperateSuccessTip")),setTimeout(function(){h.dialog("close");var a=jQuery(b).offsetParent().find(".ui-pwd-strength");o.checkPwdStrength("",a)},3e3)}).fail(function(){a.SDEncrypt.getOperateErrorPolicy(c.Name,"clearPassword").done(function(a){var b=tl("com.OperateFailTip");a.params.policy&&a.params.policy.leftTimes?b=tl("sys.AfreshPwdTip")+tl("com.LoginTimes").replace("XXXX",a.params.policy.leftTimes):a.params.policy&&a.params.policy.lockSeconds&&(b=tl("com.AccoutLockTip")+tl("sys.lockedSecond").replace("XXXX",a.params.policy.lockSeconds)),h.find(".u-tip").tip("error",b)})})},cancel:function(){var a=jQuery(this).offsetParent().find(".ui-pwd-strength");o.checkPwdStrength("",a)}}).detach().appendTo(document.body),validatorEncrypt=jQuery.validator([{element:e.find("[name=newPsw]"),check:[d.noQuotationColonAndASCII,d.noQuotationColonAndASCII,d.noQuotationColonAnd,d.noQuotationColonAnd,function(a){return a.length>=8},function(a){return a.length>=8},c.getPasswordStrong,c.getPasswordStrong],errorMsg:["com.PwdTip2","com.PwdTip2","com.PwdTip2","com.PwdTip2","com.BadlengtPassword8Tip","com.BadlengtPassword8Tip","itc.PasswordTowWordTip","itc.PasswordTowWordTip"],events:["keyup","blur","keyup","blur","keyup","blur","keyup","blur"],errorElem:".u-input-error"},{element:e.find("[name=newPswCfm]"),check:[function(a){return a===e.find("[name=newPsw]").val()},function(a){return a===e.find("[name=newPsw]").val()}],errorMsg:["com.PwdDifTip","com.PwdDifTip"],events:["keyup","blur"],errorElem:".u-input-error"}],function(a){a.parent().translation()}),validatorDecrypt=jQuery.validator([{element:f.find("[name=psw]"),check:[d.require,d.require],errorMsg:["com.NullPwdTip","com.NullPwdTip"],events:["keyup","blur"],errorElem:".u-input-error"}],function(a){a.parent().translation()}),validatorModify=jQuery.validator([{element:g.find("[name=oldPsw]"),check:[d.require,d.require],errorMsg:["com.NullPwdTip","com.NullPwdTip"],events:["keyup","blur"],errorElem:".u-input-error"},{element:g.find("[name=newPsw]"),check:[d.noQuotationColonAndASCII,d.noQuotationColonAndASCII,d.noQuotationColonAnd,d.noQuotationColonAnd,function(a){return a.length>=8},function(a){return a.length>=8},c.getPasswordStrong,c.getPasswordStrong],errorMsg:["com.PwdTip2","com.PwdTip2","com.PwdTip2","com.PwdTip2","com.BadlengtPassword8Tip","com.BadlengtPassword8Tip","itc.PasswordTowWordTip","itc.PasswordTowWordTip"],events:["keyup","blur","keyup","blur","keyup","blur","keyup","blur"],errorElem:".u-input-error"},{element:g.find("[name=newPswCfm]"),check:[function(a){return a===g.find("[name=newPsw]").val()},function(a){return a===g.find("[name=newPsw]").val()}],errorMsg:["com.PwdDifTip","com.PwdDifTip"],events:["keyup","blur"],errorElem:".u-input-error"}],function(a){a.parent().translation()}),validatorClear=jQuery.validator([{element:h.find("[name=psw]"),check:[d.require,d.require],errorMsg:["com.NullPwdTip","com.NullPwdTip"],events:["keyup","blur"],errorElem:".u-input-error"}],function(a){a.parent().translation()}),e.find("[name=newPsw]").on({keydown:function(a){return 32===a.keyCode?!1:void 0},keyup:function(){var a=jQuery(this).val(),b=jQuery(this).offsetParent().find(".ui-pwd-strength");o.checkPwdStrength(a,b)}}),g.find("[name=newPsw]").on({keydown:function(a){return 32===a.keyCode?!1:void 0},keyup:function(){var a=jQuery(this).val(),b=jQuery(this).offsetParent().find(".ui-pwd-strength");o.checkPwdStrength(a,b)}}),o.formatDialog=new Dialog("rs_format_dialog",o._formatSDCard,"rs_format_confirm","rs_format_cancel",tl("sto.Format")),m=a.Storage.getCaps().done(function(a){a&&1===a.NeedRebootAfterFormat&&(l=!1)}),m.always(function(){(isEnable("is_noNeed_reboot")||!l)&&$("rs_format_tip").setProperty("t","com.CfmFormatTip").set("text",tl("com.CfmFormatTip"))}),o.translate(),void o.bind()):void($("rs_tab_title_local").style.display="none")},translate:function(){},render:function(b){o.formatDialog.close(),j=[-1,-1],k=!1,a.Storage.getDeviceAllInfo().done(function(a){$("rs_tab_local_mode").style.display="table-cell",i=a,i?(b&&remarkDisplay("rs_tab_local_remark",tl("com.OperateSuccessTip"),3e3,0),o._showDeviceList(b),o._addDeviceListEventLister(),$$("#rs_tab_local_device_list tr").length>0&&$$("#rs_tab_local_device_list tr")[0].fireEvent("click")):($("rs_tab_local_mode").style.display="none",remarkDisplay("rs_tab_local_remark",tl("sto.NoStorage"),3e3,2),$("rs_tab_local_device_list").innerHTML="")}).fail(function(){$("rs_tab_local_mode").style.display="none",remarkDisplay("rs_tab_local_remark",tl("sto.NoStorage"),3e3,2),$("rs_tab_local_device_list").innerHTML="",jQuery("#rs_tab_local_encrypt").parent().addClass("fn-hide")})},bind:function(){$("rs_tab_local_read_only").addEvent("click",o._onReadOnlyClick),$("rs_tab_local_read_write").addEvent("click",o._onReadWriteClick),$("rs_tab_local_hot_swap").addEvent("click",o._onHotSwapClick),$("rs_tab_local_refresh").addEvent("click",o._onRreshClick),$("rs_tab_local_format").addEvent("click",o._onFormatClick),$("rs_tab_local_encrypt").addEvent("click",o._onSDEncrypt),$("rs_tab_local_decrypt").addEvent("click",o._onSDDecrypt),$("rs_tab_local_modify_password").addEvent("click",o._onSDModifyPsw),$("rs_tab_local_clear_password").addEvent("click",o._onSDForceClear)},_showDeviceList:function(a){$("rs_tab_local_device_list").innerHTML="";var b='<table cellpadding="0" cellspacing="0" >';i.length||($("rs_tab_local_mode").style.display="none"),i.each(function(c,d){if("Initializing"===c.State)remarkDisplay("rs_tab_local_remark",tl("com.LoadingSDTip"),6e3,2),o.render.delay(6e3,this,a);else{var e="";if(c.HealthDataFlag)if(k=!0,2===c.HealthDataFlag)e='<div class="ui-autobox fn-height20">'+tl("com.Unknow")+"</div>";else{var f="";f=c.LifePercent<=30?"Excellent":c.LifePercent<=50?"Good":c.LifePercent<=80?"Soso":"Bad",e='<div class="ui-autobox fn-height20"><div class="ui-autobox-content"><div class="recordstorage-progress" title='+tl("health"+f)+">",e+='<p class="fn-height15 progress-'+f+'" style="width:'+(100-c.LifePercent)+'%;"></p>',e+="</div></div></div>"}var g=!1;c.hasOwnProperty("LockState")&&1===c.SDEncryptFlag?g=!0:$("rs_tab_local_mode").style.display="none",(c.Detail||[]).each(function(a,f){if(null!==a){var h=100*(a.UsedBytes/a.TotalBytes).round(2),i="width:"+h+"%;";b+='<tr id="rs_tab_local_device_'+d+"_"+f+'" class="trClass">',b+='<td class="fn-widp10">'+tl("sys.LocalDisk")+(d+1)+"</td>",b+='<td class="fn-widp10">'+tl(a.IsError?"com.DiskError":"com.Generals")+"</td>",b+='<td class="fn-widp10">'+tl(a.Type)+"</td>",g&&(b+='<td class="fn-widp10">'+tl(n[c.LockState])+"</td>"),b+="<td>",b+='<div class="ui-autobox fn-height20"><div class="ui-autobox-content"><div class="recordstorage-progress">',b+='<p class="recordstorage-progress-used" style="'+i+'"></p>',b+='</div><div class="fn-left fn-minwid150 fn-textleft">'+(a.UsedBytes/1048576).round(1)+"M/"+(a.TotalBytes/1048576).round(1)+"M",b+="</div></div></div></td>",b+='<td class="health fn-widp20">'+e+"</td>",b+="</tr>"}})}}),b+="</table>",$("rs_tab_local_device_list").innerHTML=b,$$("#rs_tab_local_device_list tr").removeClass("ui-table-tr-current"),$$("#rs_tab_local_device_list tr:first-child").addClass("ui-table-tr-current"),k?$$("#rs_tab_local .health").removeClass("fn-hide"):$$("#rs_tab_local .health").addClass("fn-hide")},_addDeviceListEventLister:function(){$$("#rs_tab_local_device_list tr").addEvent("click",function(){j=this.id.replace(/[^\d]*/,"").split("_"),$$("#rs_tab_local_device_list tr").removeClass("ui-table-tr-current"),this.addClass("ui-table-tr-current"),1===i[j[0]].SDEncryptFlag?jQuery("#rs_tab_local_encrypt").parent().removeClass("fn-hide"):jQuery("#rs_tab_local_encrypt").parent().addClass("fn-hide"),i[j[0]].CantHotPlug===!0?$("rs_tab_local_hot_swap").addClass("ui-button-disabled"):$("rs_tab_local_hot_swap").removeClass("ui-button-disabled"),0===i[j[0]].LockState?($("rs_tab_local_read_only").removeClass("ui-button-disabled"),$("rs_tab_local_read_write").removeClass("ui-button-disabled"),$("rs_tab_local_format").removeClass("ui-button-disabled"),$("rs_tab_local_encrypt").removeClass("ui-button-disabled"),$("rs_tab_local_decrypt").addClass("ui-button-disabled"),$("rs_tab_local_modify_password").addClass("ui-button-disabled"),$("rs_tab_local_clear_password").addClass("ui-button-disabled")):2===i[j[0]].LockState?($("rs_tab_local_read_only").removeClass("ui-button-disabled"),$("rs_tab_local_read_write").removeClass("ui-button-disabled"),$("rs_tab_local_format").removeClass("ui-button-disabled"),$("rs_tab_local_encrypt").addClass("ui-button-disabled"),$("rs_tab_local_decrypt").addClass("ui-button-disabled"),$("rs_tab_local_modify_password").removeClass("ui-button-disabled"),$("rs_tab_local_clear_password").removeClass("ui-button-disabled")):1===i[j[0]].LockState&&($("rs_tab_local_read_only").addClass("ui-button-disabled"),$("rs_tab_local_read_write").addClass("ui-button-disabled"),$("rs_tab_local_format").addClass("ui-button-disabled"),$("rs_tab_local_encrypt").addClass("ui-button-disabled"),$("rs_tab_local_decrypt").removeClass("ui-button-disabled"),$("rs_tab_local_modify_password").removeClass("ui-button-disabled"),$("rs_tab_local_clear_password").removeClass("ui-button-disabled"))})},_onRreshClick:function(){o.render(!0)},_onReadOnlyClick:function(){this.hasClass("ui-button-disabled")||o._setType("ReadOnly")},_onReadWriteClick:function(){this.hasClass("ui-button-disabled")||o._setType("ReadWrite")},_setType:function(b){if(-1===j[0]||-1===j[1])return void remarkDisplay("rs_tab_local_remark",tl("com.PleaseSelectTip"),3e3,2);if(webApp.IsNewProtocol)a.WorkDirectory.setGroup(i[j[0]].Detail[j[1]].Path,b).done(function(){remarkDisplay("rs_tab_local_remark",tl("com.OperateSuccessTip"),3e3,0)}).fail(function(){remarkDisplay("rs_tab_local_remark",tl("com.OperateFailTip"),3e3,1)}).always(function(){o.render()});else{var c;if(c=i[j[0]].Detail[j[1]].Pointer,0===c)return void remarkDisplay("rs_tab_local_remark",tl("com.OperateFailTip"),3e3,1);a.WorkDirectory.setType(c,b).done(function(){remarkDisplay("rs_tab_local_remark",tl("com.OperateSuccessTip"),3e3,0)}).fail(function(){remarkDisplay("rs_tab_local_remark",tl("com.OperateFailTip"),3e3,1)}).always(function(){o.render()})}},_onHotSwapClick:function(){return this.hasClass("ui-button-disabled")?void 0:-1===j[0]||-1===j[1]?void remarkDisplay("rs_tab_local_remark",tl("com.PleaseSelectTip"),3e3,2):void a.DevStorage.eject(i[j[0]].Name).done(function(){remarkDisplay("rs_tab_local_remark",tl("com.OperateSuccessTip"),3e3,0),jQuery("#rs_tab_local_encrypt").parent().addClass("fn-hide")}).fail(function(){remarkDisplay("rs_tab_local_remark",tl("com.OperateFailTip"),3e3,1)}).always(function(){o.render()})},_onFormatClick:function(){return this.hasClass("ui-button-disabled")?void 0:-1===j[0]||-1===j[1]?void remarkDisplay("rs_tab_local_remark",tl("com.PleaseSelectTip"),3e3,2):void o.formatDialog.show()},_onSDEncrypt:function(){this.hasClass("ui-button-disabled")||(e.find("input").val(""),e.find(".u-input-error").hide(),e.dialog("show"))},_onSDDecrypt:function(){this.hasClass("ui-button-disabled")||(f.find("input").val(""),f.find(".u-input-error").hide(),f.dialog("show"))},_onSDModifyPsw:function(){this.hasClass("ui-button-disabled")||(g.find("input").val(""),g.find(".u-input-error").hide(),g.dialog("show"))},_onSDForceClear:function(){this.hasClass("ui-button-disabled")||(h.find("input").val(""),h.find(".u-input-error").hide(),h.dialog("show"))},_formatSDCard:function(){if(!this.hasClass("ui-button-disabled"))if(o.formatDialog.close(),webApp.IsNewProtocol)a.DevStorage.getDeviceInfo(i[j[0]].Name).done(function(b){var c="";a.Integration.formatPatition(i[j[0]].Name,i[j[0]].Name,b.Partitions[j[1]].FileSystem).done(function(){remarkDisplay("rs_tab_local_remark",tl("com.OperateSuccessTip"),3e3,0),c="com.FormatSDRestartDevice"}).fail(function(){remarkDisplay("rs_tab_local_remark",tl("com.OperateFailTip"),3e3,1),c="com.NeedRebootTip"}).always(function(){!isEnable("is_noNeed_reboot")&&l&&webApp.reboot(c),o.render()})});else{var b=i[j[0]].Pointer;if(0===b)return void remarkDisplay("rs_tab_local_remark",tl("com.OperateFailTip"),3e3,1);a.Integration.formatPatitionOld(b,j[1]-0).done(function(){remarkDisplay("rs_tab_local_remark",tl("com.OperateSuccessTip"),3e3,0),l&&webApp.reboot("com.FormatSDRestartDevice")}).fail(function(){remarkDisplay("rs_tab_local_remark",tl("com.OperateFailTip"),3e3,1),l&&webApp.reboot("com.NeedRebootTip")}).always(function(){o.render()})}},checkPwdStrength:function(a,b){var c=b.children("li");if(c.removeClass("current"),a){var d=common.newPwdStrenthValidator(a),e=b.find("."+d);e.addClass("current"),b.prop("class","ui-pwd-strength "+d)}else b.prop("class","ui-pwd-strength")}}}(),function(){var b,c,d,e,f=["%00","1","10.61.2.129",tl("itc.SouthToNorth"),"2","50","180",tl("itc.RunRedLight"),"1",tl("EUP5689"),tl("ivs.SmallCarColor"),tl("Light-duty"),tl("com.Yellow"),"3","2","10.61.2.128",tl("com.BlueColor"),"19_45_29_59","1547aref",tl("com.Road"),tl("com.Companys"),tl("ivs.Panorama"),"PZC2AW01800060","1","3","30S",tl("itc.TurnLeft")],g=["2013","01","06","15","27","30","110"],h=!1,i=Page.recordStorageConfig.Tab.ftp={init:function(){i.translate(),i.bind(),webApp.IsLocalStore||($("rs_tab_ftp_emergency_wrap").style.display="none"),a.Storage.getCaps().done(function(a){a&&a.RemoteStoreList&&-1!==a.RemoteStoreList.indexOf("SFTP")?(webCaps.SupportSftp=!0,$("rs_tab_ftp_type").style.display=""):webCaps.SupportSftp=!1})},translate:function(){},render:function(){a.FtpTest.getCaps().done(function(a){a.Support&&$("FTP_test").getParent().removeClass("fn-hide")}),$("rs_tab_ftp_username_tip").setProperty("text",""),$("rs_tab_ftp_password_tip").setProperty("text",""),$("rs_tab_ftp_directory_tip").setProperty("text",""),$("rs_tab_ftp_address_tip").setProperty("text",""),i._getConfigAndRenderElements()},bind:function(){$("rs_tab_ftp_enable").addEvent("click",i._onEnableClick),$("rs_tab_ftp_default").addEvent("click",i._onDefaultClick),$("rs_tab_ftp_refresh").addEvent("click",i._onRefreshClick),$("rs_tab_ftp_confirm").addEvent("click",i._onConfirmClick),$("FTP_test").addEvent("click",i.onTest),attachLimit("rs_tab_ftp_port",0,65535),$("rs_tab_ftp_directory").addEvents({keyup:function(){promptImportLimt("rs_tab_ftp_directory","rs_tab_ftp_directory_tip","com.PathErrorTip",10)},blur:function(){promptImportLimt("rs_tab_ftp_directory","rs_tab_ftp_directory_tip","com.PathErrorTip",10)}}),$$("#rs_tab_ftp_username, #rs_tab_ftp_password").addEvents({keyup:function(){promptImportLimt(this.id,this.id+"_tip","com.NoInputMarksTip",3),this.value.lengthB()>32&&(this.value=this.value.substrB(32))},blur:function(){promptImportLimt(this.id,this.id+"_tip","com.NoInputMarksTip",3)}}),$("rs_tab_ftp_address").addEvents({keyup:function(){promptImportLimt("rs_tab_ftp_address","rs_tab_ftp_address_tip","com.EmailiperrorTip",11)},blur:function(){promptImportLimt("rs_tab_ftp_address","rs_tab_ftp_address_tip","com.EmailiperrorTip",11)}}),$("rs_tab_ftp_type").addEvent("change",function(){"FTP"===this.value?(e.Enable=$("rs_tab_ftp_enable").checked,e.Port=$("rs_tab_ftp_port").value-0,e.UserName=$("rs_tab_ftp_username").value,e.Password=$("rs_tab_ftp_password").value,e.Directory=$("rs_tab_ftp_directory").value,e.Address=$("rs_tab_ftp_address").value,e.CharacterEncoding=$("rc_ftp_charset").value,i._renderElements(c,d)):"SFTP"===this.value&&(c.Enable=$("rs_tab_ftp_enable").checked,c.Port=$("rs_tab_ftp_port").value-0,c.UserName=$("rs_tab_ftp_username").value,c.Password=$("rs_tab_ftp_password").value,c.Directory=$("rs_tab_ftp_directory").value,c.Address=$("rs_tab_ftp_address").value,c.CharacterEncoding=$("rc_ftp_charset").value,i._renderElements(e,d))}),$("rs_tab_ftp_enable").addEvent("change",function(){this.checked&&webCaps.SupportSftp&&("FTP"===$("rs_tab_ftp_type").value?e.Enable=!1:c.Enable=!1)}),$("mFtp_tab_ftp_name_reset").addEvent("click",function(){i._onFtpNameDefault("pic")}),$("mFtp_tab_ftp_davname_reset").addEvent("click",function(){i._onFtpNameDefault("dav")}),$("mFtp_tab_ftp_name_help").addEvent("click",i._onFtpNameHelp),$("mFtp_tab_ftp_davname_help").addEvent("click",i._onFtpNameHelp),$("mFtp_tab_ftp_name_content").addEvents({keyup:function(){this.value.test(/[\"*:<>?|\\]+/)&&(this.value=this.value.replace(/[\"*:<>?|\\]+/,"")),this.value.length>300&&(this.value=this.value.slice(0,300)),i._ftpNameFormatPreview("pic")},blur:function(){""===this.value&&(this.value=TrafficG.NamingFormat.Format),this.value.length>300&&(this.value=this.value.slice(0,300)),i._ftpNameFormatPreview("pic")}}),$("mFtp_tab_ftp_davname_content").addEvents({keyup:function(){this.value.test(/[\"*:<>?|\\]+/)&&(this.value=this.value.replace(/[\"*:<>?|\\]+/,"")),this.value.length>300&&(this.value=this.value.slice(0,300)),i._ftpNameFormatPreview("dav")},blur:function(){""===this.value&&(this.value=TrafficG.VideoNamingFormat.Format),this.value.length>300&&(this.value=this.value.slice(0,300)),i._ftpNameFormatPreview("dav")}})},trafficSet:function(){i.dialogNameHelp=new Dialog("store_ftp_J_PictureHelp",function(){i._offFtpNameHelp()},"storeFtpDialogConfirm","storeFtpDialogClose",tl("com.NameHelp")),i.dialogNameHelp.setPosition(680,0);var a=".ui-dialog-content {padding: 10px 20px;}#store_ftp_J_PictureHelp li{border: none;display: inline-block;line-height: 20px;height: 26px;width: 48%;padding: 0;margin: 0;font-weight: 400;}#store_ftp_J_PictureHelp ul li span {display: inline-block;min-width: 25px;height: 20px;padding: 3px 10px;}";jQuery("head").append("<style>"+a+"</style>"),$("TrafficFtp").removeClass("fn-hide"),$("rc_ftp_charset_wrap").removeClass("fn-hide")},_ftpNameFormatPreview:function(a){var b="";b="pic"==a?$("mFtp_tab_ftp_name_content").value:$("mFtp_tab_ftp_davname_content").value;for(var c="",d="",e=b.length,g=0;e>g;g++)if(e>g+2&&"%"==b.charAt(g)&&/[0-9]/g.test(b.charAt(g+1))&&/[0-9]/g.test(b.charAt(g+2)))0!==b.charAt(g+1)&&(d+=b.charAt(g+1)),d+=b.charAt(g+2),d-=0,27>d&&d>0?c+=f[d]:(c+=b.charAt(g),c+=b.charAt(g+1),c+=b.charAt(g+2)),d="",g+=2;else if(e>g+1&&"%"==b.charAt(g)&&/[a-zA-Z]/g.test(b.charAt(g+1))){var h=i._timedatavalue(b.charAt(g+1));h?c+=h:"c"==b.charAt(g+1)?c+="1":(c+=b.charAt(g),c+=b.charAt(g+1)),g++}else e>g+1&&"%"==b.charAt(g)&&"%"==b.charAt(g+1)?(c+=b.charAt(g),g++):c+=b.charAt(g);"pic"==a?$("mFtp_tab_ftp_name_content1").value=c:$("mFtp_tab_ftp_davname_content1").value=c},_onFtpNameHelp:function(){i.dialogNameHelp.show()},_offFtpNameHelp:function(){i.dialogNameHelp.close()},_onFtpNameDefault:function(b){a.ConfigManager.getDefault("TrafficGlobal").done(function(a){a?("pic"==b?TrafficG.NamingFormat=a.NamingFormat:TrafficG.VideoNamingFormat=a.VideoNamingFormat,i._renderTraffic()):remarkDisplay("rs_tab_ftp_remark",tl("com.OperateFailTip"),3e3,1)
})},_timedatavalue:function(a){var b=0;switch(a){case"y":b=g[0];break;case"M":b=g[1];break;case"d":b=g[2];break;case"h":b=g[3];break;case"m":b=g[4];break;case"s":b=g[5];break;case"S":b=g[6]}return b},_checkFtpName:function(){var a=TrafficG.NamingFormat.Format.length,b=TrafficG.NamingFormat.Format;if("."!=b.charAt(a-4)||"j"!=b.charAt(a-3)||"p"!=b.charAt(a-2)||"g"!=b.charAt(a-1))return alert(tl("com.PictureNamedJpgTip")),remarkDisplay("rs_tab_ftp_remark",tl("com.SaveConfigFailTip"),3e3,1),!0;var c=TrafficG.VideoNamingFormat.Format,d=c.length,e="."==c.charAt(d-4)&&"d"==c.charAt(d-3)&&"a"==c.charAt(d-2)&&"v"==c.charAt(d-1),f="."==c.charAt(d-4)&&"a"==c.charAt(d-3)&&"v"==c.charAt(d-2)&&"i"==c.charAt(d-1);return e||f?!1:(alert(tl("com.VideoNamedDavTip")),remarkDisplay("rs_tab_ftp_remark",tl("com.SaveConfigFailTip"),3e3,1),!0)},_renderTraffic:function(){$("mFtp_tab_ftp_name_content").value=TrafficG.NamingFormat.Format,$("mFtp_tab_ftp_davname_content").value=TrafficG.VideoNamingFormat.Format,i._ftpNameFormatPreview("pic"),i._ftpNameFormatPreview("dav")},_renderElements:function(a,b){var c;c=b?b:Page.recordStorageConfig.Tab.path.getRecordStoragePoint(),c.TimingRecord.FTP||c.VideoDetectRecord.FTP||c.AlarmRecord.FTP||c.TimingSnapShot.FTP||c.VideoDetectSnapShot.FTP||c.AlarmSnapShot.FTP?($("rs_tab_ftp_enable").disabled=!1,$("rs_tab_ftp_emergency").disabled=!1,$("rs_tab_ftp_sync").disabled=!1):(a.Enable=!1,$("rs_tab_ftp_enable").disabled=!0,$("rs_tab_ftp_emergency").checked=!1,$("rs_tab_ftp_emergency").disabled=!0,$("rs_tab_ftp_sync").checked=!1,$("rs_tab_ftp_sync").disabled=!0),$("rs_tab_ftp_enable").checked=a.Enable,$("rs_tab_ftp_port").value=a.Port,$("rs_tab_ftp_username").value=a.UserName,$("rs_tab_ftp_password").value=a.Password,$("rs_tab_ftp_directory").value=a.Directory,$("rc_ftp_charset").value=a.CharacterEncoding,$("rs_tab_ftp_emergency").checked=c.TimingRecord.LocalForEmergency||c.VideoDetectRecord.LocalForEmergency||c.AlarmRecord.LocalForEmergency||c.TimingSnapShot.LocalForEmergency||c.VideoDetectSnapShot.LocalForEmergency||c.AlarmSnapShot.LocalForEmergency,i._onEnableClick(),$("rs_tab_ftp_address").value=a.Address,$$("#rs_tab_ftp .ui-tip-red").set("text","")},_onEnableClick:function(){$("rs_tab_ftp_enable").checked?$("rs_tab_ftp_emergency").disabled=!1:($("rs_tab_ftp_emergency").disabled=!0,$("rs_tab_ftp_emergency").checked=!1)},onTest:function(){var b="FTP1";webCaps.SupportSftp&&"SFTP"===$("rs_tab_ftp_type").value&&(b="SFTP1");var c="FTP1"===b?{NoListAuth:"FTPNoListAuth",NoDeleteFileAuth:"FTPNoDeleteFileAuth",NoDeleteDirAuth:"FTPNoDeleteDirAuth",ReadWrite:"com.FTPReadWriteTip",ReadOnly:"FTPReadOnly",NotAcess:"com.FTPNotAcessTip",LoginFailure:"FTPLoginFailure"}:{NoListAuth:"sto.SFTPNoListAuth",NoDeleteFileAuth:"sto.SFTPNoDeleteFileAuth",NoDeleteDirAuth:"sto.SFTPNoDeleteDirAuth",ReadWrite:"sto.SFTPReadWrite",ReadOnly:"sto.SFTPReadOnly",NotAcess:"com.FTPNotAcessTip",LoginFailure:"FTPLoginFailure"};a.FtpTest.checkAuthority(b).done(function(a){var b=a.params.access,d=a.params.authority,e=a.params.list,f=a.params.deleteFile,g=a.params.deleteDir;0===b?"ReadWrite"===d?0===e?remarkDisplay("rs_tab_ftp_remark",tl(c.NoListAuth),3e3,1):0===f?remarkDisplay("rs_tab_ftp_remark",tl(c.NoDeleteFileAuth),3e3,1):0===g?remarkDisplay("rs_tab_ftp_remark",tl(c.NoDeleteDirAuth),3e3,1):remarkDisplay("rs_tab_ftp_remark",tl(c.ReadWrite),3e3,0):"ReadOnly"===d&&remarkDisplay("rs_tab_ftp_remark",tl(c.ReadOnly),3e3,1):1===b?remarkDisplay("rs_tab_ftp_remark",tl(c.NotAcess),3e3,1):2===b&&remarkDisplay("rs_tab_ftp_remark",tl(c.LoginFailure),3e3,1)}).fail(function(){remarkDisplay("rs_tab_ftp_remark",tl("com.OperateFailTip"),3e3,1)})},_onDefaultClick:function(){$("rs_tab_ftp_username_tip").setProperty("text",""),$("rs_tab_ftp_password_tip").setProperty("text",""),$("rs_tab_ftp_directory_tip").setProperty("text",""),$("rs_tab_ftp_address_tip").setProperty("text",""),a.ConfigManager.getDefault("NAS").done(function(c){b=c,b.each(function(a){"FTP"===a.Protocol&&(ftp=a)}),webCaps.SupportSftp&&"SFTP"===$("rs_tab_ftp_type").value?a.ConfigManager.getDefault("SFTP").done(function(a){e=a[0],i._renderElements(e,d),remarkDisplay("rs_tab_ftp_remark",tl("com.DefaultSuccessTip"),3e3,0)}):(i._renderElements(ftp,d),remarkDisplay("rs_tab_ftp_remark",tl("com.DefaultSuccessTip"),3e3,0))}).fail(function(){remarkDisplay("rs_tab_ftp_remark",tl("com.DefaultfailureTip"),3e3,1)})},_onRefreshClick:function(){$("rs_tab_ftp_username_tip").setProperty("text",""),$("rs_tab_ftp_password_tip").setProperty("text",""),$("rs_tab_ftp_directory_tip").setProperty("text",""),$("rs_tab_ftp_address_tip").setProperty("text",""),i._getConfigAndRenderElements(!0)},_onConfirmClick:function(){jQuery.throttle(this,200,i.handleConfirmClick)},handleConfirmClick:function(){function f(){g.TimingRecord.AutoSync=$("rs_tab_ftp_sync").checked,g.TimingRecord.LocalForEmergency=g.TimingRecord.FTP&&j,g.VideoDetectRecord.LocalForEmergency=g.VideoDetectRecord.FTP&&j,g.AlarmRecord.LocalForEmergency=g.AlarmRecord.FTP&&j,g.TimingSnapShot.LocalForEmergency=g.TimingSnapShot.FTP&&j,g.VideoDetectSnapShot.LocalForEmergency=g.VideoDetectSnapShot.FTP&&j,g.AlarmSnapShot.LocalForEmergency=g.AlarmSnapShot.FTP&&j,g.ManualRecord.LocalForEmergency=g.TimingRecord.LocalForEmergency||g.VideoDetectRecord.LocalForEmergency||g.AlarmRecord.LocalForEmergency,g.EventRecord.LocalForEmergency=g.ManualRecord.LocalForEmergency,g.ManualSnapShot.LocalForEmergency=g.TimingSnapShot.LocalForEmergency||g.VideoDetectSnapShot.LocalForEmergency||g.AlarmSnapShot.LocalForEmergency,g.EventSnapShot.LocalForEmergency=g.ManualSnapShot.LocalForEmergency,a.ConfigManager.setConfig("RecordStoragePoint",[g,g]).done(function(){a.ConfigManager.setConfig("NAS",b).done(function(){if(h){if(TrafficG.NamingFormat&&(TrafficG.NamingFormat.Format=$("mFtp_tab_ftp_name_content").value),TrafficG.VideoNamingFormat&&(TrafficG.VideoNamingFormat.Format=$("mFtp_tab_ftp_davname_content").value),i._checkFtpName())return;a.ConfigManager.setConfig("TrafficGlobal",TrafficG).done(function(){remarkDisplay("rs_tab_ftp_remark",tl("com.SaveSuccessTip"),3e3,0)})}else remarkDisplay("rs_tab_ftp_remark",tl("com.SaveSuccessTip"),3e3,0);webCaps.SupportSftp&&a.ConfigManager.setConfig("SFTP",[e]).done(function(){remarkDisplay("rs_tab_ftp_remark",tl("com.SaveSuccessTip"),3e3,0)}).fail(function(){remarkDisplay("rs_tab_ftp_remark",tl("com.SaveConfigFailTip"),3e3,1)})}).fail(function(){remarkDisplay("rs_tab_ftp_remark",tl("com.SaveConfigFailTip"),3e3,1)})}).fail(function(){remarkDisplay("rs_tab_ftp_remark",tl("com.SaveConfigFailTip"),3e3,1)})}var g=d,j=$("rs_tab_ftp_emergency").checked;i._validateBeforSubmit()&&(webCaps.SupportSftp&&"SFTP"===$("rs_tab_ftp_type").value?(e.Enable=$("rs_tab_ftp_enable").checked,e.Port=$("rs_tab_ftp_port").value-0,e.UserName=$("rs_tab_ftp_username").value,e.Password=$("rs_tab_ftp_password").value,e.Directory=$("rs_tab_ftp_directory").value,e.Address=$("rs_tab_ftp_address").value,e.CharacterEncoding=$("rc_ftp_charset").value):(c.Enable=$("rs_tab_ftp_enable").checked,c.Port=$("rs_tab_ftp_port").value-0,c.UserName=$("rs_tab_ftp_username").value,c.Password=$("rs_tab_ftp_password").value,c.Directory=$("rs_tab_ftp_directory").value,c.Address=$("rs_tab_ftp_address").value,c.CharacterEncoding=$("rc_ftp_charset").value),webCaps.SupportSftp&&c.Enable?jQuery.confirm(tl("com.Prompt"),tl("sto.FTPRiskTip"),function(){f()},function(){return!1},!1):f())},_getConfigAndRenderElements:function(f){a.ConfigManager.getConfig("RecordStoragePoint").done(function(g){d=g[0],a.ConfigManager.getConfig("NAS").done(function(g){b=g,c=b.filter(function(a){return"FTP"===a.Protocol})[0],webCaps.SupportSftp?a.ConfigManager.getConfig("SFTP").done(function(a){e=a[0],e.Enable?$("rs_tab_ftp_type").value="SFTP":c.Enable&&($("rs_tab_ftp_type").value="FTP"),"SFTP"===$("rs_tab_ftp_type").value?($("rs_tab_ftp_type").value="SFTP",i._renderElements(e,d)):(i._renderElements(c,d),$("rs_tab_ftp_type").value="FTP"),f&&remarkDisplay("rs_tab_ftp_remark",tl("com.OperateSuccessTip"),3e3,0)}):(i._renderElements(c,d),f&&remarkDisplay("rs_tab_ftp_remark",tl("com.OperateSuccessTip"),3e3,0))})}).fail(function(){remarkDisplay("rs_tab_ftp_remark",tl("com.OperateFailTip"),3e3,1)}),webApp.IsSDTraficIntel&&a.ConfigManager.getConfig("VideoAnalyseGlobal").done(function(b){b&&b[0]&&b[0].Scene&&"Traffic"===b[0].Scene.Type&&(h=!0,i.trafficSet(),a.ConfigManager.getConfig("TrafficGlobal").done(function(a){a&&(TrafficG=a),TrafficG?(TrafficG.NamingFormat||(TrafficG.NamingFormat={Format:tl("com.SettingGetErrorTip")+"/%c/%07/%y/%M/%d/%h/%04-%y%M%d%h%m%s%S-%07-%18-(%14).jpg"}),TrafficG.VideoNamingFormat||(TrafficG.VideoNamingFormat={Format:tl("com.SettingGetErrorTip")+"/%c/%07/%y/%M/%d/%h/%04-%y%M%d%h%m%s%S-%07-%18-(%14).dav"})):TrafficG={NamingFormat:{Format:tl("com.SettingGetErrorTip")+"/%c/%07/%y/%M/%d/%h/%04-%y%M%d%h%m%s%S-%07-%18-(%14).jpg"},VideoNamingFormat:{Format:tl("com.SettingGetErrorTip")+"/%c/%07/%y/%M/%d/%h/%04-%y%M%d%h%m%s%S-%07-%18-(%14).dav"}},i._renderTraffic()}))})},_validateBeforSubmit:function(){if(!checkedImportLimt("rs_tab_ftp_username",3))return remarkDisplay("rs_tab_ftp_remark",tl("com.NoInputMarksTip"),3e3,1),!1;if(!checkedImportLimt("rs_tab_ftp_password",3))return remarkDisplay("rs_tab_ftp_remark",tl("com.NoInputMarksTip"),3e3,1),!1;if(!checkedImportLimt("rs_tab_ftp_directory",10)){if(""!==$("rs_tab_ftp_directory").value)return remarkDisplay("rs_tab_ftp_remark",tl("com.PathErrorTip"),3e3,1),!1;$("rs_tab_ftp_directory_tip").setProperty("text","")}return $("rs_tab_ftp_address").value.length>0&&!checkedImportLimt("rs_tab_ftp_address",11)?(remarkDisplay("rs_tab_ftp_remark",tl("com.EmailiperrorTip"),3e3,1),!1):!0}}}(),function(){var b,c,d,e,f=null,g=null,h=["%00","1","10.61.2.129",tl("itc.SouthToNorth"),"2","50","180",tl("itc.RunRedLight"),"1",tl("EUP5689"),tl("ivs.SmallCarColor"),tl("Light-duty"),tl("com.Yellow"),"3","2","10.61.2.128",tl("com.BlueColor"),"19_45_29_59","1547aref",tl("com.Road"),tl("com.Companys"),tl("ivs.Panorama"),"PZC2AW01800060","1","3","30S",tl("itc.TurnLeft")],i=["2013","01","06","15","27","30","110"],j=!1,k=Page.recordStorageConfig.Tab.newftp={init:function(){k.translate(),k.bind(),webApp.IsLocalStore||($("rs_tab_newftp_emergency_wrap").style.display="none"),a.Storage.getCaps().done(function(a){a&&a.RemoteStoreList&&-1!==a.RemoteStoreList.indexOf("SFTP")?(webCaps.SupportSftp=!0,$("rs_tab_newftp_type").style.display=""):webCaps.SupportSftp=!1})},translate:function(){},render:function(){a.FtpTest.getCaps().done(function(a){a.Support&&$("newFTP_test").getParent().removeClass("fn-hide")}),$("rs_tab_newftp_username_tip").setProperty("text",""),$("rs_tab_newftp_password_tip").setProperty("text",""),$("rs_tab_newftp_directory_tip").setProperty("text",""),$("rs_tab_newftp_address_tip").setProperty("text",""),k._getConfigAndRenderElements()},bind:function(){$("rs_tab_newftp_enable").addEvent("click",k._onEnableClick),$("rs_tab_newftp_default").addEvent("click",k._onDefaultClick),$("rs_tab_newftp_refresh").addEvent("click",k._onRefreshClick),$("rs_tab_newftp_confirm").addEvent("click",k._onConfirmClick),$("newFTP_test").addEvent("click",k.onTest),attachLimit("rs_tab_newftp_port",0,65535),$("rs_tab_newftp_username").addEvents({keyup:function(){var a=StringUtil.byteLength(this.value,"aaa");a>32&&(this.value=StringUtil.btSub(this.value,32,"aaa"),this.isLengthOver=!0),this.isLengthOver=32==a?!0:!1},keydown:function(a){var b=StringUtil.byteLength(this.value,"aaa");if(this.isLengthOver=32==b?!0:!1,this.isLengthOver){var c=["backspace","delete","up","down","left","right","esc","$","#","f1","f2","f3","f4","f5","f6","f7","f8","f9","f10","f11","f12"];c.contains(a.key)||"c"===a.key&&a.control||a.alt||a.meta||a.shift&&a.control||a.stop()}}}),$("rs_tab_newftp_directory").addEvents({keyup:function(){promptImportLimt("rs_tab_newftp_directory","rs_tab_newftp_directory_tip","com.PathErrorTip",10)},blur:function(){promptImportLimt("rs_tab_newftp_directory","rs_tab_newftp_directory_tip","com.PathErrorTip",10)}}),$$("#rs_tab_newftp_username, #rs_tab_newftp_password").addEvents({keyup:function(){promptImportLimt(this.id,this.id+"_tip","com.NoInputMarksTip",3)},blur:function(){promptImportLimt(this.id,this.id+"_tip","com.NoInputMarksTip",3)}}),$("rs_tab_newftp_address").addEvents({keyup:function(){promptImportLimt("rs_tab_newftp_address","rs_tab_newftp_address_tip","com.EmailiperrorTip",11)},blur:function(){promptImportLimt("rs_tab_newftp_address","rs_tab_newftp_address_tip","com.EmailiperrorTip",11)}}),$("rs_tab_newftp_type").addEvent("change",function(){"FTP"===this.value?(e.Enable=$("rs_tab_newftp_enable").checked,e.Port=$("rs_tab_newftp_port").value-0,e.UserName=$("rs_tab_newftp_username").value,e.Password=$("rs_tab_newftp_password").value,e.Directory=$("rs_tab_newftp_directory").value,e.Address=$("rs_tab_newftp_address").value,e.CharacterEncoding=$("rc_newftp_charset").value,k._renderElements(c,d)):"SFTP"===this.value&&(c.Enable=$("rs_tab_newftp_enable").checked,c.Port=$("rs_tab_newftp_port").value-0,c.UserName=$("rs_tab_newftp_username").value,c.Password=$("rs_tab_newftp_password").value,c.Directory=$("rs_tab_newftp_directory").value,c.Address=$("rs_tab_newftp_address").value,c.CharacterEncoding=$("rc_newftp_charset").value,k._renderElements(e,d))}),$("rs_tab_newftp_enable").addEvent("change",function(){this.checked&&webCaps.SupportSftp&&("FTP"===$("rs_tab_newftp_type").value?e.Enable=!1:c.Enable=!1)}),k.bindTrafficPacking()},bindTrafficPacking:function(){$$("#mFtp_originalOSD_reset,#mFtp_mergeOSD_reset,#mFtp_video_reset").addEvent("click",function(){var a=this.id;k._onFtpNameDefault(a)}),$("mFtp_originalOSD_name_help").addEvent("click",k._onFtpNameHelp),$("mFtp_mergeOSD_name_help").addEvent("click",k._onFtpNameHelp),$("mFtp_video_davname_help").addEvent("click",k._onFtpNameHelp),$$("#mFtp_mergeOSD_content,#mFtp_originalOSD_content").addEvents({keyup:function(){this.value.test(/[\"*:<>?|\\]+/)&&(this.value=this.value.replace(/[\"*:<>?|\\]+/,"")),this.value.length>300&&(this.value=this.value.slice(0,300)),k._ftpNameFormatPreview(-1!=this.id.indexOf("mergeOSD")?"mergeOSD":"originalOSD")},blur:function(){""===this.value&&(this.value=g[0].NamingFormat.Format),this.value.length>300&&(this.value=this.value.slice(0,300)),k._ftpNameFormatPreview(-1!=this.id.indexOf("mergeOSD")?"mergeOSD":"originalOSD")}}),$("mFtp_video_content").addEvents({keyup:function(){this.value.test(/[\"*:<>?|\\]+/)&&(this.value=this.value.replace(/[\"*:<>?|\\]+/,"")),this.value.length>300&&(this.value=this.value.slice(0,300)),k._ftpNameFormatPreview("dav")},blur:function(){""===this.value&&(this.value=f[0].VideoNamingFormat.Format),this.value.length>300&&(this.value=this.value.slice(0,300)),k._ftpNameFormatPreview("dav")}})},trafficSet:function(){k.dialogNameHelp=new Dialog("store_ftp_J_PictureHelp",function(){k._offFtpNameHelp()},"storeFtpDialogConfirm","storeFtpDialogClose",tl("com.NameHelp")),k.dialogNameHelp.setPosition(680,0);var a=".ui-dialog-content {padding: 10px 20px;}#store_ftp_J_PictureHelp li{border: none;display: inline-block;line-height: 20px;height: 26px;width: 48%;padding: 0;margin: 0;font-weight: 400;}#store_ftp_J_PictureHelp ul li span {display: inline-block;min-width: 25px;height: 20px;padding: 3px 10px;}";jQuery("head").append("<style>"+a+"</style>"),$("TrafficNewFtp").removeClass("fn-hide"),$("rc_newftp_charset_wrap").removeClass("fn-hide")},_ftpNameFormatPreview:function(a){var b="";b="mergeOSD"==a?$("mFtp_mergeOSD_content").value:"originalOSD"==a?$("mFtp_originalOSD_content").value:$("mFtp_video_content").value;for(var c="",d="",e=b.length,f=0;e>f;f++)if(e>f+2&&"%"==b.charAt(f)&&/[0-9]/g.test(b.charAt(f+1))&&/[0-9]/g.test(b.charAt(f+2)))0!==b.charAt(f+1)&&(d+=b.charAt(f+1)),d+=b.charAt(f+2),d-=0,27>d&&d>0?c+=h[~~d]:(c+=b.charAt(f),c+=b.charAt(f+1),c+=b.charAt(f+2)),d="",f+=2;else if(e>f+1&&"%"==b.charAt(f)&&/[a-zA-Z]/g.test(b.charAt(f+1))){var g=k._timedatavalue(b.charAt(f+1));g?c+=g:"c"==b.charAt(f+1)?c+="1":(c+=b.charAt(f),c+=b.charAt(f+1)),f++}else e>f+1&&"%"==b.charAt(f)&&"%"==b.charAt(f+1)?(c+=b.charAt(f),f++):c+=b.charAt(f);"mergeOSD"==a?$("mFtp_mergeOSD_content1").value=c:"originalOSD"==a?$("mFtp_originalOSD_content1").value=c:$("mFtp_video_content1").value=c},_onFtpNameHelp:function(){k.dialogNameHelp.show()},_offFtpNameHelp:function(){k.dialogNameHelp.close()},_onFtpNameDefault:function(b){a.ConfigManager.getDefault(["MultiSceneRecord","TrafficImage"]).done(function(a){a?(b.contains("originalOSD")&&(g[0].NamingFormat=a[1].params.table[0].NamingFormat,$("mFtp_originalOSD_content").value=g[0].NamingFormat.FormatEx,k._ftpNameFormatPreview("originalOSD")),b.contains("mergeOSD")&&(g[0].NamingFormat=a[1].params.table[0].NamingFormat,$("mFtp_mergeOSD_content").value=g[0].NamingFormat.Format,k._ftpNameFormatPreview("mergeOSD")),b.contains("video")&&(f[0].VideoNamingFormat=a[0].params.table[0].VideoNamingFormat,$("mFtp_video_content").value=f[0].VideoNamingFormat.Format,k._ftpNameFormatPreview("dav"))):remarkDisplay("rs_tab_newftp_remark",tl("com.OperateFailTip"),3e3,1)})},_timedatavalue:function(a){var b=0;switch(a){case"y":b=i[0];break;case"M":b=i[1];break;case"d":b=i[2];break;case"h":b=i[3];break;case"m":b=i[4];break;case"s":b=i[5];break;case"S":b=i[6]}return b},_checkFtpName:function(){var a=g[0].NamingFormat.Format.length,b=g[0].NamingFormat.Format;if("."!=b.charAt(a-4)||"j"!=b.charAt(a-3)||"p"!=b.charAt(a-2)||"g"!=b.charAt(a-1))return alert(tl("com.PictureNamedJpgTip")),remarkDisplay("rs_tab_newftp_remark",tl("com.SaveConfigFailTip"),3e3,1),!0;var c=f[0].VideoNamingFormat.Format,d=c.length,e="."==c.charAt(d-4)&&"d"==c.charAt(d-3)&&"a"==c.charAt(d-2)&&"v"==c.charAt(d-1),h="."==c.charAt(d-4)&&"a"==c.charAt(d-3)&&"v"==c.charAt(d-2)&&"i"==c.charAt(d-1),i="."==c.charAt(d-4)&&"m"==c.charAt(d-3)&&"p"==c.charAt(d-2)&&"4"==c.charAt(d-1);if(!(e||h||i)){var j=tl("com.VideoNamedDavTip").split(".avi")[1];return alert(tl("com.VideoNamedDavTip").split(".avi")[0].split(".dav")[0]+".dav/.avi/.mp4"+j),remarkDisplay("rs_tab_newftp_remark",tl("com.SaveConfigFailTip"),3e3,1),!0}return!1},_renderTraffic:function(){$("mFtp_mergeOSD_content").value=g[0].NamingFormat.Format,$("mFtp_originalOSD_content").value=g[0].NamingFormat.FormatEx,$("mFtp_video_content").value=f[0].VideoNamingFormat.Format,k._ftpNameFormatPreview("mergeOSD"),k._ftpNameFormatPreview("originalOSD"),k._ftpNameFormatPreview("dav")},_renderElements:function(a,b){var c;c=b?b:Page.recordStorageConfig.Tab.path.getRecordStoragePoint(),c.TimingRecord.FTP||c.VideoDetectRecord.FTP||c.AlarmRecord.FTP||c.TimingSnapShot.FTP||c.VideoDetectSnapShot.FTP||c.AlarmSnapShot.FTP?($("rs_tab_newftp_enable").disabled=!1,$("rs_tab_newftp_emergency").disabled=!1,$("rs_tab_newftp_sync").disabled=!1):(a.Enable=!1,$("rs_tab_newftp_enable").disabled=!0,$("rs_tab_newftp_emergency").checked=!1,$("rs_tab_newftp_emergency").disabled=!0,$("rs_tab_newftp_sync").checked=!1,$("rs_tab_newftp_sync").disabled=!0),$("rs_tab_newftp_enable").checked=a.Enable,$("rs_tab_newftp_port").value=a.Port,$("rs_tab_newftp_username").value=a.UserName,$("rs_tab_newftp_password").value=a.Password,$("rs_tab_newftp_directory").value=a.Directory,$("rc_newftp_charset").value=a.CharacterEncoding,$("rs_tab_newftp_emergency").checked=c.TimingRecord.LocalForEmergency||c.VideoDetectRecord.LocalForEmergency||c.AlarmRecord.LocalForEmergency||c.TimingSnapShot.LocalForEmergency||c.VideoDetectSnapShot.LocalForEmergency||c.AlarmSnapShot.LocalForEmergency,k._onEnableClick(),$("rs_tab_newftp_address").value=a.Address,$$("#rs_tab_newftp .ui-tip-red").set("text","")},_onEnableClick:function(){$("rs_tab_newftp_enable").checked?$("rs_tab_newftp_emergency").disabled=!1:($("rs_tab_newftp_emergency").disabled=!0,$("rs_tab_newftp_emergency").checked=!1)},onTest:function(){var b="FTP1";webCaps.SupportSftp&&"SFTP"===$("rs_tab_newftp_type").value&&(b="SFTP1");var c="FTP1"===b?{NoListAuth:"FTPNoListAuth",NoDeleteFileAuth:"FTPNoDeleteFileAuth",NoDeleteDirAuth:"FTPNoDeleteDirAuth",ReadWrite:"com.FTPReadWriteTip",ReadOnly:"FTPReadOnly",NotAcess:"com.FTPNotAcessTip",LoginFailure:"FTPLoginFailure"}:{NoListAuth:"sto.SFTPNoListAuth",NoDeleteFileAuth:"sto.SFTPNoDeleteFileAuth",NoDeleteDirAuth:"sto.SFTPNoDeleteDirAuth",ReadWrite:"sto.SFTPReadWrite",ReadOnly:"sto.SFTPReadOnly",NotAcess:"com.FTPNotAcessTip",LoginFailure:"FTPLoginFailure"};a.FtpTest.checkAuthority(b).done(function(a){var b=a.params.access,d=a.params.authority,e=a.params.list,f=a.params.deleteFile,g=a.params.deleteDir;0===b?"ReadWrite"===d?0===e?remarkDisplay("rs_tab_newftp_remark",tl(c.NoListAuth),3e3,1):0===f?remarkDisplay("rs_tab_newftp_remark",tl(c.NoDeleteFileAuth),3e3,1):0===g?remarkDisplay("rs_tab_newftp_remark",tl(c.NoDeleteDirAuth),3e3,1):remarkDisplay("rs_tab_newftp_remark",tl(c.ReadWrite),3e3,0):"ReadOnly"===d&&remarkDisplay("rs_tab_newftp_remark",tl(c.ReadOnly),3e3,1):1===b?remarkDisplay("rs_tab_newftp_remark",tl(c.NotAcess),3e3,1):2===b&&remarkDisplay("rs_tab_newftp_remark",tl(c.LoginFailure),3e3,1)}).fail(function(){remarkDisplay("rs_tab_newftp_remark",tl("com.OperateFailTip"),3e3,1)})},_onDefaultClick:function(){$("rs_tab_newftp_username_tip").setProperty("text",""),$("rs_tab_newftp_password_tip").setProperty("text",""),$("rs_tab_newftp_directory_tip").setProperty("text",""),$("rs_tab_newftp_address_tip").setProperty("text",""),a.ConfigManager.getDefault("NAS").done(function(b){nas=b,nas.each(function(a){"FTP"===a.Protocol&&(ftp=a)}),webCaps.SupportSftp&&"SFTP"===$("rs_tab_newftp_type").value?a.ConfigManager.getDefault("SFTP").done(function(a){e=a[0],k._renderElements(e,d),remarkDisplay("rs_tab_newftp_remark",tl("com.DefaultSuccessTip"),3e3,0)}):(k._renderElements(ftp,d),remarkDisplay("rs_tab_newftp_remark",tl("com.DefaultSuccessTip"),3e3,0))}).fail(function(){remarkDisplay("rs_tab_newftp_remark",tl("com.DefaultfailureTip"),3e3,1)})},_onRefreshClick:function(){$("rs_tab_newftp_username_tip").setProperty("text",""),$("rs_tab_newftp_password_tip").setProperty("text",""),$("rs_tab_newftp_directory_tip").setProperty("text",""),$("rs_tab_newftp_address_tip").setProperty("text",""),k._getConfigAndRenderElements(!0)},_onConfirmClick:function(){function h(){i.TimingRecord.AutoSync=$("rs_tab_newftp_sync").checked,i.TimingRecord.LocalForEmergency=i.TimingRecord.FTP&&l,i.VideoDetectRecord.LocalForEmergency=i.VideoDetectRecord.FTP&&l,i.AlarmRecord.LocalForEmergency=i.AlarmRecord.FTP&&l,i.TimingSnapShot.LocalForEmergency=i.TimingSnapShot.FTP&&l,i.VideoDetectSnapShot.LocalForEmergency=i.VideoDetectSnapShot.FTP&&l,i.AlarmSnapShot.LocalForEmergency=i.AlarmSnapShot.FTP&&l,i.ManualRecord.LocalForEmergency=i.TimingRecord.LocalForEmergency||i.VideoDetectRecord.LocalForEmergency||i.AlarmRecord.LocalForEmergency,i.EventRecord.LocalForEmergency=i.ManualRecord.LocalForEmergency,i.ManualSnapShot.LocalForEmergency=i.TimingSnapShot.LocalForEmergency||i.VideoDetectSnapShot.LocalForEmergency||i.AlarmSnapShot.LocalForEmergency,i.EventSnapShot.LocalForEmergency=i.ManualSnapShot.LocalForEmergency,a.ConfigManager.setConfig("RecordStoragePoint",[i,i]).done(function(){a.ConfigManager.setConfig("NAS",b).done(function(){if(j){if(g[0].NamingFormat&&(g[0].NamingFormat.Format=$("mFtp_mergeOSD_content").value,g[0].NamingFormat.FormatEx=$("mFtp_originalOSD_content").value),f[0].VideoNamingFormat&&(f[0].VideoNamingFormat.Format=$("mFtp_video_content").value),k._checkFtpName())return;a.ConfigManager.setConfig(["MultiSceneRecord","TrafficImage"],[f,g]).done(function(){remarkDisplay("rs_tab_newftp_remark",tl("com.SaveSuccessTip"),3e3,0)})}else remarkDisplay("rs_tab_newftp_remark",tl("com.SaveSuccessTip"),3e3,0);webCaps.SupportSftp&&a.ConfigManager.setConfig("SFTP",[e]).done(function(){remarkDisplay("rs_tab_newftp_remark",tl("com.SaveSuccessTip"),3e3,0)}).fail(function(){remarkDisplay("rs_tab_newftp_remark",tl("com.SaveConfigFailTip"),3e3,1)})}).fail(function(){remarkDisplay("rs_tab_newftp_remark",tl("com.SaveConfigFailTip"),3e3,1)})}).fail(function(){remarkDisplay("rs_tab_newftp_remark",tl("com.SaveConfigFailTip"),3e3,1)})}var i=d,l=$("rs_tab_newftp_emergency").checked;k._validateBeforSubmit()&&(webCaps.SupportSftp&&"SFTP"===$("rs_tab_newftp_type").value?(e.Enable=$("rs_tab_newftp_enable").checked,e.Port=$("rs_tab_newftp_port").value-0,e.UserName=$("rs_tab_newftp_username").value,e.Password=$("rs_tab_newftp_password").value,e.Directory=$("rs_tab_newftp_directory").value,e.Address=$("rs_tab_newftp_address").value,e.CharacterEncoding=$("rc_newftp_charset").value):(c.Enable=$("rs_tab_newftp_enable").checked,c.Port=$("rs_tab_newftp_port").value-0,c.UserName=$("rs_tab_newftp_username").value,c.Password=$("rs_tab_newftp_password").value,c.Directory=$("rs_tab_newftp_directory").value,c.Address=$("rs_tab_newftp_address").value,c.CharacterEncoding=$("rc_newftp_charset").value),webCaps.SupportSftp&&c.Enable?jQuery.confirm(tl("com.Info"),tl("sto.FTPRiskTip"),function(){h()},function(){return!1},!1):h())},_getConfigAndRenderElements:function(h){a.ConfigManager.getConfig("RecordStoragePoint").done(function(f){d=f[0],a.ConfigManager.getConfig("NAS").done(function(f){b=f,c=b.filter(function(a){return"FTP"===a.Protocol})[0],webCaps.SupportSftp?a.ConfigManager.getConfig("SFTP").done(function(a){e=a[0],e.Enable?$("rs_tab_newftp_type").value="SFTP":c.Enable&&($("rs_tab_newftp_type").value="FTP"),"SFTP"===$("rs_tab_newftp_type").value?($("rs_tab_newftp_type").value="SFTP",k._renderElements(e,d)):(k._renderElements(c,d),$("rs_tab_newftp_type").value="FTP"),h&&remarkDisplay("rs_tab_newftp_remark",tl("com.OperateSuccessTip"),3e3,0)}):(k._renderElements(c,d),h&&remarkDisplay("rs_tab_newftp_remark",tl("com.OperateSuccessTip"),3e3,0))})}).fail(function(){remarkDisplay("rs_tab_newftp_remark",tl("com.OperateFailTip"),3e3,1)}),webApp.IsSDTraficIntel&&(j=!0,k.trafficSet(),a.ConfigManager.getConfig(["MultiSceneRecord","TrafficImage"]).done(function(a){f=a[0].params.table,g=a[1].params.table,f?f[0].VideoNamingFormat||(f[0].VideoNamingFormat={Format:tl("com.SettingGetErrorTip")+"/%c/%07/%y/%M/%d/%h/%04-%y%M%d%h%m%s%S-%07-%18-(%14).dav"}):f[0]={VideoNamingFormat:{Format:tl("com.SettingGetErrorTip")+"/%c/%07/%y/%M/%d/%h/%04-%y%M%d%h%m%s%S-%07-%18-(%14).dav"}},g?g[0].NamingFormat||(g[0].NamingFormat={Format:tl("com.SettingGetErrorTip")+"/%c/%07/%y/%M/%d/%h/%04-%y%M%d%h%m%s%S-%07-%18-(%14).jpg",FormatEx:tl("com.SettingGetErrorTip")+"/%c/%07/%y/%M/%d/%h/%04-%y%M%d%h%m%s%S-%07-%18-(%14).jpg"}):g[0]={NamingFormat:{Format:tl("com.SettingGetErrorTip")+"/%c/%07/%y/%M/%d/%h/%04-%y%M%d%h%m%s%S-%07-%18-(%14).jpg",FormatEx:tl("com.SettingGetErrorTip")+"/%c/%07/%y/%M/%d/%h/%04-%y%M%d%h%m%s%S-%07-%18-(%14).jpg"}},k._renderTraffic()}))},_validateBeforSubmit:function(){if(!checkedImportLimt("rs_tab_newftp_username",3))return remarkDisplay("rs_tab_newftp_remark",tl("com.NoInputMarksTip"),3e3,1),!1;if(!checkedImportLimt("rs_tab_newftp_password",3))return remarkDisplay("rs_tab_newftp_remark",tl("com.NoInputMarksTip"),3e3,1),!1;if(!checkedImportLimt("rs_tab_newftp_directory",10)){if(""!==$("rs_tab_newftp_directory").value)return remarkDisplay("rs_tab_newftp_remark",tl("com.PathErrorTip"),3e3,1),!1;$("rs_tab_newftp_directory_tip").setProperty("text","")}return $("rs_tab_newftp_address").value.length>0&&!checkedImportLimt("rs_tab_newftp_address",11)?(remarkDisplay("rs_tab_newftp_remark",tl("com.EmailiperrorTip"),3e3,1),!1):!0}}}(),function(){var b,c,d,e,f,g=Page.recordStorageConfig.Tab.network={init:function(){isEnable("show_NAS_config")&&($("rs_tab_title_network").setStyle("display",""),g._initProtocol(),g.translate(),g.bind())},translate:function(){},_initProtocol:function(){var a;a=getPngVal("NAS_Protocol_Mask")?getPngVal("NAS_Protocol_Mask").toString(2):"".toString(2),$("rs_tab_network_Protocol").empty(),4&a&&$("rs_tab_network_Protocol").options.add(new Option("NFS","NFS")),2&a&&$("rs_tab_network_Protocol").options.add(new Option("ISCSI","ISCSI")),1&a&&(webCaps.is_show_SMB&&jQuery("#rs_tab_network_Protocol").show(),$("rs_tab_network_Protocol").options.add(new Option("SMB","SMB")))},render:function(){g._getConfigAndRenderElements()},bind:function(){$("rs_tab_network_defualt").addEvent("click",g._onDefaultClick),$("rs_tab_network_refresh").addEvent("click",g._onRefreshClick),$("rs_tab_network_confirm").addEvent("click",g._onConfirmClick),$("rs_tab_network_enable").addEvent("change",function(){$("rs_tab_network_enable").checked&&g._setUniqueEnable()}),$("rs_tab_network_Protocol").addEvent("change",function(){return g._validateBeforSubmit()?(g._saveTempJson(),e=this.value,d=b.filter(function(a){return a.Protocol===e})[0],void g._renderElements(d,c)):void(this.value=e)}),attachLimit("rs_tab_network_port",0,65535),$$("#rs_tab_network_password, #rs_tab_network_username").addEvents({keyup:function(){promptImportLimt(this.id,this.id+"_tip","com.NoInputMarksTip",3)},blur:function(){promptImportLimt(this.id,this.id+"_tip","com.NoInputMarksTip",3)}}),$("rs_tab_network_username").addEvents({keyup:function(){var a=StringUtil.byteLength(this.value,"aaa");a>32&&(this.value=StringUtil.btSub(this.value,32,"aaa"),this.isLengthOver=!0),this.isLengthOver=32==a?!0:!1},keydown:function(a){var b=StringUtil.byteLength(this.value,"aaa");if(this.isLengthOver=32==b?!0:!1,this.isLengthOver){var c=["backspace","delete","up","down","left","right","esc","$","#","f1","f2","f3","f4","f5","f6","f7","f8","f9","f10","f11","f12"];c.contains(a.key)||"c"===a.key&&a.control||a.alt||a.meta||a.shift&&a.control||a.stop()}}}),$("rs_tab_network_address").addEvents({keyup:function(){promptImportLimt("rs_tab_network_address","rs_tab_network_address_tip","com.EmailiperrorTip",11)},blur:function(){promptImportLimt("rs_tab_network_address","rs_tab_network_address_tip","com.EmailiperrorTip",11)}}),$("rs_tab_network_directory").addEvents({keyup:function(){StringUtil.byteLength(this.value,"aaa")>200?$(this.id+"_tip").setProperty("text",tl("com.PathLongTip")):$(this.id+"_tip").setProperty("text",""),this.value&&(/^[\w-.\/]+$/.test(this.value)?$(this.id+"_tip").setProperty("text",""):$(this.id+"_tip").setProperty("text",tl("com.PathErrorWithPointTip")))},blur:function(){StringUtil.byteLength(this.value,"aaa")>200?$(this.id+"_tip").setProperty("text",tl("com.PathLongTip")):$(this.id+"_tip").setProperty("text",""),this.value&&(/^[\w-.\/]+$/.test(this.value)?$(this.id+"_tip").setProperty("text",""):$(this.id+"_tip").setProperty("text",tl("com.PathErrorWithPointTip")))}})},_getConfigAndRenderElements:function(h){a.ConfigManager.getConfig("RecordStoragePoint").done(function(i){c=i[0],a.ConfigManager.getConfig("NAS").done(function(a){if(e=$("rs_tab_network_Protocol").value,b=a,webCaps.is_show_SMB){var i=0;b.each(function(a,b){a.Enable&&(i=b)}),i?(e=b[i].Protocol,$("rs_tab_network_Protocol").value=e):($("rs_tab_network_Protocol").selectedIndex=i,e=$("rs_tab_network_Protocol").value)}d=b.filter(function(a){return a.Protocol===e})[0],g._renderElements(d,c),f=$unlink(b),h&&remarkDisplay("rs_tab_network_remark",tl("com.OperateSuccessTip"),3e3,0)})}).fail(function(){remarkDisplay("rs_tab_network_remark",tl("com.OperateFailTip"),3e3,1)})},_renderElements:function(a,b){var c;c=b?b:Page.recordStorageConfig.Tab.path.getRecordStoragePoint(),hasRemote=c.TimingRecord.Remote||c.VideoDetectRecord.Remote||c.AlarmRecord.Remote||c.TimingSnapShot.Remote||c.VideoDetectSnapShot.Remote||c.AlarmSnapShot.Remote,hasRemote?$("rs_tab_network_enable").disabled=!1:(a.Enable=!1,$("rs_tab_network_enable").disabled=!0),$("rs_tab_network_enable").checked=a.Enable,$("rs_tab_network_port").value=a.Port,$("rs_tab_network_username").value=a.UserName,$("rs_tab_network_password").value=a.Password,$("rs_tab_network_directory").value=a.Directory,$("rs_tab_network_address").value=a.Address,$$("#rs_tab_network .ui-tip-red").set("text",""),webCaps.is_show_SMB&&"SMB"===a.Protocol?(jQuery("#rs_tab_network_username").parent("div").show(),jQuery("#rs_tab_network_password").parent("div").show()):(jQuery("#rs_tab_network_username").parent("div").hide(),jQuery("#rs_tab_network_password").parent("div").hide())
},_onDefaultClick:function(){a.ConfigManager.getDefault("NAS").done(function(a){e=$("rs_tab_network_Protocol").value,b=a,b.each(function(a){"FTP"===a.Protocol&&f.each(function(b){if("FTP"===b.Protocol)for(var c in a)a[c]=b[c]})}),d=b.filter(function(a){return a.Protocol===e})[0],g._renderElements(d,c),remarkDisplay("rs_tab_network_remark",tl("com.DefaultSuccessTip"),3e3,0)}).fail(function(){remarkDisplay("rs_tab_network_remark",tl("com.DefaultfailureTip"),3e3,1)})},_onRefreshClick:function(){g._getConfigAndRenderElements(!0)},_saveTempJson:function(){d.Enable=$("rs_tab_network_enable").checked,d.Port=$("rs_tab_network_port").value-0,d.UserName=$("rs_tab_network_username").value,d.Password=$("rs_tab_network_password").value,d.Directory=$("rs_tab_network_directory").value,d.Address=$("rs_tab_network_address").value},_setUniqueEnable:function(){for(var a=0;a<b.length;a++)b[a].Protocol!==e&&(b[a].Enable=!1)},_onConfirmClick:function(){g._validateBeforSubmit()&&(g._saveTempJson(),a.ConfigManager.setConfig("NAS",b).done(function(){remarkDisplay("rs_tab_network_remark",tl("com.SaveSuccessTip"),3e3,0)}).fail(function(){remarkDisplay("rs_tab_network_remark",tl("com.SaveConfigFailTip"),3e3,1)}))},_validateBeforSubmit:function(){return checkedImportLimt("rs_tab_network_username",3)&&checkedImportLimt("rs_tab_network_password",3)?$("rs_tab_network_directory").value&&!/^[\w-.\/]+$/.test($("rs_tab_network_directory").value)?(remarkDisplay("rs_tab_network_remark",tl("com.PathErrorWithPointTip"),3e3,1),!1):$("rs_tab_network_address").value.length>0&&!checkedImportLimt("rs_tab_network_address",11)?(remarkDisplay("rs_tab_network_remark",tl("com.EmailiperrorTip"),3e3,1),!1):StringUtil.byteLength($("rs_tab_network_directory").value,"aaa")>200?void remarkDisplay("rs_tab_network_remark",tl("com.PathLongTip"),3e3,1):!0:(remarkDisplay("rs_tab_network_remark",tl("com.NoInputMarksTip"),3e3,1),!1)}}}(),function(){var b={},c={},d={},e=null,f=null,g=null,h=Page.recordStorageConfig.Tab.store={init:function(){g=$("rs_tab_store_mode"),h.translate(),h.bind()},translate:function(){},render:function(){h._getConfig(),h._renderElements(),f=(8*e/8192/3600).toFixed(2),f>=3600?(f=(8*e/8192/3600).toFixed(2),$("rs_tab_store_timeTip").set("text",f+" "+tl("com.Hours"))):(f=(8*e/8192/60).toFixed(2),$("rs_tab_store_timeTip").set("text",f+" "+tl("com.Minutes")))},bind:function(){$("rs_tab_store_confirm").addEvent("click",h._onConfirmClick),$("rs_tab_store_mode").addEvent("change",h._saveTempJson)},_getConfig:function(d){a.ConfigManager.getConfig(["Encode","VideoEncodeROI"]).done(function(a){b=a[0].params.table,c=a[1].params.table,g.value=8192===b[0].MainFormat[0].Video.BitRate&&6===c[0].Quality?"High":4096===b[0].MainFormat[0].Video.BitRate&&3===c[0].Quality?"Middle":"Low",$("rs_tab_store_fpsTip").set("text",b[0].MainFormat[0].Video.FPS),d&&remarkDisplay("rs_tab_store_remark",tl("com.OperateSuccessTip"),3e3,0)}).fail(function(){remarkDisplay("rs_tab_store_remark",tl("com.OperateFailTip"),3e3,1)})},_renderElements:function(){a.Storage.getDeviceAllInfo().done(function(a){d=a,webApp.GongAnDetect&&a?$("is_SD_show").setStyle("display",""):$("is_SD_show").setStyle("display","none"),d&&d.each(function(a){a.Detail.each(function(a){e=(a.TotalBytes-a.UsedBytes)/1024,f=8*e/b[0].MainFormat[0].Video.BitRate,f>=3600?(f=(8*e/b[0].MainFormat[0].Video.BitRate/3600).toFixed(2),$("rs_tab_store_timeTip").set("text",f+" "+tl("com.Hours"))):(f=(8*e/b[0].MainFormat[0].Video.BitRate/60).toFixed(2),$("rs_tab_store_timeTip").set("text",f+" "+tl("com.Minutes")))})})})},_saveTempJson:function(){[0,1,2].each(function(a){"High"==g.value?(b[0].MainFormat[a].Video.BitRate=8192,"PAL"==webApp.VideoStandard?b[0].MainFormat[a].Video.FPS=25:"NTSC"==webApp.VideoStandard&&(b[0].MainFormat[a].Video.FPS=30),c[0].Quality=6):"Middle"==g.value?(b[0].MainFormat[a].Video.BitRate=4096,b[0].MainFormat[a].Video.FPS=20,c[0].Quality=3):"Low"==g.value&&(b[0].MainFormat[a].Video.BitRate=2048,b[0].MainFormat[a].Video.FPS=10,c[0].Quality=1)}),$("rs_tab_store_fpsTip").set("text",b[0].MainFormat[0].Video.FPS),h._renderElements()},_onConfirmClick:function(){h._saveTempJson(),a.ConfigManager.setConfig(["Encode","VideoEncodeROI"],[b,c]).done(function(){remarkDisplay("rs_tab_store_remark",tl("com.SaveSuccessTip"),3e3,0)}).fail(function(){remarkDisplay("rs_tab_store_remark",tl("com.SaveConfigFailTip"),3e3,1)})}}}(),function(){var b=!1,c=null,d=null;$store_stream=null;var e=Page.recordStorageConfig.Tab.lightstore={init:function(){$store_stream=$("rs_tab_store_stream"),d=$("rs_tab_store_level"),e.translate(),e.bind()},translate:function(){},render:function(b){a.ConfigManager.getConfig("DynamicBitrate").done(function(a){c=a,$("rs_tab_store_stream").fireEvent("change"),b&&remarkDisplay("rs_tab_store_LightStorage",tl("com.OperateSuccessTip"),3e3,0)}).fail(function(){remarkDisplay("rs_tab_store_LightStorage",tl("com.OperateFailTip"),3e3,1)})},bind:function(){$("rs_tab_lightstore_refresh").addEvent("click",e._onRefreshClick),$("rs_tab_lightstore_default").addEvent("click",e._onDefaultClick),$("rs_tab_lightstore_confirm").addEvent("click",e._onConfirmClick),$("rs_tab_store_stream").addEvent("change",e._onSelectChange)},_renderElement:function(e){var f=null;e&&(f=c[0].filter(function(a){return a.Stream==e})),d.value=f[0].DynamicFPSLevel,a.ConfigManager.getConfig("Encode",!0).done(function(a){b=a[0].MainFormat[0].Video.BitRateControl})},_onSelectChange:function(){e._renderElement($store_stream.value)},_onRefreshClick:function(){e.render(!0)},_onDefaultClick:function(){a.ConfigManager.getDefault("DynamicBitrate").done(function(a){c=a,e._renderElement($store_stream.value),remarkDisplay("rs_tab_store_LightStorage",tl("com.DefaultSuccessTip"),3e3,0)}).fail(function(){remarkDisplay("rs_tab_store_LightStorage",tl("com.DefaultfailureTip"),3e3,1)})},_onConfirmClick:function(){var f=null;return"Main"===$store_stream.value?f=c[0].filter(function(a){return"Main"==a.Stream}):"Extra1"===$store_stream.value?f=c[0].filter(function(a){return"Extra1"==a.Stream}):"Extra2"===$store_stream.value&&(f=c[0].filter(function(a){return"Extra2"==a.Stream})),"Main"===$store_stream.value&&d.value-0!==0&&"CBR"===b&&b!==!1?(remarkDisplay("rs_tab_store_LightStorage",tl("sto.ModifyConfigF"),3e3,1),void e._renderElement($store_stream.value)):(f[0].DynamicFPSLevel=d.value-0,void a.ConfigManager.setConfig("DynamicBitrate",c).done(function(){remarkDisplay("rs_tab_store_LightStorage",tl("com.SaveSuccessTip"),3e3,0)}).fail(function(){remarkDisplay("rs_tab_store_LightStorage",tl("com.SaveConfigFailTip"),3e3,1)}))}}}()});