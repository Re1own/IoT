!function(a){define(function(require,a,b){b.exports=require("jsCore/pageTab")}),define("upg_upgrade",function(require,b,c){var d=require("jsCore/pageBase"),e=require("jsCore/rpc"),f=require("jsCore/ability"),g=null,h=null,i=null,j=null,k=null,l=null,m=null,n=null,o=null,p=null,q=null,r=!1,s=!1,t=tl("com.RebootingTip");c.exports=d.extend({init:function(){g=this,h=g.$("#upg_upgrade"),i=g.$("#upg_path"),j=g.$("#upg_import"),k=g.$("#upg_probar"),l=g.$("#upg_process"),m=g.$("#upg_updating"),n=g.$("#upg_update"),h.on("change blur",g._onUpgradeChange),h.hover(function(){j.addClass("ui-button-hover")},function(){j.removeClass("ui-button-hover")}),o=g.$("#upg_progress").dialog({close:function(){"Cloud"===q?e.CloudUpgrader.cancel().done(function(){webApp.reboot("com.RebootingTip",!1)}):"Local"===q&&e.Upgrader.cancel().done(function(){webApp.reboot("com.RebootingTip",!1)})}}),f.get("CameraUpdatePowerOff").done(function(a){a&&a.Support&&(s=!0)}),g.render()},render:function(){window.downSucceed=function(){g._getStatus(!1)},r=!1,f.get("SoftwareVersion").done(function(a){var b=a.version.Version+", Build Date: "+a.version.BuildDate;g.$("#upg_firmversion").text(b)}),e.MagicBox.getSubModules().done(function(b){a.each(b,function(a,b){var c=b.SoftwareVersion;"Unknow"!==c&&""!==c&&"PTZ"===b.ModuleName&&g.$("#upg_ptzversion").text(c).parent().show()})}),i.val(""),webApp.CloudUpgrade&&e.CloudUpgrader.getAutoCheck().done(function(a){g.$("#upg_autocheck").prop("checked",a.flag),webApp.CloudAutoCheck=a.flag,webApp.CloudAutoCheck&&(webApp.CloudUpgraderInfo&&"None"!==webApp.CloudUpgraderInfo.State?(p=webApp.CloudUpgraderInfo.NewVersion,g.$("#upg_remotemessagewrap").removeClass("fn-hide"),webApp.CloudUpgraderInfo.PackageType.toLowerCase().indexOf("ptz")>-1?g.$("#upg_newptzversion").text(p).parent().show():g.$("#upg_newfirmversion").text(p).parent().show(),g.$("#upg_newversion_info").html(webApp.CloudUpgraderInfo.Attention.replace(/\n/g,"<br/>"))):webApp.CloudUpgraderInfo&&"None"===webApp.CloudUpgraderInfo.State&&g.$("#upg_err_no_version").show())})},leave:function(){r=!0,g.$("#upg_remotemessagewrap").addClass("fn-hide"),g.$("#upg_newptzversion").parent().hide(),g.$("#upg_newfirmversion").parent().hide(),g.$("#upg_err_no_version").hide()},onSelectFile:function(){h.trigger("click")},_onUpgradeChange:function(){var b=a(this).val().split("\\");i.val(b[b.length-1])},onUpdate:function(){var a=h.val();""!==i.val()&&(a.test(".bin","i")?(g.disabled(n,!0),g.$("#upg_submit").trigger("click"),o.dialog("show"),q="Local",o.find("#upg_updating").text(tl("com.TransmitWaitingTip")),l.css("width","0px"),t=s&&a.test("packet","i")?tl("com.RebootingTip")+tl("com.ChipProgrmmaPowerOffTop"):tl("com.RebootingTip")):g.$(".u-tip").tip("warning",tl("com.WrongFileUpgradeTip")))},onCloudUpgrade:function(){a.confirm(tl("com.Prompt"),tl("sys.CloudAccessTip"),function(){g.disabled(g.$("[btn-for=onCloudUpgrade]"),!0),q="Cloud",e.CloudUpgrader.execute(p,0).done(function(){o.dialog("show"),o.find("#upg_updating").text(tl("com.TransmitWaitingTip")),l.css("width","0px"),t=tl("com.RebootingTip"),g._getStatus(!0)}).fail(function(b){var c="Operateingfailure";switch(b.error.code){case 287899649:c="sys.CloudUpgErrUnknown";break;case 287899650:c="sys.CloudUpgErrDisable";break;case 287899651:c="sys.CloudUpgErrCheckTimeout";break;case 287899652:c="sys.CloudUpgErrParam";break;case 287899653:c="sys.CloudUpgErrNoVersion";break;case 287899654:c="sys.CloudUpgErrHasNewVersion";break;case 287899655:c="sys.CloudUpgErrUpgrading";break;case 287899656:c="sys.CloudUpgErrNoCache"}a.alert(tl(c),null,!0,{title:tl("com.Prompt")})})})},onConfirm:function(){e.CloudUpgrader.setAutoCheck(g.$("#upg_autocheck").prop("checked")).done(function(){webApp.CloudAutoCheck=g.$("#upg_autocheck").prop("checked"),g.$(".u-tip").tip("success",tl("com.SaveSuccessTip")),e.CloudUpgrader.check(2).done(function(a){webApp.CloudUpgraderInfo=a.info})}).fail(function(){g.$(".u-tip").tip("error",tl("com.SaveConfigFailTip"))})},onManualCheck:function(){g.disabled(g.$("[btn-for=onManualCheck]"),!0),g.$("#upg_err_no_version").hide(),g.$("#upg_remotemessagewrap").addClass("fn-hide"),g.$("#upg_newfirmversion").parent().hide(),g.$("#upg_newptzversion").parent().hide(),e.CloudUpgrader.check(0).done(function(a){var b=a.info;webApp.CloudUpgraderInfo=b,p=b.NewVersion,"None"!==b.State&&"Ptz"===b.PackageType?(g.$("#upg_remotemessagewrap").removeClass("fn-hide"),g.$("#upg_newptzversion").text(p).parent().show()):"None"!==b.State&&"Ptz"!==b.PackageType&&(g.$("#upg_remotemessagewrap").removeClass("fn-hide"),g.$("#upg_newfirmversion").text(p).parent().show()),"None"!==b.State?g.$("#upg_newversion_info").html(b.Attention.replace(/\n/g,"<br/>")):g.$("#upg_err_no_version").show(),g.disabled(g.$("[btn-for=onManualCheck]"),!1)}).fail(function(b){var c="sys.CloudUpgErrUnknown";switch(b.error.code){case 287899649:c="sys.CloudUpgErrUnknown";break;case 287899650:c="sys.CloudUpgErrDisable";break;case 287899651:c="sys.CloudUpgErrCheckTimeout";break;case 287899652:c="sys.CloudUpgErrParam";break;case 287899653:c="sys.CloudUpgErrNoVersion";break;case 287899654:c="sys.CloudUpgErrHasNewVersion";break;case 287899655:c="sys.CloudUpgErrUpgrading";break;case 287899656:c="sys.CloudUpgErrNoCache"}r||a.alert(tl(c),null,!0,{title:tl("com.Prompt")}),g.disabled(g.$("[btn-for=onManualCheck]"),!1)})},_getStatus:function(a){a?e.CloudUpgrader.getState().done(function(b){g._getStatusSuccess(b,a)}).fail(function(b){g._getStatusFails(b,a)}):e.Upgrader.getState().done(function(b){g._getStatusSuccess(b,a)}).fail(function(b){g._getStatusFails(b,a)})},_getStatusSuccess:function(a,b){switch(a.State){case"Invalid":g._upgradeFails("com.BadFiletoRebootTip",b);break;case"Failed":case"NotEnoughMemory":case"Cancelled":case"OEMNotCompare":g._upgradeFails("com.UpgradeFailedTip",b);break;case"FileUnmatch":g._upgradeFails("com.FileUnmatchTip",b);break;case"Noupgrade":g._upgradeFails("sys.Noupgrade",b);break;case"DownloadFailed":g._upgradeFails("sys.CloudUpgStateDownloadFailed",b);break;case"UnmatchVersion":g._uncatchVersion();break;default:g._upgrading(a.Progress,a.State,b)}},_getStatusFails:function(a,b){a.result===!1?b||(g.$(".u-tip").tip("warning",tl("com.OperateFailTip")),g.disabled(n,!1),k.css("visibility","hidden")):b?setTimeout(function(){g._getStatus(b)},1e3):(l.css("width","321px"),m.text(t),setTimeout(function(){g._locationToIndex()},2e4))},_uncatchVersion:function(){o.dialog("close"),g.disabled(n,!1),k.css("visibility","hidden"),a.confirm(tl("com.Reboot"),tl("com.UpdatePackageLower"),function(){webApp.reboot("com.ConfEffectRestartTip",!0)})},_upgradeFails:function(b,c){c?(o.hide(),a.alert(tl(b),function(){webApp.reboot("com.RebootingTip",!1)},!0,{title:tl("com.Prompt")})):(o.dialog("close"),g.disabled(n,!1),k.css("visibility","hidden"),webApp.reboot(b,!0))},_upgrading:function(a,b,c){switch(l.css("width",321*a/100+"px"),b){case"Preparing":case"Downloading":o.find("#upg_updating").text(tl("sys.FileDownloading")+a+"%"),o.find(".u-dialog-foot").show();break;case"Upgrading":o.find("#upg_updating").text(tl("sys.UpgradingAttention")),o.find(".u-dialog-foot").hide()}100!=a||"Upgrading"!==b&&"Succeeded"!==b?setTimeout(function(){g._getStatus(c)},1e3):(o.find("#upg_updating").text(tl("com.RebootingTip")),setTimeout(function(){g._locationToIndex()},2e4))},_locationToIndex:function(){a(window).unbind("unload"),a(window).unbind("beforeunload"),plugin.Reload()}})})}(jQuery);