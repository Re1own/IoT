define(function(require){function a(a,b){var c=a.DistantViewBox,d=a.NearbyViewBox;if(0===c[0][0]&&0===c[0][1]&&0===c[1][0]&&0===c[1][1])return!1;var e=[c[1][0]-c[0][0],c[1][1]-c[0][1]],f=[d[1][0]-d[0][0],d[1][1]-d[0][1]],g=[(c[0][0]+e[0]/2).round(0),(c[0][1]+e[1]/2).round(0)],h=1;return b&&(h=(e[0]/b[0]).round(4)),[g,e,f,h]}function b(a,b,c){var d=null;if(1===a){var e=b.CalibrateBoxs[0].CenterPoint,f=b.MaxSize,g=b.MinSize;d={DistantViewBox:[[(e[0]-f[0]/2).round(0),(e[1]-f[1]/2).round(0)],[(e[0]+f[0]/2).round(0),(e[1]+f[1]/2).round(0)]],NearbyViewBox:[[(e[0]-g[0]/2).round(0),(e[1]-g[1]/2).round(0)],[(e[0]+g[0]/2).round(0),(e[1]+g[1]/2).round(0)]]}}else{var h=c.Ratio,e=c.CenterPoint,f=[b.MaxSize[0]*h,b.MaxSize[1]*h],g=[b.MinSize[0]*h,b.MinSize[1]*h];d={DistantViewBox:[[(e[0]-f[0]/2).round(0),(e[1]-f[1]/2).round(0)],[(e[0]+f[0]/2).round(0),(e[1]+f[1]/2).round(0)]],NearbyViewBox:[[(e[0]-g[0]/2).round(0),(e[1]-g[1]/2).round(0)],[(e[0]+g[0]/2).round(0),(e[1]+g[1]/2).round(0)]]}}return d}var c,d={},e={},f=require("jsCore/modules/eventHandler"),g=require("jsCore/rpc"),h=require("jsCore/modules/timeSection"),k=require("jsCore/rpcLogin"),l=require("jsCore/plugin"),m=require("jsCore/ability"),n=require("common/common");require("widget/js/dui.iconlist"),require("widget/js/dui.iconSelect");var o,p,q,r=require("PtzCmd"),s={LeftDetection:[6,3600],TakenAwayDetection:[6,3600],WanderDetection:[1,600],MoveDetection:[6,300],RioterDetection:[10,300],ParkingDetection:[6,300]},t=[],u=[],v=!1,w=null,x=0,y=global.isZeroArray,z=global.isEmptyRect,A={},B={},C=["VideoAnalyseRule"],D=!1;!function(){var a=Page.ivsConfig={Tab:[],current:null,init:function(){m.get("IntelliTracker").done(function(a){b.init(webApp.DeviceType.indexOf("TPC")>-1&&-1===webApp.DeviceType.indexOf("SD")?!1:a&&a.Support),a&&a.Support&&($$('div[data-wrap="TrackEnable"]').removeClass("fn-hide"),v=!0,0==a.SupportConfigTrackDuration&&$("ipcIntellentNew_TrackTime").getParent().addClass("fn-hide")),r.init("ivsSdPtzWrap",{markScene:a&&a.Support,setPreset:!webApp.NoIntelliPreset})}),m.get("IVSCaps").done(function(b){if(b){for(var c in b.SupportedScenes.Normal.SupportedRules)d[c]=[],"SmokeDetection"!=c&&t.push(c);-1!==t.indexOf("HeatMap")&&t.splice(t.indexOf("HeatMap"),1),-1!==t.indexOf("VideoAbnormalDetection")&&t.splice(t.indexOf("VideoAbnormalDetection"),1),$("ipcIntellentNew_Global_tab").setStyle("display",""),$("ipcIntellentNew_CrossLineDetection_tab").setStyle("display","");var e=b.SupportedScenes&&b.SupportedScenes.Normal.SupportedRules||[];if($each(e,function(a,b){a.TriggerTrack&&(u.push(b),jQuery("#ipcIntellentNew_TrackTip").attr("t","ivs.TriggerTrack").text(tl("ivs.TriggerTrack"))),jQuery.isArray(a.SupportedObjectTypes)&&"Unknown"!==a.SupportedObjectTypes[0]&&(B[b]=a.SupportedObjectTypes)}),t.indexOf("CrossRegionDetection")>-1){$$("#ipcIntellentNew_actionWrap label.ui-checkbox").setStyle("display","none");var f=b.SupportedScenes.Normal.SupportedRules.CrossRegionDetection.SupportedActions||["Appear","Cross"];$each(f,function(a){$$("input[data-val = "+a+"]").getParent("label").setStyle("display","block")})}}Object.keys(d).length>6&&$$(".ipcIntellentNew_tab_title").setStyle("min-width","80px"),a.Tab["public"].init(),a.Tab.Global.init(),-1!==webApp.DeviceType.indexOf("TPC")&&webApp.CHANNEL_NUMBER>1&&v?(a.Tab.Track.init(),$("ipcIntellentNew_track_tab").setStyle("display","")):$("ipcIntellentNew_track_tab").setStyle("display","none"),a.translate(),a.bind(),m.get("TrackScale").done(function(b){b&&b.TrackScale&&b.TrackScale.SupportSetTrackScale&&v&&(D=!0,jQuery("#ivs_ObjectSize").parent().show(),C.push("VideoAnalyseCalibrate")),a.render()});var g=b.SupportedScenes.Normal.SupportedModuleParams;0==g.Shadow&&jQuery('#Global_TrackForm div[data-cap="Shadow"]').addClass("fn-hide"),0==g.AntiDisturbance&&jQuery('#Global_TrackForm div[data-cap="AntiDisturbance"]').addClass("fn-hide"),0==b.SupportedScenes.Normal.SupportedCalibrateParams.MaxCelibateAreas&&$("ipcIntellentNew_Global_tab").addClass("fn-hide")});"VideoAnalyseRule["+analyseSenceRuleMap.Normal+"]";g.VideoInAnalyse.getTemplateRule("All",0).done(function(b){a.parseDefaultConfig(b.Normal)}).fail(function(){g.DevVideoAnalyse.getTemplateRule("All").done(function(b){a.parseDefaultConfig(b)}).fail(function(){a.parseDefaultConfig()})}),-1===webApp.DeviceType.indexOf("SD")&&-1===webApp.DeviceType.indexOf("TPC")?jQuery('[data-show="SD"]').addClass("fn-hide"):-1!==webApp.DeviceType.indexOf("SD")&&-1===webApp.DeviceType.indexOf("TPC")?jQuery('[data-show="IPC"]').addClass("fn-hide"):-1!==webApp.DeviceType.indexOf("TPC")&&(jQuery('[data-show="SD"]').addClass("fn-hide"),jQuery('[data-show="TPC"]').removeClass("fn-hide"),jQuery('[data-showtwo="TPC"]').removeClass("fn-hide"))},destory:function(){b.leave(),t.empty()},translate:function(){$("page_ivsConfig").translation()},render:function(){g.ConfigManager.getConfig(C).done(function(a){c=a[0].params.table,a[1]&&a[1].result&&(p=a[1].params.table,q=$unlink(p[x][0])),$$(".ipcIntellentNew_tab_title.ui-tab-current").fireEvent("click")}),isEnable("is_show_help")||$("ipcIntellentNew_help").setStyle("display","none"),-1===webApp.DeviceType.indexOf("TPC")&&b.render(),m.get("VideoInputCapsEx").done(function(a){a.LightingControl&&(capsLight=a.LightingControl,capsLight.LinkingDetail&&capsLight.LinkingDetail.FilckerLighting&&capsLight.LinkingDetail.FilckerLighting.Ability&&(o=capsLight.LinkingDetail.FilckerLighting.Ability.SupportIntelliScence.indexOf("Normal")>-1?!0:!1,f.init(capsLight)))})},bind:function(){$("ipcIntellentNew_help").addEvent("click",a._openHelp),$$(".ipcIntellentNew_tab_title").addEvent("click",a._onTabTitleClick)},_onTabTitleClick:function(){var b=this,c=this.getProperty("data-for");a.current!==a.Tab[c]&&a.current&&a.current.leave&&a.current.leave(),setTimeout(function(){$$(".ipcIntellentNew_tab_title").removeClass("ui-tab-current"),$$(".ipcIntellentNew_tab_con").setStyle("display","none"),b.addClass("ui-tab-current");var d,e=["CrossLineDetection","CrossRegionDetection","LeftDetection","VideoAbnormalDetection","WanderDetection","RioterDetection","MoveDetection","CrossFenceDetection","PrisonerRiseDetection","ClimbDetection","LeaveDetection"];e.indexOf(c)>-1?(d="public",c="public"):d=c,$("ipcIntellentNew_tab_"+d).setStyle("display","block"),a._hideElement(),a.current=a.Tab[c],a.Tab[c].render()},20)},_hideElement:function(){$("ipcIntellentNew_remark1").setStyle("minWidth","310px"),$("ipcIntellentNew_remark1").setStyle("height","100%"),$("ipcIntellentNew_remark1").setStyle("visibility","hidden"),$("ipcIntellentNew_VideoAbnormalDetection").addClass("fn-width310"),$$(".ipcIntellentNew_VideoAbnormalDetectionButton").removeClass("fn-marl140"),$$(".ipcIntellentNew_VideoAbnormalDetection").setStyle("display",""),$("ipcIntellentNew_VideoAbnormalDetection").addClass("fn-left"),$("ipcIntellentNew_minDuration_wrap").setStyle("display","none"),$("ipcIntellentNew_ruleDirectionWrap").setStyle("display","none"),$("ipcIntellentNew_ruleDirectionWrap2").setStyle("display","none"),$("ipcIntellentNew_RuleType_wrap").setStyle("display","none"),$("ipcIntellentNew_SensitivityWrap").setStyle("display","none"),$("ipcIntellentNew_actionWrap").setStyle("display","none"),$("ipcIntellentNew_fieldset").removeClass("intell-abnormal-fieldset"),$("ipcIntellentNew_fenceDirection_wrap").addClass("fn-hide"),$("ipcIntellentNew_object_filter_ck").setStyle("display",""),$("ipcIntellentNew_target_label").set("text",tl("ivs.AimFiltrate")),$("ipcIntellentNew_drawDirection_wrap").setStyle("display","none"),$("ipcIntellentNew_drawDirection_wrap1").setStyle("display","none"),$("ipcIntellentNew_drawDirection_wrap2").setStyle("display","none"),$$(".InsideRule").setStyle("display","none")},_openHelp:function(){openHelp("ipcIntellentNewConfig.htm")},parseDefaultConfig:function(a){if(void 0===a||null===a)throw new Error("VideoInAnalyse.getTemplateRule(All) error!");e=a},leave:function(){b.leave(),l.close(),a.current&&a.current.leave&&a.current.leave(),a.current=null}},b={support:!1,status:"",timer:0,init:function(a){a=a===!0?!0:!1,this.support=a,a===!0&&$("ipcIntellentNew_lockPtz_wrap").removeClass("fn-hide"),this.Traceer=g.DevIntelliTracker,$("ipcIntellentNew_lockPtz").set("text",tl("ivs.UnlockPtz")+"(180s)")},render:function(){if(this.support!==!1){var a=this;this.Traceer.getLockLeft().done(function(b){0==b?(a.setLocktime(180,0),webApp.DeviceType.indexOf("TPC")>-1&&webApp.CHANNEL_NUMBER>1&&a.setLocktime(180,1)):(a.renderDom(b),setTimeout(function(){a.getLocktime()},1e3))}).fail(function(){setTimeout(function(){remarkDisplay("ipcIntellentNew_remark1",tl("com.GetLockLeftError"),3e3,1)},1e3)})}},renderDom:function(a){var b=this,c=$("ipcIntellentNew_lockPtz");if(c){c.removeEvents("click");var d="";switch(a){case 0:d=tl("ivs.LockPtz")+"(180s)",c.addEvent("click",function(){b.setLocktime(180,0),webApp.DeviceType.indexOf("TPC")>-1&&webApp.CHANNEL_NUMBER>1&&b.setLocktime(180,1)}),b.status="unlocked";break;default:d=tl("ivs.UnlockPtz")+"("+a+"s)",c.addEvent("click",function(){b.setLocktime(0,0),webApp.DeviceType.indexOf("TPC")>-1&&webApp.CHANNEL_NUMBER>1&&b.setLocktime(0,1)}),b.status="locking"}c.set("text",d)}},leave:function(){0!=this.support&&"locking"==this.status&&(this.setLocktime(0,0),webApp.DeviceType.indexOf("TPC")>-1&&webApp.CHANNEL_NUMBER>1&&that.setLocktime(0,1))},disabledButton:function(a){var b=$("ipcIntellentNew_lockPtz");a?(this.leave(),b.setProperty("disabled",!0),b.addClass("ui-button-disabled")):(b.setProperty("disabled",!1),b.removeClass("ui-button-disabled"),this.render()),b=null},getLocktime:function(){var a=this;this.Traceer.getLockLeft().done(function(c){a.renderDom(c),"locking"==b.status?a.timer=setTimeout(function(){a.getLocktime()},1e3):$clear(a.timer)}).fail(function(){remarkDisplay("ipcIntellentNew_remark1",tl("com.GetLockLeftError"),3e3,1)})},setLocktime:function(a,b){var c=this;this.Traceer.setLockDuration(a,b).done(function(){c.renderDom(a),c.getLocktime()}).fail(function(){remarkDisplay("ipcIntellentNew_remark1",tl("com.SetLockDurationError"),3e3,1)})}};w=b;var f={bind:function(){$("ivs_light_link_enable").addEvent("change",function(a){var b=a.target,c=b.checked;c?$("ivs_light_type").getParent().getParent().removeClass("fn-hide"):$("ivs_light_type").getParent().getParent().addClass("fn-hide")}),$("ivs_light_duration").addEvent("change",function(a){var b=a.target.value-0;b=Math.round(b)>b?parseInt(b)+.5:Math.round(b)<b?parseInt(b):b,$("ivs_light_duration").value=b})},init:function(a){var b={InfraredLight:"ivs.RedLight",WhiteLight:"ivs.WhiteLight",LaserLight:"ivs.LaserLight"};jQuery("#ivs_light_link").show();var c=a.LinkingDetail.FilckerLighting;jQuery("#ivs_light_duration").numberfield({min:.1*c.FilckerIntevalTime[0]||0,max:.1*c.FilckerIntevalTime[1]||100,allowDecimal:!0,allowNegative:!1}),jQuery("#ivs_light_duration").next("span").next("span").text("("+.1*c.FilckerIntevalTime[0]+"~"+.1*c.FilckerIntevalTime[1]+")"),jQuery("#ivs_light_num").numberfield({min:c.FilckerTimes[0]||0,max:c.FilckerTimes[1]||100,allowDecimal:!1,allowNegative:!1}),jQuery("#ivs_light_num").next("span").next("span").text("("+c.FilckerTimes[0]+"~"+c.FilckerTimes[1]+")");var d=jQuery("#ivs_light_type").empty();jQuery.each(c.LightType,function(a,c){d.append("<option value="+c+" t="+b[c]+"></option>")}),d.translation()}}}(),function(){var c,d=null,e=null,f=null,h=null,i=null,j=null,o=[],p=1,q=null,r=null,s=null,t=null,u=[],v=null,w=0,x=null,y=[],z=0,A=require("jsCore/hlsplayer"),B=require("jsCore/flashplayer"),C=require("jsCore/h5player"),D=null,E=!1,F=null,G=!1,H=Page.ivsConfig.Tab.Global={init:function(){H.getTemplate(),H.translate(),H.bind(),webApp.DeviceType.indexOf("TPC")>-1?(webApp.CHANNEL_NUMBER>1&&($("ivs_global_channel").getParent().removeClass("fn-hide"),$("ivs_global_channel").getParent().getNext("div").removeClass("fn-hide"),$channel=jQuery("#ivs_global_channel").iconSelect({channelNumber:webApp.CHANNEL_NUMBER,allEnable:!1,change:function(a,b){w=b.ch,H.render()}}),$channel.iconSelect("index",w)),$("VAM_ExcludeRegionD").removeClass("fn-hide"),$("calibrate_wrapper").addClass("fn-hide")):$("waterFilter_wrapper").addClass("fn-hide"),m.get("TrackPositionLimit").done(function(a){a&&a.Support&&(G=a.Support,$("ivs_trackLimit").removeClass("fn-hide"),g.ConfigManager.getDefault("IntelliTrackScene").done(function(a){F=a}))}),jQuery.when(m.get("IVSCaps"),m.is("DSPConflict",!0)).then(function(a,b){E=!b&&(webCaps.is_new_IVSUI?!0:webApp.IsIPCIntel)&&a&&(-1!==jQuery.inArray("StereoVision",a.SupportedScene)||-1!==jQuery.inArray("StereoNumber",a.SupportedScene)||-1!==jQuery.inArray("StereoBehavior",a.SupportedScene))})},getTemplate:function(){g.VideoInAnalyse.getTemplateModule("Normal").done(function(a){s=a.Normal,s.SizeFilter.CalibrateBoxs[0].CenterPoint=[0,0]}),g.VideoInAnalyse.getTemplateGlobal().done(function(a){t=a})},translate:function(){},bind:function(){attachLimit($("ipcIntellentNew_isoThresholdUp"),0,255),$("ipcIntellentNew_isoThresholdUp").addEvent("blur",function(){attachLimit($("ipcIntellentNew_isoThresholdDown"),0,$("ipcIntellentNew_isoThresholdUp").value-0)}),$("ipcIntellentNew_isoThresholdDown").addEvent("blur",H._ajustThresholdDown),$("ipcIntellentNew_isoThresholdUp").addEvent("blur",H._ajustThresholdUp),$("ivs_AddScaleArea").addEvents({click:function(){-1!=$("ivs_global_presets").value&&("hidden"==$("ivs_ScaleAreaShow").getStyle("visibility")?(l.SetCalibrateAndRules("CalibrateArea",0,!0),$("ivs_ScaleAreaShow").setStyle("visibility","visible")):remarkDisplay("ivs_global_remark",tl("com.AreaErrorTip"),3e3,1))}}),$("ivs_DeleteScaleArea").addEvent("click",function(){if($("ivs_ScaleAreaCheck").hasClass("scale_current")){$("ivs_ScaleAreaShow").setStyle("visibility","hidden"),$("ivs_ScaleAreaCheck").removeClass("scale_current"),l.SetCalibrateAndRules("CalibrateArea",0,!1),f=null;var a=H._findCalibrateKey();d[0][a]=f,e=$unlink(d),$("ivs_ScaleListShow").empty(),o.empty(),H.disableStaffOperation()}});var a=$("ivs_scaleContent");$("ivs_AddScale").addEvent("click",function(){if(!this.hasClass("ui-button-disabled")){if("hidden"==$("ivs_ScaleAreaShow").getStyle("visibility")||!f)return void remarkDisplay("ivs_global_remark",tl("com.AreaDrawTip"),3e3,1);if(o.indexOf("Horizontal")>-1&&!$("scaleVertical").checked)return void remarkDisplay("ivs_global_remark",tl("com.HorizontalErrorTip"),3e3,1);if(3===o.length&&0===$unlink(o).erase("Vertical").length&&$("scaleVertical").checked||4===o.length)return void remarkDisplay("ivs_global_remark",tl("com.VerticalErrorTip"),3e3,1);if(!f.Staffs&&o.length||f.Staffs&&o.length!=f.Staffs.length)return void remarkDisplay("ivs_global_remark",tl("com.PleaseDrawShapeTip"),3e3,1);var b=$("scaleVertical").checked?"Vertical":"Horizontal",c=0;o.each(function(a){a==b&&c++}),o.push(b),l.SetCalibrateAndRules(b,0,!0),$("ivs_ScaleListShow").getElements("i.scale_bottom_icon").set("class","scale_main_icon"),a.getElements("a").removeClass("scale_current");var d=new Element("span",{name:b});d.innerHTML='<div class="fn-clear scale-region"><i class="scale_bottom_icon"></i><a href="javascript:;" class="scale_current" data-staffIndex="'+(o.length-1)+'" scale-index="'+c+'" data-type="'+b+'">'+tl("ivs."+b)+"</a></div>",d.inject($("ivs_ScaleListShow"))}}),$("ivs_DeleteScale").addEvent("click",function(){if(!this.hasClass("ui-button-disabled")){var b=a.getElement("#ivs_ScaleListShow a.scale_current");if(!b)return void remarkDisplay("ivs_global_remark",tl("com.PleaseSelectStaff"),3e3,1);var c=b.getProperty("data-type"),d=parseInt(b.getProperty("scale-index"),10),e=parseInt(b.getProperty("data-staffIndex"),10);b.getParent("span").destroy(),o.splice(e,1),f.Staffs.splice(e,1),l.SetCalibrateAndRules(c,d,!1);var g=$$("#ivs_ScaleListShow a"),h=$$("#ivs_ScaleListShow span").getProperty("name"),i=0;o.each(function(a,b){var c=0;"Vertical"==h[b]&&(c=i++),g[b].setProperties({"scale-index":c,"data-staffIndex":b})}),$("ivs_ScaleListShow").getLast()&&$("ivs_ScaleListShow").getLast().getElements("i").set("class","scale_bottom_icon")}}),D=jQuery("#scaleLength").numberfield({min:.05,max:10,value:p,allowDecimal:!0,decimalPrecision:3}).blur(function(){var a=this.value-0;.05>=a&&(a=1,this.value=a);var b=$("ivs_ScaleListShow").getElement("a.scale_current");if(b){var c=(b.getProperty("data-staffindex")-0,b.getProperty("data-type"));f.Staffs.each(function(b){b.Type==c&&(b.Length=a)})}}),a.addEvent("click:relay([data-toggle])",function(){var a,b,c=this.getProperty("data-toggle"),d=this.getParent().getNext("span");"fold"==c?(a="visible",b="scale_icon_hide",c="unfold"):(a="hidden",b="scale_icon_show",c="fold"),d.setStyle("visibility",a),$("ivs_ScaleIcon").setProperty("class",b),this.setProperty("data-toggle",c)}),a.addEvent("click:relay(a)",function(){var b=this.getProperty("data-type"),c=null,d=this.getProperty("scale-index")||0;d=parseInt(d),a.getElements("a").removeClass("scale_current"),this.addClass("scale_current"),("Horizontal"==b||"Vertical"==b)&&(c=H.getStaff(b,d),$("ivs_global_staffType").getElement("input[value="+b+"]").checked=!0,c&&($("scaleLength").setProperty("disabled",!1),D.numberfield("value",c.Length))),l.SelectRule(b,d)}),$("ivs_scaleCheck").addEvent("click",function(){return f&&f.Area&&f.Staffs&&4==f.Staffs.length?($$("#ivs_ScaleListShow a").removeClass("scale_current"),scaleCheckNum=$("ivs_scaleValue").value-0,void l.SetCalibrateAndRules("CheckedLength",scaleCheckNum,!0)):void remarkDisplay("ivs_global_remark",tl("com.ScaleAll"),3e3,1)}),$("ivs_global_default").addEvent("click",H._onDefaultClick),$("ivs_global_refresh").addEvent("click",H._onRefreshClick),$("ivs_global_confirm").addEvent("click",H._onConfirmClick),$$("#ipcIntellentNew_tab_Global i[data-link]").addEvent("click",function(){var a=this.getProperty("data-link");jQuery("[data-link="+a+"]").toggleClass("toggle"),jQuery("#"+a).addClass("fn-relative"),jQuery("#"+a).slideToggle("normal",function(){jQuery("#"+a).removeClass("fn-relative")})}),jQuery("#Global_IVSForm").slideUp(),H.sliderInit(),$("VAM_DetectRegion").addEvent("click",H._onParaDetectRegionClick),$("VAM_ExcludeRegion").addEvent("click",H._onParaExcludeRegionClick),$("VAM_ExcludeRegionD").addEvent("click",H._onDelExcludeRegion),H.ocxMode="ParaOrGlobal",$$("#ipcIntellentNew_tab_Global #ivs_scaleContent").addEvent("mouseover",function(){var a="global";if(a&&H.ocxMode!==a)switch(H.ocxMode=a,a){case"para":H._renderModuleOcx();break;case"global":H._renderCalibrateOcx()}}),I.bind(),$("trackLimit_save").addEvent("click",function(){var a=$("ivs_global_presets").value-0,b=this.getPrevious("select").value;g.DevIntelliTracker.markSceneLimit(a,b).done(function(){remarkDisplay("ivs_global_remark",tl("com.OperateSuccessTip"),3e3,0)}).fail(function(){remarkDisplay("ivs_global_remark",tl("com.OperateFailTip"),3e3,1)})}),$("trackLimit_goto").addEvent("click",function(){var a=$("ivs_global_presets").value-0,b=this.getPrevious("select").value;g.DevIntelliTracker.gotoSceneLimit(a,b).done(function(){})}),$("ivs_global_drawTarget1").addEvent("click",function(){var a=($("ivs_global_presets").value-0,curRule.SizeFilter.CalibrateBoxs[0].CenterPoint);if(jQuery.isNumeric(y[0]))return H._displayOCXRule(y[0],!0),void H._displayOCXRule(y[1],!0);if(0===a[0]&&0===a[1]||!curRule.SizeFilter.CalibrateBoxs[1])l.CreateOneIntelShape(v,"DoubleRectangleShape","VideoAnalyzeConfig","DoubleRectangleShape","ViewFilter1","","").done(function(a){y[0]=a});else{var c=b(1,curRule.SizeFilter);if(l.CreateOneIntelShape(v,"DoubleRectangleShape","VideoAnalyzeConfig","DoubleRectangleShape","ViewFilter1",JSON.stringify(c),"").done(function(a){y[0]=a}),curRule.SizeFilter.CalibrateBoxs[1]){var d=curRule.SizeFilter.CalibrateBoxs[1];if(0!==d.CenterPoint[0]&&0!==d.CenterPoint[1]){var e=b(2,curRule.SizeFilter,d);l.CreateOneIntelShape(v,"DoubleRectangleShape","VideoAnalyzeConfig","DoubleRectangleShape","ViewFilter2",JSON.stringify(e),"").done(function(a){y[1]=a}),l.SetOneIntelShapeDisplayColor(y[1],0,255,255,0),l.SetOneIntelShapeThickness(y[1],2),l.SetOneIntelShapeVisible(y[1],!0),l.SelectOneIntelShape(y[1],!0)}}}curRule.SizeFilter.MeasureMode="CalibratedPixel",l.SetOneIntelShapeDisplayColor(y[0],0,255,255,0),l.SetOneIntelShapeThickness(y[0],2),l.SetOneIntelShapeVisible(y[0],!0),l.SelectOneIntelShape(y[0],!0)}),$("ivs_global_drawTarget2").addEvent("click",function(){jQuery.isNumeric(y[1])||(l.CreateOneIntelShape(v,"DoubleRectangleShape","VideoAnalyzeConfig","DoubleRectangleShape","ViewFilter2","","").done(function(a){y[1]=a,c=a}),l.SetOneIntelShapeDisplayColor(c,0,255,255,0),l.SetOneIntelShapeThickness(c,2),l.SetOneIntelShapeVisible(c,!0),l.SelectOneIntelShape(c,!0),l.SelectOneIntelShape(y[0],!1))}),$("ivs_global_clearTargetAll").addEvent("click",function(){$("ivs_global_presets").value-0;l.DeleteOneIntelShape(y[0]),l.DeleteOneIntelShape(y[1]),y[0]=null,y[1]=null,curRule.SizeFilter.CalibrateBoxs[0].CenterPoint=[0,0],curRule.SizeFilter.CalibrateBoxs[1]&&(curRule.SizeFilter.CalibrateBoxs[1].CenterPoint=[0,0],curRule.SizeFilter.CalibrateBoxs[1].Ratio=1)}),jQuery('[name="ivs_global_imageFre"]').on("click",function(a){$("ivs_global_presets").value-0;curRule.SizeFilter.Type=jQuery(a.target).val()})},sliderInit:function(){H.Slider={},H.Slider.OverlapPercent=new FineSlider("Global_IVS_1_slider","Global_IVS_1_knob",{range:[0,100],snap:!0},"Global_IVS_1_tip","Global_IVS_1_add","Global_IVS_1_sub"),H.Slider.DistLimit=new FineSlider("Global_IVS_2_slider","Global_IVS_2_knob",{range:[0,100],snap:!0},"Global_IVS_2_tip","Global_IVS_2_add","Global_IVS_2_sub"),H.Slider.TimeLimit=new FineSlider("Global_IVS_3_slider","Global_IVS_3_knob",{range:[0,100],snap:!0},"Global_IVS_3_tip","Global_IVS_3_add","Global_IVS_3_sub"),H.Slider.VAMSensitivity=new FineSlider("Global_IVS_4_slider","Global_IVS_4_knob",{range:[1,10],snap:!0},"Global_IVS_4_tip","Global_IVS_4_add","Global_IVS_4_sub")},leave:function(){l.addEvent("OutPutStringInfo",null),l.addEvent("VideoAnalyzeConfig",null),l.SetIVSConfig("",0),l.SetIVSConfig("",1),l.hide(),"hls"===webApp.playMode?A.hideAndStopLoad():"flash"===webApp.playMode?B.hide():"h5"===webApp.playMode&&A.hide(),webApp.DeviceType.indexOf("TPC")>-1&&v&&l.RemoveOneIntelShapeContainer(v)},render:function(){"hls"==webApp.playMode?(A.cover(jQuery("#ivs_global_video")),l.hide(),A.init("","",""),A.beginPlay()):"flash"==webApp.playMode?(B.cover(jQuery("#ivs_global_video")),B.playPreview(1,0)):"h5"===webApp.playMode?C.playPreview(1,0,$("#ivs_global_video")):l.cover("#ivs_global_video",function(a){l.SetRegionNum(0),webApp.DeviceType.indexOf("TPC")>-1?(l.SetModuleMode(1),l.SetVisibleVideoWnd(1,w),k.chkAuthority("Monitor_0"+(w+1))&&l.ConnectRealVideoEx(w,w,0),k.chkAuthority("Monitor_0"+(w+1))||l.SetVideoWndTip(w,tl("noVideoAuthoity")),v&&l.RemoveOneIntelShapeContainer(v)):(l.SetModuleMode(2),k.chkAuthority("Monitor_01")&&l.open()),a&&H._onRefreshClick(!1)}),l.addEvent("OutPutStringInfo",function(a,b){switch(a){case"OutPutGlobalCalibrateInfo":H.outPutGlobalCalibrateInfo(b);break;case"OutPutCheckedInfo":H.outPutCheckedInfo(b);break;case"OutPutModuleRect":H.OutPutModuleRect(b)}}),l.addEvent("VideoAnalyzeConfig",function(a){H.OutPutShapeRect(a)});var a=["VideoAnalyseGlobal","VideoAnalyseModule","IntelliTrackScene"];-1!==webApp.DeviceType.indexOf("TPC")&&a.push("ThermoIntelliVideoFilter"),g.ConfigManager.getConfig(a).done(function(a){d=a[0].params.table,a[1].result&&(r=a[1].params.table),a[2]&&a[2].result&&(q=a[2].params.table),a[3]&&a[3].result&&(x=a[3].params.table),e=$unlink(d),H.SD.render()}),m.get("IVSCaps").done(function(a){a&&l.SetMaxPntNum(a.MaxPointOfLine,a.MaxPointOfRegion)})},_renderGlobalElements:function(){if(-1!==webApp.DeviceType.indexOf("TPC")){if(-1!==webApp.DeviceType.indexOf("SD")&&!$("ivs_global_presets").getSelected()[0].hasClass("fn-color-ivsGreen"))return $$("#params_wrapper,#waterFilter_wrapper,#advance_wrapper").addClass("fn-hide"),void remarkDisplay("ivs_global_remark",tl("com.AddSceneFirst"),3e3,1);1!==w&&1!==webApp.CHANNEL_NUMBER||1===webApp.CamType?($$("#params_wrapper,#advance_wrapper").removeClass("fn-hide"),$("waterFilter_wrapper").addClass("fn-hide"),$$("#ivsSdPtzWrap .ptz-adjust").removeClass("fn-hide")):($("waterFilter_wrapper").removeClass("fn-hide"),$$("#params_wrapper,#advance_wrapper").removeClass("fn-hide"),webApp.DeviceType.indexOf("TPC")>-1&&$$("#ivsSdPtzWrap .ptz-adjust").addClass("fn-hide"))}var a=$("ivs_global_presets").value-0;if(H._renderIVS(a),H._renderTrack(a),0!==d.length){var b=H._findCalibrateKey(),c=d[z][b]||[];if(f=c[0]||null,H._renderScale(),$("scaleVertical").checked=!0,-1===webApp.DeviceType.indexOf("SD")&&-1===webApp.DeviceType.indexOf("TPC"))H.ocxMode="global",H._renderCalibrateOcx();else if(webApp.DeviceType.indexOf("TPC")>-1){H._analyseRule(),v=null,l.CreateOneIntelShapeContainer(w,"").done(function(a){v=a});H._renderDetect(),jQuery('[name="ivs_global_imageFre"][value='+curRule.SizeFilter.Type+"]").prop("checked",!0),x&&x[w]&&H._renderISOFilter()}else switch(H.ocxMode){case"para":H._renderModuleOcx();break;case"global":H._renderCalibrateOcx()}}},_findCalibrateKey:function(){var a=$("ivs_global_presets").value-0,b="CalibrateArea";for(var c in d[z])-1!==c.indexOf("Scene")&&d[z][c].PtzPresetId==a&&(b=c.replace("Scene","CalibrateArea"));return b},_renderISOFilter:function(){$("ipcIntellentNew_filter_enable").checked=x[w].Enable,$("ipcIntellentNew_isoThresholdUp").value=x[w].HighThreshold,$("ipcIntellentNew_isoThresholdDown").value=x[w].LowThreshold,attachLimit($("ipcIntellentNew_isoThresholdDown"),0,$("ipcIntellentNew_isoThresholdUp").value-0)},_ajustThresholdDown:function(){this.value-0>$("ipcIntellentNew_isoThresholdUp").value-0&&(this.value=$("ipcIntellentNew_isoThresholdUp").value-0)},_ajustThresholdUp:function(){this.value-0<$("ipcIntellentNew_isoThresholdDown").value-0&&($("ipcIntellentNew_isoThresholdDown").value=this.value-0)},_renderIVS:function(a){if($("VAM_AntiDisturbance_true").checked=!0,$("VAM_Shadow_false").checked=!0,H.Slider.VAMSensitivity.set(s.Sensitivity||5),H.Slider.OverlapPercent.set(t.Scene.Detail.Track.OverlapPercent||0),H.Slider.DistLimit.set(t.Scene.Detail.Track.DistLimit||10),H.Slider.TimeLimit.set(t.Scene.Detail.Track.TimeLimit||10),r&&void 0!=r[w]){for(var b=0;b<r[w].length;b++)if(r[w][b].PtzPresetId==a&&"Normal"==r[w][b].Type){r[w][b].AntiDisturbance===!0?$("VAM_AntiDisturbance_true").checked=!0:$("VAM_AntiDisturbance_false").checked=!0,r[w][b].Shadow===!0?$("VAM_Shadow_true").checked=!0:$("VAM_Shadow_false").checked=!0,H.Slider.VAMSensitivity.set(r[w][b].Sensitivity);break}var c=d[w];for(var e in c)-1!==e.indexOf("Scene")&&c[e].PtzPresetId==a&&c[e].Detail.Track&&(H.Slider.OverlapPercent.set(c[e].Detail.Track.OverlapPercent),H.Slider.DistLimit.set(c[e].Detail.Track.DistLimit),H.Slider.TimeLimit.set(c[e].Detail.Track.TimeLimit))}},_renderTrack:function(){if(q&&q[0]&&q[0].Scene)for(var a=0;a<q[0].Scene.length;a++)if(0===q[0].Scene[a].PresetID){q[0].Scene[a].PositionLimit||(q[0].Scene[a].PositionLimit={}),$("trackLimit_enable").checked=!!q[0].Scene[a].PositionLimit.Enable;break}},_buildAnalyseGlobal:function(a){if("[object Array]"!==Object.prototype.toString.call(a)){var b=[];b.push(a[0]),a=b}var c={result:!0,params:{table:[a]}};h=JSON.stringify(c)},_renderScale:function(){var a=H._findCalibrateKey(),b=d[z][a]||[],c=b[0];if(o.empty(),$("ivs_ScaleListShow").empty(),!c||!c.Area)return $("ivs_ScaleAreaShow").setStyle("visibility","hidden"),void H.disableStaffOperation();$("ivs_ScaleAreaShow").setStyle("visibility","visible"),H.enableStaffOperation();var e="",f=0;c.Staffs&&c.Staffs.each(function(a,b){var c=0;c="Horizontal"==a.Type?0:f++,e+="<span name="+a.Type+'><div class="fn-clear scale-region"><i class="scale_main_icon"></i><a href="javascript:;" data-staffIndex="'+b+'" scale-index="'+c+'" data-type="'+a.Type+'">'+tl("ivs."+a.Type)+"</a></div></span>",o.push(a.Type),"Vertical"==a.Type?(D.numberfield("value",a.Length),i=a.Length):j=a.Length}),$("ivs_ScaleListShow").innerHTML=e,$("ivs_ScaleListShow").getLast().getElements("i").set("class","scale_bottom_icon")},getStaff:function(a,b){var c=f.Staffs;if(c){var d=c.filter(function(b){return b.Type==a});return d[b]}},saveCurrentStaff:function(){var a=$("scaleVertical").checked?"Vertical":"Horizontal";if(f.Staffs){var b=D.numberfield("value");f.Staffs.each(function(c){c.Type===a&&(c.Length=isNaN(b)?p:b)})}},outPutGlobalCalibrateInfo:function(a){var b=H._findCalibrateKey();f=JSON.parse(a);var c=f.Staffs,e=d[z][b]||[];if(c){var g=e[0]||{},h=g.Staffs,i=D.numberfield("value");if(h){if(h.each(function(a,b){c[b]&&(c[b].Length=a.Length)}),h.length<c.length){var j=c[c.length-1].Type;c.each(function(a){a.Type==j&&(a.Length=i)}),$("ivs_ScaleListShow").getElements("a").removeClass("scale_current")}}else c[0].Length=i,$("ivs_ScaleListShow").getElements("a").removeClass("scale_current")}else f.Area.length>0&&H.enableStaffOperation();e[0]=f,d[z][b]=e},outPutCheckedInfo:function(a){var b,c=JSON.parse(a),d=c.CheckedLength[0],e=c.CheckedLength[1];b=0===scaleCheckNum?"Horizontal":"Vertical",g.DevVideoAnalyse.testCalibrateWithScreenPoints(b,d,e).done(function(a){l.GetLength(a.toFixed(2))})},disableStaffOperation:function(){$("ivs_global_staffType").getElements("input[name=scaleLine]").setProperty("disabled",!0),$("scaleLength").disabled=!0,$("scaleLength").value=1,$("ivs_AddScale").addClass("ui-button-disabled"),$("ivs_DeleteScale").addClass("ui-button-disabled")},enableStaffOperation:function(){$("ivs_global_staffType").getElements("input[name=scaleLine]").setProperty("disabled",!1),$("scaleLength").disabled=!1,$("ivs_AddScale").removeClass("ui-button-disabled"),$("ivs_DeleteScale").removeClass("ui-button-disabled")},_onDefaultClick:function(){var a=$("ivs_global_presets").value-0;for(var b in d[w])if(-1!==b.indexOf("Scene")&&d[w][b].PtzPresetId==a){var c=b.replace("Scene","CalibrateArea");if(E){var e=d[w][c];e&&e.each(function(a,b){a&&(!a.Method||a.Method&&"Scene"===a.Method)&&(e[b]=null)})}else d[w][c]=null;d[w][b].Detail.Track=jQuery.extend(!0,{},t.Scene.Detail.Track);break}for(var f=0;f<r[w].length;f++)if(r[w][f].PtzPresetId==a&&"Normal"==r[w][f].Type){for(var h in s)"PtzPresetId"!==h&&"Type"!==h&&(r[w][f][h]=$unlink(s[h]),r[w][f].ExcludeRegion&&r[w][f].ExcludeRegion.empty());break}if(G)for(var f=0;f<q[0].Scene.length;f++)if(0===q[0].Scene[f].PresetID){q[0].Scene[f].PositionLimit=F[0].Scene[f].PositionLimit,$("trackLimit_enable").checked=!!q[0].Scene[f].PositionLimit.Enable;break}-1!==webApp.DeviceType.indexOf("TPC")?g.ConfigManager.getDefault("ThermoIntelliVideoFilter").done(function(a){x=a,curRule.SizeFilter.CalibrateBoxs[0].CenterPoint=[0,0],H._renderGlobalElements(0),remarkDisplay("ivs_global_remark",tl("com.DefaultSuccessTip"),3e3,0)}):(remarkDisplay("ivs_global_remark",tl("com.DefaultSuccessTip"),3e3,0),H._renderGlobalElements(0))},_saveGlobalScale:function(){f&&H.saveCurrentStaff()},_saveIVS:function(a){for(var b=0;b<r[w].length;b++)if(r[w][b].PtzPresetId==a&&"Normal"==r[w][b].Type){r[w][b].AntiDisturbance=$("VAM_AntiDisturbance_true").checked,r[w][b].Shadow=$("VAM_Shadow_true").checked,r[w][b].Sensitivity=$("Global_IVS_4_slider").getProperty("title")-0;break}var c=d[w];for(var e in c)-1!==e.indexOf("Scene")&&c[e].PtzPresetId==a&&c[e].Detail.Track&&(c[e].Detail.Track.OverlapPercent=$("Global_IVS_1_slider").getProperty("title")-0,c[e].Detail.Track.DistLimit=$("Global_IVS_2_slider").getProperty("title")-0,c[e].Detail.Track.TimeLimit=$("Global_IVS_3_slider").getProperty("title")-0)},_saveTrack:function(){if(q&&q[0]&&q[0].Scene)for(var a=0;a<q[0].Scene.length;a++)if(0===q[0].Scene[a].PresetID){q[0].Scene[a].PositionLimit||(q[0].Scene[a].PositionLimit={}),q[0].Scene[a].PositionLimit.Enable=$("trackLimit_enable").checked;break}},_onRefreshClick:function(a){var b=["VideoAnalyseGlobal","VideoAnalyseModule","IntelliTrackScene"];x&&b.push("ThermoIntelliVideoFilter"),g.ConfigManager.getConfig(b).done(function(b){n.chkMutilCallRet(b,!0)?(d=b[0].params.table,e=$unlink(d),b[1].result&&(r=b[1].params.table),b[2]&&b[2].result&&(q=b[2].params.table),b[3]&&b[3].result&&(x=b[3].params.table),H._renderGlobalElements(0),a!==!1&&remarkDisplay("ivs_global_remark",tl("com.OperateSuccessTip"),3e3,0)):remarkDisplay("ivs_global_remark",tl("com.OperateFailTip"),3e3,1)
})},_onConfirmClick:function(){var a=f&&f.Area&&f.Staffs&&4==f.Staffs.length;if(!a&&f)return void remarkDisplay("ivs_global_remark",tl("com.ScaleAll"),3e3,1);if("visible"==$("ivs_ScaleAreaShow").getStyle("visibility")&&$$("#ivs_ScaleListShow span").length<4)return void remarkDisplay("ivs_global_remark",tl("com.AreaDrawTip"),3e3,1);H._saveGlobalScale();var b=$("ivs_global_presets").value-0;H._saveIVS(b),x&&x[w]&&(x[w].Enable=$("ipcIntellentNew_filter_enable").checked,x[w].HighThreshold=$("ipcIntellentNew_isoThresholdUp").value-0,x[w].LowThreshold=$("ipcIntellentNew_isoThresholdDown").value-0);var c=["VideoAnalyseGlobal","VideoAnalyseModule"],h=[d,r],i=jQuery.Deferred();x&&(c.push("ThermoIntelliVideoFilter"),h.push(x)),q?ITS=g.ConfigManager.getConfig("IntelliTrackScene").done(function(a){q=a,H._saveTrack(b),c.push("IntelliTrackScene"),h.push(q),i.resolve()}):i.reject(),jQuery.when(i).always(function(){g.ConfigManager.setConfig(c,h).done(function(a){n.chkMutilCallRet(a)?(e=$unlink(d),remarkDisplay("ivs_global_remark",tl("com.SaveSuccessTip"),3e3,0),webApp.isNeedReboot(a)&&webApp.reboot("com.ConfEffectRestartTip")):remarkDisplay("ivs_global_remark",tl("com.IvsGlobalSaveTip"),3e3,1)})})},_renderCalibrateOcx:function(){if(d.length){var a=H._findCalibrateKey(),b=d[z][a]||[];H._buildAnalyseGlobal(b),l.SetIVSConfig(h,0),l.SubVideoWndCtrl(12,1)}},_clearCalibrateOcx:function(){l.SetIVSConfig("",0)},_bulidModuleJson:function(){for(var a=$("ivs_global_presets").value-0,b={result:!0,params:{table:[[{DetectRegion:null,ExcludeRegion:null,PtzPresetId:0}]]}},c=0;c<r[w].length;c++)if(r[w][c].PtzPresetId===a&&"Normal"===r[w][c].Type){b.params.table[0][0].DetectRegion=r[w][c].DetectRegion,b.params.table[0][0].ExcludeRegion=r[w][c].ExcludeRegion||"";break}return JSON.stringify(b)},_renderModuleOcx:function(){var a=($("ivs_global_presets").value-0,H._bulidModuleJson());l.SetIVSConfig(a,1),l.AddShape(1,"","",2,0),l.SetCurModule(0)},_clearModuleOcx:function(){l.SetIVSConfig("",1)},_onParaDetectRegionClick:function(){webApp.DeviceType.indexOf("TPC")>-1?(c&&(l.DeleteOneIntelShape(c),c=null,curRule&&0!==curRule.length&&(curRule.DetectRegion.empty(),u.each(function(a){l.DeleteOneIntelShape(a)}),u.empty(),curRule.ExcludeRegion&&curRule.ExcludeRegion.empty())),name=tl("ivs.DetectRegion"),l.CreateOneIntelShape(v,"Polygon","VideoAnalyzeConfig","Polygon",name,"","").done(function(a){c=a}),l.SetOneIntelShapeThickness(c,2),l.SetOneIntelShapeDisplayColor(c,0,255,255,0),l.SetOneIntelShapeDisplayColor(c,1,0,0,255)):("para"!==H.ocxMode&&(H.ocxMode="para",H._renderModuleOcx()),l.AddDetectionRegion("",0))},_onParaExcludeRegionClick:function(){if(webApp.DeviceType.indexOf("TPC")>-1){if(!c)return void remarkDisplay("ivs_global_remark",tl("com.AddDetectRegionFirst"),3e3,1);var a,b;if(u.length>9)return void remarkDisplay("ivs_global_remark",tl("com.MaxRules10"),3e3,1);curRule&&!curRule.ExcludeRegion?b=tl("ivs.ExcludeRegion")+1:(u.each(function(a){l.SelectOneIntelShape(a,!1)}),b=tl("ivs.ExcludeRegion")+(curRule.ExcludeRegion.length+1)),l.CreateOneIntelShape(v,"Polygon","VideoAnalyzeConfig","Polygon",b,"","").done(function(b){a=b}),u.push(a),l.SetOneIntelShapeThickness(a,2),l.SetOneIntelShapeDisplayColor(a,0,0,255,255),l.SetOneIntelShapeDisplayColor(a,1,0,255,255),l.SelectOneIntelShape(a,!0)}else"para"!==H.ocxMode&&(H.ocxMode="para",H._renderModuleOcx()),l.AddExcludeRegion("",0)},OutPutModuleRect:function(a){for(var b=$("ivs_global_presets").value-0,c=JSON.parse(a),d=0;d<r[w].length;d++)if(r[w][d].PtzPresetId===b&&"Normal"===r[w][d].Type){r[w][d].DetectRegion=c.DetectRegion,r[w][d].ExcludeRegion=c.ExcludeRegion;break}},_analyseRule:function(){var a=$("ivs_global_presets").value-0;r?r[w]?(curRule=r[w].filter(function(b){return b.PtzPresetId==a})[0],curRule||(curRule=$unlink(s),curRule.PtzPresetId=a,r[w].push(curRule))):(curRule=$unlink(s),curRule.PtzPresetId=a,r[w]=[],r[w].push(curRule)):(r=[[],[]],curRule=$unlink(s),curRule.PtzPresetId=a,r[w].push(curRule))},_renderDetect:function(){if(0!==curRule.length&&null!==curRule){var a=curRule.DetectRegion;if(0!=a[0]||0!=a[1]||0!=a[2]||0!=a[3]){a&&a.length>0?(info={Polygon:a},info=JSON.stringify(info)):info="";var b=tl("ivs.DetectRegion");l.CreateOneIntelShape(v,"Polygon","VideoAnalyzeConfig","Polygon",b,info,"").done(function(a){c=a}),l.SetOneIntelShapeThickness(c,2),l.SetOneIntelShapeDisplayColor(c,0,255,255,0),l.SetOneIntelShapeDisplayColor(c,1,0,0,255),u=[],curRule.ExcludeRegion&&0!==curRule.ExcludeRegion.length&&curRule.ExcludeRegion.each(function(a,b){if(0!=a[0]||0!=a[1]||0!=a[2]||0!=a[3]){a&&a.length>0?(info={Polygon:a},info=JSON.stringify(info)):info="";var c,d=tl("ivs.ExcludeRegion")+(b+1);l.CreateOneIntelShape(v,"Polygon","VideoAnalyzeConfig","Polygon",d,info,"").done(function(a){c=a}),u[b]=c,l.SetOneIntelShapeThickness(c,2),l.SetOneIntelShapeDisplayColor(c,0,255,255,0),l.SetOneIntelShapeDisplayColor(c,1,0,255,255),l.SelectOneIntelShape(c,!1)}})}}},_onDelExcludeRegion:function(){u.length>0&&(l.DeleteOneIntelShape(u[u.length-1]),u.erase(u[u.length-1]),curRule.ExcludeRegion.erase(curRule.ExcludeRegion[curRule.ExcludeRegion.length-1]))},OutPutShapeRect:function(b){var d=JSON.parse(b);if("DoubleRectangleShape"===d.EventParam.ShapeID){{var e=null;$("ivs_global_presets").value-0}d.EventParam.ObjectID===y[0]?(e=a(d.ShapeData),curRule.SizeFilter.CalibrateBoxs[0].CenterPoint=e[0],curRule.SizeFilter.MaxSize=e[1],curRule.SizeFilter.MinSize=e[2],curRule.SizeFilter.CalibrateBoxs.Ratio=e[3]):(e=a(d.ShapeData,curRule.SizeFilter.MaxSize),e?curRule.SizeFilter.CalibrateBoxs[1]?(curRule.SizeFilter.CalibrateBoxs[1].CenterPoint=e[0],curRule.SizeFilter.CalibrateBoxs[1].Ratio=e[3]):curRule.SizeFilter.CalibrateBoxs.push({CenterPoint:e[0],Ratio:e[3]}):remarkDisplay("ivs_global_remark",tl("com.drawTargetFailed"),3e3,1))}else d.EventParam.ObjectID==c?curRule.DetectRegion=d.ShapeData.DetectLine:u.each(function(a,b){a==d.EventParam.ObjectID&&(curRule.ExcludeRegion||(curRule.ExcludeRegion=[]),curRule.ExcludeRegion[b]=d.ShapeData.DetectLine)})}},I=H.SD={bind:function(){$("ivs_global_presets").addEvent("change",function(){var a=this.value-0,b=this.getSelected()[0];b&&b.hasClass("fn-color-ivsGreen")?this.addClass("fn-color-ivsGreen"):this.removeClass("fn-color-ivsGreen"),-1===webApp.DeviceType.indexOf("SD")||webApp.NoIntelliPreset?H._renderGlobalElements():g.PTZ.gotoPreset(a).always(function(){H._renderGlobalElements()})})},render:function(){this.getPresets(function(){$("ivs_global_presets").fireEvent("change")})},getPresets:function(a){var b=$("ivs_global_presets");return-1===webApp.DeviceType.indexOf("SD")||webApp.NoIntelliPreset?($("ivs_global_presets_wrap").addClass("fn-hide"),b.empty(),b.options.add(new Option(tl("com.AddPresetFirstTip"),0)),void(a&&a())):void g.PTZ.getPresets().done(function(c){var e=c||[];if(b.empty(),0===e.length)b.options.add(new Option(tl("com.AddPlanFirstTip"),-1)),remarkDisplay("ivs_global_remark",tl("com.AddPlanFirstTip"),4e3,2);else if(-1===webApp.DeviceType.indexOf("TPC")){for(var f=[],h=0;h<e.length;h++){var i=new Option(e[h].Name,e[h].Index);$(i).setProperty("title",tl("ivs.Preset")+e[h].Index),1===e[h].Type?($(i).addClass("fn-color-ivsGreen"),b.options.add(i)):($(i).addClass("fn-color-black"),f.push(i))}f.each(function(a){b.options.add(a)})}else{for(var j=0;j<e.length;j++){var k=new Option(e[j].Name,e[j].Index);$(k).setProperty("title",tl("ivs.Preset")+e[j].Index),b.options.add(k),$(k).addClass("fn-color-black")}for(var l in d[w])if(l.indexOf("Scene")>-1){var m=d[w][l].PtzPresetId;jQuery("#ivs_global_presets").find('[value="'+m+'"]').removeClass("fn-color-black").addClass("fn-color-ivsGreen")}}g.ConfigManager.getConfig("PtzMovement").done(function(a){if("Preset"==a[0].Function){b.value=a[0].Index+1;var c=b.getSelected()[0];c&&c.hasClass("fn-color-ivsGreen")?b.addClass("fn-color-ivsGreen"):b.removeClass("fn-color-ivsGreen"),b.selectedIndex<0&&(b.selectedIndex=0)}}).always(function(){a&&a()})}).fail(function(){$("ivs_global_presets_wrap").addClass("fn-hide"),b.empty(),b.options.add(new Option(tl("com.AddPresetFirstTip"),0)),a&&a()})}}}(),function(){Page.ivsConfig.Tab.CrossLineDetection={render:function(){$("ipcIntellentNew_ruleDirectionWrap").setStyle("display","")},leave:function(){Page.ivsConfig.Tab["public"].leave()}}}(),function(){Page.ivsConfig.Tab.CrossRegionDetection={render:function(){$("ipcIntellentNew_ruleDirectionWrap2").setStyle("display",""),-1!==webApp.DeviceType.indexOf("TPC")?$("ipcIntellentNew_RegionRule").setStyle("display",""):$("ipcIntellentNew_actionWrap").setStyle("display","")},leave:function(){Page.ivsConfig.Tab["public"].leave()}}}(),function(){Page.ivsConfig.Tab.LeftDetection={render:function(){$("ipcIntellentNew_minDuration_wrap").setStyle("display",""),$("ipcIntellentNew_RuleType_wrap").setStyle("display","")},leave:function(){Page.ivsConfig.Tab["public"].leave()}}}(),function(){Page.ivsConfig.Tab.TakenAwayDetection={render:function(){$("ipcIntellentNew_minDuration_wrap").setStyle("display","")},leave:function(){Page.ivsConfig.Tab["public"].leave()}}}(),function(){Page.ivsConfig.Tab.VideoAbnormalDetection={render:function(){},leave:function(){Page.ivsConfig.Tab["public"].leave()}}}(),function(){Page.ivsConfig.Tab.WanderDetection={render:function(){$("ipcIntellentNew_minDuration_wrap").setStyle("display",""),$("ipcIntellentNew_RuleType_wrap").setStyle("display","none")},leave:function(){Page.ivsConfig.Tab["public"].leave()}}}(),function(){Page.ivsConfig.Tab.RioterDetection={render:function(){$("ipcIntellentNew_minDuration_wrap").setStyle("display",""),$("ipcIntellentNew_RuleType_wrap").setStyle("display","none"),$("ipcIntellentNew_SensitivityWrap").setStyle("display",""),$("ipcIntellentNew_target_label").set("text",tl("ivs.MinGatherRegion")),$("ipcIntellentNew_object_filter_ck").setStyle("display","none")},leave:function(){Page.ivsConfig.Tab["public"].leave()}}}(),function(){Page.ivsConfig.Tab.MoveDetection={render:function(){$("ipcIntellentNew_RuleType_wrap").setStyle("display","none"),$("ipcIntellentNew_SensitivityWrap").setStyle("display","")},leave:function(){Page.ivsConfig.Tab["public"].leave()}}}(),function(){Page.ivsConfig.Tab.RetrogradeDetection={render:function(){$("ipcIntellentNew_SensitivityWrap").setStyle("display",""),$("ipcIntellentNew_drawDirection_wrap").setStyle("display","")},leave:function(){Page.ivsConfig.Tab["public"].leave()}}}(),function(){Page.ivsConfig.Tab.CrossFenceDetection={render:function(){$("ipcIntellentNew_fenceDirection_wrap").removeClass("fn-hide")},leave:function(){$("ipcIntellentNew_fenceDirection_wrap").addClass("fn-hide"),Page.ivsConfig.Tab["public"].leave()}}}(),function(){Page.ivsConfig.Tab.ParkingDetection={render:function(){$("ipcIntellentNew_minDuration_wrap").setStyle("display","")},leave:function(){Page.ivsConfig.Tab["public"].leave()}}}(),function(){Page.ivsConfig.Tab.ClimbDetection={render:function(){$("ipcIntellentNew_ruleDirectionWrap").setStyle("display","none")},leave:function(){Page.ivsConfig.Tab["public"].leave()}}}(),function(){Page.ivsConfig.Tab.PrisonerRiseDetection={render:function(){$("ipcIntellentNew_minDuration_wrap").setStyle("display",""),$("ipcIntellentNew_drawDirection_wrap1").setStyle("display",""),$("ipcIntellentNew_drawDirection_wrap2").setStyle("display","")},leave:function(){Page.ivsConfig.Tab["public"].leave()}}}(),function(){Page.ivsConfig.Tab.LeaveDetection={render:function(){$("ipcIntellentNew_minDuration_wrap").setStyle("display","")},leave:function(){Page.ivsConfig.Tab["public"].leave()}}}(),function(){function d(a,b,c){function d(){for(var a,d=this.value,e=0,f=0,g=d.length;g>f&&(a=d.charCodeAt(f),e+=127>=a?b.asciiByte||1:b.notAsciiByte||3,!(e>b.maxByte));f++);e>b.maxByte&&(this.value=d.slice(0,f),c&&c())}b=b||{},b.maxlength&&a.setProperty("maxLength",b.maxlength),a.addEvent("keyup",d),a.addEvent("blur",d)}{var i,j,n,r={MaxRect:[8191,8191],MinRect:[0,0]},v=!1,x=!1,C=0,E={},F=null,G=10,H=10,I=require("jsCore/hlsplayer"),J=require("jsCore/flashplayer"),K=require("jsCore/h5player"),L=null,M=0,N=null,O=null,P=null,Q=[],R=null,S=!1,T=null,U=[],V=Page.ivsConfig.Tab["public"]={init:function(){F=$("ipcIntellentNew_ruleManager"),V.translate(),V.bind(),E=new FineSlider("ipcIntellentNew_Sensitivity_slider","ipcIntellentNew_Sensitivity_knob",{range:[1,10],snap:!0},"ipcIntellentNew_Sensitivity_tip","ipcIntellentNew_Sensitivity_add","ipcIntellentNew_Sensitivity_sub"),jQuery("#ivs_ObjectSize").slider({min:10,max:100,prompt:!1,complete:function(a,b){V._saveCalibrate(b.value),jQuery("#ivs_ObjectSize_val").numberfield("value",b.value)}}),jQuery("#ivs_ObjectSize_val").numberfield({min:10,max:100,allowDecimal:!1,allowNegative:!1}).change(function(){V._saveCalibrate(jQuery("#ivs_ObjectSize_val").numberfield("value")),jQuery("#ivs_ObjectSize").slider("value",jQuery("#ivs_ObjectSize_val").numberfield("value"))}),m.get("IVSCaps").done(function(a){G=a.MaxRules||10,H=a.SupportedScenes.Normal.MaxRules||10;var b=void 0!==a.LinkPtzSupport?a.LinkPtzSupport:webApp.HasPtz;if(webApp.EventCaps){for(var c=[],d=webApp.EventCaps,e={},j=jQuery.extend({},webApp.DefaultEvent),k=Math.ceil(t.length/8),m=[],n=[],o=0;k>o;o++)n[o]=t.slice(8*o,8*(o+1)),m.push(g.EventManager.getEventLink(n[o]));jQuery.when.apply(null,m).done(function(){for(var a=0;k>a;a++){var b=n[a],g=arguments[a].name;b.each(function(a,b){var d=g[b];e[a]=d,c.combine(d)})}c.indexOf("default")>-1?(j=d,c.length=0,$each(j,function(a,b){a&&"boolean"==typeof a&&c.push(b)})):c.each(function(a){j[a]=!0,"AlarmOutEnable"===a?j.AlarmOutLatch=d.AlarmOutLatch:"DejitterEnable"===a?j.DejitterRange=d.DejitterRange:"RecordEnable"===a&&(j.RecordLatch=d.RecordLatch)}),$each(e,function(a,b){var d=[];"default"==a[0]||c.length==a.length?a.length=0:(c.each(function(b){a.indexOf(b)<0&&d.push(b)}),e[b]=d)}),V.eventHandler=new f("#ipcIntellentNew_eventHandler",j)}).fail(function(){V.eventHandler=new f("#ipcIntellentNew_eventHandler",{PtzLinkEnable:b})}).always(function(){jQuery("#page_ivsConfig #ala_pir_time").off("click").on("click",function(){l.hide();var a=V._findIndexNow(),b=i[M][a];h.open(b.EventHandler.LightingLink.WhiteLightTimeSection,{title:"com.Period"}).done(function(a){b.EventHandler.LightingLink.WhiteLightTimeSection=a}).always(function(){"hls"!=webApp.playMode&&"flash"!=webApp.playMode&&"h5"!=webApp.playMode&&l.cover("#ipcintellentNewVideo")})})})}else V.eventHandler=new f("#ipcIntellentNew_eventHandler",{PtzLinkEnable:b})}),g.VideoInAnalyse.getTemplateGlobal().done(function(a){n=a}),webApp.DeviceType.indexOf("TPC")>-1&&webApp.CHANNEL_NUMBER>1&&($("ipcIntellentNew_channel").getParent().removeClass("fn-hide"),$("ipcIntellentNew_channel").getParent().getNext("div").removeClass("fn-hide"),L=jQuery("#ipcIntellentNew_channel").iconSelect({channelNumber:webApp.CHANNEL_NUMBER,allEnable:!1,change:function(a,b){M=b.ch,V.render()}}),L.iconSelect("index",M))},translate:function(){$("ipcIntellentNew_drawDirection1").set("text",tl("ivs.DrawDirection")+1),$("ipcIntellentNew_drawDirection2").set("text",tl("ivs.DrawDirection")+2)},render:function(){-1!==webApp.DeviceType.indexOf("TPC")&&-1===webApp.DeviceType.indexOf("SD")&&($("ipcIntellentNew_rebuild").style.display=""),$("ipcIntellentNew_left").setStyle("display","block"),$("ipcIntellentNew_VideoAbnormalDetection").getChildren().setStyle("margin-left","470px"),V._disabledDraw(!1),"hls"==webApp.playMode?(I.cover(jQuery("#ipcintellentNewVideo")),jQuery("#ivs_emptyDraw_container").hide(),l.hide(),I.init("","",""),I.beginPlay()):"flash"==webApp.playMode?(J.cover(jQuery("#ipcintellentNewVideo")),jQuery("#ivs_emptyDraw_container").hide(),l.hide(),J.playPreview(1,0)):"h5"===webApp.playMode?(jQuery("#ivs_emptyDraw_container").hide(),l.hide(),K.playPreview(1,0,$("#ipcintellentNewVideo"))):(l.cover("#ipcintellentNewVideo",function(a){l.SetRegionNum(0),-1!==webApp.DeviceType.indexOf("TPC")?(l.SetModuleMode(1),l.SetVisibleVideoWnd(1,M),k.chkAuthority("Monitor_0"+(M+1))&&l.ConnectRealVideoEx(M,M,0),k.chkAuthority("Monitor_0"+(M+1))||l.SetVideoWndTip(M,tl("noVideoAuthoity"))):(l.SetRegionNum(0),l.SetModuleMode(2),k.chkAuthority("Monitor_01")&&l.open()),a&&V._onRefreshClick(!1)}),jQuery("#ivs_emptyDraw_container").show()),l.addEvent("OutPutStringInfo",function(a,b){var c=JSON.parse(b);switch(a){case"OutPutShapeRect":V.outPutShapeRect(b);break;case"OutPutObjectRect":webCaps.is_show_PixelCounter&&c.rect1?(A.width=c.rect1[0],A.height=c.rect1[1],jQuery("#ipcIntellentNew_left").find("[name=DetectSize-0]").numberfield("value",A.width),jQuery("#ipcIntellentNew_left").find("[name=DetectSize-1]").numberfield("value",A.height)):V.setFilterValue(b);break;case"OutPutRuleRect":V.outPutRuleRect(b)}}),l.addEvent("VideoAnalyzeConfig",function(a){V.outPutShapeRect(a)}),webCaps.is_show_PixelCounter&&(jQuery("#ivs_detect").parent("div").show(),jQuery("#ipcIntellentNew_left").find("[name=DetectSize-0]").numberfield({min:0,max:webApp.resolution.x,allowDecimal:!0,allowNegative:!1}),jQuery("[name=DetectSize-1]").numberfield({min:0,max:webApp.resolution.y,allowDecimal:!0,allowNegative:!1}),l.addEvent("ResolutionChangeIvs",function(){jQuery("#ipcIntellentNew_left").find("[name=DetectSize-0]").numberfield({min:0,max:webApp.resolution.x,allowDecimal:!0,allowNegative:!1}),jQuery("#ipcIntellentNew_left").find("[name=DetectSize-1]").numberfield({min:0,max:webApp.resolution.y,allowDecimal:!0,allowNegative:!1}),jQuery("#ipcIntellentNew_left").find("input[name=DetectSize-0]").trigger("change"),jQuery("#ipcIntellentNew_left").find("input[name=DetectSize-1]").trigger("change")})),i=$unlink(c),webApp.DeviceType.indexOf("TPC")>-1?g.ConfigManager.getConfig("VideoAnalyseGlobal").done(function(a){R=a,V.SD.render()}):V.SD.render()},renderMinDuration:function(a){var b=s[a]||[1,600];attachLimit("ipcIntellentNew_minDuration",b[0],b[1]),$("ipcIntellentNew_minDurationTip").set("text","("+b[0]+"~"+b[1]+")")},_saveCalibrate:function(a){var b=!1,c=$("ipcIntellentNew_presets").value-0;p[M].each(function(d,e){d.PtzPresetID===c&&(p[M][e].CalibrateArea[0].ObjectScale=a,p[M][e].CalibrateArea[0].Method="Scale",b=!0)}),b||(q.CalibrateArea[0].ObjectScale=a,q.CalibrateArea[0].Method="Scale",q.PtzPresetID=c,p[M].push(q))},bind:function(){function a(){var a=this.getProperty("data-index"),b=i[M][a];b.Enable=this.checked;var c=F.getElements("[data-input]");$("ipcIntellentNew_allRuleEnable").checked=!0;for(var d=0;d<c.length;d++)c[d].checked===!1&&($("ipcIntellentNew_allRuleEnable").checked=!1)}function c(){var a=F.getElement(".current");a&&V._saveElements(),this.getSiblings().removeClass("current"),this.addClass("current");var b=this.getProperty("data-index")-0,c=i[M][b].Type;V._renderRuleDom(c),V._changeRule(b),V.renderMinDuration(c)}V.SD.bind(),$("ipcIntellentNew_default1").addEvent("click",V._onDefaultClick),$("ipcIntellentNew_refresh1").addEvent("click",V._onRefreshClick),$("ipcIntellentNew_confirm1").addEvent("click",V._onConfirmClick),$("ipcIntellentNew_setButton1").addEvent("click",V._onSetupClick),$("ivs_draw_detect").addEvent("click",V._onDetectClick),$("ipcIntellentNew_RegionRuleType").addEvent("change",V._changeRuleType),attachLimit("ipcIntellentNew_TrackTime",5,300),V._attachLimitCompare("ipcIntellentNew_MinTargets","ipcIntellentNew_MaxTargets",1,100,!0),V._attachLimitCompare("ipcIntellentNew_MaxTargets","ipcIntellentNew_MinTargets",1,100,!1),attachLimit("ipcIntellentNew_ReportInterval",0,600),$("ipcIntellentNew_drawRule").addEvent("click",function(){V._drawRuleType(!1)}),$("ipcIntellentNew_rebuild").addEvent("click",function(){V._rebuild(M)}),$("ipcIntellentNew_clearRule").addEvent("click",function(){webCaps.is_show_PixelCounter&&l.DeleteShape("rect1");var a=V._findIndexNow(),b=i[M][a];if(v)return void remarkDisplay("ipcIntellentNew_remark1",tl("com.PleaseDrawShapeTip"),3e3,1);var c="";switch(b.Type){case"CrossLineDetection":case"ClimbDetection":c="DetectLine";break;case"CrossRegionDetection":case"LeaveDetection":c="DetectRegion";break;case"PrisonerRiseDetection":c="PrisonerRiseDetection";break;case"WanderDetection":case"MoveDetection":case"RioterDetection":case"LeftDetection":case"TakenAwayDetection":c="DetectRegion";break;case"VideoAbnormalDetection":c="DetectLine";break;case"CrossFenceDetection":c="UpstairsLine";break;default:c="DetectRegion"}"DetectLine"==c?b.Config[c]=[[0,0],[0,0]]:"DetectRegion"==c?b.Config[c]=[[0,0],[0,0],[0,0],[0,0]]:"UpstairsLine"==c?(b.Config.UpstairsLine=[[0,0],[0,0]],b.Config.DownstairsLine=[[0,0],[0,0]]):"PrisonerRiseDetection"===c&&(b.Config.Direction=[[0,0],[0,0]],b.Config.BedMiddleLine=[[0,0],[0,0]],b.Config.DetectRegion=[[0,0],[0,0],[0,0],[0,0]]),V._buildRuleJson(),"PrisonerRiseDetection"===c?(l.DeleteShape(b.Name),l.DeleteShape(b.Name+"_dir1"),l.DeleteShape(b.Name+"_dir2")):l.DeleteShape(b.Name),V._drawRuleType(!0),V._renderRule()}),$("ipcIntellentNew_drawDirection").addEvent("click",function(){var a=V._findIndexNow(),b=i[analyseSenceRuleMap.Normal][a],c=b.Name+"_dir",d=-1,e=0;return b.Config&&b.Config.Direction?(l.SetCurShape(c),void l.SelectRule(c,-1)):void l.AddShape(2,"RetrogradeDetection",c,d,e)}),$("ipcIntellentNew_clearDirection").addEvent("click",function(){var a=V._findIndexNow(),b=i[analyseSenceRuleMap.Normal][a],c=b.Name+"_dir";return v?void remarkDisplay("ipcIntellentNew_remark1",tl("com.PleaseDrawShapeTip"),3e3,1):(b.Config.Direction=null,V._buildRuleJson(),l.DeleteShape(c),v=!0,void V._renderRule())}),$("ipcIntellentNew_drawDirection1").addEvent("click",function(){var a=V._findIndexNow(),b=i[analyseSenceRuleMap.Normal][a],c=b.Name+"_dir1",d=-1,e=0;if(b.Config.Direction){if(0!==b.Config.Direction[0][0]||0!==b.Config.Direction[0][1]||0!==b.Config.Direction[1][0]||0!==b.Config.Direction[1][1])return void l.SetCurShape(c);l.AddShape(2,"PrisonerRiseDetection",c,d,e)}}),$("ipcIntellentNew_clearDirection1").addEvent("click",function(){var a=V._findIndexNow(),b=i[analyseSenceRuleMap.Normal][a],c=b.Name+"_dir1",d=-1,e=0;return v?void remarkDisplay("ipcIntellentNew_remark1",tl("com.PleaseDrawShapeTip"),3e3,1):(b.Config.Direction=[[0,0],[0,0]],V._buildRuleJson(),l.SetCurShape(c),l.DeleteShape(c),l.AddShape(2,"PrisonerRiseDetection",c,d,e),void V._renderRule())}),$("ipcIntellentNew_drawDirection2").addEvent("click",function(){var a=V._findIndexNow(),b=i[analyseSenceRuleMap.Normal][a],c=b.Name+"_dir2",d=-1,e=0;if(b.Config.BedMiddleLine){if(0!=b.Config.BedMiddleLine[0][0]||0!=b.Config.BedMiddleLine[0][1]||0!=b.Config.BedMiddleLine[1][0]||0!=b.Config.BedMiddleLine[1][1])return void l.SetCurShape(c);l.AddShape(2,"PrisonerRiseDetection",c,d,e)}}),$("ipcIntellentNew_clearDirection2").addEvent("click",function(){var a=V._findIndexNow(),b=i[analyseSenceRuleMap.Normal][a],c=b.Name+"_dir2",d=-1,e=0;return v?void remarkDisplay("ipcIntellentNew_remark1",tl("com.PleaseDrawShapeTip"),3e3,1):(b.Config.BedMiddleLine=[[0,0],[0,0]],V._buildRuleJson(),l.SetCurShape(c),l.DeleteShape(c),l.AddShape(2,"PrisonerRiseDetection",c,d,e),void V._renderRule())}),$("ipcIntellentNew_NumberSelect").addEvent("change",V._changeRule),attachLimit("ipcIntellentNew_minDuration",1,600),$("ipcIntellentNew_ruleDirection").addEvent("change",function(){var a=V._findIndexNow(),b=i[M][a];b.Config.Direction=this.value,V._changeDiection()}),$("ipcIntellentNew_ruleDirection2").addEvent("change",function(){var a=V._findIndexNow(),b=i[M][a];b.Config.Direction=this.value,V._changeDiection()}),$("ipcIntellentNew_fenceDirection").addEvent("change",function(){var a=V._findIndexNow(),b=i[M][a];b.Config.Direction=this.value,V._changeDiection()}),$("ipcIntellentNew_drawTarget").addEvent("click",function(){var a=V._findIndexNow(),b=i[M][a];if(v)return void remarkDisplay("ipcIntellentNew_remark1",tl("com.PleaseDrawShapeTip"),3e3,1);if(webApp.DeviceType.indexOf("TPC")>-1)V._displayOCXRule(O,!1),P?null==Q[0]&&null==Q[1]?(P=null,V._drawOCXFilter("BigSmallFilterBox",b)):Q[0]&&null==Q[1]?V._drawOCXFilter("BigFilter",b):Q[1]&&null==Q[0]?V._drawOCXFilter("SmallFilter",b):V._displayOCXRule(P,!0):V._drawOCXFilter("BigSmallFilterBox",b),V._disabledDraw(!1);else{var c=b.Config.SizeFilter;$("ipcIntellentNew_max").checked?y(c.MaxSize)?(l.AddShape(5,"","MaxRect",0,-1),V._disabledDraw(!0)):l.SetCurShape("MaxRect"):y(c.MinSize)?(l.AddShape(5,"","MinRect",0,-1),V._disabledDraw(!0)):l.SetCurShape("MinRect")}if("RioterDetection"==b.Type){if(b.Enable===!1)return;return void(z(b.Config.MinDetectRect)?(l.AddShape(6,"","RuleRect",-1,0),V._disabledDraw(!0)):(l.DeleteShape("RuleRect"),l.SetObjectConfig(JSON.stringify({RuleRect:b.Config.MinDetectRect})),l.SetCurShape("RuleRect")))}"PrisonerRiseDetection"==b.Type&&(S=!0)}),$("ipcIntellentNew_clearTarget").addEvent("click",function(){var a=V._findIndexNow(),b=i[M][a];if(v)return void remarkDisplay("ipcIntellentNew_remark1",tl("com.PleaseDrawShapeTip"),3e3,1);if("RioterDetection"==b.Type)return b.Config.MinDetectRect=[[0,0],[0,0]],void(b.Enable&&(l.DeleteShape("RuleRect"),l.AddShape(6,"","RuleRect",-1,0)));if(!(webApp.DeviceType.indexOf("TPC")>-1&&0===Q.length)){if($("ipcIntellentNew_max").checked){if(b.Config.SizeFilter.MaxSize=[0,0],jQuery('#ipcIntellentNew_object_filter_ck [name="MaxSize-0"]').val(0),jQuery('#ipcIntellentNew_object_filter_ck [name="MaxSize-1"]').val(0),webApp.DeviceType.indexOf("TPC")>-1){var c=Q[1];l.DeleteOneIntelShape(c),Q[1]=null}}else if(b.Config.SizeFilter.MinSize=[0,0],jQuery('#ipcIntellentNew_object_filter_ck [name="MinSize-0"]').val(0),jQuery('#ipcIntellentNew_object_filter_ck [name="MinSize-1"]').val(0),webApp.DeviceType.indexOf("TPC")>-1){var d=Q[0];l.DeleteOneIntelShape(d),Q[0]=null}webApp.DeviceType.indexOf("TPC")>-1?(r.MaxRect=b.Config.SizeFilter.MaxSize,r.MinRect=b.Config.SizeFilter.MinSize):b.Enable&&(l.DeleteShape("MaxRect"),l.DeleteShape("MinRect"),r.MaxRect=b.Config.SizeFilter.MaxSize,r.MinRect=b.Config.SizeFilter.MinSize,l.SetObjectConfig(JSON.stringify(r)),$("ipcIntellentNew_max").checked?l.AddShape(5,"","MaxRect",0,-1):l.AddShape(5,"","MinRect",0,-1),V._disabledDraw(!0,!0),$("ipcIntellentNew_max").checked||(v=!1))}}),$("ipcIntellentNew_max").addEvent("click",function(){return v?void remarkDisplay("ipcIntellentNew_remark1",tl("com.PleaseDrawShapeTip"),3e3,1):void(webApp.DeviceType.indexOf("TPC")>-1?(l.SelectOneIntelShape(Q[1],!0),l.SelectOneIntelShape(Q[0],!1)):l.SetCurShape("MaxRect"))}),$("ipcIntellentNew_min").addEvent("click",function(){var a=V._findIndexNow(),b=i[M][a];return v?void remarkDisplay("ipcIntellentNew_remark1",tl("com.PleaseDrawShapeTip"),3e3,1):void(webApp.DeviceType.indexOf("TPC")>-1?(l.SelectOneIntelShape(Q[1],!1),l.SelectOneIntelShape(Q[0],!0)):y(b.Config.SizeFilter.MinSize)?(l.AddShape(5,"","MinRect",0,-1),V._disabledDraw(!0)):l.SetCurShape("MinRect"))}),$$("#ivs_crd_appear,#ivs_crd_cross,#ivs_crd_inside").addEvent("click",function(){var a=V._findIndexNow(),b=this.checked,c=this.getProperty("data-val"),d=i[M][a].Config;b?d.Action.push(c):d.Action.splice(d.Action.indexOf(c),1),"Cross"==c&&(d.Direction=b?$("ipcIntellentNew_ruleDirection2").value:"",$("ipcIntellentNew_ruleDirectionWrap2").setStyle("display",b?"":"none"),V._changeDiection())}),$("ipcIntellentNew_fieldset").addEvent("click:relay([data-add])",function(){if(this.hasClass("disabled"))return void(-1!==webApp.DeviceType.indexOf("TPC")&&$$("#ipcIntellentNew_ruleManager tbody tr").length&&remarkDisplay("ipcIntellentNew_remark1",tl("com.NoMoreRule"),3e3,1));if(-1!==webApp.DeviceType.indexOf("SD")&&!webApp.NoIntelliPreset&&-1!==webApp.DeviceType.indexOf("TPC")&&!$("ipcIntellentNew_presets").getSelected()[0].hasClass("fn-color-ivsGreen"))return void remarkDisplay("ipcIntellentNew_remark1",tl("com.AddSceneFirst"),3e3,1);var a="CrossLineDetection";-1==t.indexOf(a)&&(a=t[0]);var b=$unlink(e[a]),c=i[M];if(!b)throw remarkDisplay("ipcIntellentNew_remark1",tl("com.OperateFailTip"),3e3,1),new Error("the rule of "+a+" has no default config");var d=jQuery.extend(!0,{},b),f=[a];"LeftDetection"==a&&f.push("TakenAwayDetection");for(var g in e)f.push(g);d.Name=V.getUniqueName(d.Name,i,f,c),d.PtzPresetId=$("ipcIntellentNew_presets").value-0,d.EventHandler.RecordChannels=[M],d.EventHandler.SnapshotChannels=[M],c.push(d),V._renderRuleList(c,c.length-1),V._changeRule(c.length-1,!0)}),F.addEvent("click",function(b){b.target.getProperty("data-del")||(""!==b.target.getProperty("data-input")||(a.apply(b.target),V._findIndexNow()===1*b.target.getProperty("data-index")))&&(c.apply(jQuery(b.target).parents("tr")[0]),V._renderOcx())}),F.addEvent("click:relay([data-del])",function(){var a,b=this.getProperty("data-del")-0,c=V._findIndexNow(),d=i[M];if(webApp.DeviceType.indexOf("TPC")>-1?V._delectOCXRule(O):l.DeleteShape(d[b].Name),d.splice(b,1),a=d.length,c>=b)for(var e=c-1;e>=0;e--)if("Normal"===d[e].Class){c=e;break}V._renderRuleList(d,c),V._renderRule(),V._renderOcx()}),F.addEvent("dblclick:relay([data-name])",function(){this.addClass("edit"),this.getElement("input").select()}),F.addEvent("change:relay(select)",function(){this.getSiblings("span").setProperty("text",tl(this.value));var a=V._findIndexNow(),b=i[M][a];b.Type=this.value,b.ObjectTypes=$unlink(e[b.Type].ObjectTypes),V._renderRuleDom(b.Type),b.Config=$unlink(e[b.Type].Config),V._changeRule(a)}),$("ipcIntellentNew_allRuleEnable").addEvent("click",function(){var a=F.getElements("[data-input]");if(0===a.length)return void(this.checked=!1);for(var b=i[M],c=0;c<a.length;c++){a[c].checked=this.checked;var d=a[c].getProperty("data-index")-0;b[d].Enable=this.checked}var e=F.getElement(".current").getElement("[data-input]").getProperty("data-index");V._changeRule(e)}),F.addEvent("keyup:relay(input)",function(a){13===a.code&&this.blur()}),F.addEvent("blur:relay(input)",function(){var a=this.getProperty("type");if("checkbox"!=a){var b,c,d=this.value;if(b=this.getParent().removeClass("edit").getProperty("data-name")-0,d){this.getSiblings("span").set("text",d).setProperty("title",d);var e=i[M][b];c=e.Name,e.Name=d,l.SetCurShape(c),l.SetCurName(d),l.SetCurShape("save")}}}),$("ipcIntellentNew_drawTarget1").addEvent("click",function(){var a=V._findIndexNow(),c=i[M][a],d=c.Config.SizeFilter.CalibrateBoxs[0].CenterPoint;if(V._displayOCXRule(O,!1),jQuery.isNumeric(U[0]))return V._displayOCXRule(U[0],!0),void V._displayOCXRule(U[1],!0);if(N?id=N:l.CreateOneIntelShapeContainer(M,"").done(function(a){N=a}),0===d[0]&&0===d[1])l.CreateOneIntelShape(N,"DoubleRectangleShape","VideoAnalyzeConfig","DoubleRectangleShape","ViewFilter1","","").done(function(a){U[0]=a});else{var e=b(1,c.Config.SizeFilter);if(l.CreateOneIntelShape(N,"DoubleRectangleShape","VideoAnalyzeConfig","DoubleRectangleShape","ViewFilter1",JSON.stringify(e),"").done(function(a){U[0]=a}),c.Config.SizeFilter.CalibrateBoxs[1]){var f=c.Config.SizeFilter.CalibrateBoxs[1];if(0!==f.CenterPoint[0]&&0!==f.CenterPoint[1]){var g=b(2,c.Config.SizeFilter,f);l.CreateOneIntelShape(N,"DoubleRectangleShape","VideoAnalyzeConfig","DoubleRectangleShape","ViewFilter2",JSON.encode(g),"").done(function(a){U[1]=a})}l.SetOneIntelShapeDisplayColor(U[1],0,255,255,0),l.SetOneIntelShapeThickness(U[1],2),l.SetOneIntelShapeVisible(U[1],!0),l.SelectOneIntelShape(U[1],!0)}}l.SetOneIntelShapeDisplayColor(U[0],0,255,255,0),l.SetOneIntelShapeThickness(U[0],2),l.SetOneIntelShapeVisible(U[0],!0),l.SelectOneIntelShape(U[0],!0)}),$("ipcIntellentNew_drawTarget2").addEvent("click",function(){{var a=V._findIndexNow();i[M][a]}O=null,N?id=N:l.CreateOneIntelShapeContainer(M,"").done(function(a){N=a}),jQuery.isNumeric(U[1])||(l.CreateOneIntelShape(N,"DoubleRectangleShape","VideoAnalyzeConfig","DoubleRectangleShape","ViewFilter2","","").done(function(a){U[1]=a,O=a}),l.SetOneIntelShapeDisplayColor(O,0,255,255,0),l.SetOneIntelShapeThickness(O,2),l.SetOneIntelShapeVisible(O,!0),l.SelectOneIntelShape(O,!0),l.SelectOneIntelShape(U[0],!1))}),$("ipcIntellentNew_clearTargetAll").addEvent("click",function(){var a=V._findIndexNow(),b=i[M][a];l.DeleteOneIntelShape(U[0]),l.DeleteOneIntelShape(U[1]),U[0]=null,U[1]=null,b.Config.SizeFilter.CalibrateBoxs[0].CenterPoint=[0,0],b.Config.SizeFilter.CalibrateBoxs[1].CenterPoint=[0,0],b.Config.SizeFilter.CalibrateBoxs[1].Ratio=1
}),jQuery("#filterMode").on("change",function(a){var b=V._findIndexNow(),c=i[M][b],d=jQuery(a.target).val();jQuery("#targetFilter-Pixel").toggle("Pixel"===d),jQuery("#targetFilter-CalibratedPixel").toggle("Pixel"!==d),l.DeleteOneIntelShape(U[0]),l.DeleteOneIntelShape(U[1]),c.Config.SizeFilter.MeasureMode=d,"Pixel"===d?(c.Config.SizeFilter.CalibrateBoxs[0].CenterPoint=[4096,4096],c.Config.SizeFilter.MaxSize=[8191,8191],c.Config.SizeFilter.MinSize=[0,0],c.Config.SizeFilter.Type="ByLength",V._renderSizeFilter(c.Config.SizeFilter)):(l.DeleteOneIntelShape(Q[0]),Q[0]=null,l.DeleteOneIntelShape(Q[1]),Q[1]=null,c.Config.SizeFilter.CalibrateBoxs[0].CenterPoint=[0,0],c.Config.SizeFilter.MaxSize=[0,0],c.Config.SizeFilter.MinSize=[0,0],c.Config.SizeFilter.CalibrateBoxs[1]&&(c.Config.SizeFilter.CalibrateBoxs[1].CenterPoint=[0,0],c.Config.SizeFilter.CalibrateBoxs[1].Ratio=1))}),jQuery('[name="ivs_fliter_type"]').on("click",function(a){var b=V._findIndexNow(),c=i[M][b];c.Config.SizeFilter.Type=jQuery(a.target).val()}),jQuery("#ivs_objectFilter").on("click",function(){var a=V._findIndexNow(),b=i[M][a],c=jQuery(this).prop("checked");c?(b.ObjectTypes=jQuery.grep(b.ObjectTypes,function(a){return"Unknown"!==a}),0===b.ObjectTypes.length&&remarkDisplay("ipcIntellentNew_remark1",tl("ivs.AlarmChoose"),3e3,1)):b.ObjectTypes.push("Unknown"),jQuery("#ivs_alarmObject").toggleClass("fn-hide",!c)}),jQuery("#ivs_alarmObject input").on("click",function(){var a=i[M][C],b=0;-1===jQuery.inArray("Unknown",a.ObjectTypes)&&(jQuery(this).parent().siblings().each(function(a,c){jQuery(c).find("input").prop("checked")&&b++}),0===b&&(jQuery(this).prop("checked",!0),remarkDisplay("ipcIntellentNew_remark1",tl("ivs.AlarmChoose"),3e3,1)))})},leave:function(){l.addEvent("OutPutStringInfo",null),l.addEvent("VideoAnalyzeConfig",null),l.addEvent("ResolutionChangeIvs",null),l.SetIVSConfig("",2),l.hide(),"hls"===webApp.playMode?I.hideAndStopLoad():"flash"===webApp.playMode?J.hide():"h5"===webApp.playMode&&K.hide(),webApp.DeviceType.indexOf("TPC")>-1&&N&&l.RemoveOneIntelShapeContainer(N)},getUniqueName:function(a,b,c,d){var e=0,f=[];if(/[^\d]\d{1}$/g.test(a)&&(a=a.substr(0,a.length-1)),a=tl("com.Rule"),null==b[0])return a+"1";for(b.each(function(a){a.each(function(a){-1===c.indexOf(a.Type)&&f.push(a.Name)})}),d.each(function(a){a&&f.push(a.Name)});f.indexOf(a+ ++e)>-1;);return a+e},_ruleInitEmpty:function(a){var b=V._findIndexNow();if(-2!=b){V._buildRuleJson();var c=JSON.parse(j).params.table[0][0],d=!1;if(c.Config.DetectLine)0==c.Config.DetectLine[0][0]&&0==c.Config.DetectLine[0][1]&&0==c.Config.DetectLine[1][0]&&0==c.Config.DetectLine[1][1]&&(a||l.DeleteShape(c.Name),d=!0);else if(c.Config.DetectRegion&&"array"==$type(c.Config.DetectRegion)){var e,f=c.Config.DetectRegion,g=!0;for(e=f.length;e--;)if(f[e][0]||f[e][1]){g=!1;break}g&&!a&&l.DeleteShape(c.Name),d=g}else c.Config.Direction&&0==c.Config.Direction[0][0]&&0==c.Config.Direction[0][1]&&0==c.Config.Direction[1][0]&&0==c.Config.Direction[1][1]?(a||l.DeleteShape(c.Name),d=!0):c.Config.BedMiddleLine&&0==c.Config.BedMiddleLine[0][0]&&0==c.Config.BedMiddleLine[0][1]&&0==c.Config.BedMiddleLine[1][0]&&0==c.Config.BedMiddleLine[1][1]?(a||l.DeleteShape(c.Name),d=!0):d=!0;return"CrossFenceDetection"==c.Type&&c.Config.DownstairsLine&&c.Config.UpstairsLine&&(d="0,0,0,0"==c.Config.DownstairsLine.toString()&&"0,0,0,0"==c.Config.UpstairsLine.toString()?!0:!1),d}},_renderElements:function(){(null==i[M]||0===i[M].length)&&(i[M]=[]);var a=$("ipcIntellentNew_presets").value-0;if(D){var b=!1;p[M].each(function(c,d){c.PtzPresetID===a&&(jQuery("#ivs_ObjectSize").slider("value",p[M][d].CalibrateArea[0].ObjectScale),jQuery("#ivs_ObjectSize_val").numberfield("value",p[M][d].CalibrateArea[0].ObjectScale),b=!0)}),b||(q.PtzPresetID=a,p[M].push(q),jQuery("#ivs_ObjectSize").slider("value",q.CalibrateArea[0].ObjectScale),jQuery("#ivs_ObjectSize_val").numberfield("value",q.CalibrateArea[0].ObjectScale))}if(V._lockDisable(),V._disabledDraw(!1),V._renderRuleList(),c=V._findIndexNow(),0>c)return l.SetIVSConfig("",2),void(webApp.DeviceType.indexOf("TPC")>-1&&N&&(l.RemoveOneIntelShapeContainer(N),N=null,P=null,O=null,Q=[],U[0]=null,U[1]=null));{var c=V._findIndexNow();i[M][c]}V._renderRule(),V._renderOcx()},_renderOcx:function(){var a=V._findIndexNow(),b=i[M][a];if(b)if(webApp.DeviceType.indexOf("TPC")>-1){N&&(l.RemoveOneIntelShapeContainer(N),N=null,P=null,O=null,Q=[],U[0]=null,U[1]=null);var c,d,e,f=b.Type;switch(f){case"CrossRegionDetection":case"PrisonerRiseDetection":case"LeaveDetection":c="Polygon",d=b.Config.DetectRegion,e={Polygon:d};break;case"CrossLineDetection":case"ClimbDetection":c="DetectLine",d=b.Config.DetectLine,e={DetectLine:d};break;case"LeftDetection":case"TakenAwayDetection":c="Polygon",d=b.Config.DetectRegion,e={Polygon:d};break;case"MoveDetection":case"WanderDetection":c="Polygon",d=b.Config.DetectRegion,e={Polygon:d};break;case"CrossFenceDetection":c="Polygon",d=b.Config.DetectRegion,e={Polygon:d};break;case"ParkingDetection":c="Polygon",d=b.Config.DetectRegion,e={Polygon:d};break;case"SmokeDetection":c="Polygon",d=b.Config.DetectRegion,e={Polygon:d};break;default:return}if(0===d[0][0]&&0===d[0][1]&&0===d[1][0]&&0===d[1][1])return;if(l.CreateOneIntelShapeContainer(M,"").done(function(a){N=a}),e=JSON.stringify(e),shapeName=b.Name,l.CreateOneIntelShape(N,c,"VideoAnalyzeConfig",c,shapeName,e,"").done(function(a){O=a}),"none"!=$("ipcIntellentNew_ruleDirectionWrap").getStyle("display")||"none"!=$("ipcIntellentNew_ruleDirectionWrap2").getStyle("display")||"LeftDetection"==b.Type||"TakenAwayDetection"==b.Type){var g,h;if("LeftDetection"==b.Type)g=0;else if("TakenAwayDetection"==b.Type)g=1;else if("CrossRegionDetection"==b.Type||"LeaveDetection"==b.Type)switch(h=$("ipcIntellentNew_ruleDirection2").value){case"Enter":g=0;break;case"Leave":g=1;break;case"Both":g=2;break;default:g=0}else switch(h=$("ipcIntellentNew_ruleDirection").value){case"LeftToRight":g=0;break;case"RightToLeft":g=1;break;case"Both":g=2;break;default:g=0}l.SetIntelShapeDirection(O,g)}l.SetOneIntelShapeDisplayColor(O,0,255,255,0),l.SetOneIntelShapeDisplayColor(O,1,0,0,255),l.SetOneIntelShapeThickness(O,2),l.SetOneIntelShapeVisible(O,!0),l.SelectOneIntelShape(O,!0)}else{var k=b.Config.SizeFilter;k&&y(k.MaxSize)&&($("ipcIntellentNew_min").disabled=!0),V._buildRuleJson(),l.SetIVSConfig(j,2),l.SetCurShape(b.Name),V._ruleInitEmpty(),b.Enable&&("RioterDetection"==b.Type||(r.MaxRect=k&&k.MaxSize,r.MinRect=k&&k.MinSize,l.SetObjectConfig(JSON.stringify(r)),l.SetCurPtzID(0))),l.SetCurShape("save")}},_renderRule:function(){var a=V._findIndexNow(),b=i[M][a];if(b){if(V._renderSizeFilter(b.Config.SizeFilter),V.eventHandler.set(b.EventHandler),webApp.DeviceType.indexOf("TPC")>-1){jQuery("#filterMode").val(b.Config.SizeFilter.MeasureMode);var c=b.Config.SizeFilter.MeasureMode;if(jQuery("#targetFilter-Pixel").toggle("Pixel"===c),jQuery("#targetFilter-CalibratedPixel").toggle("Pixel"!==c),jQuery('[name="ivs_fliter_type"][value='+b.Config.SizeFilter.Type+"]").prop("checked",!0),b.Config.MinDuration&&"CrossLineDetection"!=b.Type?($("ipcIntellentNew_minDuration_wrap").style.display="",$("ipcIntellentNew_minDuration").value=b.Config.MinDuration):$("ipcIntellentNew_minDuration_wrap").style.display="none","CrossRegionDetection"==b.Type?($("ipcIntellentNew_RegionRule").style.display="",$("ipcIntellentNew_RegionRuleType").value=2==b.Config.Action.length?"both":"Cross"==b.Config.Action[0]?"Cross":"Inside"):$("ipcIntellentNew_RegionRule").style.display="none","CrossRegionDetection"==b.Type)$("ipcIntellentNew_RegionRule").style.display="",2==b.Config.Action.length?($("ipcIntellentNew_RegionRuleType").value="both",$("ipcIntellentNew_ruleDirectionWrap2").setStyle("display",""),$$(".InsideRule").setStyle("display","")):"Cross"==b.Config.Action[0]?($("ipcIntellentNew_RegionRuleType").value="Cross",$("ipcIntellentNew_ruleDirectionWrap2").setStyle("display",""),$$(".InsideRule").setStyle("display","none")):($("ipcIntellentNew_RegionRuleType").value="Inside",$("ipcIntellentNew_ruleDirectionWrap2").setStyle("display","none"),$$(".InsideRule").setStyle("display","")),$("ipcIntellentNew_MaxTargets").value=b.Config.MaxTargets,$("ipcIntellentNew_MinTargets").value=b.Config.MinTargets,$("ipcIntellentNew_ReportInterval").value=b.Config.ReportInterval,$("ipcIntellentNew_ruleDirection2").value=b.Config.Direction,$("ipcIntellentNew_ruleDirection2").selectedIndex="Enter"==b.Config.Direction?0:"Leave"==b.Config.Direction?1:2,V._changeRuleType();else if("SmokeDetection"==b.Type)$("ipcIntellentNew_RegionRule").style.display="none",$$(".InsideRule").setStyle("display","none"),$("ipcIntellentNew_minDuration_wrap").setStyle("display",""),$("ipcIntellentNew_ReportInterval").getParent().getParent().setStyle("display",""),$("ipcIntellentNew_ReportInterval").value=b.Config.ReportInterval;else if("LeftDetection"==b.Type||"TakenAwayDetection"==b.Type)$("ipcIntellentNew_RegionRule").style.display="none",$$(".InsideRule").setStyle("display","none"),$("ipcIntellentNew_minDuration_wrap").setStyle("display",""),$("ipcIntellentNew_ruleDirectionWrap2").setStyle("display","none"),$("ipcIntellentNew_minDuration").value=b.Config.MinDuration,$("ipcIntellentNew_ReportInterval").value=b.Config.ReportInterval;else if($("ipcIntellentNew_RegionRule").style.display="none",$$(".InsideRule").setStyle("display","none"),b.Config.Direction){$("ipcIntellentNew_ruleDirectionWrap").style.display="";var d=$("ipcIntellentNew_ruleDirection").getElements("option");d[0].setProperty("text",tl("com.RightToLeft")),d[1].setProperty("text",tl("com.LeftToRight")),d[2].setProperty("text",tl("com.ToBoth"));var e={LeftToRight:"RightToLeft",RightToLeft:"LeftToRight",Both:"Both"};$("ipcIntellentNew_ruleDirection").value=e[b.Config.Direction]}else $("ipcIntellentNew_ruleDirectionWrap2").style.display="none"}else if("LeaveDetection"==b.Type?($("ipcIntellentNew_RegionRule").style.display="none",$$(".InsideRule").setStyle("display","none"),$("ipcIntellentNew_minDuration_wrap").setStyle("display",""),$("ipcIntellentNew_ruleDirectionWrap2").setStyle("display","none"),$("ipcIntellentNew_minDuration").value=b.Config.MinDuration,$("ipcIntellentNew_ReportInterval").getParent().getParent().setStyle("display",""),$("ipcIntellentNew_ReportInterval").value=b.Config.ReportInterval):$("ipcIntellentNew_ReportInterval").getParent().getParent().setStyle("display","none"),b.Config.MinDuration&&($("ipcIntellentNew_minDuration").value=b.Config.MinDuration),b.Config.Action){$("ivs_crd_cross").checked=!1,$("ivs_crd_appear").checked=!1,$("ivs_crd_inside").checked=!1,jQuery.each(b.Config.Action,function(a,b){switch(b){case"Cross":$("ivs_crd_cross").checked=!0;break;case"Appear":$("ivs_crd_appear").checked=!0;break;case"Inside":$("ivs_crd_inside").checked=!0}});var f="none";b.Config.Action.indexOf("Cross")>-1&&(f=""),$("ipcIntellentNew_ruleDirectionWrap2").setStyle("display",f)}if(b.Config.Direction&&($("ipcIntellentNew_ruleDirection").value=b.Config.Direction,$("ipcIntellentNew_ruleDirection2").value=b.Config.Direction,$("ipcIntellentNew_fenceDirection").value=b.Config.Direction),b.Config.Sensitivity&&E.set(b.Config.Sensitivity),$("ipcIntellentNew_TrackTime").value=void 0!==b.Config.TrackDuration?b.Config.TrackDuration:30,void 0!==b.TrackEnable&&($("ipcIntellentNew_TrackEnable").checked=b.TrackEnable),o&&b.EventHandler&&b.EventHandler.LightingLink&&(b.EventHandler.LightingLink.Enable&&$("ivs_light_type").getParent().getParent().removeClass("fn-hide"),$("ivs_light_link_enable").checked=b.EventHandler.LightingLink.Enable,$("ivs_light_type").value=b.EventHandler.LightingLink.FilckerLightType,$("ivs_light_duration").value=.1*b.EventHandler.LightingLink.FilckerIntevalTime,$("ivs_light_num").value=b.EventHandler.LightingLink.FilckerTimes,$("ivs_light_link_enable").addEvent("change",function(a){var b=a.target,c=b.checked;c?$("ivs_light_type").getParent().getParent().removeClass("fn-hide"):$("ivs_light_type").getParent().getParent().addClass("fn-hide")}),$("ivs_light_duration").addEvent("change",function(a){var b=a.target.value-0;b=Math.round(b)>b?parseInt(b)+.5:Math.round(b)<b?parseInt(b):b,$("ivs_light_duration").value=b})),B[b.Type]){jQuery("#ivs_objectFilter").prop("checked",jQuery.inArray("Unknown",b.ObjectTypes)>-1).click();var g=jQuery("#ivs_alarmObject");jQuery.each(b.ObjectTypes,function(a,b){g.find("input[value = "+b+"]").prop("checked",!0)})}}},_renderRuleDom:function(a){Page.ivsConfig._hideElement(),Page.ivsConfig.Tab[a]&&Page.ivsConfig.Tab[a].render(),"VideoAbnormalDetection"==a?jQuery("div[data-emptyDraw]").addClass("fn-hide"):jQuery("div[data-emptyDraw]").removeClass("fn-hide"),V.renderMinDuration(a),u.indexOf(a)>-1&&webApp.IsIPCIntel?$("ipcIntellentNew_TriggerTrack").removeClass("fn-hide"):webApp.IsIPCIntel&&$("ipcIntellentNew_TriggerTrack").addClass("fn-hide"),T&&a&&($$("#ipcIntellentNew_eventHandler [cap]").getParent("div").removeClass("fn-hide"),T[a].each(function(a){$$("#ipcIntellentNew_eventHandler [cap="+a+"]").getParent("div").addClass("fn-hide")}));var b=jQuery("#ivs_alarmObject");b.find("input").prop("checked",!1),B[a]?(jQuery("#ipcIntellentNew_tab_public [data-wrap=SupportedObjectTypes]").show(),b.find("input").parent().hide(),jQuery.each(B[a],function(a,c){b.find("input[value = "+c+"]").parent().show()})):jQuery("#ipcIntellentNew_tab_public [data-wrap=SupportedObjectTypes]").hide()},_renderSizeFilter:function(a){if(a){var b=["MaxSize-0","MaxSize-1","MinSize-0","MinSize-1"];$("ipcIntellentNew_left").getElements("input[type=text]").each(function(c){var d=c.name;if(-1!==b.indexOf(d)){var e=d.split("-"),f=e[0],g=e[1]-0;c.value=a[f][g]}})}},_renderRuleList:function(a,b){var c=$("ipcIntellentNew_presets").value-0;a=i[M]||[];var e=F.getElement("tbody"),f=e.getElement(".current");if(f){var g=f.getProperty("data-index")-0;a[g]&&void 0==b&&(b=g)}for(var h=jQuery("<select></select>"),j=0;j<t.length;j++){var k=jQuery('<option value="'+t[j]+'" title="'+tl(t[j])+'">'+tl(t[j])+"</option>");h.append(k)}var m='<tr data-index="{index}" data-type="{type}" data-enable="{bool}">                                <td width="8%" class="enable"><input  data-input data-index="{index}" type="checkbox" class="ruleform fn-marl5"></td>                                <td width="10%" class="num fn-textcenter">{No}</td>                                <td width="37%" data-name="{index}" class="fn-indent10 fn-word-wrap">                                    <span class="ui-label fn-text-overflow fn-width120" style="height:20px;" title="{name}">{name}</span>                                    <input data-name class="fn-width110" value="{name}"/></td>                                <td width="37%" data-rule="{index}"><select class="fn-width110">'+h.html()+'<select></td>                                <td width="8%"><span class="ui-button-icon-clear" data-del="{index}"></span></td>                            </tr>',n=[],o=a.length;webApp.DeviceType.indexOf("TPC")>-1&&0===o&&N&&(l.RemoveOneIntelShapeContainer(N),N=null,P=null,O=null,Q=[],U[0]=null,U[1]=null),e.empty();var p=1;a.each(function(a,b){a&&a.PtzPresetId==c&&-1!==t.indexOf(a.Type)&&n.push(m.substitute({bool:a.Enable,No:p++,index:b,type:a.Type,name:a.Name.replace(/\"/g,"&quot;").replace(/\</g,"&lt;").replace(/\>/g,"&gt;")}))}),e.set("html",n.join("")),d($$("#ipcIntellentNew_ruleManager input[data-name]"),{maxByte:63}),f=e.getElements("tr"),$("ipcIntellentNew_allRuleEnable").checked=!!f.length;for(var q=0;q<f.length;q++){var r=f[q].getProperty("data-type"),s=f[q].getElement("select");s.value=r;var u=f[q].getProperty("data-enable"),v=f[q].getElement("input");v.checked="false"===u?!1:!0,"false"===u&&($("ipcIntellentNew_allRuleEnable").checked=!1)}(void 0==b||0==e.getElements("tr[data-index="+b+"]").length)&&(0!==e.getElements("tr[data-index="+(b+1)+"]").length?b++:b=V._findIndexNow()),e.getElements("tr[data-index="+b+"]").addClass("current");var w=e.getElements("tr[data-index="+b+"]").getProperty("data-type");V._renderRuleDom(w[0]);var x=V._getAddStatus();$("ipcIntellentNew_fieldset").getElements("[data-add]").toggleClass("disabled",x);var y=$("ipcIntellentNew_tab_public");y.getElements("[data-emptyReules]").toggleClass("fn-hide",!f.length),y.getElements("[data-emptyDraw]").toggleClass("fn-invisib",!f.length)},_getAddStatus:function(){for(var a=i[M]||[],b=0,c=$("ipcIntellentNew_presets").value-0,d=0;d<a.length;d++)"Normal"==a[d].Class&&a[d].PtzPresetId==c&&b++;return b>=H||a.length>=G||0>=c&&-1!==webApp.DeviceType.indexOf("SD")&&!webApp.NoIntelliPreset?!0:!1},_findIndexNow:function(){var a=F.getElement(".current");if(null!==a)return a.getProperty("data-index")-0;var b=F.getElements("tr")[0];return b?b.getProperty("data-index")-0:-2},_buildRuleJson:function(){var a=V._findIndexNow(),b=i[M][a],c=jQuery.extend(!0,{},b);delete c.EventHandler;var d={result:!0,params:{table:[[c]]}};return c.PtzPresetId=0,j=JSON.stringify(d),JSON.stringify(d)},_drawRuleType:function(a){webCaps.is_show_PixelCounter&&l.DeleteShape("rect1");var b=V._findIndexNow(),c=i[M][b],d=c.Name,e=c.Type,f=jQuery("#ipcIntellentNew_ruleManager .current .enable input");if(f[0]&&!f[0].checked)return void remarkDisplay("ipcIntellentNew_remark1",tl("com.RuleIsntEnableTip"),3e3,1);var g;if(webApp.DeviceType.indexOf("TPC")>-1){if(null===b||"undefined"===b)return;if(a){if(N)O&&(V._delectOCXRule(O),O=null,P&&(V._delectOCXRule(P),P=null));else if(v)return void remarkDisplay("ipcIntellentNew_remark1",tl("com.PleaseDrawShapeTip"),3e3,1)}else N?O?(P&&V._displayOCXRule(P,!1),U[0]&&V._displayOCXRule(U[0],!1),U[1]&&V._displayOCXRule(U[1],!1),V._displayOCXRule(O,!0),l.SelectOneIntelShape(O,!0)):V._drawNewRule(N,e,d):V._drawNewRule(null,e,d);if(g=V._ruleInitEmpty(!0),!g)return;V._disabledDraw(!0)}else{var h=$("ipcIntellentNew_ruleDirection").selectedIndex,j=0;if(v)return void remarkDisplay("ipcIntellentNew_remark1",tl("com.PleaseDrawShapeTip"),3e3,1);if(g=V._ruleInitEmpty(!0),!g){if(!a)if("PrisonerRiseDetection"===e){if(c.Config&&c.Config.DetectRegion){if(l.SetCurShape(d),!S)return;l.SelectRule(d,0),S=!1}l.SetCurShape(d)}else if("RetrogradeDetection"===e){if(c.Config&&c.Config.DetectRegion)return l.SetCurShape(d),void l.SelectRule(d,0);l.SetCurShape(d)}else l.SelectRule(d,0);return}switch("PrisonerRiseDetection"===e?("PrisonerRiseDetection"===e&&(c.Config.Direction=[[0,0],[0,0]],c.Config.BedMiddleLine=[[0,0],[0,0]],c.Config.DetectRegion=[[0,0],[0,0],[0,0],[0,0]]),l.DeleteShape(d),l.DeleteShape(d+"_dir1"),l.DeleteShape(d+"_dir2")):l.DeleteShape(d),V._disabledDraw(!0),e){case"CrossRegionDetection":h=$("ipcIntellentNew_ruleDirection2").selectedIndex,-1===c.Config.Action.indexOf("Cross")&&(h=-1),l.AddShape(2,e,d,h,j);break;case"RetrogradeDetection":case"CrossLineDetection":case"ClimbDetection":l.AddShape(2,e,d,h,j);break;case"PrisonerRiseDetection":l.AddShape(2,"PrisonerRiseDetection",d,h,j);break;case"CrossFenceDetection":h=$("ipcIntellentNew_fenceDirection").selectedIndex,l.AddShape(2,e,d,h,j);break;default:l.AddShape(2,e,d,-1,j)}}},_rebuild:function(a){g.DevVideoAnalyse.setModuleState(-1,1,a).done(function(a){a?remarkDisplay("ipcIntellentNew_remark1",tl("com.OperateSuccessTip"),3e3,0):remarkDisplay("ipcIntellentNew_remark1",tl("com.OperateFailTip"),3e3,1)}).fail(function(){remarkDisplay("ipcIntellentNew_remark1",tl("com.OperateFailTip"),3e3,1)})},_changeRule:function(a){analyseRuleList=i[M]||[],a>=analyseRuleList.length&&(a=analyseRuleList.length-1),C=a,V._disabledDraw(!1),V._renderRule(),V._renderOcx()},_changeDiection:function(){V._renderOcx()},_disabledDraw:function(a,b){v=a,x=b,$("ipcIntellentNew_max").disabled=a,$("ipcIntellentNew_min").disabled=a,$("ipcIntellentNew_NumberSelect").disabled=a,$("ipcIntellentNew_ruleDirection").disabled=a,$("ipcIntellentNew_ruleInputName").disabled=a,$("ivs_crd_cross").disabled=a,$("ipcIntellentNew_ruleDirection2").disabled=a,$("ipcIntellentNew_fenceDirection").disabled=a},_onDefaultClick:function(){g.ConfigManager.getDefault("VideoAnalyseRule").done(function(a){for(var b=$("ipcIntellentNew_presets").value-0,c=i[M].length,d=c-1;d>=0;d--)i[M][d].PtzPresetId===b&&"Normal"==i[M][d].Class&&"SmokeDetection"!=i[M][d].Type&&i[M].erase(i[M][d]);for(var e=a[0],f=0;f<e.length;f++)e[f]&&e[f].PtzPresetId===b&&"Normal"==e[f].Class&&i[M].push(e[f]);V._renderElements(),remarkDisplay("ipcIntellentNew_remark1",tl("com.DefaultSuccessTip"),3e3,0)}).fail(function(){remarkDisplay("ipcIntellentNew_remark1",tl("com.DefaultfailureTip"),3e3,1)})},_onDetectClick:function(){var a=jQuery("#ipcIntellentNew_left").find("[name=DetectSize-0]").numberfield("value"),b=jQuery("#ipcIntellentNew_left").find("[name=DetectSize-1]").numberfield("value"),c={PixelCount:[[0,0],[a,b]],Name:"rect1"};return jQuery("#ipcIntellentNew_max").prop("disabled")||v?void remarkDisplay("ipcIntellentNew_remark1",tl("com.PleaseDrawShapeTip"),3e3,1):void(a*b?l.SetObjectConfig(JSON.stringify(c)):l.AddShape(6,"PixelCount","rect1",-1,0))},_onRefreshClick:function(a){var b=["VideoAnalyseRule"];D&&b.push("VideoAnalyseCalibrate"),g.ConfigManager.getConfig(b).done(function(b){c=b[0].params.table,i=$unlink(c),b[1]&&b[1].result&&(p=b[1].params.table),V._renderElements(i),a!==!1&&remarkDisplay("ipcIntellentNew_remark1",tl("com.OperateSuccessTip"),3e3,0)}).fail(function(){remarkDisplay("ipcIntellentNew_remark1",tl("com.OperateFailTip"),3e3,1)})},_getRulePos:function(a){switch(a){case"CrossLineDetection":return"DetectLine";case"CrossFenceDetection":return"UpstairsLine";case"CrossFenceDetectionDown":return"DownstairsLine";default:return"DetectRegion"}},_onConfirmClick:function(){var a=V._findIndexNow(),b=i[M][a],d=i[M].filter(function(a){return"Normal"===a.Class}).every(function(a){var b=a.Config.SizeFilter.MaxSize;return b&&b[0]&&b[1]});if(!d)return void remarkDisplay("ipcIntellentNew_remark1",tl("com.PleaseDrawShapeTip"),3e3,1);if(-1===webApp.DeviceType.indexOf("TPC")&&b&&"CrossFenceDetection"==b.Type&&"0,0,0,0"==b.Config.DownstairsLine.toString()&&"0,0,0,0"!==b.Config.UpstairsLine.toString())return void remarkDisplay("ipcIntellentNew_remark1",tl("com.PleaseDrawShapeTip"),3e3,1);V._saveElements();var e=!0,f=!1;if(jQuery.each(i[M],function(a,b){if(B[b.Type]&&0===b.ObjectTypes.length)return remarkDisplay("ipcIntellentNew_remark1",tl("ivs.AlarmChoose"),3e3,1),e=!1,!1;if("Normal"===b.Class&&b.Enable){var c=V._getRulePos(b.Type),d=b.Config[c];if(!d||global.isZeroArray(d))return f=!0,!1}}),!e)return!1;if(f)return remarkDisplay("ipcIntellentNew_remark1",tl("com.PleaseDrawShapeTip"),3e3,1),!1;var h=V._ruleRenameTest();if(!h){l.SetCurShape("save"),c=$unlink(i);var j=["VideoAnalyseRule"],k=[c];D&&(j.push("VideoAnalyseCalibrate"),k.push(p));var m=V.defCheckGlobal(c);m.done(function(){g.ConfigManager.setConfig(j,k).done(function(){remarkDisplay("ipcIntellentNew_remark1",tl("com.SaveSuccessTip"),3e3,0),v=!1,V._lockDisable()}).fail(function(){remarkDisplay("ipcIntellentNew_remark1",tl("com.SaveConfigFailTip"),3e3,1)})}).fail(function(){remarkDisplay("ipcIntellentNew_remark1",tl("com.SaveConfigFailTip"),3e3,1)})}},_lockDisable:function(){if(-1!==webApp.DeviceType.indexOf("TPC"))if(i&&i[M]&&i[M].length>0){var a=i[M],b=a.filter(function(a){return a.TrackEnable===!0&&a.Enable===!0});w.disabledButton(b.length>0?!1:!0)}else w.disabledButton(!0)},defCheckGlobal:function(a){return jQuery.Deferred(function(b){-1===webApp.DeviceType.indexOf("SD")?b.resolve():g.ConfigManager.getConfig("VideoAnalyseGlobal").done(function(c){var d=c;null==d[0]&&(d[0]={}),d=V.checkGlobal(d,a),g.ConfigManager.setConfig("VideoAnalyseGlobal",d).done(function(){b.resolve()}).fail(function(){b.reject("setGlobalFailed")})}).fail(function(){b.reject("getGlobalFailed")})})},checkGlobal:function(a,b){var c=0,d=[],e="";for(var f in a[c])-1!==f.indexOf("Scene")&&(d.push(a[c][f].PtzPresetId),e+=f);for(var g=0;g<b[c].length;g++)if(b[c][g].PtzPresetId&&-1==jQuery.inArray(b[c][g].PtzPresetId,d)&&0!==b[c][g].PtzPresetId&&-1!==b[c][g].PtzPresetId){for(var h,i=0;255>i&&(h="Scene"+(0===i?"":i),-1!==e.indexOf(h));i++);var j=h.replace("Scene","CalibrateArea");a[c][h]=jQuery.extend(!0,{},n.Scene),a[c][j]=null!==n.CalibrateArea?jQuery.extend(!0,{},n.CalibrateArea):null,a[c][h].PtzPresetId=b[c][g].PtzPresetId,a[c][h].Type="Normal",d.push(b[c][g].PtzPresetId)}return a},_saveElements:function(){var a=V._findIndexNow(),b=i[M][a];if(b){if(b.Config.MinDuration&&"MoveDetection"!=b.Type&&(b.Config.MinDuration=$("ipcIntellentNew_minDuration").value-0),void 0!==b.Config.Direction)switch(b.Type){case"CrossLineDetection":case"ClimbDetection":b.Config.Direction=$("ipcIntellentNew_ruleDirection").value;break;case"CrossRegionDetection":case"PrisonerRiseDetection":-1!==webApp.DeviceType.indexOf("TPC")?(b.Config.Action&&(b.Config.Direction=$("ipcIntellentNew_ruleDirection2").value),b.Config.MaxTargets=$("ipcIntellentNew_MaxTargets").value-0,b.Config.MinTargets=$("ipcIntellentNew_MinTargets").value-0):b.Config.Action&&b.Config.Action.indexOf("Cross")>-1&&(b.Config.Direction=$("ipcIntellentNew_ruleDirection2").value);break;case"CrossFenceDetection":b.Config.Direction=$("ipcIntellentNew_fenceDirection").value}-1!==webApp.DeviceType.indexOf("TPC")&&b.Config.Action&&(b.Config.Action="both"==$("ipcIntellentNew_RegionRuleType").value?["Cross","Inside"]:"Cross"==$("ipcIntellentNew_RegionRuleType").value?["Cross"]:["Inside"]),void 0!==b.Config.ReportInterval&&(b.Config.ReportInterval=$("ipcIntellentNew_ReportInterval").value-0),b.Config.Sensitivity&&(b.Config.Sensitivity=E.slider.step);{$("ipcIntellentNew_presets").value-0}if(D&&V._saveCalibrate(jQuery("#ivs_ObjectSize").slider("value")),void 0!==b.Config.TrackDuration&&(b.Config.TrackDuration=$("ipcIntellentNew_TrackTime").value-0),void 0!==b.TrackEnable&&(b.TrackEnable=$("ipcIntellentNew_TrackEnable").checked),o&&b.EventHandler.LightingLink&&(b.EventHandler.LightingLink.Enable=$("ivs_light_link_enable").checked,b.EventHandler.LightingLink.FilckerLightType=$("ivs_light_type").value,b.EventHandler.LightingLink.FilckerIntevalTime=10*($("ivs_light_duration").value-0),b.EventHandler.LightingLink.FilckerTimes=$("ivs_light_num").value-0),b.EventHandler=V.eventHandler.get(),B[b.Type]){var c=jQuery("#ivs_alarmObject"),d=[];c.find("input").each(function(){jQuery(this).prop("checked")&&d.push(jQuery(this).val())}),!jQuery("#ivs_objectFilter").prop("checked")&&jQuery.inArray("Unknown",b.ObjectTypes)>-1&&d.push("Unknown"),b.ObjectTypes=d}return b}},_ruleRenameTest:function(){var a=[],b=0,c=0,d=null,e=null,f=!1;return i.each(function(d){-1!==webApp.DeviceType.indexOf("TPC")&&webApp.CHANNEL_NUMBER>1&&(a=[]),d.each(function(d){if(-1!==webApp.DeviceType.indexOf("SD")&&("Gate"==d.Class||"ParkingSpace"==d.Class))return!1;var e=d.Name;if(f)return!1;if(-1!==webApp.DeviceType.indexOf("TPC")&&"FaceDetection"===e)return!0;var g=a.some(function(a){return a.Name==e?(c="Normal"===a.Class?a.Type:d.Type,b="Normal"===a.Class?d.Type:a.Type,f=!0,!0):!1});g||a.include({Name:e,Type:d.Type,Class:d.Class})})}),f&&(d=V._stringShow(c),e=V._stringShow(b),remarkDisplay("ipcIntellentNew_remark1",tl(d)+" "+tl("com.And")+" "+tl(e)+" "+tl("com.GroupNameSameTip"),3e3,1)),f},_stringShow:function(a){switch(a){case"CrossLineDetection":a="appEventCrossLineDetection";break;case"CrossRegionDetection":a="appEventCrossRegionDetection";break;case"StereoNumberStat":a="NumberStat";break;case"StereoFallDetection":a="StereoFallDetection";break;case"StereoFightDetection":a="StereoFightDetection";break;case"StereoStayDetection":a="StereoManStayDetection";break;case"StereoManNumDetection":a="StereoAbnormalCountDetection";break;case"StereoDistanceDetection":a="StereoApproachDetection";break;case"HumanTrait":a="com.People";break;case"NonMotorDetect":a="ivs.NoMotorVehicle";break;case"VehicleDetect":a="ivs.MotorVehicle"}return a},_onSetupClick:function(){var a=V._findIndexNow();if(!(-1>=a)){l.hide();var b=i[M][a];b&&b.EventHandler&&b.EventHandler.TimeSection&&h.open(b.EventHandler.TimeSection,null,function(){l.cover("#ipcintellentNewVideo")}).done(function(a){b.EventHandler.TimeSection=a}).always(function(){"hls"!=webApp.playMode&&"flash"!=webApp.playMode&&"h5"!==webApp.playMode&&l.cover("#ipcintellentNewVideo")})}},outPutShapeRect:function(b){var c=V._findIndexNow(),d=i[M][c];V._disabledDraw(!1);var e=d.Type,f=JSON.parse(b);if(webApp.DeviceType.indexOf("TPC")>-1){var g,h,j,k=f.EventParam.ShapeID;if("DoubleRectangleShape"===k){var m=null;f.EventParam.ObjectID===U[0]?(m=a(f.ShapeData),d.Config.SizeFilter.CalibrateBoxs[0].CenterPoint=m[0],d.Config.SizeFilter.MaxSize=m[1],d.Config.SizeFilter.MinSize=m[2],d.Config.SizeFilter.CalibrateBoxs.Ratio=m[3]):(m=a(f.ShapeData,d.Config.SizeFilter.MaxSize),m?d.Config.SizeFilter.CalibrateBoxs[1]?(d.Config.SizeFilter.CalibrateBoxs[1].CenterPoint=m[0],d.Config.SizeFilter.CalibrateBoxs[1].Ratio=m[3]):d.Config.SizeFilter.CalibrateBoxs.push({CenterPoint:m[0],Ratio:m[3]}):remarkDisplay("ipcIntellentNew_remark1",tl("com.DrawTargetFailed"),3e3,1))}else switch(e){case"CrossLineDetection":"DetectLine"==f.EventParam.ShapeID?d.Config.DetectLine=f.ShapeData.DetectLine:"BigFilter"==f.EventParam.ShapeID?(g=f.ShapeData.RectangleShape,h=g[1][0]-g[0][0],j=g[1][1]-g[0][1],h=Math.abs(parseInt(h)),j=Math.abs(parseInt(j)),d.Config.SizeFilter.MaxSize=[h,j],$$('#ipcIntellentNew_object_filter_ck input[name^="MaxSize-"]')[0].value=h,$$('#ipcIntellentNew_object_filter_ck input[name^="MaxSize-"]')[1].value=j):"SmallFilter"==f.EventParam.ShapeID&&(g=f.ShapeData.RectangleShape,h=g[1][0]-g[0][0],j=g[1][1]-g[0][1],d.Config.SizeFilter.MinSize=[h,j],$$('#ipcIntellentNew_object_filter_ck input[name^="MinSize-"]')[0].value=h,$$('#ipcIntellentNew_object_filter_ck input[name^="MinSize-"]')[1].value=j),V._disabledDraw(!1);break;case"CrossFenceDetection":if("Polygon"==f.EventParam.ShapeID){if(f.ShapeData.DetectLine.length<3){V._disabledDraw(!0);break}d.Config.DetectRegion=f.ShapeData.DetectLine}else"BigFilter"==f.EventParam.ShapeID?(g=f.ShapeData.RectangleShape,h=g[1][0]-g[0][0],j=g[1][1]-g[0][1],h=Math.abs(parseInt(h)),j=Math.abs(parseInt(j)),d.Config.SizeFilter.MaxSize=[h,j],$$('#ipcIntellentNew_object_filter_ck input[name^="MaxSize-"]')[0].value=h,$$('#ipcIntellentNew_object_filter_ck input[name^="MaxSize-"]')[1].value=j):"SmallFilter"==f.EventParam.ShapeID&&(g=f.ShapeData.RectangleShape,h=g[1][0]-g[0][0],j=g[1][1]-g[0][1],d.Config.SizeFilter.MinSize=[h,j],$$('#ipcIntellentNew_object_filter_ck input[name^="MinSize-"]')[0].value=h,$$('#ipcIntellentNew_object_filter_ck input[name^="MinSize-"]')[1].value=j);break;case"CrossRegionDetection":case"LeftDetection":case"MoveDetection":case"WanderDetection":case"TakenAwayDetection":if("Polygon"==f.EventParam.ShapeID){if(f.ShapeData.DetectLine.length<3){V._disabledDraw(!0);break}d.Config.DetectRegion=f.ShapeData.DetectLine}else"BigFilter"==f.EventParam.ShapeID?(g=f.ShapeData.RectangleShape,h=g[1][0]-g[0][0],j=g[1][1]-g[0][1],h=Math.abs(parseInt(h)),j=Math.abs(parseInt(j)),d.Config.SizeFilter.MaxSize=[h,j],$$('#ipcIntellentNew_object_filter_ck input[name^="MaxSize-"]')[0].value=h,$$('#ipcIntellentNew_object_filter_ck input[name^="MaxSize-"]')[1].value=j):"SmallFilter"==f.EventParam.ShapeID&&(g=f.ShapeData.RectangleShape,h=g[1][0]-g[0][0],j=g[1][1]-g[0][1],d.Config.SizeFilter.MinSize=[h,j],$$('#ipcIntellentNew_object_filter_ck input[name^="MinSize-"]')[0].value=h,$$('#ipcIntellentNew_object_filter_ck input[name^="MinSize-"]')[1].value=j);break;case"ParkingDetection":d.Config.DetectRegion=f.Config.DetectRegion;break;case"VideoAbnormalDetection":d.Config.DetectRegion=f.Config.DetectRegion;break;case"SmokeDetection":if("Polygon"==f.EventParam.ShapeID){if(f.ShapeData.DetectLine.length<3){V._disabledDraw(!0);break}d.Config.DetectRegion=f.ShapeData.DetectLine}else"BigFilter"==f.EventParam.ShapeID?(g=f.ShapeData.RectangleShape,h=g[1][0]-g[0][0],j=g[1][1]-g[0][1],h=Math.abs(parseInt(h)),j=Math.abs(parseInt(j)),d.Config.SizeFilter.MaxSize=[h,j],$$('#ipcIntellentNew_object_filter_ck input[name^="MaxSize-"]')[0].value=h,$$('#ipcIntellentNew_object_filter_ck input[name^="MaxSize-"]')[1].value=j):"SmallFilter"==f.EventParam.ShapeID&&(g=f.ShapeData.RectangleShape,h=g[1][0]-g[0][0],j=g[1][1]-g[0][1],d.Config.SizeFilter.MinSize=[h,j],$$('#ipcIntellentNew_object_filter_ck input[name^="MinSize-"]')[0].value=h,$$('#ipcIntellentNew_object_filter_ck input[name^="MinSize-"]')[1].value=j);
break;default:d.Config.DetectRegion=f.Config.DetectRegion}l.SelectOneIntelShape(k,!0)}else switch(e){case"CrossLineDetection":case"ClimbDetection":f.Config.DetectLine&&(d.Config.DetectLine=f.Config.DetectLine);break;case"CrossFenceDetection":f.Config.UpstairsLine&&(d.Config.UpstairsLine=f.Config.UpstairsLine),f.Config.DownstairsLine&&(d.Config.DownstairsLine=f.Config.DownstairsLine);break;case"CrossRegionDetection":case"LeftDetection":case"TakenAwayDetection":case"LeaveDetection":f.Config.DetectRegion.length<3&&V._disabledDraw(!0),f.Config.DetectRegion&&(d.Config.DetectRegion=f.Config.DetectRegion);break;case"PrisonerRiseDetection":f.Config.Direction&&(d.Config.Direction=f.Config.Direction),f.Config.BedMiddleLine&&(d.Config.BedMiddleLine=f.Config.BedMiddleLine),f.Config.DetectRegion&&(f.Config.DetectRegion.length<3?V._disabledDraw(!0):d.Config.DetectRegion=f.Config.DetectRegion);break;case"RetrogradeDetection":f.Config.Direction&&(d.Config.Direction=f.Config.Direction),f.Config.DetectRegion&&(f.Config.DetectRegion.length<3?V._disabledDraw(!0):d.Config.DetectRegion=f.Config.DetectRegion);break;default:f.Config.DetectRegion&&(d.Config.DetectRegion=f.Config.DetectRegion)}},outPutRuleRect:function(a){var b=V._findIndexNow(),c=i[M][b];V._disabledDraw(!1);var d=JSON.parse(a);d.OutPutRuleRect&&(c.Config.MinDetectRect=d.OutPutRuleRect)},setFilterValue:function(a){var b=V._findIndexNow(),c=i[M][b],d=!1,e=JSON.parse(a),f=c.Config.SizeFilter,g=[1,1];e.MinRect?f.MinSize=e.MinRect:e.MaxRect&&(f.MaxSize=e.MaxRect,g=e.MaxRect),d=y(g),V._renderSizeFilter(f),V._disabledDraw(d,d)},_displayOCXRule:function(a,b){l.SetOneIntelShapeVisible(a,b)},_drawNewRule:function(a,b,c){P=null,O=null,Q=[],a?a=N:l.CreateOneIntelShapeContainer(M,"").done(function(a){N=a});var d;switch(b){case"CrossRegionDetection":case"PrisonerRiseDetection":case"LeaveDetection":d="Polygon";break;case"CrossLineDetection":case"ClimbDetection":d="DetectLine";break;case"TakenAwayDetection":case"MoveDetection":case"WanderDetection":case"CrossFenceDetection":case"LeftDetection":case"ParkingDetection":case"SmokeDetection":d="Polygon"}l.CreateOneIntelShape(N,d,"VideoAnalyzeConfig",d,c,"","").done(function(a){O=a});var e,f;if("none"!==$("ipcIntellentNew_ruleDirectionWrap").getStyle("display")||"none"!=$("ipcIntellentNew_ruleDirectionWrap2").getStyle("display")){if("LeftDetection"==b)e=0;else if("TakenAwayDetection"==b)e=1;else if("CrossRegionDetection"==b||"LeaveDetection"==b)switch(f=$("ipcIntellentNew_ruleDirection2").value){case"Enter":e=0;break;case"Leave":e=1;break;case"Both":e=2;break;default:e=0}else switch(f=$("ipcIntellentNew_ruleDirection").value){case"LeftToRight":e=0;break;case"RightToLeft":e=1;break;case"Both":e=2;break;default:e=0}l.SetIntelShapeDirection(O,e)}l.SetOneIntelShapeDisplayColor(O,0,255,255,0),l.SetOneIntelShapeDisplayColor(O,1,0,0,255),l.SetOneIntelShapeThickness(O,2),l.SetOneIntelShapeVisible(O,!0),l.SelectOneIntelShape(O,!0)},_delectOCXRule:function(a){l.DeleteOneIntelShape(a)},_drawOCXFilter:function(a,b){var c,d,e=b.Config.SizeFilter;b.Config.SizeFilter?(c=b.Config.SizeFilter.MinSize,d=b.Config.SizeFilter.MaxSize):(c=e.MinSize,d=e.MaxSize,b.Config.SizeFilter={},b.Config.SizeFilter.MinSize=c,b.Config.SizeFilter.MaxSize=d);var f,g,h,i,j=(8191-c[0])/2,k=(8191-c[1])/2,m=[[j,k],[c[0]+j,c[1]+k]],n=(8191-d[0])/2,o=(8191-d[1])/2,p=[[n,o],[d[0]+n,d[1]+o]],q="VideoAnalyzeConfig";"BigSmallFilterBox"==a?(P&&l.DeleteOneIntelShape(P),Q=[],f="BigSmallFilterBox",g="",q="VideoAnalyzeConfig",l.CreateOneIntelShape(N,"BigSmallFilterBox",q,f,"","","").done(function(a){P=a}),g={RectangleShape:m},g=JSON.stringify(g),f="SmallFilter",l.AddOneSubIntelShape(N,P,"RectangleShape",q,f,"",g,"").done(function(a){h=a}),Q.push(h),g={RectangleShape:p},g=JSON.stringify(g),f="BigFilter",l.AddOneSubIntelShape(N,P,"RectangleShape",q,f,"",g,"").done(function(a){i=a}),Q.push(i)):"SmallFilter"==a?(g={RectangleShape:m},g=JSON.stringify(g),f="SmallFilter",l.AddOneSubIntelShape(N,P,"RectangleShape",q,f,"",g,"").done(function(a){h=a}),Q[0]=h):"BigFilter"==a&&(g={RectangleShape:p},g=JSON.stringify(g),f="BigFilter",l.AddOneSubIntelShape(N,P,"RectangleShape",q,f,"",g,"").done(function(a){i=a}),Q[1]=i),l.SetOneIntelShapeDisplayColor(h,0,0,255,255),l.SetOneIntelShapeDisplayColor(h,1,0,255,255),l.SetOneIntelShapeThickness(h,1),l.SetOneIntelShapeDisplayColor(i,0,0,255,255),l.SetOneIntelShapeDisplayColor(i,1,0,255,255),l.SetOneIntelShapeThickness(i,2),$("ipcIntellentNew_max").checked?(l.SelectOneIntelShape(i,!0),l.SelectOneIntelShape(h,!1)):(l.SelectOneIntelShape(i,!1),l.SelectOneIntelShape(h,!0))},_changeRuleType:function(){0===$("ipcIntellentNew_RegionRuleType").selectedIndex?($("ipcIntellentNew_ruleDirectionWrap2").setStyle("display",""),$("ipcIntellentNew_minDuration_wrap").setStyle("display","none"),$$(".InsideRule").setStyle("display","none")):1==$("ipcIntellentNew_RegionRuleType").selectedIndex?($("ipcIntellentNew_ruleDirectionWrap2").setStyle("display","none"),$("ipcIntellentNew_minDuration_wrap").setStyle("display",""),$$(".InsideRule").setStyle("display","")):2==$("ipcIntellentNew_RegionRuleType").selectedIndex&&($("ipcIntellentNew_ruleDirectionWrap2").setStyle("display",""),$("ipcIntellentNew_minDuration_wrap").setStyle("display",""),$$(".InsideRule").setStyle("display",""))},_attachLimitCompare:function(a,b,c,d,e){var f=$(a),g=$(b);f.removeEvents("keyup"),f.removeEvents("blur"),f.addEvents({keyup:function(){limit(this,d)},blur:function(){limit(this,d),limitMin(this,c),e?this.value-0>g.value-0&&(this.value=g.value):this.value-0<g.value-0&&(this.value=g.value)}})}};V.SD={bind:function(){$("ipcIntellentNew_presets").addEvent("change",function(){var a=this.value-0,b=this.getSelected()[0];b&&b.hasClass("fn-color-ivsGreen")?this.addClass("fn-color-ivsGreen"):this.removeClass("fn-color-ivsGreen"),-1!==webApp.DeviceType.indexOf("SD")?g.PTZ.gotoPreset(a).always(function(){V._disabledDraw(!1),V._renderElements(i)}):(V._disabledDraw(!1),V._renderElements(i))})},render:function(){-1===webApp.DeviceType.indexOf("SD")||webApp.NoIntelliPreset?($$(".sd-line").addClass("fn-hide"),$("ipcIntellentNew_presets_wrap").addClass("fn-hide"),$("ipcIntellentNew_presets").empty(),$("ipcIntellentNew_presets").options.add(new Option(tl("com.AddPresetFirstTip"),0)),$("ipcIntellentNew_presets").fireEvent("change")):this.getPresets(function(){$("ipcIntellentNew_presets").fireEvent("change")})},getPresets:function(a){g.PTZ.getPresets().done(function(b){var c=b||[];if($("ipcIntellentNew_presets").empty(),0===c.length)$("ipcIntellentNew_presets").options.add(new Option(tl("com.AddPresetFirstTip"),-1)),a&&a();else{var d=$("ipcIntellentNew_presets");if(-1===webApp.DeviceType.indexOf("TPC")){for(var e=[],f=0;f<c.length;f++){var h=new Option(c[f].Name,c[f].Index);$(h).setProperty("title",c[f].Name),1===c[f].Type?($(h).addClass("fn-color-ivsGreen"),d.options.add(h)):($(h).addClass("fn-color-black"),e.push(h))}e.each(function(a){d.options.add(a)})}else{for(var i=0;i<c.length;i++){var j=new Option(c[i].Name,c[i].Index);$(j).setProperty("title",c[i].Name),d.options.add(j),$(j).addClass("fn-color-black")}for(var k in R[M])if(k.indexOf("Scene")>-1){var l=R[M][k].PtzPresetId;jQuery("#ipcIntellentNew_presets").find('[value="'+l+'"]').removeClass("fn-color-black").addClass("fn-color-ivsGreen")}}g.ConfigManager.getConfig("PtzMovement").done(function(a){"Preset"==a[0].Function&&($("ipcIntellentNew_presets").value=a[0].Index+1),$("ipcIntellentNew_presets").selectedIndex<0&&($("ipcIntellentNew_presets").selectedIndex=0)}).always(function(){a&&a()})}}).fail(function(){$$(".sd-line").addClass("fn-hide"),$("ipcIntellentNew_presets_wrap").addClass("fn-hide"),$("ipcIntellentNew_presets").empty(),$("ipcIntellentNew_presets").options.add(new Option(tl("com.AddPresetFirstTip"),0)),a&&a()})}}}}(),function(){function a(a){var b=a-0;return 10>a-0?"0"+(b-0):b}var b,c,d={},e={},f=574/86400,h={},k=0,m=require("jsCore/modules/timeSection"),n=Page.ivsConfig.Tab.Track={Tab:[],init:function(){n.bind(),n._DragInit()},_DragInit:function(){d=new Drag.Move("ivs_track_dayTime_slider",{snap:1,modifiers:{x:"left",y:""},container:$("ivs_track_slider_line"),onSnap:function(){},onDrag:function(a){$("ivs_track_slider_daytime").style.left=a.style.left.toInt()+1+"px";var b=$("ivs_track_nightTime_slider").getStyle("left").toInt()-a.style.left.toInt()-13;0>=b?(a.style.left=$("ivs_track_nightTime_slider").getStyle("left").toInt()-13+"px",$("ivs_track_slider_daytime").style.width="0px"):$("ivs_track_slider_daytime").style.width=b+"px",n._showStartTime(a)},onComplete:function(a){h.start=n._getTime(a.style.left.toInt()),n._setColorEEMode()}}),e=new Drag.Move("ivs_track_nightTime_slider",{snap:1,modifiers:{x:"left",y:""},container:$("ivs_track_slider_line"),onSnap:function(){},onDrag:function(a){var b=a.style.left.toInt()-$("ivs_track_dayTime_slider").getStyle("left").toInt()-13;$("ivs_track_slider_daytime").style.left=$("ivs_track_dayTime_slider").getStyle("left").toInt()+1+"px",0>=b?(a.style.left=$("ivs_track_dayTime_slider").getStyle("left").toInt()+13+"px",$("ivs_track_slider_daytime").style.width="0px"):$("ivs_track_slider_daytime").style.width=b+"px",$("ivs_track_slider_timeTitle").style.left=a.style.left.toInt()-11+"px",n._showEndTime(a)},onComplete:function(a){h.end=n._getTime(a.style.left.toInt()-13),n._setColorEEMode()}}),k=0},render:function(){l.hide(),h={},k=0,g.ConfigManager.getConfig(["TrackerPolicy","TrackerPolicySchedule"]).done(function(a){b=a[0].params.table,c=a[1].params.table,n._renderElements()})},bind:function(){$("newIntellent_confirm1_track").addEvent("click",n._onConfirmClick),$("newIntellent_refresh1_track").addEvent("click",n._onRefreshClick),$("newIntellent_default1_track").addEvent("click",n._onDefaultClick),$("ivs_draw_detect").addEvent("click",n._onDetectClick),$("ivs_track_dayTime_slider").addEvent("mouseover",function(){$("ivs_track_slider_timeTitle").style.display="",n._showStartTime(this)}).addEvent("mouseout",function(){$("ivs_track_slider_timeTitle").style.display="none"}),$("ivs_track_nightTime_slider").addEvent("mouseover",function(){$("ivs_track_slider_timeTitle").style.display="",n._showEndTime(this)}).addEvent("mouseout",function(){$("ivs_track_slider_timeTitle").style.display="none"}),$("ivs_track_setButton").removeEvents("click").addEvent("click",n._onSetupClick),$$("#ivs_track_visible,#ivs_track_thermal,#ivs_track_time").addEvent("click",n._onTrackMode)},leave:function(){},_renderElements:function(){"Visual"==b.TrackMode?($("ivs_track_visible").checked=!0,$("ivs_track_thermal").checked=!1,$("ivs_track_time").checked=!1,$$(".periodAuto").setStyle("display","none")):"Thermography"==b.TrackMode?($("ivs_track_visible").checked=!1,$("ivs_track_thermal").checked=!0,$("ivs_track_time").checked=!1,$$(".periodAuto").setStyle("display","none")):($("ivs_track_visible").checked=!1,$("ivs_track_thermal").checked=!1,$("ivs_track_time").checked=!0,$$(".periodAuto").setStyle("display",""),$("ivs_track_showNor").setStyle("display",""));var d=c.TimeSection[0][0],e=parsrTimeEx(d),g=e[1],i=e[2],j=e[3],k=e[4],l=e[5],m=e[6];h.start=a(e[1])+":"+a(e[2]),h.end=a(e[4])+":"+a(e[5]);var n=((3600*k+60*l+m)*f+13+.499999).round(),o=((3600*g+60*i+j)*f+.499999).round();0==g-0&&0==i-0&&(o=0),n>587&&(n=587),13>=n-o&&(o=n-13),$("ivs_track_nightTime_slider").style.left=n+"px",$("ivs_track_dayTime_slider").style.left=o+"px",$("ivs_track_slider_daytime").style.width=n-o-13+"px",$("ivs_track_slider_daytime").style.left=o+1+"px",$("ivs_track_slider_daytime").set("text",tl(""))},_onNormalMode:function(){$("ivs_track_showNor").setStyle("display",""),n._DragInit()},_onAdvanceMode:function(){$("ivs_track_showNor").setStyle("display","none")},_onTrackMode:function(){this.id.indexOf("_time")>-1?$$(".periodAuto").setStyle("display",""):$$(".periodAuto").setStyle("display","none")},_onDefaultClick:function(){h={},k=0,g.ConfigManager.getDefault(["TrackerPolicy","TrackerPolicySchedule"]).done(function(a){b=a[0].params.table,c=a[1].params.table,n._renderElements(),remarkDisplay("newIntellent_remark1",tl("com.DefaultSuccessTip"),3e3,0)}).fail(function(){remarkDisplay("newIntellent_remark1",tl("com.DefaultfailureTip"),3e3,1)})},_onRefreshClick:function(){h={},k=0,g.ConfigManager.getConfig(["TrackerPolicy","TrackerPolicySchedule"]).done(function(a){b=a[0].params.table,c=a[1].params.table,n._renderElements(),remarkDisplay("newIntellent_remark1",tl("com.OperateSuccessTip"),3e3,0)}).fail(function(){remarkDisplay("newIntellent_remark1",tl("com.OperateFailTip"),3e3,1)})},_onConfirmClick:function(){if(b.TrackMode=$("ivs_track_visible").checked?"Visual":$("ivs_track_thermal").checked?"Thermography":"TimeSection",$("ivs_track_normal").checked){for(c.Mode="Normal",j=0;j<c.TimeSection[0].length;j++)j>0&&(c.TimeSection[0][j]="0 00:00:00-23:59:59");for(i=0;i<c.TimeSection.length;i++)c.TimeSection[i]=c.TimeSection[0]}else c.Mode="Advanced";$("ivs_track_time").checked?g.ConfigManager.setConfig(["TrackerPolicy","TrackerPolicySchedule"],[b,c]).done(function(){remarkDisplay("newIntellent_remark1",tl("com.SaveSuccessTip"),3e3,0)}).fail(function(){remarkDisplay("newIntellent_remark1",tl("com.SaveConfigFailTip"),3e3,1)}):g.ConfigManager.setConfig(["TrackerPolicy"],[b]).done(function(){remarkDisplay("newIntellent_remark1",tl("com.SaveSuccessTip"),3e3,0)}).fail(function(){remarkDisplay("newIntellent_remark1",tl("com.SaveConfigFailTip"),3e3,1)})},_showStartTime:function(a){var b;a=a||this,b=a.style.left.toInt(),$("ivs_track_slider_timeTitle").style.left=b-18+"px",$("ivs_track_slider_timeTitle").set("text",n._getTime(b))},_showEndTime:function(a){var b;a=a||this,b=a.style.left.toInt(),$("ivs_track_slider_timeTitle").style.left=b-11+"px",$("ivs_track_slider_timeTitle").set("text",n._getTime(b-13))},_getTime:function(a){var b={};return a>574&&(a=574),a=a/574*24*60,b.hour=(a/60).toInt(),b.minite=(a%60).toInt(),b.hour<10&&(b.hour="0"+b.hour),b.minite<10&&(b.minite="0"+b.minite),"{hour}:{minite}".substitute(b)},_chkTime:function(){var a=h.start,b=h.end,c=a.split(":")[0]-0,d=a.split(":")[1]-0,e=0,f=b.split(":")[0]-0,g=b.split(":")[1]-0,i=0,j=60*(60*c+d)+e,k=60*(60*f+g)+i;return 24==c&&24==f||c>f?!0:j==k},_setColorEEMode:function(){if(1!=k){c.TimeSection[0][1]="0 00:00:00-23:59:59";var b=h.start,d=h.end,e=b.split(":")[0]-0,f=b.split(":")[1]-0,g=0,i=d.split(":")[0]-0,j=d.split(":")[1]-0,l=0,m=a(i),n=a(j),o=a(l),p=a(e),q=a(f),r=a(g),s=m+":"+n+":"+o,t=p+":"+q+":"+r;c.TimeSection[0][0]="1 "+t+"-"+s,c.TimeSection[0][1]="0 00:00:00-00:00:00"}},_onSetupClick:function(){c&&c.TimeSection&&m.open(c.TimeSection).done(function(a){c.TimeSection=a})},_onLinkChange:function(){var a=this.value,b=$("ipcIntellentNew_address1"),c=$("ipcIntellentNew_addressInput1"),d=parseInt(c.value);if(d=isNaN(d)?0:d,"None"==a)b.setStyle("display","none"),c.setStyle("display","none");else{switch(b.setStyle("display",""),c.setStyle("display",""),a){case"Preset":attachLimit(c,g_ptzCap.PresetMin,g_ptzCap.PresetMax);break;case"Tour":attachLimit(c,g_ptzCap.TourMin,g_ptzCap.TourMax);break;case"Pattern":attachLimit(c,g_ptzCap.PatternMin,g_ptzCap.PatternMax)}c.fireEvent("blur")}}}}()}),define("PtzCmd",function(require,a,b){var c=require("jsCore/rpc"),d=new Class({moreFunc:function(){},initialize:function(a,b,c){this.dom=$(a),"function"==typeof c&&(this.moreFunc=c),this.option=b,this.step=5,this.newProtocol=webApp.IsNewProtocol&&-1!==webApp.DeviceType.indexOf("SD"),this.initDom(),this.bind(),this.dom.translation()},initDom:function(){var a='<div class="fn-left fn-width150"><div class="ui-boat fn-marl10"><div class="ui-boat-current"><div class="ui-boat-box-up boat ptzcontrol" data-hover="up" data-cmd="Up"></div><div class="ui-boat-box-left boat ptzcontrol" data-hover="left" data-cmd="Left"></div><div class="ui-boat-box-center" data-hoverEx="img3" data-cmdEx="Default"></div><div class="ui-boat-box-right boat ptzcontrol" data-hover="right" data-cmd="Right"></div><div class="ui-boat-box-down  boat ptzcontrol" data-hover="down" data-cmd="Down"></div></div></div><div class="ui-form-item capStep" ><label class="ui-label fn-width-auto fn-marr4" t="itc.Step"></label><select class="ui-select fn-width60" onmousewheel="javascript:return false"><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5" selected="">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option></select></div></div><div class="fn-left ptz-adjust"><div class="ui-ptz-adjust-item fn-clear capZoom"><a class="ui-ptz-icon ptzcontrol" data-cmd="ZoomWide"><i class="ui-ptz-icon-less" data-cmd="ZoomWide"></i></a><label class="ui-ptz-adjust-text" t="itc.ChangeZoom"></label><a class="ui-ptz-icon ptzcontrol ZoomTele" data-cmd="ZoomTele"><i class="ui-ptz-icon-more" data-cmd="ZoomTele"></i></a></div><div class="ui-ptz-adjust-item fn-clear capFocus"><a class="ui-ptz-icon ptzcontrol" data-cmd="FocusFar"><i class="ui-ptz-icon-less" data-cmd="FocusFar"></i></a><label class="ui-ptz-adjust-text" t="med.Focus"></label><a class="ui-ptz-icon ptzcontrol" data-cmd="FocusNear"><i class="ui-ptz-icon-more" data-cmd="FocusNear"></i></a></div><div class="ui-ptz-adjust-item fn-clear capIris"><a class="ui-ptz-icon ptzcontrol"  data-cmd="IrisSmall"><i class="ui-ptz-icon-less" data-cmd="IrisSmall"></i></a><label class="ui-ptz-adjust-text" t="pfm.Iris"></label><a class="ui-ptz-icon ptzcontrol" data-cmd="IrisLarge"><i class="ui-ptz-icon-more" data-cmd="IrisLarge"></i></a></div></div><div class="fn-left fn-padt10 fn-padl20"><div class="ui-form-item" ><a data-cmd="markSceneMaxZoom" href="javascript:;" class=" fn-marb10 ui-button fn-hide markSceneMaxZoom" t="ivs.SetTrackDynameter"></a></div><div class="ui-form-item" ><a data-cmd="setPreset" href="javascript:;" class="ui-button fn-hide setPreset" t="ivs.SavePreset"></a></div></div>';this.dom.set("html",a),this.domHover=this.dom.getElement(".ui-boat-current");var b=this.dom;c.PTZ.getCurrentProtocolCaps().done(function(a){a&&(a.Zoom===!1&&b.getElement(".capZoom").addClass("fn-hide"),a.Focus===!1&&b.getElement(".capFocus").addClass("fn-hide"),a.Iris===!1&&b.getElement(".capIris").addClass("fn-hide"),a.PTZCtrl&&a.PTZCtrl.PTStep===!1&&b.getElement(".capStep").addClass("fn-hide"))});var d=this;ability.get("TrackPositionLimit").done(function(a){a&&a.Support&&d.option.markScene===!0&&d.dom.getElements(".markSceneMaxZoom").removeClass("fn-hide")}),this.option.setPreset===!0&&this.dom.getElements(".setPreset").removeClass("fn-hide"),this.dom.setStyles({"float":"left","min-width":"400px","min-height":"130px"})},bind:function(){var a=this;a.dom.getElements(".ptzcontrol").each(function(b){b.addEvents({mousedown:function(b){var d=b.target.getProperty("data-cmd");this.addClass("mouse-down"),null!==d&&c.PTZ.start(d,a.step,0,0,0)},mouseout:function(b){var d=b.target.getProperty("data-cmd");this.hasClass("mouse-down")&&(this.removeClass("mouse-down"),c.PTZ.stop(d,a.step,0,0,0),a.moreFunc())},mouseup:function(b){var d=b.target.getProperty("data-cmd");this.removeClass("mouse-down"),null!==d&&(c.PTZ.stop(d,a.step,0,0,0),a.moreFunc())}})}),a.dom.getElements(".boat").each(function(b){b.addEvents({mouseover:function(){if(this.getProperty){var b=this.getProperty("data-hover");null!=b&&a.domHover.addClass("ui-boat-current-"+b)}},mouseout:function(b){if(b.target.getProperty){var c=(b.target.getProperty("data-cmd"),b.target.getProperty("data-hover"));null!=c&&a.domHover.removeClass("ui-boat-current-"+c)}}})}),a.dom.getElement("select").addEvent("change",function(b){a.step=b.target.value-0}),a.dom.getElements("a").addEvent("click",function(){var a=this.getProperty("data-cmd"),b=$("ivs_global_presets").value-0,d=$("ivs_global_presets").getSelected()[0].text;switch(a){case"markSceneMaxZoom":var e=$("ivs_global_presets").value-0,f=0;if(0>=e)return void remarkDisplay("ivs_global_remark",tl("notIvsPresetNow"),6e3,1);c.PTZ.getStatus().done(function(a){var b=a.Postion[2];c.ConfigManager.getConfig("VideoAnalyseModule").done(function(a){for(var d=a,g=0;g<d[f].length;g++)if(d[f][g].PtzPresetId==e){d[f][g].MaxTrackZoom=b;break}c.ConfigManager.setConfig("VideoAnalyseModule",d).done(function(){remarkDisplay("ivs_global_remark",tl("com.OperateSuccessTip"),3e3,0)})})}).fail(function(){remarkDisplay("ivs_global_remark",tl("ptz.getStatusError"),3e3,1)});break;case"setPreset":c.PTZ.setPreset(b,d).done(function(){remarkDisplay("ivs_global_remark",tl("com.OperateSuccessTip"),3e3,0)}).fail(function(){remarkDisplay("ivs_global_remark",tl("com.OperateFailTip"),3e3,1)})}})}});b.exports={init:function(a,b){new d(a,b)},destory:function(){}}});