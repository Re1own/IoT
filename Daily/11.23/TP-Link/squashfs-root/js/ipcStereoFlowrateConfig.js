!function(a){define(function(require,b,c){c.exports=require("jsCore/pageTab"),c.exports.prototype.ipc_stereoFlowrateScale=ability.get("IVSCaps").then(function(a){return!(a.SupportedScenes.StereoNumber.SupportedSceneParams&&a.SupportedScenes.StereoNumber.SupportedSceneParams.HiddenDetail)}),c.exports.prototype.ipc_stereoFlowReport=ability.get("IVSCaps").then(function(b){var c=!1;return a.each(b.SupportedScenes.StereoNumber.SupportedRules,function(a,b){return b.SupportLocalDataStore!==!1?(c=!0,!1):void 0}),c})}),define("ipc_stereoFlowrateRule",function(require,b,c){var d=require("jsCore/rpc"),e=require("jsCore/pageBase"),f=require("jsCore/ability"),g=require("jsCore/rpcLogin"),h=require("jsCore/modules/timeSection"),i=require("jsCore/flashplayer"),j=require("jsCore/h5player"),k=require("jsCore/pluginCanvas");require("jsCore/modules/eventHandler");var l=null,m=0,n="StereoNumber",o=[],p=[],q=0,r=0,s=0,t=null,u=null,v=null,w=null,x="",y=[],z=null,A={},B="StereoNumberStat",C={StereoNumberStat:"NumberStat"};c.exports=e.extend({init:function(){var b=a.Deferred(),c=a.Deferred();l=this,z=["VideoAnalyseRule","VideoWidgetNumberStat"],p=[],l.$("[slider=sensitivity]").slider({min:1,max:10,complete:function(a,b){w.Config.Sensitivity=b.value}}),l.$("[slider=Threshold]").slider({min:1,max:100,complete:function(a,b){w.Config.Threshold=b.value}}),l.$("#ste_MinHeight").numberfield({min:0,max:200,allowDecimal:!1}).blur(function(){var b=a(this).val()-0,c=l.$("#ste_MaxHeight").val()-0;b>c&&(w.Config.MaxHeight=b,l.$("#ste_MaxHeight").val(b)),w.Config.MinHeight=b}),l.$("#ste_MaxHeight").numberfield({min:0,max:300,allowDecimal:!1}).blur(function(){var b=a(this).val()-0,c=l.$("#ste_MinHeight").val()-0;c>b&&(l.$("#ste_MinHeight").val(b),w.Config.MinHeight=b),w.Config.MaxHeight=b}),l.$("#s_m_StayDetectTime").numberfield({max:65535,min:0,allowDecimal:!1,allowNegative:!1}),l.$("[cfgKye = EnterThreshold], [cfgKye = ExitThreshold], [cfgKye = InsideThreshold]").numberfield({min:0,max:65535,allowDecimal:!1,allowNegative:!1}),l.$("[cfgKye = Threshold]").numberfield({max:30,min:0,allowDecimal:!1,allowNegative:!1}),l.$("[cfgKye = StayMinDuration]").numberfield({max:1800,min:1,allowDecimal:!1,allowNegative:!1}),f.get("IVSCaps").done(function(b){var c=b.SupportedScenes[n],d={},e={StereoNumberStat:tl("NumberStat")};r=b.MaxRules,q=c.MaxRules,a.each(c.SupportedRules,function(a){p.push(a),d[a]=e[a]||tl(a)}),-1===p.indexOf(B)&&(B=p[0]),c.SupportedSceneParams&&c.SupportedSceneParams.HiddenDetail?(l.$("#ste_MaxHeight, #ste_MinHeight").parent().remove(),z.push("StereoCalibrate")):l.$("[sel-for=onLeanVer]").parent().remove(),u=l.$("#ste_ruleManager").table({height:52,columns:[{check:"Enable",width:"5%",checkItem:function(a,b,c){l.checkEnable(c.data.Enable)},checkAll:function(a){l.checkEnable(a.target.checked)}},{t:"com.Numbers",width:"8%",render:function(a){return a._index+1}},{t:"com.Name",width:"25%",fields:"Name",limit:63,render:function(b){return a('<label class="ui-label fn-width100" t="'+b.Name+'"></label>')},editor:function(){return a('<input type="text" class="u-input" />')}},{t:"com.RuleType",width:"44%",fields:"Type",singleSel:!0,valueMap:d,editor:function(b,c){var d="",e=c.valueMap;if(e){d="<select>";for(var f in e)d+='<option value="'+f+'">'+e[f]+"</option>";d+="</select>"}return a(d)}},{t:"com.Delete",width:"8%",action:"delete",icon:"i-del",titleIcon:"ui-set-icon-add",handle:function(a){this.del(a),l.delRule(a.Type),w=null},titleAction:function(){l.addRule()}}],onRowSelect:function(a,b){l.saveRule(),w=b.data,l.renderRule(),l.renderOCX()},onblurEditor:function(a,b){if("Type"==b.field){var c=b.editVal,d=y.indexOf(c);return-1!==d?(y.splice(d,1),y.push(b.data.Type),l.changeRuleType(c),!0):(l.$("#ste_tip").tip("warning",tl("com.SameRuleOnlyOneTip")),!1)}if("Name"==b.field){if(!b.editVal)return!1;l.changeRuleName(b.editVal,b._index-0)}}})}),d.VideoInAnalyse.getTemplateRule(n).done(function(a){t=a[n],b.resolve()}).always(function(){b.resolve()}),webApp.EventCaps?d.EventManager.getEventLink(p).done(function(b){var c=a.extend(!0,{},webApp.EventCaps,webApp.DefaultEvent);v={},a.each(b.name,function(b,d){v[p[b]]=d,a.each(d,function(a,d){"default"===d?(c=webApp.EventCaps,v[p[b]]=null):c[d]=!0})}),l.$("#ste_eventHandler").eventHandler(c)}).fail(function(){l.$("#ste_eventHandler").eventHandler(webApp.EventCaps)}).always(function(){c.resolve()}):(l.$("#ste_eventHandler").eventHandler(),c.resolve()),a.when(b,c).done(function(){l.render()}),"flash"===webApp.playMode},render:function(){if(plugin.addEvent("OutPutStringInfo",function(a,b){b=JSON.parse(b),"OutPutShapeRect"===a&&(b.Config.DetectRegion&&(w.Config.DetectRegion=b.Config.DetectRegion),b.Config.DetectLine&&(w.Config.DetectLine=b.Config.DetectLine))}),"flash"===webApp.playMode||"h5"===webApp.playMode){if(a.subscribe("IVSRuleConfig",function(a,b){(void 0===w.shapeId||w.shapeId===b.shapeID||w.shapeId2===b.shapeID)&&("Polygon"===b.shapeName&&(w.Config.DetectRegion=b.data,w.shapeId=b.shapeID),"LineShape"===b.shapeName&&(w.Config.DetectLine=b.data,w.shapeId2=b.shapeID,k.SetVideoAnalyseShapeDirection(l.containerId,w.shapeId2,0)))}),"flash"===webApp.playMode&&(i.cover(l.$("#steVideo")),i.playPreview(1,0),d.ConfigManager.getConfig(["Encode","VideoImageControl"]).done(function(a){if(webApp.resolution.x=a[0].params.table[0].MainFormat[0].Video.Width,webApp.resolution.y=a[0].params.table[0].MainFormat[0].Video.Height,1==a[1].params.table[0].Rotate90||2==a[1].params.table[0].Rotate90){var b;b=webApp.resolution.x,webApp.resolution.x=webApp.resolution.y,webApp.resolution.y=b}setTimeout(function(){k.cover("#steVideo",webApp.resolution.x+"*"+webApp.resolution.y),l.containerId=k.CreateVideoAnalyseContainer(),k.showMult=!0,l.getConfig()},1e3)})),"h5"===webApp.playMode){var b=a.Deferred();j.playPreview(1,0,l.$("#steVideo"),null,b),b.done(function(a){webApp.resolution.x=a.width,webApp.resolution.y=a.height}),k.cover("#steVideo",webApp.resolution.x+"*"+webApp.resolution.y),l.containerId=k.CreateVideoAnalyseContainer(),k.showMult=!0,l.getConfig()}}else"ocx"===webApp.playMode&&(plugin.cover("#steVideo",function(a){plugin.SetRegionNum(0),plugin.SetModuleMode(2),g.chkAuthority("Monitor_01")&&plugin.open(),a&&l.renderOCX()}),l.getConfig())},getConfig:function(b){d.ConfigManager.getConfig(z).done(function(c){a.each(c,function(a,b){A[z[a]]=b.params.table}),l.fliterRule(),b&&l.$("#ste_tip").tip("success",tl("com.OperateSuccessTip"))}).fail(function(){b&&l.$("#ste_tip").tip("error",tl("com.OperateFailTip"))})},fliterRule:function(){("flash"===webApp.playMode||"h5"===webApp.playMode)&&k.DeleteAllVideoAnalyseShape(l.containerId),w=null,o.length=0,s=0,y=a.extend(!0,[],p),a.each(A.VideoAnalyseRule[m],function(a,b){b.Class===n?(o.push(b),y.splice(y.indexOf(b.Type),1)):s++}),u.table("dataSource",o).table("selectRow",0),l._checkRuleNum()},renderRule:function(){x=w.Type;var b=w.Config,c=A.VideoWidgetNumberStat[m],d=l.$("[rule *= "+x+"]"),e=l.$("[show-for *= "+x+"]");if(l.$("[show-for]").hide(),e.show(),v){var f=l.$("#ste_eventHandler").find("[cap]"),g=v[x];g?f.each(function(){var b=a(this).attr("cap");a(this).closest(".ui-form-item").toggleClass("fn-hide",-1===g.indexOf(b))}):f.closest(".ui-form-item").removeClass("fn-hide")}l.$('[slider="sensitivity"]').slider("value",b.Sensitivity),l.$("#ste_MinHeight").val(b.MinHeight),l.$("#ste_MaxHeight").val(b.MaxHeight),d.each(function(){var c=a(this).attr("cfgKye"),d=a(this).prop("type");"checkbox"===d?a(this).prop("checked",b[c]):a(this).val(b[c])}),"StereoNumberStat"===x?!c.EncodeBlend||c.ShowEnterNum||c.ShowExitNum?(l.$("#ste_ShowEnterNum").prop("checked",c.EncodeBlend&&c.ShowEnterNum),l.$("#ste_ShowExitNum").prop("checked",c.EncodeBlend&&c.ShowExitNum)):(l.$("#ste_ShowEnterNum").prop("checked",!0),l.$("#ste_ShowExitNum").prop("checked",!0)):l.$("#ste_ShowInsideNum").prop("checked",c.EncodeBlend&&c.ShowInsideNum),A.StereoCalibrate&&l.$("[sel-for=onLeanVer]").val(A.StereoCalibrate[m].CameraAngle),l.$("#ste_eventHandler").eventHandler("set",w.EventHandler)},renderOCX:function(){var a=l._ruleInitEmpty();if("flash"===webApp.playMode||"h5"===webApp.playMode){if(w.shapeId?k.ShowVideoAnalyseShape(l.containerId,w.shapeId):w.shapeId=a?k.CreateMainVideoAnalyseShape(l.containerId,"Polygon",null,{showName:w.Name}):k.CreateMainVideoAnalyseShape(l.containerId,"Polygon",w.Config.DetectRegion,{showName:w.Name}),k.SelectVideoAnalyseShape(l.containerId,w.shapeId,!1),"StereoNumberStat"===x){var b=l._ruleInitEmpty(!0,w.Name+"_dir");if(w.shapeId2)k.ShowVideoAnalyseShape(l.containerId,w.shapeId2);else{var c=b?null:w.Config.DetectLine;w.shapeId2=k.CreateMainVideoAnalyseShape(l.containerId,"LineShape",c),b||k.SetVideoAnalyseShapeDirection(l.containerId,w.shapeId2,0)}}}else plugin.SetIVSConfig(l._buildRuleJson(),2),plugin.SetCurShape(w.Name),a||plugin.SetCurShape("save")},saveRule:function(){if(!w)return!1;var b=w.Config;if(l.$("[rule *= "+x+"]").each(function(){var c=a(this).attr("cfgKye"),d=a(this).prop("type");b[c]="checkbox"===d?a(this).prop("checked"):a(this).val()-0}),A.VideoWidgetNumberStat){var c=A.VideoWidgetNumberStat[m];"StereoNumberStat"===x?(c.ShowInsideNum=!1,c.ShowEnterNum=l.$("#ste_ShowEnterNum").prop("checked"),c.ShowExitNum=l.$("#ste_ShowExitNum").prop("checked"),c.EncodeBlend=c.ShowEnterNum||c.ShowExitNum,c.EncodeBlend||(c.ShowEnterNum=!0,c.ShowExitNum=!0)):(c.ShowEnterNum=!1,c.ShowExitNum=!1,c.ShowInsideNum=l.$("#ste_ShowInsideNum").prop("checked"),c.EncodeBlend=c.ShowInsideNum,c.EncodeBlend||(c.ShowInsideNum=!0))}A.StereoCalibrate&&(A.StereoCalibrate[m].CameraAngle=l.$("[sel-for=onLeanVer]").val()-0),w.EventHandler=l.$("#ste_eventHandler").eventHandler("get"),("flash"===webApp.playMode||"h5"===webApp.playMode)&&(w.shapeId&&k.SelectVideoAnalyseShape(l.containerId,w.shapeId,!1),w.shapeId2&&k.SelectVideoAnalyseShape(l.containerId,w.shapeId2,!1))},checkEnable:function(a){a?l.renderOCX():plugin.SetIVSConfig("",2)},delRule:function(a){l._checkRuleNum(),y.push(a)},addRule:function(){var b=B,c=a.extend(!0,{},t[b]),d=o.length;c.Enable=!0,c.Name=l._getUniqueName(),u.table("add",c,-1).table("selectRow",d),l._checkRuleNum(),y.splice(y.indexOf(b),1)},changeRuleType:function(b){w.Type=b,w.Config=a.extend(!0,{},t[b].Config),("flash"===webApp.playMode||"h5"===webApp.playMode)&&(k.DeleteAllVideoAnalyseShape(l.containerId),delete w.shapeId,delete w.shapeId2),l.renderRule(),l.renderOCX()},changeRuleName:function(a,b){return u.table("getSelectedRow")===b?(plugin.SetCurShape(w.Name),w.Name=a,plugin.SetCurName(a),plugin.SetCurShape("save"),!0):void 0},_checkRuleNum:function(){var a=o.length,b=Math.min(r-s-a,q-a);l.disabled(l.$("[data-action=titleAction]"),!b),l.$("[data-emptyreules]").toggleClass("fn-hide",!a),o.length||plugin.SetIVSConfig("",2)},_getUniqueName:function(){var b=[],c=tl("com.Rule"),d=new RegExp("(^"+c+")(\\d*)$"),e=0;a.each(A.VideoAnalyseRule[m],function(a,c){c.Class!==n&&(e=d.exec(c.Name),e&&b.push(e[2]-0))}),a.each(o,function(a,c){e=d.exec(c.Name),e&&b.push(e[2]-0)}),b.sort(function(a,b){return a-b});var f=b.length+1;return a.each(b,function(a,b){return b-a>1?(f=a+1,!1):void 0}),c+f},onSetPeriod:function(){w.EventHandler.TimeSection&&(plugin.hide(),h.open(w.EventHandler.TimeSection).done(function(a){w.EventHandler.TimeSection=a}).always(function(){"hls"!=webApp.playMode&&"flash"!=webApp.playMode&&"h5"!=webApp.playMode&&plugin.cover("#steVideo")}))},onDrawRule:function(){if(!w.Enable)return void l.$("#ste_tip").tip("warning",tl("com.RuleIsntEnableTip"));var a=l._ruleInitEmpty(!0);return a?(l.$("#ste_tip").tip("error",tl("com.PleaseDrawShapeTip")),void("flash"===webApp.playMode||"h5"===webApp.playMode?k.RedrawVideoAnalyseShape(l.containerId,w.shapeId):(plugin.SetCurShape(w.Name),plugin.AddShape(2,w.Type,w.Name,-1,0)))):void("flash"===webApp.playMode||"h5"===webApp.playMode?(k.ShowVideoAnalyseShape(l.containerId,w.shapeId),k.SelectVideoAnalyseShape(l.containerId,w.shapeId)):"StereoNumberStat"===x?plugin.SetCurShape(w.Name):plugin.SelectRule(w.Name,0))},onClearRule:function(){return w.Enable?(w.Config.DetectRegion=null,void("flash"===webApp.playMode||"h5"===webApp.playMode?k.RedrawVideoAnalyseShape(l.containerId,w.shapeId):(plugin.DeleteShape(w.Name),plugin.SetIVSConfig(l._buildRuleJson(),2),l.onDrawRule()))):void l.$("#ste_tip").tip("warning",tl("com.RuleIsntEnableTip"))},onDrawDir:function(){var a=w.Name+"_dir";if(!w.Enable)return void l.$("#ste_tip").tip("warning",tl("com.RuleIsntEnableTip"));var b=l._ruleInitEmpty(!0,a);return b?void("flash"===webApp.playMode||"h5"===webApp.playMode?k.RedrawVideoAnalyseShape(l.containerId,w.shapeId2):(plugin.DeleteShape(a),plugin.AddShape(2,w.Type,a,-1,0))):void("flash"===webApp.playMode||"h5"===webApp.playMode?(k.ShowVideoAnalyseShape(l.containerId,w.shapeId2),k.SelectVideoAnalyseShape(l.containerId,w.shapeId2)):"StereoNumberStat"===x?plugin.SetCurShape(a):plugin.SelectRule(a,0))},onClearDir:function(){if(!w.Enable)return void l.$("#ste_tip").tip("warning",tl("com.RuleIsntEnableTip"));var a=w.Name+"_dir";"StereoNumberStat"===x&&(w.Config.DetectLine=null),"flash"===webApp.playMode||"h5"===webApp.playMode?k.RedrawVideoAnalyseShape(l.containerId,w.shapeId2):(plugin.DeleteShape(a),plugin.SetIVSConfig(l._buildRuleJson(),2),l.onDrawDir())},_buildRuleJson:function(){return JSON.stringify({result:!0,params:{table:[[w]]}})},_ruleInitEmpty:function(a,b){var c=w.Config.DetectRegion||[[0,0],[0,0],[0,0],[0,0]],d=!0;b&&(c=w.Config.DetectLine||[[0,0],[0,0]]);for(var e=c.length;e--;)if(c[e][0]||c[e][1]){d=!1;break}return d&&!a&&plugin.DeleteShape(b||w.Name),d},_checkUniqueName:function(){var b=[],c=[],d=[],e=[],f="";return a.each(A.VideoAnalyseRule[m],function(a,d){d.Class!==n&&(b.push(d.Name),c.push(d.Type))}),a.each(o,function(a,g){var h=d.indexOf(g.Name),i=b.indexOf(g.Name);return-1!==h?(f=tl(C[e[h]]||e[h])+" "+tl("com.And")+" "+tl(C[g.Type]||g.Type)+" "+tl("com.GroupNameSameTip"),!1):(d.push(g.Name),e.push(g.Type),-1!==i?(f=tl(C[c[i]]||c[i])+" "+tl("com.And")+" "+tl(C[g.Type]||g.Type)+" "+tl("com.GroupNameSameTip"),!1):void 0)}),f},onClearZero:function(){d.VideoStatServer.clearSectionStat()},leave:function(){plugin.SetIVSConfig("",2),plugin.addEvent("OutPutStringInfo",null),plugin.hide(),plugin.close(),"h5"===webApp.playMode&&(j.hide(),k.hide(),a.unsubscribe("IVSRuleConfig",null)),"flash"===webApp.playMode&&(i.hide(),k.hide(),a.unsubscribe("IVSRuleConfig",null))},onDefault:function(){d.ConfigManager.getDefault(z).done(function(b){var c=a.grep(A.VideoAnalyseRule[m],function(a){return a.Class!==n});a.each(b,function(a,b){A[z[a]]=b.params.table});var d=a.grep(A.VideoAnalyseRule[m],function(a){return a.Class===n});A.VideoAnalyseRule[m]=a.merge(c,d),l.fliterRule(),l.$("#ste_tip").tip("success",tl("com.DefaultSuccessTip"))}).fail(function(){l.$("#ste_tip").tip("success",tl("com.DefaultfailureTip"))})},onRefresh:function(){l.getConfig(!0)},onConfirm:function(){plugin.SetCurShape("save"),l.saveRule();var b=l._checkUniqueName();if(b)return l.$("#ste_tip").tip("warning",b),!1;if(w&&!w.Config.DetectRegion)return l.$("#ste_tip").tip("error",tl("com.PleaseDrawShapeTip"));if(w&&"StereoNumberStat"===w.Type&&!w.Config.DetectLine)return l.$("#ste_tip").tip("error",tl("com.PleaseDrawLineTip"));A.VideoAnalyseRule[m]=l._reBackConfig();var c=[];a.each(A,function(a,b){c.push(b)}),d.ConfigManager.setConfig(z,c).done(function(){l.$("#ste_tip").tip("success",tl("com.SaveSuccessTip"))}).fail(function(){l.$("#ste_tip").tip("error",tl("com.SaveConfigFailTip"))})},_reBackConfig:function(){var b=a.grep(A.VideoAnalyseRule[m],function(a){return a.Class!==n}),c=a.extend(!0,[],o);return a.each(c,function(a,c){delete c.__id,delete c._index,delete c.shapeId,delete c.shapeId2,b.push(c)}),b}})}),define("ipc_stereoFlowrateScale",function(require,b,c){var d=require("jsCore/rpc"),e=require("jsCore/pageBase"),f=require("jsCore/plugin"),g=require("jsCore/modules/naclDraw"),h=(require("jsCore/ability"),require("common/common"),require("jsCore/pluginCanvas")),i=require("jsCore/h5player"),j=require("jsCore/flashplayer");require("widget/js/dui.slider"),require("jsCore/modules/eventHandler");var k=null,l=0,m=null,n=null,o=null,p=null,q="ScaleArea",r=-1,s=0,t=0,u=[],v=!1;c.exports=e.extend({init:function(){k=this,k.$("#ipcStereoFlowrate_cameraHeight").numberfield({min:0,max:1e3,allowDecimal:!1,allowNegative:!1}),k.$("#ipcStereoFlowrate_cameraAngle").numberfield({min:0,max:90,allowDecimal:!0,decimalPrecision:1,allowNegative:!1}),k.render()},render:function(){if("flash"===webApp.playMode||"h5"===webApp.playMode)if(a.subscribe("IVSRuleConfig",function(a,b){"MinGatherRegion"===b.shapeName&&(o[l].CalibrateArea[r].Area=b.data)}),"flash"===webApp.playMode)j.cover(k.$("#i_sff_video")),j.playPreview(1,0),d.ConfigManager.getConfig(["Encode","VideoImageControl"]).done(function(a){if(webApp.resolution.x=a[0].params.table[0].MainFormat[0].Video.Width,webApp.resolution.y=a[0].params.table[0].MainFormat[0].Video.Height,1==a[1].params.table[0].Rotate90||2==a[1].params.table[0].Rotate90){var b;b=webApp.resolution.x,webApp.resolution.x=webApp.resolution.y,webApp.resolution.y=b}h.cover("#i_sff_video",webApp.resolution.x+"*"+webApp.resolution.y),k.containerId=h.CreateVideoAnalyseContainer(),k._getConfig(!1)});else{var b=a.Deferred();i.playPreview(1,0,k.$("#i_sff_video"),null,b),b.done(function(a){webApp.resolution.x=a.width,webApp.resolution.y=a.height}),h.cover("#i_sff_video",webApp.resolution.x+"*"+webApp.resolution.y),k.containerId=h.CreateVideoAnalyseContainer(),k._getConfig(!1)}else"ocx"===webApp.playMode&&f.cover("#i_sff_video",function(){f.SetRegionNum(0),f.SetModuleMode(2),f.open(),a.browser.chrome&&a.browser.version>41?g.render(k._outPutNaclGroudRect):f.addEvent("OutPutStringInfo",function(a,b){switch(a){case"OutPutGlobalLaneInfo":k._outPutGlobalCalibrateInfo(b)}}),k._getConfig(!1)})},leave:function(){"flash"===webApp.playMode?(h.hide(),j.hide(),k.ScaleShapeId=null,a.unsubscribe("IVSRuleConfig",null)):"h5"===webApp.playMode?(i.hide(),j.hide(),k.ScaleShapeId=null,a.unsubscribe("IVSRuleConfig",null)):a.browser.chrome&&a.browser.version>41?g.leave():(f.addEvent("OutPutStringInfo",null),f.SetIVSConfig("",2)),f.hide(),f.close()},destory:function(){a.browser.chrome&&a.browser.version>41&&g.leave()},_getConfig:function(a){d.ConfigManager.getConfig(["StereoCalibrate","VideoAnalyseGlobal"]).done(function(b){k._renderElements(b),a&&k.$("#i_sff_tip").tip("success",tl("com.OperateSuccessTip"))}).fail(function(){k.$("#i_sff_tip").tip("error",tl("com.OperateFailTip"))}),d.ConfigManager.getConfig("VideoAnalyseRule").done(function(a){v=!1;for(var b=a[l],c=0;c<b.length;c++)if(b[c]&&"StereoNumber"===b[c].Class&&b[c].Enable){v=!0;break}}).fail(function(){v=!1})},_renderElements:function(b){if(m=b[0].params.table&&b[0].params.table,n=b[1].params.table&&b[1].params.table,o=a.extend(!0,{},n),a.each(o[l].CalibrateArea,function(a,b){b&&"Stereo"===b.Method&&(r=a)}),"flash"===webApp.playMode,m[l]){var c=m[l].CameraHeight,d=m[l].CameraAngle;0>c&&(c=0),0>d&&(d=0),k.$("#ipcStereoFlowrate_cameraHeight").numberfield("value",c||0),k.$("#ipcStereoFlowrate_cameraAngle").numberfield("value",d||0),s=d,t=c}n&&(u=n[l].CalibrateArea[r].Area),a.browser.chrome&&a.browser.version>41&&"flash"!==webApp.playMode&&"h5"!==webApp.playMode?setTimeout(k._renderNaclCalibrateOcx,200):k._renderCalibrateOcx()},_renderCalibrateOcx:function(){if(o[l]){var a=n[l].CalibrateArea,b=k._ruleInitEmpty(!0);"flash"===webApp.playMode||"h5"===webApp.playMode?(h.DeleteAllVideoAnalyseShape(k.containerId),k.ScaleShapeId=h.CreateMainVideoAnalyseShape(k.containerId,"MinGatherRegion",b?null:a[r].Area),h.SelectVideoAnalyseShape(k.containerId,k.ScaleShapeId,!1)):(k._buildAnalyseGlobal(a),f.SetIVSConfig(p,0),f.SubVideoWndCtrl(12,1))}},_renderNaclCalibrateOcx:function(){if(o[l]){var a=o[l].CalibrateArea[r];a&&(a.shapeId&&(g.ocxAdjust(a.shapeId,a.shapeId1,!1),g.shapeDelete(a.shapeId)),g.createShape(a.Method,a.Area).done(function(a){g.ocxAdjust(a,"",!1)}),g.ocxSetShapeTip(""))}},_buildAnalyseGlobal:function(b){var c=null,d=[{Area:[],Type:"StereoVision",Name:q}];c=b[r]||{},a.each(c.Area,function(a,b){d[0].Area.push(b)});var e={result:!0,params:{table:[d]}};p=JSON.stringify(e)},onScaleHeight:function(){var b=!1,c=k._ruleInitEmpty(!0);if("flash"===webApp.playMode||"h5"===webApp.playMode)c?h.RedrawVideoAnalyseShape(k.containerId,k.ScaleShapeId):(h.ShowVideoAnalyseShape(k.containerId,k.ScaleShapeId),h.SelectVideoAnalyseShape(k.containerId,k.ScaleShapeId));else if(a.browser.chrome&&a.browser.version>41){if(o){var d=o[l].CalibrateArea[r];d&&(d.shapeId?(g.showShape(d.shapeId),g.chooseShape(d.shapeId)):(g.createShape(d.Method,""),ipcIvsRuleDrawFinish=!1))}}else{if(!c)return void(b||f.SelectRule(q,0));f.DeleteShape(q),f.AddShape(0,"StereoVision",q,-1,0)}},onClearScale:function(){if(f.SetIVSConfig("",0),"flash"===webApp.playMode||"h5"===webApp.playMode)h.RedrawVideoAnalyseShape(k.containerId,k.ScaleShapeId);else if(a.browser.chrome&&a.browser.version>41){if(o){var b=o[l].CalibrateArea[r];b.shapeId?(ipcIvsRuleDrawFinish=!1,g.reDrawShape(b.shapeId).done(function(){b.Area=[[0,0],[0,0]]}),g.chooseShape(b.shapeId)):g.createShape(b.Method,"")}}else o[l].CalibrateArea[r].Area=[[0,0],[0,0]],f.AddShape(0,"StereoVision",q,-1,0)},_ruleInitEmpty:function(a){var b=!1,c=null;return c=o[l].CalibrateArea[r],c.Area?0===c.Area[0][0]&&0===c.Area[0][1]&&0===c.Area[1][0]&&0===c.Area[1][1]&&(a||f.DeleteShape(q),b=!0):b=!0,b},_outPutGlobalCalibrateInfo:function(a){var b=JSON.parse(a);o[l].CalibrateArea[r].Area=b[0].config.CalibrateArea.DetectRegion},_outPutNaclGroudRect:function(a,b){if(o){var c=o[l].CalibrateArea[r];("createDone"==a||"dragDone"==a)&&(c.shapeId||(c.shapeId=b.ShapeID,g.ocxAdjust(c.shapeId,"",!0))),"mousedownSelect"===a&&(c.shapeId=b.ShapeID);{g.getData(b.ShapeID).done(function(a){c.Area=a,ipcIvsRuleDrawFinish=!1})}}},_saveData:function(){m[l].CameraHeight=k.$("#ipcStereoFlowrate_cameraHeight").numberfield("value"),m[l].CameraAngle=k.$("#ipcStereoFlowrate_cameraAngle").numberfield("value")},onDefault:function(){a.browser.chrome&&a.browser.version>41&&g.shapeDeleteAll(),d.ConfigManager.getDefault(["StereoCalibrate","VideoAnalyseGlobal"]).done(function(a){k._renderElements(a,!0),k.$("#i_sff_tip").tip("success",tl("com.DefaultSuccessTip"))}).fail(function(){k.$("#i_sff_tip").tip("error",tl("com.DefaultfailureTip"))})},onRefresh:function(){if(a.browser.chrome&&a.browser.version>41&&o){a.each(o[l].CalibrateArea,function(a,b){b&&"Stereo"===b.Method&&(r=a)});var b=o[l].CalibrateArea[r];g.ocxSetShapeTip(""),b&&b.shapeId&&g.shapeDelete(b.shapeId)}k._getConfig(!0)},onConfirm:function(){if(!k.isStereoNumberEnable(n[l].Scene)||!v)return void k.$("#i_sff_tip").tip("error",tl("com.EnablePlanAndRuleTip"));if(k._saveData(),"flash"===webApp.playMode||"h5"===webApp.playMode)h.SelectVideoAnalyseShape(k.containerId,k.ScaleShapeId,!1);else if(a.browser.chrome&&a.browser.version>41){var b=o[l].CalibrateArea[r];g.ocxSetShapeTip(""),b&&g.ocxAdjust(b.shapeId,"",!1)}else f.SetCurShape("save");n=a.extend(!0,[],o),k.disabled(k.$("[id^=ipcStereoFlowrate_camera]"),!0);var c=n[l].CalibrateArea[r].Area,e=!1;a.each(u,function(b){a.each(u[b],function(a){u[b][a]!==c[b][a]&&(e=!0)})}),e?d.ConfigManager.setConfig("VideoAnalyseGlobal",n).done(function(){d.ConfigManager.getConfig(["StereoCalibrate","VideoAnalyseGlobal"]).done(function(a){k._renderElements(a),k.disabled(k.$("[id^=ipcStereoFlowrate_camera]"),!1),k.$("#i_sff_tip").tip("success",tl("com.SaveSuccessTip"))})}).fail(function(){k.disabled(k.$("[id^=ipcStereoFlowrate_camera]"),!1),k.$("#i_sff_tip").tip("error",tl("com.SaveConfigFailTip"))}):s!==m[l].CameraAngle||t!==m[l].CameraHeight?d.ConfigManager.setConfig("StereoCalibrate",m).done(function(){d.ConfigManager.getConfig("StereoCalibrate").done(function(a){if(m=a,m&&m[l]){var b=m[l].CameraHeight,c=m[l].CameraAngle;0>b&&(b=0),0>c&&(c=0),s=c,t=b}k.disabled(k.$("[id^=ipcStereoFlowrate_camera]"),!1),k.$("#i_sff_tip").tip("success",tl("com.SaveSuccessTip"))})}).fail(function(){k.disabled(k.$("[id^=ipcStereoFlowrate_camera]"),!1),k.$("#i_sff_tip").tip("error",tl("com.SaveConfigFailTip"))}):(k.disabled(k.$("[id^=ipcStereoFlowrate_camera]"),!1),k.$("#i_sff_tip").tip("success",tl("com.SaveSuccessTip")))},isStereoNumberEnable:function(b){return b.Type&&"StereoNumber"===b.Type||-1!==a.inArray("StereoNumber",b.TypeList)?!0:!1}})}),define("ipc_stereoFlowReport",function(require,b,c){function d(a,b,c){var d,e,f,g,h;if(!(b>=a)){if(d=(a-b)/c,g=Math.pow(10,parseInt(Math.log(d)/Math.log(10)))==d?Math.pow(10,parseInt(Math.log(d)/Math.log(10))):Math.pow(10,parseInt(Math.log(d)/Math.log(10))+1),e=(d/g).toFixed(6),e=e>=0&&.1>=e?.1:e>=.100001&&.2>=e?.2:e>=.200001&&.25>=e?.25:e>=.250001&&.5>=e?.5:1,e*=g,parseInt(b/e)!=b/e&&(b=0>b?-1*Math.ceil(Math.abs(b/e))*e:parseInt(Math.abs(b/e))*e),parseInt(a/e)!=a/e&&(a=parseInt(a/e+1)*e),f=(a-b)/e,c>f&&(h=c-f,f=c,a+=h%2===0?e*parseInt(h/2):e*parseInt(h/2+1),b-=e*parseInt(h/2)),c=f,0>b){var i=(a-b)/c,j=(a+b)/i;return[a+b,0,j]}return[a,b,c]}}function e(){var a=m.$("#s_r_enter").prop("checked"),b=m.$("#s_r_exit").prop("checked"),c=m.$("#s_r_showNum").prop("checked"),e=m.$('[sc_type="bar"]').prop("checked"),f=0,g=function(a){var b=a;return b=a%10===0||10>a?a:10*Math.ceil(a/10)};if("ManNumDetection"===q)n.nDirectionStat=4,c=!0,f=d(g(n.totalMax),0,10);else if(a&&b?(n.nDirectionStat=2,f=d(g(n.totalMax),0,10)):a&&!b?(n.nDirectionStat=0,f=d(g(n.enterMax),0,10)):b&&!a?(n.nDirectionStat=1,f=d(g(n.exitMax),0,10)):n.nDirectionStat=3,!f)return!1;return n.MaxData=f[0],n.YCount=f[2],n.ShowNumber=c,n.nShowType=e?0:1,!0}{var f=require("jsCore/pageBase"),g=require("jsCore/rpc"),h=require("jsCore/plugin");require("lib/jquery.jqplot")}require("lib/Chart.min");var i,j,k,l,m=null,n=null,o={Hour:"com.DayReportRangeTip",Day:"com.MonthReportRangeTip",Month:"com.YearReportRangeTip"},p=!1,q="NumberStat";c.exports=f.extend({init:function(){m=this,i=m.$("#sr_st_date").datepicker({change:function(a,b){k.datepicker("minDate",b.value)}}),m.$("#sr_st_date").parent().css("min-width","1010px"),j=m.$("#sr_st_time").timefield({disableM:!0,disableS:!0}),k=m.$("#sr_en_date").datepicker(),l=m.$("#sr_en_time").timefield({disableM:!0,disableS:!0}),m.$("#s_r_enter,#s_r_exit,#s_r_showNum,[sc_type=bar],[sc_type=line]").on("click",function(){if(n){if(!e())return a.alert(tl("com.NoDataTip")),void m._clearChart();m._drawChart(n)}}),ability.get("IVSCaps").done(function(b){var c={StereoNumberStat:"NumberStat",ManNumDetection:"ManNumDetection"},d=m.$("[sel-for = onChangeRuleType]").empty();a.each(b.SupportedScenes.StereoNumber.SupportedRules,function(a,b){b.SupportLocalDataStore!==!1&&d.append("<option value="+c[a]+" t="+c[a]+"></option>")}),d.translation().change(),m.render()})},render:function(){p=!1,a(window).on("resize.flowrate",function(){n&&m._drawChart(n)}),m.onChangeReportType(),n?m._drawChart(n):m.disabled("[btn-for=onExport]",!0),g.ConfigManager.getConfig("Locales").done(function(a){switch(a.TimeFormat.split(" ")[0]){case"MM-dd-yyyy":i.datepicker("format","mm-dd-yyyy"),k.datepicker("format","mm-dd-yyyy");break;case"dd-MM-yyyy":i.datepicker("format","dd-mm-yyyy"),k.datepicker("format","dd-mm-yyyy");break;default:i.datepicker("format","yyyy-mm-dd"),k.datepicker("format","yyyy-mm-dd")}switch(a.TimeFormat.split(" ")[1]){case"HH:mm:ss":j.timefield("format","24"),l.timefield("format","24");break;default:j.timefield("format","12"),l.timefield("format","12")}})},leave:function(){p=!0,m._clearChart(!0),a(window).off("resize.flowrate")},destory:function(){m._clearChart(!0),a(window).off("resize.flowrate")},onChangeRuleType:function(b){var c=m.$("[sel-for = onChangeReportType]");m._clearChart(!0),q=a(b.target).val(),"NumberStat"===q?(m.$("#flowrate_dir").show(),m.$("#flowrate_standedTime").hide(),c.append('<option value="Month" t="sto.YearReport">'+tl("sto.YearReport")+"</option>")):(m.$("#flowrate_dir").hide(),m.$("#flowrate_standedTime").show(),"Month"===c.val()&&c.val("Hour").change(),c.find("option").eq(2).remove())},onChangeReportType:function(){{var b=m.$("select[sel-for=onChangeReportType]").val(),c=new Date,d=c.getFullYear(),e=c.getMonth();c.getDate()}m.$("#sr_tips_txt").text(tl(o[b])),j.hide(),l.hide(),"Hour"==b?(j.show(),l.show(),i.datepicker("value",c),k.datepicker("value",c),j.timefield("value","00:00:00"),l.timefield("value",a.pad(c.getHours(),2)+":00:00")):"Day"==b?(i.datepicker("value",new Date(d,e,1)),k.datepicker("value",c)):(i.datepicker("value",new Date(d,0,1)),k.datepicker("value",c)),k.datepicker("minDate",i.datepicker("value"))},_clearChart:function(a){m.$("#s_r_title").html(""),m.$("#s_r_chart").empty().addClass("ui-emptyChart"),a&&(n=null)},onSearch:function(){var b=m.$("select[sel-for=onChangeReportType]").val(),c=i.datepicker("value")+" ",d=k.datepicker("value")+" ",e=null,f=null,g=null,h=null,n=null;if(m.disabled("[btn-for=onExport]",!0),"Hour"==b){if(c+=j.timefield("value"),d+=l.timefield("value"),e=c,f=d,h=new Date(c.replace(/-/g,"/")),n=new Date(d.replace(/-/g,"/")),h.addDays(1)<n)return a.alert(tl(o[b])),void m._clearChart(!0);if(c===d)return a.alert(tl("com.NoDataTip")),m.$("#flow_reportTip").empty(),void m._clearChart(!0)}else if("Day"==b){if(e=c,f=d,c+="00:00:00",d+="23:59:59",h=new Date(c.replace(/-/g,"/")),n=new Date(d.replace(/-/g,"/")),h.addMonths(1)<n)return a.alert(tl(o[b])),void m._clearChart(!0)}else if("Month"==b){m.$("#flow_reportTip").tip("warning",tl("com.YearReportErrorTip"));var p=new Date(c.replace(/-/g,"/")),r=new Date(d.replace(/-/g,"/")).addMonths(1);if(p.setDate(1),r.setDate(0),i.datepicker("value",p),k.datepicker("value",r),c+="00:00:00",d+="23:59:59",e=c.substr(0,7),f=d.substr(0,7),h=new Date(c.replace(/-/g,"/")),n=new Date(d.replace(/-/g,"/")),h.addYears(1)<n)return a.alert(tl(o[b])),void m._clearChart(!0)}if(new Date(c.replace(/-/g,"/"))>new Date(d.replace(/-/g,"/")))return a.alert(tl("com.BeginTLessThanEndTTip")),m._clearChart(!0),!1;var s={StartTime:c,EndTime:d,Granularity:b,RuleType:q};if("NumberStat"===q){var t=m.$("#s_r_enter").prop("checked"),u=m.$("#s_r_exit").prop("checked");if(!t&&!u)return a.alert(tl("com.ChooseDirTip")),m._clearChart(!0),!1;g=e+" ~ "+f+" "+tl("ivs.PtzNumberStat"),m._searchNumberStat(s,b,g)}else"ManNumDetection"===q&&(g=e+" ~ "+f+" "+tl("ManNumDetection"),m._searchManNumDetection(s,b,g))},_searchNumberStat:function(b,c,d){g.VideoStatServer.startFind(b).done(function(b){m.$("#flow_reportTip").tip("warning",tl("com.SearchingTip"),-1);var e=b.token,f=b.totalCount;g.VideoStatServer.doFind(e,0,f).done(function(b){m.$("#flow_reportTip").empty(),b&&!b.info&&(a.alert(tl("com.NoDataTip")),m._clearChart(!0)),p||(m._formatChartData(b,c,d),g.VideoStatServer.stopFind(e))}).fail(function(){a.alert(tl("com.NoDataTip")),m._clearChart(!0)})}).fail(function(){a.alert(tl("com.OpearFaildTip")),m._clearChart(!0)})},_searchManNumDetection:function(b,c,d){var e=m.$("[name = standedTime]:checked").val()-0,f=a.Deferred(),h=a.extend(!0,{MinStayTime:0},b),i=a.Deferred(),j=a.extend(!0,{MinStayTime:e},b),k=0,l=0;g.VideoStatServer.startFind(h).done(function(a){m.$("#flow_reportTip").tip("warning",tl("com.SearchingTip"),-1),k=a.token,g.VideoStatServer.doFind(k,0,a.totalCount).done(function(a){f.resolve(a)}).fail(function(){f.reject(tl("com.NoDataTip"))})}).fail(function(){f.reject(tl("com.OpearFaildTip"))}),g.VideoStatServer.startFind(j).done(function(a){l=a.token,g.VideoStatServer.doFind(l,0,a.totalCount).done(function(a){i.resolve(a)}).fail(function(){i.reject(tl("com.NoDataTip"))})}).fail(function(){i.reject(tl("com.OpearFaildTip"))}),a.when(f,i).done(function(e,f){if(g.VideoStatServer.stopFind(k),g.VideoStatServer.stopFind(l),e&&!e.info)return a.alert(tl("com.NoDataTip")),m._clearChart(!0),!1;if(!p){var h=new Date(b.StartTime.replace(/-/g,"/")),i=new Date(b.EndTime.replace(/-/g,"/")).getTime(),j=[];f&&!f.info&&(f.info=[]),a.each(f.info,function(b,c){a.each(e.info,function(a,b){return b.StartTime===c.StartTime?(b.EnteredSubtotal=c.InsideSubtotal,b.ExitedSubtotal=b.InsideSubtotal-c.InsideSubtotal,!1):void 0})});var n=["getHours","setHours"];
for("Day"===c?n=["getDate","setDate"]:"Month"===c&&(n=["getMonth","setMonth"]);i-h.getTime()>=0;){var o=h[n[0]](),q=h.getMonth()+1,r=h.getDate(),s=h.getHours();r=10>r?"0"+r:r,q=10>q?"0"+q:q,s=10>s?"0"+s:s;var t=h.getFullYear()+"-"+q+"-"+r+" "+s+":00:00";j.push(t),h[n[1]](o+1)}"Hour"===c&&(j.length=j.length-1);var u=[];a.each(j,function(b,c){var d=!1;a.each(e.info,function(a,e){return e.StartTime===c?(e.EnteredSubtotal||(e.EnteredSubtotal=0,e.ExitedSubtotal=e.InsideSubtotal),u[b]=e,d=!0,!1):void 0}),d||(u[b]={StartTime:c,EnteredSubtotal:0,ExitedSubtotal:0,InsideSubtotal:0})}),e.info=u,m._formatChartData(e,c,d)}}).fail(function(b){a.alert(b)}).always(function(){m.$("#flow_reportTip").empty()})},_formatChartData:function(b,c,f){var g=[],h=[],i=[],j=[],k=0,l=m.$("#s_r_enter").prop("checked"),o=m.$("#s_r_exit").prop("checked");a.each(b.info,function(a,b){g[a]=b.EnteredSubtotal,h[a]=b.ExitedSubtotal,i[a]=b.InsideSubtotal,j[a]=b.StartTime});var p,r=Math.max.apply(null,g),s=Math.max.apply(null,h),t=Math.max(r,s);if("ManNumDetection"===q?(t=Math.max.apply(null,i),p=t):p=l?o?t:r:o?s:0,m._clearChart(!0),!p)return a.alert(tl("com.NoDataTip"));m.disabled("[btn-for=onExport]",!1),k=d(p,0,10),n={enter:g,exit:h,YCount:k[2],MaxData:k[0],ShowNumber:!0,title:f,EnteredSubtotal:0,ExitedSubtotal:0,params:b,nReportType:0,nDirectionStat:0,nShowType:0,enterMax:r,exitMax:s,totalMax:t,timeArr:[]},"Hour"==c?(a.each(j,function(a,b){n.timeArr[a]=b.substr(5,8).replace(/\-/g,"/")+":00"}),n.nReportType=0):"Day"==c?(a.each(j,function(a,b){n.timeArr[a]=b.substr(0,10).replace(/\-/g,"/")}),n.nReportType=1):(a.each(j,function(a,b){n.timeArr[a]=b.substr(0,7).replace(/\-/g,"/")}),n.nReportType=2);for(var u=0;u<g.length;u++)n.EnteredSubtotal+=g[u];for(var v=0;v<h.length;v++)n.ExitedSubtotal+=h[v];e(),m._drawChart(n)},_drawChart:function(b){var c,d,e=b.enter,f=b.exit,g=b.timeArr,h=null,i=[],j=[],k=0,l=50,o={labels:g,datasets:[]},p=b.nDirectionStat,r=b.ShowNumber;if(m._clearChart(),"flash"===webApp.playMode||"h5"===webApp.playMode){m.$("#s_r_chart").append('<canvas id="s_r_canvas" width="1595" height="593"></canvas>'),ctx=document.getElementById("s_r_canvas").getContext("2d"),flowrateChart=new Chart(ctx,{type:b.nShowType?"line":"bar",data:o,options:{responsive:!0,legend:{position:"right"},title:{display:!0,text:b.title,padding:40},scales:{yAxes:[{stacked:"ManNumDetection"===q}]},animation:{onComplete:function(){var a=this,b=this.chart.ctx;b.fillStyle="#666",b.textAlign="center",b.textBaseline="bottom",this.data.datasets.forEach(function(c,d){var e=a.chart.controller.getDatasetMeta(d);e.data.forEach(function(a,d){var e=c.data[d];e&&b.fillText(e,a._model.x,a._model.y)})})}}}});var s=m.$("[name = standedTime]:checked").val();if(2===p||4===p)o.datasets=[{label:"ManNumDetection"===q?tl("ivs.StandedTime")+">="+s+tl("com.Second"):tl("com.Enter"),backgroundColor:Chart.helpers.color("rgb(255, 99, 132)").alpha(.5).rgbString(),borderColor:"rgb(255, 99, 132)",borderWidth:1,data:b.enter},{label:"ManNumDetection"===q?tl("ivs.StandedTime")+"<"+s+tl("com.Second"):tl("com.Leave"),backgroundColor:Chart.helpers.color("rgb(54, 162, 235)").alpha(.5).rgbString(),borderColor:"rgb(54, 162, 235)",borderWidth:1,data:b.exit}];else if(0===p)o.datasets=[{label:tl("com.Enter"),backgroundColor:Chart.helpers.color("rgb(255, 99, 132)").alpha(.5).rgbString(),borderColor:"rgb(255, 99, 132)",borderWidth:1,data:b.enter}];else{if(1!==p)return void m.disabled("[btn-for=onExport]",!0);o.datasets=[{label:tl("com.Leave"),backgroundColor:Chart.helpers.color("rgb(54, 162, 235)").alpha(.5).rgbString(),borderColor:"rgb(54, 162, 235)",borderWidth:1,data:b.exit}]}return m.$("#s_r_chart").removeClass("ui-emptyChart"),flowrateChart.update(),void document.getElementById("s_r_canvas").toDataURL()}var t=m.$("#s_r_chart").width()/e.length;if(100>t&&("ManNumDetection"===q?(k=-60,l=.6*t):(k=-30,l=.3*t)),m.$('[sc_type="bar"]').prop("checked")?(d="bar",h={renderer:a.jqplot.BarRenderer,rendererOptions:{barWidth:l,barMargin:0,barPadding:0,fillToZero:!0},pointLabels:{show:r,edgeTolerance:-50}}):(d="line",h={pointLabels:{show:r,edgeTolerance:-50}}),"ManNumDetection"===q){var s=m.$("[name = standedTime]:checked").val();i=[e,f],j=[{label:tl("ivs.StandedTime")+">="+s+tl("com.Second")},{label:tl("ivs.StandedTime")+"<"+s+tl("com.Second")}],c=["#f44","#44f"]}else if(2===p)i=[e,f],j=[{label:tl("com.Enter")+(r?b.EnteredSubtotal:"")},{label:tl("com.Leave")+(r?b.ExitedSubtotal:"")}],c=["#f44","#44f"];else if(0===p)i=[e],j=[{label:tl("com.Enter")+(r?b.EnteredSubtotal:"")}],c=["#f44"];else{if(1!==p)return void m.disabled("[btn-for=onExport]",!0);i=[f],j=[{label:tl("com.Leave")+(r?b.ExitedSubtotal:"")}],c=["#44f"]}m.disabled("[btn-for=onExport]",!1),m.$("#s_r_title").html(n.title);a.jqplot("s_r_chart",i,{stackSeries:"ManNumDetection"===q&&"bar"===d?!0:!1,seriesColors:c,seriesDefaults:h,series:j,gridPadding:{top:30},legend:{show:!0,placement:"outsideGrid",textColor:"#fff"},grid:{background:"#dedede",gridLineColor:"#999",borderColor:"#999"},axes:{xaxis:{renderer:a.jqplot.CategoryAxisRenderer,ticks:g,tickRenderer:a.jqplot.CanvasAxisTickRenderer,tickOptions:{markSize:5,_styles:{"margin-top":"10px"},showGridline:!1,angle:k}},yaxis:{min:0,max:b.MaxData,numberTicks:b.YCount+1,textColor:"#fff"}}})},onExport:function(){if("flash"===webApp.playMode||"h5"===webApp.playMode){var b=m.$("#s_r_canvas")[0];if(!b)return;var c=b.toDataURL(),d="PeopleCounting"+(new Date).format("yyyyMMddHHmmss"),e=a("<a></a>").attr("href",c).attr("download",d).appendTo("body");return e[0].click(),e.remove(),!1}h.GetConfigPath("LiveSnapshot").done(function(b){b=b+(a.browser.Platform.win?"\\":"/")+"PeopleCounting"+(new Date).format("yyyyMMddHHmmss"),h.ShowSaveOrOpenDlg("saveFile",b,[{description:"bmp( *.bmp)",extensions:["bmp"]},{description:"Microsoft Office (*.csv)",extensions:["csv"]}]).done(function(b){var c,d={};d.params=n.params,d.MaxData=n.MaxData,d.YCount=n.YCount,d.ShowNumber=n.ShowNumber,d.EnteredTotal=n.EnteredSubtotal,d.ExitedTotal=n.ExitedSubtotal,d.title=n.title,d.period=m.$("[name = standedTime]:checked").val()-0,c="bmp"===b[2]?n.nShowType:2,h.MakeReport(n.nReportType,n.nDirectionStat,c,JSON.stringify(d),b[1]).done(function(b){a.alert(b?tl("com.ExportSuccessTip"):tl("com.ExportFailTip"))})})})}})})}(jQuery);