!function(a){define(function(require,a,b){b.exports=require("jsCore/pageTab")}),define("heatmap",function(require,b,c){var d=require("jsCore/rpc"),e=require("jsCore/pageBase"),f=require("jsCore/rpcLogin"),g=require("jsCore/plugin"),h=require("jsCore/modules/IntellMutex"),i=require("jsCore/modules/timeSection"),j=require("PtzCmdH"),k=require("jsCore/ability"),l=null,m=null,n=null,o=require("jsCore/hlsplayer"),p=require("jsCore/flashplayer"),q=require("jsCore/h5player");c.exports=e.extend({init:function(){m=this,n=new h("heatMap_mutex"),k.get("IVSCaps").done(function(a){if(webCaps.is_new_IVSUI!==!0){var b=h.getIntellMutexTip("HeatMap",a||{});b&&(n.add("intell",b),n.setCtrl("intell",!0)),n.add("tvout",'<span t="com.IntellMutexTVOutTip">'+tl("com.IntellMutexTVOutTip")+"</span>")}}),m.$("#heatMap_enable").click(function(){this.checked?n.show():n.hide()}),d.VideoInAnalyse.getTemplateGlobal().done(function(a){m.templateGlobal=a}),m.preset=m.$("[data-preset]"),m._initPreset().always(function(){m.render()}),-1!==webApp.DeviceType.indexOf("SD")&&m.$('[data-show="IPC"]').remove()},_initPreset:function(){return d.ConfigManager.getConfig("VideoAnalyseRule").done(function(b){var c="",d=1;a.each(b[analyseSenceRuleMap.Normal],function(a,b){"HeatMap"===b.Type&&(c+="<option value="+(b.Config.PlanId||0)+">"+d+"</option>",d++)}),m.preset.empty().append(c),2>=d?(m.preset.parent().addClass("fn-hide"),m.$('[data-show="SD"]').remove()):(m.preset.parent().removeClass("fn-hide"),j.init("#heatPtzWrap"))})},render:function(){n.hide(),webCaps.is_new_IVSUI!==!0&&n.setCtrl("tvout",g_videoInConflict.DSP.hasConflict()),"hls"==webApp.playMode?(o.cover(m.$("#heatMapVideo")),g.hide(),o.init("","",""),o.beginPlay()):"flash"==webApp.playMode?(p.cover(m.$("#heatMapVideo")),g.hide(),p.playPreview(1,0)):"h5"===webApp.playMode?(g.hide(),q&&"h5"===webApp.playMode&&q.playPreview(1,0,m.$("#heatMapVideo"))):g.cover("#heatMapVideo",function(){g.SetModuleMode(2),f.chkAuthority("Monitor_01")&&g.open()}),m._getConfig();var a=m.preset.val()-0;a>0&&!webApp.NoIntelliPreset&&d.PTZ.gotoStatisticPlan("HeatMap",a)},leave:function(){n.hide(),g.hide(),o&&o.hideAndStopLoad(),p&&p.hide(),q&&q.hide()},_getConfig:function(a){d.ConfigManager.getConfig("VideoAnalyseRule").done(function(b){m.table=b,m._render(m.table[analyseSenceRuleMap.Normal]),m.disabled("[btn-for=onSave]",!1),a&&m.$("#HM_sc_tip").tip("success",tl("com.OperateSuccessTip"))}).fail(function(){m.disabled("[btn-for=onSave]",!0),m.$("#HM_sc_tip").tip("error",tl("com.OperateFailTip"))})},_render:function(b){a.each(b,function(a,b){return"HeatMap"!==b.Type||b.Config.PlanId!==m.preset.val()-0&&void 0!==b.Config.PlanId?void 0:(l=b,m.$("#heatMap_enable").prop("checked",l.Enable),!1)})},_save:function(){l.Enable=a("#heatMap_enable").prop("checked")},defCheckGlobal:function(a){return jQuery.Deferred(function(b){d.ConfigManager.getConfig("VideoAnalyseGlobal").done(function(c){null==c[0]&&(c[0]={}),c=m.checkGlobal(c,a),c===!0?b.resolve():d.ConfigManager.setConfig("VideoAnalyseGlobal",c).done(function(){b.resolve()}).fail(function(){b.reject("setGlobalFailed")})}).fail(function(){b.reject("getGlobalFailed")})})},checkGlobal:function(a){var b=0,c="Scene";for(var d in a[b])if(-1!==d.indexOf("Scene")&&0==a[b][d].PtzPresetId&&(c=d,"HeatMapPlan"==a[b][d].Type))return!0;return m.$("#heatMap_enable").prop("checked")&&(a[b][c].Type="HeatMapPlan"),a[b][c].TypeList=[],a},changePreset:function(){m.preset.val()&&!webApp.NoIntelliPreset&&d.PTZ.gotoStatisticPlan("HeatMap",m.preset.val()-0),m._render(m.table[analyseSenceRuleMap.Normal])},onSave:function(){return m._save(),m.preset.val()-0===0||webApp.NoIntelliPreset?d.ConfigManager.setConfig("VideoAnalyseRule",m.table).done(function(){m.$("#HM_sc_tip").tip("success",tl("com.SaveSuccessTip"))}).fail(function(){m.$("#HM_sc_tip").tip("error",tl("com.SaveConfigFailTip"))}):d.PTZ.setStatisticPlan("HeatMap",m.preset.val()-0).always(function(){m.defCheckGlobal(m.table).done(function(){d.ConfigManager.setConfig("VideoAnalyseRule",m.table).done(function(){m.$("#HM_sc_tip").tip("success",tl("com.SaveSuccessTip"))}).fail(function(){m.$("#HM_sc_tip").tip("error",tl("com.SaveConfigFailTip"))})})}),!1},onDefault:function(){return d.ConfigManager.getDefault("VideoAnalyseRule").done(function(b){for(var c=m.table[analyseSenceRuleMap.Normal].length,d=c-1;d>=0;d--)"HeatMap"===m.table[analyseSenceRuleMap.Normal][d].Type&&m.table[analyseSenceRuleMap.Normal].splice(d,1);a.each(b[analyseSenceRuleMap.Normal],function(a,b){"HeatMap"===b.Type&&m.table[analyseSenceRuleMap.Normal].push(b)}),m._render(m.table[analyseSenceRuleMap.Normal]),m.disabled("[btn-for=onSave]",!1),m.$("#HM_sc_tip").tip("success",tl("com.DefaultSuccessTip"))}).fail(function(){m.disabled("[btn-for=onSave]",!0),m.$("#HM_sc_tip").tip("error",tl("com.DefaultfailureTip"))}),!1},onRefresh:function(){return this._getConfig(!0),!1},onSetPeriod:function(){return l&&l.EventHandler&&l.EventHandler.TimeSection&&(g.hide(),i.open(l.EventHandler.TimeSection).done(function(a){l.EventHandler.TimeSection=a}).always(function(){"hls"!=webApp.playMode&&"flash"!=webApp.playMode&&"h5"!==webApp.playMode&&g.cover("#heatMapVideo")})),!1}})}),define("heatmap_report",function(require,b,c){var d,e,f,g,h=require("jsCore/rpc"),i=require("jsCore/pageBase"),j=(require("jsCore/rpcLogin"),require("jsCore/plugin")),k=null,l=null;c.exports=i.extend({init:function(){l=this,d=l.$("#hr_st_date").datepicker({change:function(a,b){f.datepicker("minDate",b.value)}}),e=l.$("#hr_st_time").timefield({disableM:!0,disableS:!0}),f=l.$("#hr_en_date").datepicker(),g=l.$("#hr_en_time").timefield({disableM:!0,disableS:!0}),l.preset=l.$("[data-preset]"),l._initPreset().always(function(){l.render()})},_initPreset:function(){return h.ConfigManager.getConfig("VideoAnalyseRule").done(function(b){var c="",d=1;a.each(b[analyseSenceRuleMap.Normal],function(a,b){"HeatMap"===b.Type&&(c+="<option value="+(b.Config.PlanId||0)+">"+d+"</option>",d++)}),l.preset.empty().append(c),2>=d?l.preset.parent().addClass("fn-hide"):l.preset.parent().removeClass("fn-hide")})},render:function(){var b=new Date;d.datepicker("value",b),e.timefield("value","00:00:00"),f.datepicker("value",b),g.timefield("value",a.pad(b.getHours(),2)+":00:00"),l.$("#heatMap_reportTitle").html(""),l.disabled("[btn-for=onSearch]"),j.addEvent("StateChangedHeatMap",function(){l.disabled("[btn-for=onSearch]",!1)}),j.SetModuleMode(2),j.enableHeatMap(!0),l.disabled("[btn-for=onExport]",!0),k=setInterval(function(){-1e4!==a(".u-datepicker").offset().top&&a("#video").offset().top>0?(l.$("#heatMap_reportInfo").addClass("fn-padt180"),"hls"!=webApp.playMode&&"flash"!=webApp.playMode&&"h5"!==webApp.playMode&&j.cover("#heatMap_reportChart")):a("#video").offset().top>0&&(l.$("#heatMap_reportInfo").removeClass("fn-padt180"),"hls"!=webApp.playMode&&"flash"!=webApp.playMode&&"h5"!==webApp.playMode&&j.cover("#heatMap_reportChart"))},200),h.ConfigManager.getConfig("Locales").done(function(a){switch(a.TimeFormat.split(" ")[0]){case"MM-dd-yyyy":case"MM/dd/yyyy":d.datepicker("format","mm-dd-yyyy"),f.datepicker("format","mm-dd-yyyy");break;case"dd-MM-yyyy":case"dd/MM/yyyy":d.datepicker("format","dd-mm-yyyy"),f.datepicker("format","dd-mm-yyyy");break;default:d.datepicker("format","yyyy-mm-dd"),f.datepicker("format","yyyy-mm-dd")}switch(a.TimeFormat.split(" ")[1]){case"HH:mm:ss":e.timefield("format","24"),g.timefield("format","24");break;default:e.timefield("format","12"),g.timefield("format","12")}})},leave:function(){switch(j.enableHeatMap(!1),j.hide(),j.addEvent("StateChangedHeatMap",null),clearInterval(k),webApp.DisplayMode){case"Adaptive Window":j.SetShowMode(0);break;default:j.SetShowMode(1)}},destory:function(){switch(j.enableHeatMap(!1),webApp.DisplayMode){case"Adaptive Window":j.SetShowMode(0);break;default:j.SetShowMode(1)}},onSearch:function(){var b=l.preset.val()-0,c=a.Deferred();b>0&&!webApp.NoIntelliPreset&&h.PTZ.gotoStatisticPlan("HeatMap",b).done(function(){c.resolve()}).fail(function(){l.$("#heatMap_reportTitle").html(""),a.alert(tl("com.NoDataTip")),l.disabled("[btn-for=onExport]",!0)});var i=d.datepicker("value")+" "+e.timefield("value"),k=f.datepicker("value")+" "+g.timefield("value"),m=6048e5;return j.hide(),new Date(i.replace(/-/g,"/"))>new Date(k.replace(/-/g,"/"))?void a.alert(tl("com.BeginTLessThanEndTTip")):new Date(k.replace(/-/g,"/")).getTime()-new Date(i.replace(/-/g,"/")).getTime()>m?(l.$("#heatMap_reportTitle").html(""),a.alert(tl("com.WeekReportTip")),void l.disabled("[btn-for=onExport]",!0)):(-1===webApp.DeviceType.indexOf("SD")||webApp.NoIntelliPreset?webApp.NoIntelliPreset&&-1!==webApp.DeviceType.indexOf("SD")?j.CreateHeatMapEx(i,k,0).done(function(a){l.searchData(a,i,k)}):j.CreateHeatMap(i,k).done(function(a){l.searchData(a,i,k)}):c.done(function(){j.CreateHeatMapEx(i,k,l.preset.val()-0).done(function(a){l.searchData(a,i,k)})}),!1)},onExport:function(){return j.GetConfigPath("LiveSnapshot").done(function(b){var c=new Date,d=b+(a.browser.Platform.win?"\\":"/")+"HeatMap";d+=a.pad(c.getFullYear(),4),d+=a.pad(c.getMonth()+1,2),d+=a.pad(c.getDate(),2),d+=a.pad(c.getHours(),2),d+=a.pad(c.getMinutes(),2),d+=a.pad(c.getSeconds(),2),j.ShowSaveOrOpenDlg("saveFile",d,[{description:"bmp( *.bmp)",extensions:["bmp"]}]).done(function(b){j.MakeReport(0,0,0,JSON.stringify({type:"HeatMap"}),b[1]).done(function(b){j.hide(),b?a.alert(tl("com.ExportSuccessTip"),function(){"hls"!=webApp.playMode&&"flash"!=webApp.playMode&&"h5"!==webApp.playMode&&j.cover("#heatMap_reportChart")}):a.alert(tl("com.ExportFailTip"),function(){"hls"!=webApp.playMode&&"flash"!=webApp.playMode&&"h5"!==webApp.playMode&&j.cover("#heatMap_reportChart")})})})}),!1},searchData:function(b,c,d){b?(l.$("#heatMap_reportTitle").html(c+" ~ "+d+" "+tl("ivs.HeatMapStatistic")),j.cover("#heatMap_reportChart"),j.SetShowMode(0),l.disabled("[btn-for=onExport]",!1)):(l.$("#heatMap_reportTitle").html(""),a.alert(tl("com.NoDataTip")),l.disabled("[btn-for=onExport]",!0))}})}),define("PtzCmdH",function(require,b,c){var d=require("jsCore/rpc");c.exports={init:function(b,c,d){this.dom=a(b),0!==this.dom.length&&(a.isFunction(d)&&(this.moreFunc=d),this.option=c||{},this.step=5,this.newProtocol=webApp.IsNewProtocol&&-1!==webApp.DeviceType.indexOf("SD"),this.initDom(),this.bind(),this.dom.translation())},initDom:function(){var a='<div class="fn-left fn-width150"><div class="ui-boat fn-marl10"><div class="ui-boat-current"><div class="ui-boat-box-up boat ptzcontrol" data-hover="up" data-cmd="Up"></div><div class="ui-boat-box-left boat ptzcontrol" data-hover="left" data-cmd="Left"></div><div class="ui-boat-box-center" data-hoverEx="img3" data-cmdEx="Default"></div><div class="ui-boat-box-right boat ptzcontrol" data-hover="right" data-cmd="Right"></div><div class="ui-boat-box-down  boat ptzcontrol" data-hover="down" data-cmd="Down"></div></div></div><div class="ui-form-item capStep" ><label class="ui-label fn-width-auto fn-marr4" t="itc.Step"></label><select class="ui-select fn-width60" onmousewheel="javascript:return false"><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5" selected="">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option></select></div></div><div class="fn-left"><div class="ui-ptz-adjust-item fn-clear capZoom"><a class="ui-ptz-icon ptzcontrol" data-cmd="ZoomWide"><i class="ui-ptz-icon-less"></i></a><label class="ui-ptz-adjust-text" t="itc.ChangeZoom"></label><a class="ui-ptz-icon ptzcontrol" data-cmd="ZoomTele"><i class="ui-ptz-icon-more"></i></a></div><div class="ui-ptz-adjust-item fn-clear capFocus"><a class="ui-ptz-icon ptzcontrol" data-cmd="FocusFar"><i class="ui-ptz-icon-less"></i></a><label class="ui-ptz-adjust-text" t="med.Focus"></label><a class="ui-ptz-icon ptzcontrol" data-cmd="FocusNear"><i class="ui-ptz-icon-more"></i></a></div><div class="ui-ptz-adjust-item fn-clear capIris"><a class="ui-ptz-icon ptzcontrol"  data-cmd="IrisSmall"><i class="ui-ptz-icon-less"></i></a><label class="ui-ptz-adjust-text" t="pfm.Iris"></label><a class="ui-ptz-icon ptzcontrol" data-cmd="IrisLarge"><i class="ui-ptz-icon-more"></i></a></div></div><div class="fn-left fn-padt10 fn-padl20"><div class="ui-form-item fn-mart12" ><a data-cmd="markSceneMaxZoom" href="javascript:;" class="ui-button markSceneMaxZoom" t="ivs.SetTrackDynameter"></a></div><div class="ui-form-item fn-mart12" ><a data-cmd="setPreset" href="javascript:;" class="ui-button setPreset" t="ivs.SavePreset"></a></div></div>';this.dom.html(a),this.domHover=this.dom.find(".ui-boat-current");var b=this.dom;d.PTZ.getCurrentProtocolCaps().done(function(a){a&&(a.Zoom===!1&&b.find(".capZoom").addClass("fn-hide"),a.Focus===!1&&b.find(".capFocus").addClass("fn-hide"),a.Iris===!1&&b.find(".capIris").addClass("fn-hide"),a.PTZCtrl&&a.PTZCtrl.PTStep===!1&&b.find(".capStep").addClass("fn-hide"))}),this.option.markScene!==!0&&this.dom.find(".markSceneMaxZoom").parent().remove(),this.option.setPreset!==!0&&this.dom.find(".setPreset").parent().remove(),this.dom.css({"float":"left","min-width":"400px","min-height":"130px"})},moreFunc:function(){},bind:function(){var b,c=this;c.dom.find("[data-cmd]").on({mousedown:function(){var e=a(this).attr("data-cmd"),f=this;b=a.Deferred(function(a){d.PTZ.start(e,c.step,0,0,0).done(a.resolve).fail(a.reject)});var g=function(){b.then(function(){d.PTZ.stop(e,c.step,0,0,0),a(f).off("mouseup",g),a(f).off("mouseout",g)})};a(f).on({mouseup:g,mouseout:g})}}),c.dom.find("[data-hover]").on({mouseover:function(){var b=a(this).attr("data-hover");null!=b&&c.domHover.addClass("ui-boat-current-"+b)},mouseout:function(){var b=a(this).attr("data-hover");null!=b&&c.domHover.removeClass("ui-boat-current-"+b)}}),c.dom.find("select").on("change",function(){c.step=a(this).val()-0})},start:function(a){var b,c=this,e=c.step/8,f=15,g={Up:[0,e,0],Right:[e,0,0],Down:[0,-e,0],Left:[-e,0,0],ZoomWide:[0,0,-e],ZoomTele:[0,0,e],FocusFar:-e,FocusNear:e,IrisSmall:-e,IrisLarge:e};return b=c.newProtocol?-1!==a.indexOf("Focus")?d.PTZ.focusManually(g[a]):-1!==a.indexOf("Iris")?d.PTZ.adjustIris(g[a]):d.PTZ.moveContinuously(g[a],f):d.PTZ.start(a,c.step,0,0,0)},stop:function(a){var b=this;return b.newProtocol?-1!==a.indexOf("Focus")?d.PTZ.stopFocus():-1!==a.indexOf("Iris")||d.PTZ.stopMove():d.PTZ.stop(a,b.step,0,0,0),b},destory:function(){}}})}(jQuery);