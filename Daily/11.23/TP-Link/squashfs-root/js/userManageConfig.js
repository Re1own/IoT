!function(a){function b(a,b,c){switch(a){case 604:b="com.InputNotValidTip";break;case 605:b=c?"com.IndexOverlapGroupTip":"com.IndexOverlapUserTip";break;case 606:case 607:b=c?"com.IndexOverlapGroupTip":"com.IndexOverlapUserTip";break;case 608:b=c?"com.UsemannageErrGroupTip":"com.UsemannageErrUserTip";break;case 609:b=c?"com.SubsetOverlapGroupTip":"com.SubsetOverlapUserTip";break;case 610:b="com.SaveCfgErrorTip";break;case 611:b="com.PasswordNoTureTip";break;case 612:b="com.PasswordNoMatchTip";break;case 613:b="com.AccountReserveTip";break;case 614:b="com.AddSoMuchGroupTip";break;case 615:b="com.AddSoMuchUserTip"}return b}function c(b,c){var d=a(c).attr("data-pwd"),e=[];return a("input[data-pwd="+d+"]").each(function(b,c){e.push(a(c).val())}),e[0]===e[1]}function d(a){var b=a.children("li");b.removeClass("current"),a.prop("class","ui-pwd-strength")}define(function(require,a,b){b.exports=require("jsCore/pageTab");var c=require("jsCore/rpcLogin");b.exports.prototype.getCondition=function(){b.exports.prototype.use_onvif=!(!webApp.EncryptInfo||!webApp.EncryptInfo.asymmetric)&&webCaps.OnvifSync&&c.chkAuthority("Account")}}),define("use_userM",function(require,c,d){function e(b,c,d,e){var f=b.prop("id");b.empty(),a.each(d,function(d,g){-1===a.inArray(g,c)&&(isEnable("is_numberOK_Gate")&&"IntelliConf"===g?a('<div class="ui-textarea-item fn-clear">                            <div class="ui-checkbox">                                <input type="checkbox" data-for="'+g+'" id="'+f+"_"+g+'"/>                            </div>                            <label class="ui-label-sub" for="'+f+"_"+g+'" t="ANPR"></label>                        </div>').appendTo(b):a('<div class="ui-textarea-item fn-clear">                            <div class="ui-checkbox">                                <input type="checkbox" data-for="'+g+'" id="'+f+"_"+g+'"/>                            </div>                            <label class="ui-label-sub" for="'+f+"_"+g+'" t="'+g+'"></label>                        </div>').appendTo(b),-1!==a.inArray(g,e)&&b.find("input[data-for="+g+"]").prop("checked",!0))}),b.translation()}function f(b,c){var d=[];return a.each(b,function(a,b){-1===d.indexOf(b)&&d.push(b)}),a.each(c,function(a,b){-1===d.indexOf(b)&&d.push(b)}),d}function g(b,c){var d=[];return a.each(c,function(a,c){-1!==b.indexOf(c)&&d.push(c)}),d}function h(b){var c=[];return b.find("input:checked").each(function(b,d){c.push(a(d).attr("data-for"))}),c}function i(a){return a.find("input:checked").length===a.find("input").length}function j(b,c){var d=b.prop("checked");c.find("input").each(function(b,c){a(c).prop("checked",d)})}var k,l,m,n=require("jsCore/rpc"),o=require("jsCore/pageBase"),p=require("jsCore/rpcLogin"),q=require("jsCore/ability"),r=require("common/common"),s=null,t=null,u=null,v=null,w=!1;d.exports=o.extend({init:function(){s=this,t=s,k=s.$("#use_anonym"),w=isEnable("is_show_ModifyPsw")&&"anonymity"!==p.getLoginInfo().username&&!p.chkAuthority("Account"),w?s.$("[data-for=userM_group]").hide():s.$("[data-for=userM_group]").show(),s._renderAnonymity(),s._bind(),n.MagicBox.getSerialNo().done(function(a){l=a}),n.UserManager.getUserInfo(p.getLoginInfo().username).done(function(a){a&&(m=a),s._initTab()})},_bind:function(){k.click(function(){u.Anonymous=k.prop("checked"),n.UserManager.modifyUser("anonymity",u).done(function(){s.tip("success",u.Anonymous?"com.OpenAnonymLoginSucceedTip":"com.CloseAnonymLoginSucceedTip")}).fail(function(){s.tip("error",u.Anonymous?"com.OpenAnonymLoginFailedTip":"com.CloseAnonymLoginFailedTip"),k.prop("checked",!u.Anonymous)})})},_initTab:function(){var a=s.$(".u-tab"),b=s.$(".u-tab-content");s.tabs={},a.tab({switched:function(a,c){var d=s.tabs[c.from],e=s.tabs[c.to];d&&d.leave(),e?(e.render(),s.current=e):require.async(c.to,function(a){s.tabs[c.to]=new a({element:b.find("[data-page="+c.to+"]")}),s.current=s.tabs[c.to]})}})},render:function(){s.current.render()},_renderAnonymity:function(){n.UserManager.getUserInfo("anonymity").done(function(a){u=a,k.prop("checked",u.Anonymous)})},destory:function(){s.current.destory()}}),define("userM_user",function(require,c,d){function r(b,c){var d=a(c).attr("data-pwd"),e=[];return a("input[data-pwd="+d+"]").each(function(b,c){e.push(a(c).val())}),e[0]===e[1]}function s(a,b){var c=b.children("li");if(c.removeClass("current"),a){var d=P.newPwdStrenthValidator(a),e=b.find("."+d);e.addClass("current"),b.prop("class","ui-pwd-strength "+d)}else b.prop("class","ui-pwd-strength")}function u(a){var b=a.children("li");b.removeClass("current"),a.prop("class","ui-pwd-strength")}require("jsCore/modules/timeSection");var x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P=require("common/common"),Q=P.Check,R=null,S=["ComConf","MHardisk","ShutDown"],T=[],U=null,V=null,W=!1,X=null,Y=[],Z=null,$=!1;d.exports=o.extend({init:function(){R=this,Z=R.$("#show_user_auth"),M=R.$("#use_AUserDlg"),N=R.$("#use_EUserDlg"),O=R.$("#use_DUserDlg"),M.find("[data-pwd]").on("keydown",function(a){return 32===a.keyCode?!1:void 0}),N.find("[data-pwd]").on("keydown",function(a){return 32===a.keyCode?!1:void 0}),H=M.find("#use_AUserAuth"),I=M.find("#use_AUserAuthli"),J=N.find("#use_EUserAuth"),K=N.find("#use_EUserAuthli"),L=N.find("#use_EUserChkPwd"),webCaps.is_show_DevInit?n.DevInit.getStatus().done(function(a){v=a.params.Find,v&&-1!==v.indexOf("A")||N.find("#use_EUserPhoneWrap").remove(),v&&-1!==v.indexOf("B")||N.find("#use_EUserMailWrap").remove()}).fail(function(){N.find("#use_EUserPhoneWrap").remove(),N.find("#use_EUserMailWrap").remove()}):(N.find("#use_EUserPhoneWrap").remove(),N.find("#use_EUserMailWrap").remove()),M.find("#use_AUserMemo").textfield({length:31,asciiByte:1,notAsciiByte:3}),N.find("#use_EUserMemo").textfield({length:31,asciiByte:1,notAsciiByte:3}),X=R._initAddUserIpAuth(),webCaps.is_show_loginRestriction&&R._showNewAuth(),R._initTable(),R._initDialog(),R._initInput(),R._bind(),R.render()},_showNewAuth:function(){W=!0,$=!1,"admin"==p.getLoginInfo().username&&($=!0,M.css("width",800),N.css("width",800),M.find("#addUser_auth_list_wrap").addClass("fn-hide"),M.find("#addUser_auth_check").removeClass("fn-hide")),Z.css("width",800),n.ConfigManager.getConfig("LoginRestriction").done(function(a){Y=a})},_initAddUserIpAuth:function(){function a(){var a=v.find("li.current");v.css({display:"block",height:22}),w.css({"float":"left",width:180,lineHeight:"22px",backgroundColor:"#bababa",color:"#373737",textAlign:"center"}),a.css({backgroundColor:"#494949",color:"#fff"});var b=a.attr("li-for");x.find("[li-page]").hide(),x.find("[li-page="+b+"]").show()}function b(){n=x.find("#Add_IP_address_start").ipfield({type:"ip"}),o=x.find("#Add_IP_address_end").ipfield({type:"ip"}),l=x.find("#Add_IPv6_start").textfield(),m=x.find("#Add_IPv6_end").textfield(),r=x.find("#Add_IP_date_during_wrap").timesection(),r.find(".ui-timesection").show(),p=x.find("#Add_IP_date_start").datepicker({minDate:"2000-1-1",maxDate:"2037-12-31",change:function(a,b){q.datepicker("minDate",b.value)}}),q=x.find("#Add_IP_date_end").datepicker({minDate:"2000-1-1",maxDate:"2037-12-31"}),s=x.find("#Add_IP_time_start").timefield(),t=x.find("#Add_IP_time_end").timefield(),g(),a(),e(),B.val("IPv4"),A.val(z).change()}function c(){function a(){var a,c,d=A.val(),e=B.val(),f={ip:null,error:null};return R.ipv6Error=null,"IPv4"==e?(a=x.find("#Add_IP_address_start").ipfield("value"),c=x.find("#Add_IP_address_end").ipfield("value")):"IPv6"==e&&(a=x.find("#Add_IPv6_start").textfield("value"),c=x.find("#Add_IPv6_end").textfield("value"),Q.ipv6ornull(a)&&k(a)&&Q.ipv6ornull(c)&&k(c)||(f.error="ipv6",R.ipv6Error=!0)),f.ip="ipAddress"==d?a:b(a,c)?a+"-"+c:a==c?a:c+"-"+a,f}function b(a,b){var c=null;if(a.indexOf(":")>-1&&(c="IPv6"),"IPv6"==c)var d=a.split(":"),e=b.split(":");else var d=a.split("."),e=b.split(".");for(var f=d.length,g=[],h=[],i=0;f>i;i++)g[i]=jQuery.pad(d[i],4),h[i]=jQuery.pad(e[i],4);return g.join("")<h.join("")?!0:!1}var c,d,e=p.datepicker("value"),f=q.datepicker("value"),g=s.timefield("value"),h=t.timefield("value");e>f?(c=f+" "+h,d=e+" "+g):e==f?(c=e+" "+g,d=f+" "+h):(c=e+" "+g,d=f+" "+h);var i=a(),j={AllowedIP:{Enable:x.find("#Add_IP_address_enable").prop("checked"),IP:i.ip},AllowedTimeSchedule:{Enable:x.find("#Add_IP_date_during_enable").prop("checked"),TimeSchedule:r.timesection("value")},AllowdLifeTime:{Enable:x.find("#Add_IP_expire").prop("checked"),LifeTimeStart:c,LifeTimeEnd:d}};return j}function d(a){a||(a={AllowedIP:{Enable:x.find("#Add_IP_address_enable").prop("checked"),IP:function(){var a=x.find("#Add_IP_address_start").ipfield("value"),b=x.find("#Add_IP_address_end").ipfield("value");return"ipAddress"==z?x.find("#Add_IP_address_start").ipfield("value"):a>b?b+"-"+a:a==b?a:a+"-"+b}()},AllowedTimeSchedule:{Enable:x.find("#Add_IP_date_during_enable").prop("checked"),TimeSchedule:r.timesection("value")},AllowdLifeTime:{Enable:x.find("#Add_IP_expire").prop("checked"),LifeTimeStart:beginDate,LifeTimeEnd:e}});var b=a.AllowedIP.IP.split("-"),c=Q.ipv6ornull(b[0]);x.find("#Add_IP_address_enable").prop("checked",a.AllowedIP.Enable),c?(B.val("IPv6"),x.find("#Add_IPv6_start").textfield("value",b[0]),b.length>1?(x.find("#Add_IPv6_end").textfield("value",b[1]),A.val("ipNet").change()):A.val("ipAddress").change()):(B.val("IPv4"),x.find("#Add_IP_address_start").ipfield("value",b[0]),b.length>1?(x.find("#Add_IP_address_end").ipfield("value",b[1]),A.val("ipNet").change()):A.val("ipAddress").change()),x.find("#Add_IP_date_during_enable").prop("checked",a.AllowedTimeSchedule.Enable),r.timesection("value",a.AllowedTimeSchedule.TimeSchedule),x.find("#Add_IP_expire").prop("checked",a.AllowdLifeTime.Enable);var d=a.AllowdLifeTime.LifeTimeStart.split(" "),e=a.AllowdLifeTime.LifeTimeEnd.split(" ");p.datepicker("value",new Date(d[0].replace(/-/g,"/"))),q.datepicker("value",new Date(e[0].replace(/-/g,"/"))),q.datepicker("minDate",p.datepicker("value")),s.timefield("value",d[1]),t.timefield("value",e[1])}function e(){function b(){var a=A.val(),b=B.val();z=a,c(),"IPv4"==b?(d(["Add_IP_address_start"]),"ipNet"==a&&d(["Add_IP_address_end"])):"IPv6"==b&&(d(["Add_IPv6_start"]),"ipNet"==a&&d(["Add_IPv6_end"]))}function c(){for(var a=["Add_IP_address_start","Add_IP_address_end","Add_IPv6_start","Add_IPv6_end"],b=0,c=a.length;c>b;b++)x.find("#"+a[b]).addClass("fn-hide")}function d(a){for(var b=0,c=a.length;c>b;b++)x.find("#"+a[b]).removeClass("fn-hide")}w.off("click").on("click",function(){{var b=x.find(this).index();x.find(this).attr("li-for")}w.removeClass("current"),w.eq(b).addClass("current"),a()}),A.off("change").on("change",function(){b()}),B.off("change").on("change",function(){b()})}function f(a){x=a,u.children().appendTo(a)}function g(){x.find("#Add_IP_address_enable").prop("checked",!1),x.find("#Add_IP_date_during_enable").prop("checked",!1),x.find("#Add_IP_expire").prop("checked",!1),n.ipfield("value","1.0.0.1"),o.ipfield("value","1.0.0.1"),l.textfield("value","1:0:0:0:0:0:0:1"),m.textfield("value","1:0:0:0:0:0:0:1"),r.timesection("value",C);var a=new Date,b=([a.getYear(),a.getMonth()+1,a.getDate()].join("-"),new Date);b.setDate(b.getDate()+1),p.datepicker("value",new Date),q.datepicker("value",b),q.datepicker("minDate",p.datepicker("value")),s.timefield("value","08:00:00"),t.timefield("value","08:00:00")}function h(){x.find("[li-for=actionAuth]").show(),w.first().click(),b(),x.children().appendTo(u),x=u,y&&(x.find("#action_addUser_auth_list").find(".ui-textarea").removeClass("fn-height400"),x.find("#action_addUser_auth_list").children().appendTo(y)),z="ipAddress"}function i(a){y=a,y.children().appendTo(x.find("#action_addUser_auth_list")),x.find("#action_addUser_auth_list").find(".ui-textarea").addClass("fn-clearonly fn-height400")}function j(){x.find("[li-for=readAuth]").click(),x.find("[li-for=actionAuth]").hide()}function k(a){var b=/(^(::)$)|(^(:(:[0]{1,4}){1,7})$)|(^(([0]{1,4}:){1,7}([0]{1,4}))$)|(^(ff[a-f\d]{2}))/;return!b.test(a)}var l,m,n,o,p,q,r,s,t,u=R.$("#user_ipAuth_container"),v=u.find("#user_ipAuth_tab"),w=v.find("li"),x=u,y=null,z="ipAddress",A=x.find("[sel-for=onSelAddIpAddressType]"),B=x.find("[sel-for=onIPVersionChange]"),C=function(){for(var a="0 00:00:00-23:59:59",b="1 00:00:00-23:59:59",c=[],d=0;7>d;d++){for(var e=[],f=0;6>f;f++)e.push(0==f?b:a);c.push(e)}return c}();return b(),{init:b,appendTo:f,reset:h,addAuthList:i,getData:c,setData:d,onlyRenderLoginRestriction:j}},_bind:function(){H.on("click",function(){j(H,I)}),I.on("click",function(){H.prop("checked",i(I))}),J.on("click",function(){j(J,K)}),K.on("click",function(){J.prop("checked",i(K))}),L.on("click",function(){N.find("div[data-warp=editPwd]").css("display",L.prop("checked")?"":"none")}),M.find("#use_AUserPwd").on("keyup",function(){var b=a(this).val(),c=a(this).offsetParent().find(".ui-pwd-strength");s(b,c)}),N.find("#use_EUserNPwd").on("keyup",function(){var b=a(this).val(),c=a(this).offsetParent().find(".ui-pwd-strength");s(b,c)}),M.find("#use_AUserPwd").on("keyup",function(){M.find("#use_AUserPwdCfm").trigger("keyup")}),N.find("#use_EUserNPwd").on("keyup",function(){N.find("#use_EUserPwdCfm").trigger("keyup")})},_initTable:function(){var a=[{t:"com.Numbers",width:"10%",render:function(a){return a._index+1}},{t:"sys.UserName",width:"15%",fields:"Name"},{t:"sys.Group",width:"15%",fields:"Group"},{t:"com.Remark",width:"40%",fields:"Memo"},{t:"com.Modify",width:"10%",action:"edit",icon:"ui-table-icon-edit",handle:function(a){y=a,R._renderEditUser(y),N.dialog("show")}},{t:"com.Delete",action:"delete",icon:"ui-table-icon-del",handle:function(a,b){y=a,O.dialog("show"),b.stopPropagation()}}];W&&a.splice(3,1,{t:"com.Remark",width:"25%",fields:"Memo"},{t:"Security.LoginRestriction",width:"15%",action:"showAuth",render:function(a){return"admin"==a.Name?"/":'<i data-action="showAuth" class="ui-table-icon-search"></i>'},handle:function(a){R._renderShowUserAuth(a),Z.dialog("show")}}),x=R.$("#use_userTab").table({pageable:!1,height:200,columns:a,onRowSelect:function(a,b){return y=b.data,R._renderUserInfo(b.data),!1}})},_initDialog:function(){M.dialog({confirm:function(a,b){R._onAddUser(b)},beforeClose:function(){return X.reset(),!0}}).detach().appendTo(document.body),N.dialog({confirm:function(a,b){R._onEditUser(b)},beforeClose:function(){return X.reset(),!0}}).detach().appendTo(document.body),O.dialog({confirm:function(a,b){R._onDelUser(),b.ui.close()}}).detach().appendTo(document.body),Z.dialog({beforeClose:function(){return X.reset(),!0}})},_initInput:function(){C=a.validator([{element:M.find("#use_AUserName"),check:[P.Check.require,P.Check.require,P.Check.getnameString,P.Check.getnameString],errorMsg:["com.Necessary","com.Necessary","com.IncludeTpye7Tip","com.IncludeTpye7Tip"],events:["keyup","blur","keyup","blur"],errorElem:".u-input-error"},{element:M.find("#use_AUserMemo"),check:[P.Check.noTagCharacter],errorMsg:["sys.BadMemoTip"],events:["blur"],errorElem:".u-input-error"},{element:M.find("#use_AUserPwdCfm"),check:[r,r],errorMsg:["com.PwdDifTip","com.PwdDifTip"],events:["keyup","blur"],errorElem:"#use_AUserPwdCfmTip.u-input-error"},{element:M.find("#use_AUserPwd"),check:[P.Check.noQuotationColonAndASCII,P.Check.noQuotationColonAndASCII,P.Check.noQuotationColonAnd,P.Check.noQuotationColonAnd,function(a){return a.length>=8},function(a){return a.length>=8},P.getPasswordStrong,P.getPasswordStrong],errorMsg:["com.PwdTip2","com.PwdTip2","com.PwdTip2","com.PwdTip2","com.BadlengtPassword8Tip","com.BadlengtPassword8Tip","itc.PasswordTowWordTip","itc.PasswordTowWordTip"],events:["keyup","blur","keyup","blur","keyup","blur","keyup","blur"],errorElem:".u-input-error"}],function(a){a.parent().translation()}),D=a.validator([{element:N.find("#use_EUserMemo"),check:[P.Check.noTagCharacter],errorMsg:["sys.BadMemoTip"],events:["blur"],errorElem:".u-input-error"}],function(a){a.parent().translation()}),F=a.validator([{element:N.find("#use_EUserPhone"),check:[function(a){return a!==U?/^[0-9]*$/.test(a)&&a.length<=11:!0},function(a){return a!==U?/^[0-9]*$/.test(a)&&11===a.length:!0}],errorMsg:["sys.PhoneLength","sys.PhoneLength"],events:["keyup","blur"],errorElem:".u-input-error"}],function(a){a.parent().translation()}),N.find("#use_EUserPhone").on("ie"===a.browser.name&&a.browser.version<=8?"propertychange":"input",function(b){var c=a(b.target).val();(/\D/g.test(c)&&c!==U||c.length>11)&&a(b.target).val(c.replace(/\D/g,"").substr(0,11))}),G=a.validator([{element:N.find("#use_EUserMail"),check:[function(a){return a!==V?/^[\w-.]+@[\w-]+(\.{1}[\w-]+)+$/.test(a):!0}],errorMsg:["com.WrongEmailFormatTip"],events:["blur"],errorElem:".u-input-error"}],function(a){a.parent().translation()}),E=a.validator([{element:N.find("#use_EUserPwdCfm"),check:[r,r],errorMsg:["com.PwdDifTip","com.PwdDifTip"],events:["keyup","blur"],errorElem:"#use_EUserPwdCfmTip.u-input-error"},{element:N.find("#use_EUserNPwd"),check:[P.Check.noQuotationColonAndASCII,P.Check.noQuotationColonAndASCII,P.Check.noQuotationColonAnd,P.Check.noQuotationColonAnd,function(a){return a.length>=8},function(a){return a.length>=8},P.getPasswordStrong,P.getPasswordStrong],errorMsg:["com.PwdTip2","com.PwdTip2","com.PwdTip2","com.PwdTip2","com.BadlengtPassword8Tip","com.BadlengtPassword8Tip","itc.PasswordTowWordTip","itc.PasswordTowWordTip"],events:["keyup","blur","keyup","blur","keyup","blur","keyup","blur"],errorElem:".u-input-error"},{element:N.find("#use_EUserOPwd"),check:[P.Check.noQuotationColonAnd],errorMsg:["com.PwdTip2"],events:["blur"],errorElem:".u-input-error"}],function(a){a.parent().translation()})},render:function(){w?(k.attr("disabled",!0),R.disabled(R.$("[btn-for=renderAddUser]"),!0),R.$("[btn-for=renderAddUser]").addClass("ui-button-disabled")):(k.attr("disabled",!1),R.disabled(R.$("[btn-for=renderAddUser]"),!1),R.$("[btn-for=renderAddUser]").removeClass("ui-button-disabled")),q.get("IsLocalStore").done(function(b){S=b?["ComConf","MHardisk","ShutDown"]:["ComConf","MHardisk","ShutDown","Replay_01","Backup"],a.when(q.get("IVSCaps"),q.is("DSPConflict")).then(function(a,b){(webApp.IsIPCIntel||webApp.IsSDIntel||a)&&b&&S.push("IntelliConf"),w?n.UserManager.getUserInfo(m.Name).done(function(a){B=[a],x.table("dataSource",B).table("selectRow",0)}):n.UserManager.getUserInfoAll().done(function(a){B=a,x.table("dataSource",B).table("selectRow",0)})})}),n.UserManager.getActiveUserInfoAll().done(function(b){T.length=0,a.each(b,function(a,b){"web3.0"==b.ClientType.toLowerCase()&&T.push(b.Name)})}),n.ConfigManager.getConfig("LoginRestriction").done(function(a){Y=a})},destory:function(){M.remove(),N.remove(),O.remove(),Z.remove()},_renderShowUserAuth:function(a){Z.find("#show_user_auth_name").text(a.Name);for(var b=0,c=Y.length;c>b;b++)if(Y[b].UserName==a.Name){X.setData(Y[b]);break}if($)n.UserManager.getGroupInfoAll().done(function(b){var c=b[0].AuthorityList;e(Z.find("#use_SUserAuthli"),S,c,a.AuthorityList)});else{var d=f(m.AuthorityList,a.AuthorityList);e(Z.find("#use_SUserAuthli"),S,g(d,a.AuthorityList),a.AuthorityList)}X.onlyRenderLoginRestriction(),X.appendTo(Z.find("#showUser_auth_check")),X.addAuthList(Z.find("#use_SUserAuthli_wrap"))},_renderUserInfo:function(b){var c=R.$("#use_Ulist").empty();a.each(b.AuthorityList,function(b,d){-1===a.inArray(d,S)&&(isEnable("is_numberOK_Gate")&&"IntelliConf"===d?a('<span class="ui-detail-item" t="ANPR"></span>').translation().appendTo(c):a('<span class="ui-detail-item" t="'+d+'"></span>').appendTo(c))}),c.translation()},renderAddUser:function(){navigator.userAgent.indexOf("Chrome")>-1&&navigator.userAgent.indexOf("Safari")>-1&&-1===navigator.userAgent.indexOf("Edge")&&(M.find("#use_AUserPwd").prop("type","text"),M.find("#use_AUserPwd").css("-webkit-text-security","disc"),M.find("#use_AUserPwdCfm").prop("type","text"),M.find("#use_AUserPwdCfm").css("-webkit-text-security","disc")),M.find(":input").each(function(b,c){a(c).val("")}),M.find("#use_AUserAuthTip").text(""),u(M.find(".ui-pwd-strength")),n.UserManager.getGroupInfoAll().done(function(b){A=b;var c=M.find("#use_AUsergrp").empty();a.each(A,function(b,d){a('<option value="'+d.Name+'"></option>').text(d.Name).appendTo(c)}),a.each(A,function(a,b){b.Name===c.val()&&(z=b,e(I,S,m.AuthorityList,m.AuthorityList))}),H.prop("checked",i(I))}),C.validate(),X.reset(),W&&$?(R.$("#addUser_auth_list_wrap").addClass("fn-hide"),M.find("#addUser_auth_check_tip").removeClass("fn-hide"),X.appendTo(M.find("#addUser_auth_check")),X.addAuthList(M.find("#addUser_auth_list"))):"admin"===m.Group&&(R.$("#addUser_auth_list_wrap").removeClass("fn-hide"),M.find("#addUser_auth_check_tip").addClass("fn-hide")),M.dialog("show")},onSelAddGroup:function(b){var c=M.find(b.target).val();z=a.grep(A,function(a){return a.Name==c})[0],e(I,S,g(m.AuthorityList,z.AuthorityList),z.AuthorityList),H.prop("checked",i(I))},_onAddUser:function(c){function d(){function d(a){if(!W||!$)return void t.tip("success","sys.AddUserSuc");var b=X.getData();b.UserName=a;for(var c=0,d=Y.length;d>c;c++)Y[c].UserName==a&&Y.split(c,1);Y.push(b),R._saveLoginRestriction(Y,function(a){a.pop()},"add"),X.reset()}var e={},g=M.find("#use_AUserPwd").val(),h=M.find("#use_AUserName").val();e.Id=B.length+1,e.Name=h,e.Password=g,e.Type="",e.ModifiedTime="",e.Memo=M.find("#use_AUserMemo").val(),e.Group=M.find("#use_AUsergrp").val(),-1!==a.inArray("MHardisk",z.AuthorityList)&&-1!==a.inArray("ShutDown",z.AuthorityList)&&f.push("MHardisk","ShutDown"),e.AuthorityList=f,e.Reserved=!1,e.Sharable=!0;var i={};i.Id=B.length+1,i.Name=M.find("#use_AUserName").val(),i.Password=Base64.encode(g),i.Type="",i.ModifiedTime="",i.Memo=M.find("#use_AUserMemo").val(),i.Group=M.find("#use_AUsergrp").val(),i.AuthorityList=f,i.Reserved=!1,i.Sharable=!0,webCaps.Customize&&"DockUser"===webCaps.Customize.OnvifStrategy&&(i.Password=g),n.UserManager.addUserPlain(e).done(function(){webCaps.Customize&&webCaps.Customize.Onvif&&("DockUser"===webCaps.Customize.OnvifStrategy?P.EncryptInfo(webApp.EncryptInfo.pub,{user:i}).done(function(a){n.DockUser.addUser(a.salt,a.cipher,a.content)}):n.UserManager.onvifaddUser(i).done(function(){})),x.table("add",e,-1).table("selectRow",B.length-1),c.ui.close(),d(h)}).fail(function(a){c.ui.close();var d=b(a.error&&a.error.code,"sys.AddUserFail",0);t.tip("error",d)})}var e=X.getData();if(C.isInvalid())return void C.validate();if(e.AllowdLifeTime.LifeTimeStart>=e.AllowdLifeTime.LifeTimeEnd)return void M.find("#addUser_auth_check_tip").tip("warning",tl("com.BeginTLessThanEndTTip"));if(R.ipv6Error)return void M.find("#addUser_auth_check_tip").tip("error",tl("com.IPv6FormatError"));var f=h(I);return 0===f.length?void M.find("#use_AUserAuthTip").text(tl("net.Authenticationnone")):void d(n.Global.realm)},_saveLoginRestriction:function(a,b,c){var d,e;"add"==c?(d=tl("sys.AddUserSuc"),e=tl("com.AddUserSuccessButAuthFial")):"edit"==c?(d=tl("com.ChangeUserSuccessTip"),e=tl("com.EditUserSuccessButAuthFial")):"del"==c&&(d=tl("com.DelectUserSuccesTip")),n.ConfigManager.setConfig("LoginRestriction",a).done(function(){t.tip("success",d)}).fail(function(){b(a),"del"!=c&&t.tip("error",e)})},_renderEditUser:function(b){function c(){if(X.reset(),!W||!$)return void N.find("#editUser_auth_check_tip").addClass("fn-hide");if(W&&"admin"!==b.Name){N.css("width",800),N.find("#editUser_auth_list_wrap").addClass("fn-hide"),N.find("#editUser_auth_check").removeClass("fn-hide");for(var a=0,c=Y.length;c>a;a++)if(Y[a].UserName==b.Name){X.setData(Y[a]);break}X.appendTo(N.find("#editUser_auth_check")),X.addAuthList(N.find("#editUser_auth_list")),N.find("#editUser_auth_check_tip").removeClass("fn-hide")}else N.find("#editUser_auth_list_wrap").removeClass("fn-hide"),N.css("width",600),N.find("#editUser_auth_check_tip").addClass("fn-hide")}N.find(":input").each(function(b,c){a(c).val("")}),N.find("#use_EUserAuthliTip").text(""),N.find(".contact-error").hide(),u(N.find(".ui-pwd-strength")),N.find("div[data-warp=editPwd]").css("display","none"),L.prop("checked",!1);var d=N.find("#use_EUserName").empty();if(a.each(B,function(b,c){a('<option value="'+c.Name+'"></option>').text(c.Name).appendTo(d)}),d.val(b.Name),"admin"===b.Name&&v&&-1!==v.indexOf("A")?(N.find("#use_EUserPhone").prop("disabled","admin"!==m.Name),N.find("#use_EUserPhoneWrap").show(),n.PasswdFind.getContact().done(function(a){U=a.contact,N.find("#use_EUserPhone").val(U),N.find("#use_EUserPhone").trigger("change")}).fail(function(){U="",N.find("#use_EUserPhone").trigger("change")})):v&&-1!==v.indexOf("A")&&N.find("#use_EUserPhoneWrap").hide(),"admin"===b.Name&&v&&-1!==v.indexOf("B")?(N.find("#use_EUserMail").prop("disabled","admin"!==m.Name),N.find("#use_EUserMailWrap").show(),n.PasswdFind.getContact().done(function(a){V=a.contact,N.find("#use_EUserMail").val(V),N.find("#use_EUserMail").trigger("change")}).fail(function(){V="",N.find("#use_EUserMail").trigger("change")})):v&&-1!==v.indexOf("B")&&N.find("#use_EUserMailWrap").hide(),w){var h=N.find("#use_EUserGrp").empty();a('<option value="'+b.Group+'"></option>').text(b.Group).appendTo(h),h.val(b.Group);var j=f(m.AuthorityList,b.AuthorityList);m.cannotModifyAuth=!0,e(K,S,g(j,b.AuthorityList),b.AuthorityList),R._renderAdminInfo(!0)}else n.UserManager.getGroupInfoAll().done(function(c){A=c;var d=N.find("#use_EUserGrp").empty();a.each(A,function(b,c){a('<option value="'+c.Name+'"></option>').text(c.Name).appendTo(d)}),d.val(b.Group);var h=f(m.AuthorityList,b.AuthorityList);m.cannotModifyAuth=h.length>m.AuthorityList.length,a.each(A,function(a,c){c.Name===b.Group&&(z=c,e(K,S,g(h,z.AuthorityList),b.AuthorityList))}),J.prop("checked",i(K)),R._renderAdminInfo("admin"==b.Name||a.inArray(b.Name,T)>-1||m.cannotModifyAuth?!0:!1)});N.find("#use_EUserMemo").textfield("value",b.Memo),D.validate(),E.validate(),c()},_renderAdminInfo:function(b){N.find("#use_EUserGrp").prop("disabled",b),N.find("#use_EUserMemo").prop("disabled",b),J.prop("disabled",b),K.find(":input").not(".contact").each(function(c,d){a(d).prop("disabled",b)})},onSelEditGroup:function(b){var c=N.find(b.target).val();z=a.grep(A,function(a){return a.Name==c})[0],e(K,S,g(f(m.AuthorityList,y.AuthorityList),z.AuthorityList),g(z.AuthorityList,y.AuthorityList)),J.prop("checked",i(K))},onSelEditUser:function(b){var c=N.find(b.target).val();y=a.grep(B,function(a){return a.Name==c})[0],R._renderEditUser(y)},_onEditUser:function(c){var d=X.getData();if(D.isInvalid())return void D.validate();if(d.AllowdLifeTime.LifeTimeStart>=d.AllowdLifeTime.LifeTimeEnd)return void N.find("#editUser_auth_check_tip").tip("warning",tl("com.BeginTLessThanEndTTip"));if(R.ipv6Error)return void N.find("#editUser_auth_check_tip").tip("error",tl("com.IPv6FormatError"));var e=h(K);if(0===e.length)return void N.find("#use_EUserAuthliTip").text(tl("net.Authenticationnone"));if("admin"===y.Name&&v){if(-1!==v.indexOf("A")&&N.find("#use_EUserPhone").val()!==U&&F.isInvalid())return void F.validate();if(-1!==v.indexOf("B")&&N.find("#use_EUserMail").val()!==V&&G.isInvalid())return void G.validate()}if(L.prop("checked")){if(E.isInvalid())return void E.validate();var f,g,i,j,k=N.find("#use_EUserName").val(),o=N.find("#use_EUserOPwd").val(),q=N.find("#use_EUserNPwd").val(),r="Login to "+l;webApp.EncryptInfo&&webApp.EncryptInfo.asymmetric&&webCaps.OnvifSync?(f=q,g=o,i=q,j=o):(f=hex_md5(k+":"+r+":"+q),g=hex_md5(k+":"+r+":"+o),i=Base64.encode(q),j=Base64.encode(o)),webCaps.Customize&&"DockUser"===webCaps.Customize.OnvifStrategy&&(i=q,j=o),n.UserManager.modifyPassword(k,f,g).done(function(){webCaps.Customize&&webCaps.Customize.Onvif&&("DockUser"===webCaps.Customize.OnvifStrategy?P.EncryptInfo(webApp.EncryptInfo.pub,{name:k,pwd:i,pwdOld:j}).done(function(a){n.DockUser.modifyPassword(a.salt,a.cipher,a.content)}):n.UserManager.onvifmodifyPassword(k,i,j)),a("#reset_pwd_content").hide();p.getLoginInfo().username;"admin"===y.Name&&v?(t.tip("success","com.ChangeUserSuccessTip"),R._onEditUserOnly(c)):a.inArray(y.Name,T)>-1||m.cannotModifyAuth||w?(c.ui.close(),t.tip("success","com.ChangeUserSuccessTip")):R._onEditUserOnly(c)}).fail(function(a){var d="";a.error&&a.error.detail&&a.error.detail.remainLockSeconds?(d="sys.ModifyPwdLockedSecond",c.ui.close(),t.tip("error",tl(d).replace("XXX",a.error.detail.remainLockSeconds))):(d=b(a.error&&a.error.code,"com.ChangePwdFailTip",0),c.ui.close(),t.tip("error",d))})}else R._onEditUserOnly(c)},_onEditUserOnly:function(){function c(){var a=!1;if(!W||!$)return void t.tip("success","w_ChangeUserSucce");for(var b=0,c=Y.length;c>b;b++)if(Y[b].UserName==d.Name){var e=X.getData();e.UserName=d.Name;var f=Y.splice(b,1)[0];Y.push(e),a=!0,R._saveLoginRestriction(Y,function(a){a.pop(),a.push(f)},"edit");break}if(!a){var e=X.getData();e.UserName=d.Name,Y.push(e),R._saveLoginRestriction(Y,function(a){a.pop()},"edit")}X.reset()}var d=a.extend(!0,{},y);d.Group=N.find("#use_EUserGrp").val(),d.Memo=N.find("#use_EUserMemo").val(),d.AuthorityList=z.AuthorityList;var e=h(K);if(-1!==a.inArray("MHardisk",d.AuthorityList)&&-1!==a.inArray("ShutDown",d.AuthorityList)&&e.push("MHardisk","ShutDown"),d.AuthorityList=e,"admin"===y.Name&&v&&-1!==v.indexOf("A")&&N.find("#use_EUserPhone").val()!==U){if(F.isInvalid())return void F.validate();P.EncryptInfo(webApp.EncryptInfo.pub,{mode:1,contact:N.find("#use_EUserPhone").val()+""}).done(function(a){n.PasswdFind.setContact(a.salt,a.cipher,a.content).done(function(){U=N.find("#use_EUserPhone").val(),t.tip("success","com.ChangeUserSuccessTip")}).fail(function(){t.tip("error","com.ChangePwdFailTip")})})}else if("admin"===y.Name&&v&&-1!==v.indexOf("B")&&N.find("#use_EUserMail").val()!==V){if(G.isInvalid())return void G.validate();P.EncryptInfo(webApp.EncryptInfo.pub,{mode:2,contact:N.find("#use_EUserMail").val()+""}).done(function(a){n.PasswdFind.setContact(a.salt,a.cipher,a.content).done(function(){V=N.find("#use_EUserMail").val(),t.tip("success","com.ChangeUserSuccessTip")}).fail(function(){t.tip("error","com.ChangePwdFailTip")})})}else if("admin"!==y.Name)if(webApp.EncryptInfo&&webApp.EncryptInfo.asymmetric){var f={method:"userManager.modifyUser",params:{name:d.Name,user:d},id:d.Id};n.System.multiSec([f]).done(function(a){c(),R._onEditUserOnlyMultiSec(a,d)}).fail(function(){n.UserManager.modifyUser(d.Name,d).done(function(a){c(),R._onEditUserOnlyMultiSec(a,d)}).fail(function(a){var c=b(a.error&&a.error.code,"com.ChangeUserFailTip",0);t.tip("error",c)})})}else n.UserManager.modifyUser(d.Name,d).done(function(a){c(),R._onEditUserOnlyMultiSec(a,d)}).fail(function(a){var c=b(a.error&&a.error.code,"com.ChangeUserFailTip",0);t.tip("error",c)});N.dialog("close")},_onEditUserOnlyMultiSec:function(b,c){webCaps.Customize&&webCaps.Customize.Onvif&&("DockUser"===webCaps.Customize.OnvifStrategy?n.DockUser.modifyUser(c.Name,c):n.UserManager.onvifmodifyUser(c.Name,c)),y.Group=c.Group,y.Memo=c.Memo,y.AuthorityList=c.AuthorityList;var d=0;N.find("#use_EUserName").find("option").each(function(b,c){a(c).val()==y.Name&&(d=b)}),x.table("modify",y,d),x.table("selectRow",d),W||t.tip("success","com.ChangeUserSuccessTip")},_onDelUser:function(){function a(){if(!W||!$)return void t.tip("success","com.DelectUserSuccesTip");for(var a=null,b=0;b<Y.length;b++)if(Y[b]&&Y[b].UserName==y.Name){a=Y.splice(b,1),R._saveLoginRestriction(Y,function(b){b.push(a)},"del");break}}n.UserManager.deleteUser(y.Name).done(function(){webCaps.Customize&&webCaps.Customize.Onvif&&("DockUser"===webCaps.Customize.OnvifStrategy?n.DockUser.deleteUser(y.Name):n.UserManager.onvifdeleteUser(y.Name)),a(),x.table("del",y),x.table("selectRow",0)}).fail(function(a){var c=b(a.error&&a.error.code,"com.DelectUserFailTip",0);t.tip("error",c)})}})}),define("userM_group",function(require,c,d){var f,g,k,l,m,p,s,u,v,w,x,y,z=null,A=["ComConf","MHardisk","ShutDown"],B=[];d.exports=o.extend({init:function(){z=this,w=z.$("#use_AGrpDlg"),x=z.$("#use_EGrpDlg"),y=z.$("#use_DGrpDlg"),z._initTable(),z._initDialog(),p=w.find("#use_AGrpAuth"),s=w.find("#use_AGrpAuthli"),u=x.find("#use_EGrpAuth"),v=x.find("#use_EGrpAuthli"),z._initInput(),-1!==webApp.DeviceType.indexOf("SD")&&a("#use_AGrpName").prop("maxlength",15),n.UserManager.getAuthorityList().done(function(a){B=a}),w.find("#use_AGrpMemo").textfield({length:31,asciiByte:1,notAsciiByte:3}),x.find("#use_EGrpMemo").textfield({length:31,asciiByte:1,notAsciiByte:3}),z._bind(),z.render()
},_initTable:function(){f=z.$("#use_groupTab").table({pageable:!1,height:200,columns:[{t:"com.Numbers",width:"10%",render:function(a){return a._index+1}},{t:"sys.Group",width:"20%",fields:"Name"},{t:"com.Remark",width:"50%",fields:"Memo"},{t:"com.Modify",width:"10%",action:"edit",icon:"ui-table-icon-edit",handle:function(a){x.dialog("show"),k=a,z._renderEditGroup(a)}},{t:"com.Delete",action:"delete",icon:"ui-table-icon-del",handle:function(a,b){k=a,y.dialog("show"),b.stopPropagation()}}],onRowSelect:function(a,b){return k=b.data,z._renderGroupInfo(b.data),!1}})},_initDialog:function(){w.dialog({confirm:function(a,b){z._onAddGroup(b)}}).detach().appendTo(document.body),x.dialog({confirm:function(a,b){z._onEditGroup(b)}}).detach().appendTo(document.body),y.dialog({confirm:function(a,b){z._onDelGroup(),b.ui.close()}}).detach().appendTo(document.body)},_initInput:function(){l=a.validator([{element:w.find("#use_AGrpName"),check:[r.Check.alphaNumUnderline,r.Check.require],errorMsg:["com.IncludeTpye6Tip","com.Necessary"],events:["blur","blur"],errorElem:".u-input-error"},{element:w.find("#use_AGrpMemo"),check:[r.Check.noTagCharacter],errorMsg:["sys.BadMemoTip"],events:["blur"],errorElem:".u-input-error"}],function(a){a.parent().translation()}),m=a.validator([{element:x.find("#use_EGrpMemo"),check:[r.Check.noTagCharacter],errorMsg:["sys.BadMemoTip"],events:["blur"],errorElem:".u-input-error"}],function(a){a.parent().translation()})},_bind:function(){p.on("click",function(){j(p,s)}),s.on("click",function(){p.prop("checked",i(s))}),u.on("click",function(){j(u,v)}),v.on("click",function(){u.prop("checked",i(v))})},render:function(){q.get("IsLocalStore").done(function(b){A=b?["ComConf","MHardisk","ShutDown"]:["ComConf","MHardisk","ShutDown","Replay_01","Backup"],a.when(q.get("IVSCaps"),q.is("DSPConflict")).then(function(a,b){(webApp.IsIPCIntel||webApp.IsSDIntel||a)&&b&&A.push("IntelliConf"),n.UserManager.getGroupInfoAll().done(function(a){g=a,f.table("dataSource",g).table("selectRow",0)})})})},destory:function(){w.remove(),x.remove(),y.remove()},_renderGroupInfo:function(b){var c=z.$("#use_Glist").empty();a.each(b.AuthorityList,function(b,d){-1===a.inArray(d,A)&&(isEnable("is_numberOK_Gate")&&"IntelliConf"===d?a('<span class="ui-detail-item" t="ANPR"></span>').translation().appendTo(c):a('<span class="ui-detail-item" t="'+d+'"></span>').appendTo(c))}),c.translation()},renderAddGroup:function(){var b=a.extend(!0,[],B);isEnable("is_show_ModifyPsw")&&a.each(b,function(a,c){("Account"===c||"AuthUserMag"===c)&&b.splice(a,1)}),w.find(":input").each(function(b,c){a(c).val("")}),w.find("#use_AGrpAuthTip").text(""),e(s,A,b,[]),p.prop("checked",i(s)),l.validate(),w.dialog("show")},_onAddGroup:function(c){if(l.isInvalid())return void l.validate();var d=h(s);if(0===d.length)return void w.find("#use_AGrpAuthTip").text(tl("net.Authenticationnone"));var e={};e.Id=g.length+1,e.Name=w.find("#use_AGrpName").val(),e.Memo=w.find("#use_AGrpMemo").val(),-1===B.indexOf("AuthMaintence")&&a.each(A,function(b,c){-1===a.inArray(c,d)&&d.push(c)}),e.AuthorityList=d,n.UserManager.addGroup(e).done(function(){f.table("add",e,-1),f.table("selectRow",g.length-1),c.ui.close(),t.tip("success","sys.ForifyUserSuc")}).fail(function(a){c.ui.close();var d=b(a.error&&a.error.code,"sys.ForifyUserFail",1);t.tip("error",d)})},_renderEditGroup:function(b){x.find(":input").each(function(b,c){a(c).val("")}),x.find("#use_EGrpAuthTip").text("");var c=x.find("#use_EGrpName").empty();a.each(g,function(b,d){a('<option value="'+d.Name+'"></option>').text(d.Name).appendTo(c)}),c.val(b.Name),x.find("#use_EGrpMemo").val(b.Memo),a.each(g,function(c,d){var f=a.extend(!0,[],B);d.Name===b.Name&&(k=d,isEnable("is_show_ModifyPsw")&&"admin"!==d.Name&&a.each(f,function(a,b){("Account"===b||"AuthUserMag"===b)&&f.splice(a,1)}),e(v,A,f,b.AuthorityList))}),u.prop("checked",i(v)),m.validate()},onSelEditGroup:function(b){var c=x.find(b.target).val();k=a.grep(g,function(a){return a.Name==c})[0],z._renderEditGroup(k)},_onEditGroup:function(c){if(m.isInvalid())return void m.validate();var d=h(v);if(0===d.length)return void x.find("#use_EGrpAuthTip").text(tl("net.Authenticationnone"));var e=a.extend(!0,{},k);e.Name=x.find("#use_EGrpName").val(),e.Memo=x.find("#use_EGrpMemo").val(),webApp.newAuthority||a.each(A,function(b,c){-1===a.inArray(c,d)&&d.push(c)}),e.AuthorityList=d,n.UserManager.modifyGroup(e.Name,e).done(function(){k.Name=e.Name,k.Memo=e.Memo,k.AuthorityList=e.AuthorityList;var b=0;x.find("#use_EGrpName").find("option").each(function(c,d){a(d).val()==k.Name&&(b=c)}),f.table("modify",k,b),f.table("selectRow",b),t.tip("success","com.ChangeGrpSuccessTip")}).fail(function(a){var c=b(a.error&&a.error.code,"com.ChangeGrpFailTip",1);t.tip("error",c)}),c.ui.close()},_onDelGroup:function(){n.UserManager.deleteGroup(k.Name).done(function(){t.tip("success","com.DelectGropSuccesTip"),f.table("del",k),f.table("selectRow",0)}).fail(function(a){var c=b(a.error&&a.error.code,"com.DelectGropFailTip",1);t.tip("error",c)})}})})}),define("use_onvif",function(require,e,f){function g(a,b){var c=b.children("li");if(c.removeClass("current"),a){var d=s.newPwdStrenthValidator(a),e=b.find("."+d);e.addClass("current"),b.prop("class","ui-pwd-strength "+d)}else b.prop("class","ui-pwd-strength")}var h,i,j,k,l,m,n,o,p,q=require("jsCore/rpc"),r=(require("jsCore/rpcLogin"),require("jsCore/pageBase")),s=require("common/common"),t=["admin","operator","user"];f.exports=r.extend({init:function(){l=this,i=l.$("#use_AOnvifDlg"),j=l.$("#use_EOnvifDlg"),k=l.$("#use_DOnvifDlg"),i.find("[data-pwd]").on("keydown",function(a){return 32===a.keyCode?!1:void 0}),j.find("[data-pwd]").on("keydown",function(a){return 32===a.keyCode?!1:void 0}),j.find("#use_EOnvifChkPwd").on("click",function(){j.find("div[data-warp=editOnvifPwd]").css("display",j.find("#use_EOnvifChkPwd").prop("checked")?"":"none")}),i.find("#use_AOnvifPwd").on("keyup",function(){var b=a(this).val(),c=a(this).offsetParent().find(".ui-pwd-strength");g(b,c)}),j.find("#use_EOnvifNPwd").on("keyup",function(){var b=a(this).val(),c=a(this).offsetParent().find(".ui-pwd-strength");g(b,c)}),i.find("#use_AOnvifPwd").on("blur",function(){i.find("#use_AOnvifPwdCfm").trigger("keyup")}),j.find("#use_EOnvifNPwd").on("blur",function(){j.find("#use_EOnvifNPwdCfm").trigger("keyup")}),l._initTable(),l._initDialog(),l._initInput(),l.render()},render:function(){q.DockUser.getUserInfoAll().done(function(a){n=a,h.table("dataSource",n).table("selectRow",0)})},destory:function(){i.remove(),j.remove(),k.remove()},_initTable:function(){h=l.$("#use_OnvifTab").table({pageable:!1,height:200,columns:[{t:"com.Numbers",width:"15%",render:function(a){return a._index+1}},{t:"sys.UserName",width:"25%",fields:"Name"},{t:"sys.Group",width:"25%",fields:"Group"},{t:"com.Modify",width:"17%",action:"edit",icon:"ui-table-icon-edit",handle:function(a){m=a,j.dialog("show"),l._renderEditOnvif(m)}},{t:"com.Delete",action:"delete",icon:"ui-table-icon-del",handle:function(a,b){m=a,k.dialog("show"),b.stopPropagation()}}]})},_initDialog:function(){i.dialog({confirm:function(a,b){l._onAddOnvif(b)}}).detach().appendTo(document.body),j.dialog({confirm:function(a,b){l._onEditOnvif(b)}}).detach().appendTo(document.body),k.dialog({confirm:function(a,b){l._onDelOnvif(),b.ui.close()}}).detach().appendTo(document.body)},_initInput:function(){o=a.validator([{element:i.find("#use_AOnvifName"),check:[s.Check.require,s.Check.require,s.Check.getnameString,s.Check.getnameString],errorMsg:["com.Necessary","com.Necessary","com.IncludeTpye7Tip","com.IncludeTpye7Tip"],events:["keyup","blur","keyup","blur"],errorElem:".u-input-error"},{element:i.find("#use_AOnvifPwdCfm"),check:[c,c],errorMsg:["com.PwdDifTip","com.PwdDifTip"],events:["keyup","blur"],errorElem:"#use_AOnvifPwdCfmTip.u-input-error"},{element:i.find("#use_AOnvifPwd"),check:[s.Check.noQuotationColonAndASCII,s.Check.noQuotationColonAndASCII,s.Check.noQuotationColonAnd,s.Check.noQuotationColonAnd,function(a){return a.length>=8},function(a){return a.length>=8},s.getPasswordStrong,s.getPasswordStrong],errorMsg:["com.PwdTip2","com.PwdTip2","com.PwdTip2","com.PwdTip2","com.BadlengtPassword8Tip","com.BadlengtPassword8Tip","itc.PasswordTowWordTip","itc.PasswordTowWordTip"],events:["keyup","blur","keyup","blur","keyup","blur","keyup","blur"],errorElem:".u-input-error"}],function(a){a.parent().translation()}),p=a.validator([{element:j.find("#use_EOnvifPwdCfm"),check:[c,c],errorMsg:["com.PwdDifTip","com.PwdDifTip"],events:["keyup","blur"],errorElem:"#use_EOnvifPwdCfmTip.u-input-error"},{element:j.find("#use_EOnvifOPwd"),check:[s.Check.noQuotationColonAnd],errorMsg:["com.PwdTip2"],events:["blur"],errorElem:".u-input-error"},{element:j.find("#use_EOnvifNPwd"),check:[s.Check.noQuotationColonAndASCII,s.Check.noQuotationColonAndASCII,s.Check.noQuotationColonAnd,s.Check.noQuotationColonAnd,function(a){return a.length>=8},function(a){return a.length>=8},s.getPasswordStrong,s.getPasswordStrong],errorMsg:["com.PwdTip2","com.PwdTip2","com.PwdTip2","com.PwdTip2","com.BadlengtPassword8Tip","com.BadlengtPassword8Tip","itc.PasswordTowWordTip","itc.PasswordTowWordTip"],events:["keyup","blur","keyup","blur","keyup","blur","keyup","blur"],errorElem:".u-input-error"}],function(a){a.parent().translation()})},renderAddOnvif:function(){navigator.userAgent.indexOf("Chrome")>-1&&navigator.userAgent.indexOf("Safari")>-1&&-1===navigator.userAgent.indexOf("Edge")&&(i.find("#use_AOnvifPwd").prop("type","text"),i.find("#use_AOnvifPwd").css("-webkit-text-security","disc"),i.find("#use_AOnvifPwdCfm").prop("type","text"),i.find("#use_AOnvifPwdCfm").css("-webkit-text-security","disc")),i.find(":input").each(function(b,c){a(c).val("")});var b=i.find("#use_AOnvifgrp").empty();a.each(t,function(c,d){a('<option value="'+d+'"></option>').text(d).appendTo(b)}),d(i.find(".ui-pwd-strength")),o.validate(),i.dialog("show")},_onAddOnvif:function(a){if(o.isInvalid())return void o.validate();var c={};c.Id=n.length+1,c.Name=i.find("#use_AOnvifName").val(),c.Password=i.find("#use_AOnvifPwd").val(),c.Group=i.find("#use_AOnvifgrp").val(),s.EncryptInfo(webApp.EncryptInfo.pub,{user:c}).done(function(d){q.DockUser.addUser(d.salt,d.cipher,d.content).done(function(){c.Password="******",h.table("add",c,-1).table("selectRow",n.length-1),a.ui.close(),l.tip("success","sys.AddUserSuc")}).fail(function(c){a.ui.close();var d=b(c.error&&c.error.code,"sys.AddUserFail",0);l.tip("error",d)})})},_renderEditOnvif:function(b){j.find(":input").each(function(b,c){a(c).val("")}),d(j.find(".ui-pwd-strength")),j.find("div[data-warp=editOnvifPwd]").css("display","none"),j.find("#use_EOnvifChkPwd").prop("checked",!1);var c=j.find("#use_EOnvifName").empty();a.each(n,function(b,d){a('<option value="'+d.Name+'"></option>').text(d.Name).appendTo(c)}),c.val(b.Name);var e=j.find("#use_EOnvifGrp").empty();a.each(t,function(b,c){a('<option value="'+c+'"></option>').text(c).appendTo(e)}),e.val(b.Group),e.prop("disabled","admin"===b.Name),p.validate()},onSelEditOnvif:function(b){var c=j.find(b.target).val();m=a.grep(n,function(a){return a.Name==c})[0],l._renderEditOnvif(m)},_onEditOnvif:function(a){var c=j.find("#use_EOnvifName").val();if(j.find("#use_EOnvifChkPwd").prop("checked")){if(p.isInvalid())return void p.validate();var d=j.find("#use_EOnvifOPwd").val(),e=j.find("#use_EOnvifNPwd").val();s.EncryptInfo(webApp.EncryptInfo.pub,{name:c,pwd:e,pwdOld:d}).done(function(d){q.DockUser.modifyPassword(d.salt,d.cipher,d.content).done(function(){"admin"===c?l.tip("success","com.ChangeUserSuccessTip"):l._onEditOnvifOnly(),j.dialog("close")}).fail(function(c){var d="";c.error&&c.error.detail&&c.error.detail.remainLockSeconds?(d="sys.ModifyPwdLockedSecond",a.ui.close(),l.tip("error",tl(d).replace("XXX",c.error.detail.remainLockSeconds))):(d=b(c.error&&c.error.code,"com.ChangePwdFailTip",0),a.ui.close(),l.tip("error",d))})})}else"admin"!==c&&l._onEditOnvifOnly(),j.dialog("close")},_onEditOnvifOnly:function(){m.Group=j.find("#use_EOnvifGrp").val();var a={method:"DockUser.modifyUser",params:{name:m.Name,user:m},id:m.Id};q.System.multiSec([a]).done(function(a){l._onEditOnvifMultiSec(a)}).fail(function(){q.DockUser.modifyUser(m.Name,m).done(function(a){l._onEditOnvifMultiSec(a)}).fail(function(a){var c=b(a.error&&a.error.code,"com.ChangeUserFailTip",0);father.tip("error",c)})})},_onEditOnvifMultiSec:function(){var b=0;j.find("#use_EOnvifName").find("option").each(function(c,d){a(d).val()==m.Name&&(b=c)}),h.table("modify",m,b),h.table("selectRow",b),l.tip("success","com.ChangeUserSuccessTip")},_onDelOnvif:function(){q.DockUser.deleteUser(m.Name).done(function(){l.tip("success","com.DelectUserSuccesTip"),h.table("del",m),h.table("selectRow",0)}).fail(function(a){var c=b(a.error&&a.error.code,"com.DelectUserFailTip",0);l.tip("error",c)})}})})}(jQuery);