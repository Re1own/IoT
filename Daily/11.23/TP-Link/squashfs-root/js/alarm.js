!function(a){define(function(require,b,c){function d(b){for(var c=b.eventList,d=!0,e=0;e<c.length;++e)"Stop"!==c[e].Action&&-1===["FaceFeatureAbstract","StorageNotExist","WifiCheck"].indexOf(c[e].Code)&&(a("#alarm_table").table("add",c[e],-1),d&&(!n&&a("#alarm_tip").prop("checked")&&a("#d_alarmtip").show(),window.playAlarmSound(a("#sound_path").val()),d=!1))}function e(a){var b=m[a];h.EventManager.attach(b.events).done(function(a){b.sid=a})}function f(a){var b=m[a];h.EventManager.detach(b.sid,b.events)}function g(){webApp.NotifyVersion?j.devNotify.reconnect():p.$("#alarm_frame").attr("src",p.getEncryptServerUrl(h.getSession())),o.each(function(b,c){var d=a(c),f=d.data("event");d.prop("checked")&&e(f)})}var h=require("jsCore/rpc"),i=require("jsCore/ability"),j=require("common/common"),k=require("jsCore/plugin"),l=(require("jsCore/rpcLogin"),require("jsCore/pageBase")),m=null,n=!1,o=null,p=null,q=null,r=null;c.exports=l.extend({init:function(){p=this;var b="ivs.AlarmChannel";webApp.DeviceType.indexOf("TPC")>-1&&(b="com.AlarmInfo"),m={videoMotion:{events:["VideoMotion"],sid:-1},storageLowSpace:{events:["StorageLowSpace"],sid:-1},storageFailure:{events:["StorageFailure"],sid:-1},videoBlind:{events:["VideoBlind"],sid:-1},externalAlarm:{events:["AlarmLocal"],sid:-1},illegalAccess:{events:["LoginFailure"],sid:-1},audioDetect:{events:[],sid:-1},ivs:{events:["CrossLineDetection","CrossRegionDetection","LeftDetection","TakenAwayDetection","FaceDetection","RioterDetection","MoveDetection","WanderDetection","CrossFenceDetection","ParkingDetection","NumberStat","RetrogradeDetection","TrafficJunction","ManNumDetection","ManStandDetection","NearDistanceDetection","ManFallDetection","PrisonerRiseDetection","ClimbDetection","LeaveDetection","FaceRecognition","FireDetection","HumanTrait","NonMotorDetect","StayDetection","TailDetection","TumbleDetection","FightDetection","DistanceDetection"],sid:-1},VideoAbnormalDetection:{events:["VideoAbnormalDetection","SceneChange"],sid:-1},HeatImagingTemper:{events:["HeatImagingTemper"],sid:-1},BetweenRulesTemperDiffAlarm:{events:["BetweenRulesTemperDiffAlarm"],sid:-1},HotSpotWarning:{events:["HotSpotWarning"],sid:-1},ColdSpotWarning:{events:["ColdSpotWarning"],sid:-1},FireWarning:{events:["FireWarning","SmokeDetection"],sid:-1},PowerFault:{events:[],sid:-1},AnalogAlarm:{events:[],sid:-1},LabelInfoAlarm:{events:[],sid:-1},TrafficSuspiciousCar:{events:[],sid:-1},BurningWarning:{events:["BurningWarning"],sid:-1},ShutterAbnormal:{events:["ShutterAbnormal"],sid:-1},StorageHealthAlarm:{events:["StorageHealthAlarm"],sid:-1},SafetyAbnormal:{events:["SafetyAbnormal"],sid:-1}},r={HumanTrait:"ivs.PeopleDetect",ManNumDetection:"appEventManNumDetection",StayDetection:"StereoManStayDetection",TailDetection:"StereoTailDetection",TumbleDetection:"StereoFallDetection",FightDetection:"StereoFightDetection",DistanceDetection:"StereoApproachDetection"},isEnable("is_numberOK_Gate")&&(p.$('[data-event="ivs"]').next("span").attr("t","ANPR").text(tl("ANPR")),r.TrafficJunction="ANPR"),i.get("IVSCaps",function(b){b&&b.SupportedScene&&-1!==a.inArray("ObjectDetect",b.SupportedScene)&&(r.TrafficJunction="ivs.CarDetection")}),webApp.NotifyVersion?(p.$("#alarm_table_frame").remove(),p.$("#alarm_table").table(webApp.supportSafetyAbnormalAlarm?{pageable:!1,height:454,columns:[{t:"com.Numbers",width:"10%",render:function(a){return a._index+1}},{t:"com.Time",width:"30%",render:function(a){var b="";if(a.Data&&a.Data.Time)b=a.Data.Time;else if(a.Data&&a.Data.LocaleTime)b=a.Data.LocaleTime;else if(a.Data&&a.Data.UTC){var c=new Date;c.setTime(1e3*a.Data.UTC),b+=c.getFullYear()+"-",b+=jQuery.pad(c.getMonth()+1,2)+"-",b+=jQuery.pad(c.getDate(),2)+" ",b+=jQuery.pad(c.getHours(),2)+":",b+=jQuery.pad(c.getMinutes(),2)+":",b+=jQuery.pad(c.getSeconds(),2)}return b}},{t:"per.AlarmType",width:"20%",render:function(a){var b=tl(r[a.Code]||a.Code);return a.Data&&a.Data.ExceptionType?b+="("+tl(a.Data.ExceptionType)+")":a.Data&&a.Data.Type&&(b+="("+tl(a.Data.Type)+")"),b}},{t:"com.SourceIp",width:"20%",render:function(a){var b="";return a.Data&&a.Data.Address&&(b=a.Data.Address),b}},{t:b,width:"20%",render:function(a){var b;return b=-1!==webApp.DeviceType.indexOf("TPC")&&a.Data.AlarmId?a.Data.AlarmId:a.Index+1,a.Data.PresetID&&(b+=" - ",b+=a.Data.PresetID),b}}]}:{pageable:!1,height:454,columns:[{t:"com.Numbers",width:"10%",render:function(a){return a._index+1}},{t:"com.Time",width:"30%",render:function(a){var b="";if(a.Data&&a.Data.Time)b=a.Data.Time;else if(a.Data&&a.Data.LocaleTime)b=a.Data.LocaleTime;else if(a.Data&&a.Data.UTC){var c=new Date;c.setTime(1e3*a.Data.UTC),b+=c.getFullYear()+"-",b+=jQuery.pad(c.getMonth()+1,2)+"-",b+=jQuery.pad(c.getDate(),2)+" ",b+=jQuery.pad(c.getHours(),2)+":",b+=jQuery.pad(c.getMinutes(),2)+":",b+=jQuery.pad(c.getSeconds(),2)}return b}},{t:"per.AlarmType",width:"30%",render:function(a){var b=tl(r[a.Code]||a.Code);return a.Data&&a.Data.Type&&(b+="("+tl(a.Data.Type)+")"),b}},{t:b,width:"30%",render:function(a){var b;return b=-1!==webApp.DeviceType.indexOf("TPC")&&a.Data.AlarmId?a.Data.AlarmId:a.Index+1,a.Data.PresetID&&(b+=" - ",b+=a.Data.PresetID),b}}]})):(p.$("#alarm_table").remove(),p.$("#player").remove()),webApp.IsLocalStore||(p.$("input[data-event=storageLowSpace]").closest("label").remove(),p.$("input[data-event=storageFailure]").closest("label").remove()),webApp.ALARM_IN_NUMBER||p.$("input[data-event=externalAlarm]").closest("label").remove();var c=a.Deferred();-1!==webApp.DeviceType.indexOf("TPC")?(p.$("[btn-for=onAlarmClean]").show(),i.get("RadioMetry").done(function(a){a&&a.Support&&(p.$("input[data-event=HeatImagingTemper]").closest("label").show(),p.$("input[data-event=BetweenRulesTemperDiffAlarm]").closest("label").show(),p.$("input[data-event=HotSpotWarning]").closest("label").show(),p.$("input[data-event=ColdSpotWarning]").closest("label").show(),h.ConfigManager.getConfig("CalibratePoints").done(function(a){a.Enable&&m.HeatImagingTemper.events.push("FaceOverHeating"),c.resolve()}).fail(function(){c.resolve()}))}),i.get("FireWarning").done(function(a){a.Support&&p.$("input[data-event=FireWarning]").closest("label").show()}),i.get("BurningCheck").then(function(a){a&&a.Support&&p.$("input[data-event=BurningWarning]").closest("label").show()})):c.resolve();var k=i.get("WirelessAlarm").done(function(a){a&&a.Support&&m.externalAlarm.events.push("AlarmExtended")}),l=!1,n=i.get("AudioFileManager").done(function(a){a&&a.Support&&(l=!0,m.audioDetect.events.push("AudioDetect"))}),q=i.get("AudioDetectCaps").done(function(a){a&&a.AnomalyDetect&&(l=!0,m.audioDetect.events.push("AudioAnomaly")),a&&a.MutationDetect&&(l=!0,m.audioDetect.events.push("AudioMutation"))}),s=i.get("VideoDetectCaps").done(function(a){a&&a.SupportMovedDetect||(p.$("input[data-event=VideoAbnormalDetection]").closest("label").remove(),delete m.VideoAbnormalDetection),a&&a.SupportMotion||(p.$("input[data-event=videoMotion]").closest("label").remove(),delete m.videoMotion),a&&a.SupportBlind?a&&a.UnFocusDetect&&-1===webApp.DeviceType.indexOf("TPC")&&(m.videoBlind.events.push("VideoUnFocus"),p.$("input[data-event=videoBlind]").next("span").text(tl("med.VideoOn")).attr("t","med.VideoOn").attr("title",tl("med.VideoOn"))):(p.$("input[data-event=videoBlind]").closest("label").remove(),delete m.videoBlind)}),t=i.is("DSPConflict").done(function(a){(webApp.IsIPCIntel||webApp.IsSDIntel||-1!==webApp.DeviceType.indexOf("TPC")&&webCaps.is_new_IVSUI)&&!a||(p.$("input[data-event=ivs]").closest("label").remove(),delete m.ivs)}),u=!1,v=i.get("FaceBoardCaps").done(function(a){a&&a.PowerVoltageDetect&&(u=!0,m.PowerFault.events.push("OverVoltage","UnderVoltage"),p.$("input[data-event=PowerFault]").closest("label").show())}),w=i.get("ExternalSensorCaps").done(function(a){a&&a.Support&&(m.AnalogAlarm.events.push("AnalogAlarm"),p.$("input[data-event=AnalogAlarm]").closest("label").show(),"RFID"==a.NetworkingMode&&m.AnalogAlarm.events.push("WireLessDevLowPower")),a&&a.SupportLabelInfo&&(m.LabelInfoAlarm.events.push("LabelInfoAlarm","WireLessDevLowPower"),p.$("input[data-event=LabelInfoAlarm]").closest("label").show())}),x=i.get("SupportedTrafficTrustList").then(function(a){a&&(m.TrafficSuspiciousCar.events.push("TrafficSuspiciousCar"),p.$("input[data-event=TrafficSuspiciousCar]").closest("label").show(),p.$("input[data-event=ivs]").closest("label").remove(),delete m.ivs)}),y=i.get("SupportSafetyAbnormalAlarm").then(function(a){a&&p.$("input[data-event=SafetyAbnormal]").closest("label").show()});a.when(k,n,q,s,t,c,v,w,x,y).done(function(){l||p.$("input[data-event=audioDetect]").closest("label").remove(),p.render()}),i.get("ShutterAbnormal").then(function(a){a&&a.Support&&e("ShutterAbnormal")}),o=p.$("input[data-event]").click(function(){var b=a(this),c=b.data("event"),d=b.prop("checked");d?e(c):f(c)}),p.$("#sound_path").click(function(a){p.onSelectFile(a)}),p.disabled("#sound_path",!0),p.disabled("[btn-for=onSelectFile]",!0),p.$("#alarm_sound").click(function(){var b=a(this).prop("checked");p.disabled("#sound_path",!b),p.disabled("[btn-for=onSelectFile]",!b),b||(p.$("#sound_path").val(""),p.$("[name=alarmFileInput]").val(null))}),webApp.NotifyVersion?j.devNotify.subscribe("client.notifyEventStream",d):p.$("#alarm_frame").attr("src",p.getEncryptServerUrl(h.getSession())),a.subscribe("RECONNECTION",g)},render:function(){a("#d_alarmtip").hide(),"flash"===webApp.playMode||"h5"===webApp.playMode?p.$("#alarm_audio_wrap").hide():p.$("#alarm_audio_wrap").show(),n=!0,clearInterval(q),webApp.hideIVS===!0?p.$("[data-event=ivs]").parent("label").hide():webApp.hideIVS===!1&&p.$("[data-event=ivs]").parent("label").show(),h.Storage.getDeviceAllInfo().done(function(a){a?a[0].HealthDataFlag&&1==a[0].HealthDataFlag&&p.$("input[data-event=StorageHealthAlarm]").closest("label").show():p.$("input[data-event=StorageHealthAlarm]").closest("label").hide()}).fail(function(){p.$("input[data-event=StorageHealthAlarm]").closest("label").hide()})},leave:function(){n=!1},destory:function(){a("#d_alarmtip").hide(),webApp.NotifyVersion?j.devNotify.detach("client.notifyEventStream"):p.$("#alarm_frame").attr("src",""),a.unsubscribe("RECONNECTION",g),m=null,n=!1,clearInterval(q)},onSelectFile:function(){if("flash"===webApp.playMode||"h5"===webApp.playMode);else{var b=[{},{description:"All Files",extensions:["*"]}];a.browser.ie&&a.browser.version<=10?(b[0].description="Music Files (*.mp3;*.wav;*.mav;*.avi;*.wma;*.wmv)",b[0].extensions=["mp3","wav","mav","avi","wma","wmv"]):a.browser.Platform.mac?(b[0].description="Music Files (*.mp3;*.wav)",b[0].extensions=["mp3","wav"]):(b[0].description="Music Files (*.wav)",b[0].extensions=["wav"]),k.ShowSaveOrOpenDlg("openFile","",b).done(function(a){p.$("#sound_path").val(a[1].replace(/\\/g,"/")),"nacl"===k.type&&k.ConnectAudioPath()})}return!1},onAlarmClean:function(){a.confirm(tl("com.DelAllAlarm"),tl("com.DelAllAlarmComfirm"),function(){p.$("#alarm_table").table("dataSource",[])})},getEncryptServerUrl:function(a){var b="/cgi-bin/eventManager.cgi?action=notifyEventStream&sessionId="+a;return webApp.EncryptInfo&&webApp.EncryptInfo.asymmetric&&(b=j.getEncryptServerUrl("/cgi-bin/eventManager.cgi?","action=notifyEventStream&sessionId="+a)),b}}),window.playAlarmSound=function(b){if(b)if(a.browser.ie&&a.browser.version<=10){var c=a("#player")[0];c.url=b,c.controls.play(),setTimeout(function(){c.controls.stop()},7e3)}else clearTimeout(window.playAlarmSound.timer),window.playAlarmSound.timer=null,"flash"===webApp.playMode||"h5"===webApp.playMode||k.OpenAudioFile(b),window.playAlarmSound.timer=setTimeout(function(){"flash"===webApp.playMode||"h5"===webApp.playMode||k.OpenAudioFile("NULL")},7e3)},window.alarmCGIKeepAlive=a.noop})}(jQuery);